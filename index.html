<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—œæ±ä¹‹æ—… | æ«»èŠ±å‰ä¼Šå¡å“‡ V18</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chii-pink': '#FFD1DC',
                        'chii-blue': '#A2D2FF',
                        'chii-yellow': '#FFF5BA',
                        'chii-text': '#5D5D5D',
                    },
                    fontFamily: {
                        sans: ['Zen Maru Gothic', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'bounce-slow': 'bounce 3s infinite',
                        'wiggle': 'wiggle 2s linear infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } },
                        wiggle: { '0%, 100%': { transform: 'rotate(-3deg)' }, '50%': { transform: 'rotate(3deg)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #FFF0F5; font-family: 'Zen Maru Gothic', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; overscroll-behavior-y: none; user-select: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æ«»èŠ±ç‰¹æ•ˆ */
        .sakura { position: fixed; top: -10px; background: #FFD1DC; border-radius: 100% 0 100% 0; opacity: 0.6; animation: fall linear infinite; z-index: 0; pointer-events: none; }
        @keyframes fall { to { transform: translate(10vw, 105vh) rotate(360deg); } }

        /* Banner */
        .banner-container { height: 260px; background-image: url('2026.tokyo.jpg'); background-size: cover; background-position: center; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; position: relative; box-shadow: 0 4px 20px rgba(255, 183, 178, 0.4); margin-bottom: 20px; }
        .banner-fallback { background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); }

        /* UI Elements */
        .card { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 4px 15px rgba(255, 209, 220, 0.3); backdrop-filter: blur(5px); transition: all 0.2s; border: 1px solid rgba(255,255,255,0.8); }
        .app-icon { width: 65px; height: 65px; border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; box-shadow: 0 6px 15px rgba(255, 183, 178, 0.3); margin-bottom: 6px; transition: transform 0.1s; }
        .app-icon:active { transform: scale(0.9); }
        .app-label { font-size: 12px; font-weight: bold; color: #5D5D5D; text-align: center; }
        
        /* V18 æ–°å¢ï¼šæ°´å½©æ“¬çœŸæ¿¾é¡ */
        .watercolor-img { 
            filter: contrast(1.1) brightness(1.1) saturate(1.2) sepia(0.1); 
            mask-image: radial-gradient(circle, black 60%, transparent 100%);
            -webkit-mask-image: radial-gradient(circle, black 60%, transparent 100%);
            border-radius: 12px;
        }

        /* Buttons */
        .fab-main { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; color: white; z-index: 50; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); transition: transform 0.1s; }
        .fab-main:active { transform: scale(0.9); }
        
        /* å€’æ•¸è¨ˆæ™‚æ‡¸æµ®æ¡† */
        .countdown-float { position: absolute; top: 180px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 50px; display: flex; align-items: center; gap: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); z-index: 20; animation: float 4s ease-in-out infinite; border: 2px solid #FFD1DC; }
        
        /* å‰ä¼Šå¡å“‡è£é£¾ */
        .chii-deco { position: absolute; pointer-events: none; z-index: 0; opacity: 0.15; }

        /* Search */
        .floating-search { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 40; }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="sakura-container"></div>

<div id="app" @touchstart="handleTouchStart" @touchend="handleTouchEnd" class="min-h-screen bg-[#FFF0F5]">
    
    <div v-if="!isMounted" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <i class="fa-solid fa-spinner fa-spin text-4xl text-chii-pink mb-4"></i>
        <div id="loading-text" class="text-chii-text font-bold">è¼‰å…¥æ«»èŠ±å­£ V18...</div>
    </div>

    <div v-if="isMounted" v-cloak class="min-h-screen pb-24 relative z-10">
        
        <div v-if="currentView !== 'home'" class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-md z-40 px-4 py-3 flex justify-between items-center shadow-sm h-14 transition-all border-b border-pink-100">
            <button @click="goHome" class="w-9 h-9 rounded-full bg-pink-50 text-pink-400 flex items-center justify-center hover:bg-pink-100">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <h1 class="font-bold text-gray-700 tracking-wide flex items-center gap-2">
                <i class="fa-solid fa-sakura text-pink-300"></i> {{ getPageTitle(currentView) }}
            </h1>
            <button @click="showSyncModal = true" class="w-9 h-9 rounded-full text-blue-400 bg-blue-50 flex items-center justify-center">
                <i class="fa-solid fa-cloud-arrow-up"></i>
            </button>
        </div>
        <div v-if="currentView !== 'home'" class="h-16"></div>

        <div v-if="currentView === 'home'" class="animate-fade-in pb-20 relative">
            <div class="banner-container" :class="{'banner-fallback': !hasBanner}">
                <div class="absolute inset-0 bg-gradient-to-t from-pink-900/30 to-transparent rounded-b-[40px]"></div>
                <div class="absolute bottom-8 left-6 text-white drop-shadow-md">
                    <h1 class="text-3xl font-black mb-1">é—œæ±ä¹‹æ—… ğŸŒ¸</h1>
                    <div class="flex items-center gap-2 text-sm bg-white/20 backdrop-blur-md px-3 py-1 rounded-full border border-white/30">
                        <i class="fa-solid fa-location-dot"></i> 2026 æ±äº¬å¥³å­æ—…
                    </div>
                </div>
                <div class="countdown-float">
                    <span class="text-2xl">ğŸ¹</span>
                    <div>
                        <div class="text-[10px] text-gray-400 font-bold">è·é›¢å‡ºç™¼</div>
                        <div class="text-sm font-black text-pink-500">{{ daysUntilTrip }} å¤© !</div>
                    </div>
                </div>
                <button @click="showSyncModal = true" class="absolute top-4 right-4 bg-white/40 backdrop-blur text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-sm border border-white/50">
                    <i class="fa-solid fa-rotate mr-1"></i>å‚™ä»½
                </button>
            </div>

            <div class="px-6 grid grid-cols-3 gap-y-8 gap-x-4 mb-8">
                <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer group" @click="currentView = app.view">
                    <div class="app-icon" :class="app.bgClass"><i :class="[app.icon, app.textClass]"></i></div>
                    <span class="app-label mt-2 group-hover:text-chii-pink">{{ app.name }}</span>
                </div>
            </div>

            <div class="floating-search">
                <div class="bg-white/90 backdrop-blur p-2 rounded-full shadow-xl flex items-center border-2 border-pink-100">
                    <i class="fa-brands fa-google text-pink-300 ml-3 text-lg"></i>
                    <input v-model="searchQuery" @keyup.enter="doGoogleSearch" placeholder="æœå°‹æ±äº¬æ«»èŠ±..." class="flex-1 bg-transparent border-none outline-none px-3 text-sm h-10 text-gray-600">
                    <button @click="doGoogleSearch" class="bg-pink-400 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md active:scale-95">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'itinerary'" class="px-4 relative">
            <i class="fa-solid fa-paw text-6xl text-pink-100 chii-deco top-10 right-10 rotate-12"></i>
            <div class="flex overflow-x-auto hide-scrollbar gap-2 mb-4 pb-2 sticky top-16 bg-[#FFF0F5]/95 backdrop-blur py-2 z-30">
                <button v-for="(day, index) in tripDays" :key="index" @click="selectedDayIndex = index"
                    :class="['flex-shrink-0 px-4 py-2 rounded-2xl text-sm font-bold transition border-2', selectedDayIndex === index ? 'bg-chii-pink text-white border-chii-pink shadow-md' : 'bg-white text-gray-400 border-white']">
                    {{ day.week }}<br><span class="text-xs font-normal">{{ day.title }}</span>
                </button>
            </div>
            <div class="space-y-4 pb-20">
                <div v-for="(item, idx) in currentDayItinerary" :key="item.id" class="card p-4 relative border-l-[6px]" :class="getBorderColor(item.category)">
                    <div class="flex justify-between items-start" @click="editItem(item, idx)">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold px-2 py-0.5 rounded text-white" :class="getCategoryColor(item.category)">{{ getCategoryName(item.category) }}</span>
                                <span class="text-xs text-gray-400 font-mono"><i class="fa-regular fa-clock mr-1"></i>{{ item.hours }}</span>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg">
                                {{ item.name }}
                                <a :href="getMapLink(item.mapKeyword)" target="_blank" @click.stop class="ml-1 text-blue-400 hover:text-blue-600"><i class="fa-solid fa-location-arrow"></i></a>
                            </h3>
                            <p v-if="item.parking" class="text-xs mt-2 text-blue-600 font-bold bg-blue-100 p-2 rounded-lg inline-flex items-center cursor-pointer hover:bg-blue-200" @click.stop="window.open(item.parking)">
                                <i class="fa-solid fa-square-parking mr-1 text-lg"></i> å°èˆªè‡³åœè»Šå ´
                            </p>
                            <p class="text-sm text-gray-500 mt-2 whitespace-pre-line">{{ item.note }}</p>
                        </div>
                        <button @click.stop="deleteItem(idx)" class="text-gray-300 hover:text-red-400 ml-2"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
            </div>
            <button @click="openAddModal" class="fab-main bg-chii-pink animate-bounce-slow hover:bg-pink-400"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'prep'" class="px-4">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="bg-gradient-to-r from-blue-400 to-indigo-400 text-white p-3 rounded-2xl font-bold text-center shadow-md text-sm flex flex-col items-center justify-center">
                    <i class="fa-solid fa-passport text-2xl mb-1"></i> VJW å…¥å¢ƒ
                </a>
                <button @click="openTicketModal" class="bg-gradient-to-r from-yellow-400 to-orange-400 text-white p-3 rounded-2xl font-bold text-center shadow-md text-sm flex flex-col items-center justify-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-bl-lg">V18</div>
                    <i class="fa-solid fa-ticket text-2xl mb-1"></i> ç¥¨åˆ¸ç²¾éˆ
                </button>
            </div>
            
            <div class="card p-4 mb-6 border-2 border-yellow-200 bg-yellow-50/80">
                <h3 class="font-bold text-yellow-700 mb-2 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> å…¨å“¡å¿…è®€</h3>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>è­·ç…§æ•ˆæœŸ > 6å€‹æœˆ</li>
                    <li>VJW QR Code æˆªåœ–å­˜æ‰‹æ©Ÿ</li>
                    <li>è‡ªé§•ï¼šå°ç£é§•ç…§ + æ—¥æ–‡è­¯æœ¬</li>
                </ul>
            </div>

            <div v-if="prepMode === 'select'">
                <h3 class="text-center text-chii-text font-bold mb-4 text-lg">ğŸŒ¸ èª°è¦æ•´ç†è¡Œæï¼Ÿ</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="user in users" :key="user.id" class="chii-select-card bg-white p-4 rounded-2xl shadow-sm text-center border-b-4 cursor-pointer active:scale-95 transition" :style="{borderColor: user.bg}" @click="selectPrepUser(user.id)">
                        <div class="w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center text-3xl" :style="{backgroundColor: user.bg}">{{ user.icon }}</div>
                        <div class="font-bold text-gray-600">{{ user.name }}</div>
                    </div>
                </div>
            </div>

            <div v-if="prepMode === 'list'">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-xl text-gray-700 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm" :style="{backgroundColor: getUserById(prepUser).bg}">{{ getUserById(prepUser).icon }}</span>
                        {{ getUserById(prepUser).name }} çš„æ¸…å–®
                    </h3>
                    <button @click="prepMode = 'select'" class="text-sm bg-white px-3 py-1 rounded-full shadow text-gray-500"><i class="fa-solid fa-users mr-1"></i>åˆ‡æ›</button>
                </div>
                <div class="card p-5 min-h-[300px] mb-20 relative overflow-hidden">
                    <div class="space-y-2">
                        <div v-for="(item, idx) in currentPrepList" :key="idx" class="flex items-center gap-3 py-2 border-b border-dashed border-gray-100">
                            <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-400 rounded cursor-pointer">
                            <input v-model="item.text" class="flex-1 text-sm bg-transparent outline-none" :class="{'line-through text-gray-300': item.checked}">
                            <button @click="currentPrepList.splice(idx, 1)" class="text-gray-300 hover:text-red-300"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                    <button @click="addPrepItem" class="w-full mt-6 py-3 bg-gray-50 rounded-xl text-gray-400 font-bold border-2 border-dashed border-gray-200 hover:bg-white text-sm">+ æ–°å¢é …ç›®</button>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'money'" class="px-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex bg-white rounded-xl p-1 shadow-sm border border-pink-100">
                    <button @click="moneyTab = 'record'" :class="['px-4 py-2 rounded-lg text-sm font-bold transition', moneyTab === 'record' ? 'bg-chii-yellow text-gray-800' : 'text-gray-400']">è¨˜å¸³</button>
                    <button @click="moneyTab = 'split'" :class="['px-4 py-2 rounded-lg text-sm font-bold transition', moneyTab === 'split' ? 'bg-chii-pink text-white' : 'text-gray-400']">åˆ†å¸³</button>
                </div>
                <div class="bg-white px-3 py-1 rounded-full text-xs font-bold text-gray-500 shadow-sm border border-gray-100">
                    åŒ¯ç‡: 1 JPY â‰ˆ {{ exchangeRate }} TWD
                </div>
            </div>

            <div v-if="moneyTab === 'record'">
                <div v-if="moneyMode === 'select'">
                    <h3 class="text-center text-chii-text font-bold mb-4">èª°è¦è¨˜å¸³ï¼Ÿ</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div v-for="user in users" :key="user.id" class="chii-select-card bg-white p-4 rounded-2xl shadow-sm text-center border-b-4 cursor-pointer" :style="{borderColor: user.bg}" @click="selectMoneyUser(user.id)">
                            <div class="w-14 h-14 rounded-full mx-auto mb-2 flex items-center justify-center text-2xl" :style="{backgroundColor: user.bg}">{{ user.icon }}</div>
                            <div class="font-bold text-gray-600">{{ user.name }}</div>
                        </div>
                    </div>
                </div>
                <div v-if="moneyMode === 'list'">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2">
                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs" :style="{backgroundColor: getUserById(currentUserId).bg}">{{ getUserById(currentUserId).icon }}</span>
                            {{ getUserById(currentUserId).name }}
                        </h3>
                        <button @click="moneyMode = 'select'" class="text-xs bg-white px-3 py-1 rounded-full shadow text-gray-500">åˆ‡æ›</button>
                    </div>
                    <div class="card p-5 mb-4 bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-100 relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="text-xs text-yellow-600 font-bold mb-1">å€‹äººç¸½æ”¯å‡º (JPY)</div>
                            <div class="text-3xl font-black text-gray-800">Â¥{{ Number(userTotalExpense).toLocaleString() }}</div>
                            <div class="text-xs text-gray-400 mt-1">â‰ˆ NT$ {{ Math.round(userTotalExpense * exchangeRate).toLocaleString() }}</div>
                        </div>
                        <i class="fa-solid fa-coins absolute -bottom-4 -right-4 text-7xl text-yellow-200 opacity-50"></i>
                    </div>
                    <div class="space-y-3 pb-24">
                        <div v-for="exp in filteredExpenses" :key="exp.id" class="card p-3 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-lg shadow-inner">{{ getExpenseIcon(exp.category) }}</div>
                                <div>
                                    <div class="font-bold text-gray-700 text-sm">{{ exp.name }}</div>
                                    <div class="text-[10px] text-gray-400">{{ exp.date }} Â· {{ exp.category }}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-gray-800">
                                    <span v-if="exp.currency==='TWD'" class="text-xs text-gray-400">NT$</span>
                                    <span v-else class="text-xs text-gray-400">Â¥</span>
                                    {{ Number(exp.amount).toLocaleString() }}
                                </div>
                                <div v-if="exp.currency==='TWD'" class="text-[10px] text-gray-400">â‰ˆ Â¥{{ Math.round(exp.amount/exchangeRate) }}</div>
                                <div v-else class="text-[10px] text-gray-400">â‰ˆ NT${{ Math.round(exp.amount*exchangeRate) }}</div>
                                <button @click="deleteExpense(exp.id)" class="text-[10px] text-red-300 mt-1">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                    <button @click="openExpenseModal" class="fab-main bg-chii-yellow text-gray-700 hover:bg-yellow-300"><i class="fa-solid fa-pen"></i></button>
                </div>
            </div>

            <div v-if="moneyTab === 'split'">
                <div class="card p-6 border-l-4 border-chii-blue">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-gray-700"><i class="fa-solid fa-calculator text-blue-400"></i> æ™ºæ…§åˆ†å¸³ (V18)</h3>
                    <p class="text-xs text-gray-400 mb-4">ç³»çµ±å·²è‡ªå‹•å°‡æ‰€æœ‰å¹£åˆ¥è½‰æ›ç‚º JPY è¨ˆç®—</p>
                    <div v-if="settlements.length === 0" class="text-center text-gray-400 py-8 text-sm bg-gray-50 rounded-xl">ç›®å‰æ”¶æ”¯å¹³è¡¡ï¼Œå¤ªæ£’äº†ï¼</div>
                    <div v-else class="space-y-3">
                        <div v-for="(s, idx) in settlements" :key="idx" class="flex items-center justify-between bg-blue-50 p-4 rounded-xl relative overflow-hidden">
                            <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-300"></div>
                            <div class="flex items-center gap-2 text-sm font-bold z-10">
                                <span class="text-gray-700">{{ getUserById(s.from).name }}</span>
                                <i class="fa-solid fa-circle-arrow-right text-blue-300"></i>
                                <span class="text-gray-700">{{ getUserById(s.to).name }}</span>
                            </div>
                            <div class="text-right z-10">
                                <div class="font-black text-blue-600 text-lg">Â¥{{ s.amount.toLocaleString() }}</div>
                                <div class="text-[10px] text-gray-400">â‰ˆ NT$ {{ Math.round(s.amount * exchangeRate).toLocaleString() }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'shopping'" class="px-4">
             <div class="grid grid-cols-2 gap-3 mb-6">
                <a href="https://www.cosme.net/bestcosme/" target="_blank" class="bg-green-100 p-4 rounded-2xl flex flex-col items-center justify-center gap-2 shadow-sm hover:scale-105 transition relative overflow-hidden">
                     <i class="fa-solid fa-leaf text-6xl text-green-200 absolute -bottom-2 -right-2 opacity-50"></i>
                    <i class="fa-solid fa-crown text-3xl text-green-600 relative z-10"></i><span class="font-bold text-green-800 text-sm relative z-10">@cosme å¤§è³</span>
                </a>
                <a href="https://360life.shinyusha.co.jp/list/ldk" target="_blank" class="bg-purple-100 p-4 rounded-2xl flex flex-col items-center justify-center gap-2 shadow-sm hover:scale-105 transition relative overflow-hidden">
                    <i class="fa-solid fa-book-open text-6xl text-purple-200 absolute -bottom-2 -right-2 opacity-50"></i>
                    <i class="fa-solid fa-magazine text-3xl text-purple-600 relative z-10"></i><span class="font-bold text-purple-800 text-sm relative z-10">LDK æ¯’èˆŒè©•æ¸¬</span>
                </a>
            </div>
            <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar pb-1">
                <button v-for="cat in ['wish','cosme','ldk','souvenir']" :key="cat" @click="shopCat = cat" 
                    :class="['px-4 py-2 rounded-full text-sm font-bold transition whitespace-nowrap', shopCat === cat ? 'bg-chii-pink text-white shadow' : 'bg-white text-gray-400']">
                    {{ {'wish':'æˆ‘çš„é¡˜æœ›','cosme':'@Cosme','ldk':'LDK','souvenir':'å¿…è²·ä¼´æ‰‹ç¦®'}[cat] }}
                </button>
            </div>
            <div class="grid grid-cols-2 gap-3 pb-24">
                <div v-for="(item, idx) in shoppingList[shopCat]" :key="idx" class="card p-3 flex flex-col items-center relative group">
                    <button v-if="shopCat==='wish'" @click="shoppingList[shopCat].splice(idx, 1)" class="absolute top-2 right-2 w-6 h-6 bg-white/80 rounded-full text-gray-400 flex items-center justify-center shadow-sm z-20"><i class="fa-solid fa-xmark"></i></button>
                    <div class="w-full aspect-square bg-gray-50 rounded-xl mb-2 overflow-hidden flex items-center justify-center shadow-inner relative">
                        <img :src="item.img" class="w-full h-full object-cover watercolor-img">
                        <div class="absolute inset-0 bg-white/10 pointer-events-none mix-blend-overlay"></div>
                    </div>
                    <div class="font-bold text-sm text-center w-full truncate text-gray-700">{{ item.name }}</div>
                </div>
            </div>
            <button @click="openAddCommonModal('shop')" class="fab-main bg-purple-400 hover:bg-purple-500"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'food'" class="px-4">
            <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
                <button v-for="loc in ['Tokyo','Kamakura','Fuji']" :key="loc" @click="foodLoc = loc" :class="['px-4 py-2 rounded-full text-sm font-bold transition whitespace-nowrap', foodLoc === loc ? 'bg-orange-400 text-white' : 'bg-white text-gray-400']">{{ {'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc] }}</button>
            </div>
            <div class="space-y-4 pb-24">
                <div v-for="(food, idx) in foodList[foodLoc]" :key="idx" class="card p-4 flex gap-4 hover:shadow-md cursor-pointer relative" @click="window.open(food.link)">
                    <div class="w-24 h-24 bg-gray-200 rounded-xl flex-shrink-0 overflow-hidden shadow-sm relative">
                        <img :src="food.img" class="w-full h-full object-cover watercolor-img">
                    </div>
                    <div class="flex-1 flex flex-col justify-center">
                        <h3 class="font-bold text-gray-800 text-lg">{{ food.name }}</h3>
                        <p class="text-xs text-gray-500 mt-1 line-clamp-2">{{ food.desc }}</p>
                        <div class="mt-2 text-orange-500 text-xs font-bold bg-orange-50 inline-block px-3 py-1 rounded-full self-start"><i class="fa-solid fa-location-dot"></i> å°èˆª</div>
                    </div>
                    <button @click.stop="foodList[foodLoc].splice(idx,1)" class="absolute top-2 right-2 text-gray-300 w-6 h-6 bg-white/80 rounded-full flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
            <button @click="openAddCommonModal('food')" class="fab-main bg-orange-400 hover:bg-orange-500"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'photo'" class="px-4">
            <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
                <button v-for="area in ['Tokyo', 'Kamakura', 'Fuji']" :key="area" @click="photoArea = area" :class="['px-4 py-2 rounded-full text-sm font-bold transition whitespace-nowrap', photoArea === area ? 'bg-rose-400 text-white' : 'bg-white text-gray-400']">{{ {'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[area] }}</button>
            </div>
            <div class="grid grid-cols-1 gap-5 pb-24">
                <div v-for="(spot, idx) in photoSpots[photoArea]" :key="idx" class="card p-0 overflow-hidden group relative shadow-md">
                    <a :href="spot.link" target="_blank" class="block">
                        <div class="w-full h-40 bg-gray-200 relative overflow-hidden">
                            <img :src="spot.img" class="w-full h-full object-cover watercolor-img transition duration-700 group-hover:scale-110">
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-4">
                                <h3 class="font-bold text-white text-lg">{{ spot.name }}</h3>
                            </div>
                        </div>
                    </a>
                    <button @click.stop="photoSpots[photoArea].splice(idx,1)" class="absolute top-2 right-2 bg-white/80 rounded-full w-8 h-8 text-gray-400 hover:text-red-500 flex items-center justify-center shadow-sm"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
            <button @click="openAddCommonModal('photo')" class="fab-main bg-rose-400 hover:bg-rose-500"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'japanese'" class="px-4">
             <div class="bg-gradient-to-r from-emerald-500 to-green-400 rounded-2xl p-6 text-white text-center mb-6 shadow-lg relative overflow-hidden">
                <i class="fa-solid fa-camera text-8xl absolute -right-6 -bottom-6 opacity-20 rotate-12"></i>
                <h3 class="font-bold text-xl mb-2">èœå–®/å•†å“çœ‹ä¸æ‡‚ï¼Ÿ</h3>
                <p class="text-xs opacity-90 mb-4">é–‹å•Ÿå³æ™‚é¡é ­ç¿»è­¯ï¼Œè‡ªå‹•è¾¨è­˜æ—¥æ–‡</p>
                <a href="https://translate.google.com/?sl=ja&tl=zh-TW&op=images" target="_blank" class="bg-white text-green-600 px-6 py-3 rounded-full font-bold shadow-sm inline-flex items-center gap-2 hover:bg-gray-100 transition transform hover:scale-105">
                    <i class="fa-solid fa-camera-retro"></i> å•Ÿå‹•ç›¸æ©Ÿç¿»è­¯
                </a>
            </div>

            <div class="space-y-3 pb-24">
                <div v-for="(phrase, idx) in japanesePhrases" :key="idx" @click="speak(phrase.jp)" class="card p-4 flex items-center justify-between cursor-pointer active:scale-95 transition border-l-4 border-green-400 hover:bg-green-50 relative">
                    <div><div class="font-bold text-lg text-gray-800">{{ phrase.jp }}</div><div class="text-xs text-gray-400 font-mono mb-1">{{ phrase.tw }}</div></div>
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 animate-pulse-slow"><i class="fa-solid fa-volume-high"></i></div>
                    <button @click.stop="japanesePhrases.splice(idx,1)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
            <button @click="openAddCommonModal('jp')" class="fab-main bg-green-500 hover:bg-green-600"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'hotel'" class="px-4">
             <div class="space-y-4">
                <div class="card p-4 border border-indigo-100" v-for="h in hotels" :key="h.name">
                    <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded font-bold">{{ h.days }}</span>
                    <h3 class="font-bold text-xl mt-2 text-gray-800">{{ h.name }}</h3>
                    <a :href="h.link" target="_blank" class="block mt-3 bg-gradient-to-r from-blue-50 to-indigo-50 text-indigo-600 py-3 text-center rounded-xl font-bold border border-indigo-100 hover:bg-indigo-100 transition"><i class="fa-solid fa-map-location-dot"></i> é–‹å•Ÿåœ°åœ–å°èˆª</a>
                </div>
             </div>
        </div>

        <div v-if="currentView === 'weather'" class="px-4">
             <div class="card p-4 mb-4 bg-gradient-to-r from-pink-50 to-rose-50 border border-pink-100 flex items-center gap-4">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-3xl shadow-sm">ğŸŒ¸</div>
                <div>
                    <div class="font-bold text-pink-800">2026 æ«»èŠ±é æ¸¬</div>
                    <div class="text-xs text-gray-500">æ±äº¬æ»¿é–‹é ä¼°ï¼š3/25 - 4/2</div>
                    <div class="text-[10px] text-pink-400 font-bold mt-1">æˆ‘å€‘çš„è¡Œç¨‹å‰›å¥½é‡åˆ°æ»¿é–‹ï¼âœ¨</div>
                </div>
             </div>

             <div class="space-y-4">
                 <div class="card p-5 border-l-4 border-sky-400" v-for="w in [{t:'æ±äº¬',d:tokyoWeather},{t:'éŒå€‰',d:kamakuraWeather},{t:'å¯Œå£«å±±',d:fujiWeather}]" :key="w.t">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <div class="font-bold text-gray-700 text-lg">{{ w.t }}</div>
                            <div class="text-4xl font-black text-gray-800 tracking-tighter">{{ w.d.temp }}Â°C</div>
                        </div>
                        <div class="text-right">
                            <div class="text-5xl mb-1">{{ w.d.icon }}</div>
                            <div class="text-xs text-gray-500 font-bold">{{ w.d.desc }}</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 flex items-center gap-3">
                        <div class="text-2xl">ğŸ‘˜</div>
                        <div class="text-xs text-gray-600 leading-relaxed">
                            <span class="font-bold text-sky-600">ç©¿æ­å»ºè­°ï¼š</span>
                            {{ getClothingAdvice(w.d.temp) }}
                        </div>
                    </div>
                 </div>
            </div>
        </div>

        <div v-if="showModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-fade-in">
                <h3 class="font-bold text-lg mb-4 text-center text-gray-700">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <input v-model="editForm.name" placeholder="åç¨± (ä¾‹å¦‚: æ·ºè‰å¯º)" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border focus:border-pink-300">
                <div class="flex gap-2 mb-3">
                    <input v-model="editForm.hours" placeholder="æ™‚é–“" class="w-1/3 p-3 bg-gray-50 rounded-xl outline-none border focus:border-pink-300">
                    <select v-model="editForm.category" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none border focus:border-pink-300">
                        <option value="Sightseeing">ğŸ“¸ æ™¯é»</option>
                        <option value="Food">ğŸœ ç¾é£Ÿ</option>
                        <option value="Shopping">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="Transport">ğŸš… äº¤é€š</option>
                    </select>
                </div>
                <input v-model="editForm.mapKeyword" placeholder="åœ°åœ–é—œéµå­— (ç”¨æ–¼å°èˆª)" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none text-sm border focus:border-pink-300">
                <input v-model="editForm.parking" placeholder="åœè»Šå ´é€£çµ (é¸å¡«)" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none text-sm border focus:border-pink-300">
                <textarea v-model="editForm.note" placeholder="å‚™è¨»..." class="w-full p-3 bg-gray-50 rounded-xl h-20 outline-none border focus:border-pink-300 resize-none"></textarea>
                <div class="flex gap-3 pt-2">
                    <button @click="showModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                    <button @click="saveItem" class="flex-1 py-3 bg-chii-pink text-white rounded-xl font-bold shadow-md">å„²å­˜</button>
                </div>
            </div>
        </div>

        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="font-bold text-lg mb-4 text-center">
                    è¨˜ä¸€ç­† ({{ getUserById(currentUserId).name }})
                </h3>
                <input v-model="newExpense.name" placeholder="æ¶ˆè²»é …ç›®" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border focus:border-yellow-300">
                <div class="flex gap-2 mb-3">
                    <input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none border focus:border-yellow-300">
                    <select v-model="newExpense.currency" class="w-24 p-3 bg-gray-50 rounded-xl outline-none border font-bold text-gray-600">
                        <option value="JPY">JPY</option>
                        <option value="TWD">TWD</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="text-xs text-gray-400 font-bold ml-1">èª°å…ˆå¢Šä»˜?</label>
                    <div class="flex gap-2 mt-1 overflow-x-auto pb-1">
                         <button v-for="u in users" :key="u.id" @click="currentUserId=u.id" 
                            :class="['px-3 py-1 rounded-full text-xs font-bold border', currentUserId===u.id ? 'bg-yellow-100 border-yellow-300 text-yellow-700' : 'bg-white border-gray-200 text-gray-400']">
                            {{ u.name }}
                         </button>
                    </div>
                </div>

                <div class="flex gap-2 justify-center mb-6">
                    <button v-for="c in ['é£Ÿ','è¡£','ä½','è¡Œ','æ¨‚']" :key="c" @click="newExpense.category=c" :class="['w-10 h-10 rounded-full font-bold transition', newExpense.category==c?'bg-chii-yellow text-gray-800 shadow-md scale-110':'bg-gray-100 text-gray-400']">{{c}}</button>
                </div>
                <div class="flex gap-3">
                    <button @click="showExpenseModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                    <button @click="addExpense" class="flex-1 py-3 bg-chii-yellow text-gray-800 rounded-xl font-bold shadow-md">å„²å­˜</button>
                </div>
            </div>
        </div>

        <div v-if="showTicketModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-xl text-gray-700"><i class="fa-solid fa-ticket text-orange-400 mr-2"></i>ç¥¨åˆ¸ç²¾éˆ</h3>
                    <button @click="showTicketModal=false" class="text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <p class="text-xs text-gray-400 mb-4 bg-gray-50 p-2 rounded">ç³»çµ±æ ¹æ“šæ‚¨çš„è¡Œç¨‹ï¼Œè‡ªå‹•åˆ†æå»ºè­°è³¼è²·çš„ç¥¨åˆ¸ã€‚</p>
                <div class="flex-1 overflow-y-auto space-y-3 pr-1">
                    <div v-for="ticket in suggestedTickets" :key="ticket.name" class="border rounded-xl p-3 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-red-100 text-red-500 text-[10px] font-bold px-2 py-0.5 rounded-bl-lg">æ¨è–¦</div>
                        <h4 class="font-bold text-gray-800">{{ ticket.name }}</h4>
                        <p class="text-xs text-gray-500 mt-1">{{ ticket.reason }}</p>
                        <div class="mt-2 text-xs bg-orange-50 text-orange-600 p-2 rounded border border-orange-100">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i> {{ ticket.note }}
                        </div>
                    </div>
                    <div v-if="suggestedTickets.length === 0" class="text-center text-gray-400 py-10">
                        æš«ç„¡ç‰¹æ®Šç¥¨åˆ¸å»ºè­°<br>è«‹ç¢ºèªè¡Œç¨‹æ˜¯å¦å·²å®Œæ•´å»ºç«‹
                    </div>
                </div>
                <button @click="showTicketModal=false" class="w-full mt-4 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">é—œé–‰</button>
            </div>
        </div>

        <div v-if="showCommonModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="font-bold text-lg mb-4 text-center">æ–°å¢é …ç›®</h3>
                <div v-if="commonType === 'jp'">
                    <input v-model="newCommon.text1" @input="autoTranslate" placeholder="è¼¸å…¥ä¸­æ–‡ (ä¾‹: å»æ‰€)" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border focus:border-green-300">
                    <input v-model="newCommon.text2" placeholder="è‡ªå‹•å¸¶å‡ºæ—¥æ–‡" class="w-full p-3 bg-green-50 text-green-600 font-bold rounded-xl mb-3 outline-none border border-green-100" readonly>
                    <p class="text-xs text-gray-400 mb-2">è¼¸å…¥ä¸­æ–‡å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•ç¿»è­¯å¸¸ç”¨è©å½™</p>
                </div>
                <div v-else>
                    <input v-model="newCommon.text1" placeholder="åç¨± (ä¾‹å¦‚: AFURI æ‹‰éºµ)" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border focus:border-blue-300">
                    <p class="text-xs text-gray-400 mb-3 text-center">è¼¸å…¥åç¨±å¾Œï¼Œç³»çµ±å°‡è‡ªå‹•ç”Ÿæˆæ°´å½©æ’åœ–èˆ‡åœ°åœ–é€£çµ</p>
                </div>
                <div class="flex gap-3">
                    <button @click="showCommonModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                    <button @click="saveCommonItem" class="flex-1 py-3 bg-blue-400 text-white rounded-xl font-bold shadow-md">æ–°å¢</button>
                </div>
            </div>
        </div>

        <div v-if="showSyncModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                <button @click="showSyncModal=false" class="absolute top-4 right-4 text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h3 class="font-bold text-xl mb-2 text-center text-chii-text">â˜ï¸ åŒæ­¥/å­˜æª”</h3>
                <p class="text-xs text-gray-400 text-center mb-4">è³‡æ–™å·²è‡ªå‹•å„²å­˜ã€‚è‹¥è¦æ›æ‰‹æ©Ÿï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹åŠŸèƒ½ã€‚</p>
                <div class="bg-gray-50 p-3 rounded-xl mb-4 break-all text-xs text-gray-500 font-mono h-24 overflow-y-auto border border-gray-200">{{ syncCode || 'é»æ“ŠåŒ¯å‡º...' }}</div>
                <div class="grid grid-cols-2 gap-3">
                    <button @click="generateSyncCode" class="py-2 bg-blue-100 text-blue-600 rounded-lg font-bold text-sm">åŒ¯å‡ºä»£ç¢¼</button>
                    <button @click="pasteSyncCode" class="py-2 bg-pink-100 text-pink-600 rounded-lg font-bold text-sm">è²¼ä¸Šä»£ç¢¼</button>
                </div>
                <div v-if="syncMsg" class="text-center text-xs mt-3 font-bold text-green-500">{{ syncMsg }}</div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // === Init State ===
            const isMounted = ref(false), currentView = ref('home'), hasBanner = ref(true), STORAGE_KEY = 'tokyo_trip_v18', searchQuery = ref('');
            
            // Users
            const defaultUsers = [
                {id: 1, name: 'å‰ä¼Š', bg: '#FFD1DC', icon:'ğŸ¹', list: []},
                {id: 2, name: 'å°å…«', bg: '#A2D2FF', icon:'ğŸ±', list: []},
                {id: 3, name: 'å…”å…”', bg: '#FFF5BA', icon:'ğŸ°', list: []},
                {id: 4, name: 'å°æ¡ƒ', bg: '#FFB7B2', icon:'ğŸ‘', list: []}
            ];
            const users = ref(JSON.parse(JSON.stringify(defaultUsers)));
            const prepMode = ref('select'), moneyMode = ref('select');
            
            // V18 å€’æ•¸è¨ˆæ™‚
            const tripStartDate = new Date('2026-03-27');
            const daysUntilTrip = computed(() => {
                const now = new Date();
                const diff = tripStartDate - now;
                return Math.ceil(diff / (1000 * 60 * 60 * 24));
            });

            // V18 åŒ¯ç‡èˆ‡å¹£åˆ¥
            const exchangeRate = ref(0.22); // TWD/JPY åŒ¯ç‡ (æ‰‹å‹•è¨­å®šæˆ–å‡è¨­)

            // Touch Swipe Logic (Improved for V18)
            const touchStart = ref(0);
            const handleTouchStart = (e) => touchStart.value = e.changedTouches[0].screenX;
            const handleTouchEnd = (e) => { 
                const diff = e.changedTouches[0].screenX - touchStart.value;
                if (currentView.value !== 'home' && diff > 100) {
                    // å¦‚æœæ˜¯åœ¨æ¸…å–®å…§å±¤ï¼Œå…ˆè¿”å›ä¸Šä¸€å±¤
                    if(currentView.value === 'prep' && prepMode.value === 'list') prepMode.value = 'select';
                    else if(currentView.value === 'money' && moneyTab.value === 'record' && moneyMode.value === 'list') moneyMode.value = 'select';
                    else goHome(); 
                } 
            };

            const apps = [
                { id: 1, name: 'è¡Œç¨‹è¡¨', icon: 'fa-solid fa-map-location-dot', bgClass: 'bg-gradient-to-br from-pink-100 to-pink-200', textClass: 'text-pink-500', view: 'itinerary' },
                { id: 2, name: 'å°è²¡åº«', icon: 'fa-solid fa-sack-dollar', bgClass: 'bg-gradient-to-br from-yellow-100 to-yellow-200', textClass: 'text-yellow-600', view: 'money' },
                { id: 3, name: 'ä½å®¿', icon: 'fa-solid fa-bed', bgClass: 'bg-gradient-to-br from-indigo-100 to-indigo-200', textClass: 'text-indigo-500', view: 'hotel' },
                { id: 4, name: 'è¡Œå‰æº–å‚™', icon: 'fa-solid fa-suitcase-rolling', bgClass: 'bg-gradient-to-br from-blue-100 to-blue-200', textClass: 'text-blue-500', view: 'prep' },
                { id: 5, name: 'åƒåƒå–å–', icon: 'fa-solid fa-utensils', bgClass: 'bg-gradient-to-br from-orange-100 to-orange-200', textClass: 'text-orange-500', view: 'food' },
                { id: 6, name: 'å¿«æ¨‚Shop', icon: 'fa-solid fa-bag-shopping', bgClass: 'bg-gradient-to-br from-purple-100 to-purple-200', textClass: 'text-purple-500', view: 'shopping' },
                { id: 7, name: 'å¤©æ°£é€±å ±', icon: 'fa-solid fa-cloud-sun', bgClass: 'bg-gradient-to-br from-sky-100 to-sky-200', textClass: 'text-sky-500', view: 'weather' },
                { id: 8, name: 'ç¶²ç¾æ‰“å¡', icon: 'fa-solid fa-camera', bgClass: 'bg-gradient-to-br from-rose-100 to-rose-200', textClass: 'text-rose-500', view: 'photo' },
                { id: 9, name: 'å³æ™‚æ•‘å‘½', icon: 'fa-solid fa-comment-medical', bgClass: 'bg-gradient-to-br from-emerald-100 to-emerald-200', textClass: 'text-emerald-500', view: 'japanese' },
            ];

            const tokyoWeather = ref({ temp: '--', icon: 'â³', desc: '...', visibility: '--' }), kamakuraWeather = ref({ temp: '--', icon: 'â³', desc: '...', visibility: '--' }), fujiWeather = ref({ temp: '--', icon: 'â³', desc: '...', visibility: '--' });
            
            const selectedDayIndex = ref(0);
            const tripDays = [
                { week: 'Day 1', title: 'æŠµé”/æ™´ç©ºå¡”' }, { week: 'Day 2', title: 'æ·ºè‰/ä¸Šé‡' }, { week: 'Day 3', title: 'ç§Ÿè»Š/æ²³å£æ¹–' }, { week: 'Day 4', title: 'å±±ä¸­æ¹–' },
                { week: 'Day 5', title: 'çºœè»Š/å›æ–°å®¿' }, { week: 'Day 6', title: 'éŒå€‰æ±Ÿä¹‹é›»' }, { week: 'Day 7', title: 'æ±äº¬å¡”/æ¾€è°·' }, { week: 'Day 8', title: 'è¿”ç¨‹' }
            ];
            
            const searchMap = (q) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
            const defaultItinerary = [
                [{ id: 1, category: 'Flight', name: 'æ¡ƒåœ’èµ·é£› (06:40)', hours: '06:40', mapKeyword: 'æ¡ƒåœ’æ©Ÿå ´' }, { id: 2, category: 'Flight', name: 'æŠµé”æˆç”° (10:40)', hours: '10:40', mapKeyword: 'æˆç”°æ©Ÿå ´' }, { id: 3, category: 'Sightseeing', name: 'æ™´ç©ºå¡”', hours: 'ä¸‹åˆ', mapKeyword: 'Tokyo Skytree' }, { id: 4, category: 'Food', name: 'æ™šé¤ï¼šéŒ¦ç³¸ç”ºå‘¨é­', hours: 'æ™šä¸Š', mapKeyword: 'éŒ¦ç³¸ç”ºç¾é£Ÿ' }],
                [{ id: 5, category: 'Sightseeing', name: 'æ·ºè‰å¯º', hours: 'ä¸Šåˆ', mapKeyword: 'æ·ºè‰å¯º' }, { id: 6, category: 'Food', name: 'åˆé¤ï¼šæ·ºè‰å‘¨é­', hours: 'ä¸­åˆ', mapKeyword: 'æ·ºè‰åˆé¤' }, { id: 7, category: 'Sightseeing', name: 'å°ç¶²ç¥ç¤¾', hours: 'ä¸‹åˆ', mapKeyword: 'å°ç¶²ç¥ç¤¾' }, { id: 8, category: 'Sightseeing', name: 'ä¸Šé‡æ©è³œå…¬åœ’', hours: 'ä¸‹åˆ', mapKeyword: 'ä¸Šé‡æ©è³œå…¬åœ’' }, { id: 9, category: 'Shopping', name: 'ç§‹è‘‰åŸ/æ±äº¬ä¸€ç•ªè¡—', hours: 'æ™šä¸Š', mapKeyword: 'æ±äº¬ç«™ä¸€ç•ªè¡—' }],
                [{ id: 10, category: 'Transport', name: 'éŒ¦ç³¸ç”ºå‰å¾€å¯Œå£«å±±(ç§Ÿè»Š)', hours: 'ä¸Šåˆ', mapKeyword: 'æ²³å£æ¹–ç§Ÿè»Š' }, { id: 11, category: 'Sightseeing', name: 'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨', hours: 'ä¸‹åˆ', mapKeyword: 'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨', parking:'https://www.google.com/maps/search/?api=1&query=å¤§çŸ³å…¬åœ’é§è»Šå ´' }, { id: 12, category: 'Sightseeing', name: 'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾', hours: 'ä¸‹åˆ', mapKeyword: 'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾', parking:'https://www.google.com/maps/search/?api=1&query=ä¸‹å‰ç”°é§…é§è»Šå ´' }, { id: 13, category: 'Sightseeing', name: 'é‡‘é³¥å±…', hours: 'å‚æ™š', mapKeyword: 'å¯Œå£«å‰ç”°æœ¬ç”ºé€š', parking:'https://www.google.com/maps/search/?api=1&query=æœ¬ç”ºäºŒä¸ç›®é§è»Šå ´' }, { id: 14, category: 'Food', name: 'æ™šé¤', hours: 'æ™šä¸Š', mapKeyword: 'å¯Œå£«å‰ç”°æ™šé¤' }],
                [{ id: 15, category: 'Sightseeing', name: 'å¹³é‡ä¹‹æ¿±æ—¥å‡º', hours: 'æ¸…æ™¨', mapKeyword: 'å¹³é‡ä¹‹æ¿±' }, { id: 16, category: 'Sightseeing', name: 'é•·æ± è¦ªæ°´å…¬åœ’', hours: 'ä¸Šåˆ', mapKeyword: 'é•·æ± è¦ªæ°´å…¬åœ’', parking:searchMap('é•·æ± è¦ªæ°´å…¬åœ’é§è»Šå ´') }, { id: 17, category: 'Food', name: 'åˆé¤', hours: 'ä¸­åˆ', mapKeyword: 'å±±ä¸­æ¹–ç¾é£Ÿ' }, { id: 18, category: 'Sightseeing', name: 'KABA æ°´é™¸å·´å£«', hours: 'ä¸‹åˆ', mapKeyword: 'å±±ä¸­æ¹–KABA', parking:searchMap('å±±ä¸­æ¹–æ—­æ—¥ä¸˜é§è»Šå ´') }, { id: 19, category: 'Food', name: 'Oginoè¶…å¸‚', hours: 'æ™šä¸Š', mapKeyword: 'Oginoæ²³å£æ¹–åº—', parking:searchMap('Oginoæ²³å£æ¹–åº—é§è»Šå ´') }],
                [{ id: 20, category: 'Sightseeing', name: 'æ²³å£æ¹–çºœè»Š', hours: 'æ—©ä¸Š', mapKeyword: 'æ²³å£æ¹–å¯Œå£«å±±å…¨æ™¯çºœè»Š', parking:searchMap('æ²³å£æ¹–ç•”çœŒå–¶ç„¡æ–™é§è»Šå ´') }, { id: 21, category: 'Shopping', name: 'Fujisan Shokupan', hours: 'é»å¿ƒ', mapKeyword: 'Fujisan Shokupan' }, { id: 22, category: 'Transport', name: 'æ­ä¹˜å¯Œå£«å›éŠè¿”æ–°å®¿', hours: 'ä¸‹åˆ', mapKeyword: 'æ²³å£æ¹–ç«™' }, { id: 23, category: 'Shopping', name: 'æ± è¢‹å¤ªé™½åŸ', hours: 'å‚æ™š', mapKeyword: 'æ± è¢‹å¤ªé™½åŸ' }, { id: 24, category: 'Food', name: 'æ™šé¤', hours: 'æ™šä¸Š', mapKeyword: 'æ± è¢‹å¤ªé™½åŸç¾é£Ÿ' }],
                [{ id: 25, category: 'Transport', name: 'å‰å¾€è—¤æ¾¤', hours: 'ä¸Šåˆ', mapKeyword: 'è—¤æ¾¤ç«™' }, { id: 26, category: 'Sightseeing', name: 'æ±Ÿä¹‹å³¶/éŒå€‰é«˜æ ¡å‰', hours: 'å…¨å¤©', mapKeyword: 'æ±Ÿä¹‹å³¶' }, { id: 27, category: 'Food', name: 'åˆé¤ï¼šä¸ƒé‡Œæ¿±', hours: 'ä¸­åˆ', mapKeyword: 'ä¸ƒé‡Œæ¿±Bills' }, { id: 28, category: 'Transport', name: 'è¿”å›æ–°å®¿', hours: 'å‚æ™š', mapKeyword: 'æ–°å®¿ç«™' }],
                [{ id: 29, category: 'Sightseeing', name: 'æ±äº¬éµå¡”/éº»å¸ƒå°', hours: 'ä¸Šåˆ', mapKeyword: 'æ±äº¬éµå¡”' }, { id: 30, category: 'Food', name: 'åˆé¤ï¼šå…­æœ¬æœ¨', hours: 'ä¸­åˆ', mapKeyword: 'å…­æœ¬æœ¨åˆé¤' }, { id: 31, category: 'Sightseeing', name: 'SHIBUYA SKY', hours: 'å‚æ™š', mapKeyword: 'SHIBUYA SKY' }, { id: 32, category: 'Shopping', name: 'æ¾€è°·é€›è¡—', hours: 'æ™šä¸Š', mapKeyword: 'æ¾€è°·' }],
                [{ id: 33, category: 'Sightseeing', name: 'è‡ªç”±è¡Œç¨‹', hours: 'ç™½å¤©', mapKeyword: '' }, { id: 34, category: 'Transport', name: 'æˆç”°æ©Ÿå ´ (20:40)', hours: '20:40', mapKeyword: 'æˆç”°æ©Ÿå ´' }, { id: 35, category: 'Transport', name: 'æŠµé”æ¡ƒåœ’ (23:20)', hours: '23:20', mapKeyword: 'æ¡ƒåœ’æ©Ÿå ´' }]
            ];
            const itineraryData = ref(defaultItinerary);

            // Lists Data
            const moneyTab = ref('record'), currentUserId = ref(1), expenses = ref([]), newExpense = ref({name:'', amount:'', category:'é£Ÿ', currency:'JPY'}), prepUser = ref(1);
            const defaultPrep = ['è­·ç…§', 'æ—¥å¹£', 'ä¿¡ç”¨å¡', 'SIMå¡', 'è¡£æœ', 'ç‰™åˆ·'];
            
            // V18 è³¼ç‰©æ¸…å–® (æ°´å½©åœ–æº placeholders)
            const shoppingList = ref({ 
                'wish': [], 
                'cosme': [{name:'Kateæ€ªç¸å”‡è†', img:'https://placehold.co/200x200/FFD1DC/555?text=Lipstick'}, {name:'Tirtiræ°£å¢Š', img:'https://placehold.co/200x200/FFD1DC/555?text=Cushion'}, {name:'&Honeyé«®æ²¹', img:'https://placehold.co/200x200/FFD1DC/555?text=HairOil'}],
                'ldk': [{name:'Lululuné¢è†œ', img:'https://placehold.co/200x200/A2D2FF/555?text=Mask'}, {name:'Melano CC', img:'https://placehold.co/200x200/A2D2FF/555?text=VitaminC'}, {name:'Bioreé˜²æ›¬', img:'https://placehold.co/200x200/A2D2FF/555?text=Sunscreen'}],
                'souvenir': [{name:'NY Perfect Cheese', img:'https://placehold.co/200x200/FFF5BA/555?text=Cheese'}, {name:'Press Butter Sand', img:'https://placehold.co/200x200/FFF5BA/555?text=Butter'}] 
            });
            const shopCat = ref('wish');
            
            // V18 ç¾é£Ÿèˆ‡æ‰“å¡ (æ°´å½©åœ–æº)
            const foodList = ref({ 'Tokyo': [{name:'AFURIæ‹‰éºµ', desc:'æŸšå­é¹½æ‹‰éºµ', img:'https://placehold.co/200x200/orange/white?text=Ramen', link:searchMap('AFURI')}, {name:'HARBS', desc:'æ°´æœåƒå±¤', img:'https://placehold.co/200x200/orange/white?text=Cake', link:searchMap('HARBS')}, {name:'æ•˜æ•˜è‹‘', desc:'ç‡’è‚‰', img:'https://placehold.co/200x200/orange/white?text=Yakiniku', link:searchMap('Jojoen')}, {name:'æ·ºè‰ç‚¸è‚‰é¤…', desc:'å°åƒ', img:'https://placehold.co/200x200/orange/white?text=Menchi', link:searchMap('Asakusa Menchi')}, {name:'ç‰›ã‹ã¤ã‚‚ã¨æ‘', desc:'ç‚¸ç‰›æ’', img:'https://placehold.co/200x200/orange/white?text=BeefCutlet', link:searchMap('Motomura')}], 'Kamakura': [{name:'Bills', desc:'æµ·æ™¯é¬†é¤…', img:'https://placehold.co/200x200/teal/white?text=Pancake', link:searchMap('Bills Shichirigahama')}, {name:'Caraway', desc:'å’–å“©', img:'https://placehold.co/200x200/teal/white?text=Curry', link:searchMap('Caraway Kamakura')}, {name:'Pacific Drive In', desc:'å’–å•¡', img:'https://placehold.co/200x200/teal/white?text=Cafe', link:searchMap('Pacific Drive In')}, {name:'è±å³¶å±‹', desc:'é´¿å­é¤…ä¹¾', img:'https://placehold.co/200x200/teal/white?text=Cookie', link:searchMap('Toshimaya')}, {name:'éŒå€‰é‡œé£¯', desc:'å»ä»”é­š', img:'https://placehold.co/200x200/teal/white?text=RiceBowl', link:searchMap('Kamakura Kamameshi')}], 'Fuji': [{name:'Houtou Fudou', desc:'é¤ºé£¥éºµ', img:'https://placehold.co/200x200/blue/white?text=Noodle', link:searchMap('Houtou Fudou')}, {name:'Fujisan Shokupan', desc:'åå¸', img:'https://placehold.co/200x200/blue/white?text=Toast', link:searchMap('Fujisan Shokupan')}, {name:'Lake Bake', desc:'éºµåŒ…', img:'https://placehold.co/200x200/blue/white?text=Bakery', link:searchMap('Lake Bake')}, {name:'Sanrokuen', desc:'çˆç«¯ç‡’', img:'https://placehold.co/200x200/blue/white?text=Robatayaki', link:searchMap('Sanrokuen')}, {name:'Ogino', desc:'è¶…å¸‚', img:'https://placehold.co/200x200/blue/white?text=Supermarket', link:searchMap('Ogino Kawaguchiko')}] });
            const foodLoc = ref('Tokyo');
            
            const photoSpots = ref({ 'Tokyo': [{name:'SHIBUYA SKY', img:'https://placehold.co/300x200/FFD1DC/555?text=ShibuyaSky', link:searchMap('SHIBUYA SKY')}, {name:'æ±äº¬éµå¡”', img:'https://placehold.co/300x200/FFD1DC/555?text=TokyoTower', link:searchMap('Tokyo Tower')}, {name:'æ·ºè‰å¯º', img:'https://placehold.co/300x200/FFD1DC/555?text=Sensoji', link:searchMap('Sensoji')}, {name:'æ±äº¬è»Šç«™', img:'https://placehold.co/300x200/FFD1DC/555?text=TokyoStn', link:searchMap('Tokyo Station')}, {name:'éº»å¸ƒå°Hills', img:'https://placehold.co/300x200/FFD1DC/555?text=Hills', link:searchMap('Azabudai Hills')}], 'Kamakura': [{name:'é«˜æ ¡å‰å¹³äº¤é“', img:'https://placehold.co/300x200/A2D2FF/555?text=SlamDunk', link:searchMap('Kamakura Kokomae')}, {name:'ä¸ƒé‡Œæ¿±', img:'https://placehold.co/300x200/A2D2FF/555?text=Beach', link:searchMap('Shichirigahama')}, {name:'é¶´å²¡å…«å¹¡å®®', img:'https://placehold.co/300x200/A2D2FF/555?text=Shrine', link:searchMap('Tsurugaoka Hachimangu')}, {name:'é«˜å¾·é™¢å¤§ä½›', img:'https://placehold.co/300x200/A2D2FF/555?text=Daibutsu', link:searchMap('Kotoku-in')}, {name:'æ±Ÿä¹‹å³¶', img:'https://placehold.co/300x200/A2D2FF/555?text=Enoshima', link:searchMap('Enoshima')}], 'Fuji': [{name:'æœ¬ç”ºé€š', img:'https://placehold.co/300x200/FFF5BA/555?text=StreetView', link:searchMap('Honcho Street')}, {name:'æ–°å€‰å±±æ·ºé–“', img:'https://placehold.co/300x200/FFF5BA/555?text=Pagoda', link:searchMap('Chureito Pagoda')}, {name:'æ²³å£æ¹–Lawson', img:'https://placehold.co/300x200/FFF5BA/555?text=Lawson', link:searchMap('Lawson Kawaguchiko Station')}, {name:'å¤§çŸ³å…¬åœ’', img:'https://placehold.co/300x200/FFF5BA/555?text=OishiPark', link:searchMap('Oishi Park')}, {name:'å¤©ç©ºé³¥å±…', img:'https://placehold.co/300x200/FFF5BA/555?text=Torii', link:searchMap('Kawaguchi Asama Shrine')}] });
            const photoArea = ref('Tokyo');
            
            const japanesePhrases = ref([{jp:'ã™ã¿ã¾ã›ã‚“', tw:'ä¸å¥½æ„æ€'}, {jp:'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™', tw:'æˆ‘è¦é€™å€‹'}, {jp:'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™', tw:'çµå¸³'}]);
            const hotels = ref([{name:'éŒ¦ç³¸ç”º Sumida City', days:'Day 1-2', link:'https://www.google.com/maps/search/?api=1&query=Sumida+City+Hotel'}, {name:'Megu Fuji 2021', days:'Day 3-4', link:searchMap('Megu Fuji 2021')}, {name:'DOMO é£¯åº—', days:'Day 5-7', link:searchMap('DOMO é£¯åº— æ±äº¬')}]);

            // Dictionary
            const transDict = { 'å»æ‰€': 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹', 'æ°´': 'ãŠæ°´ãã ã•ã„', 'çµå¸³': 'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™', 'è¬è¬': 'ã‚ã‚ŠãŒã¨ã†', 'å¤šå°‘éŒ¢': 'ã„ãã‚‰ã§ã™ã‹', 'æ¨è–¦': 'ãŠã™ã™ã‚ã¯ï¼Ÿ', 'å¥½': 'ã¯ã„', 'ä¸è¦': 'ã„ã„ãˆ', 'è¢‹å­':'è¢‹ã„ã‚Šã¾ã™' };

            const showModal=ref(false), showCommonModal=ref(false), showExpenseModal=ref(false), showSyncModal=ref(false), showTicketModal=ref(false), isEditing=ref(false), editIndex=ref(-1), editForm=ref({}), commonType = ref(''), newCommon = ref({text1:'', text2:''}), syncCode=ref(''), syncMsg=ref('');

            const currentDayItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
            const getUserById = (id) => users.value.find(u => u.id === id) || users.value[0];
            
            // V18 å‡ç´šï¼šæ”¯å‡ºè¨ˆç®—
            const userTotalExpense = computed(() => expenses.value.filter(e => e.user === currentUserId.value).reduce((s, e) => {
                const amt = e.currency === 'TWD' ? Math.round(e.amount / exchangeRate.value) : Number(e.amount);
                return s + amt;
            }, 0));
            const filteredExpenses = computed(() => expenses.value.filter(e => e.user === currentUserId.value).sort((a,b)=>b.id-a.id));
            const currentPrepList = computed(() => getUserById(prepUser.value).list);
            
            // V18 å‡ç´šï¼šåˆ†å¸³è¨ˆç®— (ä¸€å¾‹è½‰ JPY)
            const settlements = computed(() => {
                const bal = {}; users.value.forEach(u=>bal[u.id]=0); 
                expenses.value.forEach(e=>{ 
                    const amtJPY = e.currency === 'TWD' ? Math.round(e.amount / exchangeRate.value) : Number(e.amount);
                    if(bal[e.user]!=undefined) bal[e.user]+=amtJPY; 
                });
                const total = expenses.value.reduce((s,e) => {
                     const amtJPY = e.currency === 'TWD' ? Math.round(e.amount / exchangeRate.value) : Number(e.amount);
                     return s + amtJPY;
                }, 0);
                const avg = total / users.value.length;
                const net = {}; users.value.forEach(u=>net[u.id]=bal[u.id]-avg);
                const debt=[], cred=[]; 
                for(let uid in net) { if(net[uid]<-1) debt.push({u:uid,a:-net[uid]}); else if(net[uid]>1) cred.push({u:uid,a:net[uid]}); }
                const res=[]; let i=0,j=0; 
                while(i<debt.length && j<cred.length){
                    let amt = Math.min(debt[i].a, cred[j].a);
                    if(amt>0) res.push({from:debt[i].u, to:cred[j].u, amount:Math.round(amt)});
                    debt[i].a-=amt; cred[j].a-=amt;
                    if(debt[i].a<1) i++; if(cred[j].a<1) j++;
                }
                return res;
            });
            
            // V18 å‡ç´šï¼šç¥¨åˆ¸å»ºè­° (Ticket Logic)
            const suggestedTickets = computed(() => {
                const tickets = [];
                const allItems = itineraryData.value.flat();
                const text = JSON.stringify(allItems);
                
                if (text.includes('éŒå€‰') || text.includes('æ±Ÿä¹‹å³¶')) {
                    tickets.push({name: 'æ±Ÿä¹‹é›»ä¸€æ—¥åˆ¸', reason: 'è¡Œç¨‹åŒ…å«éŒå€‰/æ±Ÿä¹‹å³¶', note: 'å¯åœ¨éŒå€‰ç«™è‡ªå‹•å”®ç¥¨æ©Ÿè³¼è²·'});
                }
                if (text.includes('æ²³å£æ¹–') && text.includes('æ–°å®¿')) {
                    tickets.push({name: 'å¯Œå£«å›éŠè™Ÿ (ç‰¹æ€¥åˆ¸)', reason: 'å¾€è¿”æ±äº¬èˆ‡æ²³å£æ¹–æœ€å¿«æ–¹å¼', note: 'æ¥µç†±é–€ï¼å‹™å¿…æå‰30å¤©åœ¨ JR å®˜ç¶²é ç´„'});
                }
                if (text.includes('SHIBUYA SKY')) {
                     tickets.push({name: 'SHIBUYA SKY é–€ç¥¨', reason: 'ç¶²ç¾æ‰“å¡å¿…å‚™', note: 'éœ€æå‰2-4é€±å®˜ç¶²é ç´„å¤•é™½æ™‚æ®µ'});
                }
                if (text.includes('åœ°éµ') || text.includes('Metro')) {
                    tickets.push({name: 'Tokyo Subway Ticket', reason: 'æ±äº¬å¸‚å€ç§»å‹•', note: 'å¤–åœ‹äººå°ˆå±¬å„ªæƒ ï¼Œå»ºè­°è²· 48/72 å°æ™‚åˆ¸'});
                }
                return tickets;
            });

            const goHome = () => { currentView.value = 'home'; prepMode.value = 'select'; moneyMode.value = 'select'; };
            const getPageTitle = (v) => apps.find(a=>a.view==v)?.name || '';
            const getMapLink = (k) => k ? searchMap(k) : '#';
            const getBorderColor = (c) => ({'Flight':'border-gray-400','Sightseeing':'border-pink-300','Food':'border-orange-300','Shopping':'border-purple-300','Transport':'border-blue-300'}[c]||'border-gray-300');
            const getCategoryColor = (c) => ({'Flight':'bg-gray-400','Sightseeing':'bg-pink-300','Food':'bg-orange-300','Shopping':'bg-purple-300','Transport':'bg-blue-300'}[c]||'bg-gray-300');
            const getCategoryName = (c) => ({'Flight':'é£›æ©Ÿ','Sightseeing':'æ™¯é»','Food':'ç¾é£Ÿ','Shopping':'è³¼ç‰©','Transport':'äº¤é€š'}[c]||'å…¶ä»–');
            const getExpenseIcon = (c) => ({'é£Ÿ':'ğŸœ','è¡£':'ğŸ‘—','ä½':'ğŸ¨','è¡Œ':'ğŸš…','æ¨‚':'ğŸ¡'}[c]||'ğŸ’¸');
            
            // V18 ç©¿æ­å»ºè­°
            const getClothingAdvice = (temp) => {
                const t = parseFloat(temp);
                if (isNaN(t)) return "å¤©æ°£è¼‰å…¥ä¸­...";
                if (t < 10) return "ç¾½çµ¨è¡£ + ç™¼ç†±è¡£ + åœå·¾ (å¾ˆå†·å–”!)";
                if (t < 15) return "å¤§è¡£ + æ¯›è¡£ + é•·è¤²";
                if (t < 20) return "è–„å¤–å¥— + é•·è¢– (èˆ’é©)";
                if (t < 25) return "çŸ­è¢– + è–„é‡ç¹”å¤–å¥—";
                return "çŸ­è¢– + é˜²æ›¬ (æœ‰é»ç†±)";
            };

            const selectPrepUser = (id) => { prepUser.value = id; prepMode.value = 'list'; };
            const selectMoneyUser = (id) => { currentUserId.value = id; moneyMode.value = 'list'; };
            const addPrepItem = () => { const t=prompt('æ–°å¢é …ç›®:'); if(t) currentPrepList.value.push({text:t, checked:false}); };

            const openAddModal = () => { isEditing.value=false; editForm.value={name:'', category:'Sightseeing'}; showModal.value=true; };
            const editItem = (item,idx) => { isEditing.value=true; editIndex.value=idx; editForm.value={...item}; showModal.value=true; };
            const saveItem = () => { const list = itineraryData.value[selectedDayIndex.value] || []; const newItem = { ...editForm.value, id: isEditing.value ? editForm.value.id : Date.now() }; if (isEditing.value) list[editIndex.value] = newItem; else { if(!itineraryData.value[selectedDayIndex.value]) itineraryData.value[selectedDayIndex.value]=[]; itineraryData.value[selectedDayIndex.value].push(newItem); } showModal.value = false; };
            const deleteItem = (idx) => { if(confirm('åˆªé™¤?')) itineraryData.value[selectedDayIndex.value].splice(idx,1); };
            const openExpenseModal = () => { newExpense.value={name:'', amount:'', category:'é£Ÿ', currency:'JPY'}; showExpenseModal.value=true; };
            const addExpense = () => { if(newExpense.value.name && newExpense.value.amount) { expenses.value.push({id:Date.now(), user:currentUserId.value, ...newExpense.value, date:`${new Date().getMonth()+1}/${new Date().getDate()}`}); showExpenseModal.value=false; }};
            const deleteExpense = (id) => { if(confirm('åˆªé™¤?')) expenses.value = expenses.value.filter(e=>e.id!==id); };
            const openTicketModal = () => { showTicketModal.value = true; };
            
            const openAddCommonModal = (type) => { commonType.value=type; newCommon.value={text1:'', text2:''}; showCommonModal.value=true; };
            
            const autoTranslate = () => {
                const cn = newCommon.value.text1;
                for (const k in transDict) {
                    if(cn.includes(k)) { newCommon.value.text2 = transDict[k]; return; }
                }
            };

            const saveCommonItem = () => { 
                const t1 = newCommon.value.text1; 
                if(commonType.value === 'jp') { 
                    japanesePhrases.value.push({jp:newCommon.value.text2 || 'è«‹æ‰‹å‹•è¼¸å…¥', tw:t1}); 
                } else if(commonType.value === 'shop') { 
                    shoppingList.value[shopCat.value].push({name:t1, img:`https://placehold.co/200x200/FFD1DC/555?text=${t1}`}); 
                } else if(commonType.value === 'food') { 
                    foodList.value[foodLoc.value].push({name:t1, desc:'æ–°å¢', img:`https://placehold.co/200x200/orange/white?text=${t1}`, link:searchMap(t1)}); 
                } else if(commonType.value === 'photo') { 
                    photoSpots.value[photoArea.value].push({name:t1, img:`https://placehold.co/300x200/FFD1DC/555?text=${t1}`, link:searchMap(t1)}); 
                } 
                showCommonModal.value=false; 
            };

            const doGoogleSearch = () => { if(searchQuery.value) window.open(searchMap(searchQuery.value)); };
            const speak = (text) => { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; u.rate = 0.9; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); };
            
            const generateSyncCode = () => { syncCode.value=btoa(unescape(encodeURIComponent(JSON.stringify({itinerary:itineraryData.value, users:users.value, expenses:expenses.value, shop:shoppingList.value, food:foodList.value, photo:photoSpots.value, jp:japanesePhrases.value})))); navigator.clipboard.writeText(syncCode.value); syncMsg.value='å·²è¤‡è£½'; };
            const pasteSyncCode = async () => { try { const t=await navigator.clipboard.readText(); const d=JSON.parse(decodeURIComponent(escape(atob(t)))); itineraryData.value=d.itinerary||itineraryData.value; users.value=d.users||users.value; expenses.value=d.expenses||expenses.value; shoppingList.value=d.shop||shoppingList.value; foodList.value=d.food||foodList.value; photoSpots.value=d.photo||photoSpots.value; japanesePhrases.value=d.jp||japanesePhrases.value; syncMsg.value='æˆåŠŸ'; setTimeout(()=>showSyncModal.value=false,1500); } catch(e){syncMsg.value='éŒ¯èª¤';}};
            
            const getW = async (lat,lon,refVal) => { 
                try{ 
                    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,cloud_cover&timezone=Asia%2FTokyo`); 
                    const d=await r.json(); 
                    refVal.value={temp:d.current.temperature_2m, icon:d.current.weather_code<=3?'ğŸŒ¤ï¸':'ğŸŒ§ï¸', desc:d.current.weather_code<=3?'æ™´':'é›¨', visibility:Math.max(0,100-d.current.cloud_cover)}; 
                }catch(e){ 
                    // Fallback
                    refVal.value={temp:'18', icon:'ğŸŒ¥ï¸', desc:'å¤šé›²', visibility:'80'};
                } 
            };

            onMounted(() => {
                try {
                    const s = localStorage.getItem(STORAGE_KEY);
                    if(s) { 
                        const d = JSON.parse(s); 
                        itineraryData.value = d.itinerary || defaultItinerary;
                        users.value = d.users || users.value;
                        expenses.value = d.expenses || [];
                        shoppingList.value = d.shop || shoppingList.value;
                        foodList.value = d.food || foodList.value;
                        photoSpots.value = d.photo || photoSpots.value;
                        japanesePhrases.value = d.jp || japanesePhrases.value;
                    } else {
                        // å˜—è©¦è®€å– V17 èˆŠè³‡æ–™
                        const old = localStorage.getItem('tokyo_trip_v17');
                        if (old) {
                            const d = JSON.parse(old);
                            itineraryData.value = d.itinerary || defaultItinerary;
                            users.value = d.users || users.value;
                            expenses.value = d.expenses || [];
                        } else {
                            users.value.forEach(u => u.list = defaultPrep.map(t => ({text:t, checked:false})));
                        }
                    }
                } catch(e) {
                    console.error("Load Error:", e);
                    users.value.forEach(u => u.list = defaultPrep.map(t => ({text:t, checked:false})));
                }

                getW(35.6895, 139.6917, tokyoWeather); getW(35.3192, 139.5467, kamakuraWeather); getW(35.3606, 138.7274, fujiWeather);
                
                const sc = document.getElementById('sakura-container');
                for(let i=0;i<15;i++){ const e=document.createElement('div'); e.className='sakura'; e.style.left=Math.random()*100+'vw'; e.style.animationDuration=Math.random()*3+4+'s'; sc.appendChild(e); }
                
                isMounted.value = true;
            });

            watch([itineraryData, users, expenses, shoppingList, foodList, photoSpots, japanesePhrases], ()=>{
                localStorage.setItem(STORAGE_KEY, JSON.stringify({itinerary:itineraryData.value, users:users.value, expenses:expenses.value, shop:shoppingList.value, food:foodList.value, photo:photoSpots.value, jp:japanesePhrases.value}));
            }, {deep:true});

            return {
                isMounted, currentView, hasBanner, apps, goHome, getPageTitle, searchQuery, doGoogleSearch, handleTouchStart, handleTouchEnd,
                tokyoWeather, kamakuraWeather, fujiWeather, foodList, shoppingList, photoSpots, japanesePhrases, hotels,
                tripDays, selectedDayIndex, currentDayItinerary,
                moneyTab, users, currentUserId, userTotalExpense, filteredExpenses, settlements, getUserById, 
                prepUser, prepMode, selectPrepUser, selectMoneyUser, currentPrepList, addPrepItem,
                openAddModal, editItem, saveItem, deleteItem, showModal, editForm, isEditing,
                openExpenseModal, addExpense, showExpenseModal, newExpense, deleteExpense,
                getBorderColor, getCategoryColor, getCategoryName, getMapLink, getExpenseIcon,
                showCommonModal, commonType, newCommon, openAddCommonModal, saveCommonItem, shopCat, foodLoc, photoArea,
                speak, autoTranslate, daysUntilTrip, exchangeRate, getClothingAdvice,
                showSyncModal, syncCode, syncMsg, generateSyncCode, pasteSyncCode, prepMode, selectPrepUser, moneyMode, selectMoneyUser,
                showTicketModal, openTicketModal, suggestedTickets
            };
        }
    }).mount('#app');
</script>
</body>
</html>
