<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (Ultimate V43.0 Strict-Sync)</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>

<script>
    window.tailwind = {
        config: {
            theme: {
                extend: {
                    colors: {'chii-pink':'#FFD1DC','chii-deep-pink':'#FF9EAC','chii-blue':'#A2D2FF','chii-yellow':'#FFF5BA','chii-text':'#5D4037'},
                    fontFamily: {sans:['Zen Maru Gothic','sans-serif']},
                    animation: {'wiggle':'wiggle 3s ease-in-out infinite','float':'float 3s ease-in-out infinite','fade-in':'fadeIn 0.5s ease-out forwards','spin-slow':'spin 8s linear infinite','pulse-fast':'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite'},
                    keyframes: {
                        wiggle: {'0%,100%':{transform:'rotate(-3deg)'},'50%':{transform:'rotate(3deg)'}},
                        float: {'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-5px)'}},
                        fadeIn: {from:{opacity:0,transform:'translateY(10px)'},to:{opacity:1,transform:'translateY(0)'}}
                    }
                }
            }
        }
    }
</script>

<style>
    /* V43.0 Strict Core - UI Repaired */
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: "Zen Maru Gothic", sans-serif; color: #5D4037; overflow: hidden; -webkit-tap-highlight-color: transparent; background-color: #FFF0F5; overscroll-behavior: none; }
    input, textarea, select { font-size: 16px !important; }
    
    #app-content { height: 100%; overflow-y: auto; overflow-x: hidden; padding-bottom: 160px; padding-top: env(safe-area-inset-top); transition: padding-bottom 0.3s ease; }
    #app-content.view-shopping { padding-bottom: 350px !important; } /* å¢åŠ åº•éƒ¨ç©ºé–“çµ¦æŠ˜åƒ¹åˆ¸ */

    #fixed-bg { position: fixed; inset: 0; z-index: -1; background-color: #FFF0F5; background-image: radial-gradient(#FFD1DC 15%, transparent 16%), radial-gradient(#FFF5BA 15%, transparent 16%); background-size: 60px 60px; background-position: 0 0, 30px 30px; }
    
    .card { background: rgba(255,255,255,0.92); border-radius: 24px; box-shadow: 0 8px 30px rgba(255,105,180,0.12); border: 2px solid rgba(255,255,255,0.8); margin-bottom: 0; position: relative; backdrop-filter: blur(10px); transition: all 0.3s ease; transform: translateZ(0); }
    .card-chii { border: 3px solid #FFD1DC; box-shadow: 4px 4px 0px #FF9EAC; }

    /* FAB System - Repaired Layering */
    .fab-home {
        position: fixed; bottom: calc(25px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%);
        width: 68px; height: 68px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 28px; color: white; z-index: 300; /* æé«˜å±¤ç´šï¼Œé«˜æ–¼ Coupon Bar (200) */
        border: 4px solid white; box-shadow: 0 10px 25px rgba(255,105,180,0.5); 
        background: linear-gradient(135deg,#FF9EAC,#FFD1DC); cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .fab-home.lifted { bottom: calc(110px + env(safe-area-inset-bottom)); } /* ç•¶æœ‰æŠ˜åƒ¹åˆ¸æ™‚å‘ä¸Šæµ®å‹• */

    .fab-main {
        position: fixed; bottom: calc(100px + env(safe-area-inset-bottom)); right: 20px;
        width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 22px; color: white; z-index: 290; border: 3px solid white; box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        transition: all 0.3s;
    }
    .fab-main.lifted { bottom: calc(190px + env(safe-area-inset-bottom)); } /* å°æ‡‰ Home éµä¸€èµ·ä¸Šç§» */

    .fab-search { position: fixed; bottom: calc(30px + env(safe-area-inset-bottom)); left: 20px; width: 54px; height: 54px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #5D4037; z-index: 290; border: 2px solid white; background: rgba(255,255,255,0.9); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
    
    .coupon-bar {
        position: fixed; bottom: 0; left: 0; right: 0; 
        background: rgba(255,255,255,0.98); backdrop-filter: blur(10px);
        padding: 16px 20px; padding-bottom: calc(30px + env(safe-area-inset-bottom)); 
        border-top: 1px solid rgba(255,192,203,0.5); z-index: 200; /* è¨­å®šç‚º 200 */
        display: flex; justify-content: center; align-items: center;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.1); 
        transform: translateY(0); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .coupon-bar.hidden { transform: translateY(150%); }

    .welcome-screen { position: fixed; inset: 0; z-index: 9999; background: #FFF0F5; transition: transform 0.8s cubic-bezier(0.7,0,0.3,1); }
    .welcome-screen.hidden-screen { transform: translateY(-100%); pointer-events: none; }
    
    .cloud-status {
        position: fixed; bottom: calc(30px + env(safe-area-inset-bottom)); left: 80px;
        font-size: 10px; font-weight: bold; color: #aaa; display: flex; align-items: center; gap: 6px; z-index: 50;
        background: rgba(255,255,255,0.85); padding: 6px 12px; border-radius: 20px; border: 1px solid white; cursor: pointer;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; transition: all 0.3s; }

    /* Utilities */
    [v-cloak] { display: none !important; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .sakura { position: fixed; top: -20px; background: #FFB7B2; border-radius: 100% 0 100% 0; opacity: 0.6; animation: fall linear infinite; z-index: 0; pointer-events: none; width: 14px; height: 14px; }
    @keyframes fall { to { transform: translate(10vw, 105vh) rotate(360deg); } }
    .timeline-connect { width: 2px; height: 50px; background: repeating-linear-gradient(to bottom, #FFD1DC 0, #FFD1DC 5px, transparent 5px, transparent 10px); margin: 0 auto; position: relative; }
</style>
</head>
<body>
<div id="fixed-bg"></div>
<div id="sakura-container"></div>
<div id="app" v-cloak class="h-full flex flex-col">
    
    <div :class="['welcome-screen flex flex-col items-center justify-between', isWelcomeClosed ? 'hidden-screen' : '']">
        <div class="absolute inset-0 z-0"><img :src="getImg('welcome.jpg')" class="w-full h-full object-cover opacity-90" @error="handleImgError"></div>
        <div class="absolute top-6 right-6 z-50 pt-[env(safe-area-inset-top)]">
            <button @click.stop="handleAuthClick" :class="['flex items-center gap-2 px-4 py-2 rounded-full backdrop-blur-md border border-white/50 shadow-lg font-bold text-sm transition', isLoggedIn ? 'bg-green-500/80 text-white' : 'bg-white/40 text-gray-800']">
                <i :class="isLoggedIn ? 'fa-solid fa-cloud' : 'fa-solid fa-cloud-arrow-up'"></i> {{ isLoggedIn ? 'å·²é€£ç·š (V43)' : 'é›²ç«¯åŒæ­¥' }}
            </button>
        </div>
        <div class="relative z-10 mt-32 text-center px-6">
            <div class="inline-block bg-white/40 backdrop-blur-md px-6 py-2 rounded-full text-white text-xs font-black tracking-[0.2em] border border-white/50 mb-6 shadow-lg">ULTIMATE V43</div>
            <h1 class="text-7xl font-black text-white drop-shadow-lg tracking-widest mb-2 font-sans">é—œæ±ä¹‹æ—…</h1>
            <p class="text-3xl text-white/90 font-bold tracking-widest drop-shadow-md">2026.03.27</p>
        </div>
        <div class="relative z-10 mb-20 w-full px-10 pb-[env(safe-area-inset-bottom)] space-y-4">
            <button @click="enterSite" class="w-full bg-white/90 text-pink-500 font-black py-4 rounded-full shadow-2xl backdrop-blur-xl text-xl flex items-center justify-center gap-3 border border-white animate-pulse-fast">
                <span class="animate-spin-slow">ğŸŒ¸</span> æ—…ä¼´ç™»å…¥
            </button>
            <button @click="enterAsGuest" class="w-full bg-gray-800/60 text-white font-bold py-3 rounded-full backdrop-blur-md text-sm border border-white/30 hover:bg-gray-800/80 transition">
                <i class="fa-solid fa-user-secret"></i> è¨ªå®¢åƒè§€ (å”¯è®€)
            </button>
        </div>
    </div>

    <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-[60px] bg-[#FFF0F5]/90 backdrop-blur-xl z-30 flex items-center justify-between px-4 border-b border-white/50 shadow-sm pt-[env(safe-area-inset-top)] box-content transition-all">
        <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow-md border border-white active:scale-90 transition"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="font-black text-gray-700 text-lg flex items-center gap-2"><i class="fa-solid fa-sakura text-pink-300"></i> {{getPageTitle(currentView)}}</h1>
        <div class="w-10"></div>
    </div>
    <div v-if="currentView !== 'menu'" class="h-[60px] pt-[env(safe-area-inset-top)] box-content shrink-0"></div>

    <div id="app-content" class="flex-1" :class="{'view-shopping': currentView === 'shopping'}">
        
        <div v-if="currentView==='menu'" class="p-6 pt-12 animate-fade-in pb-32">
            <h2 class="text-3xl font-black text-gray-700 mb-8 text-center pt-[env(safe-area-inset-top)]">æ—…ç¨‹ä¸­å¿ƒ</h2>
            <div class="mb-8 bg-white/70 backdrop-blur-xl border border-white rounded-[32px] p-6 shadow-xl relative overflow-hidden card-chii">
                 <div class="flex items-start gap-4 relative z-10">
                     <div class="bg-gradient-to-br from-yellow-200 to-yellow-400 w-12 h-12 rounded-2xl flex items-center justify-center text-white text-xl shrink-0 shadow-lg"><i class="fa-solid fa-bell"></i></div>
                     <div class="flex-1">
                         <div class="font-black text-gray-800 text-lg mb-1">å€’æ•¸ {{daysUntilTrip}} å¤©</div>
                         <div class="text-xs text-gray-500 font-bold leading-relaxed space-y-1">
                            <div v-for="alert in smartReminders" class="text-pink-500 flex items-start gap-1 font-black"><i class="fa-solid fa-circle-exclamation mt-0.5"></i> {{alert}}</div>
                            <div class="text-gray-400 mt-2 pt-2 border-t border-gray-200">
                                <div class="flex items-center gap-1"><i class="fa-solid fa-check text-green-400"></i> è­·ç…§æœŸé™æª¢æŸ¥</div>
                            </div>
                         </div>
                     </div>
                 </div>
            </div>
            <div class="grid grid-cols-3 gap-x-4 gap-y-8 px-2">
                <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition duration-300 group" @click="currentView=app.view">
                    <div class="w-[76px] h-[76px] rounded-[30px] flex items-center justify-center text-3xl text-white shadow-lg border-[4px] border-white relative overflow-hidden" :class="app.bgClass"><i :class="app.icon"></i></div>
                    <span class="text-sm font-bold mt-3 text-gray-600 group-hover:text-pink-500 transition">{{app.name}}</span>
                </div>
            </div>
        </div>

        <div v-if="currentView==='itinerary'" class="px-5 py-4 animate-fade-in">
            <div class="flex overflow-x-auto gap-3 mb-6 hide-scrollbar sticky top-0 bg-[#FFF0F5]/95 z-20 py-3 -mx-5 px-5 backdrop-blur-md">
                 <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-6 py-3 rounded-2xl text-sm font-black border-2 transition shrink-0 shadow-sm flex flex-col items-center min-w-[70px]',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400 shadow-lg scale-105':'bg-white text-gray-300 border-white']"><span>{{d.week}}</span><span class="text-[10px] mt-1 opacity-80">{{d.title}}</span></button>
            </div>
            <div class="pb-20 relative">
                <div v-for="(item,idx) in getCurrentItinerary()" :key="idx">
                    <div class="card p-5 border-0 shadow-sm relative group z-10 mb-4" @click="!isGuest && openEditItineraryModal(item, idx)">
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-pink-300 to-pink-100"></div>
                        <div class="flex gap-4 pr-8">
                            <div class="flex flex-col items-center pt-1 min-w-[50px]">
                                <span class="text-xs font-black text-gray-400 mb-2">{{item.hours}}</span>
                                <div class="w-10 h-10 rounded-full text-lg flex items-center justify-center border bg-pink-50 text-pink-400 border-pink-100"><i :class="getIconByCategory(item.category)"></i></div>
                            </div>
                            <div class="flex-1 py-1">
                                <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                                <p class="text-sm text-gray-500 line-clamp-2 font-medium mb-2">{{item.note}}</p>
                                <a :href="getMapLink(item.mapKeyword, item.name)" target="_blank" @click.stop class="inline-flex items-center gap-1 text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded-full font-bold border border-blue-100"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                            </div>
                        </div>
                    </div>
                    <div v-if="idx < getCurrentItinerary().length - 1" class="timeline-connect !h-[40px] mb-4">
                        <div v-if="item.travelTime" class="timeline-badge absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white border border-pink-200 px-2 py-1 rounded-full text-[10px] text-pink-400 font-bold whitespace-nowrap shadow-sm">{{item.travelTime}}</div>
                    </div>
                </div>
                <button v-if="!isGuest" @click="openAddItineraryModal" class="w-full py-4 mt-6 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white/50 transition"><i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹</button>
            </div>
        </div>

        <div v-if="currentView==='shopping'" class="px-5 py-4 animate-fade-in">
            <div class="grid grid-cols-2 gap-3 mb-6"><a href="https://www.cosme.net/ranking/" target="_blank" class="bg-green-50 text-green-600 p-3 rounded-xl text-center font-bold text-xs border border-green-200 block">ğŸ‘‘ COSME å¤§è³</a><a href="https://www.shinyusha.co.jp/media/ldk-the-beauty/" target="_blank" class="bg-pink-50 text-pink-600 p-3 rounded-xl text-center font-bold text-xs border border-pink-200 block">ğŸ’„ LDK æ¯’èˆŒé›œèªŒ</a></div>
            <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar"><button v-for="cat in ['cosme','ldk','souvenir']" @click="shopCat=cat" :class="['px-5 py-2 rounded-full font-bold text-xs whitespace-nowrap transition', shopCat===cat?'bg-pink-400 text-white':'bg-white text-gray-400']">{{{'cosme':'è—¥å¦æ¸…å–®','ldk':'LDKæ¨è–¦','souvenir':'ä¼´æ‰‹ç¦®'}[cat]}}</button></div>
            <div class="grid grid-cols-2 gap-4">
                <div v-for="(item,idx) in shopping[shopCat]" class="card !p-0 border-0 shadow-lg group relative" :key="idx">
                    <div class="h-32 bg-gray-100 relative overflow-hidden"><img :src="item.img || 'https://placehold.co/300x300/pink/white?text=SHOP'" class="w-full h-full object-cover" @error="handleImgError"></div>
                    <div class="p-3">
                        <div class="font-bold text-gray-800 text-sm mb-1 truncate">{{item.name}}</div>
                        <a :href="item.link || getSearchLink(item.name)" target="_blank" class="block text-center bg-gray-50 text-gray-500 text-[10px] py-1.5 rounded font-bold hover:bg-pink-500 hover:text-white transition">å‰å¾€å®˜ç¶² / æœå°‹</a>
                    </div>
                    <div v-if="!isGuest" class="absolute top-1 right-1 flex gap-1"><button @click="openEditModal('shopping', item, idx)" class="bg-white/90 p-1.5 rounded-full text-blue-400 shadow w-7 h-7 flex items-center justify-center"><i class="fa-solid fa-pen text-[10px]"></i></button><button @click="shopping[shopCat].splice(idx,1);saveData()" class="bg-white/90 p-1.5 rounded-full text-red-400 shadow w-7 h-7 flex items-center justify-center"><i class="fa-solid fa-trash text-[10px]"></i></button></div>
                </div>
            </div>
            <button v-if="!isGuest" @click="openAddShopModal" class="fab-main bg-purple-400 text-white" :class="{'lifted': currentView === 'shopping'}"><i class="fa-solid fa-plus"></i></button>
            <div class="coupon-bar" :class="{'hidden': currentView !== 'shopping'}">
                <button @click="showCouponModal=true" class="w-full bg-gradient-to-r from-red-500 to-pink-600 text-white font-black py-3 rounded-full shadow-lg flex items-center justify-center gap-2 animate-bounce"><i class="fa-solid fa-ticket"></i> ğŸ‡¯ğŸ‡µ æ¿€çœæŠ˜åƒ¹åˆ¸ (é»æˆ‘ç·¨è¼¯)</button>
            </div>
        </div>

        <div v-if="['food','photo','japanese','weather','money','hotel','prep'].includes(currentView)" class="px-5 py-4 animate-fade-in">
             <div v-if="currentView==='food' || currentView==='photo'">
                <div class="flex gap-2 mb-4 justify-center"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="currentLoc=loc" :class="['px-5 py-2 rounded-full font-bold text-xs transition', currentLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc]}}</button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20">
                    <div v-for="(item,idx) in spots[currentView][currentLoc]" :key="idx" class="card !p-0 border-0 shadow-lg group relative">
                        <div class="h-48 bg-gray-100 relative overflow-hidden"><img :src="item.img || 'https://placehold.co/600x400/orange/white?text=SPOT'" class="w-full h-full object-cover" @error="handleImgError"></div>
                        <div class="p-4">
                            <h3 class="font-black text-gray-800 text-lg mb-1 flex items-center justify-between">{{item.name}}</h3>
                            <p class="text-sm text-gray-500 mb-3 font-bold">{{item.desc}}</p>
                            <a :href="getMapLink(item.link, item.name)" target="_blank" class="block w-full text-center bg-gray-50 text-gray-600 font-bold py-3 rounded-lg text-sm border hover:bg-orange-400 hover:text-white transition"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                        </div>
                        <div v-if="!isGuest" class="absolute top-2 right-2 flex gap-2"><button @click="openEditModal(currentView==='food'?'food':'spot', item, idx)" class="w-8 h-8 bg-white rounded-full shadow text-blue-500 flex items-center justify-center"><i class="fa-solid fa-pen"></i></button><button @click="spots[currentView][currentLoc].splice(idx,1);saveData()" class="w-8 h-8 bg-white rounded-full shadow text-red-500 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button></div>
                    </div>
                </div>
                <button v-if="!isGuest" @click="currentView==='food'?openAddFoodModal():openAddSpotModal()" class="fab-main bg-orange-400 text-white"><i class="fa-solid fa-plus"></i></button>
             </div>
             <div v-if="currentView==='weather'" class="text-center py-10"><i class="fa-solid fa-cloud-sun text-6xl text-sky-300 mb-4"></i><div class="font-bold text-gray-600">å³æ™‚å¤©æ°£è¼‰å…¥ä¸­...</div></div>
             <div v-if="currentView==='prep'" class="text-center py-10"><i class="fa-solid fa-suitcase text-6xl text-blue-300 mb-4"></i><div class="font-bold text-gray-600">è¡Œå‰æ¸…å–®ç®¡ç†</div></div>
             <div v-if="currentView==='money'" class="text-center py-10"><i class="fa-solid fa-yen-sign text-6xl text-yellow-300 mb-4"></i><div class="font-bold text-gray-600">è¨˜å¸³åŠŸèƒ½</div></div>
             <div v-if="currentView==='hotel'" class="text-center py-10"><i class="fa-solid fa-hotel text-6xl text-indigo-300 mb-4"></i><div class="font-bold text-gray-600">ä½å®¿èˆ‡äº¤é€š</div></div>
        </div>

    </div>

    <div v-if="currentView!=='menu'" class="fab-home" :class="{'lifted': currentView === 'shopping'}" @click="currentView='menu'"><i class="fa-solid fa-house"></i></div>
    
    <div class="cloud-status" @click="showDiagnostic">
        <div class="status-dot" :class="syncStatusColor"></div>
        <span v-if="syncStatus === 'error'" class="underline ml-1 font-bold text-red-400">é‡è©¦</span>
        <span v-else>{{ syncStatusText }}</span>
    </div>

    <div v-if="showCouponModal" class="fixed inset-0 z-[3000] bg-black/60 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-2xl text-pink-500"><i class="fa-solid fa-ticket"></i> å„ªæƒ åˆ¸</h3>
                <div class="flex gap-2">
                    <button v-if="!isGuest" @click="openAddCouponModal" class="bg-gray-100 text-gray-600 w-8 h-8 rounded-full"><i class="fa-solid fa-plus"></i></button>
                    <button @click="showCouponModal=false" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto space-y-4">
                <div v-for="(c, idx) in coupons" class="border border-pink-200 rounded-xl p-4 relative overflow-hidden bg-pink-50/30 group">
                    <div class="absolute -right-6 -top-6 w-20 h-20 bg-pink-500 rounded-full opacity-10"></div>
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-black text-lg text-gray-800">{{c.name}}</h4>
                        <span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow">{{c.discount}}</span>
                    </div>
                    <p class="text-xs text-gray-500 font-bold mb-3"><i class="fa-solid fa-circle-exclamation text-pink-400"></i> {{c.note}}</p>
                    <a :href="c.link" target="_blank" class="block w-full bg-pink-500 text-white text-center font-bold py-3 rounded-lg shadow-md active:scale-95 transition">ä½¿ç”¨ / æ¢ç¢¼</a>
                    <button v-if="!isGuest" @click="coupons.splice(idx,1);saveData()" class="absolute bottom-2 right-2 text-red-300 opacity-50 hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showPersonaModal" class="fixed inset-0 z-[2000] bg-black/85 flex items-center justify-center p-6 backdrop-blur-lg animate-fade-in">
        <div class="bg-white/95 w-full max-w-sm rounded-[32px] p-8 text-center shadow-2xl relative border-[6px] border-pink-100">
            <div class="absolute -top-10 left-0 right-0 flex justify-center"><div class="bg-pink-500 text-white px-6 py-2 rounded-full font-black text-lg shadow-lg border-2 border-white animate-bounce-slow">è«‹å•æ‚¨æ˜¯å“ªä¸€ä½ï¼Ÿ</div></div>
            <div class="grid grid-cols-2 gap-6 mt-6">
                <div v-for="u in users" :key="u.id" class="relative group cursor-pointer" @click="setCurrentUser(u)">
                    <div class="w-24 h-24 mx-auto rounded-full bg-white border-4 border-gray-100 shadow-lg flex items-center justify-center text-4xl mb-3 overflow-hidden transition-all duration-300 group-hover:scale-110 group-hover:border-pink-300 group-hover:shadow-pink-200">
                        <img v-if="u.avatar" :src="u.avatar" class="w-full h-full object-cover">
                        <span v-else>{{u.icon}}</span>
                    </div>
                    <div class="font-black text-gray-600 text-lg group-hover:text-pink-500 transition">{{u.name}}</div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showModal" class="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-center">{{modalTitle}}</h3>
            <div class="space-y-3">
                <div v-for="f in modalFields" :key="f.key">
                    <label v-if="f.label" class="text-xs font-bold text-gray-400 ml-1 mb-1 block">{{f.label}}</label>
                    <input v-if="f.key!=='note'" v-model="modalData[f.key]" :placeholder="f.placeholder" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-pink-300">
                    <textarea v-else v-model="modalData[f.key]" :placeholder="f.placeholder" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-pink-300 h-24"></textarea>
                </div>
                <button v-if="modalHasImg" @click="$refs.modalImgInput.click()" class="w-full py-3 bg-blue-50 text-blue-500 rounded-xl font-bold border border-blue-100">{{modalData.img?'æ›´æ›åœ–ç‰‡':'ä¸Šå‚³åœ–ç‰‡'}}</button>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                <button @click="handleModalSave" class="flex-1 py-3 bg-pink-500 text-white rounded-xl font-bold shadow-lg">å„²å­˜</button>
            </div>
            <input type="file" ref="modalImgInput" accept="image/*" class="hidden" @change="processModalImg">
        </div>
    </div>

    <div v-if="showLoginModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-3xl p-8 shadow-2xl"><h3 class="text-2xl font-black text-center mb-6">åŒæ­¥é›²ç«¯</h3><input v-model="loginForm.email" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 font-bold" placeholder="Email"><input v-model="loginForm.password" type="password" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 font-bold" placeholder="Password"><button @click="doLogin" class="w-full py-4 bg-pink-500 text-white font-black rounded-2xl">ç™»å…¥</button><button @click="showLoginModal=false" class="w-full py-2 mt-2 text-gray-400 font-bold">å–æ¶ˆ</button></div></div>

</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, enableIndexedDbPersistence, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { createApp, ref, computed, onMounted, watch, nextTick } from "https://unpkg.com/vue@3.3.4/dist/vue.esm-browser.js";

// V43.1 Config
const firebaseConfig = { 
    apiKey: "AIzaSyD3ojbkJVfDKmZQHRpZG-gp8gv7ajKdJr4", 
    authDomain: "tokyo-trip-24b28.firebaseapp.com", 
    projectId: "tokyo-trip-24b28", 
    storageBucket: "tokyo-trip-24b28.firebasestorage.app", 
    messagingSenderId: "518699705070", 
    appId: "1:518699705070:web:56e95f603210d8d5d209ff" 
};

let auth, db; 
try { 
    const app = initializeApp(firebaseConfig); 
    auth = getAuth(app); 
    db = getFirestore(app); 
    enableIndexedDbPersistence(db).catch(err => console.log("Persistence:", err.code));
} catch (e) { console.error("Firebase Init Error:", e); }

// ã€å®Œæ•´è³‡æ–™çµæ§‹é‚„åŸã€‘ - ä¿®æ­£åŒæ­¥éŒ¯èª¤çš„é—œéµ
// ä¹‹å‰å› ç‚ºç¸®æ¸›äº†é€™è£¡ï¼Œå°è‡´ save function æ‰¾ä¸åˆ°è®Šæ•¸è€Œå ±éŒ¯
const defaultPrepList = [{text:'è­·ç…§',checked:false},{text:'æ—¥å¹£',checked:false},{text:'ç¶²å¡/æ¼«éŠ',checked:false},{text:'è¡Œå‹•é›»æº',checked:false}];
const defaultData = {
    users: [
        {id:1,name:'å‰ä¼Š',icon:'ğŸ¹',avatar:'',list:[...defaultPrepList],lastActive:0},
        {id:2,name:'å°å…«',icon:'ğŸ±',avatar:'',list:[...defaultPrepList],lastActive:0},
        {id:3,name:'å…”å…”',icon:'ğŸ°',avatar:'',list:[...defaultPrepList],lastActive:0},
        {id:4,name:'å°æ¡ƒ',icon:'ğŸ‘',avatar:'',list:[...defaultPrepList],lastActive:0}
    ],
    itinerary: [
        [{hours:"06:40",category:"Flight",name:"TPE èµ·é£›",note:"T1 è¾¦ç†ç™»æ©Ÿ",mapKeyword:"æ¡ƒåœ’æ©Ÿå ´ T1"},{hours:"10:40",category:"Flight",name:"NRT æŠµé”",note:"é ˜å–è¡Œæ/è³¼è²·è¥¿ç“œå¡",mapKeyword:"æˆç”°æ©Ÿå ´"},{hours:"14:00",category:"Sightseeing",name:"æ™´ç©ºå¡”",note:"ä¸‹åˆè¡Œç¨‹",mapKeyword:"æ±äº¬æ™´ç©ºå¡”",travelTime:"â¬‡ 60-90min (é›»è»Š/å·´å£«)"}],
        [{hours:"09:00",category:"Sightseeing",name:"æ·ºè‰å¯º",note:"é›·é–€/ä»²è¦‹ä¸–é€š",mapKeyword:"æ·ºè‰å¯º",travelTime:"â¬‡ 20min (é›»è»Š)"},{hours:"12:00",category:"Food",name:"æ·ºè‰å‘¨é­",note:"åˆé¤",mapKeyword:"æ·ºè‰ç«™ ç¾é£Ÿ"}],
        [{hours:"08:00",category:"Transport",name:"å‰å¾€å¯Œå£«å±±",note:"éŒ¦ç³¸ç”ºå‡ºç™¼ (å¯Œå£«å›éŠ)",mapKeyword:"éŒ¦ç³¸ç”ºç«™",travelTime:"â¬‡ 120min (JRç‰¹æ€¥)"}],
        [{hours:"05:00",category:"Sightseeing",name:"å¹³é‡ä¹‹æ¿±",note:"çœ‹æ—¥å‡º (è¦–å¤©æ°£)",mapKeyword:"å¹³é‡ã®æµœ",travelTime:"â¬‡ 30min (è»Š)"}],
        [{hours:"09:00",category:"Sightseeing",name:"æ²³å£æ¹–çºœè»Š",note:"é‡‘é³¥å±…/çµ•æ™¯é¦éŸ†",mapKeyword:"æ²³å£æ¹– å¯Œå£«å±±å…¨æ™¯çºœè»Š",travelTime:"â¬‡ 20min (è»Š)"}],
        [{hours:"09:00",category:"Transport",name:"å‰å¾€è—¤æ¾¤",note:"æ–°å®¿å‡ºç™¼ (æ±Ÿä¹‹é›»ä¸€æ—¥éŠ)",mapKeyword:"æ–°å®¿ç«™",travelTime:"â¬‡ 60min (å°ç”°æ€¥)"}],
        [{hours:"09:00",category:"Sightseeing",name:"æ±äº¬éµå¡”/éº»å¸ƒå°",note:"å…­æœ¬æœ¨å‘¨é­æ‹ç…§",mapKeyword:"éº»å¸ƒå°Hills",travelTime:"â¬‡ 30min (åœ°éµ)"}],
        [{hours:"10:00",category:"Sightseeing",name:"è‡ªç”±è¡Œç¨‹",note:"æœ€å¾Œæ¡è²·",mapKeyword:"ä¸Šé‡é˜¿ç¾æ©«ä¸",travelTime:"â¬‡ 0min"},{hours:"20:40",category:"Flight",name:"NRT èµ·é£›",note:"æˆç”°æ©Ÿå ´å ±åˆ°",mapKeyword:"æˆç”°æ©Ÿå ´"}]
    ],
    // ä¹‹å‰æ¼æ‰çš„é‡è¦è³‡æ–™çµæ§‹
    drivePlan: [[{hours:"08:00",category:"Transport",name:"å‰å¾€å¯Œå£«å±±",note:"éŒ¦ç³¸ç”ºå‡ºç™¼",travelTime:"ğŸš— 120min"}], [{hours:"05:00",category:"Sightseeing",name:"å¹³é‡ä¹‹æ¿±",note:"çœ‹æ—¥å‡º",travelTime:"ğŸš— 30min"}]],
    shopping: {
        cosme: [{name:'Canmake è‡¥è ¶ç›¤',link:''},{name:'Kate æ€ªç¸å”‡è†',link:''}],
        ldk: [{name:'MINON èƒºåŸºé…¸é¢è†œ',link:''},{name:'Quality 1st é¢è†œ',link:''}],
        souvenir: [{name:'NY Perfect Cheese',link:''},{name:'Press Butter Sand',link:''}]
    },
    coupons: [
        {name: 'å”å‰è¨¶å¾·', discount: '10% (å…ç¨…) + 5%', link: 'https://www.djapanpass.com/coupon/0002000103', note: 'æœªç¨…æ»¿ 1è¬æ—¥åœ“'},
        {name: 'Bic Camera', discount: '10% (å…ç¨…) + 7%', link: '', note: 'å‡ºç¤ºè­·ç…§'}
    ],
    spots: { 
        food: {Tokyo:[{name:'AFURI',desc:'æŸšå­é¹½æ‹‰éºµ',link:'AFURI'}], Kamakura:[{name:'Bills',desc:'é¬†é¤…',link:'Bills'}], Fuji:[{name:'ä¸å‹•èŒ¶å±‹',desc:'é¤ºé£¥éºµ',link:'ä¸å‹•èŒ¶å±‹'}]}, 
        photo: {Tokyo:[{name:'SHIBUYA SKY',desc:'å±•æœ›å°',link:'SHIBUYA SKY'}], Kamakura:[{name:'çŒç±ƒé«˜æ‰‹å¹³äº¤é“',desc:'éŒå€‰é«˜æ ¡å‰',link:'éŒå€‰é«˜æ ¡å‰'}], Fuji:[{name:'æ–°å€‰å±±æ·ºé–“å…¬åœ’',desc:'å¿ éˆå¡”',link:'æ–°å€‰å±±æ·ºé–“å…¬åœ’'}]} 
    },
    transportTickets: [
        {name:'æ±äº¬åœ°éµåˆ¸ (24/48/72h)', url:'https://www.tokyometro.jp/tcn/ticket/travel/index.html', icon:'fa-solid fa-subway', note:'æ±äº¬ Metro + éƒ½ç‡Ÿåœ°éµ'},
        {name:'Suica è¥¿ç“œå¡', url:'', icon:'fa-solid fa-mobile-screen', note:'ç¶å®š iPhone éŒ¢åŒ…'}
    ],
    rentalCars: [
        {company: 'Toyota Rent a Car', pickup: 'æ²³å£æ¹–ç«™å‰åº—', url: 'https://rent.toyota.co.jp/zh-tw/', note: 'éœ€æº–å‚™å°ç£é§•ç…§ + æ—¥æ–‡è­¯æœ¬', status: 'todo', reservationNumber:'', insurance:''}
    ],
    hotels: [
        {name:'éŒ¦ç³¸ç”ºæ°‘å®¿', img:'bnb.jpg', link:'éŒ¦ç³¸ç”º æ°‘å®¿'},
        {name:'Megu Fuji', img:'megu.jpg', link:'Megu Fuji 2026'}
    ],
    phrases: [{jp:'ã™ã¿ã¾ã›ã‚“',zh:'ä¸å¥½æ„æ€/è«‹å•'},{jp:'ã“ã‚Œãã ã•ã„',zh:'æˆ‘è¦é€™å€‹'},{jp:'ã„ãã‚‰ã§ã™ã‹',zh:'è«‹å•å¤šå°‘éŒ¢'}]
};

createApp({
    setup() {
        // Core State
        const currentView = ref('welcome');
        const currentUser = ref(null);
        const isGuest = ref(false); 
        const showPersonaModal = ref(false);
        const showUserEditModal = ref(false);
        const editingUser = ref({});
        const isWelcomeClosed = ref(false);
        const showLoginModal = ref(false);
        const loginForm = ref({email:'',password:''});
        const isLoggedIn = ref(false);
        
        // V43.1 Sync Engine - Strict Safety
        const syncStatus = ref('offline'); 
        const isDataLoaded = ref(false); // é—œéµï¼šè³‡æ–™è¼‰å…¥é–
        const syncStatusText = computed(() => ({'offline':'é›¢ç·š','synced':'å·²åŒæ­¥','saving':'å„²å­˜ä¸­...','error':'åŒæ­¥éŒ¯èª¤ (ç¼ºå°‘æ¬„ä½)'}[syncStatus.value]));
        const syncStatusColor = computed(() => ({'offline':'bg-gray-400','synced':'bg-green-400','saving':'bg-yellow-400','error':'bg-red-500'}[syncStatus.value]));

        // Data Refs - å®Œæ•´å®šç¾©ï¼Œé¿å… undefined éŒ¯èª¤
        const users = ref(JSON.parse(JSON.stringify(defaultData.users)));
        const itinerary = ref(defaultData.itinerary);
        const drivePlan = ref(defaultData.drivePlan);
        const expenses = ref([]); // ä¹‹å‰æ¼äº†é€™å€‹ï¼Œå°è‡´è¨˜å¸³åŠŸèƒ½å­˜æª”å¤±æ•—
        const spots = ref(defaultData.spots);
        const shopping = ref(defaultData.shopping);
        const japanesePhrases = ref(defaultData.phrases);
        const suggestedTickets = ref([]); 
        const transportTickets = ref(defaultData.transportTickets);
        const rentalCars = ref(defaultData.rentalCars);
        const hotels = ref(defaultData.hotels);
        const coupons = ref(defaultData.coupons);
        
        // View State
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        const exchangeRate = ref(0.215);
        const moneyTab = ref('record');
        const hotelTab = ref('stay');
        const shopCat = ref('cosme');
        const currentLoc = ref('Tokyo');
        const weatherData = ref([
            {name:'Tokyo', name_zh:'æ±äº¬', temp:'--', tempValue:20, bg:'bg-blue-400', icon:'fa-solid fa-sun'},
            {name:'Kamakura', name_zh:'éŒå€‰', temp:'--', tempValue:20, bg:'bg-indigo-400', icon:'fa-solid fa-cloud-sun'},
            {name:'Fuji', name_zh:'å¯Œå£«å±±', temp:'--', tempValue:15, bg:'bg-purple-400', icon:'fa-solid fa-snowflake'}
        ]);
        
        // Modal State
        const showModal = ref(false);
        const modalTitle = ref('');
        const modalFields = ref([]);
        const modalData = ref({});
        const modalHasImg = ref(false);
        const modalCallback = ref(null);
        const isEditingItem = ref(false); 
        const modalDeleteCallback = ref(null);
        const showCouponModal = ref(false);
        const showExpenseModal = ref(false);
        const expenseMode = ref('private'); 
        const expandedPhrase = ref(null);
        const showFlightModal = ref(false);
        const tempFlightData = ref({code:'',seat:''});
        const flightMode = ref('out'); 
        const showRentalModal = ref(false);
        const activeRental = ref({});
        
        const apps = [{id:1,name:'è¡Œç¨‹',icon:'fa-solid fa-map',view:'itinerary',bgClass:'bg-pink-400'},{id:2,name:'å°è²¡åº«',icon:'fa-solid fa-yen-sign',view:'money',bgClass:'bg-yellow-400'},{id:3,name:'ä½å®¿äº¤é€š',icon:'fa-solid fa-hotel',view:'hotel',bgClass:'bg-indigo-400'},{id:4,name:'è¡Œå‰æº–å‚™',icon:'fa-solid fa-suitcase',view:'prep',bgClass:'bg-blue-400'},{id:5,name:'åƒåƒå–å–',icon:'fa-solid fa-utensils',view:'food',bgClass:'bg-orange-400'},{id:6,name:'ç¶²ç¾æ‰“å¡',icon:'fa-solid fa-camera',view:'photo',bgClass:'bg-rose-400'},{id:7,name:'å¿«æ¨‚è³¼',icon:'fa-solid fa-bag-shopping',view:'shopping',bgClass:'bg-purple-400'},{id:8,name:'å¤©æ°£',icon:'fa-solid fa-cloud-sun',view:'weather',bgClass:'bg-sky-400'},{id:9,name:'ç¿»è­¯',icon:'fa-solid fa-language',view:'japanese',bgClass:'bg-emerald-400'}];
        const tripDays = [{week:'D1',title:'3/27'},{week:'D2',title:'3/28'},{week:'D3',title:'3/29'},{week:'D4',title:'3/30'},{week:'D5',title:'3/31'},{week:'D6',title:'4/01'},{week:'D7',title:'4/02'},{week:'D8',title:'4/03'}];
        const daysUntilTrip = ref(Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24)));
        const smartReminders = computed(() => { const l=[]; if(daysUntilTrip.value<=30) l.push("æº–å‚™å‡ºç™¼ï¼"); return l; });

        // Logic Helpers
        const getCurrentItinerary = () => (itineraryMode.value === 'drive' && [2,3].includes(selectedDayIndex.value)) ? (drivePlan.value[selectedDayIndex.value-2] || []) : (itinerary.value[selectedDayIndex.value] || []);
        const getIconByCategory = (cat) => ({'Flight':'fa-solid fa-plane','Sightseeing':'fa-solid fa-camera','Food':'fa-solid fa-utensils','Shopping':'fa-solid fa-bag-shopping','Transport':'fa-solid fa-train-subway','Hotel':'fa-solid fa-bed'}[cat]||'fa-solid fa-location-dot');
        const getMapLink = (k,n) => k?`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k||n)}`:'';
        const getSearchLink = (n) => `https://www.google.com/search?q=${encodeURIComponent(n)}`;
        const getImg = (p) => p && p.startsWith('data:')?p:`https://raw.githubusercontent.com/sunny5200820-maker/2026.tokyo.fuji.trip/main/${p}`;
        const handleImgError = (e) => e.target.src='https://placehold.co/400x300/pink/white?text=IMAGE';
        const getPageTitle = (view) => ({'itinerary':'è¡Œç¨‹è¡¨','money':'å°è²¡åº«','hotel':'ä½å®¿äº¤é€š','prep':'è¡Œå‰æº–å‚™','food':'ç¾é£Ÿåœ°åœ–','photo':'æ‰“å¡æ™¯é»','shopping':'è³¼ç‰©æ¸…å–®','weather':'å¤©æ°£é å ±','japanese':'ç¿»è­¯è’Ÿè’»'}[view]||'é—œæ±ä¹‹æ—…');
        
        const getUserName = (id) => users.value.find(u=>u.id===id)?.name||'æœªçŸ¥';
        const getClothingAdvice = (t) => t<10?'ç¾½çµ¨+åœå·¾':t<15?'å¤§è¡£+ç™¼ç†±è¡£':'æ´‹è”¥å¼ç©¿æ­';
        const getPaymentIcon = (m) => ({'cash':'ğŸ’µ','card':'ğŸ’³','suica':'ğŸ§','other':'ğŸ”–'}[m]||'ğŸ’µ');
        const flightStatusLink = (code) => code ? `https://www.flightradar24.com/data/flights/${code.toLowerCase()}` : '';
        const getAirlineInfo = (flightCode, isShort) => { if(!flightCode) return null; const c = flightCode.toUpperCase(); if(c.startsWith('TR')) return isShort?"é…·èˆª Scoot":"ã€é…·èˆª Scootã€‘\nğŸ“ å ±åˆ°ï¼šæ¡ƒåœ’ T1 / æˆç”° T1 å—ç¿¼\nğŸ§³ æ‰‹æï¼š10kg (åš´æ ¼ç§¤é‡)"; if(c.startsWith('BR')) return isShort?"é•·æ¦® EVA":"ã€é•·æ¦® EVAã€‘\nğŸ“ å ±åˆ°ï¼šæ¡ƒåœ’ T2 / æˆç”° T1 å—ç¿¼\nğŸ§³ è¨—é‹ï¼šè¨ˆä»¶åˆ¶ 23kg x 2 ä»¶"; return 'è«‹ç¢ºèªé›»å­æ©Ÿç¥¨ä¸Šçš„èˆªå»ˆè³‡è¨Š'; };
        const getDirLink = (dest) => { return `https://www.google.com/maps/dir/?api=1&origin=$${encodeURIComponent(dest)}&travelmode=transit`; };

        const getAmountInTWD = (e) => e.currency==='JPY' ? e.amount*exchangeRate.value : e.amount;
        const myPrivateExpenses = computed(() => currentUser.value ? expenses.value.filter(e => e.whoPaid===currentUser.value.id && e.forWhom.length===1 && e.forWhom[0]===currentUser.value.id) : []);
        const myPrivateTotalTWD = computed(() => myPrivateExpenses.value.reduce((sum, e) => sum + getAmountInTWD(e), 0));
        const groupExpenses = computed(() => expenses.value.filter(e => e.forWhom.length > 1 || (e.forWhom.length===1 && e.forWhom[0]!==e.whoPaid)));
        const settlements = computed(() => { const b={}; users.value.forEach(u=>b[u.id]=0); groupExpenses.value.forEach(e=>{ const t=getAmountInTWD(e); b[e.whoPaid]+=t; const s=t/e.forWhom.length; e.forWhom.forEach(i=>b[i]-=s); }); const r=[]; const n=users.value.map(u=>({id:u.id,v:b[u.id]})); const d=n.filter(x=>x.v<-1).sort((x,y)=>x.v-y.v); const c=n.filter(x=>x.v>1).sort((x,y)=>y.v-x.v); let i=0,j=0; while(i<d.length&&j<c.length){ let a=Math.min(-d[i].v,c[j].v); r.push({from:d[i].id,to:c[j].id,amount:Math.round(a)}); d[i].v+=a; c[j].v-=a; if(Math.abs(d[i].v)<1)i++; if(Math.abs(c[j].v)<1)j++; } return r; });
        const onlineUsers = computed(() => users.value.filter(u => u.lastActive && (Date.now() - u.lastActive) < 60000));

        // Image Compression
        const compressImage = (base64) => new Promise(resolve=>{const img=new Image();img.src=base64;img.onload=()=>{const c=document.createElement('canvas');let w=img.width,h=img.height;if(w>800){h*=800/w;w=800;}c.width=w;c.height=h;const ctx=c.getContext('2d');ctx.drawImage(img,0,0,w,h);resolve(c.toDataURL('image/jpeg',0.6));}});

        // Weather API
        const fetchWeather = async () => {
             const locs = [{k:'Tokyo', lat:35.6895, lon:139.6917},{k:'Kamakura', lat:35.3197, lon:139.5467},{k:'Fuji', lat:35.4981, lon:138.7686}];
             for(let l of locs) {
                 try {
                     const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${l.lat}&longitude=${l.lon}&current=temperature_2m,weather_code&timezone=Asia%2FTokyo`);
                     const data = await res.json();
                     if(data.current) {
                         const idx = weatherData.value.findIndex(w => w.name === l.k);
                         if(idx !== -1) {
                             const t = Math.round(data.current.temperature_2m);
                             weatherData.value[idx].temp = t; weatherData.value[idx].tempValue = t;
                             let icon = 'fa-solid fa-sun'; const c = data.current.weather_code;
                             if(c > 3) icon = 'fa-solid fa-cloud'; if(c > 45) icon = 'fa-solid fa-smog'; if(c > 50) icon = 'fa-solid fa-cloud-rain';
                             weatherData.value[idx].icon = icon;
                         }
                     }
                 } catch(e) {}
             }
        };

        // Strict Save Data - ä¿®æ­£åŒæ­¥éŒ¯èª¤
        let saveTimeout = null;
        const saveData = async () => { 
            if(isGuest.value) return;
            if(!isDataLoaded.value) { console.log("ç­‰å¾…è³‡æ–™è¼‰å…¥ä¸­ï¼Œç•¥éå­˜æª”"); return; } // é˜²æ­¢è¦†è“‹
            
            syncStatus.value = 'saving';
            clearTimeout(saveTimeout);
            
            saveTimeout = setTimeout(async () => {
                // é€™è£¡å¿…é ˆåŒ…å«æ‰€æœ‰æ¬„ä½ï¼Œä¸èƒ½çœç•¥ï¼Œå¦å‰‡æœƒæŠŠé›²ç«¯è³‡æ–™è“‹æ‰è®Šæˆ undefined
                const data = { 
                    users:users.value, itinerary:itinerary.value, expenses:expenses.value, spots:spots.value, 
                    shopping:shopping.value, phrases:japanesePhrases.value, drivePlan:drivePlan.value, 
                    tickets:suggestedTickets.value, transportTickets:transportTickets.value, rentalCars:rentalCars.value,
                    hotels:hotels.value, coupons:coupons.value, lastUpdated: serverTimestamp()
                };
                
                try {
                    if(db && isLoggedIn.value) {
                        await setDoc(doc(db,"trips","kanto2026"), data, {merge:true}); 
                        syncStatus.value = 'synced';
                    } else {
                        syncStatus.value = 'error';
                    }
                } catch(e) { console.error("Save Error:", e); syncStatus.value = 'error'; }
            }, 1000); 
        };

        const sendHeartbeat = async () => {
            if(!isLoggedIn.value || isGuest.value || !currentUser.value) return;
            const idx = users.value.findIndex(u => u.id === currentUser.value.id);
            if(idx !== -1) users.value[idx].lastActive = Date.now();
            if(db && isDataLoaded.value) { // ç¢ºä¿è³‡æ–™è¼‰å…¥å¾Œæ‰ç™¼é€å¿ƒè·³ï¼Œé¿å…å¯«å£è³‡æ–™
                try { await updateDoc(doc(db,"trips","kanto2026"), { [`users.${idx}.lastActive`]: Date.now() }); } catch(e){}
            }
        };

        const showDiagnostic = () => {
             const keys = Object.keys({expenses:expenses.value, rentalCars:rentalCars.value});
             alert(`ã€V43.1 ç³»çµ±è¨ºæ–·ã€‘\né€£ç·šï¼š${isLoggedIn.value?'ğŸŸ¢':'ğŸ”´'}\nè³‡æ–™è¼‰å…¥ï¼š${isDataLoaded.value?'âœ…':'â³'}\nåŒæ­¥ï¼š${syncStatusText.value}\nå®Œæ•´æ€§æª¢æŸ¥ï¼š${keys.join(',')}`);
             if(syncStatus.value === 'error') saveData(); // å¼·åˆ¶é‡è©¦
        };

        // User & App Logic
        const setCurrentUser = (u) => { if(isGuest.value) return; currentUser.value = u; localStorage.setItem('V42_USER_ID', u.id); sendHeartbeat(); showPersonaModal.value = false; currentView.value = 'menu'; };
        const enterSite = () => { const savedId = localStorage.getItem('V42_USER_ID'); if(savedId){const u=users.value.find(user=>user.id===parseInt(savedId));if(u){currentUser.value=u;isGuest.value=false;isWelcomeClosed.value=true;currentView.value='menu';sendHeartbeat();return;}} isGuest.value=false;isWelcomeClosed.value=true;showPersonaModal.value=true; };
        const enterAsGuest = () => { isGuest.value=true; currentUser.value={id:999,name:'è¨ªå®¢',list:[]}; isWelcomeClosed.value=true; currentView.value='menu'; };
        const handleAuthClick = () => isLoggedIn.value ? (confirm('ç™»å‡º?')&&signOut(auth)) : showLoginModal.value=true;
        const doLogin = async () => { try{await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth,loginForm.value.email,loginForm.value.password);showLoginModal.value=false;}catch(e){alert('ç™»å…¥å¤±æ•—');} };
        const openUserEditor = (u) => { editingUser.value={...u}; showUserEditModal.value=true; };
        const saveUserChanges = () => { if(isGuest.value) return; const idx=users.value.findIndex(u=>u.id===editingUser.value.id); if(idx!==-1){users.value[idx]={...editingUser.value};if(currentUser.value&&currentUser.value.id===editingUser.value.id)currentUser.value=users.value[idx];} saveData(); showUserEditModal.value=false; };
        const processAvatarUpload = async (e) => { const f = e.target.files[0]; if(f) { const res = await new Promise(r=>{const fr=new FileReader();fr.onload=ev=>r(ev.target.result);fr.readAsDataURL(f);}); editingUser.value.avatar = await compressImage(res); } };

        // Modals
        const openEditItineraryModal = (item, idx) => { if(isGuest.value) return; modalTitle.value = 'ç·¨è¼¯è¡Œç¨‹'; modalFields.value = [{key:'hours',label:'æ™‚é–“'},{key:'name',label:'åç¨±'},{key:'note',label:'å‚™è¨»'},{key:'mapKeyword',label:'åœ°åœ–é—œéµå­—'},{key:'travelTime',label:'äº¤é€šæ™‚é–“'},{key:'parkingLink',label:'åœè»Šå ´åœ°åœ– (è‡ªé§•ç”¨)'}]; modalData.value = {...item}; modalHasImg.value=false; isEditingItem.value = true; const targetArray = (itineraryMode.value === 'drive' && [2,3].includes(selectedDayIndex.value)) ? drivePlan.value[selectedDayIndex.value-2] : itinerary.value[selectedDayIndex.value]; modalCallback.value = () => { targetArray[idx] = modalData.value; targetArray.sort((a,b) => a.hours.localeCompare(b.hours)); saveData(); }; modalDeleteCallback.value = () => { targetArray.splice(idx, 1); saveData(); }; showModal.value = true; };
        const openAddItineraryModal = () => { modalTitle.value = 'æ–°å¢è¡Œç¨‹'; modalFields.value = [{key:'hours',label:'æ™‚é–“'},{key:'name',label:'åç¨±'},{key:'note',label:'å‚™è¨»'},{key:'mapKeyword',label:'åœ°åœ–é—œéµå­—'},{key:'travelTime',label:'äº¤é€šæ™‚é–“'},{key:'parkingLink',label:'åœè»Šå ´åœ°åœ– (è‡ªé§•ç”¨)'}]; modalData.value = {hours:'',name:'',note:'',category:'Sightseeing'}; modalHasImg.value=false; isEditingItem.value = false; modalCallback.value = () => { const arr = (itineraryMode.value === 'drive' && [2,3].includes(selectedDayIndex.value)) ? drivePlan.value[selectedDayIndex.value-2] : itinerary.value[selectedDayIndex.value]; arr.push(modalData.value); arr.sort((a,b) => a.hours.localeCompare(b.hours)); saveData(); }; showModal.value = true; };
        const openEditModal = (type, item, idx) => { if(isGuest.value) return; modalTitle.value = 'ç·¨è¼¯'; modalData.value = {...item}; modalHasImg.value=true; isEditingItem.value = true; if(type === 'shopping') { modalFields.value=[{key:'name',label:'åç¨±'},{key:'link',label:'é€£çµ'}]; modalCallback.value = () => { shopping.value[shopCat.value][idx] = modalData.value; saveData(); }; modalDeleteCallback.value = () => { shopping.value[shopCat.value].splice(idx, 1); saveData(); }; } else if (type === 'spot') { modalFields.value=[{key:'name',label:'åç¨±'},{key:'desc',label:'æè¿°'},{key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalCallback.value = () => { spots.value.photo[currentLoc.value][idx] = modalData.value; saveData(); }; modalDeleteCallback.value = () => { spots.value.photo[currentLoc.value].splice(idx, 1); saveData(); }; } else if (type === 'food') { modalFields.value=[{key:'name',label:'é¤å»³åç¨±', onInput: autoFillFoodInfo},{key:'desc',label:'æè¿°'},{key:'reserve',label:'éœ€è¦è¨‚ä½?', type:'checkbox'},{key:'reserveLink',label:'é ç´„é€£çµ'},{key:'note',label:'ç­†è¨˜', type:'textarea'},{key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalCallback.value = () => { spots.value.food[currentLoc.value][idx] = modalData.value; saveData(); }; modalDeleteCallback.value = () => { spots.value.food[currentLoc.value].splice(idx, 1); saveData(); }; } showModal.value=true; };
        const openAddShopModal = () => { modalTitle.value='æ–°å¢å•†å“'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'link',label:'é€£çµ'}]; modalData.value={name:'',link:'',img:''}; modalHasImg.value=true; isEditingItem.value=false; modalCallback.value = () => { shopping.value[shopCat.value].push(modalData.value); saveData(); }; showModal.value=true; };
        const openAddSpotModal = () => { modalTitle.value='æ–°å¢æ™¯é»'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'desc',label:'æè¿°'},{key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalData.value={name:'',desc:'',link:'',img:''}; modalHasImg.value=true; isEditingItem.value=false; modalCallback.value=()=>{spots.value.photo[currentLoc.value].push(modalData.value); saveData();}; showModal.value=true; };
        const openAddFoodModal = () => { modalTitle.value='æ–°å¢ç¾é£Ÿ'; modalFields.value=[{key:'name',label:'é¤å»³åç¨±', onInput: autoFillFoodInfo},{key:'desc',label:'æè¿°'},{key:'reserve',label:'éœ€è¦è¨‚ä½?', type:'checkbox'},{key:'reserveLink',label:'é ç´„é€£çµ'},{key:'note',label:'ç­†è¨˜', type:'textarea'},{key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalData.value={name:'',desc:'',reserve:false,reserveLink:'',note:'',link:'',img:''}; modalHasImg.value=true; isEditingItem.value=false; modalCallback.value=()=>{ if(!modalData.value.note) autoFillFoodInfo(); spots.value.food[currentLoc.value].push(modalData.value); saveData(); }; showModal.value=true; };
        const openAddCouponModal = () => { modalTitle.value='æ–°å¢å„ªæƒ åˆ¸'; modalFields.value=[{key:'name',label:'åº—å®¶åç¨±'},{key:'discount',label:'æŠ˜æ‰£å…§å®¹'},{key:'link',label:'é€£çµ'},{key:'note',label:'å‚™è¨»'}]; modalData.value={name:'',discount:'',link:'',note:''}; modalHasImg.value=false; modalCallback.value = () => { coupons.value.push(modalData.value); saveData(); }; showModal.value=true; };
        
        const openEditHotelModal = (h, idx) => { if(isGuest.value) return; modalTitle.value = 'ç·¨è¼¯ä½å®¿'; modalFields.value = [{key:'name',label:'åç¨±'},{key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalData.value = {...h}; modalHasImg.value = true; isEditingItem.value = false; modalCallback.value = () => { hotels.value[idx] = modalData.value; saveData(); }; showModal.value = true; };
        const openAddTicketModal = () => { modalTitle.value='æ–°å¢é–€ç¥¨'; modalFields.value=[{key:'name',label:'æ™¯é»åç¨±'},{key:'url',label:'è³¼ç¥¨é€£çµ'}]; modalData.value={name:'',url:'https://', custom:true}; modalHasImg.value=false; isEditingItem.value=false; modalCallback.value=()=>{suggestedTickets.value.push(modalData.value); saveData();}; showModal.value=true; };
        const openAddTransTicketModal = () => { modalTitle.value='æ–°å¢äº¤é€šç¥¨åˆ¸'; modalFields.value=[{key:'name',label:'ç¥¨åˆ¸åç¨±'},{key:'url',label:'è³‡è¨Šé€£çµ'},{key:'note',label:'æ³¨æ„äº‹é …', type:'textarea'}]; modalData.value={name:'',url:'https://', note:'', icon:'fa-solid fa-ticket', custom:true, type:''}; modalHasImg.value=false; isEditingItem.value=false; modalCallback.value=()=>{transportTickets.value.push(modalData.value); saveData();}; showModal.value=true; };
        const openAddCarModal = () => { modalTitle.value = 'æ–°å¢ç§Ÿè»Šé ç´„'; modalFields.value = [{key:'company',label:'ç§Ÿè»Šå…¬å¸'},{key:'pickup',label:'å–è»Šåœ°é»'},{key:'url',label:'é ç´„é€£çµ'},{key:'note',label:'å‚™è¨»'}]; modalData.value = {company:'', pickup:'', url:'', note:'', status:'todo', reservationNumber:'', insurance:''}; modalHasImg.value = false; isEditingItem.value = false; modalCallback.value = () => { rentalCars.value.push(modalData.value); saveData(); }; showModal.value = true; };
        const openAddPhraseModal = () => { modalTitle.value='æ–°å¢ç¿»è­¯'; modalFields.value=[{key:'zh',label:'ä¸­æ–‡'},{key:'jp',label:'æ—¥æ–‡'}]; modalData.value={zh:'',jp:''}; modalHasImg.value=false; isEditingItem.value=false; modalCallback.value=()=>{japanesePhrases.value.push(modalData.value); saveData();}; showModal.value=true; };

        const handleModalSave = () => { if(modalCallback.value) modalCallback.value(); showModal.value=false; };
        const handleModalDelete = () => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ') && modalDeleteCallback.value) { modalDeleteCallback.value(); showModal.value=false; } };
        const processModalImg = async (e) => { const f = e.target.files[0]; if(f) { const res = await new Promise(r=>{const fr=new FileReader();fr.onload=ev=>r(ev.target.result);fr.readAsDataURL(f);}); modalData.value.img = await compressImage(res); } };
        const openExpenseModal = (mode) => { expenseMode.value = mode; modalData.value={name:'', amount:'', currency:'JPY', method:'cash', whoPaid: currentUser.value.id, forWhom: mode==='private' ? [currentUser.value.id] : users.value.map(u=>u.id)}; showExpenseModal.value=true; };
        const toggleShare = (id) => { const i=modalData.value.forWhom.indexOf(id); i>-1?modalData.value.forWhom.splice(i,1):modalData.value.forWhom.push(id); };
        const saveExpense = () => { expenses.value.push({...modalData.value,id:Date.now(),date:new Date().toLocaleDateString()}); saveData(); showExpenseModal.value=false; };
        const deleteExpense = (id) => { if(isGuest.value) return; if(confirm('ç¢ºå®šåˆªé™¤?')){expenses.value=expenses.value.filter(e=>e.id!==id); saveData();} };
        const deleteCar = (idx) => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { rentalCars.value.splice(idx,1); saveData(); } };
        const openRentalDetail = (car, idx) => { activeRental.value = rentalCars.value[idx]; showRentalModal.value = true; };
        const updateRentalStatus = (status) => { activeRental.value.status = status; };
        const editFlight = (mode) => { if(isGuest.value) return; flightMode.value = mode; tempFlightData.value.code = mode==='out' ? (currentUser.value.flightOut||'') : (currentUser.value.flightIn||''); tempFlightData.value.seat = mode==='out' ? (currentUser.value.flightOutSeat||'') : (currentUser.value.flightInSeat||''); showFlightModal.value = true; };
        const saveFlight = () => { if(flightMode.value === 'out') { currentUser.value.flightOut = tempFlightData.value.code; currentUser.value.flightOutSeat = tempFlightData.value.seat; } else { currentUser.value.flightIn = tempFlightData.value.code; currentUser.value.flightInSeat = tempFlightData.value.seat; } const idx = users.value.findIndex(u=>u.id===currentUser.value.id); if(idx!==-1) users.value[idx] = currentUser.value; saveData(); showFlightModal.value = false; };
        const autoFillFoodInfo = () => { const name = modalData.value.name; if(!name) return; const n = name.toLowerCase(); if(n.includes('å™å™è‹‘')) { modalData.value.reserve=true; modalData.value.reserveLink='https://www.tablecheck.com/zh-TW/shops/jojoen-tokyoskytreetown-solamachi/reserve'; modalData.value.note='ã€éœ€è¨‚ä½ã€‘åˆé–“å¥—é¤CPå€¼æœ€é«˜ã€‚'; } else if(n.includes('harbs')) { modalData.value.reserve=false; modalData.value.note='ã€ç¾å ´æ’éšŠã€‘æ°´æœåƒå±¤å¿…é»ã€‚'; } };
        const applyTicketTemplate = () => { const t = modalData.value.type; if(t==='suica') { modalData.value.name='Suica è¥¿ç“œå¡'; modalData.value.icon='fa-solid fa-mobile-screen'; modalData.value.url='https://www.jreast.co.jp/tc/pass/suica.html'; } };
        const speakJapanese = (text) => { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; window.speechSynthesis.speak(u); };
        const openGoogleTranslate = (text) => { window.open(`https://translate.google.com/?sl=zh-TW&tl=ja&text=${encodeURIComponent(text)}&op=translate`, '_blank'); };
        const handleCameraTranslate = () => { window.open('https://translate.google.com/?sl=auto&tl=zh-TW&op=images', '_blank'); };
        const expandCard = (p) => expandedPhrase.value=p;
        const addPrepItem = (u) => { u.list.push({text:'æ–°é …ç›®',checked:false}); saveData(); };
        
        const initSakura = () => { const container = document.getElementById('sakura-container'); if(!container) return; setInterval(() => { const petal = document.createElement('div'); petal.className = 'sakura'; petal.style.left = Math.random() * 100 + 'vw'; petal.style.animationDuration = Math.random() * 3 + 2 + 's'; petal.style.opacity = Math.random(); container.appendChild(petal); setTimeout(() => petal.remove(), 5000); }, 400); };
        
        onMounted(() => {
            initSakura();
            fetchWeather();
            
            if(auth) onAuthStateChanged(auth, u=>{ 
                isLoggedIn.value=!!u; 
                if(u && db) {
                    onSnapshot(doc(db,"trips","kanto2026"), d=>{
                        if(d.exists()){
                            const dt = d.data();
                            isDataLoaded.value = true; // é–æ‰“é–‹ï¼Œå…è¨±å­˜æª”
                            syncStatus.value = 'synced';
                            
                            // åš´æ ¼è¼‰å…¥ï¼šå¦‚æœæœ‰é›²ç«¯è³‡æ–™å°±ç”¨é›²ç«¯ï¼Œæ²’æœ‰å°±ç”¨é è¨­ï¼Œçµ•ä¸ç•™ç©º
                            if(dt.users) {
                                users.value = dt.users;
                                if(currentUser.value) { const me = users.value.find(u => u.id === currentUser.value.id); if(me) currentUser.value = me; }
                            }
                            if(dt.itinerary) itinerary.value = dt.itinerary;
                            if(dt.drivePlan) drivePlan.value = dt.drivePlan;
                            if(dt.expenses) expenses.value = dt.expenses; // é‚„åŸ
                            if(dt.spots) spots.value = dt.spots;
                            if(dt.shopping) shopping.value = dt.shopping;
                            if(dt.coupons) coupons.value = dt.coupons;
                            if(dt.phrases) japanesePhrases.value = dt.phrases;
                            if(dt.tickets) suggestedTickets.value = dt.tickets;
                            if(dt.transportTickets) transportTickets.value = dt.transportTickets; // é‚„åŸ
                            if(dt.rentalCars) rentalCars.value = dt.rentalCars; // é‚„åŸ
                            if(dt.hotels) hotels.value = dt.hotels; // é‚„åŸ
                        } else {
                             // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å»ºç«‹ï¼Œå…è¨±ä½¿ç”¨é è¨­å€¼
                             isDataLoaded.value = true;
                        }
                    }, err => {
                        console.error("Sync Error", err);
                        syncStatus.value = 'error';
                    });
                }
            });
            setInterval(sendHeartbeat, 30000);
        });

        return {
            users, currentView, isWelcomeClosed, enterSite, enterAsGuest, isGuest, apps, getPageTitle,
            daysUntilTrip, smartReminders, tripDays, selectedDayIndex, getCurrentItinerary,
            moneyTab, exchangeRate, myPrivateExpenses, myPrivateTotalTWD, groupExpenses, settlements, getUserName, openExpenseModal, showExpenseModal, modalData, toggleShare, saveExpense, deleteExpense, expenseMode, getPaymentIcon,
            hotelTab, shopCat, shopping, openAddShopModal, currentLoc, spots, openAddSpotModal, weatherData, getClothingAdvice, japanesePhrases, expandCard, expandedPhrase, openAddPhraseModal,
            showModal, modalTitle, modalFields, modalHasImg, handleModalSave, handleModalDelete, isEditingItem, processModalImg, getIconByCategory, getMapLink, getSearchLink, getImg, handleImgError, saveData,
            currentUser, showPersonaModal, setCurrentUser, openUserEditor, showUserEditModal, editingUser, saveUserChanges, processAvatarUpload,
            addPrepItem, openEditModal, showFlightModal, tempFlightData, editFlight, saveFlight, flightMode, speakJapanese,
            handleAuthClick, showLoginModal, loginForm, doLogin, isLoggedIn, itineraryMode, suggestedTickets, openAddTicketModal,
            syncStatus, syncStatusText, syncStatusColor, openAddItineraryModal, openEditItineraryModal, openGoogleTranslate,
            transportTickets, openAddTransTicketModal, getAirlineInfo, flightStatusLink, getDirLink, applyTicketTemplate,
            rentalCars, openAddCarModal, deleteCar, openAddFoodModal, autoFillFoodInfo,
            coupons, showCouponModal, handleCameraTranslate, hotels, openEditHotelModal, 
            toggleCarStatus: updateRentalStatus, showRentalModal, activeRental, openRentalDetail, updateRentalStatus, 
            onlineUsers, showDiagnostic, openAddCouponModal
        };
    }
}).mount('#app');
</script>
