<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—œæ±ä¹‹æ—… | å‰ä¼Šå¡å“‡é¢¨ V8.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chii-pink': '#FFD1DC',
                        'chii-blue': '#A2D2FF',
                        'chii-yellow': '#FFF5BA',
                        'chii-text': '#5D5D5D',
                    },
                    fontFamily: {
                        sans: ['Zen Maru Gothic', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'bounce-slow': 'bounce 3s infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #FFF5F7; 
            font-family: 'Zen Maru Gothic', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æ«»èŠ±é£„è½å‹•ç•« */
        .sakura {
            position: fixed;
            top: -10px;
            background: #FFD1DC;
            border-radius: 100% 0 100% 0;
            opacity: 0.6;
            animation: fall linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        @keyframes fall {
            to { transform: translate(10vw, 105vh) rotate(360deg); }
        }

        /* Banner */
        .banner-container {
            height: 240px;
            background-image: url('./banner.jpg');
            background-size: cover;
            background-position: center;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            position: relative;
            box-shadow: 0 4px 20px rgba(255, 209, 220, 0.4);
            margin-bottom: 20px;
        }
        .banner-fallback {
            background: linear-gradient(135deg, #A2D2FF 0%, #FFD1DC 100%);
        }

        /* App Icons */
        .app-icon {
            width: 65px;
            height: 65px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            margin-bottom: 6px;
        }
        .app-icon:active { transform: scale(0.9); }
        .app-label { font-size: 12px; font-weight: bold; color: #5D5D5D; text-align: center; line-height: 1.2; }

        .card {
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            transition: all 0.2s;
        }

        /* Weather Card */
        .weather-card {
            background: linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%);
            color: white;
        }

        /* æ‡¸æµ®æŒ‰éˆ•ç¾¤ */
        .fab-main {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 50;
            transition: transform 0.2s;
            color: white;
        }
        .fab-main:active { transform: scale(0.9); }
        
        .floating-search {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            z-index: 40;
            transition: all 0.3s;
        }

        /* Tag Button for Lists */
        .tag-btn {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.2s;
            white-space: nowrap;
        }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="sakura-container"></div>

<div id="app" @touchstart="handleTouchStart" @touchend="handleTouchEnd">
    <div v-if="!isMounted" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <i class="fa-solid fa-spinner fa-spin text-4xl text-chii-pink mb-4"></i>
        <div class="text-chii-text font-bold">è¼‰å…¥ç¾å¥½æ—…ç¨‹ V8.0...</div>
    </div>

    <div v-if="isMounted" v-cloak class="min-h-screen pb-24 relative z-10">
        
        <div v-if="currentView !== 'home'" class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-sm z-40 px-4 py-3 flex justify-between items-center shadow-sm h-14 transition-all">
            <button @click="goHome" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-chii-pink hover:text-white transition">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <h1 class="font-bold text-gray-700">{{ getPageTitle(currentView) }}</h1>
            <button @click="showSyncModal = true" class="w-8 h-8 rounded-full text-blue-400 flex items-center justify-center">
                <i class="fa-solid fa-cloud-arrow-up"></i>
            </button>
        </div>
        <div v-if="currentView !== 'home'" class="h-16"></div>

        <div v-if="currentView === 'home'" class="animate-fade-in pb-20">
            <div class="banner-container" :class="{'banner-fallback': !hasBanner}">
                <div class="absolute inset-0 bg-gradient-to-l from-black/20 to-transparent rounded-b-[30px]"></div>
                <div class="absolute bottom-6 right-6 text-white text-right">
                    <div class="text-xs opacity-90 mb-1 tracking-widest">TOKYO TRIP</div>
                    <h1 class="text-4xl font-black drop-shadow-md">é—œæ±ä¹‹æ—… ğŸŒ¸</h1>
                    <div class="mt-2 text-sm bg-white/20 backdrop-blur-md px-3 py-1 rounded-full inline-block">
                        <i class="fa-solid fa-car mr-1"></i>V8.0 å®Œæ•´ç‰ˆ
                    </div>
                </div>
                <button @click="showSyncModal = true" class="absolute top-4 right-4 bg-white/30 backdrop-blur text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-sm border border-white/50">
                    <i class="fa-solid fa-rotate mr-1"></i>åŒæ­¥
                </button>
            </div>

            <div class="px-5 grid grid-cols-4 gap-y-6 gap-x-2 mb-8">
                <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer group" @click="currentView = app.view">
                    <div class="app-icon" :class="app.color"><i :class="app.icon"></i></div>
                    <span class="app-label group-hover:text-chii-pink transition">{{ app.name }}</span>
                </div>
            </div>

            <div class="px-4 mb-24">
                <div @click="currentView = 'weather'" class="weather-card rounded-2xl p-4 relative overflow-hidden shadow-lg cursor-pointer">
                    <div class="flex justify-between items-center relative z-10">
                        <div>
                            <div class="text-sm font-bold opacity-90"><i class="fa-solid fa-location-dot mr-1"></i>ä»Šæ—¥å¯Œå£«å±±</div>
                            <div class="text-3xl font-bold mt-1">{{ fujiWeather.temp }}Â°C</div>
                            <div class="text-xs mt-1 bg-white/20 px-2 py-0.5 rounded inline-block">èƒ½è¦‹åº¦: {{ fujiWeather.visibility }}%</div>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl animate-float">{{ fujiWeather.icon }}</div>
                            <div class="text-xs mt-1">{{ fujiWeather.desc }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="floating-search">
                <div class="bg-white/90 backdrop-blur p-2 rounded-full shadow-xl flex items-center border border-gray-200">
                    <i class="fa-brands fa-google text-gray-400 ml-3 text-lg"></i>
                    <input v-model="searchQuery" @keyup.enter="doGoogleSearch" placeholder="æœå°‹æ±äº¬æ™¯é»..." class="flex-1 bg-transparent border-none outline-none px-3 text-sm h-10">
                    <button @click="doGoogleSearch" class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md active:scale-95 transition">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'itinerary'" class="px-4">
            <div class="flex overflow-x-auto hide-scrollbar gap-2 mb-4 pb-2 sticky top-16 bg-white/95 backdrop-blur py-2 z-30">
                <button v-for="(day, index) in tripDays" :key="index" @click="selectedDayIndex = index"
                    :class="['flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition border', 
                            selectedDayIndex === index ? 'bg-chii-pink text-white border-chii-pink shadow-md' : 'bg-white text-gray-400 border-gray-100']">
                    {{ day.week }}<br><span class="text-xs font-normal">{{ day.title }}</span>
                </button>
            </div>
            <div class="space-y-4 pb-20">
                <div v-for="(item, idx) in currentDayItinerary" :key="item.id" class="card p-4 relative border-l-[6px]" :class="getBorderColor(item.category)">
                    <div class="flex justify-between items-start" @click="editItem(item, idx)">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold px-2 py-0.5 rounded text-white" :class="getCategoryColor(item.category)">{{ getCategoryName(item.category) }}</span>
                                <span class="text-xs text-gray-400 font-mono"><i class="fa-regular fa-clock mr-1"></i>{{ item.hours }}</span>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg">
                                {{ item.name }}
                                <a :href="getMapLink(item.mapKeyword)" target="_blank" @click.stop class="ml-1 text-blue-400 hover:text-blue-600"><i class="fa-solid fa-location-arrow"></i></a>
                            </h3>
                            <p v-if="item.parking" class="text-xs mt-1 text-blue-500 font-bold bg-blue-50 p-1 rounded inline-block">
                                <i class="fa-solid fa-square-parking mr-1"></i><a :href="item.parking" target="_blank">æ¨è–¦åœè»Šå ´</a>
                            </p>
                            <p class="text-sm text-gray-500 mt-2 leading-relaxed bg-gray-50 p-2 rounded-lg whitespace-pre-line">{{ item.note }}</p>
                        </div>
                        <button @click.stop="deleteItem(idx)" class="text-gray-300 hover:text-red-400 ml-2"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
            </div>
            <button @click="openAddModal" class="fab-main bg-chii-pink animate-bounce-slow hover:bg-pink-400"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'money'" class="px-4">
            <div class="flex bg-white rounded-xl p-1 mb-6 shadow-sm border border-gray-100">
                <button @click="moneyTab = 'record'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition', moneyTab === 'record' ? 'bg-chii-yellow text-gray-700 shadow-sm' : 'text-gray-400']">è¨˜å¸³</button>
                <button @click="moneyTab = 'split'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition', moneyTab === 'split' ? 'bg-chii-pink text-white shadow-sm' : 'text-gray-400']">åˆ†å¸³çµç®—</button>
            </div>

            <div v-if="moneyTab === 'record'">
                <div class="card p-5 mb-4 bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-100">
                    <div class="flex justify-between items-end">
                        <div>
                            <div class="text-xs text-gray-500 font-bold mb-1">ç¸½æ”¯å‡º ({{ currentUser }})</div>
                            <div class="text-3xl font-black text-gray-800">Â¥{{ userTotalExpense.toLocaleString() }}</div>
                        </div>
                        <div class="text-right">
                             <select v-model="currentUser" class="bg-white border border-gray-200 text-sm rounded-lg p-1 outline-none font-bold">
                                <option v-for="u in expenseUsers" :key="u" :value="u">{{ u }}</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="space-y-3 pb-20">
                    <div v-for="exp in filteredExpenses" :key="exp.id" class="card p-3 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl">{{ getExpenseIcon(exp.category) }}</div>
                            <div>
                                <div class="font-bold text-gray-700">{{ exp.name }}</div>
                                <div class="text-xs text-gray-400">{{ exp.date }} Â· {{ exp.category }}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-800">Â¥{{ Number(exp.amount).toLocaleString() }}</div>
                            <button @click="deleteExpense(exp.id)" class="text-xs text-red-300 mt-1 px-2">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
                <button @click="openExpenseModal" class="fab-main bg-chii-yellow text-gray-700 hover:bg-yellow-300"><i class="fa-solid fa-pen"></i></button>
            </div>

            <div v-if="moneyTab === 'split'">
                <div class="card p-4 mb-4">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">ğŸ‘¥ æˆå“¡ç®¡ç†</h3>
                    <div class="flex flex-wrap gap-2">
                        <div v-for="(u, idx) in expenseUsers" :key="u" class="bg-gray-100 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                            {{ u }} <button @click="removeUser(idx)" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <button @click="addUser" class="px-3 py-1 rounded-full text-sm border border-dashed border-gray-300 text-gray-500">+ æ–°å¢</button>
                    </div>
                </div>
                <div class="card p-5 border-l-4 border-chii-blue">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fa-solid fa-calculator text-blue-400"></i> åˆ†å¸³å»ºè­°</h3>
                    <div v-if="settlements.length === 0" class="text-center text-gray-400 py-4 text-sm">ç›®å‰ç„¡è³‡æ–™æˆ–å·²å¹³è¡¡</div>
                    <div v-else class="space-y-3">
                        <div v-for="(s, idx) in settlements" :key="idx" class="flex items-center justify-between bg-blue-50 p-3 rounded-lg">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-red-500">{{ s.from }}</span> <i class="fa-solid fa-arrow-right-long text-gray-400 text-xs"></i> <span class="font-bold text-green-600">{{ s.to }}</span>
                            </div>
                            <div class="font-bold text-gray-800">Â¥{{ s.amount.toLocaleString() }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'prep'" class="px-4">
            <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="fixed bottom-24 right-5 bg-gradient-to-r from-pink-400 to-rose-400 text-white px-5 py-3 rounded-full shadow-lg font-bold flex items-center gap-2 z-50 animate-bounce-slow">
                <i class="fa-solid fa-qrcode"></i> VJW
            </a>

            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                <h3 class="font-bold text-blue-600 mb-2"><i class="fa-solid fa-car"></i> å¯Œå£«å±±ç§Ÿè»Šæ¨è–¦</h3>
                <div class="space-y-2 text-sm">
                    <a href="https://rent.toyota.co.jp/zh-tw/" target="_blank" class="block bg-white p-2 rounded flex justify-between">
                        <span>Toyota Rent a Car (æ²³å£æ¹–åº—)</span> <i class="fa-solid fa-external-link-alt text-gray-400"></i>
                    </a>
                    <a href="https://www.nipponrentacar.co.jp/en/" target="_blank" class="block bg-white p-2 rounded flex justify-between">
                        <span>Nippon Rent-A-Car</span> <i class="fa-solid fa-external-link-alt text-gray-400"></i>
                    </a>
                </div>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4 text-sm text-gray-600">
                <h3 class="font-bold text-yellow-600 mb-2"><i class="fa-solid fa-triangle-exclamation"></i> æ³¨æ„äº‹é …</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li>è­·ç…§æ•ˆæœŸ > 6å€‹æœˆ</li>
                    <li>è‡ªé§•ï¼šå°ç£é§•ç…§ + æ—¥æ–‡è­¯æœ¬</li>
                    <li>VJW QR Code æˆªåœ–å­˜æ‰‹æ©Ÿ</li>
                </ul>
            </div>

            <div class="bg-white rounded-2xl shadow-sm p-4 relative mb-20">
                <div class="absolute top-0 left-0 w-full h-3 bg-chii-blue opacity-50 rounded-t-2xl"></div>
                <div v-for="(item, idx) in prepList" :key="idx" class="flex items-center gap-3 py-3 border-b border-gray-50 last:border-0">
                    <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-blue-400 rounded cursor-pointer">
                    <input v-model="item.text" class="flex-1 text-sm bg-transparent outline-none" :class="{'line-through text-gray-300': item.checked}">
                    <button @click="prepList.splice(idx, 1)" class="text-gray-300"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <button @click="addPrepItem" class="w-full mt-4 py-3 bg-gray-100 rounded-xl text-gray-500 font-bold border-2 border-dashed border-gray-200">+ æ–°å¢é …ç›®</button>
            </div>
        </div>

        <div v-if="currentView === 'shopping'" class="px-4">
            <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar pb-2">
                <a href="https://www.cosme.net/bestcosme/" target="_blank" class="tag-btn bg-green-100 text-green-700">@cosmeå¤§è³</a>
                <a href="https://360life.shinyusha.co.jp/list/ldk" target="_blank" class="tag-btn bg-pink-100 text-pink-700">LDKè©•æ¸¬</a>
                <a href="https://www.google.com/search?q=æ—¥æœ¬å¿…è²·ä¼´æ‰‹ç¦®2025" target="_blank" class="tag-btn bg-yellow-100 text-yellow-700">å°ç£äººå¿…è²·ä¼´æ‰‹ç¦®</a>
            </div>

            <div class="grid grid-cols-2 gap-3 pb-24">
                <div v-for="(item, idx) in shoppingList" :key="idx" class="card p-3 flex flex-col items-center relative group">
                    <button @click="shoppingList.splice(idx, 1)" class="absolute top-2 right-2 w-6 h-6 bg-gray-100 rounded-full text-gray-400 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                    <div class="w-full h-24 bg-gray-100 rounded-lg mb-2 overflow-hidden flex items-center justify-center">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <i v-else class="fa-solid fa-bag-shopping text-3xl text-purple-200"></i>
                    </div>
                    <div class="font-bold text-sm text-center w-full truncate">{{ item.name }}</div>
                </div>
            </div>
            <button @click="openShopModal" class="fab-main bg-purple-400 hover:bg-purple-500"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'japanese'" class="px-4">
            <div class="flex gap-3 mb-6 justify-center">
                <a href="https://lens.google.com/" target="_blank" class="bg-blue-50 text-blue-600 px-4 py-3 rounded-xl font-bold flex items-center gap-2 shadow-sm border border-blue-100 flex-1 justify-center">
                    <i class="fa-solid fa-camera"></i> æƒæç¿»è­¯
                </a>
                <a href="https://translate.google.com/?sl=ja&tl=zh-TW" target="_blank" class="bg-green-50 text-green-600 px-4 py-3 rounded-xl font-bold flex items-center gap-2 shadow-sm border border-green-100 flex-1 justify-center">
                    <i class="fa-solid fa-microphone"></i> èªéŸ³ç¿»è­¯
                </a>
            </div>

            <div class="space-y-3 pb-24">
                <div v-for="(phrase, idx) in japanesePhrases" :key="idx" 
                        @click="speak(phrase.jp)"
                        class="card p-5 flex items-center justify-between cursor-pointer active:scale-95 transition border-l-4 border-green-400 hover:bg-green-50 relative">
                    <div>
                        <div class="font-bold text-xl text-gray-800">{{ phrase.jp }}</div>
                        <div class="text-xs text-gray-400 font-mono mb-1">{{ phrase.romaji }}</div>
                        <div class="text-sm text-green-600 font-bold">{{ phrase.tw }}</div>
                    </div>
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fa-solid fa-volume-high"></i></div>
                    <button @click.stop="japanesePhrases.splice(idx,1)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
            <button @click="addPhrase" class="fab-main bg-green-500 hover:bg-green-600"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'photo'" class="px-4">
            <div class="flex bg-white rounded-xl p-1 mb-4 shadow-sm">
                <button v-for="area in ['Tokyo', 'Kamakura', 'Fuji']" :key="area" 
                    @click="photoArea = area" 
                    :class="['flex-1 py-2 rounded-lg text-sm font-bold transition', photoArea === area ? 'bg-rose-100 text-rose-500' : 'text-gray-400']">
                    {{ {'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[area] }}
                </button>
            </div>
            
            <div class="grid grid-cols-1 gap-4 pb-24">
                <div v-for="(spot, idx) in photoSpots[photoArea]" :key="idx" class="card p-0 overflow-hidden group relative">
                    <a :href="getMapLink(spot.name)" target="_blank" class="flex">
                        <div class="w-32 h-28 bg-gray-200 relative flex-shrink-0"><img :src="spot.img" class="w-full h-full object-cover"></div>
                        <div class="p-3 flex flex-col justify-center flex-1">
                            <h3 class="font-bold text-gray-800">{{ spot.name }}</h3>
                            <div class="mt-2 text-rose-400 text-xs font-bold"><i class="fa-solid fa-location-dot mr-1"></i>å°èˆª</div>
                        </div>
                    </a>
                    <button @click.stop="photoSpots[photoArea].splice(idx,1)" class="absolute top-2 right-2 bg-white/80 rounded-full w-6 h-6 text-gray-400 hover:text-red-500 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
            <button @click="addPhotoSpot" class="fab-main bg-rose-400 hover:bg-rose-500"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'hotel'" class="px-4">
            <h2 class="text-lg font-bold text-gray-700 mb-4 pl-2 border-l-4 border-indigo-400">æœ¬æ¬¡æ—…ç¨‹ä½å®¿</h2>
            <div class="space-y-5">
                <div class="card p-4">
                    <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded font-bold">Day 1-2 (2æ™š)</span>
                    <h3 class="font-bold text-xl mt-2">éŒ¦ç³¸ç”º Sumida City</h3>
                    <a href="https://maps.app.goo.gl/8o6Bxb1TM5MxuvFm8" target="_blank" class="block mt-3 bg-blue-50 text-blue-600 py-2 text-center rounded-lg font-bold"><i class="fa-solid fa-map-location-dot"></i> åœ°åœ–å°èˆª</a>
                </div>
                 <div class="card p-4">
                    <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded font-bold">Day 3-4 (2æ™š)</span>
                    <h3 class="font-bold text-xl mt-2">Megu Fuji 2021</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=Megu+Fuji+2021" target="_blank" class="block mt-3 bg-blue-50 text-blue-600 py-2 text-center rounded-lg font-bold"><i class="fa-solid fa-map-location-dot"></i> åœ°åœ–å°èˆª</a>
                </div>
                 <div class="card p-4">
                    <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded font-bold">Day 5-7 (3æ™š)</span>
                    <h3 class="font-bold text-xl mt-2">DOMO é£¯åº—</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=DOMO+HOTEL+Tokyo" target="_blank" class="block mt-3 bg-blue-50 text-blue-600 py-2 text-center rounded-lg font-bold"><i class="fa-solid fa-map-location-dot"></i> åœ°åœ–å°èˆª</a>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'food'" class="px-4">
            <div class="space-y-3 pb-20">
                <div v-for="(food, idx) in foodList" :key="idx" class="card p-4 flex gap-4 hover:shadow-md cursor-pointer" @click="window.open(getMapLink(food.name))">
                    <div class="w-16 h-16 bg-orange-50 rounded-xl flex-shrink-0 flex items-center justify-center text-3xl">{{ food.icon }}</div>
                    <div>
                        <span class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-bold">{{ food.area }}</span>
                        <h3 class="font-bold text-gray-800">{{ food.name }}</h3>
                        <p class="text-xs text-gray-500">{{ food.desc }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div v-if="currentView === 'weather'" class="px-4">
             <div class="space-y-4">
                 <div class="card p-5 border-l-4 border-blue-400 flex justify-between items-center" v-for="w in [{t:'æ±äº¬',d:tokyoWeather},{t:'éŒå€‰',d:kamakuraWeather},{t:'å¯Œå£«å±±',d:fujiWeather}]">
                    <div><div class="font-bold text-gray-700">{{ w.t }}</div><div class="text-3xl font-bold">{{ w.d.temp }}Â°C</div></div>
                    <div class="text-right"><div class="text-4xl">{{ w.d.icon }}</div><div class="text-xs text-gray-500">{{ w.d.desc }}</div><div v-if="w.t=='å¯Œå£«å±±'" class="text-xs font-bold text-blue-500 mt-1">èƒ½è¦‹åº¦:{{w.d.visibility}}%</div></div>
                 </div>
            </div>
        </div>

        <div v-if="showModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl">
                <h3 class="font-bold text-lg mb-4 text-center">{{ isEditing ? 'ç·¨è¼¯' : 'æ–°å¢' }}</h3>
                <input v-model="editForm.name" placeholder="åç¨±" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none">
                <div class="flex gap-2 mb-3">
                    <input v-model="editForm.hours" placeholder="æ™‚é–“" class="w-1/3 p-3 bg-gray-50 rounded-xl outline-none">
                    <select v-model="editForm.category" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none"><option value="Sightseeing">ğŸ“¸ æ™¯é»</option><option value="Food">ğŸœ ç¾é£Ÿ</option><option value="Shopping">ğŸ›ï¸ è³¼ç‰©</option><option value="Transport">ğŸš… äº¤é€š</option></select>
                </div>
                <input v-model="editForm.mapKeyword" placeholder="åœ°åœ–é—œéµå­—" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none text-sm">
                <textarea v-model="editForm.note" placeholder="å‚™è¨»..." class="w-full p-3 bg-gray-50 rounded-xl h-20 outline-none"></textarea>
                <div class="flex gap-3 pt-2">
                    <button @click="showModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                    <button @click="saveItem" class="flex-1 py-3 bg-chii-pink text-white rounded-xl font-bold">å„²å­˜</button>
                </div>
            </div>
        </div>

        <div v-if="showShopModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl">
                <h3 class="font-bold text-lg mb-4 text-center">æ–°å¢è³¼ç‰©æ¸…å–®</h3>
                <input v-model="newShopItem.name" placeholder="å•†å“åç¨±" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none">
                <label class="block w-full p-4 border-2 border-dashed border-gray-300 rounded-xl text-center text-gray-400 cursor-pointer mb-4">
                    <i class="fa-solid fa-camera mb-1"></i> ä¸Šå‚³åœ–ç‰‡
                    <input type="file" @change="handleImageUpload" class="hidden">
                </label>
                <div v-if="newShopItem.image" class="text-xs text-green-500 text-center mb-3">å·²é¸æ“‡åœ–ç‰‡</div>
                <div class="flex gap-3">
                    <button @click="showShopModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                    <button @click="saveShopItem" class="flex-1 py-3 bg-purple-400 text-white rounded-xl font-bold">æ–°å¢</button>
                </div>
            </div>
        </div>
        
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl">
                <h3 class="font-bold text-lg mb-4 text-center">è¨˜ä¸€ç­†</h3>
                <input v-model="newExpense.name" placeholder="é …ç›®" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none">
                <input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none">
                <div class="flex gap-2 justify-center mb-4"><button v-for="c in ['é£Ÿ','è¡£','ä½','è¡Œ','æ¨‚']" :key="c" @click="newExpense.category=c" :class="['w-10 h-10 rounded-full font-bold', newExpense.category==c?'bg-chii-yellow':'bg-gray-100']">{{c}}</button></div>
                <div class="flex gap-3">
                    <button @click="showExpenseModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                    <button @click="addExpense" class="flex-1 py-3 bg-chii-yellow text-gray-800 rounded-xl font-bold">å„²å­˜</button>
                </div>
            </div>
        </div>

        <div v-if="showSyncModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl relative">
                <button @click="showSyncModal=false" class="absolute top-4 right-4 text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h3 class="font-bold text-xl mb-2 text-center text-chii-text">â˜ï¸ åŒæ­¥/å­˜æª”</h3>
                <div class="bg-gray-50 p-3 rounded-xl mb-4 break-all text-xs text-gray-500 font-mono h-24 overflow-y-auto border">{{ syncCode || 'é»æ“ŠåŒ¯å‡º...' }}</div>
                <div class="grid grid-cols-2 gap-3">
                    <button @click="generateSyncCode" class="py-2 bg-blue-100 text-blue-600 rounded-lg font-bold text-sm">åŒ¯å‡º</button>
                    <button @click="pasteSyncCode" class="py-2 bg-pink-100 text-pink-600 rounded-lg font-bold text-sm">è²¼ä¸Š</button>
                </div>
                <div v-if="syncMsg" class="text-center text-xs mt-3 font-bold text-green-500">{{ syncMsg }}</div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // === State ===
            const isMounted = ref(false);
            const currentView = ref('home');
            const hasBanner = ref(true);
            const STORAGE_KEY = 'tokyo_trip_v8';
            const searchQuery = ref('');

            // Touch Swipe
            const touchStart = ref(0);
            const handleTouchStart = (e) => touchStart.value = e.changedTouches[0].screenX;
            const handleTouchEnd = (e) => {
                if (currentView.value !== 'home' && e.changedTouches[0].screenX - touchStart.value > 100) goHome();
            };

            const apps = [
                { id: 1, name: 'è¡Œç¨‹è¡¨', icon: 'fa-solid fa-map-location-dot', color: 'bg-gradient-to-br from-pink-300 to-pink-400', view: 'itinerary' },
                { id: 2, name: 'å°è²¡åº«', icon: 'fa-solid fa-sack-dollar', color: 'bg-gradient-to-br from-yellow-300 to-yellow-500', view: 'money' },
                { id: 3, name: 'ä½å®¿', icon: 'fa-solid fa-bed', color: 'bg-gradient-to-br from-indigo-300 to-indigo-400', view: 'hotel' },
                { id: 4, name: 'è¡Œå‰æº–å‚™', icon: 'fa-solid fa-suitcase-rolling', color: 'bg-gradient-to-br from-blue-300 to-blue-400', view: 'prep' },
                { id: 5, name: 'åƒåƒå–å–', icon: 'fa-solid fa-utensils', color: 'bg-gradient-to-br from-orange-300 to-orange-400', view: 'food' },
                { id: 6, name: 'å¿«æ¨‚Shop', icon: 'fa-solid fa-bag-shopping', color: 'bg-gradient-to-br from-purple-300 to-purple-400', view: 'shopping' },
                { id: 7, name: 'å¤©æ°£é€±å ±', icon: 'fa-solid fa-cloud-sun', color: 'bg-gradient-to-br from-sky-300 to-sky-500', view: 'weather' },
                { id: 8, name: 'ç¶²ç¾æ‰“å¡', icon: 'fa-solid fa-camera', color: 'bg-gradient-to-br from-rose-300 to-rose-400', view: 'photo' },
                { id: 9, name: 'å³æ™‚æ•‘å‘½', icon: 'fa-solid fa-comment-medical', color: 'bg-gradient-to-br from-emerald-400 to-teal-500', view: 'japanese' },
            ];

            // Data
            const tokyoWeather = ref({ temp: '--', icon: 'â³', desc: '...', visibility: '--' });
            const kamakuraWeather = ref({ temp: '--', icon: 'â³', desc: '...', visibility: '--' });
            const fujiWeather = ref({ temp: '--', icon: 'â³', desc: '...', visibility: '--' });
            
            const selectedDayIndex = ref(0);
            const tripDays = [
                { week: 'Day 1', title: 'æŠµé”/æ™´ç©ºå¡”' }, { week: 'Day 2', title: 'æ·ºè‰/ä¸Šé‡' }, { week: 'Day 3', title: 'ç§Ÿè»Š/æ²³å£æ¹–' }, { week: 'Day 4', title: 'å±±ä¸­æ¹–' },
                { week: 'Day 5', title: 'çºœè»Š/å›æ–°å®¿' }, { week: 'Day 6', title: 'éŒå€‰æ±Ÿä¹‹é›»' }, { week: 'Day 7', title: 'æ±äº¬å¡”/æ¾€è°·' }, { week: 'Day 8', title: 'è¿”ç¨‹' }
            ];
            
            // 8-Day Itinerary with Parking
            const defaultItinerary = [
                [{ id: 1, category: 'Flight', name: 'æ¡ƒåœ’èµ·é£› (06:40)', hours: '06:40', mapKeyword: 'æ¡ƒåœ’æ©Ÿå ´' }, { id: 2, category: 'Flight', name: 'æŠµé”æˆç”° (10:40)', hours: '10:40', mapKeyword: 'æˆç”°æ©Ÿå ´' }, { id: 3, category: 'Sightseeing', name: 'æ™´ç©ºå¡”', hours: 'ä¸‹åˆ', mapKeyword: 'Tokyo Skytree' }, { id: 4, category: 'Food', name: 'æ™šé¤ï¼šéŒ¦ç³¸ç”º', hours: 'æ™šä¸Š', mapKeyword: 'éŒ¦ç³¸ç”ºç¾é£Ÿ' }],
                [{ id: 5, category: 'Sightseeing', name: 'æ·ºè‰å¯º', hours: 'ä¸Šåˆ', mapKeyword: 'æ·ºè‰å¯º' }, { id: 6, category: 'Food', name: 'åˆé¤ï¼šæ·ºè‰', hours: 'ä¸­åˆ', mapKeyword: 'æ·ºè‰åˆé¤' }, { id: 7, category: 'Sightseeing', name: 'å°ç¶²ç¥ç¤¾', hours: 'ä¸‹åˆ', mapKeyword: 'å°ç¶²ç¥ç¤¾' }, { id: 8, category: 'Sightseeing', name: 'ä¸Šé‡æ©è³œå…¬åœ’', hours: 'ä¸‹åˆ', mapKeyword: 'ä¸Šé‡æ©è³œå…¬åœ’' }, { id: 9, category: 'Shopping', name: 'ç§‹è‘‰åŸ/æ±äº¬ä¸€ç•ªè¡—', hours: 'æ™šä¸Š', mapKeyword: 'æ±äº¬ç«™ä¸€ç•ªè¡—' }],
                [{ id: 10, category: 'Transport', name: 'éŒ¦ç³¸ç”ºå‰å¾€å¯Œå£«å±±(ç§Ÿè»Š)', hours: 'ä¸Šåˆ', mapKeyword: 'æ²³å£æ¹–ç§Ÿè»Š' }, { id: 11, category: 'Sightseeing', name: 'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨', hours: 'ä¸‹åˆ', mapKeyword: 'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨', parking:'http://googleusercontent.com/maps.google.com/search?q=å¤§çŸ³å…¬åœ’åœè»Šå ´' }, { id: 12, category: 'Sightseeing', name: 'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾', hours: 'ä¸‹åˆ', mapKeyword: 'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾', parking:'http://googleusercontent.com/maps.google.com/search?q=ä¸‹å‰ç”°é§…é§è»Šå ´' }, { id: 13, category: 'Sightseeing', name: 'é‡‘é³¥å±…', hours: 'å‚æ™š', mapKeyword: 'å¯Œå£«å‰ç”°æœ¬ç”ºé€š', parking:'http://googleusercontent.com/maps.google.com/search?q=æœ¬ç”ºäºŒä¸ç›®é§è»Šå ´' }, { id: 14, category: 'Food', name: 'æ™šé¤', hours: 'æ™šä¸Š', mapKeyword: 'å¯Œå£«å‰ç”°æ™šé¤' }],
                [{ id: 15, category: 'Sightseeing', name: 'å¹³é‡ä¹‹æ¿±æ—¥å‡º', hours: 'æ¸…æ™¨', mapKeyword: 'å¹³é‡ä¹‹æ¿±' }, { id: 16, category: 'Sightseeing', name: 'é•·æ± è¦ªæ°´å…¬åœ’', hours: 'ä¸Šåˆ', mapKeyword: 'é•·æ± è¦ªæ°´å…¬åœ’', parking:'http://googleusercontent.com/maps.google.com/search?q=é•·æ± è¦ªæ°´å…¬åœ’é§è»Šå ´' }, { id: 17, category: 'Food', name: 'åˆé¤', hours: 'ä¸­åˆ', mapKeyword: 'å±±ä¸­æ¹–ç¾é£Ÿ' }, { id: 18, category: 'Sightseeing', name: 'KABA æ°´é™¸å·´å£«', hours: 'ä¸‹åˆ', mapKeyword: 'å±±ä¸­æ¹–KABA', parking:'http://googleusercontent.com/maps.google.com/search?q=å±±ä¸­æ¹–æ—­æ—¥ä¸˜é§è»Šå ´' }, { id: 19, category: 'Food', name: 'Oginoè¶…å¸‚', hours: 'æ™šä¸Š', mapKeyword: 'Oginoæ²³å£æ¹–åº—', parking:'http://googleusercontent.com/maps.google.com/search?q=Oginoæ²³å£æ¹–åº—é§è»Šå ´' }],
                [{ id: 20, category: 'Sightseeing', name: 'æ²³å£æ¹–çºœè»Š', hours: 'æ—©ä¸Š', mapKeyword: 'æ²³å£æ¹–å¯Œå£«å±±å…¨æ™¯çºœè»Š', parking:'http://googleusercontent.com/maps.google.com/search?q=æ²³å£æ¹–ç•”çœŒå–¶ç„¡æ–™é§è»Šå ´' }, { id: 21, category: 'Shopping', name: 'Fujisan Shokupan', hours: 'é»å¿ƒ', mapKeyword: 'Fujisan Shokupan' }, { id: 22, category: 'Transport', name: 'æ­ä¹˜å¯Œå£«å›éŠè¿”æ–°å®¿', hours: 'ä¸‹åˆ', mapKeyword: 'æ²³å£æ¹–ç«™' }, { id: 23, category: 'Shopping', name: 'æ± è¢‹å¤ªé™½åŸ', hours: 'å‚æ™š', mapKeyword: 'æ± è¢‹å¤ªé™½åŸ' }, { id: 24, category: 'Food', name: 'æ™šé¤', hours: 'æ™šä¸Š', mapKeyword: 'æ± è¢‹å¤ªé™½åŸç¾é£Ÿ' }],
                [{ id: 25, category: 'Transport', name: 'å‰å¾€è—¤æ¾¤', hours: 'ä¸Šåˆ', mapKeyword: 'è—¤æ¾¤ç«™' }, { id: 26, category: 'Sightseeing', name: 'æ±Ÿä¹‹å³¶/éŒå€‰é«˜æ ¡å‰', hours: 'å…¨å¤©', mapKeyword: 'æ±Ÿä¹‹å³¶' }, { id: 27, category: 'Food', name: 'åˆé¤ï¼šä¸ƒé‡Œæ¿±', hours: 'ä¸­åˆ', mapKeyword: 'ä¸ƒé‡Œæ¿±Bills' }, { id: 28, category: 'Transport', name: 'è¿”å›æ–°å®¿', hours: 'å‚æ™š', mapKeyword: 'æ–°å®¿ç«™' }],
                [{ id: 29, category: 'Sightseeing', name: 'æ±äº¬éµå¡”/éº»å¸ƒå°', hours: 'ä¸Šåˆ', mapKeyword: 'æ±äº¬éµå¡”' }, { id: 30, category: 'Food', name: 'åˆé¤ï¼šå…­æœ¬æœ¨', hours: 'ä¸­åˆ', mapKeyword: 'å…­æœ¬æœ¨åˆé¤' }, { id: 31, category: 'Sightseeing', name: 'SHIBUYA SKY', hours: 'å‚æ™š', mapKeyword: 'SHIBUYA SKY' }, { id: 32, category: 'Shopping', name: 'æ¾€è°·é€›è¡—', hours: 'æ™šä¸Š', mapKeyword: 'æ¾€è°·' }],
                [{ id: 33, category: 'Sightseeing', name: 'è‡ªç”±è¡Œç¨‹', hours: 'ç™½å¤©', mapKeyword: '' }, { id: 34, category: 'Transport', name: 'æˆç”°æ©Ÿå ´ (20:40)', hours: '20:40', mapKeyword: 'æˆç”°æ©Ÿå ´' }, { id: 35, category: 'Transport', name: 'æŠµé”æ¡ƒåœ’ (23:20)', hours: '23:20', mapKeyword: 'æ¡ƒåœ’æ©Ÿå ´' }]
            ];
            const itineraryData = ref(defaultItinerary);

            // Money
            const moneyTab = ref('record');
            const expenseUsers = ref(['æˆ‘','æœ‹å‹A']);
            const currentUser = ref('æˆ‘');
            const expenses = ref([]);
            const newExpense = ref({name:'', amount:'', category:'é£Ÿ'});
            
            // Lists
            const prepList = ref([{text:'è­·ç…§ (æ•ˆæœŸ6å€‹æœˆ)', checked:false},{text:'å°ç£é§•ç…§+æ—¥æ–‡è­¯æœ¬', checked:false}]);
            const shoppingList = ref([{name:'NY Perfect Cheese', image:''}]);
            const japanesePhrases = ref([{jp:'ã™ã¿ã¾ã›ã‚“', romaji:'Sumimasen', tw:'ä¸å¥½æ„æ€'}, {jp:'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™', romaji:'Kore o', tw:'æˆ‘è¦é€™å€‹'}, {jp:'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™', romaji:'Okaikei', tw:'çµå¸³'}]);
            const foodList = ref([{name:'AFURIæ‹‰éºµ', area:'åŸå®¿', icon:'ğŸœ', desc:'æŸšå­é¹½æ‹‰éºµ'}, {name:'HARBS', area:'æ–°å®¿', icon:'ğŸ°', desc:'æ°´æœåƒå±¤'}, {name:'Houtou Fudou', area:'æ²³å£æ¹–', icon:'ğŸ²', desc:'é¤ºé£¥éºµ'}]);
            const photoSpots = ref({
                'Tokyo': [{name:'SHIBUYA SKY', img:'https://images.unsplash.com/photo-1696257523267-313d4b68ec29?auto=format&fit=crop&w=600&q=80'}, {name:'æ±äº¬éµå¡”', img:'https://images.unsplash.com/photo-1536098561742-ca998e48cbcc?auto=format&fit=crop&w=600&q=80'}, {name:'æ·ºè‰å¯ºé›·é–€', img:'https://images.unsplash.com/photo-1563865646-b33705330368?auto=format&fit=crop&w=600&q=80'}, {name:'éº»å¸ƒå°Hills', img:'https://images.unsplash.com/photo-1707054948834-0346c8206096?auto=format&fit=crop&w=600&q=80'}, {name:'æ±äº¬è»Šç«™', img:'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?auto=format&fit=crop&w=600&q=80'}],
                'Kamakura': [{name:'éŒå€‰é«˜æ ¡å‰', img:'https://images.unsplash.com/photo-1633519398858-693247d86348?auto=format&fit=crop&w=600&q=80'}, {name:'ä¸ƒé‡Œæ¿±æµ·å²¸', img:'https://images.unsplash.com/photo-1565618790209-411a51163627?auto=format&fit=crop&w=600&q=80'}, {name:'é¶´å²¡å…«å¹¡å®®', img:'https://images.unsplash.com/photo-1600414864509-32215c32470c?auto=format&fit=crop&w=600&q=80'}, {name:'é«˜å¾·é™¢å¤§ä½›', img:'https://images.unsplash.com/photo-1553603227-2358e375ece5?auto=format&fit=crop&w=600&q=80'}, {name:'æ±Ÿä¹‹å³¶', img:'https://images.unsplash.com/photo-1598418086208-164478832a22?auto=format&fit=crop&w=600&q=80'}],
                'Fuji': [{name:'æœ¬ç”ºé€š', img:'https://images.unsplash.com/photo-1589451814294-26d36298dd22?auto=format&fit=crop&w=600&q=80'}, {name:'æ²³å£æ¹–Lawson', img:'https://images.unsplash.com/photo-1584856403612-9c3f09599d10?auto=format&fit=crop&w=600&q=80'}, {name:'æ–°å€‰å±±æ·ºé–“å…¬åœ’', img:'https://images.unsplash.com/photo-1524225010903-8898df5d0954?auto=format&fit=crop&w=600&q=80'}, {name:'å¤§çŸ³å…¬åœ’', img:'https://images.unsplash.com/photo-1490806843957-31f4c9a91c65?auto=format&fit=crop&w=600&q=80'}, {name:'å¤©ç©ºé³¥å±…', img:'https://images.unsplash.com/photo-1667022275253-34e85741f021?auto=format&fit=crop&w=600&q=80'}]
            });
            const photoArea = ref('Tokyo');

            // Modals
            const showModal=ref(false), showShopModal=ref(false), showExpenseModal=ref(false), showSyncModal=ref(false);
            const isEditing=ref(false), editIndex=ref(-1), editForm=ref({}), newShopItem=ref({}), syncCode=ref(''), syncMsg=ref('');

            // Computed
            const currentDayItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
            const userTotalExpense = computed(() => expenses.value.filter(e => e.user === currentUser.value).reduce((s, e) => s + Number(e.amount), 0));
            const filteredExpenses = computed(() => expenses.value.filter(e => e.user === currentUser.value).sort((a,b)=>b.id-a.id));
            const settlements = computed(() => {
                const bal = {}; expenseUsers.value.forEach(u=>bal[u]=0);
                expenses.value.forEach(e=>{ if(bal[e.user]!=undefined) bal[e.user]+=Number(e.amount); });
                const avg = expenses.value.reduce((s,e)=>s+Number(e.amount),0)/expenseUsers.value.length;
                const net = {}; expenseUsers.value.forEach(u=>net[u]=bal[u]-avg);
                const debt=[], cred=[]; for(let u in net) { if(net[u]<-1) debt.push({u,a:-net[u]}); else if(net[u]>1) cred.push({u,a:net[u]}); }
                const res=[]; let i=0,j=0;
                while(i<debt.length && j<cred.length){
                    let amt = Math.min(debt[i].a, cred[j].a);
                    if(amt>0) res.push({from:debt[i].u, to:cred[j].u, amount:Math.round(amt)});
                    debt[i].a-=amt; cred[j].a-=amt;
                    if(debt[i].a<1) i++; if(cred[j].a<1) j++;
                }
                return res;
            });

            // Methods
            const goHome = () => currentView.value = 'home';
            const getPageTitle = (v) => apps.find(a=>a.view==v)?.name || '';
            const getMapLink = (k) => k ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}` : '#';
            const getBorderColor = (c) => ({'Flight':'border-gray-400','Sightseeing':'border-pink-300','Food':'border-orange-300','Shopping':'border-purple-300','Transport':'border-blue-300'}[c]||'border-gray-300');
            const getCategoryColor = (c) => ({'Flight':'bg-gray-400','Sightseeing':'bg-pink-300','Food':'bg-orange-300','Shopping':'bg-purple-300','Transport':'bg-blue-300'}[c]||'bg-gray-300');
            const getCategoryName = (c) => ({'Flight':'é£›æ©Ÿ','Sightseeing':'æ™¯é»','Food':'ç¾é£Ÿ','Shopping':'è³¼ç‰©','Transport':'äº¤é€š'}[c]||'å…¶ä»–');
            const getExpenseIcon = (c) => ({'é£Ÿ':'ğŸœ','è¡£':'ğŸ‘—','ä½':'ğŸ¨','è¡Œ':'ğŸš…','æ¨‚':'ğŸ¡'}[c]||'ğŸ’¸');

            const addPrepItem = () => { const t=prompt('æ–°å¢:'); if(t) prepList.value.push({text:t, checked:false}); };
            const addPhrase = () => { const j=prompt('æ—¥æ–‡:'), t=prompt('ä¸­æ–‡:'); if(j&&t) japanesePhrases.value.push({jp:j, romaji:'', tw:t}); };
            const addPhotoSpot = () => { const n=prompt('åç¨±:'); if(n) photoSpots.value[photoArea.value].push({name:n, img:'https://placehold.co/600x400/FFD1DC/white?text=New'}); };
            const addUser = () => { const n=prompt('äººå:'); if(n) expenseUsers.value.push(n); };
            const removeUser = (i) => { if(confirm('åˆªé™¤?')) expenseUsers.value.splice(i,1); };
            const deleteExpense = (id) => { if(confirm('åˆªé™¤?')) expenses.value = expenses.value.filter(e=>e.id!==id); };

            const openAddModal = () => { isEditing.value=false; editForm.value={name:'', category:'Sightseeing'}; showModal.value=true; };
            const editItem = (item,idx) => { isEditing.value=true; editIndex.value=idx; editForm.value={...item}; showModal.value=true; };
            const saveItem = () => {
                const list = itineraryData.value[selectedDayIndex.value] || [];
                const newItem = { ...editForm.value, id: isEditing.value ? editForm.value.id : Date.now() };
                if (isEditing.value) list[editIndex.value] = newItem;
                else { if(!itineraryData.value[selectedDayIndex.value]) itineraryData.value[selectedDayIndex.value]=[]; itineraryData.value[selectedDayIndex.value].push(newItem); }
                showModal.value = false;
            };
            const deleteItem = (idx) => { if(confirm('åˆªé™¤?')) itineraryData.value[selectedDayIndex.value].splice(idx,1); };

            const openShopModal = () => { newShopItem.value={name:'', image:null}; showShopModal.value=true; };
            const handleImageUpload = (e) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(ev)=>newShopItem.value.image=ev.target.result; r.readAsDataURL(f); }};
            const saveShopItem = () => { if(newShopItem.value.name) shoppingList.value.push({...newShopItem.value}); showShopModal.value=false; };
            
            const openExpenseModal = () => { newExpense.value={name:'', amount:'', category:'é£Ÿ'}; showExpenseModal.value=true; };
            const addExpense = () => { if(newExpense.value.name && newExpense.value.amount) { expenses.value.push({id:Date.now(), user:currentUser.value, ...newExpense.value, date:`${new Date().getMonth()+1}/${new Date().getDate()}`}); showExpenseModal.value=false; }};

            const doGoogleSearch = () => { if(searchQuery.value) window.open(`https://www.google.com/search?q=${encodeURIComponent(searchQuery.value)}`); };
            
            // TTS Fix
            const speak = (text) => {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ja-JP';
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(u);
            };

            // Sync
            const generateSyncCode = () => { syncCode.value=btoa(unescape(encodeURIComponent(JSON.stringify({itinerary:itineraryData.value, prep:prepList.value, shopping:shoppingList.value, expenses:expenses.value, users:expenseUsers.value, photo:photoSpots.value, jap:japanesePhrases.value})))); navigator.clipboard.writeText(syncCode.value); syncMsg.value='å·²è¤‡è£½'; };
            const pasteSyncCode = async () => { try { const t=await navigator.clipboard.readText(); const d=JSON.parse(decodeURIComponent(escape(atob(t)))); itineraryData.value=d.itinerary; prepList.value=d.prep; shoppingList.value=d.shopping; expenses.value=d.expenses; expenseUsers.value=d.users; photoSpots.value=d.photo; japanesePhrases.value=d.jap; syncMsg.value='æˆåŠŸ'; setTimeout(()=>showSyncModal.value=false,1500); } catch(e){syncMsg.value='éŒ¯èª¤';}};

            // Weather
            const getW = async (lat,lon,refVal) => { try{ const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,cloud_cover&timezone=Asia%2FTokyo`); const d=await r.json(); refVal.value={temp:d.current.temperature_2m, icon:d.current.weather_code<=3?'ğŸŒ¤ï¸':'ğŸŒ§ï¸', desc:d.current.weather_code<=3?'æ™´':'é›¨', visibility:Math.max(0,100-d.current.cloud_cover)}; }catch(e){} };

            onMounted(() => {
                const s = localStorage.getItem(STORAGE_KEY);
                if(s) { try{ const d=JSON.parse(s); itineraryData.value=d.itinerary||defaultItinerary; prepList.value=d.prep||prepList.value; shoppingList.value=d.shopping||shoppingList.value; expenses.value=d.expenses||[]; expenseUsers.value=d.users||expenseUsers.value; photoSpots.value=d.photo||photoSpots.value; japanesePhrases.value=d.jap||japanesePhrases.value; }catch(e){} }
                getW(35.6895, 139.6917, tokyoWeather); getW(35.3192, 139.5467, kamakuraWeather); getW(35.3606, 138.7274, fujiWeather);
                const img = new Image(); img.src='./banner.jpg'; img.onerror=()=>hasBanner.value=false;
                
                // Sakura
                const sc = document.getElementById('sakura-container');
                for(let i=0;i<12;i++){ const e=document.createElement('div'); e.className='sakura'; e.style.left=Math.random()*100+'vw'; e.style.animationDuration=Math.random()*3+4+'s'; sc.appendChild(e); }
                isMounted.value = true;
            });

            watch([itineraryData, prepList, shoppingList, expenses, expenseUsers, photoSpots, japanesePhrases], ()=>{
                localStorage.setItem(STORAGE_KEY, JSON.stringify({itinerary:itineraryData.value, prep:prepList.value, shopping:shoppingList.value, expenses:expenses.value, users:expenseUsers.value, photo:photoSpots.value, jap:japanesePhrases.value}));
            }, {deep:true});

            return {
                isMounted, currentView, hasBanner, apps, goHome, getPageTitle, searchQuery, doGoogleSearch, handleTouchStart, handleTouchEnd,
                tokyoWeather, kamakuraWeather, fujiWeather, foodList, shoppingList, prepList, photoSpots, japanesePhrases,
                tripDays, selectedDayIndex, currentDayItinerary,
                moneyTab, expenseUsers, currentUser, userTotalExpense, filteredExpenses, settlements,
                openAddModal, editItem, saveItem, deleteItem, showModal, editForm, isEditing,
                openShopModal, saveShopItem, showShopModal, newShopItem, handleImageUpload,
                openExpenseModal, addExpense, showExpenseModal, newExpense, deleteExpense, addUser, removeUser,
                getBorderColor, getCategoryColor, getCategoryName, getMapLink, getExpenseIcon,
                addPrepItem, addPhrase, addPhotoSpot, speak, photoArea,
                showSyncModal, syncCode, syncMsg, generateSyncCode, pasteSyncCode
            };
        }
    }).mount('#app');
</script>
</body>
</html>
