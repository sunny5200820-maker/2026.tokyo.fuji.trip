<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>é—œæ±8æ—¥ä¹‹æ—… | å‰ä¼Šå¡å“‡é¢¨ V4.2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chii-pink': '#FFD1DC', 'chii-deep-pink': '#FF9EAC', 'chii-blue': '#A2D2FF', 'chii-yellow': '#FFF5BA', 'chii-text': '#5D4037',
                    },
                    fontFamily: { sans: ['Zen Maru Gothic', 'sans-serif'] },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'bounce-slow': 'bounce 3s infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-6px)' } },
                        wiggle: { '0%, 100%': { transform: 'rotate(-3deg)' }, '50%': { transform: 'rotate(3deg)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #FFF0F5; 
            background-image: radial-gradient(#FFD1DC 15%, transparent 16%), radial-gradient(#FFF5BA 15%, transparent 16%);
            background-size: 60px 60px; background-position: 0 0, 30px 30px;
            font-family: 'Zen Maru Gothic', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; user-select: none; color: #5D4037;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .sakura { position: fixed; top: -10px; background: #FFB7B2; border-radius: 100% 0 100% 0; opacity: 0.6; animation: fall linear infinite; z-index: 0; pointer-events: none; width: 12px; height: 12px; }
        @keyframes fall { to { transform: translate(15vw, 105vh) rotate(360deg); } }

        /* Banner Fix for Mobile */
        .banner-img-container { position: absolute; inset: 0; z-index: 0; }
        .banner-img { 
            width: 100%; height: 100%; 
            object-fit: cover; 
            /* é—œéµä¿®æ­£ï¼šå¼·åˆ¶å°é½Šä¸‹æ–¹ï¼Œè®“è»Šå­ä¸è¢«è£åˆ‡ */
            object-position: center bottom; 
        }

        /* Draggable Countdown */
        .draggable-countdown {
            position: fixed; z-index: 50; cursor: grab; touch-action: none;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px);
            border: 3px solid #FFD1DC; padding: 8px 16px; border-radius: 50px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px;
        }
        
        /* General UI */
        .card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-radius: 24px; box-shadow: 0 8px 32px rgba(255, 182, 193, 0.25); border: 1px solid rgba(255, 255, 255, 0.8); transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .watercolor-img { width: 100%; height: 100%; object-fit: cover; filter: contrast(1.1) brightness(1.05) saturate(1.2); }
        .watercolor-paper-texture { position: absolute; inset: 0; opacity: 0.2; pointer-events: none; mix-blend-mode: multiply; background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNjY2MiIG9wYWNpdHk9IjAuMSIvPgo8L3N2Zz4='); }
        .fab-main { position: fixed; bottom: 30px; right: 20px; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; z-index: 50; box-shadow: 0 10px 25px rgba(255, 107, 107, 0.5); border: 4px solid white; transition: transform 0.2s; }
        
        /* Timeline */
        .timeline-line { position: absolute; left: 24px; top: 20px; bottom: -20px; width: 2px; background: repeating-linear-gradient(to bottom, #FFD1DC 0, #FFD1DC 6px, transparent 6px, transparent 12px); z-index: 0; }
        .timeline-dot { position: relative; z-index: 10; background: white; border: 2px solid #FF9EAC; width: 16px; height: 16px; border-radius: 50%; box-shadow: 0 0 0 4px #FFF0F5; }
        
        /* Sakura Forecast */
        .sakura-forecast-float { position: fixed; top: 80px; right: 20px; z-index: 40; background: rgba(255,255,255,0.95); padding: 12px; border-radius: 20px; box-shadow: 0 10px 30px rgba(255,105,180,0.3); border: 2px solid #FFB7B2; text-align: center; animation: float 6s ease-in-out infinite; max-width: 160px; }
        
        /* Boarding Pass Style */
        .boarding-pass { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #eee; position: relative; margin-bottom: 16px; }
        .boarding-pass::before, .boarding-pass::after { content: ''; position: absolute; width: 20px; height: 20px; background: #FFF0F5; border-radius: 50%; top: 65%; z-index: 10; }
        .boarding-pass::before { left: -10px; } .boarding-pass::after { right: -10px; }
        .dashed-line { border-top: 2px dashed #ddd; margin: 15px 0; position: relative; }
        
        /* Progress Bar */
        .progress-container { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="sakura-container"></div>

<div id="app" v-cloak class="min-h-screen relative overflow-hidden" @touchstart="handleTouchStart" @touchmove="handleTouchMove" @touchend="handleTouchEnd">
    
    <div v-if="!isMounted" class="fixed inset-0 flex flex-col items-center justify-center bg-[#FFF0F5] z-[100]">
        <div class="text-6xl animate-bounce-slow mb-4">ğŸŒ¸</div>
        <div class="text-chii-text font-bold text-lg animate-pulse">V4.2 å…¨èƒ½å‡ç´šä¸­...</div>
    </div>

    <div v-if="isMounted" class="relative z-10 min-h-screen flex flex-col">
        
        <header v-if="currentView !== 'home'" class="fixed top-0 left-0 right-0 bg-[#FFF0F5]/90 backdrop-blur-md z-40 px-4 py-3 flex justify-between items-center shadow-sm h-16 border-b border-pink-100 transition-all">
            <button @click="goHome" class="w-10 h-10 rounded-full bg-white text-pink-400 flex items-center justify-center border border-pink-100 active:scale-95"><i class="fa-solid fa-chevron-left text-lg"></i></button>
            <h1 class="font-bold text-gray-700 tracking-wide flex items-center gap-2 text-lg"><i class="fa-solid fa-sakura text-pink-400"></i> {{ getPageTitle(currentView) }}</h1>
            <button @click="showSyncModal = true" class="w-10 h-10 rounded-full text-blue-400 bg-white flex items-center justify-center border border-blue-100 active:scale-95"><i class="fa-solid fa-floppy-disk text-lg"></i></button>
        </header>
        <div v-if="currentView !== 'home'" class="h-16"></div>

        <div v-if="currentView === 'home'" class="flex-1 flex flex-col relative h-screen">
            <div class="banner-img-container">
                <img :src="homeBannerImg" class="banner-img" @error="handleImgError($event, 'banner')">
                <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-[#FFF0F5]"></div>
            </div>

            <div ref="countdownEl" class="draggable-countdown" :style="{ top: countdownPos.y + 'px', left: countdownPos.x + 'px' }" @mousedown="startDrag" @touchstart="startDrag">
                <div class="text-2xl animate-wiggle">ğŸ¹</div>
                <div class="flex flex-col"><div class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Countdown</div><div class="text-lg font-black text-pink-500 leading-none">{{ daysUntilTrip }} <span class="text-xs text-gray-400">å¤©</span></div></div>
            </div>

            <div class="relative z-10 flex-1 flex flex-col justify-between pb-8 pt-12 px-6">
                <div class="mt-8 text-white drop-shadow-md text-center">
                    <div class="inline-flex items-center gap-2 bg-pink-500/90 backdrop-blur-md px-4 py-1.5 rounded-full text-sm font-bold border border-white/30 mb-3 shadow-lg"><i class="fa-solid fa-plane-departure"></i> 2026.03.27 å‡ºç™¼</div>
                    <h1 class="text-5xl font-black mb-1 tracking-widest" style="text-shadow: 0 4px 12px rgba(0,0,0,0.4);">é—œæ±ä¹‹æ—…</h1>
                    <p class="text-lg font-bold opacity-90 tracking-[0.2em] text-pink-100">8å¤©7å¤œ</p>
                </div>

                <div class="bg-white/70 backdrop-blur-xl p-6 rounded-[32px] shadow-xl border border-white/60 mb-16">
                    <div class="grid grid-cols-3 gap-y-6 gap-x-4">
                        <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer group active:scale-95 transition" @click="currentView = app.view">
                            <div class="w-[56px] h-[56px] rounded-2xl flex items-center justify-center text-2xl text-white shadow-md transition transform group-hover:-translate-y-1 border-2 border-white" :class="app.bgClass"><i :class="app.icon"></i></div>
                            <span class="mt-2 text-xs font-bold text-gray-700">{{ app.name }}</span>
                        </div>
                    </div>
                </div>

                <div class="floating-search absolute bottom-8 left-1/2 -translate-x-1/2 w-11/12 max-w-sm">
                    <div class="bg-white/95 backdrop-blur-lg p-1.5 rounded-full shadow-2xl flex items-center border-2 border-pink-200">
                        <i class="fa-brands fa-google text-pink-400 ml-4 text-lg"></i>
                        <input v-model="searchQuery" @keyup.enter="doGoogleSearch" placeholder="æœå°‹æ±äº¬..." class="flex-1 bg-transparent border-none outline-none px-3 text-sm h-10 text-gray-600 font-medium">
                        <button @click="doGoogleSearch" class="bg-pink-400 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md active:scale-95"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'itinerary'" class="px-4 animate-slide-in">
             <div class="flex overflow-x-auto hide-scrollbar gap-2 mb-4 pb-2 sticky top-16 bg-[#FFF0F5]/95 backdrop-blur py-2 z-30">
                <button v-for="(day, index) in tripDays" :key="index" @click="selectedDayIndex = index" :class="['flex-shrink-0 px-5 py-2.5 rounded-full text-sm font-bold transition border-2 shadow-sm', selectedDayIndex === index ? 'bg-pink-400 text-white border-pink-400 shadow-md' : 'bg-white text-gray-400 border-white']">{{ day.week }}<br><span class="text-[10px] opacity-80">{{ day.title }}</span></button>
            </div>
            <div class="space-y-6 pb-24 px-2">
                <div v-if="currentDayItinerary.length === 0" class="text-center py-10 text-gray-400">å°šç„¡è¡Œç¨‹ï¼Œé»æ“Š + æ–°å¢</div>
                <div v-for="(item, idx) in currentDayItinerary" :key="item.id" class="card p-5 relative overflow-hidden group">
                    <div class="timeline-line"></div>
                    <div class="flex items-start relative z-10">
                        <div class="flex flex-col items-center mr-4 pt-1"><div class="timeline-dot"></div><div class="mt-2 text-gray-300 text-xl"><i :class="getIconByCategory(item.category)"></i></div></div>
                        <div class="flex-1" @click="editItem(item, idx)">
                            <div class="flex items-center justify-between mb-1"><span class="text-sm font-bold text-pink-500 bg-pink-50 px-2 py-0.5 rounded">{{ item.hours }}</span><div class="flex gap-2"><a :href="getMapLink(item.mapKeyword)" target="_blank" @click.stop class="text-blue-400 bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center hover:bg-blue-100 transition"><i class="fa-solid fa-location-arrow"></i></a><button @click.stop="deleteItem(idx)" class="text-gray-300 hover:text-red-400 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-trash-can"></i></button></div></div>
                            <h3 class="font-bold text-gray-800 text-lg mb-1 leading-tight">{{ item.name }}</h3>
                            <a v-if="item.parking" :href="item.parking" target="_blank" @click.stop class="mt-2 inline-flex items-center gap-1 text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100 hover:bg-blue-100 transition w-full"><i class="fa-solid fa-square-parking text-lg"></i> å°èˆªè‡³åœè»Šå ´</a>
                            <p class="text-sm text-gray-500 mt-2 whitespace-pre-line leading-relaxed pl-2 border-l-2 border-gray-100">{{ item.note }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <button @click="openAddModal" class="fab-main bg-pink-400 hover:bg-pink-500"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'money'" class="px-4 pb-24">
            <div class="flex justify-between items-center mb-4 sticky top-16 z-30 bg-[#FFF0F5] pb-2">
                <div class="flex bg-white rounded-xl p-1 shadow-sm border border-pink-100"><button @click="moneyTab = 'record'" :class="['px-4 py-2 rounded-lg text-sm font-bold transition', moneyTab === 'record' ? 'bg-chii-yellow text-gray-800 shadow-sm' : 'text-gray-400']">å€‹äººè¨˜å¸³</button><button @click="moneyTab = 'split'" :class="['px-4 py-2 rounded-lg text-sm font-bold transition', moneyTab === 'split' ? 'bg-pink-400 text-white shadow-sm' : 'text-gray-400']">å…¬å¸³åˆ†æ”¤</button></div>
                <div class="bg-white px-3 py-1 rounded-full text-xs font-bold text-gray-500 shadow-sm border border-gray-100 flex items-center gap-1"><i class="fa-solid fa-rotate text-[10px]"></i> åŒ¯ç‡: {{ exchangeRate }}</div>
            </div>
            
            <div v-if="moneyTab === 'record'">
                <div v-if="moneyMode === 'select'">
                    <div class="grid grid-cols-2 gap-4">
                        <div v-for="user in users" :key="user.id" class="card p-5 text-center cursor-pointer relative hover:-translate-y-1 transition" @click="selectMoneyUser(user.id)">
                            <div class="avatar-container w-20 h-20 rounded-full mx-auto mb-3 flex items-center justify-center text-4xl shadow-md border-4 border-white bg-gray-100" @click.stop="triggerAvatarUpload(user.id)"><img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover"><span v-else>{{ user.icon }}</span><div class="avatar-edit-overlay"><i class="fa-solid fa-camera"></i></div></div>
                            <div class="font-bold text-gray-700 text-lg">{{ user.name }}</div>
                        </div>
                    </div>
                </div>
                <div v-if="moneyMode === 'list'">
                    <div class="flex items-center justify-between mb-3 px-1"><h3 class="font-bold text-gray-700 flex items-center gap-2">{{ getUserById(currentUserId).name }} çš„å€‹äººå¸³æœ¬</h3><button @click="moneyMode = 'select'" class="text-xs bg-white px-3 py-1.5 rounded-full shadow font-bold text-gray-500">åˆ‡æ›</button></div>
                    <div class="card p-5 mb-4 bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-100"><div class="text-xs text-yellow-600 font-bold mb-1">å€‹äººç¸½æ”¯å‡º (ä¸å«å…¬å¸³)</div><div class="text-3xl font-black text-gray-800">Â¥{{ Number(userPersonalTotal).toLocaleString() }}</div></div>
                    <div class="space-y-3 pb-24"><div v-for="exp in personalExpenses" :key="exp.id" class="card p-3 flex justify-between items-center"><div><div class="font-bold text-gray-700 text-sm">{{ exp.name }}</div><div class="text-[10px] text-gray-400">{{ exp.date }} Â· {{ exp.category }}</div></div><div class="text-right"><div class="font-bold text-gray-800">Â¥{{ Number(exp.amount).toLocaleString() }}</div><button @click="deleteExpense(exp.id)" class="text-[10px] text-red-300 mt-1">åˆªé™¤</button></div></div></div>
                    <button @click="openExpenseModal('personal')" class="fab-main bg-chii-yellow text-gray-700 hover:bg-yellow-300"><i class="fa-solid fa-pen"></i></button>
                </div>
            </div>
            
            <div v-if="moneyTab === 'split'">
                <div class="card p-6 border-l-4 border-chii-blue mb-4">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-gray-700"><i class="fa-solid fa-calculator text-blue-400"></i> å³æ™‚åˆ†å¸³çµæœ</h3>
                    <div v-if="settlements.length === 0" class="text-center text-gray-400 text-sm">ç›®å‰ç„¡å…¬å¸³ç´€éŒ„</div>
                    <div class="space-y-3"><div v-for="(s, idx) in settlements" :key="idx" class="flex items-center justify-between bg-white border border-gray-100 p-4 rounded-xl shadow-sm"><div class="flex items-center gap-2 text-sm font-bold"><span class="text-gray-700">{{ getUserById(s.from).name }}</span><i class="fa-solid fa-angles-right text-gray-300 text-xs"></i><span class="text-blue-500">çµ¦ {{ getUserById(s.to).name }}</span></div><div class="text-right"><div class="font-black text-gray-800 text-lg">Â¥{{ s.amount.toLocaleString() }}</div></div></div></div>
                </div>
                <h4 class="font-bold text-gray-600 ml-1 mb-2">å…¬å¸³æ˜ç´°</h4>
                <div class="space-y-2 pb-24">
                     <div v-for="exp in groupExpenses" :key="exp.id" class="bg-white p-3 rounded-xl border border-blue-50 flex justify-between items-center"><div><div class="font-bold text-gray-700 text-sm">{{ exp.name }}</div><div class="text-[10px] text-blue-400">{{ getUserById(exp.user).name }} å…ˆä»˜ Â· {{ exp.date }}</div></div><div class="text-right"><div class="font-bold text-gray-800">Â¥{{ Number(exp.amount).toLocaleString() }}</div><button @click="deleteExpense(exp.id)" class="text-[10px] text-red-300 mt-1">åˆªé™¤</button></div></div>
                </div>
                <button @click="openExpenseModal('group')" class="fab-main bg-blue-400 text-white hover:bg-blue-500"><i class="fa-solid fa-users"></i></button>
            </div>
        </div>

        <div v-if="currentView === 'hotel'" class="px-4 pb-24">
             <div class="flex gap-2 mb-4 justify-center"><button @click="hotelTab='stay'" :class="['px-6 py-2 rounded-full font-bold shadow-sm', hotelTab==='stay'?'bg-indigo-400 text-white':'bg-white text-gray-400']">ä½å®¿</button><button @click="hotelTab='flight'" :class="['px-6 py-2 rounded-full font-bold shadow-sm', hotelTab==='flight'?'bg-pink-400 text-white':'bg-white text-gray-400']">å€‹äººæ©Ÿç¥¨</button></div>
             
             <div v-if="hotelTab==='stay'" class="space-y-5 animate-fade-in">
                <div class="card p-5 border border-indigo-100 relative overflow-hidden" v-for="h in hotels" :key="h.name"><div class="absolute top-0 right-0 bg-indigo-500 text-white text-xs font-bold px-3 py-1 rounded-bl-xl shadow-sm">{{ h.days }}</div><h3 class="font-bold text-xl mt-2 text-gray-800 pr-12">{{ h.name }}</h3><a :href="h.link" target="_blank" class="block mt-4 bg-gradient-to-r from-indigo-500 to-blue-500 text-white py-3 text-center rounded-xl font-bold shadow-md hover:shadow-lg transition active:scale-95"><i class="fa-solid fa-map-location-dot mr-2"></i> é–‹å•Ÿåœ°åœ–å°èˆª</a></div>
             </div>

             <div v-if="hotelTab==='flight'" class="animate-fade-in">
                <div v-if="flightMode==='select'" class="grid grid-cols-2 gap-4">
                    <div v-for="user in users" :key="user.id" class="card p-5 text-center cursor-pointer hover:bg-pink-50" @click="currentFlightUser=user.id; flightMode='list'">
                        <div class="text-4xl mb-2">{{ user.icon }}</div><div class="font-bold text-gray-700">{{ user.name }} çš„æ©Ÿç¥¨</div>
                    </div>
                </div>
                <div v-if="flightMode==='list'">
                    <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg">{{ getUserById(currentFlightUser).name }} çš„æ©Ÿç¥¨</h3><button @click="flightMode='select'" class="text-xs bg-white px-3 py-1 rounded-full shadow text-gray-500">åˆ‡æ›</button></div>
                    <div class="boarding-pass p-0">
                         <div class="bg-pink-400 px-4 py-2 text-white font-bold text-xs flex justify-between"><span>OUTBOUND å»ç¨‹</span><span>{{getUserById(currentFlightUser).name}}</span></div>
                         <div class="p-4 flex justify-between items-center">
                             <div class="text-center"><div class="text-3xl font-black text-gray-800">TPE</div><div class="text-xs text-gray-400">æ¡ƒåœ’</div></div>
                             <div class="flex-1 px-4 text-center"><i class="fa-solid fa-plane text-pink-300"></i><div class="text-[10px] text-gray-400">BR198</div></div>
                             <div class="text-center"><div class="text-3xl font-black text-gray-800">NRT</div><div class="text-xs text-gray-400">æˆç”°</div></div>
                         </div>
                         <div class="dashed-line"></div>
                         <div class="px-4 pb-4 flex justify-between text-sm"><div class="font-bold text-gray-600">08:50 <span class="text-[10px] font-normal">Depart</span></div><div class="font-bold text-gray-600">13:15 <span class="text-[10px] font-normal">Arrive</span></div></div>
                    </div>
                    <div class="boarding-pass p-0">
                         <div class="bg-blue-400 px-4 py-2 text-white font-bold text-xs flex justify-between"><span>INBOUND å›ç¨‹</span><span>{{getUserById(currentFlightUser).name}}</span></div>
                         <div class="p-4 flex justify-between items-center">
                             <div class="text-center"><div class="text-3xl font-black text-gray-800">NRT</div><div class="text-xs text-gray-400">æˆç”°</div></div>
                             <div class="flex-1 px-4 text-center"><i class="fa-solid fa-plane fa-rotate-180 text-blue-300"></i><div class="text-[10px] text-gray-400">BR197</div></div>
                             <div class="text-center"><div class="text-3xl font-black text-gray-800">TPE</div><div class="text-xs text-gray-400">æ¡ƒåœ’</div></div>
                         </div>
                         <div class="dashed-line"></div>
                         <div class="px-4 pb-4 flex justify-between text-sm"><div class="font-bold text-gray-600">14:15 <span class="text-[10px] font-normal">Depart</span></div><div class="font-bold text-gray-600">17:05 <span class="text-[10px] font-normal">Arrive</span></div></div>
                    </div>
                </div>
             </div>
        </div>

        <div v-if="currentView === 'prep'" class="px-4 pb-24">
            <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
                <button @click="prepTab='common'" :class="['px-4 py-2 rounded-full font-bold whitespace-nowrap', prepTab==='common'?'bg-blue-400 text-white':'bg-white text-gray-400']">é€šç”¨</button>
                <button @click="prepTab='car'" :class="['px-4 py-2 rounded-full font-bold whitespace-nowrap', prepTab==='car'?'bg-green-400 text-white':'bg-white text-gray-400']">è‡ªé§•æ¨è–¦</button>
                <button @click="prepTab='list'" :class="['px-4 py-2 rounded-full font-bold whitespace-nowrap', prepTab==='list'?'bg-pink-400 text-white':'bg-white text-gray-400']">å€‹äººæ¸…å–®</button>
            </div>

            <div v-if="prepTab==='common'" class="grid grid-cols-2 gap-3 mb-6 animate-fade-in">
                <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="bg-gradient-to-r from-blue-400 to-indigo-400 text-white p-4 rounded-3xl font-bold text-center shadow-lg"><i class="fa-solid fa-passport text-3xl mb-1"></i><div class="text-sm">VJW å…¥å¢ƒ</div></a>
                <button @click="openTicketModal" class="bg-gradient-to-r from-yellow-400 to-orange-400 text-white p-4 rounded-3xl font-bold text-center shadow-lg"><i class="fa-solid fa-ticket text-3xl mb-1"></i><div class="text-sm">ç¥¨åˆ¸ç²¾éˆ</div></button>
            </div>

            <div v-if="prepTab==='car'" class="animate-fade-in space-y-4">
                 <div class="card p-5 border-l-4 border-green-400">
                     <h3 class="font-bold text-lg mb-2">å¯Œå£«å±±è‡ªé§•æ¨è–¦</h3>
                     <p class="text-xs text-gray-500 mb-3">æ¨è–¦åœ¨æ²³å£æ¹–ç«™å–è»Šï¼Œè·¯ç·šè¼ƒç°¡å–®ã€‚</p>
                     <div class="grid gap-2">
                         <a href="https://www2.tocoo.jp/cn" target="_blank" class="block bg-gray-50 p-3 rounded-lg font-bold text-gray-700 hover:bg-green-50 flex justify-between items-center"><div>ğŸš— ToCoo! æ¯”åƒ¹</div><i class="fa-solid fa-chevron-right text-gray-300"></i></a>
                         <a href="https://rent.toyota.co.jp/zh-tw/" target="_blank" class="block bg-gray-50 p-3 rounded-lg font-bold text-gray-700 hover:bg-green-50 flex justify-between items-center"><div>ğŸš™ Toyota Rent a Car</div><i class="fa-solid fa-chevron-right text-gray-300"></i></a>
                         <a href="https://cars.tabirai.net/home/" target="_blank" class="block bg-gray-50 p-3 rounded-lg font-bold text-gray-700 hover:bg-green-50 flex justify-between items-center"><div>ğŸš• Tabirai ç§Ÿè»Šç¶²</div><i class="fa-solid fa-chevron-right text-gray-300"></i></a>
                     </div>
                 </div>
            </div>

            <div v-if="prepTab==='list'" class="animate-fade-in">
                 <div v-if="prepMode === 'select'">
                     <div class="grid grid-cols-2 gap-4">
                        <div v-for="user in users" :key="user.id" class="card p-4 cursor-pointer" @click="selectPrepUser(user.id)">
                            <div class="flex justify-between items-center mb-2">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl overflow-hidden"><img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover"><span v-else>{{ user.icon }}</span></div>
                                <div class="font-bold text-gray-700">{{ user.name }}</div>
                            </div>
                            <div class="progress-container"><div class="progress-fill" :style="{width: getProgress(user.id)+'%', backgroundColor: user.bg}"></div></div>
                            <div class="text-right text-[10px] text-gray-400 mt-1">{{ Math.round(getProgress(user.id)) }}%</div>
                        </div>
                    </div>
                 </div>
                 <div v-if="prepMode === 'list'">
                    <div class="flex items-center justify-between mb-4 px-2"><h3 class="font-bold text-xl text-gray-700">{{ getUserById(prepUser).name }} çš„æ¸…å–®</h3><button @click="prepMode = 'select'" class="text-xs bg-white px-3 py-1.5 rounded-full shadow font-bold text-gray-500">è¿”å›</button></div>
                    <div class="card p-5 min-h-[400px] mb-20">
                        <div v-for="(item, idx) in currentPrepList" :key="idx" class="flex items-center gap-3 py-3 border-b border-dashed border-gray-200"><input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-400 rounded cursor-pointer"><input v-model="item.text" class="flex-1 text-sm bg-transparent outline-none font-medium" :class="{'line-through text-gray-300': item.checked}"><button @click="currentPrepList.splice(idx, 1)" class="text-gray-200 hover:text-red-300"><i class="fa-solid fa-xmark"></i></button></div>
                        <button @click="addPrepItem" class="w-full mt-6 py-3 bg-gray-50 rounded-xl text-gray-400 font-bold border-2 border-dashed border-gray-200 hover:bg-white text-sm">+ æ–°å¢é …ç›®</button>
                    </div>
                 </div>
            </div>
        </div>

        <div v-if="currentView === 'weather'" class="px-4 pb-24 relative">
             <div class="sakura-forecast-float">
                 <div class="text-[10px] text-gray-400 font-bold mb-1">2026 æ«»èŠ±é æ¸¬</div>
                 <div class="text-2xl mb-1">ğŸŒ¸</div>
                 <div class="text-sm font-bold text-pink-500 mb-2">{{ sakuraStatus }}</div>
                 <div class="flex flex-col gap-1">
                     <a href="https://n-kishou.com/corp/news-contents/sakura/" target="_blank" class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded-full font-bold hover:bg-pink-200">æ°£è±¡æ ªå¼æœƒç¤¾</a>
                     <a href="https://weathernews.jp/s/sakura/" target="_blank" class="text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold hover:bg-blue-200">Weathernews</a>
                 </div>
             </div>
             <div class="space-y-5 mt-4"><div class="card p-6 border-l-[6px] border-sky-400" v-for="w in [{t:'æ±äº¬',d:tokyoWeather},{t:'éŒå€‰',d:kamakuraWeather},{t:'å¯Œå£«å±±',d:fujiWeather}]" :key="w.t"><div class="flex justify-between items-center mb-4"><div><div class="font-bold text-gray-500 text-sm mb-1">{{ w.t }}</div><div class="text-5xl font-black text-gray-800 tracking-tighter">{{ w.d.temp }}Â°</div></div><div class="text-right"><div class="text-6xl mb-1 filter drop-shadow-sm">{{ w.d.icon }}</div><div class="text-sm text-gray-500 font-bold bg-gray-100 px-2 py-1 rounded">{{ w.d.desc }}</div></div></div><div class="bg-sky-50 rounded-xl p-4 flex items-start gap-3 border border-sky-100"><div class="text-3xl">ğŸ‘˜</div><div class="text-sm text-gray-600 leading-relaxed font-medium"><span class="font-bold text-sky-600 block mb-1">å‰ä¼Šç©¿æ­å»ºè­°ï¼š</span>{{ getClothingAdvice(w.d.temp) }}</div></div></div></div>
        </div>

        <div v-if="['food','shopping','photo'].includes(currentView)" class="px-4 pb-24">
            <div v-if="currentView==='food'" class="flex gap-2 mb-6 overflow-x-auto hide-scrollbar justify-center sticky top-16 z-30 py-2"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" :key="loc" @click="foodLoc=loc" :class="['px-6 py-2 rounded-full text-sm font-bold transition whitespace-nowrap shadow-sm', foodLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400 border border-gray-100']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc]}}</button></div>
            <div v-if="currentView==='shopping'" class="flex gap-2 mb-6 overflow-x-auto hide-scrollbar justify-center"><button v-for="cat in ['wish','cosme','ldk','souvenir']" :key="cat" @click="shopCat=cat" :class="['px-5 py-2 rounded-full text-sm font-bold transition whitespace-nowrap shadow-sm', shopCat===cat?'bg-pink-400 text-white':'bg-white text-gray-400 border border-gray-100']">{{{'wish':'æˆ‘çš„é¡˜æœ›','cosme':'è—¥å¦','ldk':'LDK','souvenir':'ä¼´æ‰‹ç¦®'}[cat]}}</button></div>
            <div v-if="currentView==='photo'" class="flex gap-2 mb-6 overflow-x-auto hide-scrollbar justify-center"><button v-for="area in ['Tokyo', 'Kamakura', 'Fuji']" :key="area" @click="photoArea=area" :class="['px-6 py-2 rounded-full text-sm font-bold transition whitespace-nowrap shadow-sm', photoArea===area?'bg-rose-400 text-white':'bg-white text-gray-400 border border-gray-100']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[area]}}</button></div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div v-for="(item, idx) in getCurrentList()" :key="item.id || idx" class="bg-white border border-gray-200 rounded-lg shadow-md overflow-hidden hover:shadow-lg transition relative group">
                    <div class="relative w-full h-64 cursor-pointer" @click="openImage(item.img)">
                        <img class="w-full h-full object-cover watercolor-img" :src="item.img" @error="handleImgError($event, currentView, item.name)">
                        <div class="watercolor-paper-texture"></div>
                        <div class="absolute top-2 right-2 flex gap-2">
                             <button @click.stop="editCommonItem(item, idx)" class="w-8 h-8 bg-white/80 rounded-full flex items-center justify-center text-blue-400 shadow-sm"><i class="fa-solid fa-pen"></i></button>
                             <button @click.stop="deleteCommonItem(idx)" class="w-8 h-8 bg-white/80 rounded-full flex items-center justify-center text-red-400 shadow-sm"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="p-5">
                        <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900">{{ item.name }}</h5>
                        <p class="mb-4 font-normal text-gray-700 text-sm leading-relaxed text-justify">{{ item.desc }}</p>
                        <a v-if="item.link" :href="item.link" target="_blank" class="inline-flex items-center justify-center w-full px-3 py-2 text-sm font-medium text-center text-white rounded-lg bg-blue-500 hover:bg-blue-600">é€£çµ / å°èˆª</a>
                    </div>
                </div>
            </div>
            <button @click="openAddCommonModal(currentView)" class="fab-main hover:scale-110" :class="currentView==='shopping'?'bg-purple-400':currentView==='food'?'bg-orange-400':'bg-rose-400'"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'japanese'" class="px-4 pb-24"><button @click="openCamera" class="w-full bg-gradient-to-r from-emerald-500 to-green-400 rounded-3xl p-6 text-white text-center mb-6 shadow-xl relative overflow-hidden active:scale-95 transition group"><h3 class="font-bold text-2xl mb-2">ğŸ“¸ é–‹å•Ÿæ‡¸æµ®é¡é ­</h3><p class="text-sm opacity-90 font-medium">ç›´æ¥æ‹ç…§ç¿»è­¯</p></button><div class="space-y-3"><div v-for="(phrase, idx) in japanesePhrases" :key="idx" @click="speak(phrase.jp)" class="card p-5 flex items-center justify-between cursor-pointer active:scale-95 transition border-l-[6px] border-emerald-400"><div><div class="font-bold text-xl text-gray-800 mb-1">{{ phrase.jp }}</div><div class="text-sm text-gray-500 font-medium">{{ phrase.tw }}</div></div><div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-500 text-xl shadow-inner"><i class="fa-solid fa-volume-high"></i></div><button @click.stop="japanesePhrases.splice(idx,1)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400 p-2"><i class="fa-solid fa-trash"></i></button></div></div><button @click="openAddCommonModal('jp')" class="fab-main bg-emerald-500 hover:bg-emerald-600"><i class="fa-solid fa-plus"></i></button></div>

        <div v-if="showLightbox" class="fixed inset-0 z-[100] bg-white/95 backdrop-blur flex items-center justify-center p-4 animate-fade-in" @click="showLightbox = false"><img :src="currentZoomImg" class="max-w-full max-h-[80vh] rounded-2xl shadow-2xl border-4 border-white" @click.stop><button class="absolute top-6 right-6 text-gray-400 hover:text-gray-800 text-4xl"><i class="fa-solid fa-circle-xmark"></i></button></div>
        <div v-if="showCamera" class="fixed inset-0 bg-black z-[100] flex flex-col"><video ref="videoElement" autoplay playsinline class="w-full h-full object-cover"></video><button @click="closeCamera" class="absolute top-6 right-6 bg-black/40 text-white w-12 h-12 rounded-full flex items-center justify-center z-50 backdrop-blur"><i class="fa-solid fa-xmark"></i></button></div>
        <input type="file" ref="avatarInput" accept="image/*" class="hidden" @change="processAvatarUpload">
        <input type="file" ref="commonImageInput" accept="image/*" class="hidden" @change="processCommonImageUpload">
        
        <div v-if="showModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-center">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3><input v-model="editForm.name" placeholder="åç¨±" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border"><div class="flex gap-2 mb-3"><input v-model="editForm.hours" placeholder="æ™‚é–“" class="w-1/3 p-3 bg-gray-50 rounded-xl outline-none border"><select v-model="editForm.category" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none border"><option value="Sightseeing">ğŸ“¸ æ™¯é»</option><option value="Food">ğŸœ ç¾é£Ÿ</option><option value="Shopping">ğŸ›ï¸ è³¼ç‰©</option><option value="Transport">ğŸš… äº¤é€š</option><option value="Flight">âœˆï¸ èˆªç­</option></select></div><input v-model="editForm.mapKeyword" placeholder="åœ°åœ–é—œéµå­—" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border"><input v-model="editForm.parking" placeholder="åœè»Šå ´é€£çµ (é¸å¡«)" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border"><textarea v-model="editForm.note" placeholder="å‚™è¨»..." class="w-full p-3 bg-gray-50 rounded-xl h-24 outline-none border resize-none"></textarea><div class="flex gap-3"><button @click="showModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="saveItem" class="flex-1 py-3 bg-pink-400 text-white rounded-xl font-bold shadow-md">å„²å­˜</button></div></div></div>

        <div v-if="showCommonModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="font-bold text-lg mb-4 text-center">{{isEditing?'ç·¨è¼¯':'æ–°å¢'}}é …ç›®</h3>
                <div v-if="commonType === 'jp'"><input v-model="newCommon.text1" @input="autoTranslate" placeholder="è¼¸å…¥ä¸­æ–‡" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border"><input v-model="newCommon.text2" placeholder="æ—¥æ–‡" class="w-full p-3 bg-green-50 text-green-600 font-bold rounded-xl mb-3 outline-none border" readonly></div>
                <div v-else>
                    <input v-model="newCommon.text1" placeholder="åç¨±" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border">
                    <textarea v-if="commonType !== 'jp'" v-model="newCommon.text2" placeholder="æè¿°..." class="w-full p-3 bg-gray-50 rounded-xl h-20 outline-none border resize-none mb-3"></textarea>
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center border overflow-hidden">
                             <img v-if="newCommon.text3" :src="newCommon.text3" class="w-full h-full object-cover">
                             <i v-else class="fa-solid fa-image text-gray-300"></i>
                        </div>
                        <button @click="$refs.commonImageInput.click()" class="text-xs bg-blue-50 text-blue-500 px-3 py-2 rounded-lg font-bold">ä¸Šå‚³/æ›´æ›åœ–ç‰‡</button>
                    </div>
                </div>
                <div class="flex gap-3"><button @click="showCommonModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="saveCommonItem" class="flex-1 py-3 bg-blue-400 text-white rounded-xl font-bold shadow-md">å„²å­˜</button></div>
            </div>
        </div>

        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="font-bold text-lg mb-4 text-center">{{ expenseType==='group'?'è¨˜ä¸€ç­† (å…¬å¸³)':'è¨˜ä¸€ç­† (å€‹äºº)' }}</h3>
                <input v-model="newExpense.name" placeholder="æ¶ˆè²»é …ç›®" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border">
                <div class="flex gap-2 mb-3"><input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none border"><select v-model="newExpense.currency" class="w-24 p-3 bg-gray-50 rounded-xl outline-none border font-bold text-gray-600"><option value="JPY">JPY</option><option value="TWD">TWD</option></select></div>
                <div class="mb-3">
                    <label class="text-xs text-gray-400 font-bold ml-1">{{ expenseType==='group'?'èª°å…ˆå¢Šä»˜?':'èª°èŠ±çš„?' }}</label>
                    <div class="flex gap-2 mt-1 overflow-x-auto pb-1"><button v-for="u in users" :key="u.id" @click="currentUserId=u.id" :class="['px-3 py-1 rounded-full text-xs font-bold border', currentUserId===u.id ? 'bg-yellow-100 border-yellow-300 text-yellow-700' : 'bg-white border-gray-200 text-gray-400']">{{ u.name }}</button></div>
                </div>
                <div class="flex gap-2 justify-center mb-6"><button v-for="c in ['é£Ÿ','è¡£','ä½','è¡Œ','æ¨‚']" :key="c" @click="newExpense.category=c" :class="['w-10 h-10 rounded-full font-bold transition', newExpense.category==c?'bg-chii-yellow text-gray-800 shadow-md scale-110':'bg-gray-100 text-gray-400']">{{c}}</button></div>
                <div class="flex gap-3"><button @click="showExpenseModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="addExpense" class="flex-1 py-3 bg-chii-yellow text-gray-800 rounded-xl font-bold shadow-md">å„²å­˜</button></div>
            </div>
        </div>

        <div v-if="showTicketModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl h-[60vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xl text-gray-700">ç¥¨åˆ¸ç²¾éˆ</h3><button @click="showTicketModal=false" class="text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="flex-1 overflow-y-auto space-y-3"><div v-for="ticket in suggestedTickets" :key="ticket.name" class="border rounded-xl p-3 border-orange-200 bg-orange-50"><h4 class="font-bold text-gray-800">{{ ticket.name }}</h4><p class="text-xs text-gray-600 mt-1">{{ ticket.reason }}</p><a :href="ticket.link" target="_blank" class="block text-center bg-white border border-orange-200 text-orange-500 text-xs font-bold py-1 mt-2 rounded-full">å‰å¾€è³¼è²·</a></div></div></div></div>
        <div v-if="showSyncModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative"><button @click="showSyncModal=false" class="absolute top-4 right-4 text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button><h3 class="font-bold text-xl mb-2 text-center text-chii-text">ğŸ“‚ æª”æ¡ˆå­˜å– (V42)</h3><p class="text-xs text-gray-400 text-center mb-6">å„²å­˜ HTML å¯ä¿ç•™æ‰€æœ‰åœ–ç‰‡èˆ‡è³‡æ–™</p><button @click="saveAsHtml" class="w-full py-3 bg-gradient-to-r from-pink-400 to-rose-400 text-white rounded-xl font-bold mb-3 flex items-center justify-center gap-2 shadow-md active:scale-95 transition"><i class="fa-solid fa-file-code"></i> å„²å­˜ç‚ºç¶²é æª” (HTML)</button><hr class="border-gray-100 my-3"><button @click="downloadBackup" class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold mb-3 flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> åƒ…å‚™ä»½è³‡æ–™ (JSON)</button><label class="w-full py-3 bg-gray-50 text-gray-600 rounded-xl font-bold flex items-center justify-center gap-2 cursor-pointer border border-gray-200"><i class="fa-solid fa-upload"></i> è®€å–è³‡æ–™ (JSON)<input type="file" @change="loadBackup" accept=".json" class="hidden"></label><div v-if="syncMsg" class="text-center text-xs mt-3 font-bold text-green-500">{{ syncMsg }}</div></div></div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const isMounted = ref(false), currentView = ref('home'), STORAGE_KEY = 'tokyo_trip_v42';
            const showCamera = ref(false), videoElement = ref(null), showLightbox = ref(false), currentZoomImg = ref('');
            const homeBannerImg = ref('2026.tokyo.jpg');
            const searchQuery = ref('');
            
            // Countdown Logic
            const countdownEl = ref(null);
            const countdownPos = ref({ x: 20, y: 150 });
            let isDragging = false, dragOffset = { x: 0, y: 0 };
            const startDrag = (e) => { isDragging = true; const cX = e.touches ? e.touches[0].clientX : e.clientX; const cY = e.touches ? e.touches[0].clientY : e.clientY; dragOffset.x = cX - countdownPos.value.x; dragOffset.y = cY - countdownPos.value.y; document.addEventListener('mousemove', onDrag); document.addEventListener('touchmove', onDrag, { passive: false }); document.addEventListener('mouseup', stopDrag); document.addEventListener('touchend', stopDrag); };
            const onDrag = (e) => { if (!isDragging) return; e.preventDefault(); const cX = e.touches ? e.touches[0].clientX : e.clientX; const cY = e.touches ? e.touches[0].clientY : e.clientY; countdownPos.value = { x: cX - dragOffset.x, y: cY - dragOffset.y }; };
            const stopDrag = () => { isDragging = false; document.removeEventListener('mousemove', onDrag); document.removeEventListener('touchmove', onDrag); document.removeEventListener('mouseup', stopDrag); document.removeEventListener('touchend', stopDrag); };
            const sakuraStatus = ref('é æ¸¬ä¸­...'); 

            // Users
            const defaultUsers = [{id: 1, name: 'å‰ä¼Š', bg: '#FFD1DC', icon:'ğŸ¹', avatar:'', list: []}, {id: 2, name: 'å°å…«', bg: '#A2D2FF', icon:'ğŸ±', avatar:'', list: []}, {id: 3, name: 'å…”å…”', bg: '#FFF5BA', icon:'ğŸ°', avatar:'', list: []}, {id: 4, name: 'å°æ¡ƒ', bg: '#FFB7B2', icon:'ğŸ‘', avatar:'', list: []}];
            const users = ref(JSON.parse(JSON.stringify(defaultUsers)));
            const daysUntilTrip = computed(() => Math.ceil((new Date('2026-03-27') - new Date()) / (86400000)));
            const exchangeRate = ref(0.22); 
            
            // View States
            const prepMode = ref('select'), prepTab = ref('common'), moneyTab = ref('record'), moneyMode = ref('select'), hotelTab = ref('stay'), flightMode = ref('select'), currentFlightUser = ref(1);
            
            // Touch Logic
            const touchStartX = ref(0);
            const handleTouchStart = (e) => touchStartX.value = e.changedTouches[0].screenX;
            const handleTouchMove = (e) => {};
            const handleTouchEnd = (e) => { 
                const diff = e.changedTouches[0].screenX - touchStartX.value;
                if (currentView.value !== 'home' && diff > 100 && !showLightbox.value && !showCamera.value && !isDragging) { 
                    if(currentView.value === 'prep' && prepMode.value === 'list') prepMode.value = 'select';
                    else if(currentView.value === 'money' && moneyMode.value === 'list') moneyMode.value = 'select';
                    else if(currentView.value === 'hotel' && flightMode === 'list') flightMode = 'select';
                    else goHome(); 
                } 
            };

            const apps = [
                { id: 1, name: 'è¡Œç¨‹è¡¨', icon: 'fa-solid fa-map-location-dot', bgClass: 'bg-gradient-to-br from-pink-400 to-pink-300', view: 'itinerary' },
                { id: 2, name: 'å°è²¡åº«', icon: 'fa-solid fa-sack-dollar', bgClass: 'bg-gradient-to-br from-yellow-300 to-orange-300', view: 'money' },
                { id: 3, name: 'ä½å®¿èˆ‡æ©Ÿç¥¨', icon: 'fa-solid fa-plane-arrival', bgClass: 'bg-gradient-to-br from-indigo-400 to-blue-400', view: 'hotel' },
                { id: 4, name: 'è¡Œå‰æº–å‚™', icon: 'fa-solid fa-suitcase-rolling', bgClass: 'bg-gradient-to-br from-blue-400 to-cyan-400', view: 'prep' },
                { id: 5, name: 'åƒåƒå–å–', icon: 'fa-solid fa-utensils', bgClass: 'bg-gradient-to-br from-orange-400 to-amber-400', view: 'food' },
                { id: 6, name: 'å¿«æ¨‚Shop', icon: 'fa-solid fa-bag-shopping', bgClass: 'bg-gradient-to-br from-purple-400 to-fuchsia-400', view: 'shopping' },
                { id: 7, name: 'å¤©æ°£é€±å ±', icon: 'fa-solid fa-cloud-sun', bgClass: 'bg-gradient-to-br from-sky-400 to-cyan-300', view: 'weather' },
                { id: 8, name: 'ç¶²ç¾æ‰“å¡', icon: 'fa-solid fa-camera', bgClass: 'bg-gradient-to-br from-rose-400 to-red-300', view: 'photo' },
                { id: 9, name: 'å³æ™‚æ•‘å‘½', icon: 'fa-solid fa-comment-medical', bgClass: 'bg-gradient-to-br from-emerald-400 to-green-400', view: 'japanese' },
            ];

            const tokyoWeather = ref({ temp: '--', icon: 'â³', desc: '...', visibility: '--' }), kamakuraWeather = ref({ temp: '--', icon: 'â³', desc: '...', visibility: '--' }), fujiWeather = ref({ temp: '--', icon: 'â³', desc: '...', visibility: '--' });
            const selectedDayIndex = ref(0);
            const tripDays = [{ week: 'Day 1', title: 'æŠµé”/æ™´ç©ºå¡”' }, { week: 'Day 2', title: 'æ·ºè‰/ä¸Šé‡' }, { week: 'Day 3', title: 'ç§Ÿè»Š/æ²³å£æ¹–' }, { week: 'Day 4', title: 'å±±ä¸­æ¹–' }, { week: 'Day 5', title: 'å›æ–°å®¿/æ± è¢‹' }, { week: 'Day 6', title: 'æ±Ÿä¹‹é›»é®å€‰' }, { week: 'Day 7', title: 'æ±äº¬å¡”/æ¾€è°·' }, { week: 'Day 8', title: 'è¿”ç¨‹' }];
            const searchMap = (q) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
            
            // ITINERARY
            const defaultItinerary = [
                [{ id: 101, category: 'Flight', name: '06:40 æ¡ƒåœ’èµ·é£›', hours: '06:40', mapKeyword: 'æ¡ƒåœ’æ©Ÿå ´', note: 'ææ—©2å°æ™‚æŠµé”æ©Ÿå ´' }, { id: 102, category: 'Flight', name: '10:40 æŠµé”æˆç”°æ©Ÿå ´', hours: '10:40', mapKeyword: 'æˆç”°æ©Ÿå ´', note: 'é ˜å–è¡Œæã€è³¼è²·äº¤é€šå¡' }, { id: 103, category: 'Sightseeing', name: 'æ™´ç©ºå¡” Tokyo Skytree', hours: 'ä¸‹åˆ', mapKeyword: 'Tokyo Skytree', note: 'å¯é€› Solamachi å•†åº—è¡—' }, { id: 104, category: 'Food', name: 'æ™šé¤ï¼šéŒ¦ç³¸ç”ºå‘¨é­', hours: 'æ™šä¸Š', mapKeyword: 'éŒ¦ç³¸ç”ºç¾é£Ÿ', note: 'ä¾ç…§ç•¶ä¸‹å¿ƒæƒ…é¸æ“‡' }],
                [{ id: 201, category: 'Sightseeing', name: 'æ·ºè‰å¯º', hours: 'ä¸Šåˆ', mapKeyword: 'æ·ºè‰å¯º', note: 'é›·é–€ã€ä»²è¦‹ä¸–é€š' }, { id: 202, category: 'Food', name: 'åˆé¤ï¼šæ·ºè‰å¯ºå‘¨é­', hours: 'ä¸­åˆ', mapKeyword: 'æ·ºè‰åˆé¤', note: 'æ¨è–¦ç‚¸è‚‰é¤…ã€é°»é­šé£¯' }, { id: 203, category: 'Sightseeing', name: 'å°ç¶²ç¥ç¤¾', hours: 'ä¸‹åˆ', mapKeyword: 'å°ç¶²ç¥ç¤¾', note: 'å¼·é‹å„é™¤' }, { id: 204, category: 'Sightseeing', name: 'ä¸Šé‡æ©è³œå…¬åœ’', hours: 'ä¸‹åˆ', mapKeyword: 'ä¸Šé‡æ©è³œå…¬åœ’', note: 'æ•£æ­¥ã€æ˜Ÿå·´å…‹' }, { id: 205, category: 'Shopping', name: 'ç§‹è‘‰åŸ æˆ– æ±äº¬ä¸€ç•ªè¡—', hours: 'æ™šä¸Š', mapKeyword: 'æ±äº¬ç«™ä¸€ç•ªè¡—', note: 'å‹•æ¼«å‘¨é‚Š / ä¼´æ‰‹ç¦®' }],
                [{ id: 301, category: 'Transport', name: 'å‰å¾€å¯Œå£«å±± (ç§Ÿè»Š)', hours: 'ä¸Šåˆ', mapKeyword: 'æ²³å£æ¹–ç§Ÿè»Š', note: 'å¾éŒ¦ç³¸ç”ºå‡ºç™¼ï¼Œé–‹å§‹3å¤©2å¤œè‡ªé§•' }, { id: 302, category: 'Sightseeing', name: 'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨', hours: 'ä¸‹åˆ', mapKeyword: 'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨' }, { id: 303, category: 'Sightseeing', name: 'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾', hours: 'ä¸‹åˆ', mapKeyword: 'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾' }, { id: 304, category: 'Sightseeing', name: 'é‡‘é³¥å±… & æœ¬ç”ºå•†åº—è¡—', hours: 'å‚æ™š', mapKeyword: 'å¯Œå£«å‰ç”°æœ¬ç”ºé€šã‚Š' }, { id: 305, category: 'Food', name: 'æ™šé¤ï¼šè‡ªç‚Šæˆ–å•†åº—è¡—', hours: 'æ™šä¸Š', mapKeyword: 'å¯Œå£«å‰ç”°æ™šé¤' }],
                [{ id: 401, category: 'Sightseeing', name: 'å¹³é‡ä¹‹æ¿±æ—¥å‡º', hours: 'æ¸…æ™¨', mapKeyword: 'å¹³é‡ä¹‹æ¿±', note: 'çµ•ç¾é€†å¯Œå£«' }, { id: 402, category: 'Sightseeing', name: 'é•·æ± è¦ªæ°´å…¬åœ’ & ç™½é³¥æ¿±', hours: 'ä¸Šåˆ', mapKeyword: 'é•·æ± è¦ªæ°´å…¬åœ’', note: 'é¤µå¤©éµã€æ‹ç¾ç…§' }, { id: 403, category: 'Transport', name: 'ç§Ÿè‡ªè¡Œè»Šç’°æ¹–', hours: 'ä¸Šåˆ', mapKeyword: 'å±±ä¸­æ¹–è‡ªè¡Œè»Šç§Ÿå€Ÿ', note: 'äº«å—æ¹–ç•”å¾®é¢¨' }, { id: 404, category: 'Food', name: 'åˆé¤ï¼šå±±ä¸­æ¹–é¤å»³', hours: 'ä¸­åˆ', mapKeyword: 'å±±ä¸­æ¹–ç¾é£Ÿ' }, { id: 405, category: 'Sightseeing', name: 'KABA æ°´é™¸å·´å£«', hours: 'ä¸‹åˆ', mapKeyword: 'å±±ä¸­æ¹–KABA' }, { id: 406, category: 'Shopping', name: 'Ogino è¶…å¸‚æ¡è²·', hours: 'å‚æ™š', mapKeyword: 'Ogino æ²³å£æ¹–åº—', note: 'æ™šé¤é£Ÿæ' }],
                [{ id: 501, category: 'Sightseeing', name: 'é‡‘é³¥å±… (è£œæ‹)', hours: 'æ—©ä¸Š', mapKeyword: 'é‡‘é³¥å±…', note: 'è‹¥å‰å…©å¤©æ²’æ‹åˆ°' }, { id: 502, category: 'Sightseeing', name: 'æ²³å£æ¹–çºœè»Š & çµ•æ™¯é¦éŸ†', hours: 'æ—©ä¸Š', mapKeyword: 'æ²³å£æ¹–å¯Œå£«å±±å…¨æ™¯çºœè»Š' }, { id: 503, category: 'Shopping', name: 'Fujisan Shokupan', hours: 'ä¸­åˆ', mapKeyword: 'Fujisan Shokupan', note: 'è³¼è²·å¯Œå£«å±±åå¸' }, { id: 504, category: 'Transport', name: 'æ­ä¹˜å¯Œå£«å›éŠè¿”æ–°å®¿', hours: 'ä¸‹åˆ', mapKeyword: 'æ²³å£æ¹–ç«™', note: 'é‚„è»Šå¾Œæ­è»Š' }, { id: 505, category: 'Shopping', name: 'æ± è¢‹å¤ªé™½åŸ', hours: 'æ™šä¸Š', mapKeyword: 'æ± è¢‹å¤ªé™½åŸ', note: 'è³¼ç‰©ã€æ™šé¤' }],
                [{ id: 601, category: 'Transport', name: 'æ–°å®¿å‰å¾€è—¤æ¾¤', hours: 'ä¸Šåˆ', mapKeyword: 'è—¤æ¾¤ç«™', note: 'æ±Ÿä¹‹é›»ä¸€æ—¥éŠé–‹å§‹' }, { id: 602, category: 'Sightseeing', name: 'æ±Ÿä¹‹å³¶', hours: 'ä¸Šåˆ', mapKeyword: 'æ±Ÿä¹‹å³¶', note: 'åƒé“ã€ç¥ç¤¾' }, { id: 603, category: 'Sightseeing', name: 'éŒå€‰é«˜æ ¡å‰', hours: 'ä¸­åˆ', mapKeyword: 'éŒå€‰é«˜æ ¡å‰é§…', note: 'çŒç±ƒé«˜æ‰‹å¹³äº¤é“' }, { id: 604, category: 'Sightseeing', name: 'ä¸ƒé‡Œæ¿± & åˆé¤', hours: 'ä¸‹åˆ', mapKeyword: 'ä¸ƒé‡Œæ¿±', note: 'Bills æˆ–å‘¨é‚Šé¤å»³' }, { id: 605, category: 'Sightseeing', name: 'éŒå€‰', hours: 'å‚æ™š', mapKeyword: 'éŒå€‰å°ç”ºé€š', note: 'é€›è¡—ã€å¤§ä½›' }],
                [{ id: 701, category: 'Sightseeing', name: 'æ±äº¬éµå¡”', hours: 'ä¸Šåˆ', mapKeyword: 'èŠå…¬åœ’', note: 'æ‹ç…§é»ï¼šèŠå…¬åœ’' }, { id: 702, category: 'Sightseeing', name: 'å…­æœ¬æœ¨ / éº»å¸ƒå°', hours: 'ä¸­åˆ', mapKeyword: 'éº»å¸ƒå°ä¹‹ä¸˜', note: 'åˆé¤åœ¨æ­¤è§£æ±º' }, { id: 703, category: 'Sightseeing', name: 'å‰å¾€æ¾€è°·', hours: 'ä¸‹åˆ', mapKeyword: 'æ¾€è°·', note: 'é€›è¡—' }, { id: 704, category: 'Sightseeing', name: 'SHIBUYA SKY', hours: 'å‚æ™š', mapKeyword: 'SHIBUYA SKY', note: 'éœ€é ç´„å¤•é™½æ™‚æ®µ' }, { id: 705, category: 'Shopping', name: 'æ¾€è°·æœ€å¾Œæ¡è²·', hours: 'æ™šä¸Š', mapKeyword: 'æ¾€è°·åå­—è·¯å£', note: 'è—¥å¦ã€å”å‰è¨¶å¾·' }],
                [{ id: 801, category: 'Sightseeing', name: 'è‡ªç”±è¡Œç¨‹', hours: 'ç™½å¤©', mapKeyword: '', note: 'è£œè²¨æˆ–ä¼‘æ¯' }, { id: 802, category: 'Flight', name: '20:40 æˆç”°èµ·é£›', hours: '20:40', mapKeyword: 'æˆç”°æ©Ÿå ´', note: 'ææ—©æŠµé”æ©Ÿå ´' }, { id: 803, category: 'Flight', name: '23:20 æŠµé”æ¡ƒåœ’', hours: '23:20', mapKeyword: 'æ¡ƒåœ’æ©Ÿå ´', note: 'å¹³å®‰å›å®¶' }]
            ];
            const itineraryData = ref(defaultItinerary);
            
            // MONEY (V42: Added type 'personal' | 'group')
            const currentUserId = ref(1), expenses = ref([]), newExpense = ref({name:'', amount:'', category:'é£Ÿ', currency:'JPY'}), expenseType = ref('personal');
            const personalExpenses = computed(() => expenses.value.filter(e => e.user === currentUserId.value && e.type === 'personal').sort((a,b)=>b.id-a.id));
            const groupExpenses = computed(() => expenses.value.filter(e => e.type === 'group').sort((a,b)=>b.id-a.id));
            const userPersonalTotal = computed(() => personalExpenses.value.reduce((s, e) => s + (e.currency === 'TWD' ? Math.round(e.amount / exchangeRate.value) : Number(e.amount)), 0));
            
            const settlements = computed(() => {
                // Split logic only considers group expenses
                const bal = {}; users.value.forEach(u=>bal[u.id]=0);
                groupExpenses.value.forEach(e=>{ 
                    const amtJPY = e.currency === 'TWD' ? Math.round(e.amount / exchangeRate.value) : Number(e.amount);
                    if(bal[e.user]!=undefined) bal[e.user]+=amtJPY; // Payer gets credit
                });
                const total = Object.values(bal).reduce((a,b)=>a+b,0);
                const avg = total / users.value.length;
                const net = {}; users.value.forEach(u=>net[u.id]=bal[u.id]-avg);
                const debt=[], cred=[]; for(let uid in net) { if(net[uid]<-1) debt.push({u:uid,a:-net[uid]}); else if(net[uid]>1) cred.push({u:uid,a:net[uid]}); }
                const res=[]; let i=0,j=0; while(i<debt.length && j<cred.length){ let amt = Math.min(debt[i].a, cred[j].a); if(amt>0) res.push({from:debt[i].u, to:cred[j].u, amount:Math.round(amt)}); debt[i].a-=amt; cred[j].a-=amt; if(debt[i].a<1) i++; if(cred[j].a<1) j++; } return res;
            });

            // EDITABLE LISTS
            const shoppingList = ref({ 
                'wish': [], 
                'cosme': [{id:1, name:'Kate æ€ªç¸å”‡è†', desc:'è³£åˆ°ç¼ºè²¨çš„ç¥ç´šå”‡è†ï¼', img:'./images/kate.jpg', link:searchMap('Kate Monster Lip')}, {id:2, name:'Tirtir æ°£å¢Šç²‰é¤…', desc:'æ—¥æœ¬å¥³ç”Ÿäººæ‰‹ä¸€é¡†çš„ç´…ç›’æ°£å¢Šã€‚', img:'./images/tirtir.jpg', link:searchMap('Tirtir Cushion')}],
                'ldk': [{id:3, name:'Lululun é¢è†œ', desc:'LDK è©•æ¸¬å¸¸å‹è»ï¼', img:'./images/lululun.jpg', link:searchMap('Lululun Mask')}, {id:4, name:'Melano CC ç²¾è¯', desc:'å¹³åƒ¹ç¾ç™½ç¥å™¨ï¼', img:'./images/cc.jpg', link:searchMap('Melano CC')}],
                'souvenir': [{id:5, name:'NY Perfect Cheese', desc:'æ±äº¬è»Šç«™æ’éšŠååº—ï¼', img:'./images/ny.jpg', link:searchMap('NY Perfect Cheese')}] 
            });
            const shopCat = ref('wish');
            const foodList = ref({ 
                'Tokyo': [{id:1, name:'AFURI é˜¿å¤«åˆ©æ‹‰éºµ', desc:'å¿…åƒçš„æŸšå­é¹½æ‹‰éºµï¼', img:'./images/afuri-ramen.jpg', link:'https://afuri.com/'}, {id:2, name:'HARBS æ°´æœåƒå±¤è›‹ç³•', desc:'æ±äº¬ç”œé»ç•Œçš„å¤¢å¹»é€¸å“ï¼', img:'./images/harbs-fruit-crepe.jpg', link:'https://www.harbs.co.jp/'}, {id:3, name:'æ·ºè‰ç‚¸è‚‰é¤…', desc:'ä»²è¦‹ä¸–é€šå¿…åƒæ•£æ­¥ç¾é£Ÿã€‚', img:'./images/menchi.jpg', link:searchMap('æ·ºè‰ç‚¸è‚‰é¤…')}, {id:4, name:'ç‰›ã‹ã¤ã‚‚ã¨æ‘', desc:'äººæ°£ç‚¸ç‰›æ’å®šé£Ÿã€‚', img:'./images/beef.jpg', link:searchMap('ç‰›ã‹ã¤ã‚‚ã¨æ‘')}], 
                'Kamakura': [{id:5, name:'Bills ä¸ƒé‡Œæ¿±', desc:'ä¸–ç•Œç¬¬ä¸€å¥½åƒçš„æ—©é¤ã€‚', img:'./images/bills.jpg', link:searchMap('Bills ä¸ƒé‡Œæ¿±')}, {id:6, name:'è±å³¶å±‹ é´¿å­é¤…ä¹¾', desc:'éŒå€‰æœ€å…·ä»£è¡¨æ€§ä¼´æ‰‹ç¦®ã€‚', img:'./images/dove.jpg', link:searchMap('è±å³¶å±‹ æœ¬åº—')}], 
                'Fuji': [{id:7, name:'Houtou Fudou é¤ºé£¥éºµ', desc:'æ²³å£æ¹–å¿…åƒé„‰åœŸæ–™ç†ã€‚', img:'./images/houtou.jpg', link:searchMap('Houtou Fudou æ±æˆ€è·¯åº—')}, {id:8, name:'Fujisan Shokupan', desc:'è¶…å¯æ„›çš„å¯Œå£«å±±é€ å‹åå¸ï¼', img:'./images/toast.jpg', link:searchMap('Fujisan Shokupan')}] 
            });
            const foodLoc = ref('Tokyo');
            const photoSpots = ref({ 
                'Tokyo': [{id:1, name:'SHIBUYA SKY', desc:'æ±äº¬æœ€ç¾é«˜ç©ºå±•æœ›å°ï¼', img:'./images/sky.jpg', link:searchMap('SHIBUYA SKY')}, {id:2, name:'æ±äº¬éµå¡” (èŠå…¬åœ’)', desc:'èƒ½æ‹åˆ°æ±äº¬éµå¡”å…¨è²Œçš„æœ€ä½³å…¬åœ’ã€‚', img:'./images/tower.jpg', link:searchMap('èŠå…¬åœ’')}], 
                'Kamakura': [{id:3, name:'éŒå€‰é«˜æ ¡å‰', desc:'çŒç±ƒé«˜æ‰‹ç¶“å…¸å ´æ™¯å†ç¾ï¼', img:'./images/slamdunk.jpg', link:searchMap('éŒå€‰é«˜æ ¡å‰ç«™')}, {id:4, name:'é•·è°·å¯º', desc:'ç¹¡çƒèŠ±å­£çš„çµ•ç¾æ™¯é»ã€‚', img:'./images/hasedera.jpg', link:searchMap('é•·è°·å¯º')}], 
                'Fuji': [{id:5, name:'æ–°å€‰å±±æ·ºé–“å…¬åœ’', desc:'æ˜ä¿¡ç‰‡ç­‰ç´šçš„çµ•æ™¯ï¼', img:'./images/pagoda.jpg', link:searchMap('æ–°å€‰å±±æ·ºé–“å…¬åœ’')}, {id:6, name:'æ²³å£æ¹– Lawson', desc:'ä¾¿åˆ©å•†åº—èƒŒå¾Œå°±æ˜¯å·¨å¤§çš„å¯Œå£«å±±ï¼', img:'./images/lawson.jpg', link:searchMap('Lawson æ²³å£æ¹–ç«™å‰åº—')}] 
            });
            const photoArea = ref('Tokyo');
            
            const japanesePhrases = ref([{jp:'ã™ã¿ã¾ã›ã‚“', tw:'ä¸å¥½æ„æ€'}, {jp:'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™', tw:'æˆ‘è¦é€™å€‹'}, {jp:'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™', tw:'çµå¸³'}]);
            const hotels = ref([{name:'éŒ¦ç³¸ç”º Sumida City', days:'Day 1-2', link:'https://maps.app.goo.gl/cyLNVJttoAM61dmFA'}, {name:'Megu Fuji 2021', days:'Day 3-4', link:searchMap('Megu Fuji 2021')}, {name:'DOMO é£¯åº—', days:'Day 5-7', link:searchMap('DOMO é£¯åº— æ±äº¬')}]);
            const transDict = { 'å»æ‰€': 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹', 'æ°´': 'ãŠæ°´ãã ã•ã„', 'çµå¸³': 'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™' };
            const showModal=ref(false), showCommonModal=ref(false), showExpenseModal=ref(false), showSyncModal=ref(false), showTicketModal=ref(false), isEditing=ref(false), editIndex=ref(-1), editForm=ref({}), commonType = ref(''), newCommon = ref({text1:'', text2:'', text3:''}), syncMsg=ref('');
            const avatarInput = ref(null), commonImageInput = ref(null), editingAvatarUserId = ref(null);

            // Helpers
            const currentDayItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
            const getUserById = (id) => users.value.find(u => u.id === id) || users.value[0];
            const currentPrepList = computed(() => getUserById(prepUser.value).list);
            const getProgress = (uid) => { const l = getUserById(uid).list; if(!l.length) return 0; return (l.filter(i=>i.checked).length / l.length)*100; };
            const suggestedTickets = computed(() => { const t = []; const txt = JSON.stringify(itineraryData.value); if (txt.includes('éŒå€‰')) t.push({name: 'æ±Ÿä¹‹é›»ä¸€æ—¥åˆ¸', reason: 'è¡Œç¨‹åŒ…å«éŒå€‰', link:'https://www.klook.com/zh-TW/activity/15647-enoden-1-day-pass-ticket-kamakura/'}); if (txt.includes('æ²³å£æ¹–')) t.push({name: 'å¯Œå£«å›éŠè™Ÿ', reason: 'å‰å¾€æ²³å£æ¹–', link:'https://www.klook.com/zh-TW/activity/108425-fuji-excursion-limited-express/'}); return t; });
            const getCurrentList = () => { if(currentView.value==='food') return foodList.value[foodLoc.value]; if(currentView.value==='shopping') return shoppingList.value[shopCat.value]; if(currentView.value==='photo') return photoSpots.value[photoArea.value]; return []; };

            const goHome = () => { currentView.value = 'home'; prepMode.value = 'select'; moneyMode.value = 'select'; hotelTab.value='stay'; flightMode.value='select'; };
            const getPageTitle = (v) => apps.find(a=>a.view==v)?.name || '';
            const getMapLink = (k) => k ? searchMap(k) : '#';
            const getIconByCategory = (c) => ({'Flight':'fa-plane-up','Sightseeing':'fa-camera','Food':'fa-utensils','Shopping':'fa-bag-shopping','Transport':'fa-train-subway'}[c]||'fa-map-pin');
            const getClothingAdvice = (temp) => { const t = parseFloat(temp); if(t<15) return "å¤§è¡£+åœå·¾"; if(t<20) return "è–„å¤–å¥—"; return "çŸ­è¢–"; };

            const selectPrepUser = (id) => { prepUser.value = id; prepMode.value = 'list'; };
            const selectMoneyUser = (id) => { currentUserId.value = id; moneyMode.value = 'list'; };
            const editUserName = (user) => { const n = prompt('ä¿®æ”¹åç¨±:', user.name); if(n) user.name=n; };
            const addPrepItem = () => { const t=prompt('æ–°å¢:'); if(t) currentPrepList.value.push({text:t, checked:false}); };
            const openImage = (src) => { currentZoomImg.value = src; showLightbox.value = true; };
            const triggerAvatarUpload = (userId) => { editingAvatarUserId.value = userId; avatarInput.value.click(); };
            const processAvatarUpload = (e) => { const file = e.target.files[0]; if (!file || !editingAvatarUserId.value) return; const reader = new FileReader(); reader.onload = (ev) => { const user = users.value.find(u => u.id === editingAvatarUserId.value); if (user) user.avatar = ev.target.result; }; reader.readAsDataURL(file); };
            const processCommonImageUpload = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { newCommon.value.text3 = ev.target.result; }; reader.readAsDataURL(file); };

            const openAddModal = () => { isEditing.value=false; editForm.value={name:'', category:'Sightseeing'}; showModal.value=true; };
            const editItem = (item,idx) => { isEditing.value=true; editIndex.value=idx; editForm.value={...item}; showModal.value=true; };
            const saveItem = () => { const list = itineraryData.value[selectedDayIndex.value] || []; const newItem = { ...editForm.value, id: isEditing.value ? editForm.value.id : Date.now() }; if (isEditing.value) list[editIndex.value] = newItem; else { if(!itineraryData.value[selectedDayIndex.value]) itineraryData.value[selectedDayIndex.value]=[]; itineraryData.value[selectedDayIndex.value].push(newItem); } showModal.value = false; };
            const deleteItem = (idx) => { if(confirm('åˆªé™¤?')) itineraryData.value[selectedDayIndex.value].splice(idx,1); };
            const openExpenseModal = (type) => { expenseType.value=type; newExpense.value={name:'', amount:'', category:'é£Ÿ', currency:'JPY'}; showExpenseModal.value=true; };
            const addExpense = () => { if(newExpense.value.name && newExpense.value.amount) { expenses.value.push({id:Date.now(), user:currentUserId.value, type:expenseType.value, ...newExpense.value, date:`${new Date().getMonth()+1}/${new Date().getDate()}`}); showExpenseModal.value=false; }};
            const deleteExpense = (id) => { if(confirm('åˆªé™¤?')) expenses.value = expenses.value.filter(e=>e.id!==id); };
            const openTicketModal = () => { showTicketModal.value = true; };
            
            // Generic Item CRUD
            const openAddCommonModal = (type) => { commonType.value=type; isEditing.value=false; newCommon.value={text1:'', text2:'', text3:''}; showCommonModal.value=true; };
            const editCommonItem = (item, idx) => { commonType.value=currentView.value; isEditing.value=true; editIndex.value=idx; newCommon.value={text1:item.name, text2:item.desc, text3:item.img}; showCommonModal.value=true; };
            const deleteCommonItem = (idx) => { if(confirm('åˆªé™¤?')) getCurrentList().splice(idx,1); };
            const autoTranslate = () => { const cn = newCommon.value.text1; for (const k in transDict) if(cn.includes(k)) newCommon.value.text2 = transDict[k]; };
            
            const saveCommonItem = () => { 
                const t1 = newCommon.value.text1; const t2 = newCommon.value.text2; const img = newCommon.value.text3;
                if(commonType.value === 'jp') japanesePhrases.value.push({jp:newCommon.value.text2 || 'è«‹è¼¸å…¥', tw:t1}); 
                else {
                    const list = getCurrentList();
                    const item = {id:Date.now(), name:t1, desc:t2||'è‡ªè¨‚', img:img||`https://placehold.co/400x400/FFD1DC/555?text=${t1}`, link:searchMap(t1)};
                    if(isEditing.value) { Object.assign(list[editIndex.value], item); } else { list.push(item); }
                }
                showCommonModal.value=false; 
            };

            const speak = (text) => { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; window.speechSynthesis.speak(u); };
            const doGoogleSearch = () => { if(searchQuery.value) window.open(searchMap(searchQuery.value)); };
            const saveAsHtml = () => { const appState = { itinerary: itineraryData.value, users: users.value, expenses: expenses.value, shop: shoppingList.value, food: foodList.value, photo: photoSpots.value, jp: japanesePhrases.value }; let html = document.documentElement.outerHTML; const dataInjection = ` const savedState = ${JSON.stringify(appState)}; if(savedState) { defaultItinerary.splice(0, defaultItinerary.length, ...savedState.itinerary); defaultUsers.splice(0, defaultUsers.length, ...savedState.users); expenses.value = savedState.expenses; shoppingList.value = savedState.shop; foodList.value = savedState.food; photoSpots.value = savedState.photo; japanesePhrases.value = savedState.jp; } `; html = html.replace('const exchangeRate = ref(0.22);', 'const exchangeRate = ref(0.22);' + dataInjection); const blob = new Blob([html], {type: 'text/html'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = '2026_tokyo_trip_v42.html'; a.click(); URL.revokeObjectURL(url); syncMsg.value = 'ç¶²é æª”ä¸‹è¼‰æˆåŠŸï¼'; };
            const downloadBackup = () => { const data = JSON.stringify({itinerary:itineraryData.value, users:users.value, expenses:expenses.value, shop:shoppingList.value, food:foodList.value, photo:photoSpots.value, jp:japanesePhrases.value}); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'tokyo_trip_backup.json'; a.click(); URL.revokeObjectURL(url); syncMsg.value = 'ä¸‹è¼‰æˆåŠŸï¼'; };
            const loadBackup = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const d = JSON.parse(e.target.result); itineraryData.value=d.itinerary||itineraryData.value; users.value=d.users||users.value; expenses.value=d.expenses||expenses.value; shoppingList.value=d.shop||shoppingList.value; foodList.value=d.food||foodList.value; photoSpots.value=d.photo||photoSpots.value; japanesePhrases.value=d.jp||japanesePhrases.value; syncMsg.value = 'é‚„åŸæˆåŠŸï¼'; setTimeout(()=>showSyncModal.value=false, 1500); } catch(err) { syncMsg.value = 'æª”æ¡ˆæ ¼å¼éŒ¯èª¤'; } }; reader.readAsText(file); };
            const getW = async (lat,lon,refVal) => { try{ const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,cloud_cover&timezone=Asia%2FTokyo`); const d=await r.json(); refVal.value={temp:d.current.temperature_2m, icon:d.current.weather_code<=3?'ğŸŒ¤ï¸':'ğŸŒ§ï¸', desc:d.current.weather_code<=3?'æ™´':'é›¨', visibility:Math.max(0,100-d.current.cloud_cover)}; }catch(e){} };
            const fetchRate = async () => { try { const r=await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); const d=await r.json(); if(d.rates.TWD) exchangeRate.value = (1/d.rates.TWD).toFixed(3); } catch(e){ console.log('Rate fetch failed'); } };
            const openCamera = async () => { showCamera.value = true; try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); if(videoElement.value) videoElement.value.srcObject = stream; } catch(e) { alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ (éœ€HTTPS)'); showCamera.value=false; } };
            const closeCamera = () => { if(videoElement.value && videoElement.value.srcObject) videoElement.value.srcObject.getTracks().forEach(t => t.stop()); showCamera.value = false; };
            const handleImgError = (e, type, name) => { e.target.src = `https://placehold.co/600x400/FFD1DC/555?text=${encodeURIComponent(name || 'åœ–ç‰‡')}`; };

            onMounted(() => {
                try { const s = localStorage.getItem(STORAGE_KEY); if(s) { const d = JSON.parse(s); itineraryData.value = d.itinerary || defaultItinerary; users.value = d.users || users.value; expenses.value = d.expenses || []; shoppingList.value = d.shop || shoppingList.value; foodList.value = d.food || foodList.value; photoSpots.value = d.photo || photoSpots.value; japanesePhrases.value = d.jp || japanesePhrases.value; } else { 
                    // Init Prep Lists
                    const basic = ['è­·ç…§', 'æ—¥å¹£', 'ä¿¡ç”¨å¡', 'SIMå¡'];
                    const drive = JSON.stringify(itineraryData.value).includes('ç§Ÿè»Š') ? ['é§•ç…§/è­¯æœ¬'] : [];
                    users.value.forEach((u, i) => u.list = [...basic, ...(i===0?drive:[])].map(t => ({text:t, checked:false}))); 
                } } catch(e) {}
                getW(35.6895, 139.6917, tokyoWeather); getW(35.3192, 139.5467, kamakuraWeather); getW(35.3606, 138.7274, fujiWeather); fetchRate();
                const sc = document.getElementById('sakura-container'); for(let i=0;i<20;i++){ const e=document.createElement('div'); e.className='sakura'; e.style.left=Math.random()*100+'vw'; e.style.animationDuration=Math.random()*3+4+'s'; sc.appendChild(e); }
                isMounted.value = true;
            });

            watch([itineraryData, users, expenses, shoppingList, foodList, photoSpots, japanesePhrases], ()=>{ localStorage.setItem(STORAGE_KEY, JSON.stringify({itinerary:itineraryData.value, users:users.value, expenses:expenses.value, shop:shoppingList.value, food:foodList.value, photo:photoSpots.value, jp:japanesePhrases.value})); }, {deep:true});

            return { isMounted, currentView, homeBannerImg, apps, goHome, getPageTitle, handleTouchStart, handleTouchEnd, handleTouchMove, tokyoWeather, kamakuraWeather, fujiWeather, foodList, shoppingList, photoSpots, japanesePhrases, hotels, tripDays, selectedDayIndex, currentDayItinerary, moneyTab, users, currentUserId, userPersonalTotal, personalExpenses, groupExpenses, settlements, getUserById, prepUser, prepMode, selectPrepUser, selectMoneyUser, currentPrepList, addPrepItem, editUserName, openAddModal, editItem, saveItem, deleteItem, showModal, editForm, isEditing, openExpenseModal, addExpense, showExpenseModal, newExpense, deleteExpense, getIconByCategory, showCommonModal, commonType, newCommon, openAddCommonModal, saveCommonItem, shopCat, foodLoc, photoArea, speak, autoTranslate, daysUntilTrip, exchangeRate, getClothingAdvice, showSyncModal, syncMsg, downloadBackup, loadBackup, saveAsHtml, showTicketModal, openTicketModal, suggestedTickets, showCamera, openCamera, closeCamera, videoElement, showLightbox, openImage, currentZoomImg, avatarInput, triggerAvatarUpload, processAvatarUpload, commonImageInput, processCommonImageUpload, moneyMode, handleImgError, countdownEl, countdownPos, startDrag, sakuraStatus, searchQuery, doGoogleSearch, expenseType, editCommonItem, deleteCommonItem, getCurrentList, hotelTab, flightMode, currentFlightUser, prepTab, getProgress };
        }
    }).mount('#app');
</script>
</body>
</html>
