<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (V71.9)</title>
<link rel="apple-touch-icon" href="app-icon.png">

<link rel="icon" type="image/png" sizes="192x192" href="app-icon.png">
<link rel="icon" type="image/png" sizes="512x512" href="app-icon.png">

<link rel="manifest" href="manifest.json">
<script>
    window.tailwind = {
        config: {
            theme: {
                extend: {
                    colors: {
                        'chii-pink': '#FFD1DC',
                        'chii-deep-pink': '#FF9EAC',
                        'chii-blue': '#A2D2FF',
                        'chii-yellow': '#FFF5BA',
                        'chii-text': '#5D4037'
                    },
                    fontFamily: {
                        sans: ['Zen Maru Gothic', 'sans-serif']
                    },
                    animation: {
                        'wiggle': 'wiggle 3s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'spin-slow': 'spin 8s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pop': 'pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        wiggle: { '0%,100%': { transform: 'rotate(-3deg)' }, '50%': { transform: 'rotate(3deg)' } },
                        float: { '0%,100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeIn: { from: { opacity: 0, transform: 'translateY(10px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        pop: { '0%': { transform: 'scale(0)' }, '50%': { transform: 'scale(1.2)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    }
</script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>

<style>
    /* V71.6 Core Style */
    html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        font-family: "Zen Maru Gothic", sans-serif;
        color: #5D4037;
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
        background-color: transparent !important;
        overscroll-behavior: none;
    }

    #fixed-bg {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        z-index: -2; 
        background: #fdf2f8; 
        overflow: hidden;
    }

    .blob {
        position: absolute;
        filter: blur(60px); 
        opacity: 0.9;       
        animation: blob-bounce 20s infinite ease-in-out;
        z-index: -2;
        border-radius: 50%;
    }
    .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #FFD1DC; animation-delay: 0s; }
    .blob-2 { top: 40%; right: -20%; width: 400px; height: 400px; background: #A2D2FF; animation-delay: -5s; }
    .blob-3 { bottom: -10%; left: 20%; width: 600px; height: 600px; background: #FFF5BA; animation-delay: -10s; }

    @keyframes blob-bounce {
        0%, 100% { transform: translate(0, 0) scale(1); }
        33% { transform: translate(30px, -50px) scale(1.1); }
        66% { transform: translate(-20px, 20px) scale(0.9); }
    }

    #noise-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        z-index: -1; 
        opacity: 0.05;
        pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

    input, textarea, select { font-size: 16px !important; font-family: inherit; }
    * { -webkit-overflow-scrolling: touch; }

    #app-content {
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        padding-bottom: 180px;
        padding-top: env(safe-area-inset-top);
        transition: padding-bottom 0.3s ease;
    }
    #app-content.view-shopping { padding-bottom: 250px !important; }
    body.modal-open #app-content { overflow: hidden; }

    [v-cloak] { display: none !important; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }

    .card {
        background: rgba(255, 255, 255, 0.75);
        border-radius: 24px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        border: 1px solid rgba(255, 255, 255, 0.6);
        margin-bottom: 0;
        position: relative;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        transition: all 0.2s ease;
        overflow: hidden;
        transform: translateZ(0);
    }
    .card:active { transform: scale(0.98); border-color: #FFD1DC; }

    .immersive-text { text-shadow: 0 2px 10px rgba(255,255,255,0.8), 0 0 20px rgba(255,182,193,0.5); }

    .sos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .sos-card {
        border-radius: 20px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: 2px solid white;
        transition: transform 0.2s;
        height: 100%;
        justify-content: space-between;
    }
    .sos-card:active { transform: scale(0.96); }
    .sos-icon { font-size: 32px; margin-bottom: 8px; }
    .sos-title { font-weight: 900; font-size: 14px; margin-bottom: 4px; }
    .sos-content { font-size: 11px; font-weight: 700; line-height: 1.4; opacity: 0.8; }

    .move-btn-group { display: flex; flex-direction: column; gap: 4px; margin-right: 8px; justify-content: center; }
    .move-btn { width: 28px; height: 28px; border-radius: 8px; background: #fff; color: #d1d5db; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 1px solid #e5e7eb; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .move-btn:active { background: #fb7185; color: white; border-color: #fb7185; }

    .konbini-card { border-left: 6px solid; padding: 15px; background: white; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
    .konbini-711 { border-color: #EF3340; }
    .konbini-fam { border-color: #009245; }
    .konbini-law { border-color: #0068B7; }

    .photo-strategy-box { background: #fff1f2; border-radius: 12px; padding: 12px; margin-top: 12px; font-size: 12px; line-height: 1.6; border: 2px solid #ffe4e6; }
    .photo-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-weight: 900; font-size: 10px; margin-right: 6px; color: white; }
    .tag-time { background-color: #F472B6; } 
    .tag-queue { background-color: #F59E0B; } 

    .hp-bar-container { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 5px; }
    .hp-bar-fill { height: 100%; transition: width 0.5s ease, background-color 0.5s ease; }
    .hp-low { background-color: #ef4444; } .hp-med { background-color: #f59e0b; } .hp-high { background-color: #10b981; }

    .packing-suitcase { width: 60px; height: 50px; background: #3b82f6; border-radius: 8px; position: relative; transition: all 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid #1e40af; }
    .packing-suitcase.full { background: #10b981; border-color: #047857; animation: pop 0.5s; }
    .packing-fill { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.3); transition: height 0.5s; }
    
    .map-cover-container { padding: 0 10px 20px 10px; perspective: 1000px; }
    .map-cover { width: 100%; height: auto; border-radius: 24px; border: 4px solid white; box-shadow: 0 15px 35px rgba(0,0,0,0.15); animation: float 6s ease-in-out infinite; transform-style: preserve-3d; background-color: #eee; min-height: 180px; object-fit: cover; }
    
    .food-card { background: #fff; border-radius: 24px; overflow: visible; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 2px solid white; position: relative; transition: all 0.3s; }
    .item-img-container { height: 180px; width: 100%; background-color: #f3f4f6; position: relative; overflow: hidden; border-radius: 24px 24px 0 0; cursor: zoom-in; }
    .item-img-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
    .img-fallback { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: #999; font-weight: bold; font-size: 12px; z-index: 0; background: #eee; }
    
    .raid-badge { position: absolute; top: -8px; left: -8px; z-index: 20; padding: 6px 12px; border-radius: 16px; font-size: 11px; font-weight: 900; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; items-center; gap: 4px; animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .raid-green { background: linear-gradient(135deg, #10b981, #34d399); border: 2px solid #ecfdf5; }
    .raid-yellow { background: linear-gradient(135deg, #f59e0b, #fbbf24); border: 2px solid #fffbeb; }
    .raid-red { background: linear-gradient(135deg, #ef4444, #f87171); border: 2px solid #fef2f2; animation: pulse-fast; }
    
    .lightbox-overlay { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; animation: fade-in 0.3s ease; }
    .lightbox-img { max-width: 95vw; max-height: 90vh; border-radius: 12px; box-shadow: 0 0 30px rgba(255,255,255,0.2); transform: scale(1); animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

    .fab-home { position: fixed; bottom: calc(25px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); width: 68px; height: 68px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; z-index: 90; border: 4px solid white; box-shadow: 0 10px 25px rgba(255,105,180,0.5); background: linear-gradient(135deg,#FF9EAC,#FFD1DC); cursor: pointer; }
    .fab-main { position: fixed; bottom: calc(100px + env(safe-area-inset-bottom)); right: 20px; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; z-index: 80; border: 3px solid white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .fab-main.lifted { bottom: calc(180px + env(safe-area-inset-bottom)); }
    .fab-search { position: fixed; bottom: calc(30px + env(safe-area-inset-bottom)); left: 20px; width: 54px; height: 54px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #5D4037; z-index: 90; border: 2px solid white; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: all 0.3s; }
    .fab-camera { position: fixed; bottom: calc(100px + env(safe-area-inset-bottom)); left: 20px; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; z-index: 80; border: 3px solid white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); background: #10b981; }
    .coupon-fab { position: fixed; bottom: calc(100px + env(safe-area-inset-bottom)); right: 20px; width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #f43f5e, #fb7185); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; border: 2px solid white; box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3); z-index: 200; transition: transform 0.2s; }
    
    .online-header-bubble { position: fixed; top: calc(12px + env(safe-area-inset-top)); right: 12px; z-index: 300; display: flex; gap: -5px; pointer-events: none; }
    .online-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; background: white; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-left: -10px; position: relative; transition: transform 0.3s; pointer-events: auto; }
    .online-avatar.active { border-color: #4ade80; transform: translateY(2px); z-index: 10; box-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
    .online-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .online-avatar .dot { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #ccc; border-radius: 50%; border: 2px solid white; }
    .online-avatar.active .dot { background: #4ade80; }
    .cloud-status { position: fixed; top: calc(15px + env(safe-area-inset-top)); left: 15px; font-size: 10px; font-weight: bold; color: #aaa; display: flex; align-items: center; gap: 4px; z-index: 300; background: rgba(255,255,255,0.7); padding: 4px 10px; border-radius: 20px; backdrop-filter: blur(4px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
    .status-dot { width: 8px; height: 8px; rounded: 50%; border-radius: 50%; }
</style>
</head>
<body>

<div id="fixed-bg">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
</div>
<div id="noise-overlay"></div>

<div id="app" v-cloak class="h-full flex flex-col">
    
    <div v-if="!isWelcomeClosed" class="welcome-screen flex flex-col items-center justify-between">
        <div class="absolute inset-0 z-0"><img :src="getImg('welcome.jpg')" class="w-full h-full object-cover opacity-90" @error="handleImgError"></div>
        <div class="absolute top-6 right-6 z-50 pt-[env(safe-area-inset-top)]">
            <button @click.stop="handleAuthClick" :class="['flex items-center gap-2 px-4 py-2 rounded-full backdrop-blur-md border border-white/50 shadow-lg font-bold text-sm transition', isLoggedIn ? 'bg-green-500/80 text-white' : 'bg-white/40 text-gray-800']">
                <i :class="isLoggedIn ? 'fa-solid fa-cloud' : 'fa-solid fa-cloud-arrow-up'"></i> {{ isLoggedIn ? 'å·²é€£ç·š' : 'é›²ç«¯åŒæ­¥' }}
            </button>
        </div>
        
        <div class="relative z-10 mt-[env(safe-area-inset-top)] pt-16 text-center px-6">
            <div class="inline-block bg-white/20 backdrop-blur-lg px-6 py-2 rounded-full text-white text-xs font-black tracking-[0.2em] border border-white/40 mb-4 animate-float shadow-lg">V71.8 LIVE RATE</div>
            <h1 class="text-6xl font-black text-white drop-shadow-lg tracking-widest mb-2 font-sans immersive-text">é—œæ±ä¹‹æ—…</h1>
            <p class="text-2xl text-white/90 font-bold tracking-widest drop-shadow-md immersive-text">2026.03.27</p>
        </div>

        <div class="relative z-10 mb-20 w-full px-10 pb-[env(safe-area-inset-bottom)] space-y-4">
            <button @click="enterSite" class="w-full bg-white/90 text-pink-500 font-black py-4 rounded-full shadow-2xl backdrop-blur-xl text-xl flex items-center justify-center gap-3 border border-white animate-pulse-slow">
                <span class="animate-spin-slow">ğŸŒ¸</span> æ—…ä¼´ç™»å…¥
            </button>
            <button @click="enterAsGuest" class="w-full bg-gray-800/60 text-white font-bold py-3 rounded-full backdrop-blur-md text-sm border border-white/30 hover:bg-gray-800/80 transition">
                <i class="fa-solid fa-user-secret"></i> è¨ªå®¢åƒè§€ (å”¯è®€)
            </button>
        </div>
    </div>

    <div v-if="isWelcomeClosed" class="h-full flex flex-col relative">
        
        <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-[60px] bg-[#FFF0F5]/90 backdrop-blur-xl z-30 flex items-center justify-between px-4 border-b border-white/50 shadow-sm pt-[env(safe-area-inset-top)] box-content transition-all">
            <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow-md border border-white active:scale-95 transition"><i class="fa-solid fa-chevron-left"></i></button>
            <h1 class="font-black text-gray-700 text-lg flex items-center gap-2 absolute left-1/2 transform -translate-x-1/2"><i class="fa-solid fa-sakura text-pink-300"></i> {{getPageTitle(currentView)}}</h1>
            <div class="w-10"></div>
        </div>
        <div v-if="currentView !== 'menu'" class="h-[60px] pt-[env(safe-area-inset-top)] box-content shrink-0"></div>

        <div class="online-header-bubble">
            <div v-for="u in users" :key="u.id" :class="['online-avatar', isUserOnline(u.id) ? 'active' : '']" :title="u.name">
                <img v-if="u.avatar" :src="u.avatar" @error="handleImgError">
                <span v-else class="flex items-center justify-center h-full w-full bg-gray-100 text-xs">{{u.icon}}</span>
                <div class="dot"></div>
            </div>
        </div>

        <div id="app-content" class="flex-1" :class="{'view-shopping': currentView === 'shopping'}">

            <div v-if="currentView==='menu'" class="p-6 pt-12 animate-fade-in pb-32">
                <div class="absolute top-6 left-6 pt-[env(safe-area-inset-top)] flex items-center gap-2">
                    <div class="w-10 h-10 rounded-full bg-white shadow flex items-center justify-center text-xl animate-bounce-slow">
                        {{ getBudgetMood() }}
                    </div>
                    <div class="text-[10px] font-bold text-gray-400 bg-white/50 px-2 py-1 rounded-full">é ç®—ç›£æ§</div>
                </div>

                <h2 class="text-3xl font-black text-gray-700 mb-8 text-center pt-[env(safe-area-inset-top)]">{{ getGreeting() }}</h2>
                
                <div class="mb-8 bg-white/70 backdrop-blur-xl border border-white rounded-[32px] p-6 shadow-xl relative overflow-hidden">
                      <div class="flex items-start gap-4 relative z-10">
                          <div class="bg-gradient-to-br from-yellow-200 to-yellow-400 w-12 h-12 rounded-2xl flex items-center justify-center text-white text-xl shrink-0 shadow-lg"><i class="fa-solid fa-bell"></i></div>
                          <div class="flex-1">
                              <div class="font-black text-gray-800 text-lg mb-1">{{ daysUntilTrip > 0 ? `å€’æ•¸ ${daysUntilTrip} å¤©` : 'æ—…ç¨‹é€²è¡Œä¸­ ğŸ‡¯ğŸ‡µ' }}</div>
                              <div class="text-xs text-gray-500 font-bold leading-relaxed space-y-1">
                                 <div v-if="daysUntilTrip > 0">
                                     <div class="text-pink-500 flex items-start gap-1 font-black"><i class="fa-solid fa-ticket mt-0.5"></i> Shibuya Sky é–€ç¥¨æª¢æŸ¥</div>
                                     <div class="text-pink-500 flex items-start gap-1 font-black"><i class="fa-solid fa-passport mt-0.5"></i> è­·ç…§æœ‰æ•ˆæœŸé™</div>
                                 </div>
                                 <div v-else>
                                     <div class="text-blue-500 flex items-start gap-1 font-black"><i class="fa-solid fa-cloud-sun mt-0.5"></i> æ±äº¬: {{weatherData[0].temp}}Â°C (å»ºè­°æ´‹è”¥å¼)</div>
                                     <div class="text-orange-500 flex items-start gap-1 font-black"><i class="fa-solid fa-utensils mt-0.5"></i> è¨˜å¾—ç¢ºèªé¤å»³é ç´„</div>
                                 </div>
                              </div>
                          </div>
                      </div>
                </div>

                <div class="grid grid-cols-3 gap-x-4 gap-y-8 px-2">
                    <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition duration-300 group" @click="currentView=app.view">
                        <div class="w-[76px] h-[76px] rounded-[30px] flex items-center justify-center text-3xl text-white shadow-lg border-[4px] border-white relative overflow-hidden" :class="app.bgClass"><i :class="app.icon"></i></div>
                        <span class="text-sm font-bold mt-3 text-gray-600 group-hover:text-pink-500 transition">{{app.name}}</span>
                    </div>
                </div>
                <button @click="isWelcomeClosed=false" class="mt-12 mx-auto text-gray-400 text-sm font-bold border-b border-gray-300 pb-1 block">å›åˆ°æ­¡è¿é é¢</button>
            </div>

            <div v-if="currentView==='itinerary'" class="px-5 py-4 animate-fade-in">
                <div class="flex overflow-x-auto gap-3 mb-6 hide-scrollbar sticky top-0 z-20 py-3 -mx-5 px-5">
                     <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-6 py-3 rounded-2xl text-sm font-black border-2 transition shrink-0 shadow-sm flex flex-col items-center min-w-[70px]',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400 shadow-lg scale-105':'bg-white text-gray-300 border-white']">
                        <span>{{d.week}}</span>
                        <span class="text-[10px] mt-1 opacity-80">{{d.title}}</span>
                        <div class="hp-bar-container w-10 mt-1">
                            <div class="hp-bar-fill" :class="getStaminaColor(i)" :style="{width: getStamina(i)+'%'}"></div>
                        </div>
                     </button>
                </div>
                <div v-if="[2,3,4].includes(selectedDayIndex)" class="flex justify-center mb-6">
                    <div class="bg-white p-1 rounded-full border border-gray-200 shadow-sm flex">
                        <button @click="itineraryMode='normal'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='normal'?'bg-pink-400 text-white':'text-gray-400']">ä¸€èˆ¬</button>
                        <button @click="itineraryMode='drive'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='drive'?'bg-green-500 text-white':'text-gray-400']"><i class="fa-solid fa-car"></i> è‡ªé§•</button>
                    </div>
                </div>
                <div class="pb-20 relative">
                    <transition-group name="list" tag="div">
                        <div v-for="(item,idx) in getCurrentItinerary()" :key="item.id || idx">
                            <div class="card p-4 border-0 shadow-sm relative group z-10 mb-4 flex items-center" @click="!isGuest && openEditItineraryModal(item, idx)">
                                <div class="absolute left-0 top-0 bottom-0 w-1.5 rounded-l-2xl" :class="itineraryMode==='drive' && [2,3,4].includes(selectedDayIndex)?'bg-green-400':'bg-gradient-to-b from-pink-300 to-pink-100'"></div>
                                
                                <div v-if="!isGuest" class="move-btn-group pl-3" @click.stop>
                                    <button class="move-btn" @click.stop="moveItineraryItem(-1, idx)"><i class="fa-solid fa-chevron-up"></i></button>
                                    <button class="move-btn" @click.stop="moveItineraryItem(1, idx)"><i class="fa-solid fa-chevron-down"></i></button>
                                </div>

                                <div class="flex gap-4 pr-2 flex-1 items-start py-1">
                                    <div class="flex flex-col items-center min-w-[50px]">
                                        <span class="text-xs font-black text-gray-400 mb-2">{{item.hours}}</span>
                                        <div class="w-10 h-10 rounded-full text-lg flex items-center justify-center border" :class="itineraryMode==='drive' && [2,3,4].includes(selectedDayIndex)?'bg-green-50 text-green-500 border-green-100':'bg-pink-50 text-pink-400 border-pink-100'"><i :class="getIconByCategory(item.category)"></i></div>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                                        <p class="text-sm text-gray-500 line-clamp-2 font-medium mb-2">{{item.note}}</p>
                                        <div class="flex gap-2 flex-wrap">
                                            <a :href="getMapLink(item.mapKeyword, item.name)" target="_blank" @click.stop class="inline-flex items-center gap-1 text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded-full font-bold border border-blue-100 hover:bg-blue-100 transition active:scale-95"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="idx < getCurrentItinerary().length - 1" class="timeline-connect !h-[30px] mb-4" :class="{'drive-line': itineraryMode==='drive' && [2,3,4].includes(selectedDayIndex)}">
                                <div v-if="item.travelTime" class="timeline-badge" :class="{'drive-badge': itineraryMode==='drive' && [2,3,4].includes(selectedDayIndex)}">
                                    {{item.travelTime}}
                                </div>
                            </div>
                        </div>
                    </transition-group>
                    <button v-if="!isGuest" @click="openAddItineraryModal" class="w-full py-4 mt-6 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white/50 transition active:scale-95"><i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹</button>
                </div>
            </div>

            <div v-if="currentView==='photo'" class="px-5 py-4 animate-fade-in">
                <div class="flex gap-2 mb-4 justify-center"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="currentLoc=loc" :class="['px-5 py-2 rounded-full font-bold text-xs transition active:scale-95', currentLoc===loc?'bg-rose-400 text-white':'bg-white text-gray-400']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc]}}</button></div>
                <h2 class="text-center font-black text-rose-500 mb-4 text-xl"><i class="fa-solid fa-camera-retro"></i> ç†±é–€æ‰“å¡æ”»ç•¥</h2>
                <div class="grid grid-cols-1 gap-6 pb-20 px-2">
                    <div v-for="(item,idx) in spots.photo[currentLoc]" :key="idx" class="food-card relative group shadow-xl border-4 border-white">
                        <div class="item-img-container h-48" @click.stop="openLightbox(item.img)">
                            <div class="img-fallback">åœ–ç‰‡è¼‰å…¥ä¸­...</div>
                            <img v-if="item.img" :src="getImg(item.img)" class="relative z-10 group-hover:scale-105" @error="handleImgError">
                            <div class="absolute inset-0 bg-black/10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-20"><i class="fa-solid fa-expand text-white text-3xl drop-shadow-md"></i></div>
                        </div>
                        <div class="p-5 relative bg-white">
                            <h3 class="font-black text-gray-800 text-xl mb-1 flex justify-between items-center">{{item.name}}</h3>
                            <p class="text-sm text-gray-500 mb-3 font-bold">{{item.desc}}</p>
                            
                            <div class="photo-strategy-box">
                                <div class="mb-2"><span class="photo-tag tag-time"><i class="fa-regular fa-clock"></i> æœ€ä½³æ©Ÿä½</span> <span class="text-gray-600 font-bold">{{item.bestTime || 'å°šæœªè¨­å®š (è«‹ç·¨è¼¯)'}}</span></div>
                                <div><span class="photo-tag tag-queue"><i class="fa-solid fa-hourglass-half"></i> æ’éšŠæ”»ç•¥</span> <span class="text-gray-600 font-bold">{{item.queueTip || 'ç„¡ç‰¹åˆ¥æ³¨æ„äº‹é …'}}</span></div>
                            </div>

                            <a :href="getMapLink(item.link, item.name)" target="_blank" class="block w-full text-center bg-gray-800 text-white font-bold py-3 rounded-xl text-sm hover:bg-rose-500 transition active:scale-95 mt-4 shadow-md"><i class="fa-solid fa-location-dot"></i> Google Maps å°èˆª</a>
                        </div>
                        <div v-if="!isGuest" class="absolute top-2 right-2 flex gap-2 z-20"><button @click="openEditModal('spot', item, idx)" class="w-8 h-8 bg-white/90 rounded-full shadow text-blue-500 flex items-center justify-center active:scale-90"><i class="fa-solid fa-pen text-[10px]"></i></button></div>
                    </div>
                </div>
                <button v-if="!isGuest" @click="openAddSpotModal()" class="fab-main bg-rose-400 text-white"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div v-if="currentView==='food'" class="px-5 py-4 animate-fade-in">
                <div class="flex gap-2 mb-4 justify-center"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="currentLoc=loc" :class="['px-5 py-2 rounded-full font-bold text-xs transition active:scale-95', currentLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc]}}</button></div>
                <div class="map-cover-container mb-6"><img :src="getMapCover(currentLoc)" class="map-cover w-full shadow-lg border-4 border-white" @error="handleImgError"></div>
                <div class="mb-6"><button @click="showKonbiniModal=true" class="w-full bg-gradient-to-r from-blue-500 to-green-500 text-white font-black py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition border-2 border-white"><i class="fa-solid fa-store"></i> ğŸ‡¯ğŸ‡µ æ—¥æœ¬ä¸‰å¤§è¶…å•†å¿…è²·æ”»ç•¥</button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20 px-2">
                    <div v-for="(item,idx) in spots.food[currentLoc]" :key="idx" class="food-card relative group">
                        <div class="raid-badge" :class="getRaidClass(item)"><i :class="getRaidIcon(item)"></i> {{getRaidLabel(item)}}</div>
                        <div class="item-img-container" @click.stop="openLightbox(item.img)">
                            <div class="img-fallback">åœ–ç‰‡è¼‰å…¥ä¸­...</div>
                            <img v-if="item.img" :src="getImg(item.img)" class="relative z-10 group-hover:scale-110" @error="handleImgError">
                            <div class="absolute bottom-2 right-2 z-20 flex items-center" @click.stop="toggleFoodVote(item)">
                                <div class="flex -space-x-1 mr-2">
                                    <div v-for="uid in item.votes" :key="uid" class="w-6 h-6 rounded-full border border-white bg-gray-100 overflow-hidden flex items-center justify-center text-[8px] shadow-sm">
                                        <img v-if="getUserAvatar(uid).startsWith('http')" :src="getUserAvatar(uid)" class="w-full h-full object-cover">
                                        <span v-else>{{ getUserName(uid).charAt(0) }}</span>
                                    </div>
                                </div>
                                <div class="w-9 h-9 rounded-full bg-white/90 backdrop-blur shadow-md flex items-center justify-center text-rose-500 text-lg transition active:scale-75 cursor-pointer">
                                    <i :class="(item.votes && currentUser && item.votes.includes(currentUser.id)) ? 'fa-solid fa-heart animate-pop' : 'fa-regular fa-heart'"></i>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 relative">
                            <h3 class="font-black text-gray-800 text-lg mb-1 flex justify-between items-center">{{item.name}}</h3>
                            <p class="text-sm text-gray-500 mb-3 font-bold">{{item.desc}}</p>
                            <div class="mb-3 space-y-2"><div v-if="item.reserveLink" class="text-center"><a :href="item.reserveLink" target="_blank" class="inline-block bg-red-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-sm active:scale-95">ç«‹å³é ç´„</a></div></div>
                            <button @click="quickExpense(item)" class="w-full mb-2 bg-yellow-400 text-white font-bold py-2 rounded-lg text-xs flex items-center justify-center gap-1 active:scale-95 transition shadow-sm"><i class="fa-solid fa-file-invoice-dollar"></i> åƒå®Œäº† (ä¸€éµè¨˜å¸³)</button>
                            <a :href="getMapLink(item.link, item.name)" target="_blank" class="block w-full text-center bg-gray-100 text-gray-500 font-bold py-2 rounded-lg text-xs hover:bg-orange-400 hover:text-white transition active:scale-95"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                        </div>
                        <div v-if="!isGuest" class="absolute top-2 right-2 flex gap-2 z-20"><button @click="openEditModal('food', item, idx)" class="w-8 h-8 bg-white/90 rounded-full shadow text-blue-500 flex items-center justify-center active:scale-90"><i class="fa-solid fa-pen text-[10px]"></i></button></div>
                    </div>
                </div>
                <button v-if="!isGuest" @click="openAddFoodModal()" class="fab-main bg-orange-400 text-white"><i class="fa-solid fa-plus"></i></button>
            </div>
             
            <div v-if="currentView==='emergency'" class="px-5 py-6 animate-fade-in pb-32">
                <div class="flex gap-2 mb-6 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm shadow-sm">
                    <button @click="emergencyTab='sos'" :class="['px-6 py-2 rounded-full font-bold transition text-xs', emergencyTab==='sos'?'bg-red-500 text-white shadow-md':'text-gray-400']"><i class="fa-solid fa-truck-medical"></i> SOS æ€¥æ•‘</button>
                    <button @click="emergencyTab='trans'" :class="['px-6 py-2 rounded-full font-bold transition text-xs', emergencyTab==='trans'?'bg-emerald-500 text-white shadow-md':'text-gray-400']"><i class="fa-solid fa-language"></i> ç¿»è­¯/ç›¸æ©Ÿ</button>
                </div>
                <div v-if="emergencyTab==='sos'" class="animate-fade-in">
                    <h2 class="text-2xl font-black text-center mb-6 text-gray-700">ğŸš¨ æ€¥é›£æ•‘åŠ©ä¸­å¿ƒ</h2>
                    <div class="sos-grid h-[320px]">
                        <a href="tel:110" class="sos-card bg-blue-50 border-blue-200"><div class="flex flex-col items-center"><div class="sos-icon text-blue-600"><i class="fa-solid fa-user-shield"></i></div><div class="sos-title text-blue-700">è­¦å¯Ÿæ±‚åŠ©</div></div><div class="sos-content text-blue-800">ğŸš“ å ±è­¦å°ˆç·šï¼š110<br>ğŸ“ æ±äº¬è­¦è¦–å»³</div></a>
                        <a href="tel:119" class="sos-card bg-red-50 border-red-200"><div class="flex flex-col items-center"><div class="sos-icon text-red-600"><i class="fa-solid fa-truck-medical"></i></div><div class="sos-title text-red-700">é†«ç™‚æ€¥æ•‘</div></div><div class="sos-content text-red-800">ğŸš‘ æ•‘è­·å°ˆç·šï¼š119<br>ğŸ¥ é„°è¿‘é†«é™¢</div></a>
                        <a href="tel:05038162787" class="sos-card bg-green-50 border-green-200"><div class="flex flex-col items-center"><div class="sos-icon text-green-600"><i class="fa-solid fa-headset"></i></div><div class="sos-title text-green-700">æ—…å®¢æ”¯æ´</div></div><div class="sos-content text-green-800">â˜ï¸ Visitor Hotline<br>050-3816-2787</div></a>
                        <a href="tel:0332807811" class="sos-card bg-purple-50 border-purple-200"><div class="flex flex-col items-center"><div class="sos-icon text-purple-600"><i class="fa-solid fa-passport"></i></div><div class="sos-title text-purple-700">å°ç£ä»£è¡¨è™•</div></div><div class="sos-content text-purple-800">â˜ï¸ 03-3280-7811<br>ğŸ“ 090-6866-0101</div></a>
                    </div>
                </div>
                <div v-if="emergencyTab==='trans'" class="animate-fade-in">
                    <div class="space-y-3 pb-20">
                        <div v-for="(p,idx) in japanesePhrases" :key="idx" class="card p-5 flex justify-between items-center cursor-pointer hover:shadow-md transition border-l-4 border-emerald-400" @click="expandCard(p)">
                            <div><div class="font-bold text-lg text-gray-800">{{p.jp}}</div><div class="text-xs text-gray-500 font-bold mt-1">{{p.zh}}</div></div>
                            <i class="fa-solid fa-expand text-gray-300"></i>
                        </div>
                    </div>
                    <button v-if="!isGuest" @click="openAddPhraseModal" class="fab-main bg-emerald-500 text-white"><i class="fa-solid fa-plus"></i></button>
                    <div class="fab-camera text-white cursor-pointer" @click="$refs.cameraInput.click()"><i class="fa-solid fa-camera"></i></div>
                    <input type="file" ref="cameraInput" accept="image/*" capture="environment" class="hidden" @change="handleCameraTranslate">
                </div>
             </div>
        
            <div v-if="currentView==='prep'" class="px-5 py-4 animate-fade-in">
                 <div class="bg-blue-50 rounded-3xl p-5 mb-6 text-center border-4 border-blue-200 border-dashed relative overflow-hidden">
                     <div class="text-blue-500 font-black text-sm mb-2 uppercase tracking-widest">Packing Status</div>
                     <div class="flex justify-center mb-2"><div class="packing-suitcase" :class="{'full': getPackingProgress(currentUser)===100}"><div class="packing-fill" :style="{height: getPackingProgress(currentUser)+'%'}"></div><span class="relative z-10">{{getPackingProgress(currentUser)}}%</span></div></div>
                     <div v-if="getPackingProgress(currentUser)===100" class="text-green-500 font-black animate-bounce">Ready to Go! âœˆï¸</div><div v-else class="text-gray-400 text-xs font-bold">é‚„å·®ä¸€é»é»...</div>
                 </div>
                 <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="block w-full bg-gradient-to-r from-blue-600 to-blue-400 text-white rounded-2xl p-4 mb-6 shadow-lg flex items-center justify-between active:scale-95 transition"><div class="flex items-center gap-3"><i class="fa-solid fa-qrcode text-3xl"></i><div><div class="font-bold text-lg">Visit Japan Web</div><div class="text-xs opacity-90">å…¥å¢ƒæ‰‹çºŒ/æµ·é—œç”³å ±</div></div></div><i class="fa-solid fa-chevron-right"></i></a>
                 <div v-if="!currentUser || isGuest" class="text-center text-gray-400 font-bold bg-white/50 py-10 rounded-2xl border border-dashed"><i class="fa-solid fa-suitcase text-3xl mb-2"></i><br>{{isGuest?'è¨ªå®¢ç„¡æ³•å­˜å–ç§äººæ¸…å–®':'è«‹ç™»å…¥ä»¥ç®¡ç†æ¸…å–®'}}</div>
                <div v-else class="card p-0">
                    <div class="bg-gray-50 p-3 border-b font-bold text-gray-700 flex justify-between items-center"><span class="flex items-center gap-2"><i class="fa-solid fa-clipboard-check text-blue-400"></i> {{currentUser.name}} çš„è¡Œæ</span><button @click="addPrepItem(currentUser)" class="text-xs bg-blue-500 text-white px-3 py-1 rounded-full font-bold shadow-blue-200 shadow active:scale-95 transition">+ æ–°å¢</button></div>
                    <div v-for="(item, idx) in currentUser.list" :key="idx" class="flex items-center p-3 border-b border-gray-100 group"><input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-500 mr-3" @change="saveData"><input v-model="item.text" @change="saveData" :class="['flex-1 text-sm font-bold bg-transparent outline-none', item.checked?'text-gray-300 line-through':'text-gray-700']"><button @click="currentUser.list.splice(idx,1);saveData()" class="text-gray-200 hover:text-red-400 transition px-2"><i class="fa-solid fa-times"></i></button></div>
                </div>
                <div class="card p-5 bg-gradient-to-r from-purple-50 to-pink-50 border-purple-100 mb-6 mt-6">
                    <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-purple-800 text-sm flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> æ™¯é»é–€ç¥¨ç²¾éˆ</h4><button v-if="!isGuest" @click="openAddTicketModal" class="text-xs bg-white text-purple-500 px-2 py-1 rounded shadow-sm font-bold border active:scale-95 transition"><i class="fa-solid fa-plus"></i></button></div>
                    <div class="space-y-2"><div v-for="(t, idx) in suggestedTickets" :key="t.name" class="bg-white p-3 rounded-xl shadow-sm border border-purple-100 flex justify-between items-center"><span class="text-sm font-bold text-gray-700">{{t.name}}</span><div class="flex gap-2"><a :href="t.url" target="_blank" class="text-xs bg-purple-500 text-white px-3 py-1.5 rounded-full font-bold active:scale-95 transition">è³¼ç¥¨</a><button v-if="!isGuest" @click="suggestedTickets.splice(idx,1);saveData()" class="text-red-300 text-xs px-1"><i class="fa-solid fa-trash"></i></button></div></div></div>
                </div>
            </div>

            <div v-if="currentView==='shopping'" class="px-5 py-4 animate-fade-in">
                <div class="grid grid-cols-2 gap-3 mb-6"><a href="https://www.cosme.net/ranking/" target="_blank" class="bg-green-50 text-green-600 p-3 rounded-xl text-center font-bold text-xs border border-green-200 block active:scale-95 transition">ğŸ‘‘ COSME å¤§è³</a><a href="https://www.shinyusha.co.jp/media/ldk-the-beauty/" target="_blank" class="bg-pink-50 text-pink-600 p-3 rounded-xl text-center font-bold text-xs border border-pink-200 block active:scale-95 transition">ğŸ’„ LDK æ¯’èˆŒé›œèªŒ</a></div>
                <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar"><button v-for="cat in ['cosme','ldk','souvenir','fashion','toy','other']" @click="shopCat=cat" :class="['px-5 py-2 rounded-full font-bold text-xs whitespace-nowrap transition active:scale-95', shopCat===cat?'bg-pink-400 text-white':'bg-white text-gray-400']">{{{'cosme':'ğŸ’„ è—¥å¦','ldk':'ğŸ‘‘ LDK','souvenir':'ğŸ ä¼´æ‰‹ç¦®','fashion':'ğŸ‘— æœé£¾','toy':'ğŸ’Š æ‰­è›‹ç©å…·','other':'ğŸ›ï¸ é›œè²¨å…¶ä»–'}[cat]}}</button></div>
                <div class="grid grid-cols-2 gap-4"><div v-for="(item,idx) in shopping[shopCat]" class="food-card relative group" :key="idx"><div class="item-img-container" @click.stop="openLightbox(item.img)"><div class="img-fallback">åœ–ç‰‡å¾…è£œ</div><img v-if="item.img" :src="getImg(item.img)" class="relative z-10 group-hover:scale-110" @error="handleImgError"></div><div class="p-3"><div class="font-bold text-gray-800 text-sm mb-1 truncate">{{item.name}}</div><a :href="item.link || getSearchLink(item.name)" target="_blank" class="block text-center bg-gray-50 text-gray-500 text-[10px] py-1.5 rounded font-bold hover:bg-pink-500 hover:text-white transition active:scale-95">å‰å¾€å®˜ç¶² / æœå°‹</a></div><div v-if="!isGuest" class="absolute top-1 right-1 flex gap-1 z-20"><button @click="openEditModal('shopping', item, idx)" class="bg-white/90 p-1.5 rounded-full text-blue-400 shadow w-7 h-7 flex items-center justify-center active:scale-90"><i class="fa-solid fa-pen text-[10px]"></i></button></div></div></div>
                <button v-if="!isGuest" @click="openAddShopModal" class="fab-main bg-purple-400 text-white" :class="{'lifted': currentView === 'shopping'}"><i class="fa-solid fa-plus"></i></button>
                <button @click="showCouponModal=true" class="coupon-fab"><i class="fa-solid fa-ticket"></i></button>
            </div>

            <div v-if="currentView==='weather'" class="px-5 py-4 animate-fade-in">
                 <div class="bg-pink-50 p-4 rounded-2xl border border-pink-200 mb-6 shadow-sm text-center relative overflow-hidden"><i class="fa-solid fa-fan text-pink-200 text-6xl absolute -right-4 -bottom-4 animate-spin-slow"></i><h3 class="font-black text-pink-500 mb-3 text-sm">ğŸŒ¸ 2026 æ«»èŠ±æ¬Šå¨é æ¸¬</h3><div class="grid grid-cols-2 gap-3 mb-3"><a href="https://weathernews.jp/s/sakura/" target="_blank" class="bg-white text-pink-500 py-2 rounded-lg text-xs font-bold shadow-sm hover:shadow-md transition">Weathernews</a><a href="https://tenki.jp/sakura/" target="_blank" class="bg-white text-pink-500 py-2 rounded-lg text-xs font-bold shadow-sm hover:shadow-md transition">æ—¥æœ¬æ°£è±¡å”æœƒ</a></div><div class="grid grid-cols-3 gap-2"><div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">æ±äº¬</div><div class="font-bold text-pink-600">3/22</div></div><div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">éŒå€‰</div><div class="font-bold text-pink-600">3/25</div></div><div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">å¯Œå£«å±±</div><div class="font-bold text-pink-600">4/10</div></div></div></div>
                 <div class="bg-blue-50 p-4 rounded-2xl border border-blue-200 mb-4 shadow-sm relative overflow-hidden"><h3 class="font-black text-blue-500 mb-3 text-sm">â˜ï¸ V71 å³æ™‚å¤©æ°£ (Open-Meteo)</h3><div v-if="weatherLoading" class="text-gray-400 text-xs py-4 font-bold animate-pulse">æ­£åœ¨é€£ç·šè‡³æ—¥æœ¬æ°£è±¡è¡›æ˜Ÿ...</div><div v-else class="space-y-4"><div v-for="w in weatherData" :key="w.name" class="card p-6 text-white relative overflow-hidden" :class="w.bg"><div class="relative z-10 flex justify-between items-center"><div><div class="font-bold opacity-80 uppercase text-xs tracking-widest">{{w.displayName}}</div><div class="text-5xl font-black my-2">{{w.temp}}<span class="text-2xl">Â°C</span></div></div><div class="text-4xl opacity-90"><i :class="w.icon"></i></div></div><div class="relative z-10 mt-2"><div class="text-sm bg-white/20 backdrop-blur inline-block px-3 py-1 rounded-full font-bold">ğŸ‘• {{getClothingAdvice(w.temp)}}</div></div></div></div><button @click="fetchRealWeather" class="mt-4 text-xs bg-white text-blue-500 px-4 py-2 rounded-full font-bold shadow-sm border border-blue-100 active:scale-95">ğŸ”„ æ›´æ–°å¤©æ°£ç‹€æ³</button></div>
            </div>

            <div v-if="currentView==='hotel'" class="px-5 py-4 animate-fade-in">
                 <div class="flex gap-2 mb-6 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm shadow-sm"><button @click="hotelTab='stay'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='stay'?'bg-indigo-500 text-white':'text-gray-400']">ä½å®¿</button><button @click="hotelTab='ticket'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='ticket'?'bg-pink-500 text-white':'text-gray-400']">äº¤é€šç¥¨åˆ¸</button><button @click="hotelTab='flight'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='flight'?'bg-blue-500 text-white':'text-gray-400']">æ©Ÿç¥¨</button><button @click="hotelTab='car'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='car'?'bg-green-500 text-white':'text-gray-400']">ç§Ÿè»Š</button></div>
                <div v-if="hotelTab==='stay'" class="space-y-6"><div v-for="(h, idx) in hotels" :key="idx" class="card !p-0 border-0 shadow-xl overflow-hidden relative group"><div class="h-40 bg-gray-200 relative"><img :src="getImg(h.img)" class="w-full h-full object-cover" @error="handleImgError"><div class="absolute bottom-4 left-5 text-white shadow-black drop-shadow-md"><h3 class="font-black text-2xl">{{h.name}}</h3></div><button v-if="!isGuest" @click="openEditHotelModal(h, idx)" class="absolute top-2 right-2 bg-white/80 p-2 rounded-full text-gray-600 shadow-lg active:scale-95"><i class="fa-solid fa-pen"></i></button></div><div class="p-4"><a :href="getMapLink(h.link)" target="_blank" class="w-full flex items-center justify-center gap-2 bg-indigo-50 text-indigo-600 font-bold py-3 rounded-xl border border-indigo-100 active:scale-95 transition"><i class="fa-solid fa-location-dot"></i> å°èˆª</a></div></div></div>
                <div v-if="hotelTab==='ticket'" class="space-y-4 pb-20"><div v-for="(t, idx) in transportTickets" :key="idx" class="card overflow-hidden"><div class="p-4 flex justify-between items-center border-l-4 border-pink-400"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-pink-50 flex items-center justify-center text-pink-500 text-xl"><i :class="t.icon||'fa-solid fa-ticket'"></i></div><div><div class="font-bold text-gray-800">{{t.name}}</div><div class="text-[10px] text-gray-400 font-bold mt-1">è©³æƒ…èˆ‡é€£çµå¦‚ä¸‹</div></div></div><div class="flex gap-2"><a :href="t.url" target="_blank" class="bg-pink-500 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-md active:scale-95 transition">è³¼è²·</a><button v-if="!isGuest && t.custom" @click="transportTickets.splice(idx,1);saveData()" class="text-red-300 px-2"><i class="fa-solid fa-trash"></i></button></div></div><div class="bg-gray-50 p-3 text-xs text-gray-600 font-medium border-t border-gray-100 leading-relaxed whitespace-pre-wrap"><span class="font-bold text-pink-400 mb-1 block"><i class="fa-solid fa-circle-exclamation"></i> æ³¨æ„äº‹é …ï¼š</span>{{t.note}}</div></div><button v-if="!isGuest" @click="openAddTransTicketModal" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold active:scale-95 transition"><i class="fa-solid fa-plus"></i> æ–°å¢äº¤é€šç¥¨åˆ¸ (è‡ªå‹•å¸¶å…¥)</button></div>
                <div v-if="hotelTab==='flight'" class="animate-fade-in pb-20"><div v-if="!currentUser" class="text-center py-20 text-gray-400 font-bold bg-white/50 rounded-3xl border border-dashed border-gray-300"><i class="fa-solid fa-eye-slash text-4xl mb-4"></i><br>è«‹å…ˆé¸æ“‡èº«åˆ†</div><div v-else class="space-y-4"><div class="card !p-0 border-0 shadow-lg relative overflow-hidden group"><div class="bg-blue-500 p-3 flex justify-between items-center text-white"><span class="font-black text-sm tracking-widest"><i class="fa-solid fa-plane-departure mr-2"></i>å»ç¨‹æ©Ÿç¥¨ (OUT)</span><button v-if="!isGuest" @click="editFlight('out')" class="text-xs bg-white/20 px-2 py-1 rounded hover:bg-white/40"><i class="fa-solid fa-pen"></i></button></div><div class="p-5 relative bg-white"><div class="flex justify-between items-end bg-gray-50 p-3 rounded-xl mb-3"><div><div class="text-[10px] text-gray-400 font-bold">FLIGHT</div><a :href="flightStatusLink(currentUser.flightOut)" target="_blank" class="font-black text-xl text-blue-600 underline decoration-dashed underline-offset-4">{{currentUser.flightOut || 'TR898'}} <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a></div><div class="text-right"><div class="text-[10px] text-gray-400 font-bold">SEAT</div><div class="font-black text-2xl text-blue-500">{{currentUser.flightOutSeat||'--'}}</div></div></div><div class="bg-yellow-50 p-3 text-xs text-yellow-800 font-bold border border-yellow-100 rounded-xl leading-relaxed whitespace-pre-wrap"><i class="fa-solid fa-circle-info mr-1"></i> {{getAirlineInfo(currentUser.flightOut, false) || 'è«‹ç¢ºèªèˆªå»ˆ'}}</div></div></div><div class="card !p-0 border-0 shadow-lg relative overflow-hidden group"><div class="bg-indigo-500 p-3 flex justify-between items-center text-white"><span class="font-black text-sm tracking-widest"><i class="fa-solid fa-plane-arrival mr-2"></i>å›ç¨‹æ©Ÿç¥¨ (IN)</span><button v-if="!isGuest" @click="editFlight('in')" class="text-xs bg-white/20 px-2 py-1 rounded hover:bg-white/40"><i class="fa-solid fa-pen"></i></button></div><div class="p-5 relative bg-white"><div class="flex justify-between items-end bg-gray-50 p-3 rounded-xl mb-3"><div><div class="text-[10px] text-gray-400 font-bold">FLIGHT</div><a :href="flightStatusLink(currentUser.flightIn)" target="_blank" class="font-black text-xl text-indigo-600 underline decoration-dashed underline-offset-4">{{currentUser.flightIn || 'BR197'}} <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a></div><div class="text-right"><div class="text-[10px] text-gray-400 font-bold">SEAT</div><div class="font-black text-2xl text-indigo-500">{{currentUser.flightInSeat||'--'}}</div></div></div><div class="bg-yellow-50 p-3 text-xs text-yellow-800 font-bold border border-yellow-100 rounded-xl leading-relaxed whitespace-pre-wrap"><i class="fa-solid fa-circle-info mr-1"></i> {{getAirlineInfo(currentUser.flightIn, false) || 'è«‹ç¢ºèªèˆªå»ˆ'}}</div></div></div></div></div>
                <div v-if="hotelTab==='car'" class="animate-fade-in space-y-4 pb-20"><div v-for="(car, idx) in rentalCars" :key="idx" class="card overflow-hidden"><div class="p-5 border-l-4" :class="idx%2===0?'border-green-500':'border-blue-400'"><div class="rental-badge" :class="car.status==='done'?'done':'todo'" @click="openRentalDetail(car, idx)"><i :class="car.status==='done'?'fa-solid fa-check':'fa-solid fa-circle-exclamation'"></i>{{car.status==='done'?'å·²å®Œæˆ':'å°šæœªé ç´„'}}</div><div class="flex justify-between items-start"><h3 class="font-black text-lg mb-1">{{car.company}}</h3><button v-if="!isGuest" @click="deleteCar(idx)" class="text-red-300"><i class="fa-solid fa-trash"></i></button></div><p class="text-xs text-gray-500 font-bold mb-3"><i class="fa-solid fa-location-dot"></i> å–è»Šï¼š{{car.pickup}}</p><a :href="car.url" target="_blank" class="block text-center text-white font-bold py-2 rounded-xl active:scale-95 transition" :class="idx%2===0?'bg-green-500':'bg-blue-400'">å‰å¾€é ç´„/æŸ¥çœ‹</a></div></div><button v-if="!isGuest" @click="openAddCarModal" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold active:scale-95 transition"><i class="fa-solid fa-plus"></i> æ–°å¢ç§Ÿè»Šé ç´„</button></div>
            </div>

            <div v-if="currentView==='money'" class="px-5 py-4 animate-fade-in"><div v-if="isGuest" class="text-center py-20 text-gray-400 font-bold bg-white/50 rounded-3xl border border-dashed border-gray-300"><i class="fa-solid fa-user-secret text-4xl mb-4 text-gray-300"></i><br>è¨ªå®¢æ¨¡å¼<br>ç„¡æ³•å­˜å–è²¡å‹™è³‡è¨Š</div><div v-else-if="!currentUser" class="text-center py-20 text-gray-400 font-bold bg-white/50 rounded-3xl border border-dashed border-gray-300"><i class="fa-solid fa-lock text-4xl mb-4 text-pink-300"></i><br>è«‹å…ˆé¸æ“‡èº«åˆ†</div><div v-else><div class="flex gap-2 mb-4 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm shadow-sm"><button @click="moneyTab='record'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='record'?'bg-yellow-400 text-white shadow-md':'text-gray-400']"><i class="fa-solid fa-user-lock"></i> æˆ‘çš„ç§å¸³</button><button @click="moneyTab='split'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='split'?'bg-blue-400 text-white shadow-md':'text-gray-400']"><i class="fa-solid fa-users"></i> å…¬æ¬¾åˆ†å¸³</button></div><div class="flex justify-between items-center mb-4 px-2"><div class="text-xs font-bold text-gray-500 bg-white px-3 py-1.5 rounded-full shadow-sm border border-pink-100">åŒ¯ç‡: 1 JPY â‰ˆ <input v-model="exchangeRate" class="w-14 text-center text-pink-500 font-black outline-none bg-transparent" type="number" step="0.001"> TWD <button @click="fetchExchangeRate" class="ml-2 text-blue-500 active:scale-95"><i class="fa-solid fa-rotate"></i></button></div></div><div v-if="moneyTab==='record'"><div class="card p-6 bg-gradient-to-br from-yellow-300 to-orange-400 text-white border-none shadow-orange-200 mb-4"><div class="flex justify-between items-end"><div><div class="text-xs font-bold opacity-80 mb-1">ğŸ”’ {{currentUser.name}} çš„ç§äººæ”¯å‡º</div><div class="text-4xl font-black">TWD ${{Math.round(myPrivateTotalTWD).toLocaleString()}}</div></div></div></div><div class="space-y-3 pb-20"><div v-for="exp in myPrivateExpenses" :key="exp.id" class="card p-4 flex justify-between items-center !mb-0 !rounded-2xl border-l-4 border-yellow-300"><div><div class="font-bold text-gray-800">{{exp.name}}</div><div class="text-[10px] text-gray-400 flex items-center gap-1">{{getPaymentIcon(exp.method)}} {{exp.date}}</div></div><div class="text-right"><span class="font-black text-gray-700 block">{{exp.currency}} {{exp.amount}}</span></div><button @click="deleteExpense(exp.id)" class="ml-3 text-red-300"><i class="fa-solid fa-trash-can"></i></button></div></div><button @click="openExpenseModal('private')" class="fab-main bg-yellow-400 text-white"><i class="fa-solid fa-pen"></i></button></div><div v-if="moneyTab==='split'"><div class="card p-5 border-l-4 border-blue-400 bg-blue-50/50"><h3 class="font-bold text-blue-500 mb-4 flex items-center gap-2"><i class="fa-solid fa-calculator"></i> æ™ºæ…§çµç®— (TWD)</h3><div v-for="s in settlements" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-blue-100 mb-2"><span class="font-bold text-gray-700 text-sm">{{getUserName(s.from)}} <i class="fa-solid fa-angles-right text-blue-300 mx-1"></i> {{getUserName(s.to)}}</span><span class="font-black text-blue-600">${{s.amount.toLocaleString()}}</span></div></div><div class="flex items-center justify-between mt-6 mb-3 px-2"><h3 class="font-bold text-gray-600">æ‰€æœ‰äººå…¬æ¬¾æ˜ç´° (Live)</h3><span class="text-[10px] bg-green-100 text-green-600 px-2 py-1 rounded-full font-bold animate-pulse-fast">å³æ™‚åŒæ­¥ä¸­</span></div><div class="space-y-3 pb-20"><transition-group name="list"><div v-for="exp in groupExpenses" :key="exp.id" class="card p-4 !mb-0 !rounded-2xl border-l-4 border-blue-300 relative"><div class="flex justify-between items-start mb-1"><div class="font-bold text-gray-800">{{exp.name}} <span class="text-[10px] text-gray-400 font-normal ml-1">{{getPaymentIcon(exp.method)}}</span></div><div class="font-black text-blue-500">{{exp.currency}} {{exp.amount}}</div></div><div class="flex justify-between items-end"><div class="text-xs text-gray-500 font-bold bg-gray-100 px-2 py-1 rounded inline-block"><span class="text-blue-500">{{getUserName(exp.whoPaid)}}</span> ä»˜æ¬¾ <i class="fa-solid fa-caret-right text-gray-400"></i> {{exp.forWhom.length}} äººå‡åˆ†</div><button v-if="exp.whoPaid === currentUser.id" @click="deleteExpense(exp.id)" class="text-red-300 p-2"><i class="fa-solid fa-trash-can"></i></button></div></div></transition-group></div><button @click="openExpenseModal('split')" class="fab-main bg-blue-400 text-white"><i class="fa-solid fa-plus"></i></button></div></div></div>
        </div> 
        
        <div v-if="currentView!=='menu'" class="fab-home" @click="currentView='menu'"><i class="fa-solid fa-house"></i></div>
        <a v-if="currentView!=='welcome'" :href="getSearchLink('')" target="_blank" class="fab-search"><i class="fa-brands fa-google"></i></a>
        <div class="cloud-status" @click="showDiagnostic">
            <div class="status-dot" :class="statusColor"></div>
            <span class="ml-1">{{ statusText }}</span>
        </div>

        <div v-if="showPersonaModal" class="fixed inset-0 z-[2000] bg-black/85 flex items-center justify-center p-6 backdrop-blur-lg animate-fade-in">
            <div class="bg-white/95 w-full max-w-sm rounded-[32px] p-8 text-center shadow-2xl relative border-[6px] border-pink-200">
                <h3 class="font-black text-2xl mb-8 text-pink-500 tracking-wider flex items-center justify-center gap-2"><i class="fa-solid fa-paw"></i> è«‹å•æ‚¨æ˜¯å“ªä¸€ä½ï¼Ÿ</h3>
                <div class="grid grid-cols-2 gap-6 mb-2">
                    <div v-for="u in users" :key="u.id" class="relative group cursor-pointer" @click="setCurrentUser(u)">
                        <div class="w-24 h-24 mx-auto rounded-3xl bg-white border-4 border-gray-100 shadow-lg flex items-center justify-center text-4xl mb-3 overflow-hidden transition-all duration-300 group-hover:scale-110 group-hover:border-pink-400 group-hover:shadow-pink-300 group-hover:rotate-3">
                            <img v-if="u.avatar" :src="u.avatar" class="w-full h-full object-cover">
                            <span v-else>{{u.icon}}</span>
                        </div>
                        <div class="font-black text-gray-600 text-lg group-hover:text-pink-500 transition">{{u.name}}</div>
                        <button v-if="!isGuest" @click.stop="openUserEditor(u)" class="absolute -top-2 -right-2 w-8 h-8 bg-gray-800 text-white rounded-full flex items-center justify-center shadow-md active:scale-90 transition z-10"><i class="fa-solid fa-pen text-xs"></i></button>
                    </div>
                </div>
            </div>
        </div>
        
        <div v-if="previewImg" class="lightbox-overlay" @click="closeLightbox">
            <img :src="previewImg" class="lightbox-img" @click.stop>
        </div>

        <div v-if="showCouponModal" class="fixed inset-0 z-[3000] bg-black/60 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-black text-2xl text-pink-500"><i class="fa-solid fa-ticket"></i> å„ªæƒ åˆ¸</h3>
                    <div class="flex gap-2">
                        <button v-if="!isGuest" @click="openAddCouponModal" class="bg-gray-100 text-gray-600 w-8 h-8 rounded-full active:scale-95"><i class="fa-solid fa-plus"></i></button>
                        <button @click="showCouponModal=false" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 active:scale-95"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto space-y-4 pb-10">
                    <div v-for="(c, idx) in coupons" class="border border-pink-200 rounded-xl p-4 relative overflow-hidden bg-pink-50/30 group">
                        <div class="absolute -right-6 -top-6 w-20 h-20 bg-pink-500 rounded-full opacity-10"></div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-black text-lg text-gray-800">{{c.name}}</h4>
                            <span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow">{{c.discount}}</span>
                        </div>
                        <p class="text-xs text-gray-500 font-bold mb-3"><i class="fa-solid fa-circle-exclamation text-pink-400"></i> {{c.note}}</p>
                        <a :href="c.link" target="_blank" class="block w-full bg-pink-500 text-white text-center font-bold py-3 rounded-lg shadow-md active:scale-95 transition">ä½¿ç”¨ / æ¢ç¢¼</a>
                        <button v-if="!isGuest" @click="openEditModal('coupon', c, idx)" class="absolute top-2 right-2 bg-white/80 p-2 rounded-full text-blue-400 shadow active:scale-90"><i class="fa-solid fa-pen"></i></button>
                        <button v-if="!isGuest" @click="coupons.splice(idx,1);saveData()" class="absolute bottom-2 right-2 text-red-300 opacity-50 hover:opacity-100 active:scale-90"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showRentalModal" class="fixed inset-0 z-[1500] bg-black/60 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-fade-in max-h-[85vh] overflow-y-auto"><h3 class="font-black text-xl mb-4 text-center">ç§Ÿè»Šè©³æƒ…</h3><div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded-lg"><button @click="updateRentalStatus('todo')" :class="['flex-1 py-2 rounded-lg font-bold text-xs transition', activeRental.status==='todo'?'bg-red-100 text-red-600 shadow':'text-gray-400']">å°šæœªé ç´„</button><button @click="updateRentalStatus('done')" :class="['flex-1 py-2 rounded-lg font-bold text-xs transition', activeRental.status==='done'?'bg-green-100 text-green-600 shadow':'text-gray-400']">å·²å®Œæˆ</button></div><div v-if="activeRental.status==='done'" class="space-y-4"><div><label class="text-xs text-gray-400 font-bold block mb-1">é ç´„ç·¨è™Ÿ</label><input v-model="activeRental.reservationNumber" placeholder="è¼¸å…¥è™Ÿç¢¼" class="w-full bg-gray-50 p-3 rounded-xl border font-bold"></div><div><label class="text-xs text-gray-400 font-bold block mb-1">ä¿éšªæ–¹æ¡ˆ</label><input v-model="activeRental.insurance" placeholder="ä¾‹å¦‚ï¼šè±ªè¯å…¨éšª" class="w-full bg-gray-50 p-3 rounded-xl border font-bold"></div><div><label class="text-xs text-gray-400 font-bold block mb-1">å‚™è¨»/ç·Šæ€¥é›»è©±</label><input v-model="activeRental.note" placeholder="è¼¸å…¥å‚™è¨»" class="w-full bg-gray-50 p-3 rounded-xl border font-bold"></div><div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><h4 class="font-bold text-blue-600 text-sm mb-2">æ—¥æœ¬è‡ªé§•å¿…å‚™</h4><div class="space-y-2"><div v-for="item in ['å°ç£é§•ç…§æ­£æœ¬', 'æ—¥æ–‡è­¯æœ¬', 'è­·ç…§', 'ä¿¡ç”¨å¡', 'ETC å¡', 'MapCode']" class="flex items-center text-xs font-bold text-gray-600"><i class="fa-regular fa-square-check mr-2 text-blue-400"></i> {{item}}</div></div></div></div><div v-else class="text-center py-8 text-gray-400 font-bold"><i class="fa-solid fa-triangle-exclamation text-4xl mb-3 text-red-200"></i><br>è«‹ç›¡å¿«å‰å¾€å®˜ç¶²é ç´„</div><div class="flex gap-2 mt-6"><button @click="showRentalModal=false" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold">é—œé–‰</button><button @click="saveData();showRentalModal=false;" class="flex-1 py-3 bg-green-500 text-white rounded-xl font-bold shadow">å„²å­˜</button></div></div></div>

        <div v-if="showModal" class="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
                <h3 class="font-bold text-lg mb-4 text-center">{{modalTitle}}</h3>
                <div class="space-y-3">
                    <div v-if="modalTitle==='æ–°å¢äº¤é€šç¥¨åˆ¸'" class="mb-2"><label class="text-xs font-bold text-gray-400 ml-1">å¿«é€Ÿæ¨¡ç‰ˆ</label><select v-model="modalData.type" @change="applyTicketTemplate" class="w-full p-2 bg-gray-100 rounded-xl font-bold text-sm"><option value="">è‡ªè¨‚</option><option value="suica">Suica</option><option value="metro">æ±äº¬åœ°éµåˆ¸</option><option value="jrpass">JR æ±äº¬å»£åŸŸå‘¨éŠåˆ¸</option><option value="fuji">å¯Œå£«å›éŠè™Ÿ</option></select></div>
                    <div v-for="f in modalFields" :key="f.key">
                        <label v-if="f.label" class="text-xs font-bold text-gray-400 ml-1 mb-1 block">{{f.label}}</label>
                        <div v-if="f.type==='checkbox'" class="flex items-center bg-gray-50 p-3 rounded-xl border">
                            <input type="checkbox" v-model="modalData[f.key]" class="w-5 h-5 accent-pink-500 mr-3">
                            <span class="font-bold text-gray-700 text-sm">{{f.text||f.label}}</span>
                        </div>
                        <div v-else-if="f.key==='note' && modalData.reserve" class="bg-red-50 p-2 rounded text-xs text-red-500 font-bold mb-2">* æé†’ï¼šè«‹è¨˜å¾—åœ¨ä¸‹æ–¹å¡«å…¥é è¨‚é€£çµ</div>
                        <textarea v-else-if="f.type==='textarea'" v-model="modalData[f.key]" :placeholder="f.placeholder" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-pink-300 h-24"></textarea>
                        <input v-else v-model="modalData[f.key]" @input="f.onInput?f.onInput():null" :placeholder="f.placeholder" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-pink-300">
                    </div>
                    <button v-if="modalHasImg" @click="$refs.modalImgInput.click()" class="w-full py-3 bg-blue-50 text-blue-500 rounded-xl font-bold border border-blue-100">{{modalData.img?'æ›´æ›åœ–ç‰‡':'ä¸Šå‚³åœ–ç‰‡'}}</button>
                    <div v-if="modalTitle==='æ–°å¢ç¿»è­¯'" class="text-xs text-gray-400 text-center pt-2">* å¡«å¯«ä¸­æ–‡ï¼Œå¯æŒ‰ä¸‹æ–¹æŒ‰éˆ•è‡ªå‹•ç¿»è­¯</div>
                    <div v-if="modalTitle==='æ–°å¢è¡Œç¨‹' && modalData.name" class="text-center"><a :href="getDirLink(modalData.name)" target="_blank" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full font-bold border border-gray-300 shadow-sm"><i class="fa-solid fa-route"></i> ğŸ” ä¼°ç®—æ™‚é–“</a></div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500 active:scale-95">å–æ¶ˆ</button>
                    <button v-if="modalTitle==='æ–°å¢ç¿»è­¯'" @click="openGoogleTranslate(modalData.zh)" class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-bold shadow-lg active:scale-95">G ç¿»è­¯</button>
                    <button @click="handleModalSave" class="flex-1 py-3 bg-pink-500 text-white rounded-xl font-bold shadow-lg active:scale-95">å„²å­˜</button>
                </div>
                <button v-if="isEditingItem" @click="handleModalDelete" class="w-full mt-2 text-red-300 py-2 font-bold text-xs active:scale-95"><i class="fa-solid fa-trash"></i> åˆªé™¤æ­¤é …ç›®</button>
            </div>
            <input type="file" ref="modalImgInput" accept="image/*" class="hidden" @change="processModalImg">
        </div>

        <div v-if="showLoginModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-3xl p-8 shadow-2xl"><h3 class="text-2xl font-black text-center mb-6">åŒæ­¥é›²ç«¯</h3><input v-model="loginForm.email" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 font-bold" placeholder="Email"><input v-model="loginForm.password" type="password" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 font-bold" placeholder="Password"><button @click="doLogin" class="w-full py-4 bg-pink-500 text-white font-black rounded-2xl active:scale-95 transition">ç™»å…¥</button><button @click="showLoginModal=false" class="w-full py-2 mt-2 text-gray-400 font-bold">å–æ¶ˆ</button></div></div>
        
        <div v-if="showExpenseModal" class="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-center">{{expenseMode==='private'?'è¨˜ä¸€ç­†ç§å¸³':'å…¬æ¬¾åˆ†å¸³'}}</h3><input v-model="modalData.name" placeholder="æ¶ˆè²»é …ç›®" class="w-full p-3 bg-gray-50 rounded-xl mb-3 border font-bold"><div class="flex gap-2 mb-3"><input type="number" v-model="modalData.amount" placeholder="é‡‘é¡" class="flex-1 p-3 bg-gray-50 rounded-xl border font-black text-lg"><select v-model="modalData.currency" class="bg-gray-100 rounded-xl px-2 font-bold text-sm outline-none"><option value="JPY">JPY</option><option value="TWD">TWD</option></select></div><div class="mb-4"><label class="text-xs font-bold text-gray-400 ml-1 mb-1 block">ä»˜æ¬¾æ–¹å¼</label><div class="grid grid-cols-4 gap-2"><button v-for="m in ['cash','card','suica','other']" :key="m" @click="modalData.method=m" :class="['py-2 rounded-xl text-xs font-bold border transition', modalData.method===m?'bg-yellow-400 text-white border-yellow-400':'bg-white text-gray-400 border-gray-200']">{{ {'cash':'ç¾é‡‘','card':'ä¿¡ç”¨å¡','suica':'è¥¿ç“œå¡','other':'å…¶ä»–'}[m] }}</button></div></div><div v-if="expenseMode==='split'" class="mb-4 bg-blue-50 p-3 rounded-xl"><label class="text-xs text-blue-500 font-bold ml-1 block mb-2">èª°å…ˆå¢ŠéŒ¢?</label><div class="flex gap-2 overflow-x-auto hide-scrollbar"><button v-for="u in users" :key="u.id" @click="modalData.whoPaid=u.id" :class="['px-3 py-1 rounded-full text-xs font-bold border transition whitespace-nowrap', modalData.whoPaid===u.id?'bg-blue-500 text-white':'bg-white text-gray-400']">{{u.name}}</button></div><label class="text-xs text-blue-500 font-bold ml-1 block mt-3 mb-2">å¹³åˆ†çµ¦èª°?</label><div class="flex gap-2 overflow-x-auto hide-scrollbar"><button v-for="u in users" :key="u.id" @click="toggleShare(u.id)" :class="['px-3 py-1 rounded-full text-xs font-bold border transition whitespace-nowrap', modalData.forWhom.includes(u.id)?'bg-pink-400 text-white':'bg-white text-gray-400']">{{u.name}}</button></div></div><button @click="saveExpense" class="w-full py-3 bg-yellow-400 text-white rounded-xl font-bold shadow-lg active:scale-95">å„²å­˜</button><button @click="showExpenseModal=false" class="w-full py-3 mt-2 text-gray-400 font-bold active:scale-95">å–æ¶ˆ</button></div></div>
        
        <div v-if="showUserEditModal" class="fixed inset-0 z-[2100] bg-black/60 flex items-center justify-center p-6 backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-xl text-center"><h3 class="font-bold text-lg mb-4">ç·¨è¼¯èº«åˆ†è³‡æ–™</h3><div class="w-24 h-24 mx-auto rounded-full bg-gray-100 border-4 border-white shadow mb-4 overflow-hidden relative cursor-pointer" @click="$refs.avatarInput.click()"><img v-if="editingUser.avatar" :src="editingUser.avatar" class="w-full h-full object-cover"><span v-else class="text-4xl flex items-center justify-center h-full">{{editingUser.icon}}</span></div><input v-model="editingUser.name" class="w-full p-3 bg-gray-50 rounded-xl mb-4 text-center font-bold border"><button @click="saveUserChanges" class="w-full py-2 bg-pink-500 text-white rounded-xl font-bold shadow active:scale-95">å„²å­˜</button></div></div>
        
        <div v-if="showFlightModal" class="fixed inset-0 z-[1200] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-center">ç·¨è¼¯æ©Ÿç¥¨</h3><label class="text-xs font-bold text-gray-400 ml-1">èˆªç­ä»£è™Ÿ</label><input v-model="tempFlightData.code" placeholder="å¦‚ TR898" class="w-full p-3 bg-gray-50 rounded-xl mb-3 border font-black uppercase"><label class="text-xs font-bold text-gray-400 ml-1">åº§ä½è™Ÿç¢¼</label><input v-model="tempFlightData.seat" placeholder="å¦‚ 12A" class="w-full p-3 bg-gray-50 rounded-xl mb-6 border font-black uppercase"><button @click="saveFlight" class="w-full py-3 bg-pink-500 text-white rounded-xl font-bold shadow-lg active:scale-95">æ›´æ–°æ©Ÿç¥¨</button></div></div>
        
        <div v-if="showKonbiniModal" class="fixed inset-0 z-[1600] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col animate-fade-in relative">
                <button @click="showKonbiniModal=false" class="absolute top-4 right-4 text-gray-400 active:scale-90"><i class="fa-solid fa-times text-2xl"></i></button>
                <h3 class="font-black text-2xl mb-6 text-center text-gray-700">ğŸª è¶…å•†å¿…è²·æ”»ç•¥</h3>
                <div class="flex-1 overflow-y-auto pb-6">
                    <div class="mb-6"><h4 class="font-bold text-lg mb-3 flex items-center gap-2"><span class="w-1 h-6 bg-[#EF3340] rounded-full"></span> 7-Eleven</h4><div class="space-y-2"><div class="konbini-card konbini-711"><div><div class="font-bold text-gray-700">ç„¦ç³–å¸ƒä¸å†°æ·‡æ·‹</div><div class="text-[10px] text-gray-400">å†·å‡æ«ƒå¿…æ‹¿</div></div><i class="fa-solid fa-ice-cream text-[#EF3340]"></i></div><div class="konbini-card konbini-711"><div><div class="font-bold text-gray-700">è›‹æ²™æ‹‰ä¸‰æ˜æ²»</div><div class="text-[10px] text-gray-400">æ—©é¤ç¥ç‰©</div></div><i class="fa-solid fa-bread-slice text-[#EF3340]"></i></div><div class="konbini-card konbini-711"><div><div class="font-bold text-gray-700">è’™å¤æ¹¯éºµæ³¡éºµ</div><div class="text-[10px] text-gray-400">è¾›è¾£ä¸­æ¯’æ€§</div></div><i class="fa-solid fa-bowl-food text-[#EF3340]"></i></div></div></div>
                    <div class="mb-6"><h4 class="font-bold text-lg mb-3 flex items-center gap-2"><span class="w-1 h-6 bg-[#009245] rounded-full"></span> FamilyMart</h4><div class="space-y-2"><div class="konbini-card konbini-fam"><div><div class="font-bold text-gray-700">Famichiki ç‚¸é›</div><div class="text-[10px] text-gray-400">çµå¸³æ«ƒæª¯ç›´æ¥é»</div></div><i class="fa-solid fa-drumstick-bite text-[#009245]"></i></div><div class="konbini-card konbini-fam"><div><div class="font-bold text-gray-700">èˆ’èŠ™è•¾å¸ƒä¸</div><div class="text-[10px] text-gray-400">ç”œé»æ«ƒç‹è€…</div></div><i class="fa-solid fa-cookie text-[#009245]"></i></div><div class="konbini-card konbini-fam"><div><div class="font-bold text-gray-700">ç‰§å ´ç‰›å¥¶å†°æ²™</div><div class="text-[10px] text-gray-400">éœ€è‡³å’–å•¡æ©ŸåŠ ç†±ç‰›å¥¶</div></div><i class="fa-solid fa-mug-hot text-[#009245]"></i></div></div></div>
                    <div class="mb-6"><h4 class="font-bold text-lg mb-3 flex items-center gap-2"><span class="w-1 h-6 bg-[#0068B7] rounded-full"></span> Lawson</h4><div class="space-y-2"><div class="konbini-card konbini-law"><div><div class="font-bold text-gray-700">Premium ç”Ÿä¹³æ²</div><div class="text-[10px] text-gray-400">æ¯æœˆ22è™Ÿæœ‰è‰è“ç‰ˆ</div></div><i class="fa-solid fa-cake-candles text-[#0068B7]"></i></div><div class="konbini-card konbini-law"><div><div class="font-bold text-gray-700">ç‚¸é›å› (åŸå‘³/èµ·å¸)</div><div class="text-[10px] text-gray-400">åŒ…è£å¯æ„›ä¸€å£æ¥ä¸€å£</div></div><i class="fa-solid fa-drumstick-bite text-[#0068B7]"></i></div><div class="konbini-card konbini-law"><div><div class="font-bold text-gray-700">BASCHEE å·´æ–¯å…‹</div><div class="text-[10px] text-gray-400">æ¿ƒéƒèµ·å¸å£æ„Ÿ</div></div><i class="fa-solid fa-cheese text-[#0068B7]"></i></div></div></div>
                </div>
            </div>
        </div>

        <div v-if="expandedPhrase" class="fixed inset-0 z-[5000] bg-white flex flex-col items-center justify-center p-10 text-center"><div class="flex-1 flex flex-col items-center justify-center w-full"><div class="text-[80px] leading-tight font-black mb-10 text-gray-800 break-words w-full">{{expandedPhrase.jp}}</div><div class="text-3xl font-bold text-gray-500 mb-16">{{expandedPhrase.zh}}</div><button @click.stop="speakJapanese(expandedPhrase.jp)" class="w-24 h-24 rounded-full bg-emerald-500 text-white text-4xl shadow-xl flex items-center justify-center active:scale-90 transition animate-pulse-fast"><i class="fa-solid fa-volume-high"></i></button><div class="mt-4 text-emerald-600 font-bold">é»æ“Šæ’­æ”¾ç™¼éŸ³</div></div><button class="mb-10 w-16 h-16 rounded-full bg-gray-100 text-gray-400 text-2xl flex items-center justify-center shadow-md active:scale-90" @click="expandedPhrase=null"><i class="fa-solid fa-times"></i></button></div>

        <input type="file" ref="avatarInput" accept="image/*" class="hidden" @change="processAvatarUpload">
    </div>

</div>     
 <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3.3.4/dist/vue.esm-browser.js";

// Firebase è¨­å®š
const firebaseConfig = { apiKey: "AIzaSyD3ojbkJVfDKmZQHRpZG-gp8gv7ajKdJr4", authDomain: "tokyo-trip-24b28.firebaseapp.com", projectId: "tokyo-trip-24b28", storageBucket: "tokyo-trip-24b28.firebasestorage.app", messagingSenderId: "518699705070", appId: "1:518699705070:web:56e95f603210d8d5d209ff" };
let auth, db; try { const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); enableIndexedDbPersistence(db).catch(e=>{}); } catch (e) { console.warn("Firebase Init Fail", e); }

// --- éœæ…‹è³‡æ–™å®šç¾©å€ ---

const defaultPrepList = [{text:'è­·ç…§',checked:false},{text:'æ—¥å¹£',checked:false},{text:'ç¶²å¡/æ¼«éŠ',checked:false},{text:'è¡Œå‹•é›»æº',checked:false}];
const defaultUsers = [
    {id:1,name:'éˆ',icon:'ğŸ¹',list:[...defaultPrepList]},
    {id:2,name:'ä¸',icon:'ğŸ±',list:[...defaultPrepList]},
    {id:3,name:'é´¨',icon:'ğŸ¦†',list:[...defaultPrepList]},
    {id:4,name:'å˜‰',icon:'ğŸ‘',list:[...defaultPrepList]}
];

const getImg = (p) => {
    if (!p) return 'https://placehold.co/600x400/orange/white?text=NO+IMAGE';
    if (p.startsWith('data:') || p.startsWith('http')) return p;
    return `./images/${p}`; 
};

// è©³ç´°è³‡æ–™ (å®Œæ•´ç‰ˆï¼ŒåŒ…å«æ­£ç¢ºåœ–ç‰‡è·¯å¾‘)
const foodSpots = {
    Tokyo: [
        {name:'ç‰›ã‹ã¤ã‚‚ã¨æ‘', desc:'è‡ªè¡Œç…çƒ¤è»Ÿå«©ç‚¸ç‰›æ’', tag:'æ–°å®¿/æ¾€è°·', img:'gyukatsu-motomura.jpg', reserve:false, link:'ç‰›ã‹ã¤ã‚‚ã¨æ‘', reserveLink:'', votes:[]},
        {name:'HARBS', desc:'å¿…åƒæ°´æœåƒå±¤è›‹ç³•', tag:'å…­æœ¬æœ¨/æ–°å®¿', img:'harbs-fruit-crepe.jpg', reserve:false, link:'HARBS', reserveLink:'', votes:[]},
        {name:'ä»ŠåŠ', desc:'ç™¾å¹´è€åº—å£½å–œç‡’', tag:'äººå½¢ç”º', img:'asakusa-imahan.jpg', reserve:true, link:'äººå½¢ç”ºä»ŠåŠ', reserveLink:'https://www.asakusaimahan.co.jp/english/guide', votes:[]},
        {name:'AFURI', desc:'æ¸…çˆ½æŸšå­é¹½æ‹‰éºµ', tag:'åŸå®¿', img:'afuri-ramen.jpg', reserve:false, link:'AFURI åŸå®¿', reserveLink:'', votes:[]},
        {name:'å™å™è‹‘', desc:'é«˜ç´šç‡’è‚‰', tag:'æ™´ç©ºå¡”', img:'jojoen-yakiniku.jpg', reserve:true, link:'å™å™è‹‘', reserveLink:'', votes:[]}
    ],
    Kamakura: [
        {name:'Bills', desc:'ä¸–ç•Œç¬¬ä¸€æ—©é¤é¬†é¤…', tag:'ä¸ƒé‡Œæ¿±', img:'bills-pancakes.jpg', reserve:true, link:'Bills ä¸ƒé‡Œãƒ¶æµœ', reserveLink:'https://billsjapan.com/en/shichirigahama', votes:[]},
        {name:'Pacific Drive-in',desc:'æµ·æ™¯å’–å•¡èˆ‡è’œè“‰è¦', tag:'ä¸ƒé‡Œæ¿±', img:'pacific-drive-in.jpg', reserve:false, link:'Pacific Drive-in', reserveLink:'', votes:[]},
        {name:'å»ä»”é­šé‡œé£¯', desc:'æ±Ÿä¹‹é›»å¿…åƒç¾é£Ÿ', tag:'éŒå€‰', img:'shirasu-kamameshi.jpg', reserve:false, link:'éŒå€‰ é‡œé£¯', reserveLink:'', votes:[]},
        {name:'Caraway', desc:'å‚³èªªä¸­çš„æ’éšŠå’–å“©', tag:'éŒå€‰', img:'caraway-curry.jpg', reserve:false, link:'Caraway Curry', reserveLink:'', votes:[]},
        {name:'åŠ›é¤…å®¶', desc:'ç™¾å¹´è€èˆ–æ¬Šäº”éƒåŠ›é¤…', tag:'é•·è°·', img:'chikaramochiya.jpg', reserve:false, link:'åŠ›é¤…å®¶', reserveLink:'', votes:[]}
    ],
    Fuji: [
        {name:'ä¸å‹•èŒ¶å±‹', desc:'é›²æœµå»ºç¯‰é¤ºé£¥éºµ', tag:'æ²³å£æ¹–', img:'houtouhoutou-fudou-noodles.jpg', reserve:false, link:'ä¸å‹•èŒ¶å±‹ æ±æˆ€è·¯', reserveLink:'', votes:[]}, 
        {name:'å±±éº“åœ’', desc:'åœçˆè£ç‚­ç«ç‡’çƒ¤', tag:'æ²³å£æ¹–', img:'sanrokuen.jpg', reserve:true, link:'å±±éº“åœ’', reserveLink:'https://sanrokuen.com/', votes:[]},
        {name:'ç‡’è‚‰èŠ±', desc:'çœºæœ›å¯Œå£«å±±ç‡’è‚‰', tag:'æ²³å£æ¹–', img:'hana-yakiniku.jpg', reserve:true, link:'Hana Yakiniku', reserveLink:'', votes:[]},
        {name:'The Park', desc:'å¯Œå£«å±±é¬†é¤…èˆ‡åå¸', tag:'æ²³å£æ¹–', img:'the-park-fuji.jpg', reserve:false, link:'The Park', reserveLink:'', votes:[]}
    ]
};

const photoSpots = {
    Tokyo: [
        {name:'SHIBUYA SKY', desc:'æ±äº¬æœ€ç¾å±•æœ›å°', img:'shibuya_sky.jpg', bestTime:'ğŸŒ‡ æ—¥è½å‰ 1 å°æ™‚ (Magic Hour)', queueTip:'âš ï¸ é–€ç¥¨æ¥µé›£æ¶ï¼é–‹æ”¾é ç´„ç•¶æ—¥(4é€±å‰)çš„å°ç£æ™‚é–“æ™šä¸Š11é»æº–æ™‚æ¶ã€‚ç¾å ´é€šå¸¸ç„¡ç¥¨ã€‚', link:'SHIBUYA SKY'},
        {name:'è±ªå¾·å¯º', desc:'æ»¿æ»¿æ‹›è²¡è²“', img:'gotokuji.jpg', bestTime:'â˜€ï¸ ä¸Šåˆ 10:00-11:00 å…‰ç·šç‘åœ¨è²“å’ªå€æœ€ç¾ã€‚', queueTip:'é€±æœ«äººæ½®å¤šåˆ°éœ€ç®¡åˆ¶å…¥å ´ã€‚å»ºè­°å¹³æ—¥ä¸Šåˆå‰å¾€ï¼Œä¸¦ä¿æŒå®‰éœã€‚', link:'è±ªå¾·å¯º'},
        {name:'æ±äº¬éµå¡” (èŠå…¬åœ’)', desc:'åœ°ä¸‹åœè»Šå ´æ¨“æ¢¯æ©Ÿä½', img:'tokyo_tower.jpg', bestTime:'ğŸŒ™ å‚æ™šè—èª¿æ™‚åˆ» (Blue Hour) é»ç‡ˆå¾Œã€‚', queueTip:'ã€Œåœ°ä¸‹åœè»Šå ´å‡ºå£ã€æ˜¯æ’éšŠç†±é»ï¼Œéœ€æ’ 30-60 åˆ†é˜ã€‚', link:'èŠå…¬åœ’ 4è™Ÿåœ°'},
        {name:'æ·ºè‰é›·é–€', desc:'ç¶“å…¸åœ°æ¨™å¤§ç‡ˆç± ', img:'kaminarimon.jpg', bestTime:'ğŸŒ… æ¸…æ™¨ 7:00 å‰ (äººå°‘) æˆ– æ™šä¸Š 9:00 å¾Œã€‚', queueTip:'9:00 å¾Œä»²è¦‹ä¸–é€šäººå±±äººæµ·ï¼Œå¹¾ä¹ç„¡æ³•æ‹åˆ°ç©ºæ™¯ã€‚', link:'é›·é–€'},
        {name:'TeamLab Planets', desc:'å…‰å½±è—è¡“å±•', img:'teamlab.jpg', bestTime:'ğŸ“… é ç´„æœ€æ—©æˆ–æœ€æ™šå ´æ¬¡ã€‚', queueTip:'éœ€èµ¤è…³å…¥å ´ï¼Œå»ºè­°ç©¿è‘—çŸ­è¤²æˆ–æ˜“æ²èµ·çš„è¤²å­ã€‚', link:'TeamLab Planets'}
    ],
    Kamakura: [
        {name:'éŒå€‰é«˜æ ¡å‰', desc:'çŒç±ƒé«˜æ‰‹å¹³äº¤é“', img:'kamakura_koko.jpg', bestTime:'ğŸŒ… æ¸…æ™¨ 7:00-8:00ã€‚', queueTip:'âŒ ç¦æ­¢ç«™åœ¨é¦¬è·¯ä¸­é–“ï¼è­¦è¡›æœƒè¶•äººã€‚å»ºè­°ç«™åœ¨å¡é“ä¸Šæ–¹ç”¨é•·ç„¦æ‹æ”ã€‚', link:'éŒå€‰é«˜æ ¡å‰é§…'},
        {name:'é•·è°·å¯º', desc:'çœºæœ›æ¹˜å—æµ·å²¸', img:'hasedera.jpg', bestTime:'ğŸŒº 6æœˆç¹¡çƒèŠ±å­£éœ€æ¸…æ™¨æ’éšŠã€‚å¹³æ™‚ä¸‹åˆé †å…‰ã€‚', queueTip:'èŠ±å­£æœŸé–“éœ€é ˜ã€Œæ•´ç†åˆ¸ã€ï¼Œç­‰å¾…æ™‚é–“å¯èƒ½è¶…é 2 å°æ™‚ã€‚', link:'é•·è°·å¯º'},
        {name:'å ±åœ‹å¯º', desc:'çµ•ç¾ç«¹æ— (ç±³å…¶æ—ä¸‰æ˜Ÿ)', img:'hokokuji.jpg', bestTime:'â˜€ï¸ ä¸Šåˆ 9:00 é–‹é–€ç¬¬ä¸€æ‰¹ã€‚', queueTip:'æŠ¹èŒ¶å¸­éœ€æ’éšŠï¼Œå»ºè­°å…¥åœ’å…ˆè²·æŠ¹èŒ¶ç¥¨ã€‚', link:'å ±åœ‹å¯º'},
        {name:'æ±Ÿå³¶ç¥ç¤¾', desc:'æµ·ä¸Šé³¥å±…èˆ‡åƒé“', img:'enoshima_shrine.jpg', bestTime:'ğŸŒ‡ æ—¥è½æ™‚åˆ†ã€‚å¤©æ°£å¥½æ™‚å¯è¦‹å¯Œå£«å±±å‰ªå½±ã€‚', queueTip:'å³¶ä¸Šéšæ¢¯å¤šï¼Œå»ºè­°è³¼è²·ã€ŒEscar (é›»æ‰¶æ¢¯)ã€å¥—ç¥¨ã€‚', link:'æ±Ÿå³¶ç¥ç¤¾'},
        {name:'ä¸ƒé‡Œæ¿±', desc:'æœ€ç¾æµ·å²¸ç·š', img:'shichirigahama.jpg', bestTime:'ğŸŒ‡ å¤•é™½æ™‚åˆ» (Golden Hour)ã€‚', queueTip:'æ²¿å²¸å ¤é˜²çš†å¯æ‹ã€‚æ³¨æ„ä¸Šç©ºè€é·¹æœƒæ¶é£Ÿï¼', link:'ä¸ƒé‡Œãƒ¶æµœ æµ·å²¸'}
    ],
    Fuji: [
        {name:'æ–°å€‰å±±æ·ºé–“å…¬åœ’', desc:'äº”é‡å¡”èˆ‡å¯Œå£«å±±', img:'chureito_pagoda.jpg', bestTime:'ğŸŒ… æ¸…æ™¨ 6:00-8:00 (é †å…‰)ã€‚ä¸‹åˆé€†å…‰ã€‚', queueTip:'éœ€çˆ¬ 398 éšæ¢¯ã€‚æ—ºå­£å±•æœ›å°æœƒé™åˆ¶æ‹æ”æ™‚é–“ã€‚', link:'æ–°å€‰å±±æ·ºé–“å…¬åœ’'},
        {name:'ä¸‹å‰ç”° (æœ¬ç”ºäºŒä¸ç›®)', desc:'æ—¥å·æ™‚è¨ˆåº—', img:'honcho_street.jpg', bestTime:'â˜€ï¸ æ¸…æ™¨äººæœ€å°‘ã€‚', queueTip:'âš ï¸ ç›®å‰æœ‰åš´æ ¼äº¤é€šç®¡åˆ¶ï¼Œç¦æ­¢åœ¨è·¯ä¸­åœç•™ã€‚', link:'æ—¥å·æ™‚è¨ˆåº—'},
        {name:'å¤§çŸ³å…¬åœ’', desc:'èŠ±æµ·å¯Œå£«å±±', img:'oishi_park.jpg', bestTime:'â˜€ï¸ ä¸Šåˆé †å…‰ã€‚', queueTip:'å…è²»å…¥å ´ï¼Œä½†åœ˜å®¢æ¥µå¤šã€‚éœ€å¾€å…¬åœ’æ·±è™•èµ°é¿é–‹äººæ½®ã€‚', link:'å¤§çŸ³å…¬åœ’'},
        {name:'æ²³å£æ¹–è»Šç«™', desc:'LAWSON å¯Œå£«å±±', img:'kawaguchiko_station.jpg', bestTime:'ğŸŒ… æ¸…æ™¨ã€‚', queueTip:'âš ï¸ ç«™å‰åº—å·²è¨­é»‘å¹•å±éšœã€‚å»ºè­°æ”¹å»ã€Œæ²³å£æ¹–å½¹å ´å‰åº—ã€æˆ–éš”å£å…¨å®¶ã€‚', link:'æ²³å£æ¹–é§…'},
        {name:'å¹³é‡ä¹‹æ¿±', desc:'å¯§éœæ¹–ç•”å€’å½± (é€†å¯Œå£«)', img:'hirano_beach.jpg', bestTime:'ğŸŒ… æ—¥å‡ºå‰å¾Œ 30 åˆ†é˜ä¸”ç„¡é¢¨æ™‚ã€‚', queueTip:'ç„¡å¤§çœ¾é‹è¼¸ï¼Œå¼·çƒˆå»ºè­°è‡ªé§•ã€‚', link:'å¹³é‡ã®æµœ'}
    ]
};

const defaultData = {
    users: JSON.parse(JSON.stringify(defaultUsers)), 
    itinerary: [
        // Day 1
        [{hours:"06:40",category:"Flight",name:"TPE èµ·é£›",note:"T1 è¾¦ç†ç™»æ©Ÿ",mapKeyword:"æ¡ƒåœ’æ©Ÿå ´ T1"},{hours:"10:40",category:"Flight",name:"NRT æŠµé”",note:"é ˜å–è¡Œæ/è³¼è²·è¥¿ç“œå¡",mapKeyword:"æˆç”°æ©Ÿå ´"},{hours:"14:00",category:"Sightseeing",name:"æ™´ç©ºå¡”",note:"ä¸‹åˆè¡Œç¨‹",mapKeyword:"æ±äº¬æ™´ç©ºå¡”",travelTime:"â¬‡ 60-90min (é›»è»Š/å·´å£«)"},{hours:"18:00",category:"Food",name:"éŒ¦ç³¸ç”ºå‘¨é­",note:"æ™šé¤",mapKeyword:"éŒ¦ç³¸ç”ºç«™ ç¾é£Ÿ",travelTime:"â¬‡ 15min (æ­¥è¡Œ)"}],
        // Day 2
        [{hours:"09:00",category:"Sightseeing",name:"æ·ºè‰å¯º",note:"é›·é–€/ä»²è¦‹ä¸–é€š",mapKeyword:"æ·ºè‰å¯º",travelTime:"â¬‡ 20min (é›»è»Š)"},{hours:"12:00",category:"Food",name:"æ·ºè‰å‘¨é­",note:"åˆé¤",mapKeyword:"æ·ºè‰ç«™ ç¾é£Ÿ",travelTime:"â¬‡ 5min (æ­¥è¡Œ)"},{hours:"14:00",category:"Sightseeing",name:"å°ç¶²ç¥ç¤¾/ä¸Šé‡å…¬åœ’",note:"å¼·é‹å„é™¤/å…¬åœ’æ•£æ­¥",mapKeyword:"å°ç¶²ç¥ç¤¾",travelTime:"â¬‡ 25min (é›»è»Š)"},{hours:"18:00",category:"Shopping",name:"ç§‹è‘‰åŸ/æ±äº¬ä¸€ç•ªè¡—",note:"å‹•æ¼«æˆ–é€›è¡—",mapKeyword:"ç§‹è‘‰åŸ",travelTime:"â¬‡ 15min (é›»è»Š)"},{hours:"20:00",category:"Food",name:"æ™šé¤",note:"ä¾é€›è¡—è¡Œç¨‹æ±ºå®š",mapKeyword:"æ±äº¬è»Šç«™ ç¾é£Ÿ"}],
        // Day 3
        [{hours:"08:00",category:"Transport",name:"å‰å¾€å¯Œå£«å±±",note:"éŒ¦ç³¸ç”ºå‡ºç™¼ (å¯Œå£«å›éŠ)",mapKeyword:"éŒ¦ç³¸ç”ºç«™",travelTime:"â¬‡ 120min (JRç‰¹æ€¥)"},{hours:"10:30",category:"Transport",name:"é–‹å§‹ç§Ÿè»Š",note:"å¯Œå£«å±±ç§Ÿè»Š 3å¤©2å¤œ",mapKeyword:"æ²³å£æ¹– ç§Ÿè»Š",travelTime:"â¬‡ 0min"},{hours:"13:00",category:"Sightseeing",name:"æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨",note:"å¤§çŸ³å…¬åœ’çµ•æ™¯",mapKeyword:"æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨",travelTime:"â¬‡ 20min (è»Š)"},{hours:"15:00",category:"Sightseeing",name:"æ–°å€‰å±±æ·ºé–“å…¬åœ’",note:"å¿ éˆå¡”ç­æœ›å° (éœ€çˆ¬éšæ¢¯)",mapKeyword:"æ–°å€‰å±±æ·ºé–“å…¬åœ’",travelTime:"â¬‡ 25min (è»Š)"},{hours:"17:30",category:"Sightseeing",name:"é‡‘é³¥å±…/æœ¬ç”ºå•†åº—è¡—",note:"æ—¥å·æ™‚è¨ˆåº—æ‹ç…§",mapKeyword:"å¯Œå£«å‰ç”°æœ¬ç”ºé€šã‚Š",travelTime:"â¬‡ 10min (è»Š)"},{hours:"19:00",category:"Food",name:"æ™šé¤",note:"è‡ªè¡Œçƒ¹é£ªæˆ–å•†åº—è¡—",mapKeyword:"Ogino æ²³å£æ¹–åº—"}],
        // Day 4
        [{hours:"05:00",category:"Sightseeing",name:"å¹³é‡ä¹‹æ¿±",note:"çœ‹æ—¥å‡º (è¦–å¤©æ°£)",mapKeyword:"å¹³é‡ã®æµœ",travelTime:"â¬‡ 30min (è»Š)"},{hours:"09:00",category:"Sightseeing",name:"é•·æ± è¦ªæ°´å…¬åœ’/ç™½é³¥æ¿±",note:"å±±ä¸­æ¹–ç§Ÿè‡ªè¡Œè»Š",mapKeyword:"é•·æ± è¦ªæ°´å…¬åœ’",travelTime:"â¬‡ 15min (è»Š)"},{hours:"12:00",category:"Food",name:"å±±ä¸­æ¹–é¤å»³",note:"åˆé¤",mapKeyword:"å±±ä¸­æ¹– ç¾é£Ÿ",travelTime:"â¬‡ 0min"},{hours:"14:00",category:"Sightseeing",name:"KABA æ°´é™¸å·´å£«",note:"æ—­æ—¥ä¸˜æ¹–ç•”ç¶ åœ°å…¬åœ’",mapKeyword:"KABA BUS",travelTime:"â¬‡ 10min (è»Š)"},{hours:"18:00",category:"Food",name:"æ™šé¤",note:"è‡ªè¡Œçƒ¹é£ª (Oginoè¶…å¸‚)",mapKeyword:"Ogino æ²³å£æ¹–åº—",travelTime:"â¬‡ 30min (è»Š)"}],
        // Day 5
        [{hours:"09:00",category:"Sightseeing",name:"æ²³å£æ¹–çºœè»Š",note:"é‡‘é³¥å±…/çµ•æ™¯é¦éŸ†",mapKeyword:"æ²³å£æ¹– å¯Œå£«å±±å…¨æ™¯çºœè»Š",travelTime:"â¬‡ 20min (è»Š)"},{hours:"11:00",category:"Shopping",name:"Fujisan Shokupan",note:"è³¼è²·ä¼´æ‰‹ç¦®é»å¿ƒ",mapKeyword:"Fujisan Shokupan",travelTime:"â¬‡ 10min (è»Š)"},{hours:"14:00",category:"Transport",name:"å¯Œå£«å›éŠ",note:"è¿”å›æ±äº¬æ–°å®¿ (æ”¾è¡Œæ)",mapKeyword:"æ²³å£æ¹–ç«™",travelTime:"â¬‡ 120min (JRç‰¹æ€¥)"},{hours:"16:30",category:"Shopping",name:"æ± è¢‹å¤ªé™½åŸ",note:"é€›è¡—è¡Œç¨‹",mapKeyword:"æ± è¢‹å¤ªé™½åŸ",travelTime:"â¬‡ 20min (é›»è»Š)"},{hours:"19:00",category:"Food",name:"å¤ªé™½åŸé¤å»³",note:"æ™šé¤",mapKeyword:"æ± è¢‹å¤ªé™½åŸ ç¾é£Ÿ"}],
        // Day 6 (è£œå›)
        [{hours:"09:00",category:"Transport",name:"å‰å¾€è—¤æ¾¤",note:"æ–°å®¿å‡ºç™¼ (æ±Ÿä¹‹é›»ä¸€æ—¥éŠ)",mapKeyword:"æ–°å®¿ç«™",travelTime:"â¬‡ 60min (å°ç”°æ€¥)"},{hours:"10:30",category:"Sightseeing",name:"æ±Ÿä¹‹å³¶/éŒå€‰é«˜æ ¡",note:"çŒç±ƒé«˜æ‰‹å¹³äº¤é“",mapKeyword:"éŒå€‰é«˜æ ¡å‰ç«™",travelTime:"â¬‡ 20min (æ±Ÿä¹‹é›»)"},{hours:"13:00",category:"Food",name:"ä¸ƒé‡Œæ¿±é¤å»³",note:"åˆé¤",mapKeyword:"ä¸ƒé‡Œæ¿± ç¾é£Ÿ",travelTime:"â¬‡ 10min (æ±Ÿä¹‹é›»)"},{hours:"15:00",category:"Sightseeing",name:"éŒå€‰/é¶´å²¡å…«å¹¡å®®",note:"å°ç”ºé€šé€›è¡—",mapKeyword:"é¶´å²¡å…«å¹¡å®®",travelTime:"â¬‡ 20min (æ±Ÿä¹‹é›»)"},{hours:"18:00",category:"Transport",name:"è¿”å›æ–°å®¿",note:"æ™šé¤: æ–°å®¿æˆ–çƒ¹é£ª",mapKeyword:"æ–°å®¿ç«™",travelTime:"â¬‡ 60min (å°ç”°æ€¥)"}],
        // Day 7 (è£œå›)
        [{hours:"09:00",category:"Sightseeing",name:"æ±äº¬éµå¡”/éº»å¸ƒå°",note:"å…­æœ¬æœ¨å‘¨é­æ‹ç…§",mapKeyword:"éº»å¸ƒå°Hills",travelTime:"â¬‡ 30min (åœ°éµ)"},{hours:"12:00",category:"Food",name:"å…­æœ¬æœ¨é¤å»³",note:"åˆé¤",mapKeyword:"å…­æœ¬æœ¨ ç¾é£Ÿ",travelTime:"â¬‡ 10min (æ­¥è¡Œ)"},{hours:"14:00",category:"Shopping",name:"å‰å¾€æ¾€è°·",note:"é€›è¡—",mapKeyword:"æ¾€è°·ç«™",travelTime:"â¬‡ 15min (åœ°éµ)"},{hours:"17:00",category:"Sightseeing",name:"SHIBUYA SKY",note:"çµ•ç¾æ—¥è½/åå­—è·¯å£",mapKeyword:"SHIBUYA SKY",travelTime:"â¬‡ 5min (æ­¥è¡Œ)"},{hours:"20:00",category:"Food",name:"æ¾€è°·é¤å»³",note:"æ™šé¤",mapKeyword:"æ¾€è°· ç¾é£Ÿ"}],
        // Day 8 (è£œå›)
        [{hours:"10:00",category:"Sightseeing",name:"è‡ªç”±è¡Œç¨‹",note:"æœ€å¾Œæ¡è²·",mapKeyword:"ä¸Šé‡é˜¿ç¾æ©«ä¸",travelTime:"â¬‡ 0min"},{hours:"20:40",category:"Flight",name:"NRT èµ·é£›",note:"æˆç”°æ©Ÿå ´å ±åˆ°",mapKeyword:"æˆç”°æ©Ÿå ´"},{hours:"23:20",category:"Flight",name:"TPE æŠµé”",note:"å›åˆ°æº«æš–çš„å®¶",mapKeyword:"æ¡ƒåœ’æ©Ÿå ´"}]
    ],
    drivePlan: [
        [{hours:"08:00",category:"Transport",name:"å‰å¾€å¯Œå£«å±±",note:"éŒ¦ç³¸ç”ºå‡ºç™¼",travelTime:"ğŸš— 120min"}, {hours:"10:30",category:"Transport",name:"é–‹å§‹ç§Ÿè»Š",note:"æ²³å£æ¹– ç§Ÿè»Š",travelTime:"ğŸš— 20min",parkingLink:"æ²³å£æ¹–é§… é§è»Šå ´"}, {hours:"13:00",category:"Sightseeing",name:"æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨",note:"å¤§çŸ³å…¬åœ’çµ•æ™¯",travelTime:"ğŸš— 20min",parkingLink:"å¤§çŸ³å…¬åœ’ é§è»Šå ´"}, {hours:"15:00",category:"Sightseeing",name:"æ–°å€‰å±±æ·ºé–“å…¬åœ’",note:"å¿ éˆå¡”ç­æœ›å°",travelTime:"ğŸš— 15min",parkingLink:"æ–°å€‰å±±æ·ºé–“å…¬åœ’ é§è»Šå ´"}, {hours:"17:30",category:"Sightseeing",name:"é‡‘é³¥å±…/æœ¬ç”ºå•†åº—è¡—",note:"æ—¥å·æ™‚è¨ˆåº—æ‹ç…§",travelTime:"ğŸš— 10min",parkingLink:"å¯Œå£«å‰ç”°å¸‚å–¶ æœ¬ç”ºé€šã‚Šé§è»Šå ´"}, {hours:"19:00",category:"Food",name:"æ™šé¤",note:"è‡ªè¡Œçƒ¹é£ªæˆ–å•†åº—è¡—"}],
        [{hours:"05:00",category:"Sightseeing",name:"å¹³é‡ä¹‹æ¿±",note:"çœ‹æ—¥å‡º",travelTime:"ğŸš— 30min",parkingLink:"å¹³é‡ã®æµœ é§è»Šå ´"}, {hours:"09:00",category:"Sightseeing",name:"é•·æ± è¦ªæ°´å…¬åœ’/ç™½é³¥æ¿±",note:"å±±ä¸­æ¹–ç§Ÿè‡ªè¡Œè»Š",travelTime:"ğŸš— 15min",parkingLink:"é•·æ± è¦ªæ°´å…¬åœ’ é§è»Šå ´"}, {hours:"12:00",category:"Food",name:"å±±ä¸­æ¹–é¤å»³",note:"åˆé¤",travelTime:"ğŸš— 20min"}, {hours:"14:00",category:"Sightseeing",name:"KABA æ°´é™¸å·´å£«",note:"æ—­æ—¥ä¸˜æ¹–ç•”ç¶ åœ°å…¬åœ’",travelTime:"ğŸš— 30min",parkingLink:"æ—­æ—¥ä¸˜æ¹–ç•”ç·‘åœ°å…¬åœ’ é§è»Šå ´"}, {hours:"18:00",category:"Food",name:"æ™šé¤",note:"è‡ªè¡Œçƒ¹é£ª (Oginoè¶…å¸‚)"}],
        [{hours:"09:00",category:"Sightseeing",name:"æ²³å£æ¹–çºœè»Š",note:"å¤©ä¸Šå±±å…¬åœ’çµ•æ™¯",travelTime:"ğŸš— 15min",parkingLink:"æ²³å£æ¹–ç•”çœŒå–¶é§è»Šå ´"}, {hours:"11:00",category:"Shopping",name:"Fujisan Shokupan",note:"å¯Œå£«å±±åå¸ä¼´æ‰‹ç¦®",travelTime:"ğŸš— 10min",parkingLink:"Fujisan Shokupan Parking"}, {hours:"12:30",category:"Food",name:"æ²³å£æ¹–åˆé¤",note:"æœ€å¾Œçš„å¯Œå£«å±±ç¾é£Ÿ",travelTime:"ğŸš— 15min"}, {hours:"13:30",category:"Transport",name:"åŠ æ²¹/é‚„è»Š",note:"åŠ æ»¿æ²¹å¾Œæ­¸é‚„",travelTime:"ğŸš¶ 5min"}, {hours:"14:00",category:"Transport",name:"å¯Œå£«å›éŠ",note:"å‰å¾€æ–°å®¿ (è»Šä¸Šè£œçœ )",travelTime:"â¬‡ 120min (JRç‰¹æ€¥)"}, {hours:"16:30",category:"Shopping",name:"æ± è¢‹å¤ªé™½åŸ",note:"æ±äº¬å¸‚å€é€›è¡—",travelTime:"â¬‡ 20min"}]
    ],
    shopping: {
        cosme: [
            {name:'Canmake è‡¥è ¶ç›¤', link:'https://www.canmake.com/', img:'canmake.jpg'},
            {name:'Kate æ€ªç¸å”‡è†', link:'https://www.nomorerules.net/', img:'kate.jpg'},
            {name:'Tirtir æ°£å¢Šç²‰é¤…', link:'', img:'tirtir.jpg'},
            {name:'Cezanne ç å…‰ä¿®å®¹', link:'https://www.cezanne.co.jp/', img:'cezanne.jpg'},
            {name:'Excel çœ¼å½±', link:'https://noevirgroup.jp/excel/', img:'excel.jpg'}
        ],
        ldk: [
            {name:'MINON èƒºåŸºé…¸é¢è†œ', link:'https://www.daiichisankyo-hc.co.jp/site_minon/', img:'minon.jpg'},
            {name:'Quality 1st é¢è†œ', link:'', img:'quality1st.jpg'},
            {name:'IHADA åŒ–å¦æ°´', link:'', img:'ihada.jpg'},
            {name:'Elixir å°é‡‘ç®¡', link:'', img:'elixir.jpg'},
            {name:'Fino é«®è†œ', link:'', img:'fino.jpg'}
        ],
        souvenir: [
            {name:'NY Perfect Cheese', link:'', img:'ny_cheese.jpg'},
            {name:'Press Butter Sand', link:'https://buttersand.com/', img:'pbs.jpg'},
            {name:'Sugar Butter Tree', link:'', img:'sbt.jpg'},
            {name:'Tokyo Banana', link:'https://www.tokyobanana.jp/', img:'banana.jpg'},
            {name:'ç™½è‰²æˆ€äºº', link:'https://www.ishiya.co.jp/', img:'shiroi.jpg'}
        ],
        fashion: [
            {name:'GU (æ¯”å°ç£ä¾¿å®œ)', link:'https://www.gu-global.com/jp/ja/', img:'gu.jpg'},
            {name:'UNIQLO æ——è‰¦åº—', link:'https://www.uniqlo.com/jp/ja/', img:'uniqlo.jpg'},
            {name:'ABC-MART Grand Stage', link:'https://gs.abc-mart.net/', img:'abc_mart.jpg'},
            {name:'Workman Girl', link:'https://www.workman.co.jp/', img:'workman.jpg'},
            {name:'WEGO åŸå®¿', link:'https://wego.jp/', img:'wego.jpg'}
        ],
        toy: [
            {name:'æ± è¢‹ æ‰­è›‹ç™¾è²¨åº— (å¤ªé™½åŸ)', link:'https://bandainamco-am.co.jp/others/gashapon-dept/', img:'gachapon.jpg'},
            {name:'Nintendo Tokyo (æ¾€è°·)', link:'https://www.nintendo.co.jp/officialstore/', img:'nintendo.jpg'},
            {name:'Kiddy Land (åŸå®¿)', link:'https://www.kiddyland.co.jp/harajuku/', img:'kiddyland.jpg'},
            {name:'Pokemon Center', link:'https://www.pokemon.co.jp/shop/', img:'pokemon.jpg'},
            {name:'é§¿æ²³å±‹ (äºŒæ‰‹å‹•æ¼«)', link:'https://www.suruga-ya.jp/', img:'surugaya.jpg'}
        ],
        other: [
            {name:'Standard Products', link:'https://standardproducts.jp/', img:'standard.jpg'},
            {name:'3COINS', link:'https://www.3coins.jp/', img:'3coins.jpg'},
            {name:'LOFT æ–‡å…·é›œè²¨', link:'https://www.loft.co.jp/', img:'loft.jpg'},
            {name:'Seria (100åœ“åº—)', link:'https://www.seria-group.com/', img:'seria.jpg'},
            {name:'Donki å”å‰è¨¶å¾·', link:'https://www.donki.com/', img:'donki.jpg'}
        ]
    },
    coupons: [
        {name: 'å”å‰è¨¶å¾·', discount: '10% (å…ç¨…) + 5%', link: 'https://www.djapanpass.com/coupon/0002000103', note: 'æœªç¨…æ»¿ 1è¬æ—¥åœ“'},
        {name: 'Bic Camera', discount: '10% (å…ç¨…) + 7%', link: 'https://www.biccamera.com/bc/c/info/order/lang-select.jsp', note: 'å‡ºç¤ºè­·ç…§'},
        {name: 'æ¾æœ¬æ¸…', discount: '10% (å…ç¨…) + 3~7%', link: 'https://www.matsukiyo.co.jp/store/online', note: 'ä¾é‡‘é¡æŠ˜æ‰£'},
        {name: 'ä¸‰äº• Outlet', discount: 'å„ªæƒ åˆ¸ + è´ˆå“', link: 'https://mitsui-shopping-park.com/mop/index.html', note: 'è‡³æœå‹™å°å‡ºç¤º QR Code æ›å–'}
    ],
    phrases: [{jp:'ã™ã¿ã¾ã›ã‚“',zh:'ä¸å¥½æ„æ€/è«‹å•'},{jp:'ã“ã‚Œãã ã•ã„',zh:'æˆ‘è¦é€™å€‹'},{jp:'ã„ãã‚‰ã§ã™ã‹',zh:'è«‹å•å¤šå°‘éŒ¢'},{jp:'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™',zh:'æˆ‘è¦çµå¸³'},{jp:'è¢‹ã„ã‚Šã¾ã›ã‚“',zh:'ä¸ç”¨è¢‹å­'},{jp:'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹',zh:'å»æ‰€åœ¨å“ªè£¡'},{jp:'å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã„ã„ã§ã™ã‹',zh:'å¯ä»¥æ‹ç…§å—'},{jp:'è‹±èªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ã‚Šã¾ã™ã‹',zh:'æœ‰è‹±æ–‡èœå–®å—'},{jp:'ãŠã™ã™ã‚ã¯ä½•ã§ã™ã‹',zh:'æœ‰æ¨è–¦çš„å—'},{jp:'æ°´ãã ã•ã„',zh:'è«‹çµ¦æˆ‘æ°´'}], 
    spots: { 
        food: foodSpots, 
        photo: photoSpots 
    },
    transportTickets: [
        {name:'æ±äº¬åœ°éµåˆ¸ (24/48/72h)', url:'https://www.tokyometro.jp/tcn/ticket/travel/index.html', icon:'fa-solid fa-subway', note:'ã€ä½¿ç”¨ç¯„åœã€‘\næ±äº¬ Metro 9æ¢ç·š + éƒ½ç‡Ÿåœ°éµ 4æ¢ç·š\n\nã€ä¸é©ç”¨ã€‘\nJR å±±æ‰‹ç·šã€ç§éµ (å¦‚ç™¾åˆæµ·é·—è™Ÿ)\n\nã€å•Ÿç”¨ã€‘\nç¬¬ä¸€æ¬¡é€²ç«™èµ·ç®—å°æ™‚ï¼Œå»ºè­°é€£çºŒä½¿ç”¨ã€‚'},
        {name:'Suica è¥¿ç“œå¡', url:'https://www.jreast.co.jp/tc/pass/suica.html', icon:'fa-solid fa-mobile-screen', note:'ã€æ‰‹æ©Ÿç‰ˆã€‘\niPhone éŒ¢åŒ…ç›´æ¥æ–°å¢ > äº¤é€šå¡ > Suica\n\nã€å„²å€¼ã€‘\nå¯ä½¿ç”¨ Apple Pay (Mastercard/JCB)\n\nã€å¯¦é«”å¡ã€‘\nç›®å‰ç¼ºè²¨ï¼Œå»ºè­°ä½¿ç”¨ Welcome Suica (æˆç”°æ©Ÿå ´è²·)'},
        {name:'JR æ±äº¬å»£åŸŸå‘¨éŠåˆ¸', url:'https://www.jreast.co.jp/multi/zh-CHT/pass/tokyowide.html', icon:'fa-solid fa-ticket', note:'ã€å”®åƒ¹ã€‘\n15,000 æ—¥åœ“ (3å¤©)\n\nã€å¿…ç”¨è¡Œç¨‹ã€‘\n1. æ±äº¬ <-> æ²³å£æ¹– (å¯Œå£«å›éŠ)\n2. æ±äº¬ <-> è¼•äº•æ¾¤/æ—¥å…‰\n3. æˆç”°æ©Ÿå ´ (N\'EX)\n\n* éœ€é€£çºŒ3å¤©ä½¿ç”¨ï¼Œè«‹è¨ˆç®—ç¸½è»Šè³‡æ˜¯å¦åˆ’ç®—ã€‚'},
        {name:'å¯Œå£«å›éŠè™Ÿ (JR)', url:'https://www.eki-net.com/zh-CHT/jreast-train-reservation/Top/Index', icon:'fa-solid fa-train', note:'ã€é‡è¦ã€‘\nå…¨è»ŠæŒ‡å®šå¸­ï¼Œç„¡ç«™ç¥¨ï¼\nè«‹å‹™å¿…æå‰ 30 å¤©ç”± Eki-net é ç´„ã€‚\n\næŒæœ‰å»£åŸŸå‘¨éŠåˆ¸è€…ï¼Œä»éœ€å»æ©Ÿå°åŠƒä½ (å…è²»)ã€‚'}
    ],
    rentalCars: [
        {company: 'Toyota Rent a Car', pickup: 'æ²³å£æ¹–ç«™å‰åº—', url: 'https://rent.toyota.co.jp/zh-tw/', note: 'éœ€æº–å‚™å°ç£é§•ç…§ + æ—¥æ–‡è­¯æœ¬', status: 'todo', reservationNumber:'', insurance:''},
        {company: 'Tabirai æ¯”åƒ¹ç¶²', pickup: 'ä¾ç…§æ–¹æ¡ˆ', url: 'https://tc.tabirai.net/car/', note: 'å¤šé–“ç§Ÿè»Šå…¬å¸æ¯”åƒ¹', status: 'todo', reservationNumber:'', insurance:''}
    ],
    hotels: [
        {name:'éŒ¦ç³¸ç”ºæ°‘å®¿', img:'bnb.jpg', link:'éŒ¦ç³¸ç”º æ°‘å®¿'},
        {name:'Megu Fuji', img:'megu.jpg', link:'Megu Fuji 2026'},
        {name:'DOMO æ°‘å®¿', img:'domo.jpg', link:'DOMO æ°‘å®¿ æ±æ–°å®¿'}
    ],
    suggestedTickets: [
        {name: 'SHIBUYA SKY', url: 'https://www.shibuya-scramble-square.com/sky/ticket/', custom: false}
    ]
};
// --- æ‡‰ç”¨ç¨‹å¼é‚è¼¯å€ (V72.3 æœ€çµ‚ä¿®æ­£ï¼šè³‡æ–™é˜²è­· + åœ°åœ–ä¿®å¾©) ---
createApp({
    setup() {
        // ç‹€æ…‹è®Šæ•¸
        const currentView = ref('welcome');
        const isWelcomeClosed = ref(false); 
        const currentUser = ref(null);
        const isGuest = ref(false); 
        const showPersonaModal = ref(false);
        const showUserEditModal = ref(false);
        const editingUser = ref({});
        const showLoginModal = ref(false);
        const loginForm = ref({email:'',password:''});
        const isLoggedIn = ref(false);
        const syncStatus = ref('idle'); 
        
        // â˜…â˜…â˜… V72.3 é—œéµä¿®æ­£ï¼šåˆå§‹å€¼æ”¹å›è®€å– defaultDataï¼Œé˜²æ­¢è®Šç©ºç™½ â˜…â˜…â˜…
        const users = ref(JSON.parse(JSON.stringify(defaultUsers)));
        // é€™è£¡ä¸€å®šè¦è®€å– defaultDataï¼Œé€™æ¨£å°±ç®—é›²ç«¯é‚„æ²’è¼‰å…¥ï¼Œç•«é¢ä¹Ÿä¸æœƒæ˜¯ç™½çš„
        const itinerary = ref(JSON.parse(JSON.stringify(defaultData.itinerary)));
        const drivePlan = ref(JSON.parse(JSON.stringify(defaultData.drivePlan)));
        
        const expenses = ref([]);
        const spots = ref(JSON.parse(JSON.stringify(defaultData.spots)));
        const shopping = ref(JSON.parse(JSON.stringify(defaultData.shopping)));
        const japanesePhrases = ref(JSON.parse(JSON.stringify(defaultData.phrases)));
        const suggestedTickets = ref(JSON.parse(JSON.stringify(defaultData.suggestedTickets))); 
        const transportTickets = ref(JSON.parse(JSON.stringify(defaultData.transportTickets)));
        const rentalCars = ref(JSON.parse(JSON.stringify(defaultData.rentalCars)));
        const hotels = ref(JSON.parse(JSON.stringify(defaultData.hotels)));
        const coupons = ref(JSON.parse(JSON.stringify(defaultData.coupons)));
        const activeUsers = ref({}); 
        
        // UI è®Šæ•¸
        const previewImg = ref(null);
        const openLightbox = (img) => { if(img) previewImg.value = getImg(img); };
        const closeLightbox = () => { previewImg.value = null; };
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        const exchangeRate = ref(0.215);
        const moneyTab = ref('record');
        const hotelTab = ref('stay');
        const shopCat = ref('cosme');
        const currentLoc = ref('Tokyo');
        const showKonbiniModal = ref(false);
        const emergencyTab = ref('sos'); 
        const weatherLoading = ref(false);
        const weatherData = ref([
            {name:'Tokyo', displayName:'æ±äº¬', temp:'--', bg:'bg-blue-400', icon:'fa-solid fa-cloud-sun'},
            {name:'Kamakura', displayName:'éŒå€‰', temp:'--', bg:'bg-indigo-400', icon:'fa-solid fa-water'},
            {name:'Fuji', displayName:'å¯Œå£«å±±', temp:'--', bg:'bg-purple-400', icon:'fa-solid fa-mountain'}
        ]);
        const showCouponModal = ref(false);
        const showExpenseModal = ref(false);
        const modalData = ref({});
        const expenseMode = ref('private'); 
        const expandedPhrase = ref(null);
        const showModal = ref(false);
        const modalTitle = ref('');
        const modalFields = ref([]);
        const modalHasImg = ref(false);
        const modalCallback = ref(null);
        const isEditingItem = ref(false); 
        const modalDeleteCallback = ref(null);
        const showFlightModal = ref(false);
        const tempFlightData = ref({code:'',seat:''});
        const flightMode = ref('out');
        const showRentalModal = ref(false);
        const activeRental = ref({});

        const apps = [{id:1,name:'è¡Œç¨‹',icon:'fa-solid fa-map',view:'itinerary',bgClass:'bg-pink-400'},{id:2,name:'å°è²¡åº«',icon:'fa-solid fa-yen-sign',view:'money',bgClass:'bg-yellow-400'},{id:3,name:'ä½å®¿äº¤é€š',icon:'fa-solid fa-hotel',view:'hotel',bgClass:'bg-indigo-400'},{id:4,name:'è¡Œå‰æº–å‚™',icon:'fa-solid fa-suitcase',view:'prep',bgClass:'bg-blue-400'},{id:5,name:'åƒåƒå–å–',icon:'fa-solid fa-utensils',view:'food',bgClass:'bg-orange-400'},{id:6,name:'ç¶²ç¾æ‰“å¡',icon:'fa-solid fa-camera',view:'photo',bgClass:'bg-rose-400'},{id:7,name:'å¿«æ¨‚è³¼',icon:'fa-solid fa-bag-shopping',view:'shopping',bgClass:'bg-purple-400'},{id:8,name:'å¤©æ°£',icon:'fa-solid fa-cloud-sun',view:'weather',bgClass:'bg-sky-400'},{id:9,name:'æ€¥é›£æ•‘åŠ©',icon:'fa-solid fa-truck-medical',view:'emergency',bgClass:'bg-red-500'}];
        const tripDays = [{week:'D1',title:'3/27'},{week:'D2',title:'3/28'},{week:'D3',title:'3/29'},{week:'D4',title:'3/30'},{week:'D5',title:'3/31'},{week:'D6',title:'4/01'},{week:'D7',title:'4/02'},{week:'D8',title:'4/03'}];
        const daysUntilTrip = ref(Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24)));
        const smartReminders = computed(() => { const l=[]; const diffDays = daysUntilTrip.value; const text = JSON.stringify(itinerary.value); if(text.includes('å¯Œå£«å›éŠ')) { if(diffDays <= 33 && diffDays > 30) l.push("å¯Œå£«å›éŠè™Ÿï¼šæº–å‚™æ¶ç¥¨ (30å¤©å‰)ï¼"); if(diffDays <= 30) l.push("ğŸ”´ å¯Œå£«å›éŠè™Ÿï¼šç¾åœ¨å¯ä»¥æ¶ç¥¨äº†ï¼"); } if(diffDays <= 2) l.push("ç·šä¸Šé è¾¦ç™»æ©Ÿ (48hrå‰)"); if(diffDays <= 0 && diffDays > -8) l.push("æ—…é€”æ„‰å¿«ï¼ğŸŒ¸"); return l; });

        const statusText = computed(() => { if (!isLoggedIn.value) return 'Offline'; if (syncStatus.value === 'syncing') return 'Syncing...'; if (syncStatus.value === 'error') return 'Error: æ¬Šé™ä¸è¶³'; return 'Online'; });
        const statusColor = computed(() => { if (!isLoggedIn.value) return 'bg-gray-400'; if (syncStatus.value === 'syncing') return 'bg-yellow-400 animate-pulse'; if (syncStatus.value === 'error') return 'bg-red-500'; return 'bg-green-400'; });

        const compressImage = (base64) => { return new Promise((resolve) => { const img = new Image(); img.src = base64; img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height; const MAX = 600; if(w>MAX){ h*=MAX/w; w=MAX; } canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h); resolve(canvas.toDataURL('image/jpeg', 0.6)); }; }); };

        const getCurrentItinerary = () => (itineraryMode.value === 'drive' && [2,3,4].includes(selectedDayIndex.value)) ? (drivePlan.value[selectedDayIndex.value-2] || []) : (itinerary.value[selectedDayIndex.value] || []);
        const getIconByCategory = (cat) => ({'Flight':'fa-solid fa-plane','Sightseeing':'fa-solid fa-camera','Food':'fa-solid fa-utensils','Shopping':'fa-solid fa-bag-shopping','Transport':'fa-solid fa-train-subway','Hotel':'fa-solid fa-bed'}[cat]||'fa-solid fa-location-dot');
        
        // â˜…â˜…â˜… V72.3 åœ°åœ–é€£çµä¿®å¾© (ä½¿ç”¨æ­£ç¢ºçš„ googleusercontent æ ¼å¼) â˜…â˜…â˜…
        const getMapLink = (k,n) => { 
            const q = k || n; 
            if(!q) return ''; 
            if(q.startsWith('http')) return q; 
            return 'http://googleusercontent.com/maps.google.com/?q=' + encodeURIComponent(q); 
        };
        const getDirLink = (dest) => { 
            const list = getCurrentItinerary(); 
            let origin = list.length > 0 ? list[list.length-1].mapKeyword || list[list.length-1].name : ""; 
            return 'http://googleusercontent.com/maps.google.com/?saddr=' + encodeURIComponent(origin) + '&daddr=' + encodeURIComponent(dest) + '&travelmode=transit'; 
        };
        const getSearchLink = (n) => 'https://www.google.com/search?q=' + encodeURIComponent(n);
        
        const handleImgError = (e) => e.target.src='https://placehold.co/400x300/pink/white?text=IMAGE';
        const getPageTitle = (view) => ({'itinerary':'è¡Œç¨‹è¡¨','money':'å°è²¡åº«','hotel':'ä½å®¿äº¤é€š','prep':'è¡Œå‰æº–å‚™','food':'ç¾é£Ÿåœ°åœ–','photo':'æ‰“å¡æ™¯é»','shopping':'è³¼ç‰©æ¸…å–®','weather':'å¤©æ°£é å ±','emergency':'æ€¥é›£æ•‘åŠ©'}[view]||'é—œæ±ä¹‹æ—…');
        const isUserOnline = (id) => { const last = activeUsers.value[id]; return last && (Date.now() - last) < 65000; };
        const getUserName = (id) => users.value.find(u=>u.id===id)?.name||'æœªçŸ¥';
        const getUserAvatar = (id) => users.value.find(u=>u.id===id)?.avatar || 'https://placehold.co/100x100/pink/white?text=' + getUserName(id).charAt(0);
        const getClothingAdvice = (t) => t==='--'?'--': t<10?'ç¾½çµ¨+åœå·¾':t<15?'å¤§è¡£+ç™¼ç†±è¡£':'æ´‹è”¥å¼ç©¿æ­';
        const getPaymentIcon = (m) => ({'cash':'ğŸ’µ','card':'ğŸ’³','suica':'ğŸ§','other':'ğŸ”–'}[m]||'ğŸ’µ');
        const flightStatusLink = (code) => code ? `https://www.flightradar24.com/data/flights/${code.toLowerCase()}` : '';
        const getAirlineInfo = (flightCode, isShort) => { if(!flightCode) return null; const c = flightCode.toUpperCase(); if(c.startsWith('TR')) return isShort?"é…·èˆª Scoot":"ã€é…·èˆª Scootã€‘\nğŸ“ å ±åˆ°ï¼šæ¡ƒåœ’ T1 / æˆç”° T1 å—ç¿¼\nğŸ§³ æ‰‹æï¼š10kg (åš´æ ¼ç§¤é‡)"; if(c.startsWith('BR')) return isShort?"é•·æ¦® EVA":"ã€é•·æ¦® EVAã€‘\nğŸ“ å ±åˆ°ï¼šæ¡ƒåœ’ T2 / æˆç”° T1 å—ç¿¼\nğŸ§³ è¨—é‹ï¼šè¨ˆä»¶åˆ¶ 23kg x 2 ä»¶"; return 'è«‹ç¢ºèªé›»å­æ©Ÿç¥¨ä¸Šçš„èˆªå»ˆè³‡è¨Š'; };
        const getAmountInTWD = (e) => e.currency==='JPY' ? e.amount*exchangeRate.value : e.amount;
        const myPrivateExpenses = computed(() => currentUser.value ? expenses.value.filter(e => e.whoPaid===currentUser.value.id && e.forWhom.length===1 && e.forWhom[0]===currentUser.value.id) : []);
        const myPrivateTotalTWD = computed(() => myPrivateExpenses.value.reduce((sum, e) => sum + getAmountInTWD(e), 0));
        const groupExpenses = computed(() => expenses.value.filter(e => e.forWhom.length > 1 || (e.forWhom.length===1 && e.forWhom[0]!==e.whoPaid)));
        
        const settlements = computed(() => {
            const b = {}; 
            users.value.forEach(u => b[u.id] = 0);
            groupExpenses.value.forEach(e => {
                if (b[e.whoPaid] === undefined) return; 
                const amountTWD = e.currency === 'JPY' ? (e.amount * exchangeRate.value) : parseFloat(e.amount);
                const validTargets = e.forWhom.filter(uid => b[uid] !== undefined);
                if (validTargets.length === 0) return;
                b[e.whoPaid] += amountTWD;
                const splitAmount = amountTWD / validTargets.length;
                validTargets.forEach(uid => { b[uid] -= splitAmount; });
            });
            const r = [];
            const debtors = []; const creditors = [];
            for (const uid in b) {
                const val = b[uid];
                if (val < -1) debtors.push({ id: parseInt(uid), v: val });
                if (val > 1) creditors.push({ id: parseInt(uid), v: val });
            }
            debtors.sort((a, b) => a.v - b.v);
            creditors.sort((a, b) => b.v - a.v);
            let i = 0; let j = 0;
            while (i < debtors.length && j < creditors.length) {
                const debtor = debtors[i];
                const creditor = creditors[j];
                let amount = Math.min(Math.abs(debtor.v), creditor.v);
                r.push({ from: parseInt(debtor.id), to: parseInt(creditor.id), amount: Math.round(amount) });
                debtor.v += amount; creditor.v -= amount;
                if (Math.abs(debtor.v) < 1) i++;
                if (Math.abs(creditor.v) < 1) j++;
            }
            return r;
        });

        const getMapCover = (loc) => { const map = { 'Tokyo': 'tokyo_map.jpg', 'Kamakura': 'kamakura_map.jpg', 'Fuji': 'fuji_map.jpg' }; if(!map[loc]) return 'https://placehold.co/600x200/orange/white?text=Food+Map'; return getImg(map[loc]); };
        const getRaidClass = (item) => { if(item.reserve) return 'raid-red'; if(item.desc.includes('æ’éšŠ')) return 'raid-yellow'; return 'raid-green'; };
        const getRaidLabel = (item) => { if(item.reserve) return 'ç‰¹ç´šå’’ç‰© (éœ€é ç´„)'; if(item.desc.includes('æ’éšŠ')) return 'è¨ä¼éšŠç´š (æ’éšŠ)'; return 'é›œè‰ç´š (è¼•é¬†åƒ)'; };
        const getRaidIcon = (item) => { if(item.reserve) return 'fa-solid fa-dragon'; if(item.desc.includes('æ’éšŠ')) return 'fa-solid fa-people-group'; return 'fa-solid fa-seedling'; };
        const toggleFoodVote = (item) => { if(!currentUser.value) return; if(!item.votes) item.votes = []; const idx = item.votes.indexOf(currentUser.value.id); if(idx > -1) item.votes.splice(idx, 1); else item.votes.push(currentUser.value.id); saveData(); };
        const getGreeting = () => { if(!currentUser.value) return 'æ—…ç¨‹ä¸­å¿ƒ'; const n = currentUser.value.name; if(n.includes('å‰ä¼Š') || n.includes('éˆ')) return 'å“‡...å“‡æ¯å“‡æ¯...'; if(n.includes('å°å…«') || n.includes('ä¸')) return 'ä»Šå¤©ä¹Ÿè¦åŠªåŠ›å–”ï¼(å¾®ç¬‘)'; if(n.includes('å…”å…”') || n.includes('é´¨')) return 'Hula!!! (æ€ªå«)'; return `æ­¡è¿å›ä¾†ï¼Œ${n}ï¼`; };
        const getBudgetMood = () => { const budget = 30000; const spent = myPrivateTotalTWD.value; const p = spent / budget; if(p > 1) return 'ğŸ—¿'; if(p > 0.8) return 'ğŸ˜°'; return 'ğŸ˜Š'; };
        const getPackingProgress = (u) => { if(!u || !u.list || u.list.length === 0) return 0; const done = u.list.filter(i => i.checked).length; return Math.round((done / u.list.length) * 100); };
        const getStamina = (dayIdx) => { const staminaMap = [100, 80, 50, 40, 60, 90, 70, 100]; return staminaMap[dayIdx] || 100; };
        const getStaminaColor = (i) => { const s = getStamina(i); if(s < 50) return 'hp-low'; if(s < 80) return 'hp-med'; return 'hp-high'; };
        const quickExpense = (item) => { if(!currentUser.value) { alert('è«‹å…ˆç™»å…¥'); return; } currentView.value = 'money'; moneyTab.value = 'record'; openExpenseModal('private'); modalData.value.name = item.name; modalData.value.amount = ''; };
        const moveItineraryItem = (direction, idx) => { if (isGuest.value) return; const list = (itineraryMode.value === 'drive' && [2,3,4].includes(selectedDayIndex.value)) ? drivePlan.value[selectedDayIndex.value-2] : itinerary.value[selectedDayIndex.value]; if (!list) return; const newIdx = idx + direction; if (newIdx < 0 || newIdx >= list.length) return; [list[idx], list[newIdx]] = [list[newIdx], list[idx]]; saveData(); };
        
        const repairSpotData = (remoteSpots) => { 
            if (!remoteSpots) return JSON.parse(JSON.stringify(defaultData.spots));
            const localSpots = defaultData.spots;
            for (const type in localSpots) { 
                if(!remoteSpots[type]) remoteSpots[type] = {};
                for (const loc in localSpots[type]) { 
                    if(!remoteSpots[type][loc]) remoteSpots[type][loc] = [];
                }
            }
            return remoteSpots; 
        };
        
        const deepSanitize = (obj) => { if (obj === undefined) return null; if (obj === null || typeof obj !== 'object') return obj; if (Array.isArray(obj)) return obj.map(deepSanitize); const newObj = {}; for (const key in obj) { newObj[key] = deepSanitize(obj[key]); } return newObj; };

        let saveTimeout = null;
        const saveData = async () => { 
            if(isGuest.value) return; 
            
            // â˜…â˜…â˜… V72.3 çµ•å°é˜²è­·é–ï¼šå¦‚æœè¡Œç¨‹è¡¨æ˜¯ç©ºçš„ï¼Œç¦æ­¢å­˜æª”ï¼ â˜…â˜…â˜…
            // é€™èƒ½é˜²æ­¢å› ç‚ºé›²ç«¯è®€å–å¤±æ•—ï¼Œè€ŒæŠŠç©ºç™½è³‡æ–™è¦†è“‹å›å»
            if (!itinerary.value || itinerary.value.length === 0) {
                console.warn("Safety Lock: Itinerary is empty, save aborted.");
                return;
            }

            syncStatus.value = 'syncing'; 
            clearTimeout(saveTimeout); 
            saveTimeout = setTimeout(async () => { 
                const rawData = { users: users.value, itinerary_json: JSON.stringify(itinerary.value), drivePlan_json: JSON.stringify(drivePlan.value), expenses: expenses.value, spots: spots.value, shopping: shopping.value, phrases: japanesePhrases.value, tickets: suggestedTickets.value, transportTickets: transportTickets.value, rentalCars: rentalCars.value, hotels: hotels.value, coupons: coupons.value }; 
                const safeData = deepSanitize(rawData); 
                try { 
                    if(db && isLoggedIn.value) { 
                        await setDoc(doc(db,"trips","kanto2026"), safeData, {merge:true}); 
                        setTimeout(() => syncStatus.value = 'idle', 500); 
                    } else { 
                        syncStatus.value = 'error'; 
                    } 
                } catch(e) { 
                    console.error("Firebase Write Error:", e); 
                    syncStatus.value = 'error'; 
                } 
            }, 800); 
        };
        
        const forceRestoreDefaults = async () => { if(confirm('è­¦å‘Šï¼šé€™å°‡æœƒå¼·åˆ¶è¦†è“‹é›²ç«¯ä¸Šçš„æ‰€æœ‰è³‡æ–™(å«è¡Œç¨‹èˆ‡è¨˜å¸³)ã€‚ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ')) { const rawData = { users: JSON.parse(JSON.stringify(defaultUsers)), itinerary_json: JSON.stringify(defaultData.itinerary), drivePlan_json: JSON.stringify(defaultData.drivePlan), spots: defaultData.spots, shopping: defaultData.shopping, phrases: defaultData.phrases, transportTickets: defaultData.transportTickets, rentalCars: defaultData.rentalCars, hotels: defaultData.hotels, coupons: defaultData.coupons, tickets: defaultData.suggestedTickets }; const safeData = deepSanitize(rawData); try { await setDoc(doc(db,"trips","kanto2026"), safeData, {merge:true}); alert('é‚„åŸæˆåŠŸï¼'); location.reload(); } catch(e) { alert('é‚„åŸå¤±æ•—ï¼š' + e.message); } } };
        
        const updateHeartbeat = async () => { if(!isLoggedIn.value || !currentUser.value || isGuest.value) return; try { await updateDoc(doc(db,"trips","kanto2026"), { [`heartbeats.${currentUser.value.id}`]: serverTimestamp() }); } catch(e) { console.log("Heartbeat skip"); } };
        const fetchRealWeather = async () => { weatherLoading.value = true; try { const locs = [ {lat: 35.6895, lon: 139.6917, key:'Tokyo'}, {lat: 35.3192, lon: 139.5467, key:'Kamakura'}, {lat: 35.4988, lon: 138.7616, key:'Fuji'} ]; for(let l of locs) { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${l.lat}&longitude=${l.lon}&current_weather=true`); const d = await res.json(); const target = weatherData.value.find(w => w.name === l.key); if(target && d.current_weather) { target.temp = Math.round(d.current_weather.temperature); } } } catch(e) { console.error("Weather Error", e); } weatherLoading.value = false; };
        const fetchExchangeRate = async () => { try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); const data = await res.json(); if (data && data.rates && data.rates.TWD) { exchangeRate.value = data.rates.TWD; } } catch (e) { console.error("Rate Fetch Error", e); } };
        const showDiagnostic = () => { const isReset = confirm(`ã€V72.3 ç³»çµ±è¨ºæ–·ã€‘\n\né€£ç·šç‹€æ…‹ï¼š${isLoggedIn.value?'ğŸŸ¢ å·²é€£ç·š':'ğŸ”´ æœªé€£ç·š'}\nåŒæ­¥ç‹€æ…‹ï¼š${syncStatus.value}\nç›®å‰èº«åˆ†ï¼š${currentUser.value?.name || 'æœªç™»å…¥'}\n\nã€é€²éšã€‘æ˜¯å¦è¦å¼·åˆ¶é‡ç½®è³‡æ–™åº«ï¼Ÿ(æ³¨æ„ï¼šæœƒæ¸…é™¤æ‰€æœ‰è³‡æ–™)`); if(isReset) forceRestoreDefaults(); };

        const setCurrentUser = (u) => { if(isGuest.value) return; currentUser.value = u; localStorage.setItem('V71_LAST_USER_ID', u.id); updateHeartbeat(); showPersonaModal.value = false; currentView.value = 'menu'; };
        const addPrepItem = (u) => { if(!u.list) u.list = []; u.list.push({text:'æ–°é …ç›®',checked:false}); saveData(); };
        const enterSite = () => { isGuest.value=false; isWelcomeClosed.value=true; showPersonaModal.value=true; };
        const enterAsGuest = () => { isGuest.value=true; currentUser.value={id:999,name:'è¨ªå®¢',list:[]}; isWelcomeClosed.value=true; currentView.value='menu'; };
        const handleAuthClick = () => isLoggedIn.value ? (confirm('ç™»å‡º?')&&signOut(auth)) : showLoginModal.value=true;
        const doLogin = async () => { try{await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth,loginForm.value.email,loginForm.value.password);showLoginModal.value=false;}catch(e){alert('ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼');} };
        const openUserEditor = (u) => { editingUser.value={...u}; showUserEditModal.value=true; };
        const saveUserChanges = () => { if(isGuest.value) return; const idx=users.value.findIndex(u=>u.id===editingUser.value.id); if(idx!==-1){ users.value[idx]={...editingUser.value}; if(currentUser.value && currentUser.value.id === editingUser.value.id) currentUser.value = users.value[idx]; } saveData(); showUserEditModal.value=false; };
        const processAvatarUpload = async (e) => { const f = e.target.files[0]; if(f) { const res = await new Promise(r=>{const fr=new FileReader();fr.onload=ev=>r(ev.target.result);fr.readAsDataURL(f);}); editingUser.value.avatar = await compressImage(res); } };

        const openEditItineraryModal = (item, idx) => { if(isGuest.value) return; modalTitle.value = 'ç·¨è¼¯è¡Œç¨‹'; modalFields.value = [{key:'hours',label:'æ™‚é–“'},{key:'name',label:'åç¨±'},{key:'note',label:'å‚™è¨»'},{key:'mapKeyword',label:'åœ°åœ–é—œéµå­—'},{key:'travelTime',label:'äº¤é€šæ™‚é–“'},{key:'parkingLink',label:'åœè»Šå ´åœ°åœ– (è‡ªé§•ç”¨)'}]; modalData.value = {...item}; modalHasImg.value=false; isEditingItem.value = true; const targetArray = (itineraryMode.value === 'drive' && [2,3,4].includes(selectedDayIndex.value)) ? drivePlan.value[selectedDayIndex.value-2] : itinerary.value[selectedDayIndex.value]; modalCallback.value = () => { targetArray[idx] = modalData.value; targetArray.sort((a,b) => a.hours.localeCompare(b.hours)); saveData(); }; modalDeleteCallback.value = () => { targetArray.splice(idx, 1); saveData(); }; showModal.value = true; };
        const openAddItineraryModal = () => { modalTitle.value = 'æ–°å¢è¡Œç¨‹'; modalFields.value = [{key:'hours',label:'æ™‚é–“'},{key:'name',label:'åç¨±'},{key:'note',label:'å‚™è¨»'},{key:'mapKeyword',label:'åœ°åœ–é—œéµå­—'},{key:'travelTime',label:'äº¤é€šæ™‚é–“'},{key:'parkingLink',label:'åœè»Šå ´åœ°åœ– (è‡ªé§•ç”¨)'}]; modalData.value = {hours:'',name:'',note:'',category:'Sightseeing'}; modalHasImg.value=false; isEditingItem.value = false; modalCallback.value = () => { const arr = (itineraryMode.value === 'drive' && [2,3,4].includes(selectedDayIndex.value)) ? drivePlan.value[selectedDayIndex.value-2] : itinerary.value[selectedDayIndex.value]; arr.push(modalData.value); arr.sort((a,b) => a.hours.localeCompare(b.hours)); saveData(); }; showModal.value = true; };
        
        const openEditModal = (type, item, idx) => { if(isGuest.value) return; modalTitle.value = 'ç·¨è¼¯'; modalData.value = {...item}; modalHasImg.value=true; isEditingItem.value = true; if(type === 'shopping') { modalFields.value=[{key:'name',label:'åç¨±'},{key:'link',label:'é€£çµ'}]; modalCallback.value = () => { shopping.value[shopCat.value][idx] = modalData.value; saveData(); }; modalDeleteCallback.value = () => { shopping.value[shopCat.value].splice(idx, 1); saveData(); }; } else if (type === 'spot') { modalFields.value=[{key:'name',label:'åç¨±'},{key:'desc',label:'æè¿°'},{key:'bestTime',label:'ğŸ“¸ æœ€ä½³æ©Ÿä½'}, {key:'queueTip',label:'â³ æ’éšŠæ”»ç•¥'}, {key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalCallback.value = () => { spots.value.photo[currentLoc.value][idx] = modalData.value; saveData(); }; modalDeleteCallback.value = () => { spots.value.photo[currentLoc.value].splice(idx, 1); saveData(); }; } else if (type === 'food') { modalFields.value=[{key:'name',label:'é¤å»³åç¨±'},{key:'desc',label:'æè¿°'},{key:'reserve',label:'éœ€è¨‚ä½?',type:'checkbox'},{key:'reserveLink',label:'é ç´„é€£çµ'},{key:'note',label:'ç­†è¨˜',type:'textarea'},{key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalCallback.value = () => { spots.value.food[currentLoc.value][idx] = modalData.value; saveData(); }; modalDeleteCallback.value = () => { spots.value.food[currentLoc.value].splice(idx, 1); saveData(); }; } else if (type === 'coupon') { modalTitle.value = 'ç·¨è¼¯å„ªæƒ åˆ¸'; modalHasImg.value=false; modalFields.value=[{key:'name',label:'åº—å®¶åç¨±'},{key:'discount',label:'æŠ˜æ‰£å…§å®¹'},{key:'link',label:'é€£çµ'},{key:'note',label:'å‚™è¨»'}]; modalCallback.value = () => { coupons.value[idx] = modalData.value; saveData(); }; modalDeleteCallback.value = () => { coupons.value.splice(idx, 1); saveData(); }; } showModal.value=true; };
        const openAddShopModal = () => { modalTitle.value='æ–°å¢å•†å“'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'link',label:'é€£çµ'}]; modalData.value={name:'',link:'',img:''}; modalHasImg.value=true; isEditingItem.value=false; modalCallback.value = () => { shopping.value[shopCat.value].push(modalData.value); saveData(); }; showModal.value=true; };
        const openAddSpotModal = () => { modalTitle.value='æ–°å¢æ™¯é»'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'desc',label:'æè¿°'},{key:'bestTime',label:'ğŸ“¸ æœ€ä½³æ©Ÿä½'}, {key:'queueTip',label:'â³ æ’éšŠæ”»ç•¥'}, {key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalData.value={name:'',desc:'',bestTime:'',queueTip:'',link:'',img:''}; modalHasImg.value=true; isEditingItem.value=false; modalCallback.value=()=>{spots.value.photo[currentLoc.value].push(modalData.value); saveData();}; showModal.value=true; };
        const openAddFoodModal = () => { modalTitle.value='æ–°å¢ç¾é£Ÿ'; modalFields.value=[{key:'name',label:'é¤å»³åç¨±'},{key:'desc',label:'æè¿°'},{key:'reserve',label:'éœ€è¦è¨‚ä½?', type:'checkbox'},{key:'reserveLink',label:'é ç´„é€£çµ'},{key:'note',label:'ç­†è¨˜', type:'textarea'},{key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalData.value={name:'',desc:'',reserve:false,reserveLink:'',note:'',link:'',img:''}; modalHasImg.value=true; isEditingItem.value=false; modalCallback.value=()=>{ if(!modalData.value.note) autoFillFoodInfo(); spots.value.food[currentLoc.value].push(modalData.value); saveData(); }; showModal.value=true; };
        const openAddCouponModal = () => { modalTitle.value='æ–°å¢å„ªæƒ åˆ¸'; modalFields.value=[{key:'name',label:'åº—å®¶åç¨±'},{key:'discount',label:'æŠ˜æ‰£å…§å®¹'},{key:'link',label:'é€£çµ'},{key:'note',label:'å‚™è¨»'}]; modalData.value={name:'',discount:'',link:'',note:''}; modalHasImg.value=false; isEditingItem.value=false; modalCallback.value = () => { coupons.value.push(modalData.value); saveData(); }; showModal.value=true; };
        const openEditHotelModal = (h, idx) => { if(isGuest.value) return; modalTitle.value = 'ç·¨è¼¯ä½å®¿'; modalFields.value = [{key:'name',label:'åç¨±'},{key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalData.value = {...h}; modalHasImg.value = true; isEditingItem.value = false; modalCallback.value = () => { hotels.value[idx] = modalData.value; saveData(); }; showModal.value = true; };
        const openAddTicketModal = () => { modalTitle.value='æ–°å¢é–€ç¥¨'; modalFields.value=[{key:'name',label:'æ™¯é»åç¨±'},{key:'url',label:'è³¼ç¥¨é€£çµ'}]; modalData.value={name:'',url:'https://', custom:true}; modalHasImg.value=false; isEditingItem.value=false; modalCallback.value=()=>{suggestedTickets.value.push(modalData.value); saveData();}; showModal.value=true; };
        const openAddTransTicketModal = () => { modalTitle.value='æ–°å¢äº¤é€šç¥¨åˆ¸'; modalFields.value=[{key:'name',label:'ç¥¨åˆ¸åç¨±'},{key:'url',label:'è³‡è¨Šé€£çµ'},{key:'note',label:'æ³¨æ„äº‹é …', type:'textarea'}]; modalData.value={name:'',url:'https://', note:'', icon:'fa-solid fa-ticket', custom:true, type:''}; modalHasImg.value=false; isEditingItem.value=false; modalCallback.value=()=>{transportTickets.value.push(modalData.value); saveData();}; showModal.value=true; };
        const openAddCarModal = () => { modalTitle.value = 'æ–°å¢ç§Ÿè»Šé ç´„'; modalFields.value = [{key:'company',label:'ç§Ÿè»Šå…¬å¸'},{key:'pickup',label:'å–è»Šåœ°é»'},{key:'url',label:'é ç´„é€£çµ'},{key:'note',label:'å‚™è¨»'}]; modalData.value = {company:'', pickup:'', url:'', note:'', status:'todo', reservationNumber:'', insurance:''}; modalHasImg.value = false; isEditingItem.value = false; modalCallback.value = () => { rentalCars.value.push(modalData.value); saveData(); }; showModal.value = true; };
        const openAddPhraseModal = () => { modalTitle.value='æ–°å¢ç¿»è­¯'; modalFields.value=[{key:'zh',label:'ä¸­æ–‡'},{key:'jp',label:'æ—¥æ–‡'}]; modalData.value={zh:'',jp:''}; modalHasImg.value=false; isEditingItem.value=false; modalCallback.value=()=>{japanesePhrases.value.push(modalData.value); saveData();}; showModal.value=true; };
        const handleModalSave = () => { if(modalCallback.value) modalCallback.value(); showModal.value=false; };
        const handleModalDelete = () => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ') && modalDeleteCallback.value) { modalDeleteCallback.value(); showModal.value=false; } };
        const processModalImg = async (e) => { const f = e.target.files[0]; if(f) { const res = await new Promise(r=>{const fr=new FileReader();fr.onload=ev=>r(ev.target.result);fr.readAsDataURL(f);}); modalData.value.img = await compressImage(res); } };
        const openExpenseModal = (mode) => { expenseMode.value = mode; modalData.value={name:'', amount:'', currency:'JPY', method:'cash', whoPaid: currentUser.value.id, forWhom: mode==='private' ? [currentUser.value.id] : users.value.map(u=>u.id)}; showExpenseModal.value=true; };
        const toggleShare = (id) => { const i=modalData.value.forWhom.indexOf(id); i>-1?modalData.value.forWhom.splice(i,1):modalData.value.forWhom.push(id); };
        const saveExpense = () => { expenses.value.push({...modalData.value,id:Date.now(),date:new Date().toLocaleDateString()}); saveData(); showExpenseModal.value=false; };
        const deleteExpense = (id) => { if(isGuest.value) return; if(confirm('ç¢ºå®šåˆªé™¤?')){expenses.value=expenses.value.filter(e=>e.id!==id); saveData();} };
        const deleteCar = (idx) => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { rentalCars.value.splice(idx,1); saveData(); } };
        const openRentalDetail = (car, idx) => { activeRental.value = rentalCars.value[idx]; showRentalModal.value = true; };
        const updateRentalStatus = (status) => { activeRental.value.status = status; };
        const editFlight = (mode) => { if(isGuest.value) return; flightMode.value = mode; tempFlightData.value.code = mode==='out' ? (currentUser.value.flightOut||'') : (currentUser.value.flightIn||''); tempFlightData.value.seat = mode==='out' ? (currentUser.value.flightOutSeat||'') : (currentUser.value.flightInSeat||''); showFlightModal.value = true; };
        const saveFlight = () => { if(flightMode.value === 'out') { currentUser.value.flightOut = tempFlightData.value.code; currentUser.value.flightOutSeat = tempFlightData.value.seat; } else { currentUser.value.flightIn = tempFlightData.value.code; currentUser.value.flightInSeat = tempFlightData.value.seat; } const idx = users.value.findIndex(u=>u.id===currentUser.value.id); if(idx!==-1) users.value[idx] = currentUser.value; saveData(); showFlightModal.value = false; };
        const autoFillFoodInfo = () => { const name = modalData.value.name; if(!name) return; const n = name.toLowerCase(); if(n.includes('å™å™è‹‘')) { modalData.value.reserve=true; modalData.value.reserveLink='https://www.tablecheck.com/zh-TW/shops/jojoen-tokyoskytreetown-solamachi/reserve'; modalData.value.note='ã€éœ€è¨‚ä½ã€‘åˆé–“å¥—é¤CPå€¼æœ€é«˜ã€‚'; } else if(n.includes('harbs')) { modalData.value.reserve=false; modalData.value.note='ã€ç¾å ´æ’éšŠã€‘æ°´æœåƒå±¤å¿…é»ã€‚'; } };
        const applyTicketTemplate = () => { const t = modalData.value.type; if(t==='suica') { modalData.value.name='Suica è¥¿ç“œå¡'; modalData.value.icon='fa-solid fa-mobile-screen'; modalData.value.url='https://www.jreast.co.jp/tc/pass/suica.html'; } else if(t==='metro') { modalData.value.name='æ±äº¬åœ°éµåˆ¸ (72h)'; modalData.value.icon='fa-solid fa-subway'; modalData.value.url='https://www.tokyometro.jp/tcn/ticket/travel/index.html'; } else if(t==='jrpass') { modalData.value.name='JR æ±äº¬å»£åŸŸå‘¨éŠåˆ¸'; modalData.value.icon='fa-solid fa-ticket'; modalData.value.url='https://www.jreast.co.jp/multi/zh-CHT/pass/tokyowide.html'; } else if(t==='fuji') { modalData.value.name='å¯Œå£«å›éŠè™Ÿ (JR)'; modalData.value.icon='fa-solid fa-train'; modalData.value.url='https://www.eki-net.com/zh-CHT/jreast-train-reservation/Top/Index'; } };
        const speakJapanese = (text) => { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; window.speechSynthesis.speak(u); };
        const openGoogleTranslate = (text) => { window.open(`https://translate.google.com/?sl=zh-TW&tl=ja&text=${encodeURIComponent(text)}&op=translate`, '_blank'); };
        const handleCameraTranslate = () => { window.open('https://translate.google.com/?sl=auto&tl=zh-TW&op=images', '_blank'); };
        const expandCard = (p) => expandedPhrase.value=p;
        const mergeUsers = (local, remote) => { if(!remote || !Array.isArray(remote)) return local; remote.forEach(rUser => { const lUser = local.find(u => u.id === rUser.id); if(lUser) { lUser.name = rUser.name; lUser.avatar = rUser.avatar; if(rUser.list && rUser.list.length > 0) lUser.list = rUser.list; lUser.flightOut = rUser.flightOut; lUser.flightOutSeat = rUser.flightOutSeat; lUser.flightIn = rUser.flightIn; lUser.flightInSeat = rUser.flightInSeat; } }); return local; };
        const ensureEssentialData = () => { const hasSky = suggestedTickets.value.find(t => t.name === 'SHIBUYA SKY'); if(!hasSky) { suggestedTickets.value.push({name: 'SHIBUYA SKY', url: 'https://www.shibuya-scramble-square.com/sky/ticket/', custom: false}); } };

        onMounted(() => {
            fetchRealWeather();
            fetchExchangeRate();
            
            if(auth) onAuthStateChanged(auth, u=>{ 
                isLoggedIn.value=!!u; 
                if(u && db) {
                    onSnapshot(doc(db,"trips","kanto2026"), d=>{
                        if(d.exists()){
                            const dt = d.data();
                            if (dt.users) users.value = mergeUsers(users.value, dt.users);
                            if (dt.itinerary_json) itinerary.value = JSON.parse(dt.itinerary_json);
                            else if(dt.itinerary && dt.itinerary.length > 0) itinerary.value = dt.itinerary; 
                            if (dt.drivePlan_json) drivePlan.value = JSON.parse(dt.drivePlan_json);
                            else if(dt.drivePlan && dt.drivePlan.length > 0) drivePlan.value = dt.drivePlan; 
                            if (dt.expenses) expenses.value = dt.expenses;
                            
                            // â˜…â˜…â˜… V72.1 å…¨é¢ä¿®å¾©é‚è¼¯ (é—œéµå€å¡Š) â˜…â˜…â˜…
                            let needsFix = false;

                            // 1. ä¿®å¾© Shopping (è·Ÿä¸Šæ¬¡ä¸€æ¨£)
                            if (dt.shopping) {
                                const remoteShop = dt.shopping;
                                const localShop = defaultData.shopping;
                                for (const cat in localShop) {
                                    if (!remoteShop[cat]) { remoteShop[cat] = localShop[cat]; needsFix = true; continue; }
                                    localShop[cat].forEach(localItem => {
                                        const remoteItem = remoteShop[cat].find(r => r.name === localItem.name);
                                        if (remoteItem && !remoteItem.img && localItem.img) {
                                            remoteItem.img = localItem.img;
                                            needsFix = true;
                                        }
                                    });
                                }
                                shopping.value = remoteShop;
                            } else {
                                shopping.value = defaultData.shopping;
                            }

                            // 2. ä¿®å¾© Spots (æ™¯é»/ç¾é£Ÿ)
                            if (dt.spots) {
                                const remoteSpots = dt.spots;
                                const localSpots = defaultData.spots;
                                for (const type in localSpots) { // photo, food
                                    if (!remoteSpots[type]) { remoteSpots[type] = localSpots[type]; needsFix = true; continue; }
                                    for (const loc in localSpots[type]) { // Tokyo, Kamakura, Fuji
                                        if (!remoteSpots[type][loc]) { remoteSpots[type][loc] = localSpots[type][loc]; needsFix = true; continue; }
                                        localSpots[type][loc].forEach(localItem => {
                                            const remoteItem = remoteSpots[type][loc].find(r => r.name === localItem.name);
                                            // é—œéµæª¢æŸ¥ï¼šå¦‚æœé›²ç«¯è³‡æ–™æ²’åœ–ç‰‡ï¼Œä½†æœ¬åœ°ç¨‹å¼ç¢¼æœ‰ï¼Œå°±è£œä¸Šå»
                                            if (remoteItem && !remoteItem.img && localItem.img) {
                                                remoteItem.img = localItem.img;
                                                needsFix = true;
                                            }
                                        });
                                    }
                                }
                                spots.value = remoteSpots;
                            } else {
                                spots.value = defaultData.spots;
                            }

                            if (dt.coupons) coupons.value = dt.coupons;
                            if (dt.phrases) japanesePhrases.value = dt.phrases;
                            if (dt.tickets) suggestedTickets.value = dt.tickets;
                            if (dt.transportTickets) transportTickets.value = dt.transportTickets;
                            if (dt.rentalCars) rentalCars.value = dt.rentalCars;
                            if (dt.hotels) hotels.value = dt.hotels;
                            
                            if (dt.heartbeats) { const map = {}; for(let uid in dt.heartbeats) { if(dt.heartbeats[uid]) map[parseInt(uid)] = dt.heartbeats[uid].toDate().getTime(); } activeUsers.value = map; }
                            ensureEssentialData();

                            // å¦‚æœæœ‰ç™¼ç¾ç¼ºåœ–ç‰‡ï¼Œå°±è‡ªå‹•å­˜æª”ä¿®å¾©
                            if(needsFix && !isGuest.value) {
                                console.log("V72.1 Auto-healing images (Spots + Shopping)...");
                                saveData(); 
                            }
                        } else {
                             itinerary.value = JSON.parse(JSON.stringify(defaultData.itinerary));
                             drivePlan.value = JSON.parse(JSON.stringify(defaultData.drivePlan));
                             shopping.value = JSON.parse(JSON.stringify(defaultData.shopping));
                             spots.value = JSON.parse(JSON.stringify(defaultData.spots));
                        }
                    });
                }
            });
            
            setInterval(updateHeartbeat, 30000);
            
            const lastId = localStorage.getItem('V71_LAST_USER_ID');
            if(lastId) { const u = users.value.find(user => user.id === parseInt(lastId)); if(u) currentUser.value = u; }
        });

        return {
            users, currentView, isWelcomeClosed, enterSite, enterAsGuest, isGuest, apps, getPageTitle,
            daysUntilTrip, smartReminders, tripDays, selectedDayIndex, getCurrentItinerary,
            moneyTab, exchangeRate, myPrivateExpenses, myPrivateTotalTWD, groupExpenses, settlements, getUserName, openExpenseModal, showExpenseModal, modalData, toggleShare, saveExpense, deleteExpense, expenseMode, getPaymentIcon,
            hotelTab, shopCat, shopping, openAddShopModal, currentLoc, spots, openAddSpotModal, weatherData, getClothingAdvice, japanesePhrases, expandCard, expandedPhrase, openAddPhraseModal,
            showModal, modalTitle, modalFields, modalHasImg, handleModalSave, handleModalDelete, isEditingItem, processModalImg, getIconByCategory, getMapLink, getSearchLink, getImg, handleImgError, saveData,
            currentUser, showPersonaModal, setCurrentUser, openUserEditor, showUserEditModal, editingUser, saveUserChanges, processAvatarUpload,
            addPrepItem, openEditModal, showFlightModal, tempFlightData, editFlight, saveFlight, flightMode, speakJapanese,
            handleAuthClick, showLoginModal, loginForm, doLogin, isLoggedIn, itineraryMode, suggestedTickets, openAddTicketModal,
            syncStatus, statusText, statusColor, openAddItineraryModal, openEditItineraryModal, openGoogleTranslate,
            transportTickets, openAddTransTicketModal, getAirlineInfo, flightStatusLink, getDirLink, applyTicketTemplate,
            rentalCars, openAddCarModal, deleteCar, openAddFoodModal, autoFillFoodInfo,
            coupons, showCouponModal, handleCameraTranslate, hotels, openEditHotelModal, toggleCarStatus: updateRentalStatus, showRentalModal, activeRental, openRentalDetail, updateRentalStatus, isUserOnline, showDiagnostic, openAddCouponModal, fetchRealWeather, weatherLoading, openAddCouponModal,
            getMapCover, getRaidClass, getRaidLabel, getRaidIcon, toggleFoodVote, getUserAvatar,
            previewImg, openLightbox, closeLightbox, showKonbiniModal,
            getGreeting, getBudgetMood, getPackingProgress, getStamina, getStaminaColor, quickExpense,
            emergencyTab, moveItineraryItem, fetchExchangeRate
        };
    }
}).mount('#app');
</script>                                
 </body>
</html>
