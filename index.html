<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (Luxury Edition)</title>

<script>
    window.tailwind = {
        config: {
            theme: {
                extend: {
                    colors: {'chii-pink':'#FFD1DC','chii-deep-pink':'#FF9EAC','chii-blue':'#A2D2FF','chii-yellow':'#FFF5BA','chii-text':'#5D4037'},
                    fontFamily: {sans:['Zen Maru Gothic','sans-serif']},
                    animation: {'wiggle':'wiggle 3s ease-in-out infinite','float':'float 3s ease-in-out infinite','fade-in':'fadeIn 0.5s ease-out forwards','spin-slow':'spin 8s linear infinite','pulse-slow':'pulse 3s infinite'},
                    keyframes: {
                        wiggle: {'0%,100%':{transform:'rotate(-3deg)'},'50%':{transform:'rotate(3deg)'}},
                        float: {'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-5px)'}},
                        fadeIn: {from:{opacity:0,transform:'translateY(10px)'},to:{opacity:1,transform:'translateY(0)'}}
                    }
                }
            }
        }
    }
</script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>

<style>
    /* è±ªè¯ç‰ˆæ‰‹æ©Ÿé©é…ï¼šé–å®šæ»¾å‹•è¡Œç‚ºï¼Œé˜²æ­¢æ©¡çš®ç­‹æ•ˆæœ */
    html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        font-family: "Zen Maru Gothic", sans-serif;
        color: #5D4037;
        overflow: hidden; /* App-like feel */
        -webkit-tap-highlight-color: transparent;
        background-color: #FFF0F5;
        overscroll-behavior: none; /* ç¦æ­¢ä¸‹æ‹‰åˆ·æ–° */
    }

    /* ç¨ç«‹æ»¾å‹•å®¹å™¨ */
    #app-content {
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 120px; /* åº•éƒ¨å®‰å…¨è·é›¢ */
    }

    /* èƒŒæ™¯å±¤å„ªåŒ– */
    #fixed-bg {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1;
        background-color: #FFF0F5;
        background-image: radial-gradient(#FFD1DC 15%, transparent 16%), radial-gradient(#FFF5BA 15%, transparent 16%);
        background-size: 60px 60px;
        background-position: 0 0, 30px 30px;
    }

    input, textarea, select { font-size: 16px !important; font-family: inherit; } /* ç¦æ­¢ iOS è¼¸å…¥ç¸®æ”¾ */
    [v-cloak] { display: none !important; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    
    /* å¡ç‰‡ç»ç’ƒæ“¬æ…‹ */
    .card {
        background: rgba(255,255,255,0.92);
        border-radius: 24px;
        box-shadow: 0 8px 30px rgba(255,105,180,0.12);
        border: 1px solid rgba(255,255,255,0.8);
        margin-bottom: 16px;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
        transition: transform 0.2s;
    }
    .card:active { transform: scale(0.98); }
    
    /* æ‡¸æµ®æŒ‰éˆ•ï¼šé©é… Safe Area */
    .fab-home {
        position: fixed;
        bottom: calc(30px + env(safe-area-inset-bottom));
        left: 50%; transform: translateX(-50%);
        width: 68px; height: 68px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 28px; color: white;
        z-index: 900;
        border: 4px solid white;
        box-shadow: 0 10px 25px rgba(255,105,180,0.5);
        background: linear-gradient(135deg,#FF9EAC,#FFD1DC);
        cursor: pointer;
    }
    .fab-main {
        position: fixed;
        bottom: calc(110px + env(safe-area-inset-bottom));
        right: 20px;
        width: 60px; height: 60px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 24px; color: white;
        z-index: 40;
        border: 3px solid white;
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        background-color: #ff9eac;
    }

    .welcome-screen {
        position: fixed; inset: 0; z-index: 9999;
        background: #FFF0F5;
        transition: transform 0.8s cubic-bezier(0.7,0,0.3,1);
        cursor: pointer; height: 100%;
    }
    .welcome-screen.hidden-screen { transform: translateY(-100%); pointer-events: none; }
    
    .sakura {
        position: fixed; top: -20px; background: #FFB7B2;
        border-radius: 100% 0 100% 0; opacity: 0.6;
        animation: fall linear infinite; z-index: 0; pointer-events: none;
        width: 14px; height: 14px;
    }
    @keyframes fall { to { transform: translate(10vw, 105vh) rotate(360deg); } }
</style>
</head>
<body>

<div id="fixed-bg"></div>
<div id="sakura-container"></div>

<div id="app" v-cloak class="h-full flex flex-col">
    
    <div :class="['welcome-screen flex flex-col items-center justify-between', isWelcomeClosed ? 'hidden-screen' : '']">
        <div class="absolute inset-0 z-0" @click="enterSite"><img :src="getImg('welcome.jpg')" class="w-full h-full object-cover opacity-90" @error="handleImgError"></div>
        <div class="absolute top-6 right-6 z-50 pt-[env(safe-area-inset-top)]">
            <button @click.stop="handleAuthClick" :class="['flex items-center gap-2 px-4 py-2 rounded-full backdrop-blur-md border border-white/50 shadow-lg font-bold text-sm transition', isLoggedIn ? 'bg-green-500/80 text-white' : 'bg-white/40 text-gray-800']">
                <i :class="isLoggedIn ? 'fa-solid fa-cloud' : 'fa-solid fa-cloud-arrow-up'"></i> {{ isLoggedIn ? 'å·²é€£ç·š' : 'é›²ç«¯ç™»å…¥' }}
            </button>
        </div>
        <div class="relative z-10 mt-40 text-center px-6" @click="enterSite">
            <div class="inline-block bg-white/40 backdrop-blur-md px-6 py-2 rounded-full text-white text-xs font-black tracking-[0.2em] border border-white/50 mb-6 animate-float shadow-lg">TOKYO â€¢ FUJI â€¢ KAMAKURA</div>
            <h1 class="text-7xl font-black text-white drop-shadow-lg tracking-widest mb-2 font-sans" style="text-shadow: 0 4px 10px rgba(255,105,180,0.3);">é—œæ±ä¹‹æ—…</h1>
            <p class="text-3xl text-white/90 font-bold tracking-widest drop-shadow-md">2026.03.27</p>
        </div>
        <div class="relative z-10 mb-28 w-full px-10 pb-[env(safe-area-inset-bottom)]" @click="enterSite">
            <div class="w-full bg-white/90 text-pink-500 font-black py-5 rounded-full shadow-2xl backdrop-blur-xl text-xl flex items-center justify-center gap-3 border border-white animate-pulse-slow">
                <span class="animate-spin-slow">ğŸŒ¸</span> é»æ“Šé–‹å§‹æ—…ç¨‹
            </div>
        </div>
    </div>

    <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-[64px] bg-[#FFF0F5]/90 backdrop-blur-xl z-30 flex items-center justify-between px-4 border-b border-white/50 shadow-sm pt-[env(safe-area-inset-top)] box-content transition-all">
        <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow-md border border-white active:scale-90 transition"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="font-black text-gray-700 text-lg flex items-center gap-2"><i class="fa-solid fa-sakura text-pink-300"></i> {{getPageTitle(currentView)}}</h1>
        <div v-if="currentUser" class="w-10 h-10 rounded-full bg-white border border-pink-200 overflow-hidden shadow-sm flex items-center justify-center text-xl cursor-pointer" @click="showPersonaModal=true">
            <img v-if="currentUser.avatar" :src="currentUser.avatar" class="w-full h-full object-cover">
            <span v-else>{{currentUser.icon}}</span>
        </div>
        <div v-else class="w-10"></div>
    </div>
    <div v-if="currentView !== 'menu'" class="h-[64px] pt-[env(safe-area-inset-top)] box-content shrink-0"></div>

    <div id="app-content" class="flex-1">

        <div v-if="currentView==='menu'" class="p-6 pt-12 animate-fade-in pb-32">
            <h2 class="text-3xl font-black text-gray-700 mb-8 text-center pt-[env(safe-area-inset-top)]">æ—…ç¨‹ä¸­å¿ƒ</h2>
            <div class="mb-8 bg-white/70 backdrop-blur-xl border border-white rounded-[32px] p-6 shadow-xl relative overflow-hidden group">
                 <div class="flex items-start gap-4 relative z-10">
                     <div class="bg-gradient-to-br from-yellow-200 to-yellow-400 w-12 h-12 rounded-2xl flex items-center justify-center text-white text-xl shrink-0 shadow-lg"><i class="fa-solid fa-bell"></i></div>
                     <div class="flex-1">
                         <div class="font-black text-gray-800 text-lg mb-1">å€’æ•¸ {{daysUntilTrip}} å¤©</div>
                         <div class="text-xs text-gray-500 font-bold leading-relaxed space-y-1">
                            <div v-for="alert in smartReminders" class="text-pink-500 flex items-start gap-1 font-black"><i class="fa-solid fa-circle-exclamation mt-0.5"></i> {{alert}}</div>
                            <div v-if="smartReminders.length===0" class="text-gray-400">ç›®å‰ç„¡ç·Šæ€¥å¾…è¾¦äº‹é …ã€‚</div>
                         </div>
                     </div>
                 </div>
            </div>
            <div class="grid grid-cols-3 gap-x-4 gap-y-8 px-2">
                <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition duration-300 group" @click="currentView=app.view">
                    <div class="w-[76px] h-[76px] rounded-[30px] flex items-center justify-center text-3xl text-white shadow-lg border-[4px] border-white relative overflow-hidden" :class="app.bgClass"><i :class="app.icon"></i></div>
                    <span class="text-sm font-bold mt-3 text-gray-600 group-hover:text-pink-500 transition">{{app.name}}</span>
                </div>
            </div>
            <button @click="isWelcomeClosed=false" class="mt-12 mx-auto text-gray-400 text-sm font-bold border-b border-gray-300 pb-1 block">å›åˆ°æ­¡è¿é é¢</button>
        </div>

        <div v-if="currentView==='itinerary'" class="px-5 py-4 animate-fade-in">
            <div class="flex overflow-x-auto gap-3 mb-6 hide-scrollbar sticky top-0 bg-[#FFF0F5]/95 z-20 py-3 -mx-5 px-5 backdrop-blur-md">
                 <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-6 py-3 rounded-2xl text-sm font-black border-2 transition shrink-0 shadow-sm flex flex-col items-center min-w-[70px]',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400 shadow-lg scale-105':'bg-white text-gray-300 border-white']"><span>{{d.week}}</span><span class="text-[10px] mt-1 opacity-80">{{d.title}}</span></button>
            </div>
            <div v-if="[2,3].includes(selectedDayIndex)" class="flex justify-center mb-4">
                <div class="bg-white p-1 rounded-full border border-gray-200 shadow-sm flex">
                    <button @click="itineraryMode='normal'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='normal'?'bg-pink-400 text-white':'text-gray-400']">ä¸€èˆ¬</button>
                    <button @click="itineraryMode='drive'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='drive'?'bg-green-500 text-white':'text-gray-400']"><i class="fa-solid fa-car"></i> è‡ªé§•</button>
                </div>
            </div>
            <div class="space-y-4">
                <div v-for="(item,idx) in getCurrentItinerary()" :key="idx" class="card p-5 border-0 shadow-sm relative group">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-pink-300 to-pink-100"></div>
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center pt-1 min-w-[50px]">
                            <span class="text-xs font-black text-gray-400 mb-2">{{item.hours}}</span>
                            <div class="w-10 h-10 rounded-full bg-pink-50 text-pink-400 flex items-center justify-center text-lg border border-pink-100"><i :class="getIconByCategory(item.category)"></i></div>
                        </div>
                        <div class="flex-1 py-1">
                            <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                            <p class="text-sm text-gray-500 line-clamp-2 font-medium mb-2">{{item.note}}</p>
                            <a :href="getMapLink(item.mapKeyword, item.name)" target="_blank" class="inline-flex items-center gap-1 text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded-full font-bold border border-blue-100 hover:bg-blue-100 transition"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                        </div>
                    </div>
                </div>
                <div v-if="getCurrentItinerary().length === 0" class="text-center text-gray-400 py-10 font-bold">æœ¬æ—¥ç„¡ç‰¹å®šè¡Œç¨‹ï¼Œè‡ªç”±æ¢ç´¢ï¼</div>
            </div>
        </div>

        <div v-if="currentView==='money'" class="px-5 py-4 animate-fade-in">
             <div v-if="!currentUser" class="text-center py-20 text-gray-400 font-bold bg-white/50 rounded-3xl border border-dashed border-gray-300">
                 <i class="fa-solid fa-lock text-4xl mb-4 text-pink-300"></i><br>è«‹å…ˆé¸æ“‡èº«åˆ†<br>ä»¥å­˜å–éš±ç§å¸³æœ¬
             </div>
             <div v-else>
                 <div class="flex gap-2 mb-4 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm shadow-sm">
                     <button @click="moneyTab='record'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='record'?'bg-yellow-400 text-white shadow-md':'text-gray-400']"><i class="fa-solid fa-user-lock"></i> æˆ‘çš„ç§å¸³</button>
                     <button @click="moneyTab='split'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='split'?'bg-blue-400 text-white shadow-md':'text-gray-400']"><i class="fa-solid fa-users"></i> å…¬æ¬¾åˆ†å¸³</button>
                 </div>
                 <div class="flex justify-between items-center mb-4 px-2">
                     <div class="text-xs font-bold text-gray-500 bg-white px-3 py-1.5 rounded-full shadow-sm border border-pink-100">åŒ¯ç‡: 1 JPY â‰ˆ <input v-model="exchangeRate" class="w-14 text-center text-pink-500 font-black outline-none bg-transparent" type="number" step="0.001"> TWD</div>
                 </div>
                 
                 <div v-if="moneyTab==='record'">
                     <div class="card p-6 bg-gradient-to-br from-yellow-300 to-orange-400 text-white border-none shadow-orange-200 mb-4">
                        <div class="flex justify-between items-end">
                            <div><div class="text-xs font-bold opacity-80 mb-1">ğŸ”’ {{currentUser.name}} çš„ç§äººæ”¯å‡ºç¸½è¨ˆ</div><div class="text-4xl font-black">TWD ${{Math.round(myPrivateTotalTWD).toLocaleString()}}</div></div>
                        </div>
                     </div>
                     <div class="space-y-3 pb-20">
                        <div v-for="exp in myPrivateExpenses" :key="exp.id" class="card p-4 flex justify-between items-center !mb-0 !rounded-2xl border-l-4 border-yellow-300">
                            <div><div class="font-bold text-gray-800">{{exp.name}}</div><div class="text-[10px] text-gray-400">{{exp.date}}</div></div>
                            <div class="text-right">
                                <span class="font-black text-gray-700 block">{{exp.currency}} {{exp.amount}}</span>
                                <span v-if="exp.currency==='JPY'" class="text-[10px] text-gray-400">â‰ˆ TWD {{Math.round(exp.amount*exchangeRate)}}</span>
                            </div>
                            <button @click="deleteExpense(exp.id)" class="ml-3 text-red-300"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <div v-if="myPrivateExpenses.length===0" class="text-center text-gray-400 text-sm mt-10">ç›®å‰æ²’æœ‰ç§äººæ”¯å‡ºè¨˜éŒ„</div>
                     </div>
                     <button @click="openExpenseModal('private')" class="fab-main bg-yellow-400 text-white"><i class="fa-solid fa-pen"></i></button>
                 </div>

                 <div v-if="moneyTab==='split'">
                     <div class="card p-5 border-l-4 border-blue-400 bg-blue-50/50">
                         <h3 class="font-bold text-blue-500 mb-4 flex items-center gap-2"><i class="fa-solid fa-calculator"></i> æ™ºæ…§çµç®— (TWD)</h3>
                         <div v-if="settlements.length===0" class="text-center text-gray-400 text-sm py-4">ç›®å‰æ”¶æ”¯å¹³è¡¡ï¼Œç„¡é ˆè½‰å¸³ã€‚</div>
                         <div v-else class="space-y-3">
                             <div v-for="s in settlements" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-blue-100">
                                 <span class="font-bold text-gray-700 text-sm">{{getUserName(s.from)}} <i class="fa-solid fa-angles-right text-blue-300 mx-1"></i> {{getUserName(s.to)}}</span>
                                 <span class="font-black text-blue-600">${{s.amount.toLocaleString()}}</span>
                             </div>
                         </div>
                     </div>
                     <h3 class="font-bold text-gray-600 mt-6 mb-3 px-2">å…¬æ¬¾æ˜ç´°</h3>
                     <div class="space-y-3 pb-20">
                        <div v-for="exp in groupExpenses" :key="exp.id" class="card p-4 !mb-0 !rounded-2xl border-l-4 border-blue-300 relative">
                             <div class="flex justify-between items-start mb-1">
                                 <div class="font-bold text-gray-800">{{exp.name}}</div>
                                 <div class="font-black text-blue-500">{{exp.currency}} {{exp.amount}}</div>
                             </div>
                             <div class="flex justify-between items-end">
                                 <div class="text-xs text-gray-500 font-bold bg-gray-100 px-2 py-1 rounded inline-block">
                                     <span class="text-blue-500">{{getUserName(exp.whoPaid)}}</span> å…ˆä»˜ <i class="fa-solid fa-caret-right text-gray-400"></i> åˆ†çµ¦ {{exp.forWhom.length}} äºº
                                 </div>
                                 <button @click="deleteExpense(exp.id)" class="text-red-300 p-2"><i class="fa-solid fa-trash-can"></i></button>
                             </div>
                        </div>
                     </div>
                     <button @click="openExpenseModal('split')" class="fab-main bg-blue-400 text-white"><i class="fa-solid fa-plus"></i></button>
                 </div>
             </div>
        </div>

        <div v-if="currentView==='hotel'" class="px-5 py-4 animate-fade-in">
            <div class="flex gap-2 mb-6 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm">
                <button @click="hotelTab='stay'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='stay'?'bg-indigo-500 text-white':'text-gray-400']">ä½å®¿</button>
                <button @click="hotelTab='flight'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='flight'?'bg-pink-500 text-white':'text-gray-400']">æˆ‘çš„æ©Ÿç¥¨</button>
                <button @click="hotelTab='car'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='car'?'bg-green-500 text-white':'text-gray-400']">ç§Ÿè»Š</button>
            </div>
            <div v-if="hotelTab==='stay'" class="space-y-6">
                <div class="card !p-0 border-0 shadow-xl overflow-hidden"><div class="h-40 bg-gray-200 relative"><img :src="getImg('bnb.jpg')" class="w-full h-full object-cover" @error="handleImgError"><div class="absolute bottom-4 left-5 text-white shadow-black drop-shadow-md"><h3 class="font-black text-2xl">éŒ¦ç³¸ç”ºæ°‘å®¿</h3></div></div><div class="p-4"><a href="https://www.google.com/maps/search/?api=1&query={encodeURIComponent('éŒ¦ç³¸ç”ºæ°‘å®¿')}" target="_blank" class="w-full flex items-center justify-center gap-2 bg-indigo-50 text-indigo-600 font-bold py-3 rounded-xl border border-indigo-100"><i class="fa-solid fa-location-dot"></i> å°èˆª</a></div></div>
                <div class="card !p-0 border-0 shadow-xl overflow-hidden"><div class="h-40 bg-gray-200 relative"><img :src="getImg('megu.jpg')" class="w-full h-full object-cover" @error="handleImgError"><div class="absolute bottom-4 left-5 text-white shadow-black drop-shadow-md"><h3 class="font-black text-2xl">Megu Fuji</h3></div></div><div class="p-4"><a href="https://www.google.com/maps/search/?api=1&query={encodeURIComponent('Megu Fuji 2021')}" target="_blank" class="w-full flex items-center justify-center gap-2 bg-indigo-50 text-indigo-600 font-bold py-3 rounded-xl border border-indigo-100"><i class="fa-solid fa-location-dot"></i> å°èˆª</a></div></div>
            </div>
            <div v-if="hotelTab==='flight'" class="animate-fade-in">
                 <div v-if="!currentUser" class="text-center py-20 text-gray-400 font-bold bg-white/50 rounded-3xl border border-dashed border-gray-300"><i class="fa-solid fa-eye-slash text-4xl mb-4"></i><br>è«‹å…ˆé¸æ“‡èº«åˆ†<br>ä»¥æŸ¥çœ‹æ‚¨çš„æ©Ÿç¥¨</div>
                 <div v-else class="boarding-pass p-0 border-l-4 border-pink-500">
                     <div class="bg-pink-50 p-4 flex items-center gap-3 border-b border-pink-100">
                         <div class="w-12 h-12 rounded-full bg-white border flex items-center justify-center text-2xl"><img v-if="currentUser.avatar" :src="currentUser.avatar" class="w-full h-full object-cover"><span v-else>{{currentUser.icon}}</span></div>
                         <div class="flex-1"><div class="font-black text-gray-800 text-lg">åªé¡¯ç¤º {{currentUser.name}} çš„æ©Ÿç¥¨</div></div>
                         <i class="fa-solid fa-lock text-pink-300"></i>
                     </div>
                     <div class="p-5 space-y-4">
                         <div class="flex justify-between items-center"><span class="text-xs text-gray-500 font-bold">å»ç¨‹ TR898 (06:40)</span><span class="font-black text-xl text-gray-800">{{currentUser.flightOutSeat||'æœªé¸ä½'}}</span></div>
                         <div class="flex justify-between items-center"><span class="text-xs text-gray-500 font-bold">å›ç¨‹ BR197 (14:00)</span><span class="font-black text-xl text-gray-800">{{currentUser.flightInSeat||'æœªé¸ä½'}}</span></div>
                         <div class="text-[10px] text-gray-400 text-center mt-2">*ä»–äººç„¡æ³•æŸ¥çœ‹æ­¤è³‡è¨Š</div>
                     </div>
                 </div>
            </div>
            <div v-if="hotelTab==='car'" class="animate-fade-in space-y-4">
                 <div class="card p-5 border-l-4 border-green-500"><h3 class="font-black text-lg mb-2">Toyota Rent a Car</h3><a href="https://rent.toyota.co.jp/zh-tw/" target="_blank" class="block text-center bg-green-500 text-white font-bold py-2 rounded-xl">é ç´„å®˜ç¶²</a></div>
            </div>
        </div>

        <div v-if="currentView==='prep'" class="px-5 py-4 animate-fade-in">
            <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="block w-full bg-gradient-to-r from-blue-600 to-blue-400 text-white rounded-2xl p-4 mb-6 shadow-lg flex items-center justify-between active:scale-95 transition"><div class="flex items-center gap-3"><i class="fa-solid fa-qrcode text-3xl"></i><div><div class="font-bold text-lg">Visit Japan Web</div></div></div><i class="fa-solid fa-chevron-right"></i></a>
            <div class="card p-5 bg-gradient-to-r from-indigo-50 to-purple-50 border-indigo-200 mb-6"><h4 class="font-bold text-indigo-800 text-sm mb-3">ğŸ« ç¥¨åˆ¸ç²¾éˆ</h4><div class="space-y-3"><div v-for="t in suggestedTickets" class="bg-white p-3 rounded-xl shadow-sm border border-indigo-100 flex justify-between items-center"><span class="text-sm font-bold text-gray-700">{{t.name}}</span><a :href="t.link" target="_blank" class="text-xs bg-indigo-500 text-white px-3 py-1.5 rounded-full font-bold">è³¼ç¥¨</a></div></div></div>
            <div v-if="!currentUser" class="text-center text-gray-400 font-bold bg-white/50 py-10 rounded-2xl border border-dashed"><i class="fa-solid fa-suitcase text-3xl mb-2"></i><br>è«‹ç™»å…¥ä»¥æŸ¥çœ‹è¡Œææ¸…å–®</div>
            <div v-else class="card p-0">
                <div class="bg-gray-50 p-3 border-b font-bold text-gray-700 flex justify-between items-center">
                    <span class="flex items-center gap-2"><i class="fa-solid fa-user-check text-blue-400"></i> {{currentUser.name}} çš„è¡Œæ</span>
                    <button @click="addPrepItem(currentUser)" class="text-xs bg-white border border-blue-200 text-blue-500 px-3 py-1 rounded-full">+ æ–°å¢</button>
                </div>
                <div v-for="(item, idx) in currentUser.list" :key="idx" class="flex items-center p-3 border-b border-gray-100"><input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-500 mr-3" @change="saveData"><span :class="['flex-1 text-sm font-bold', item.checked?'text-gray-300 line-through':'text-gray-700']">{{item.text}}</span><button @click="currentUser.list.splice(idx,1);saveData()" class="text-gray-300"><i class="fa-solid fa-times"></i></button></div>
                <div v-if="currentUser.list.length===0" class="p-4 text-center text-gray-400 text-xs">å°šç„¡é …ç›®ï¼Œè¶•å¿«æ–°å¢å§ï¼</div>
            </div>
        </div>

        <div v-if="currentView==='shopping'" class="px-5 py-4 animate-fade-in">
            <div class="grid grid-cols-2 gap-3 mb-6"><a href="https://www.cosme.net/ranking/" target="_blank" class="bg-green-50 text-green-600 p-3 rounded-xl text-center font-bold text-xs border border-green-200 block">ğŸ‘‘ COSME å¤§è³</a><a href="https://www.shinyusha.co.jp/media/ldk-the-beauty/" target="_blank" class="bg-pink-50 text-pink-600 p-3 rounded-xl text-center font-bold text-xs border border-pink-200 block">ğŸ’„ LDK æ¯’èˆŒé›œèªŒ</a></div>
            <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar"><button v-for="cat in ['cosme','ldk','souvenir']" @click="shopCat=cat" :class="['px-5 py-2 rounded-full font-bold text-xs whitespace-nowrap transition', shopCat===cat?'bg-pink-400 text-white':'bg-white text-gray-400']">{{{'cosme':'è—¥å¦æ¸…å–®','ldk':'LDKæ¨è–¦','souvenir':'ä¼´æ‰‹ç¦®'}[cat]}}</button></div>
            <div class="grid grid-cols-2 gap-4 pb-20">
                <div v-for="(item,idx) in shopping[shopCat]" class="card !p-0 border-0 shadow-lg group relative" :key="idx">
                    <div class="h-32 bg-gray-100 relative overflow-hidden"><img :src="item.img" class="w-full h-full object-cover" @error="handleImgError"></div>
                    <div class="p-3">
                        <div class="font-bold text-gray-800 text-sm mb-1 truncate">{{item.name}}</div>
                        <a :href="item.link || getSearchLink(item.name)" target="_blank" class="block text-center bg-gray-50 text-gray-500 text-[10px] py-1.5 rounded font-bold hover:bg-pink-500 hover:text-white transition">å®˜æ–¹/æœå°‹</a>
                    </div>
                    <div v-if="isLoggedIn" class="absolute top-1 right-1"><button @click="shopping[shopCat].splice(idx,1);saveData()" class="bg-white/90 p-1 rounded-full text-red-500 shadow"><i class="fa-solid fa-trash"></i></button></div>
                </div>
            </div>
            <button v-if="isLoggedIn" @click="openAddShopModal" class="fab-main bg-purple-400 text-white"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="['food','photo'].includes(currentView)" class="px-5 py-4 animate-fade-in">
            <div class="flex gap-2 mb-4 justify-center"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="currentLoc=loc" :class="['px-5 py-2 rounded-full font-bold text-xs transition', currentLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc]}}</button></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20">
                <div v-for="(item,idx) in spots[currentView][currentLoc]" :key="idx" class="card !p-0 border-0 shadow-lg group relative">
                    <div class="h-48 bg-gray-100 relative overflow-hidden"><img :src="item.img" class="w-full h-full object-cover" @error="handleImgError"></div>
                    <div class="p-4">
                        <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                        <p class="text-sm text-gray-500 mb-3">{{item.desc}}</p>
                        <a :href="getMapLink(item.link, item.name)" target="_blank" class="block w-full text-center bg-gray-50 text-gray-600 font-bold py-2 rounded-lg text-sm border hover:bg-orange-400 hover:text-white transition"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                    </div>
                    <div v-if="isLoggedIn" class="absolute top-2 right-2"><button @click="spots[currentView][currentLoc].splice(idx,1);saveData()" class="w-8 h-8 bg-white rounded-full shadow text-red-500"><i class="fa-solid fa-trash"></i></button></div>
                </div>
            </div>
            <button v-if="isLoggedIn" @click="openAddSpotModal" class="fab-main bg-orange-400 text-white"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView==='weather'" class="px-5 py-4 animate-fade-in"><div class="bg-pink-50 p-4 rounded-2xl border border-pink-200 mb-6 shadow-sm text-center relative overflow-hidden"><i class="fa-solid fa-fan text-pink-200 text-6xl absolute -right-4 -bottom-4 animate-spin-slow"></i><h3 class="font-black text-pink-500 mb-3 text-sm">ğŸŒ¸ 2026 æ«»èŠ±é æ¸¬</h3><div class="grid grid-cols-3 gap-2"><div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">æ±äº¬</div><div class="font-bold text-pink-600">3/22</div></div><div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">éŒå€‰</div><div class="font-bold text-pink-600">3/25</div></div><div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">å¯Œå£«å±±</div><div class="font-bold text-pink-600">4/10</div></div></div></div><div class="space-y-4"><div v-for="w in weatherData" class="card p-6 text-white relative" :class="w.bg"><div class="relative z-10"><div class="font-bold opacity-80 uppercase text-xs">{{w.name}}</div><div class="text-5xl font-black my-2">{{w.temp}}Â°C</div><div class="text-sm bg-white/20 backdrop-blur inline-block px-3 py-1 rounded-full">ğŸ‘• {{getClothingAdvice(w.temp)}}</div></div></div></div></div>

        <div v-if="currentView==='japanese'" class="px-5 py-4 animate-fade-in">
            <button @click="$refs.cameraInput.click()" class="w-full bg-gray-900 text-white rounded-2xl p-4 mb-6 shadow-lg flex items-center justify-center gap-3 active:scale-95 transition relative overflow-hidden">
                <i class="fa-solid fa-camera text-2xl"></i>
                <div class="text-left"><div class="font-bold">é–‹å•Ÿç›¸æ©Ÿç¿»è­¯</div><div class="text-[10px] text-gray-400">æ‹ç…§å¾Œæ¨¡æ“¬æƒæ</div></div>
                <input type="file" ref="cameraInput" accept="image/*" capture="environment" class="absolute inset-0 opacity-0 cursor-pointer" @change="handleCameraTranslate">
            </button>
            <div class="space-y-3 pb-20">
                <div v-for="(p,idx) in japanesePhrases" :key="idx" class="card p-5 flex justify-between items-center cursor-pointer hover:shadow-md transition border-l-4 border-emerald-400" @click="expandCard(p)">
                    <div><div class="font-bold text-lg text-gray-800">{{p.jp}}</div><div class="text-xs text-gray-500 font-bold mt-1">{{p.zh}}</div></div>
                    <i class="fa-solid fa-expand text-gray-300"></i>
                </div>
            </div>
            <button v-if="isLoggedIn" @click="openAddPhraseModal" class="fab-main bg-emerald-500 text-white"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <div v-show="currentView!=='menu'" class="fab-home" @click="currentView='menu'"><i class="fa-solid fa-house"></i></div>

    <div v-if="showPersonaModal" class="fixed inset-0 z-[2000] bg-black/85 flex items-center justify-center p-6 backdrop-blur-lg animate-fade-in">
        <div class="bg-white/95 w-full max-w-sm rounded-[32px] p-8 text-center shadow-2xl relative">
            <h3 class="font-black text-2xl mb-8 text-gray-700 tracking-wider">è«‹å•æ‚¨æ˜¯å“ªä¸€ä½ï¼Ÿ</h3>
            <div class="grid grid-cols-2 gap-6">
                <div v-for="u in users" :key="u.id" class="relative group cursor-pointer" @click="setCurrentUser(u)">
                    <div class="w-24 h-24 mx-auto rounded-full bg-white border-4 border-gray-100 shadow-lg flex items-center justify-center text-4xl mb-3 overflow-hidden transition-all duration-300 group-hover:scale-110 group-hover:border-pink-300 group-hover:shadow-pink-200">
                        <img v-if="u.avatar" :src="u.avatar" class="w-full h-full object-cover">
                        <span v-else>{{u.icon}}</span>
                    </div>
                    <div class="font-black text-gray-600 text-lg group-hover:text-pink-500 transition">{{u.name}}</div>
                    <button @click.stop="openUserEditor(u)" class="absolute -top-1 -right-1 w-8 h-8 bg-gray-800 text-white rounded-full flex items-center justify-center shadow-md active:scale-90 transition z-10"><i class="fa-solid fa-pen text-xs"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showUserEditModal" class="fixed inset-0 z-[2100] bg-black/60 flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-xl text-center">
            <h3 class="font-bold text-lg mb-4">ç·¨è¼¯èº«åˆ†è³‡æ–™</h3>
            <div class="w-24 h-24 mx-auto rounded-full bg-gray-100 border-4 border-white shadow mb-4 overflow-hidden relative cursor-pointer" @click="$refs.avatarInput.click()">
                <img v-if="editingUser.avatar" :src="editingUser.avatar" class="w-full h-full object-cover">
                <span v-else class="text-4xl flex items-center justify-center h-full">{{editingUser.icon}}</span>
                <div class="absolute inset-0 bg-black/30 flex items-center justify-center text-white text-xs font-bold opacity-0 hover:opacity-100 transition">æ›´æ›</div>
            </div>
            <input v-model="editingUser.name" class="w-full p-3 bg-gray-50 rounded-xl mb-4 text-center font-bold border" placeholder="è¼¸å…¥æ–°æš±ç¨±">
            <div class="flex gap-2">
                <button @click="showUserEditModal=false" class="flex-1 py-2 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                <button @click="saveUserChanges" class="flex-1 py-2 bg-pink-500 text-white rounded-xl font-bold shadow">å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <div v-if="showExpenseModal" class="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center">{{expenseMode==='private'?'è¨˜ä¸€ç­†ç§å¸³':'å…¬æ¬¾åˆ†å¸³'}}</h3>
            <input v-model="modalData.name" placeholder="æ¶ˆè²»é …ç›® (å¦‚: æ™šé¤)" class="w-full p-3 bg-gray-50 rounded-xl mb-3 border font-bold">
            <div class="flex gap-2 mb-3">
                <input type="number" v-model="modalData.amount" placeholder="é‡‘é¡" class="flex-1 p-3 bg-gray-50 rounded-xl border font-black text-lg">
                <select v-model="modalData.currency" class="bg-gray-100 rounded-xl px-2 font-bold text-sm outline-none">
                    <option value="JPY">JPY</option>
                    <option value="TWD">TWD</option>
                </select>
            </div>
            <div v-if="expenseMode==='split'" class="mb-4 bg-blue-50 p-3 rounded-xl">
                <label class="text-xs text-blue-500 font-bold ml-1 block mb-2">èª°å…ˆå¢ŠéŒ¢?</label>
                <div class="flex gap-2 overflow-x-auto">
                    <button v-for="u in users" :key="u.id" @click="modalData.whoPaid=u.id" :class="['px-3 py-1 rounded-full text-xs font-bold border transition whitespace-nowrap', modalData.whoPaid===u.id?'bg-blue-500 text-white':'bg-white text-gray-400']">{{u.name}}</button>
                </div>
                <label class="text-xs text-blue-500 font-bold ml-1 block mt-3 mb-2">å¹³åˆ†çµ¦èª°?</label>
                <div class="flex gap-2 overflow-x-auto">
                    <button v-for="u in users" :key="u.id" @click="toggleShare(u.id)" :class="['px-3 py-1 rounded-full text-xs font-bold border transition whitespace-nowrap', modalData.forWhom.includes(u.id)?'bg-pink-400 text-white':'bg-white text-gray-400']">{{u.name}}</button>
                </div>
            </div>
            <button @click="saveExpense" class="w-full py-3 bg-yellow-400 text-white rounded-xl font-bold shadow-lg">å„²å­˜</button>
            <button @click="showExpenseModal=false" class="w-full py-3 mt-2 text-gray-400 font-bold">å–æ¶ˆ</button>
        </div>
    </div>

    <div v-if="showLoginModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-3xl p-8 shadow-2xl"><h3 class="text-2xl font-black text-center mb-6">ç®¡ç†å“¡ç™»å…¥</h3><input v-model="loginForm.email" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 font-bold" placeholder="Email"><input v-model="loginForm.password" type="password" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 font-bold" placeholder="Password"><button @click="doLogin" class="w-full py-4 bg-pink-500 text-white font-black rounded-2xl">ç™»å…¥</button></div></div>
    
    <div v-if="expandedPhrase" class="fixed inset-0 z-[2000] bg-white flex flex-col items-center justify-center p-10 text-center" @click="expandedPhrase=null"><div class="text-6xl font-black mb-6">{{expandedPhrase.jp}}</div><div class="text-2xl font-bold text-gray-500">{{expandedPhrase.zh}}</div><div class="mt-10 text-gray-300 text-sm">é»æ“Šé—œé–‰</div></div>
    
    <input type="file" ref="avatarInput" accept="image/*" class="hidden" @change="processAvatarUpload">
    
    <div v-if="showModal" class="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative"><h3 class="font-bold text-lg mb-4 text-center">{{modalTitle}}</h3><div class="space-y-3"><input v-for="f in modalFields" :key="f.key" v-model="modalData[f.key]" :placeholder="f.label" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-pink-300"><button v-if="modalHasImg" @click="$refs.modalImgInput.click()" class="w-full py-3 bg-blue-50 text-blue-500 rounded-xl font-bold border border-blue-100">ä¸Šå‚³åœ–ç‰‡</button></div><div class="flex gap-3 mt-6"><button @click="showModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="handleModalSave" class="flex-1 py-3 bg-pink-500 text-white rounded-xl font-bold shadow-lg">å„²å­˜</button></div></div><input type="file" ref="modalImgInput" accept="image/*" class="hidden" @change="processModalImg"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3.3.4/dist/vue.esm-browser.js";

const firebaseConfig = { apiKey: "AIzaSyD3ojbkJVfDKmZQHRpZG-gp8gv7ajKdJr4", authDomain: "tokyo-trip-24b28.firebaseapp.com", projectId: "tokyo-trip-24b28", storageBucket: "tokyo-trip-24b28.firebasestorage.app", messagingSenderId: "518699705070", appId: "1:518699705070:web:56e95f603210d8d5d209ff" };
let auth, db; try { const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.warn("Firebase Init Fail", e); }

// V25.10 Data Restoration
const defaultData = {
    users: [{id:1,name:'å‰ä¼Š',icon:'ğŸ¹',list:[]},{id:2,name:'å°å…«',icon:'ğŸ±',list:[]},{id:3,name:'å…”å…”',icon:'ğŸ°',list:[]},{id:4,name:'å°æ¡ƒ',icon:'ğŸ‘',list:[]}],
    itinerary: [
        [{hours:"06:40",category:"Flight",name:"TPE èµ·é£›",note:"T1 è¾¦ç†ç™»æ©Ÿ"},{hours:"10:30",category:"Flight",name:"NRT æŠµé”",note:"é ˜å–è¡Œæ/è³¼è²·è¥¿ç“œå¡"},{hours:"14:00",category:"Sightseeing",name:"æ™´ç©ºå¡”",note:"æ°´æ—é¤¨/å¯¶å¯å¤¢ä¸­å¿ƒ"},{hours:"18:00",category:"Food",name:"æ•˜æ•˜è‹‘",note:"æ™´ç©ºå¡”åº—æ™šé¤"}],
        [{hours:"09:00",category:"Sightseeing",name:"æ·ºè‰å¯º",note:"é›·é–€/ä»²è¦‹ä¸–é€š"},{hours:"12:00",category:"Food",name:"æ·ºè‰ä»ŠåŠ",note:"ç™¾å¹´å£½å–œç‡’"},{hours:"15:00",category:"Sightseeing",name:"ç§‹è‘‰åŸ",note:"å‹•æ¼«å·¡ç¦®"},{hours:"19:00",category:"Food",name:"AFURI",note:"æŸšå­é¹½æ‹‰éºµ"}],
        [{hours:"07:30",category:"Transport",name:"å¯Œå£«å›éŠ",note:"æ–°å®¿ç›´é”æ²³å£æ¹–"},{hours:"10:30",category:"Sightseeing",name:"ä¸‹å‰ç”°",note:"æ—¥å·æ™‚è¨ˆåº—"},{hours:"12:00",category:"Food",name:"ä¸å‹•èŒ¶å±‹",note:"é¤ºé£¥éºµ"},{hours:"14:00",category:"Sightseeing",name:"æ–°å€‰å±±æ·ºé–“å…¬åœ’",note:"å¿ éˆå¡”èˆ‡å¯Œå£«å±±"},{hours:"16:00",category:"Hotel",name:"Check-in",note:"æ²³å£æ¹–é£¯åº—"}],
        [{hours:"05:30",category:"Sightseeing",name:"é€†å¯Œå£«",note:"æ—©èµ·çœ‹å€’å½±"},{hours:"10:00",category:"Sightseeing",name:"å¤©ä¸Šå±±çºœè»Š",note:"å…”å­ç¥ç¤¾/çµ•æ™¯"},{hours:"12:30",category:"Food",name:"å±±éº“åœ’",note:"çˆç«¯ç‡’é«”é©—"},{hours:"15:00",category:"Transport",name:"è¿”å›æ±äº¬",note:"å¯Œå£«å›éŠ/å·´å£«"}],
        [{hours:"09:00",category:"Transport",name:"å‰å¾€éŒå€‰",note:"æ±Ÿä¹‹é›»ä¸€æ—¥åˆ¸"},{hours:"10:30",category:"Sightseeing",name:"éŒå€‰é«˜æ ¡å‰",note:"çŒç±ƒé«˜æ‰‹å¹³äº¤é“"},{hours:"12:00",category:"Food",name:"Bills",note:"ä¸–ç•Œç¬¬ä¸€æ—©é¤é¬†é¤…"},{hours:"14:00",category:"Sightseeing",name:"é•·è°·å¯º/å¤§ä½›",note:"è§€éŸ³/ç¹¡çƒèŠ±"},{hours:"17:00",category:"Sightseeing",name:"æ±Ÿä¹‹å³¶",note:"å¤•é™½/ç¥ç¤¾"}],
        [{hours:"10:00",category:"Sightseeing",name:"æ±äº¬è¿ªå£«å°¼",note:"Land/Sea å…¨æ—¥éŠ"},{hours:"20:00",category:"Sightseeing",name:"ç…™ç«ç§€",note:"åŸå ¡å‰å¡ä½"}],
        [{hours:"10:00",category:"Sightseeing",name:"æ±äº¬éµå¡”",note:"èŠå…¬åœ’é‡é¤"},{hours:"13:00",category:"Shopping",name:"éŠ€åº§/æ¾€è°·",note:"å„å¤§ç™¾è²¨/LOFT"},{hours:"17:30",category:"Sightseeing",name:"SHIBUYA SKY",note:"çµ•ç¾æ—¥è½å±•æœ›å°"},{hours:"20:00",category:"Food",name:"é³¥è²´æ—",note:"å±…é…’å±‹æ…¶åŠŸå®´"}],
        [{hours:"09:00",category:"Shopping",name:"æœ€å¾Œè£œè²¨",note:"ä¸Šé‡äºŒæœ¨ã®è“å­/å”å‰è¨¶å¾·"},{hours:"14:00",category:"Transport",name:"å‰å¾€æ©Ÿå ´",note:"Skyliner"},{hours:"17:00",category:"Flight",name:"NRT å ±åˆ°",note:"å…ç¨…åº—æœ€å¾Œè¡åˆº"},{hours:"20:40",category:"Flight",name:"èµ·é£›å›å°",note:"æœŸå¾…ä¸‹æ¬¡æ—…è¡Œ"}]
    ],
    drivePlan: [
        [{hours:"10:00",name:"å–è»Š",note:"æ²³å£æ¹–ç«™ Toyota Rent"},{hours:"11:00",name:"æ–°å€‰å±±æ·ºé–“å…¬åœ’",note:"äº”é‡å¡” (è‡ªé§•æ–¹ä¾¿)"},{hours:"13:00",name:"ä¸å‹•èŒ¶å±‹",note:"æ±æˆ€è·¯åº— (é›²æœµå»ºç¯‰)"},{hours:"15:00",name:"å¤§çŸ³å…¬åœ’",note:"è–°è¡£è‰/èŠ±è¡—é“"}],
        [{hours:"05:30",name:"å¹³é‡ä¹‹æ¿±",note:"è»Šæ‹é€†å¯Œå£«çµ•æ™¯"},{hours:"08:00",name:"å±±ä¸­æ¹–",note:"å¤©éµèˆ¹"},{hours:"12:00",name:"å±±éº“åœ’",note:"çˆç«¯ç‡’"},{hours:"14:30",name:"è¥¿æ¹–ç™‚ç™’ä¹‹é‡Œ",note:"åˆæŒæ‘"},{hours:"17:00",name:"é‚„è»Š",note:"æ²³å£æ¹–ç«™"}]
    ],
    expenses: [],
    spots: {
        food: {
            Tokyo: [{name:'AFURI',desc:'æ¸…æ–°æŸšå­é¹½æ‹‰éºµ',link:'AFURI åŸå®¿'},{name:'å™å™è‹‘',desc:'é«˜ç´šç‡’è‚‰æ™¯è§€é¤å»³',link:'å™å™è‹‘ æ™´ç©ºå¡”'},{name:'HARBS',desc:'å¿…åƒæ°´æœåƒå±¤è›‹ç³•',link:'HARBS LUMINE EST'},{name:'æ·ºè‰ä»ŠåŠ',desc:'ç™¾å¹´å£½å–œç‡’è€åº—',link:'æ·ºè‰ä»ŠåŠ åœ‹éš›é€š'},{name:'ç‚¸ç‰›æ’ æœ¬æ‘',desc:'è‡ªè¡Œç…çƒ¤è»Ÿå«©ç‰›æ’',link:'ç‰›ã‹ã¤ã‚‚ã¨æ‘ æ¾€è°·'}],
            Kamakura: [{name:'Bills',desc:'ä¸–ç•Œç¬¬ä¸€å¥½åƒé¬†é¤…',link:'Bills ä¸ƒé‡Œãƒ¶æµœ'},{name:'Caraway',desc:'æ’éšŠå’–å“©ååº—',link:'Caraway Curry'},{name:'Pacific Drive-in',desc:'æµ·æ™¯å¤å¨å¤·é¤å»³',link:'Pacific Drive-in'},{name:'åŠ›é¤…å®¶',desc:'ç™¾å¹´è€èˆ–æ¬Šäº”éƒåŠ›é¤…',link:'åŠ›é¤…å®¶'},{name:'éŒå€‰é‡œé£¯',desc:'å»ä»”é­šé‡œé£¯',link:'éŒå€‰é‡œé£¯ ã‹ã¾ã‹ã¾'}],
            Fuji: [{name:'ä¸å‹•èŒ¶å±‹',desc:'ç‰¹è‰²é›²æœµå»ºç¯‰é¤ºé£¥éºµ',link:'ä¸å‹•èŒ¶å±‹ æ±æˆ€è·¯'},{name:'å±±éº“åœ’',desc:'ç‚­ç«çˆç«¯ç‡’é«”é©—',link:'å±±éº“åœ’'},{name:'æ¹–æ³¢',desc:'æ²³å£æ¹–æ™¯è§€å®šé£Ÿ',link:'æ¹–æ³¢é£Ÿäº‹è™•'},{name:'Hana ç‡’è‚‰',desc:'ç•¶åœ°äººæ¨è–¦ç‡’è‚‰',link:'Hana Yakiniku'},{name:'The Park',desc:'å¯Œå£«å±±åå¸',link:'Food Labo'}]
        },
        photo: {
            Tokyo: [{name:'SHIBUYA SKY',desc:'æ±äº¬æœ€ç¾å±•æœ›å°',link:'SHIBUYA SKY'},{name:'è±ªå¾·å¯º',desc:'æ»¿æ»¿æ‹›è²¡è²“',link:'è±ªå¾·å¯º'},{name:'æ±äº¬éµå¡”',desc:'èŠå…¬åœ’æœ€ä½³æ©Ÿä½',link:'èŠå…¬åœ’ 4è™Ÿåœ°'},{name:'æ·ºè‰é›·é–€',desc:'ç¶“å…¸åœ°æ¨™å¤§ç‡ˆç± ',link:'é›·é–€'},{name:'TeamLab',desc:'å…‰å½±è—è¡“å±•',link:'TeamLab Planets'}],
            Kamakura: [{name:'éŒå€‰é«˜æ ¡å‰',desc:'çŒç±ƒé«˜æ‰‹å¹³äº¤é“',link:'éŒå€‰é«˜æ ¡å‰é§…'},{name:'é•·è°·å¯º',desc:'çœºæœ›æ¹˜å—æµ·å²¸',link:'é•·è°·å¯º'},{name:'å ±åœ‹å¯º',desc:'çµ•ç¾ç«¹æ—',link:'å ±åœ‹å¯º'},{name:'æ±Ÿå³¶ç¥ç¤¾',desc:'æµ·ä¸Šé³¥å±…',link:'æ±Ÿå³¶ç¥ç¤¾'},{name:'ä¸ƒé‡Œæ¿±',desc:'æœ€ç¾æµ·å²¸ç·š',link:'ä¸ƒé‡Œãƒ¶æµœ æµ·å²¸'}],
            Fuji: [{name:'æ–°å€‰å±±æ·ºé–“å…¬åœ’',desc:'äº”é‡å¡”èˆ‡å¯Œå£«å±±',link:'æ–°å€‰å±±æ·ºé–“å…¬åœ’'},{name:'ä¸‹å‰ç”°',desc:'æ—¥å·æ™‚è¨ˆåº—æœ¬ç”ºé€š',link:'æ—¥å·æ™‚è¨ˆåº—'},{name:'å¤§çŸ³å…¬åœ’',desc:'èŠ±æµ·å¯Œå£«å±±',link:'å¤§çŸ³å…¬åœ’'},{name:'æ²³å£æ¹–è»Šç«™',desc:'LAWSON å¯Œå£«å±±',link:'æ²³å£æ¹–é§…'},{name:'å¹³é‡ä¹‹æ¿±',desc:'å¯§éœæ¹–ç•”å€’å½±',link:'å¹³é‡ã®æµœ'}]
        }
    },
    shopping: {
        cosme: [{name:'Canmake è‡¥è ¶ç›¤',link:''},{name:'Kate æ€ªç¸å”‡è†',link:''},{name:'Tirtir æ°£å¢Šç²‰é¤…',link:''},{name:'Cezanne ç å…‰ä¿®å®¹',link:''},{name:'Excel çœ¼å½±',link:''}],
        ldk: [{name:'MINON èƒºåŸºé…¸é¢è†œ',link:''},{name:'Quality 1st é¢è†œ',link:''},{name:'IHADA åŒ–å¦æ°´',link:''},{name:'Elixir å°é‡‘ç®¡',link:''},{name:'Fino é«®è†œ',link:''}],
        souvenir: [{name:'NY Perfect Cheese',link:''},{name:'Press Butter Sand',link:''},{name:'Sugar Butter Tree',link:''},{name:'Tokyo Banana',link:''},{name:'ç™½è‰²æˆ€äºº',link:''}]
    },
    phrases: [{jp:'ã™ã¿ã¾ã›ã‚“',zh:'ä¸å¥½æ„æ€/è«‹å•'},{jp:'ã“ã‚Œãã ã•ã„',zh:'æˆ‘è¦é€™å€‹'},{jp:'ã„ãã‚‰ã§ã™ã‹',zh:'è«‹å•å¤šå°‘éŒ¢'},{jp:'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™',zh:'æˆ‘è¦çµå¸³'},{jp:'è¢‹ã„ã‚Šã¾ã›ã‚“',zh:'ä¸ç”¨è¢‹å­'},{jp:'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹',zh:'å»æ‰€åœ¨å“ªè£¡'},{jp:'å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã„ã„ã§ã™ã‹',zh:'å¯ä»¥æ‹ç…§å—'},{jp:'è‹±èªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ã‚Šã¾ã™ã‹',zh:'æœ‰è‹±æ–‡èœå–®å—'},{jp:'ãŠã™ã™ã‚ã¯ä½•ã§ã™ã‹',zh:'æœ‰æ¨è–¦çš„å—'},{jp:'æ°´ãã ã•ã„',zh:'è«‹çµ¦æˆ‘æ°´'}]
};

createApp({
    setup() {
        const currentView = ref('welcome');
        const currentUser = ref(null);
        const showPersonaModal = ref(false);
        const showUserEditModal = ref(false);
        const editingUser = ref({});
        const isLoggedIn = ref(false);
        const isWelcomeClosed = ref(false);
        const showLoginModal = ref(false);
        const loginForm = ref({email:'',password:''});
        
        // Data
        const users = ref(defaultData.users);
        const itinerary = ref(defaultData.itinerary);
        const drivePlan = ref(defaultData.drivePlan);
        const expenses = ref([]);
        const spots = ref(defaultData.spots);
        const shopping = ref(defaultData.shopping);
        const japanesePhrases = ref(defaultData.phrases);
        
        // State
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        const exchangeRate = ref(0.215);
        const moneyTab = ref('record');
        const hotelTab = ref('stay');
        const shopCat = ref('cosme');
        const currentLoc = ref('Tokyo');
        const weatherData = ref([{name:'Tokyo',temp:'--',bg:'bg-blue-400'},{name:'Kamakura',temp:'--',bg:'bg-indigo-400'},{name:'Fuji',temp:'--',bg:'bg-purple-400'}]);
        
        const showExpenseModal = ref(false);
        const modalData = ref({});
        const expenseMode = ref('private'); // private or split
        const expandedPhrase = ref(null);
        const showModal = ref(false);
        const modalTitle = ref('');
        const modalFields = ref([]);
        const modalHasImg = ref(false);
        const modalCallback = ref(null);

        const apps = [{id:1,name:'è¡Œç¨‹',icon:'fa-solid fa-map',view:'itinerary',bgClass:'bg-pink-400'},{id:2,name:'å°è²¡åº«',icon:'fa-solid fa-yen-sign',view:'money',bgClass:'bg-yellow-400'},{id:3,name:'ä½å®¿äº¤é€š',icon:'fa-solid fa-hotel',view:'hotel',bgClass:'bg-indigo-400'},{id:4,name:'è¡Œå‰æº–å‚™',icon:'fa-solid fa-suitcase',view:'prep',bgClass:'bg-blue-400'},{id:5,name:'åƒåƒå–å–',icon:'fa-solid fa-utensils',view:'food',bgClass:'bg-orange-400'},{id:6,name:'ç¶²ç¾æ‰“å¡',icon:'fa-solid fa-camera',view:'photo',bgClass:'bg-rose-400'},{id:7,name:'å¿«æ¨‚è³¼',icon:'fa-solid fa-bag-shopping',view:'shopping',bgClass:'bg-purple-400'},{id:8,name:'å¤©æ°£',icon:'fa-solid fa-cloud-sun',view:'weather',bgClass:'bg-sky-400'},{id:9,name:'ç¿»è­¯',icon:'fa-solid fa-language',view:'japanese',bgClass:'bg-emerald-400'}];
        const tripDays = [{week:'D1',title:'3/27'},{week:'D2',title:'3/28'},{week:'D3',title:'3/29'},{week:'D4',title:'3/30'},{week:'D5',title:'3/31'},{week:'D6',title:'4/01'},{week:'D7',title:'4/02'},{week:'D8',title:'4/03'}];
        const daysUntilTrip = ref(Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24)));
        
        // V25 Smart Reminders Logic
        const smartReminders = computed(() => { 
            const l=[]; 
            const today = new Date();
            const tripStart = new Date('2026-03-27');
            const diffDays = Math.ceil((tripStart - today)/(1000*60*60*24));

            if(diffDays <= 60) l.push("è¿ªå£«å°¼é–€ç¥¨ (2å€‹æœˆå‰é–‹è³£)");
            if(diffDays <= 30) l.push("å¯Œå£«å›éŠè™Ÿ (1å€‹æœˆå‰æ¶ç¥¨)");
            if(diffDays <= 28) l.push("SHIBUYA SKY (4é€±å‰é–‹æ”¾)");
            if(diffDays <= 2) l.push("ç·šä¸Šé è¾¦ç™»æ©Ÿ (48hrå‰)");
            if(diffDays <= 7) l.push("VJW å¡«å¯«å®Œç•¢äº†å—ï¼Ÿ");
            return l; 
        });

        // Itinerary Logic
        const getCurrentItinerary = () => (itineraryMode.value==='drive'&&[2,3].includes(selectedDayIndex.value)) ? (drivePlan.value[selectedDayIndex.value-2]||[]) : (itinerary.value[selectedDayIndex.value]||[]);

        // Finance Logic V25 (Strict Currency & Split)
        const getAmountInTWD = (e) => e.currency==='JPY' ? e.amount*exchangeRate.value : e.amount;
        
        // Private: Created by ME, For ME ONLY
        const myPrivateExpenses = computed(() => currentUser.value ? expenses.value.filter(e => e.whoPaid===currentUser.value.id && e.forWhom.length===1 && e.forWhom[0]===currentUser.value.id) : []);
        const myPrivateTotalTWD = computed(() => myPrivateExpenses.value.reduce((sum, e) => sum + getAmountInTWD(e), 0));

        // Group: Split expenses
        const groupExpenses = computed(() => expenses.value.filter(e => e.forWhom.length > 1 || (e.forWhom.length===1 && e.forWhom[0]!==e.whoPaid)));
        
        const settlements = computed(() => { 
            const b={}; users.value.forEach(u=>b[u.id]=0); 
            groupExpenses.value.forEach(e=>{ 
                const t=getAmountInTWD(e); 
                b[e.whoPaid]+=t; // Payer gets credit
                const s=t/e.forWhom.length; 
                e.forWhom.forEach(i=>b[i]-=s); // Consumer owes
            }); 
            const r=[]; const n=users.value.map(u=>({id:u.id,v:b[u.id]})); 
            const d=n.filter(x=>x.v<-1).sort((x,y)=>x.v-y.v); 
            const c=n.filter(x=>x.v>1).sort((x,y)=>y.v-x.v); 
            let i=0,j=0; 
            while(i<d.length&&j<c.length){ 
                let a=Math.min(-d[i].v,c[j].v); 
                r.push({from:d[i].id,to:c[j].id,amount:Math.round(a)}); 
                d[i].v+=a; c[j].v-=a; 
                if(Math.abs(d[i].v)<1)i++; if(Math.abs(c[j].v)<1)j++; 
            } 
            return r; 
        });

        const getMapLink = (k,n) => `https://www.google.com/maps/search/?api=1&query={encodeURIComponent(k||n)}`;
        const getSearchLink = (n) => `https://www.google.com/search?q=${encodeURIComponent(n)}`;
        const getImg = (p) => p.startsWith('data:')?p:`https://raw.githubusercontent.com/sunny5200820-maker/2026.tokyo.fuji.trip/main/${p}`;
        const handleImgError = (e) => e.target.src='https://placehold.co/400x300?text=Image';
        const getUserName = (id) => users.value.find(u=>u.id===id)?.name||'æœªçŸ¥';
        const getClothingAdvice = (t) => t<10?'ç¾½çµ¨+åœå·¾':t<15?'å¤§è¡£+ç™¼ç†±è¡£':'æ´‹è”¥å¼ç©¿æ­';

        const getPageTitle = (view) => {
            const map = {
                'itinerary': 'è¡Œç¨‹è¡¨', 'money': 'å°è²¡åº«', 'hotel': 'ä½å®¿äº¤é€š', 'prep': 'è¡Œå‰æº–å‚™',
                'food': 'ç¾é£Ÿåœ°åœ–', 'photo': 'æ‰“å¡æ™¯é»', 'shopping': 'è³¼ç‰©æ¸…å–®', 'weather': 'å¤©æ°£é å ±', 'japanese': 'ç¿»è­¯è’Ÿè’»'
            };
            return map[view] || 'é—œæ±ä¹‹æ—…';
        };

        const getIconByCategory = (cat) => {
            const map = { 'Flight': 'fa-solid fa-plane', 'Sightseeing': 'fa-solid fa-camera', 'Food': 'fa-solid fa-utensils', 'Shopping': 'fa-solid fa-bag-shopping', 'Transport': 'fa-solid fa-train-subway', 'Hotel': 'fa-solid fa-bed' };
            return map[cat] || 'fa-solid fa-location-dot';
        };

        const enterSite = () => { isWelcomeClosed.value=true; showPersonaModal.value=true; };
        const setCurrentUser = (u) => { currentUser.value=u; showPersonaModal.value=false; currentView.value='menu'; };
        const openUserEditor = (u) => { editingUser.value={...u}; showUserEditModal.value=true; };
        const saveUserChanges = () => { const idx=users.value.findIndex(u=>u.id===editingUser.value.id); if(idx!==-1)users.value[idx]={...editingUser.value}; saveData(); showUserEditModal.value=false; };
        const processAvatarUpload = (e) => { const r=new FileReader(); r.onload=ev=>editingUser.value.avatar=ev.target.result; r.readAsDataURL(e.target.files[0]); };

        const openExpenseModal = (mode) => { 
            expenseMode.value = mode;
            modalData.value={
                name:'', amount:'', currency:'JPY', 
                whoPaid: currentUser.value.id, 
                forWhom: mode==='private' ? [currentUser.value.id] : users.value.map(u=>u.id) 
            }; 
            showExpenseModal.value=true; 
        };
        const toggleShare = (id) => { const i=modalData.value.forWhom.indexOf(id); i>-1?modalData.value.forWhom.splice(i,1):modalData.value.forWhom.push(id); };
        const saveExpense = () => { expenses.value.push({...modalData.value,id:Date.now(),date:new Date().toLocaleDateString()}); saveData(); showExpenseModal.value=false; };
        const deleteExpense = (id) => { if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†è¨˜éŒ„?')){expenses.value=expenses.value.filter(e=>e.id!==id); saveData();} };
        const addPrepItem = (u) => { u.list.push({text:'æ–°é …ç›®',checked:false}); saveData(); };
        const expandCard = (p) => expandedPhrase.value=p;
        
        // V25 Camera Translation Simulation
        const handleCameraTranslate = () => {
             alert("å·²æ“·å–å½±åƒï¼(æ¨¡æ“¬ä¸­)\nç¿»è­¯çµæœï¼šè«‹åƒè€ƒä¸‹æ–¹å¸¸ç”¨å­—å¡æˆ–ä½¿ç”¨ Google Lensã€‚");
        };

        const handleAuthClick = () => isLoggedIn.value ? (confirm('ç™»å‡º?')&&signOut(auth)) : showLoginModal.value=true;
        const doLogin = async () => { try{await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth,loginForm.value.email,loginForm.value.password);showLoginModal.value=false;}catch(e){alert(e.message);} };
        const saveData = async () => { if(db&&isLoggedIn.value) await setDoc(doc(db,"trips","kanto2026"),{users:users.value,itinerary:itinerary.value,drivePlan:drivePlan.value,expenses:expenses.value,spots:spots.value,shopping:shopping.value,phrases:japanesePhrases.value},{merge:true}); else localStorage.setItem('V25_LOCAL',JSON.stringify({users:users.value,itinerary:itinerary.value,drivePlan:drivePlan.value,expenses:expenses.value,spots:spots.value,shopping:shopping.value,phrases:japanesePhrases.value})); };

        const openAddShopModal = () => { modalTitle.value='æ–°å¢å•†å“'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'link',label:'é€£çµ'}]; modalData.value={name:'',link:'',img:''}; modalHasImg.value=true; modalCallback.value=()=>{shopping.value[shopCat.value].push(modalData.value); saveData();}; showModal.value=true; };
        const openAddSpotModal = () => { modalTitle.value='æ–°å¢æ™¯é»'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'desc',label:'æè¿°'},{key:'link',label:'åœ°åœ–'}]; modalData.value={name:'',desc:'',link:'',img:''}; modalHasImg.value=true; modalCallback.value=()=>{spots.value[currentView.value][currentLoc.value].push(modalData.value); saveData();}; showModal.value=true; };
        const openAddPhraseModal = () => { modalTitle.value='æ–°å¢ç¿»è­¯'; modalFields.value=[{key:'zh',label:'ä¸­æ–‡'},{key:'jp',label:'æ—¥æ–‡'}]; modalData.value={zh:'',jp:''}; modalHasImg.value=false; modalCallback.value=()=>{japanesePhrases.value.push(modalData.value); saveData();}; showModal.value=true; };
        const handleModalSave = () => { if(modalCallback.value)modalCallback.value(); showModal.value=false; };
        const processModalImg = (e) => { const r=new FileReader(); r.onload=ev=>modalData.value.img=ev.target.result; r.readAsDataURL(e.target.files[0]); };

        const suggestedTickets = computed(() => { const n=JSON.stringify(itinerary.value); const l=[]; if(n.includes('è¿ªå£«å°¼'))l.push({name:'è¿ªå£«å°¼é–€ç¥¨',link:'https://www.klook.com/'}); if(n.includes('SHIBUYA'))l.push({name:'SHIBUYA SKY',link:'https://www.klook.com/'}); return l; });
        const fetchWeather = async () => { try{ const g=async(la,lo,i)=>{const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${la}&longitude=${lo}&current_weather=true`);const d=await r.json();weatherData.value[i].temp=d.current_weather.temperature;}; await g(35.68,139.69,0); await g(35.31,139.54,1); await g(35.36,138.72,2); }catch(e){} };

        const initSakura = () => {
            const container = document.getElementById('sakura-container');
            if(!container) return;
            const createPetal = () => {
                const petal = document.createElement('div');
                petal.className = 'sakura';
                petal.style.left = Math.random() * 100 + 'vw';
                petal.style.animationDuration = Math.random() * 3 + 2 + 's';
                petal.style.opacity = Math.random();
                container.appendChild(petal);
                setTimeout(() => petal.remove(), 5000);
            };
            setInterval(createPetal, 300);
        };

        onMounted(() => {
            initSakura();
            if(auth) onAuthStateChanged(auth, u=>{ isLoggedIn.value=!!u; if(u&&db) onSnapshot(doc(db,"trips","kanto2026"),d=>{if(d.exists()){const dt=d.data(); users.value=dt.users||users.value; itinerary.value=dt.itinerary||itinerary.value; expenses.value=dt.expenses||[]; spots.value=dt.spots||spots.value; shopping.value=dt.shopping||shopping.value; japanesePhrases.value=dt.phrases||japanesePhrases.value; drivePlan.value=dt.drivePlan||drivePlan.value; }}) });
            const l=localStorage.getItem('V25_LOCAL'); 
            if(l&&!auth){ 
                try {
                    const d=JSON.parse(l); 
                    if(d.users && d.users.length>0) users.value=d.users; 
                    if(d.itinerary) itinerary.value=d.itinerary;
                    if(d.expenses) expenses.value=d.expenses;
                    if(d.spots) spots.value=d.spots;
                    if(d.shopping) shopping.value=d.shopping;
                    if(d.phrases) japanesePhrases.value=d.phrases;
                    if(d.drivePlan) drivePlan.value=d.drivePlan;
                } catch(e) { localStorage.removeItem('V25_LOCAL'); }
            }
            fetchWeather();
        });

        return {
            users, currentView, isWelcomeClosed, isLoggedIn, enterSite, apps, getPageTitle, handleAuthClick,
            showLoginModal, loginForm, doLogin, daysUntilTrip, smartReminders, tripDays, selectedDayIndex, itineraryMode, getCurrentItinerary,
            moneyTab, exchangeRate, myPrivateExpenses, myPrivateTotalTWD, groupExpenses, settlements, getUserName, openExpenseModal, showExpenseModal, modalData, toggleShare, saveExpense, deleteExpense, expenseMode,
            hotelTab, suggestedTickets, addPrepItem, shopCat, shopping, openAddShopModal, currentLoc, spots, openAddSpotModal, weatherData, getClothingAdvice, japanesePhrases, expandCard, expandedPhrase, openAddPhraseModal,
            showModal, modalTitle, modalFields, modalHasImg, handleModalSave, processModalImg, getIconByCategory, getMapLink, getSearchLink, getImg, handleImgError, saveData,
            currentUser, showPersonaModal, setCurrentUser, openUserEditor, showUserEditModal, editingUser, saveUserChanges, processAvatarUpload, handleCameraTranslate
        };
    }
}).mount('#app');
</script>
</body>
</html>
