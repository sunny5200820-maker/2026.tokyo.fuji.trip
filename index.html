<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (V17.00 æ——è‰¦ä¿®å¾©ç‰ˆ)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
<script>
    tailwind.config={theme:{extend:{colors:{'chii-pink':'#FFD1DC','chii-deep-pink':'#FF9EAC','chii-blue':'#A2D2FF','chii-yellow':'#FFF5BA','chii-text':'#5D4037'},fontFamily:{sans:['Zen Maru Gothic','sans-serif']},animation:{'wiggle':'wiggle 3s ease-in-out infinite','float':'float 3s ease-in-out infinite','fade-in':'fadeIn 0.5s ease-out forwards','spin-slow':'spin 8s linear infinite'},keyframes:{wiggle:{'0%,100%':{transform:'rotate(-3deg)'},'50%':{transform:'rotate(3deg)'}},float:{'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-5px)'}},fadeIn:{from:{opacity:0,transform:'translateY(10px)'},to:{opacity:1,transform:'translateY(0)'}}}}}}
</script>
<style>
    /* æ ¸å¿ƒåŸºç¤æ¨£å¼ - é‡å°æ‰‹æ©Ÿæµæš¢åº¦å„ªåŒ– */
    html,body{margin:0;padding:0;width:100%;height:100%;background-color:#FFF0F5;background-image:radial-gradient(#FFD1DC 15%,transparent 16%),radial-gradient(#FFF5BA 15%,transparent 16%);background-size:60px 60px;background-position:0 0,30px 30px;font-family:"Zen Maru Gothic",sans-serif;color:#5D4037;overflow-x:hidden;-webkit-tap-highlight-color:transparent;padding-bottom:env(safe-area-inset-bottom)}
    input, textarea, select { font-size: 16px !important; font-family: inherit; }
    #app{display:block;min-height:100vh}
    [v-cloak]{display:none !important}
    
    /* æ»¾å‹•æ¢éš±è—ä½†ä¿æŒåŠŸèƒ½ */
    .hide-scrollbar::-webkit-scrollbar{display:none}.hide-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    
    /* è¼‰å…¥èˆ‡éŒ¯èª¤ç•«é¢ */
    #crash-screen { display: none; position: fixed; inset: 0; background: #fff; z-index: 100000; padding: 20px; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
    #loading-screen { position: fixed; inset: 0; background: #FFF0F5; z-index: 99999; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.5s; backdrop-filter: blur(20px); }
    
    /* é«˜ç´šè³ªæ„Ÿå¡ç‰‡ */
    .card{background:rgba(255,255,255,0.85);border-radius:24px;box-shadow:0 8px 32px rgba(255,105,180,0.1);border:1px solid rgba(255,255,255,0.9);margin-bottom:16px;position:relative;overflow:hidden;backdrop-filter:blur(12px);transition:transform 0.2s}
    .card:active { transform: scale(0.98); }
    
    /* æ‡¸æµ®æŒ‰éˆ•ç³»çµ± */
    .fab-home{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);width:68px;height:68px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:white;z-index:900;border:4px solid white;box-shadow:0 10px 25px rgba(255,105,180,0.5);background:linear-gradient(135deg,#FF9EAC,#FFD1DC);cursor:grab;touch-action:none;transition:transform 0.2s}
    .fab-home:active{transform:translateX(-50%) scale(0.9);cursor:grabbing}
    .fab-main{position:fixed;bottom:calc(110px + env(safe-area-inset-bottom));right:20px;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;color:white;z-index:40;border:3px solid white;box-shadow:0 8px 20px rgba(0,0,0,0.15);background-color:#ff9eac;transition:all 0.2s}
    .fab-main:active { transform: scale(0.9); }
    
    /* Google æœå°‹æ‡¸æµ®çƒ */
    .google-float { position: fixed; bottom: 30px; right: 20px; z-index: 800; display: flex; align-items: center; justify-content: flex-end; }
    .google-btn { width: 50px; height: 50px; border-radius: 50%; background: white; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #4285F4; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s; }
    .google-bar { width: 0; overflow: hidden; height: 50px; background: white; border-radius: 25px; display: flex; align-items: center; transition: width 0.3s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s; opacity: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-right: 10px; }
    .google-float.active .google-bar { width: 240px; opacity: 1; padding: 0 15px; }
    
    /* æ©Ÿç¥¨èˆ‡ç¥¨åˆ¸æ¨£å¼ */
    .boarding-pass { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.05); border: 1px solid white; margin-bottom: 20px; position: relative; }
    .cut-line { border-top: 2px dashed #ddd; position: relative; margin: 20px 0; }
    .cut-line::before, .cut-line::after { content: ''; position: absolute; top: -12px; width: 24px; height: 24px; background: #FFF0F5; border-radius: 50%; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
    .cut-line::before { left: -12px; } .cut-line::after { right: -12px; }
    
    /* æ­¡è¿é é¢ */
    .welcome-screen{position:fixed;inset:0;z-index:9999;background:#FFF0F5;transition:transform 0.8s cubic-bezier(0.7,0,0.3,1)}.welcome-screen.hidden-screen{transform:translateY(-100%);pointer-events:none}
    .welcome-bg{position:absolute;inset:0;z-index:0}.welcome-bg::after{content:'';position:absolute;inset:0;background:linear-gradient(to bottom,rgba(255,255,255,0),rgba(255,240,245,0.8))}
    
    /* æ«»èŠ±ç‰¹æ•ˆ */
    .sakura{position:fixed;top:-10px;background:#FFB7B2;border-radius:100% 0 100% 0;opacity:0.6;animation:fall linear infinite;z-index:0;pointer-events:none;width:14px;height:14px; box-shadow: 0 2px 5px rgba(255,105,180,0.2);}
    @keyframes fall{to{transform:translate(15vw,105vh) rotate(360deg)}}
</style>
</head>
<body>

<div id="crash-screen">
    <div class="text-6xl mb-4">ğŸ˜¿</div>
    <h2 class="text-2xl font-black mb-4 text-red-500">å“å‘€ï¼ç¨‹å¼å‡ºéŒ¯äº†</h2>
    <p class="mb-6 text-gray-500 text-sm">å‰ä¼Šå¡å“‡å¥½åƒæŠŠæ•¸æ“šå¼„äº‚äº†ã€‚<br>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²è¡Œä¿®å¾©ã€‚</p>
    <button onclick="localStorage.removeItem('V17_FLAGSHIP');location.reload()" class="bg-red-500 text-white px-10 py-4 rounded-full font-bold shadow-lg active:scale-95 transition">é‡ç½®ä¸¦ä¿®å¾©</button>
    <pre id="error-log" class="mt-6 text-[10px] text-gray-400 bg-gray-50 p-4 rounded-xl text-left overflow-auto max-w-xs border border-gray-200"></pre>
</div>
<script>
    window.onerror = function(msg, url, line, col, error) {
        document.getElementById('loading-screen').style.display = 'none';
        const c = document.getElementById('crash-screen');
        c.style.display = 'flex';
        document.getElementById('error-log').innerText = `Error: ${msg}\nLine: ${line}`;
        return false;
    };
</script>

<div id="loading-screen">
    <div style="font-size: 80px;" class="animate-bounce mb-4">ğŸŒ¸</div>
    <div class="font-bold text-pink-400 text-xl tracking-widest animate-pulse">LOADING...</div>
    <div class="text-xs text-gray-400 mt-2 font-medium">V17.00 Flagship Edition</div>
</div>

<div id="sakura-container"></div>

<div id="app" v-cloak>
    <div :class="['welcome-screen flex flex-col items-center justify-between', isWelcomeClosed ? 'hidden-screen' : '']">
        <div class="welcome-bg"><img :src="getImg('welcome.jpg')" @error="handleImgError" class="w-full h-full object-cover opacity-90"></div>
        <div class="relative z-10 mt-40 text-center px-6">
            <div class="inline-block bg-white/40 backdrop-blur-md px-6 py-2 rounded-full text-white text-xs font-black tracking-[0.2em] border border-white/50 mb-6 animate-float shadow-lg">TOKYO â€¢ FUJI â€¢ KAMAKURA</div>
            <h1 class="text-7xl font-black text-white drop-shadow-lg tracking-widest mb-2 font-sans" style="text-shadow: 0 4px 10px rgba(255,105,180,0.3);">é—œæ±ä¹‹æ—…</h1>
            <p class="text-3xl text-white/90 font-bold tracking-widest drop-shadow-md">2026.03.27</p>
        </div>
        <div class="relative z-10 mb-28 w-full px-10 pb-[env(safe-area-inset-bottom)]">
            <button @click="enterSite" class="w-full bg-white/90 text-pink-500 font-black py-5 rounded-full shadow-2xl backdrop-blur-xl transition active:scale-95 text-xl flex items-center justify-center gap-3 border border-white">
                <span class="animate-spin-slow">ğŸŒ¸</span> é–‹å§‹æ—…ç¨‹
            </button>
        </div>
    </div>

    <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-[64px] bg-[#FFF0F5]/80 backdrop-blur-xl z-30 flex items-center justify-between px-4 border-b border-white/50 shadow-sm pt-[env(safe-area-inset-top)] box-content transition-all">
        <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow-md border border-white active:scale-90 transition"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="font-black text-gray-700 text-lg flex items-center gap-2"><i class="fa-solid fa-sakura text-pink-300"></i> {{getPageTitle(currentView)}}</h1>
        <button @click="showSyncModal=true" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-blue-400 shadow-md border border-white active:scale-90 transition"><i class="fa-solid fa-gear"></i></button>
    </div>
    <div v-if="currentView !== 'menu'" class="h-[64px] pt-[env(safe-area-inset-top)] box-content"></div>

    <div :class="['google-float', showGoogleSearch?'active':'']" v-if="isWelcomeClosed">
        <div class="google-bar"><form action="https://www.google.com/search" target="_blank" class="w-full flex"><input name="q" placeholder="Google æœå°‹..." class="w-full bg-transparent outline-none text-base text-gray-700 font-bold placeholder-gray-300"><button type="submit" class="text-blue-500 px-2"><i class="fa-solid fa-magnifying-glass"></i></button></form></div>
        <div class="google-btn" @click="showGoogleSearch=!showGoogleSearch"><i class="fa-brands fa-google"></i></div>
    </div>

    <div v-if="currentView==='menu'" class="min-h-screen p-6 pt-12 flex flex-col pb-40 animate-fade-in">
        <h2 class="text-3xl font-black text-gray-700 mb-8 text-center pt-[env(safe-area-inset-top)]">æ—…ç¨‹åŠŸèƒ½</h2>
        <div class="mb-8 bg-white/70 backdrop-blur-xl border border-white rounded-[32px] p-6 shadow-xl flex items-start gap-5 relative overflow-hidden group">
             <div class="absolute -right-5 -top-5 w-24 h-24 bg-yellow-100 rounded-full blur-2xl opacity-50"></div>
             <div class="bg-gradient-to-br from-yellow-200 to-yellow-400 w-14 h-14 rounded-2xl flex items-center justify-center text-white text-2xl shrink-0 shadow-lg rotate-3 group-hover:rotate-12 transition"><i class="fa-solid fa-bell"></i></div>
             <div class="flex-1 space-y-1 relative z-10">
                 <div class="font-black text-gray-800 text-xl mb-1">å€’æ•¸ {{daysUntilTrip}} å¤©</div>
                 <div class="text-gray-600 font-medium">ğŸ“… <span class="text-pink-500 font-black">3/27</span> å•Ÿç¨‹</div>
                 <div class="text-gray-500 text-xs font-bold mt-2 flex gap-2 flex-wrap">
                    <span class="bg-white/80 px-2 py-1 rounded-md shadow-sm text-pink-400">07:08 éŒ¦ç³¸ç”ºç™¼</span>
                    <span class="bg-white/80 px-2 py-1 rounded-md shadow-sm text-blue-400">æ²³å£æ¹–ç§Ÿè»Š</span>
                 </div>
             </div>
        </div>
        <div class="grid grid-cols-3 gap-x-4 gap-y-8 px-2">
            <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition duration-300 group" @click="currentView=app.view">
                <div class="w-[76px] h-[76px] rounded-[30px] flex items-center justify-center text-3xl text-white shadow-lg border-[4px] border-white relative overflow-hidden group-hover:-translate-y-1 transition duration-300" :class="app.bgClass">
                    <div class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition"></div>
                    <i :class="app.icon"></i>
                </div>
                <span class="text-sm font-bold mt-3 text-gray-600 group-hover:text-pink-500 transition">{{app.name}}</span>
            </div>
        </div>
    </div>

    <div v-if="currentView==='money'" class="px-5 py-4 pb-40 animate-fade-in">
         <div class="flex gap-2 mb-6 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm">
             <button @click="moneyTab='record'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='record'?'bg-yellow-400 text-white shadow-md':'text-gray-400 hover:bg-white/50']">å€‹äººè¨˜å¸³</button>
             <button @click="moneyTab='split'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='split'?'bg-blue-400 text-white shadow-md':'text-gray-400 hover:bg-white/50']">åˆ†å¸³åŠ©æ‰‹</button>
         </div>
         <div v-if="moneyTab==='record'">
             <div v-if="moneyMode==='select'" class="grid grid-cols-2 gap-4">
                 <div v-for="user in users" :key="user.id" class="card p-6 text-center cursor-pointer relative group" @click="selectMoneyUser(user.id)">
                     <button @click.stop="openUserEdit(user)" class="absolute top-3 right-3 text-gray-300 hover:text-blue-500 bg-white w-8 h-8 rounded-full shadow-sm flex items-center justify-center transition"><i class="fa-solid fa-pen text-xs"></i></button>
                     <div class="w-20 h-20 mx-auto rounded-full bg-gray-100 mb-3 overflow-hidden border-[3px] border-white shadow-md group-hover:scale-105 transition"><img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover"><span v-else class="flex items-center justify-center h-full text-4xl">{{user.icon}}</span></div>
                     <div class="font-black text-gray-700 text-lg">{{user.name}}</div>
                 </div>
             </div>
             <div v-else>
                 <div class="flex items-center gap-3 mb-6"><button @click="moneyMode='select'" class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-gray-500 active:scale-90 transition"><i class="fa-solid fa-arrow-left"></i></button><h3 class="font-black text-2xl text-gray-700">{{getUserById(currentUserId).name}} çš„éŒ¢åŒ…</h3></div>
                 <div class="card p-6 bg-gradient-to-br from-yellow-300 to-orange-400 text-white border-none shadow-orange-200">
                    <div class="flex justify-between items-end">
                        <div><div class="text-xs font-bold opacity-80 mb-1">ç¸½æ”¯å‡º Total</div><div class="text-4xl font-black">Â¥{{Number(userPersonalTotal).toLocaleString()}}</div></div>
                        <i class="fa-solid fa-wallet text-5xl opacity-20"></i>
                    </div>
                 </div>
                 <div class="space-y-3 mt-4">
                    <div v-for="exp in personalExpenses" :key="exp.id" class="card p-4 flex justify-between items-center !mb-0 !rounded-2xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-500"><i class="fa-solid fa-tag"></i></div>
                            <div><div class="font-bold text-gray-800">{{exp.name}}</div><div class="text-xs text-gray-400 font-medium">{{exp.date}}</div></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-black text-lg text-gray-700">Â¥{{Number(exp.amount).toLocaleString()}}</span>
                            <button @click="deleteExpense(exp.id)" class="text-red-300 hover:text-red-500 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                 </div>
                 <button @click="openExpenseModal('personal')" class="fab-main bg-yellow-400 text-white hover:bg-yellow-500"><i class="fa-solid fa-pen"></i></button>
             </div>
         </div>
         <div v-if="moneyTab==='split'">
             <div class="card p-6 border-l-[6px] border-blue-400"><h3 class="font-black mb-4 text-blue-500 text-lg">ğŸ’¡ çµç®—å»ºè­°</h3><div v-for="s in settlements" class="flex justify-between py-3 border-b last:border-0 border-dashed border-gray-200 text-sm font-bold"><span>{{getUserById(s.from).name}} <i class="fa-solid fa-arrow-right text-blue-300 mx-2"></i> {{getUserById(s.to).name}}</span><span class="text-blue-600 bg-blue-50 px-2 py-1 rounded">Â¥{{s.amount.toLocaleString()}}</span></div><div v-if="settlements.length===0" class="text-center text-gray-400 text-sm py-4">ç›®å‰æ²’æœ‰éœ€è¦åˆ†å¸³çš„é …ç›®</div></div>
             <div class="mt-6 space-y-3">
                <div v-for="exp in groupExpenses" :key="exp.id" class="bg-white/90 backdrop-blur p-4 rounded-2xl border border-white flex justify-between items-center shadow-sm">
                    <div><div class="font-bold text-gray-700 text-lg">{{exp.name}}</div><div class="text-xs text-white bg-blue-400 px-2 py-0.5 rounded-full inline-block font-bold mt-1">{{getUserById(exp.user).name}} å¢Šä»˜</div></div>
                    <div class="flex items-center gap-3"><span class="font-black text-xl text-gray-800">Â¥{{Number(exp.amount).toLocaleString()}}</span><button @click="deleteExpense(exp.id)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                </div>
             </div>
             <button @click="openExpenseModal('group')" class="fab-main bg-blue-400 text-white hover:bg-blue-500"><i class="fa-solid fa-users"></i></button>
         </div>
    </div>

    <div v-if="currentView==='hotel'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="flex gap-2 mb-6 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm"><button @click="hotelTab='stay'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',hotelTab==='stay'?'bg-indigo-500 text-white shadow-md':'text-gray-400 hover:bg-white/50']">ä½å®¿è³‡è¨Š</button><button @click="hotelTab='flight'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',hotelTab==='flight'?'bg-pink-500 text-white shadow-md':'text-gray-400 hover:bg-white/50']">æ©Ÿç¥¨/ç¥¨åˆ¸</button></div>
        <div v-if="hotelTab==='stay'" class="space-y-6">
            <div v-for="h in hotels" class="card !p-0 border-0 shadow-xl group overflow-hidden">
                <div class="h-40 bg-gray-200 relative overflow-hidden">
                    <img :src="getImg(h.img)" class="w-full h-full object-cover transition duration-700 group-hover:scale-110">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent"></div>
                    <div class="absolute bottom-4 left-5 text-white">
                        <div class="text-[10px] font-bold bg-indigo-500 px-2 py-1 rounded mb-2 inline-block shadow-sm tracking-wider uppercase">{{h.days}}</div>
                        <h3 class="font-black text-2xl shadow-black drop-shadow-md">{{h.name}}</h3>
                    </div>
                </div>
                <div class="p-5">
                    <a :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name)}`" target="_blank" class="w-full flex items-center justify-center gap-2 bg-indigo-50 text-indigo-600 font-bold py-3.5 rounded-xl text-center border border-indigo-100 active:scale-95 transition hover:bg-indigo-100"><i class="fa-solid fa-location-arrow"></i> é–‹å•Ÿåœ°åœ–å°èˆª</a>
                </div>
            </div>
        </div>
        <div v-if="hotelTab==='flight'" class="animate-fade-in">
            <div class="mb-8">
                <h3 class="font-black text-gray-500 mb-3 ml-2 text-sm uppercase tracking-wider">Flight Info</h3>
                <div class="boarding-pass">
                    <div class="bg-gradient-to-r from-pink-500 to-rose-400 h-3"></div>
                    <div class="p-5 flex justify-between items-center"><span class="font-black text-gray-400 text-sm tracking-widest">SCOOT</span><span class="font-black text-pink-500 bg-pink-50 px-2 py-1 rounded text-xs">å»ç¨‹ TR898</span></div>
                    <div class="px-8 pb-4 flex justify-between items-center">
                        <div class="text-center"><div class="text-4xl font-black text-gray-800">TPE</div><div class="text-xs text-gray-400 font-bold mt-1">06:40</div></div>
                        <div class="text-center flex flex-col items-center"><i class="fa-solid fa-plane text-pink-300 text-xl transform rotate-45 mb-1"></i><div class="w-16 h-[2px] bg-pink-100"></div></div>
                        <div class="text-center"><div class="text-4xl font-black text-gray-800">NRT</div><div class="text-xs text-gray-400 font-bold mt-1">10:40</div></div>
                    </div>
                    <div class="cut-line"></div>
                    <div class="p-5 flex justify-between items-center"><span class="font-black text-gray-400 text-sm tracking-widest">EVA AIR</span><span class="font-black text-green-500 bg-green-50 px-2 py-1 rounded text-xs">å›ç¨‹ BR197</span></div>
                    <div class="px-8 pb-8 flex justify-between items-center">
                        <div class="text-center"><div class="text-4xl font-black text-gray-800">NRT</div><div class="text-xs text-gray-400 font-bold mt-1">20:40</div></div>
                        <div class="text-center flex flex-col items-center"><i class="fa-solid fa-plane text-green-300 text-xl transform -rotate-45 mb-1"></i><div class="w-16 h-[2px] bg-green-100"></div></div>
                        <div class="text-center"><div class="text-4xl font-black text-gray-800">TPE</div><div class="text-xs text-gray-400 font-bold mt-1">23:20</div></div>
                    </div>
                </div>
            </div>
            <div>
                <h3 class="font-black text-gray-500 mb-3 ml-2 text-sm uppercase tracking-wider">Transport</h3>
                <div class="boarding-pass !border-l-[6px] !border-l-red-500">
                    <div class="bg-gray-50 p-4 flex justify-between items-center border-b border-dashed"><span class="font-black text-gray-700 text-lg">å¯Œå£«å›éŠ 3å·</span><span class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm">æŒ‡å®šå¸­</span></div>
                    <div class="p-6">
                        <div class="flex justify-between items-end mb-6">
                            <div><div class="text-xs text-gray-400 font-bold mb-1">éŒ¦ç³¸ç”º Kinshicho</div><div class="text-4xl font-black text-gray-800">07:08</div></div>
                            <div class="pb-3 text-gray-300"><i class="fa-solid fa-arrow-right-long text-xl"></i></div>
                            <div class="text-right"><div class="text-xs text-gray-400 font-bold mb-1">æ²³å£æ¹– Kawaguchiko</div><div class="text-4xl font-black text-gray-800">09:28</div></div>
                        </div>
                        <div class="text-xs text-gray-600 bg-red-50 p-3 rounded-xl border border-red-100 font-bold flex items-start gap-2"><i class="fa-solid fa-circle-info text-red-400 mt-0.5"></i> <span>è«‹å‹™å¿…æå‰ä¸€å€‹æœˆåœ¨ JR å®˜ç¶²é ç´„ï¼Œæ­¤ç­æ¬¡ç‚ºå…¨è»ŠæŒ‡å®šå¸­ï¼Œç„¡ç¥¨ç„¡æ³•ä¸Šè»Šã€‚</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="currentView==='prep'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="flex gap-2 mb-6 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm"><button @click="prepTab='personal'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',prepTab==='personal'?'bg-pink-400 text-white shadow-md':'text-gray-400 hover:bg-white/50']">è¡Œææ¸…å–®</button><button @click="prepTab='car'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',prepTab==='car'?'bg-green-400 text-white shadow-md':'text-gray-400 hover:bg-white/50']">ç§Ÿè»Šè³‡è¨Š</button></div>
        <div v-if="prepTab==='personal'">
            <div v-if="prepMode==='select'" class="grid grid-cols-2 gap-4">
                <div v-for="user in users" :key="user.id" class="card p-5 cursor-pointer relative active:scale-95 transition" @click="selectPrepUser(user.id)">
                     <div class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center text-2xl overflow-hidden border-2 border-white shadow mb-3"><img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover"><span v-else>{{user.icon}}</span></div>
                     <div class="font-black text-gray-700 mb-2">{{user.name}}</div>
                     <div class="h-2.5 w-full bg-gray-100 rounded-full overflow-hidden inner-shadow"><div class="h-full bg-gradient-to-r from-pink-300 to-pink-500 transition-all duration-1000" :style="{width: getProgress(user.id)+'%'}"></div></div>
                     <div class="text-right text-[10px] text-gray-400 mt-1 font-bold">{{Math.round(getProgress(user.id))}}% å®Œæˆ</div>
                </div>
            </div>
            <div v-else>
                 <div class="flex items-center gap-3 mb-4"><button @click="prepMode='select'" class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-gray-500 active:scale-90 transition"><i class="fa-solid fa-arrow-left"></i></button><h3 class="font-black text-xl text-gray-700">{{getUserById(prepUser).name}} çš„æ¸…å–®</h3></div>
                 <div class="card p-0 overflow-hidden border-0">
                    <div class="bg-pink-50 p-4 border-b border-pink-100 flex justify-between items-center"><span class="font-bold text-pink-500 text-sm">æª¢æŸ¥é …ç›®</span><button @click="addPrepItem" class="text-xs bg-white text-pink-500 px-3 py-1.5 rounded-full border border-pink-200 font-bold shadow-sm active:scale-90 transition">+ æ–°å¢</button></div>
                    <div class="max-h-[60vh] overflow-y-auto p-2 divide-y divide-gray-100">
                        <div v-for="(item,idx) in currentPrepList" :key="idx" class="flex items-center gap-4 p-4 hover:bg-gray-50 transition rounded-xl">
                            <input type="checkbox" v-model="item.checked" class="w-6 h-6 accent-pink-500 rounded-lg cursor-pointer">
                            <input v-model="item.text" class="flex-1 text-base bg-transparent outline-none font-bold text-gray-700 placeholder-gray-300" :class="{'line-through text-gray-300':item.checked}">
                            <button @click="currentPrepList.splice(idx,1)" class="text-gray-300 hover:text-red-400 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
        <div v-if="prepTab==='car'" class="card p-6 border-l-[6px] border-green-500">
            <h3 class="font-black text-xl mb-4 text-gray-700 flex items-center gap-2"><i class="fa-solid fa-car text-green-500"></i> è‡ªé§•å¿…å‚™ Check</h3>
            <ul class="space-y-3">
                <li class="flex items-center gap-3 bg-green-50 p-3 rounded-xl"><i class="fa-solid fa-check text-green-500"></i> <span class="text-sm font-bold text-gray-700">å°ç£é§•ç…§ (æ­£æœ¬)</span></li>
                <li class="flex items-center gap-3 bg-green-50 p-3 rounded-xl"><i class="fa-solid fa-check text-green-500"></i> <span class="text-sm font-bold text-gray-700">æ—¥æ–‡è­¯æœ¬ (ç›£ç†æ‰€ç”³è«‹)</span></li>
                <li class="flex items-center gap-3 bg-green-50 p-3 rounded-xl"><i class="fa-solid fa-check text-green-500"></i> <span class="text-sm font-bold text-gray-700">è­·ç…§ (æ­£æœ¬)</span></li>
                <li class="flex items-center gap-3 bg-white border border-green-100 p-3 rounded-xl"><i class="fa-solid fa-location-dot text-red-400"></i> <span class="text-sm font-bold text-gray-500">å–è»Šï¼šæ²³å£æ¹–ç«™å‰ Toyota</span></li>
            </ul>
        </div>
    </div>

    <div v-if="['food','shopping','photo'].includes(currentView)" class="px-5 py-4 pb-40 animate-fade-in">
        <div v-if="currentView==='food'" class="flex gap-3 mb-6 overflow-x-auto hide-scrollbar pb-2"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="foodLoc=loc" :class="['px-6 py-2.5 rounded-full text-sm font-black shadow-sm transition whitespace-nowrap border',foodLoc===loc?'bg-orange-400 text-white border-orange-400':'bg-white text-gray-400 border-white']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc]}}</button></div>
        <div v-if="currentView==='shopping'" class="flex gap-3 mb-6 overflow-x-auto hide-scrollbar pb-2"><button v-for="cat in ['wish','cosme','ldk','souvenir']" @click="shopCat=cat" :class="['px-6 py-2.5 rounded-full text-sm font-black shadow-sm transition whitespace-nowrap border',shopCat===cat?'bg-pink-400 text-white border-pink-400':'bg-white text-gray-400 border-white']">{{{'wish':'é¡˜æœ›','cosme':'è—¥å¦','ldk':'LDK','souvenir':'ä¼´æ‰‹ç¦®'}[cat]}}</button></div>
        <div v-if="currentView==='photo'" class="flex gap-3 mb-6 overflow-x-auto hide-scrollbar pb-2"><button v-for="area in ['Tokyo','Kamakura','Fuji']" @click="photoArea=area" :class="['px-6 py-2.5 rounded-full text-sm font-black shadow-sm transition whitespace-nowrap border',photoArea===area?'bg-rose-400 text-white border-rose-400':'bg-white text-gray-400 border-white']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[area]}}</button></div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div v-for="(item,idx) in getCurrentList()" :key="item.id||idx" class="card !p-0 overflow-hidden hover:shadow-2xl transition duration-300 group border-none">
                <div class="h-52 relative bg-gray-100 cursor-pointer overflow-hidden" @click="openImage(item.img)">
                    <img :src="getImg(item.img)" class="w-full h-full object-cover transition duration-700 group-hover:scale-110" @error="handleImgError">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-60"></div>
                    <div class="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition duration-300"><button @click.stop="editCommonItem(item,idx)" class="w-9 h-9 bg-white rounded-full flex items-center justify-center shadow-lg text-blue-500 hover:scale-110 transition"><i class="fa-solid fa-pen"></i></button><button @click.stop="deleteCommonItem(idx)" class="w-9 h-9 bg-white rounded-full flex items-center justify-center shadow-lg text-red-500 hover:scale-110 transition"><i class="fa-solid fa-trash"></i></button></div>
                </div>
                <div class="p-5 relative -mt-6 bg-white/95 backdrop-blur-md rounded-t-3xl mx-2 shadow-inner">
                    <h3 class="font-black text-xl text-gray-800 mb-1 tracking-wide">{{item.name}}</h3>
                    <p class="text-sm text-gray-500 mb-4 font-medium line-clamp-1">{{item.desc}}</p>
                    <a :href="item.link" target="_blank" class="block text-center bg-gray-50 text-gray-600 hover:bg-gray-800 hover:text-white font-bold py-3 rounded-xl text-sm border border-gray-100 transition active:scale-95"><i :class="currentView==='shopping'?'fa-solid fa-magnifying-glass':'fa-solid fa-location-arrow'"></i> {{currentView==='shopping'?'æœå°‹å•†å“ / å®˜ç¶²':'å°èˆªå‰å¾€'}}</a>
                </div>
            </div>
        </div>
        <button @click="openAddCommonModal(currentView)" class="fab-main hover:rotate-90 transition"><i class="fa-solid fa-plus"></i></button>
    </div>

    <div v-if="currentView==='weather'" class="px-5 py-4 pb-40 animate-fade-in">
         <div class="mb-5 bg-pink-50/80 backdrop-blur p-5 rounded-[30px] border border-pink-200 shadow-sm">
             <div class="flex items-center gap-3 mb-3"><i class="fa-solid fa-fan text-pink-400 animate-spin-slow text-xl"></i><span class="font-black text-pink-600 text-lg">2026 æ«»èŠ±é æ¸¬</span></div>
             <div class="grid grid-cols-2 gap-3">
                 <a href="https://n-kishou.com/corp/news-contents/sakura/" target="_blank" class="bg-white py-3 rounded-xl text-center text-xs font-bold text-pink-500 shadow-sm border border-pink-100 active:scale-95 transition">æ°£è±¡æ ªå¼æœƒç¤¾</a>
                 <a href="https://weathernews.jp/s/sakura/" target="_blank" class="bg-white py-3 rounded-xl text-center text-xs font-bold text-blue-500 shadow-sm border border-blue-100 active:scale-95 transition">Weathernews</a>
             </div>
         </div>
         <div class="mb-6 bg-gradient-to-br from-blue-400 to-sky-300 p-8 rounded-[32px] shadow-xl text-white relative overflow-hidden group">
             <i class="fa-solid fa-cloud-sun text-[150px] absolute -right-8 -bottom-8 opacity-20 group-hover:scale-110 transition duration-700"></i>
             <div class="relative z-10">
                <div class="text-sm font-bold opacity-80 mb-2 uppercase tracking-widest">Tokyo Forecast</div>
                <div class="text-6xl font-black mb-4">{{tokyoWeather.temp}}<span class="text-4xl align-top">Â°C</span></div>
                <div class="text-base font-bold bg-white/20 backdrop-blur inline-block px-4 py-2 rounded-full border border-white/30">ğŸ’¡ ç©¿æ­ï¼š{{getClothingAdvice(tokyoWeather.temp)}}</div>
            </div>
         </div>
         <div class="space-y-4">
            <div v-for="w in [{t:'éŒå€‰ Kamakura',d:kamakuraWeather},{t:'å¯Œå£«å±± Mt.Fuji',d:fujiWeather}]" class="card p-6 flex items-center justify-between hover:bg-white transition cursor-pointer">
                <div><div class="font-bold text-gray-400 text-xs uppercase tracking-wider mb-1">{{w.t}}</div><div class="text-3xl font-black text-gray-800">{{w.d.temp}}Â°C</div></div>
                <div class="text-4xl text-gray-200"><i class="fa-solid fa-temperature-half"></i></div>
            </div>
         </div>
    </div>

    <div v-if="currentView==='japanese'" class="px-5 py-4 pb-40 animate-fade-in">
        <button @click="openCamera" class="w-full bg-black rounded-[32px] p-1 text-white text-center mb-6 shadow-2xl active:scale-95 transition overflow-hidden group">
            <div class="bg-gray-900 rounded-[28px] p-8 border border-gray-700 relative overflow-hidden">
                <i class="fa-solid fa-camera text-7xl text-white absolute right-4 bottom-4 opacity-10 group-hover:opacity-20 transition group-hover:scale-110"></i>
                <div class="text-left relative z-10">
                    <div class="text-xs text-yellow-400 font-bold mb-2 tracking-widest border border-yellow-400 inline-block px-2 py-0.5 rounded">AI LENS</div>
                    <h3 class="font-black text-3xl mb-1">æ‹ç…§ç¿»è­¯</h3>
                    <p class="text-gray-400 text-sm">é»æ“Šå•Ÿå‹•ç›¸æ©Ÿ (æ¨¡æ“¬)</p>
                </div>
            </div>
        </button>
        <div class="grid grid-cols-3 gap-3 mb-8">
            <a href="tel:110" class="bg-red-50 text-red-500 p-4 rounded-2xl text-center font-black text-sm border border-red-100 active:scale-95 transition shadow-sm"><i class="fa-solid fa-phone mb-2 text-xl block"></i> 110</a>
            <a href="tel:119" class="bg-red-50 text-red-500 p-4 rounded-2xl text-center font-black text-sm border border-red-100 active:scale-95 transition shadow-sm"><i class="fa-solid fa-fire-extinguisher mb-2 text-xl block"></i> 119</a>
            <a href="tel:+81-3-3280-7917" class="bg-blue-50 text-blue-500 p-4 rounded-2xl text-center font-black text-sm border border-blue-100 active:scale-95 transition shadow-sm"><i class="fa-solid fa-passport mb-2 text-xl block"></i> ä»£è¡¨è™•</a>
        </div>
        <div class="space-y-3">
            <div v-for="(phrase,idx) in japanesePhrases" :key="idx" @click="speak(phrase.jp)" class="card p-5 flex justify-between items-center cursor-pointer active:bg-gray-50 hover:shadow-md transition border-l-[6px] border-l-emerald-400 !rounded-r-2xl !rounded-l-md">
                <div><div class="font-black text-xl text-gray-800 mb-1">{{phrase.jp}}</div><div class="text-xs text-gray-500 font-bold">{{phrase.tw}}</div></div>
                <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-500 flex items-center justify-center"><i class="fa-solid fa-volume-high"></i></div>
            </div>
        </div>
    </div>
    
    <div v-if="currentView==='itinerary'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="flex overflow-x-auto gap-3 mb-6 hide-scrollbar sticky top-[68px] bg-[#FFF0F5]/95 z-20 py-3 -mx-5 px-5 backdrop-blur-md">
             <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-6 py-3 rounded-2xl text-sm font-black border-2 transition shrink-0 shadow-sm flex flex-col items-center min-w-[70px]',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400 shadow-lg scale-105':'bg-white text-gray-300 border-white']"><span>{{d.week}}</span><span class="text-[10px] mt-1 opacity-80">{{d.title}}</span></button>
        </div>
        
        <div v-if="[2,3,4].includes(selectedDayIndex)" class="mb-6 flex justify-center">
            <div class="bg-white p-1.5 rounded-full border border-gray-200 flex shadow-sm">
                <button @click="itineraryMode='normal'" :class="['px-6 py-2 rounded-full text-xs font-black transition', itineraryMode==='normal'?'bg-pink-400 text-white shadow':'text-gray-400']">ä¸€èˆ¬è¡Œç¨‹</button>
                <button @click="itineraryMode='drive'" :class="['px-6 py-2 rounded-full text-xs font-black transition', itineraryMode==='drive'?'bg-green-500 text-white shadow':'text-gray-400']"><i class="fa-solid fa-car mr-1"></i> è‡ªé§•åœ°åœ–</button>
            </div>
        </div>

        <div v-if="itineraryMode==='drive' && [2,3,4].includes(selectedDayIndex)" class="animate-fade-in space-y-4">
             <div class="bg-green-50 border border-green-200 p-5 rounded-3xl flex items-start gap-3 shadow-sm">
                <i class="fa-solid fa-circle-info text-green-500 mt-1 text-xl"></i>
                <div><h3 class="font-black text-green-800 text-base">ä»Šæ—¥é§•é§›é‡é»</h3><p class="text-xs text-green-600 mt-1 font-bold">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¯ç›´æ¥é–‹å•Ÿ Google Maps å°èˆªã€‚</p></div>
            </div>
            <div class="pl-6 border-l-4 border-green-200 space-y-8 py-4 ml-2">
                <div v-for="(stop, sIdx) in getDrivePlanForDay(selectedDayIndex)" :key="sIdx" class="card p-6 relative !overflow-visible !mb-0 shadow-lg">
                     <div class="absolute -left-[35px] top-6 w-5 h-5 rounded-full border-4 border-green-400 bg-white z-10 shadow"></div>
                     <div class="flex justify-between items-start gap-3">
                         <div><h5 class="font-black text-gray-800 text-xl">{{stop.name}}</h5><p class="text-sm text-gray-500 mt-2 font-bold">{{stop.note}}</p></div>
                         <div class="flex flex-col gap-3 shrink-0">
                             <a :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.location)}`" target="_blank" class="bg-blue-50 text-blue-600 px-5 py-2.5 rounded-xl text-xs font-black border border-blue-100 flex items-center gap-2 hover:bg-blue-100 active:scale-95 transition"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                             <a v-if="stop.parking" :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.parking)}`" target="_blank" class="bg-green-50 text-green-600 px-5 py-2.5 rounded-xl text-xs font-black border border-green-200 flex items-center gap-2 hover:bg-green-100 active:scale-95 transition"><i class="fa-solid fa-square-parking"></i> åœè»Š</a>
                         </div>
                     </div>
                </div>
            </div>
        </div>

        <div v-else class="space-y-4">
            <div v-for="(item,idx) in currentItinerary" :key="idx" class="card p-5 border-0 shadow-sm relative group cursor-pointer active:scale-[0.98] transition" @click="editItem(item,idx)">
                <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-pink-300 to-pink-100 group-hover:w-2 transition-all"></div>
                <div class="flex gap-5">
                    <div class="flex flex-col items-center pt-1 min-w-[50px]">
                        <span class="text-xs font-black text-gray-400 mb-2">{{item.hours}}</span>
                        <div class="w-10 h-10 rounded-full bg-pink-50 text-pink-400 flex items-center justify-center text-lg border border-pink-100"><i :class="getIconByCategory(item.category)"></i></div>
                    </div>
                    <div class="flex-1 py-1">
                        <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                        <p class="text-sm text-gray-500 line-clamp-2 font-medium">{{item.note}}</p>
                    </div>
                    <div class="flex items-center text-gray-300"><i class="fa-solid fa-chevron-right text-xs"></i></div>
                </div>
            </div>
            <button @click="openAddModal" class="fab-main hover:rotate-90 transition"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <div v-show="currentView!=='menu'" class="fab-home" @click="currentView='menu'" @touchstart.prevent="startDrag" @mousedown.prevent="startDrag"><i class="fa-solid fa-house"></i></div>

    <div v-if="showCommonModal" class="fixed inset-0 bg-black/60 z-[1000] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in"><div class="bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-2 bg-pink-400"></div><h3 class="font-black text-2xl mb-6 text-center text-gray-700">{{isEditing?'ç·¨è¼¯é …ç›®':'æ–°å¢æ”¶è—'}}</h3><input v-model="newCommon.text1" placeholder="åç¨±" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 outline-none border border-transparent focus:border-pink-300 font-bold transition"><textarea v-if="currentView!=='japanese'" v-model="newCommon.text2" class="w-full p-4 bg-gray-50 rounded-2xl h-28 mb-4 outline-none border border-transparent focus:border-pink-300 resize-none font-medium text-sm transition" placeholder="æè¿°..."></textarea><input v-if="currentView==='food' || currentView==='photo'" v-model="newCommon.link" placeholder="Google åœ°åœ–é€£çµ (ç•™ç©ºè‡ªå‹•ç”Ÿæˆ)" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 outline-none border border-transparent focus:border-pink-300 text-xs font-bold transition"><input v-if="currentView==='shopping'" v-model="newCommon.link" placeholder="å®˜æ–¹ç¶²ç«™é€£çµ (ç•™ç©ºè‡ªå‹•ç”Ÿæˆæœå°‹)" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 outline-none border border-transparent focus:border-pink-300 text-xs font-bold transition"><div v-if="currentView!=='japanese'" class="flex items-center gap-4 mb-6"><div class="w-20 h-20 bg-gray-100 rounded-2xl flex items-center justify-center border border-gray-200 overflow-hidden shrink-0"><img v-if="newCommon.text3" :src="newCommon.text3" class="w-full h-full object-cover"><i v-else class="fa-solid fa-image text-gray-300 text-2xl"></i></div><button @click="$refs.commonImageInput.click()" class="flex-1 bg-blue-50 text-blue-500 h-14 rounded-2xl font-black border border-blue-100 active:scale-95 transition">ä¸Šå‚³åœ–ç‰‡</button></div><div class="flex gap-4"><button @click="showCommonModal=false" class="flex-1 bg-gray-100 py-4 rounded-2xl font-black text-gray-500 active:scale-95 transition">å–æ¶ˆ</button><button @click="saveCommonItem" class="flex-1 bg-pink-400 text-white py-4 rounded-2xl font-black shadow-lg shadow-pink-200 active:scale-95 transition">å„²å­˜</button></div></div></div>
    
    <div v-if="showUserModal" class="fixed inset-0 bg-black/60 z-[1000] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in"><div class="bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl text-center"><h3 class="font-black text-2xl mb-6 text-gray-700">ç·¨è¼¯æˆå“¡</h3><div class="w-28 h-28 mx-auto bg-gray-100 rounded-full mb-6 relative border-[6px] border-gray-50 shadow-inner overflow-hidden group cursor-pointer" @click="triggerAvatarUpload"><img v-if="editingUser.avatar" :src="editingUser.avatar" class="w-full h-full object-cover"><div v-else class="w-full h-full flex items-center justify-center text-5xl">{{editingUser.icon}}</div><div class="absolute inset-0 bg-black/40 flex items-center justify-center text-white text-sm font-bold opacity-0 group-hover:opacity-100 transition">æ›´æ›å¤§é ­è²¼</div></div><input v-model="editingUser.name" class="w-full p-4 bg-gray-50 rounded-2xl mb-6 text-center font-black outline-none border focus:border-blue-300 text-lg transition" placeholder="åå­—"><div class="flex gap-4"><button @click="showUserModal=false" class="flex-1 bg-gray-100 py-4 rounded-2xl font-black text-gray-500 active:scale-95 transition">å–æ¶ˆ</button><button @click="saveUserEdit" class="flex-1 bg-pink-400 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition">å„²å­˜</button></div></div></div>
    
    <div v-if="showModal" class="fixed inset-0 bg-black/60 z-[1000] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in"><div class="bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-2 bg-pink-400"></div><h3 class="font-black text-2xl mb-6 text-center text-gray-700">{{isEditing?'ç·¨è¼¯è¡Œç¨‹':'æ–°å¢è¡Œç¨‹'}}</h3><input v-model="editForm.name" placeholder="è¡Œç¨‹åç¨±" class="w-full p-4 bg-gray-50 rounded-2xl mb-3 outline-none border border-transparent focus:border-pink-300 font-black transition text-lg"><div class="flex gap-3 mb-3"><input v-model="editForm.hours" placeholder="00:00" class="w-1/3 p-4 bg-gray-50 rounded-2xl outline-none border border-transparent focus:border-pink-300 font-bold text-center"><div class="relative flex-1"><select v-model="editForm.category" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border border-transparent focus:border-pink-300 font-bold appearance-none"><option value="Sightseeing">ğŸ“¸ æ™¯é»</option><option value="Food">ğŸ´ ç¾é£Ÿ</option><option value="Shopping">ğŸ›ï¸ è³¼ç‰©</option><option value="Transport">ğŸš„ äº¤é€š</option><option value="Flight">âœˆï¸ èˆªç­</option><option value="Hotel">ğŸ¨ ä½å®¿</option></select><i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i></div></div><input v-model="editForm.mapKeyword" placeholder="åœ°åœ–æœå°‹é—œéµå­— (ä¾‹å¦‚: æ±äº¬éµå¡”)" class="w-full p-4 bg-gray-50 rounded-2xl mb-3 outline-none border border-transparent focus:border-pink-300 font-bold text-sm"><textarea v-model="editForm.note" class="w-full p-4 bg-gray-50 rounded-2xl h-28 mb-6 outline-none border border-transparent focus:border-pink-300 resize-none font-medium text-sm" placeholder="å‚™è¨»..."></textarea><div class="flex gap-4"><button v-if="isEditing" @click="deleteItem(editIndex);showModal=false" class="px-4 bg-red-50 text-red-400 rounded-2xl font-bold"><i class="fa-solid fa-trash"></i></button><button @click="showModal=false" class="flex-1 bg-gray-100 py-4 rounded-2xl font-black text-gray-500 active:scale-95 transition">å–æ¶ˆ</button><button @click="saveItem" class="flex-1 bg-pink-400 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition">å„²å­˜</button></div></div></div>
    
    <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 z-[1000] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in"><div class="bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-2 bg-yellow-400"></div><h3 class="font-black text-2xl mb-6 text-center text-gray-700">è¨˜ä¸€ç­†</h3><input v-model="newExpense.name" placeholder="æ¶ˆè²»é …ç›®" class="w-full p-4 bg-gray-50 rounded-2xl mb-3 outline-none border border-transparent focus:border-yellow-400 font-black text-lg transition"><div class="flex gap-3 mb-3"><input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡" class="flex-1 p-4 bg-gray-50 rounded-2xl outline-none border border-transparent focus:border-yellow-400 text-2xl font-black transition text-gray-800"><div class="w-20 flex items-center justify-center bg-gray-100 rounded-2xl font-black text-gray-400">JPY</div></div><div class="mb-6"><label class="text-xs text-gray-400 font-bold ml-1 mb-2 block">{{expenseType==='group'?'èª°å…ˆå¢Šä»˜?':'èª°èŠ±çš„?'}}</label><div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar"><button v-for="u in users" :key="u.id" @click="currentUserId=u.id" :class="['px-5 py-3 rounded-xl text-xs font-black border-2 transition shrink-0',currentUserId===u.id?'bg-yellow-400 border-yellow-400 text-white shadow-md scale-105':'bg-white border-gray-100 text-gray-400']">{{u.name}}</button></div></div><div class="flex gap-4"><button @click="showExpenseModal=false" class="flex-1 bg-gray-100 py-4 rounded-2xl font-black text-gray-500 active:scale-95 transition">å–æ¶ˆ</button><button @click="addExpense" class="flex-1 bg-yellow-400 text-white py-4 rounded-2xl font-black shadow-lg shadow-yellow-200 active:scale-95 transition">å„²å­˜</button></div></div></div>
    
    <div v-if="showSyncModal" class="fixed inset-0 bg-black/60 z-[1000] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in"><div class="bg-white w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative"><button @click="showSyncModal=false" class="absolute top-4 right-4 text-gray-300 w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button><h3 class="font-black text-xl mb-6 text-center text-gray-700">è¨­å®šèˆ‡å‚™ä»½</h3><button @click="isWelcomeClosed=false;showSyncModal=false" class="w-full py-4 bg-gray-50 text-gray-600 rounded-2xl font-bold mb-3 border border-gray-100 active:scale-95 transition hover:bg-gray-100">å›åˆ°æ­¡è¿é </button><button @click="saveAsHtml" class="w-full py-4 bg-blue-500 text-white rounded-2xl font-bold mb-3 shadow-md shadow-blue-200 active:scale-95 transition flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> ä¸‹è¼‰å‚™ä»½ (HTML)</button><button @click="resetItinerary" class="w-full py-4 bg-red-50 text-red-500 rounded-2xl font-bold border border-red-100 active:scale-95 transition">é‡ç½®æ‰€æœ‰è³‡æ–™</button></div></div>

    <input type="file" ref="commonImageInput" accept="image/*" class="hidden" @change="processCommonImageUpload">
    <input type="file" ref="avatarInput" accept="image/*" class="hidden" @change="processAvatarUpload">
</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;
const sc = document.getElementById('sakura-container'); for(let i=0;i<15;i++){let e=document.createElement('div');e.className='sakura';e.style.left=Math.random()*100+'vw';e.style.animationDuration=Math.random()*3+6+'s';e.style.animationDelay=Math.random()*5+'s';sc.appendChild(e)}

createApp({
    setup() {
        const STORAGE_KEY = 'V17_FLAGSHIP'; // å‡ç´š Key ä»¥ç¢ºä¿æ•¸æ“šçµæ§‹æ›´æ–°
        const currentView = ref('menu');
        const isWelcomeClosed = ref(false);
        const showGoogleSearch = ref(false);
        
        // --- æ ¸å¿ƒè³‡æ–™åº« ---
        const defaultItinerary = [
            [
                {"id": 101, "category": "Flight", "name": "06:40 æ¡ƒåœ’èµ·é£› (TR898)", "hours": "06:40", "mapKeyword": "Taoyuan Airport", "note": "T1èˆªå»ˆï¼Œææ—©2.5å°æ™‚æŠµé”"},
                {"id": 102, "category": "Flight", "name": "10:40 æŠµé”æˆç”° (NRT)", "hours": "10:40", "mapKeyword": "Narita Airport", "note": "å…¥å¢ƒå¯©æŸ¥ -> é ˜è¡Œæ -> æ­è»Š"},
                {"id": 103, "category": "Transport", "name": "å‰å¾€éŒ¦ç³¸ç”ºæ°‘å®¿", "hours": "12:30", "mapKeyword": "Kinshicho Station", "note": "å¯„æ”¾è¡Œæ (é€£çµè«‹è¦‹ä½å®¿é )"},
                {"id": 104, "category": "Sightseeing", "name": "æ™´ç©ºå¡” Solamachi", "hours": "14:00", "mapKeyword": "Tokyo Skytree", "note": "é€›è¡—/æ°´æ—é¤¨"},
                {"id": 105, "category": "Food", "name": "æ™šé¤ï¼šæ•˜æ•˜è‹‘ç‡’è‚‰", "hours": "18:00", "mapKeyword": "Jojoen Skytree", "note": "é«˜ç©ºæ™¯è§€ç‡’è‚‰"}
            ],
            [
                {"id": 201, "category": "Sightseeing", "name": "æ·ºè‰å¯º & é›·é–€", "hours": "09:00", "mapKeyword": "Senso-ji", "note": "è¶æ—©å»é¿é–‹äººæ½®"},
                {"id": 202, "category": "Food", "name": "åˆé¤ï¼šæ·ºè‰ä»ŠåŠ", "hours": "12:00", "mapKeyword": "Asakusa Imahan", "note": "å£½å–œç‡’è€åº—"},
                {"id": 203, "category": "Sightseeing", "name": "ä¸Šé‡æ©è³œå…¬åœ’", "hours": "14:00", "mapKeyword": "Ueno Park", "note": "è³æ«»ç†±é»"},
                {"id": 204, "category": "Shopping", "name": "é˜¿ç¾æ©«ç”º", "hours": "16:00", "mapKeyword": "Ameyoko", "note": "è—¥å¦/é›¶é£Ÿæ¡è²·"},
                {"id": 205, "category": "Food", "name": "æ™šé¤ï¼šé³¥è²´æ—", "hours": "19:00", "mapKeyword": "Torikizoku Ueno", "note": "å¹³åƒ¹ä¸²ç‡’"}
            ],
            [
                {"id": 301, "category": "Transport", "name": "å¯Œå£«å›éŠ3è™Ÿ (ç›´é”)", "hours": "07:08", "mapKeyword": "Kinshicho Station", "note": "æ¯æ—¥å”¯ä¸€ç­æ¬¡ï¼ŒéŒ¦ç³¸ç”ºç›´é”æ²³å£æ¹–"},
                {"id": 302, "category": "Transport", "name": "æŠµé”æ²³å£æ¹–ç«™", "hours": "09:28", "mapKeyword": "Kawaguchiko Station", "note": "å‡ºç«™å‰å¾€å–è»Š"},
                {"id": 303, "category": "Transport", "name": "Toyota Rent a Car", "hours": "09:40", "mapKeyword": "Toyota Rent a Car Kawaguchiko Station", "note": "ç«™å‰åº—å–è»Š"},
                {"id": 304, "category": "Sightseeing", "name": "æ–°å€‰å±±æ·ºé–“å…¬åœ’", "hours": "10:30", "mapKeyword": "Chureito Pagoda", "note": "ä¸Šåˆé †å…‰æ‹äº”é‡å¡”"},
                {"id": 305, "category": "Food", "name": "åˆé¤ï¼šä¸å‹•èŒ¶å±‹ (æ±æˆ€è·¯)", "hours": "12:30", "mapKeyword": "Houtou Fudou Higashikoiji", "note": "æ±æˆ€è·¯åº—ï¼Œé›²æœµå»ºç¯‰"},
                {"id": 306, "category": "Sightseeing", "name": "æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨", "hours": "14:30", "mapKeyword": "Oishi Park", "note": "å¤§çŸ³å…¬åœ’è³èŠ±"},
                {"id": 307, "category": "Sightseeing", "name": "ä¸‹å‰ç”°æœ¬ç”ºé€š", "hours": "17:00", "mapKeyword": "Honcho Street Fujiyoshida", "note": "æ˜­å’Œå¾©å¤è¡—æ™¯"},
                {"id": 308, "category": "Hotel", "name": "Check-in: Megu Fuji", "hours": "18:30", "mapKeyword": "Megu Fuji 2021", "note": "å…¥ä½ä¼‘æ¯"}
            ],
            [
                {"id": 401, "category": "Sightseeing", "name": "å±±ä¸­æ¹–å¹³é‡ä¹‹æ¿±", "hours": "06:00", "mapKeyword": "Hirano no Hama", "note": "çœ‹é€†å¯Œå£«æ—¥å‡º"},
                {"id": 402, "category": "Sightseeing", "name": "é•·æ± è¦ªæ°´å…¬åœ’", "hours": "09:00", "mapKeyword": "Nagaike Water Park", "note": "é¤µå¤©éµ/æ‹å¯Œå£«å±±"},
                {"id": 403, "category": "Sightseeing", "name": "å¿é‡å…«æµ·", "hours": "11:00", "mapKeyword": "Oshino Hakkai", "note": "åæ°´ç™¾é¸"},
                {"id": 404, "category": "Food", "name": "åˆé¤ï¼šå±±éº“åœ’", "hours": "13:00", "mapKeyword": "Sanrokuen", "note": "çˆç«¯ç‡’é«”é©—"},
                {"id": 405, "category": "Sightseeing", "name": "KABA æ°´é™¸å·´å£«", "hours": "15:00", "mapKeyword": "Yamanakako KABA", "note": "éŠæ¹–é«”é©—"},
                {"id": 406, "category": "Shopping", "name": "Ogino è¶…å¸‚", "hours": "17:00", "mapKeyword": "Ogino Kawaguchiko", "note": "æ¡è²·æ™šé¤é£Ÿæ"}
            ],
            [
                {"id": 501, "category": "Sightseeing", "name": "æ²³å£æ¹–çºœè»Š / ç›ªé¦éŸ†", "hours": "09:00", "mapKeyword": "Mt. Fuji Panoramic Ropeway", "note": "çµ•æ™¯é¦éŸ†"},
                {"id": 502, "category": "Shopping", "name": "å¯Œå£«å±±åå¸", "hours": "11:00", "mapKeyword": "Fujisan Shokupan", "note": "ä¼´æ‰‹ç¦®"},
                {"id": 503, "category": "Transport", "name": "æ²³å£æ¹–ç«™é‚„è»Š", "hours": "13:30", "mapKeyword": "Toyota Rent a Car Kawaguchiko Station", "note": "çµæŸè‡ªé§•"},
                {"id": 504, "category": "Transport", "name": "è¿”å›æ–°å®¿ (å·´å£«/éµè·¯)", "hours": "14:00", "mapKeyword": "Shinjuku Station", "note": "æ­ä¹˜é«˜é€Ÿå·´å£«æˆ–é›»è»Š"},
                {"id": 505, "category": "Hotel", "name": "Check-in: DOMO Hotel", "hours": "16:30", "mapKeyword": "DOMO Hotel Shinjuku", "note": "å…¥ä½æ–°å®¿"},
                {"id": 506, "category": "Food", "name": "æ™šé¤/é€›è¡—ï¼šæ± è¢‹å¤ªé™½åŸ", "hours": "18:00", "mapKeyword": "Sunshine City", "note": "å¯¶å¯å¤¢ä¸­å¿ƒ"}
            ],
            [
                {"id": 601, "category": "Transport", "name": "æ­ä¹˜æ±Ÿä¹‹é›»", "hours": "09:00", "mapKeyword": "Fujisawa Station", "note": "å‰å¾€éŒå€‰"},
                {"id": 602, "category": "Sightseeing", "name": "éŒå€‰é«˜æ ¡å‰", "hours": "10:00", "mapKeyword": "Kamakura Kokomae", "note": "çŒç±ƒé«˜æ‰‹å¹³äº¤é“"},
                {"id": 603, "category": "Food", "name": "åˆé¤ï¼šBills", "hours": "12:00", "mapKeyword": "Bills Shichirigahama", "note": "æµ·é‚Šé¬†é¤…"},
                {"id": 604, "category": "Sightseeing", "name": "éŒå€‰å¤§ä½› & é•·è°·å¯º", "hours": "14:00", "mapKeyword": "Kotoku-in", "note": "åƒæ‹œ"},
                {"id": 605, "category": "Sightseeing", "name": "æ±Ÿä¹‹å³¶å¤•é™½", "hours": "17:00", "mapKeyword": "Enoshima Sea Candle", "note": "ç¨šå…’ä¹‹æ·µ"},
                {"id": 606, "category": "Food", "name": "æ™šé¤ï¼šæ–°å®¿æ­Œèˆä¼ç”º", "hours": "19:30", "mapKeyword": "Kabukicho", "note": "å±…é…’å±‹"}
            ],
            [
                {"id": 701, "category": "Sightseeing", "name": "æ±äº¬éµå¡”", "hours": "10:00", "mapKeyword": "Tokyo Tower", "note": "èŠå…¬åœ’é‡é¤"},
                {"id": 702, "category": "Sightseeing", "name": "éº»å¸ƒå°ä¹‹ä¸˜", "hours": "13:00", "mapKeyword": "Azabudai Hills", "note": "æ–°åœ°æ¨™é€›è¡—"},
                {"id": 703, "category": "Shopping", "name": "æ¾€è°· Parco / Loft", "hours": "15:00", "mapKeyword": "Shibuya Parco", "note": "ä»»å¤©å ‚/å¯¶å¯å¤¢ä¸­å¿ƒ"},
                {"id": 704, "category": "Sightseeing", "name": "SHIBUYA SKY", "hours": "17:30", "mapKeyword": "SHIBUYA SKY", "note": "é ç´„å¤•é™½æ™‚æ®µ"},
                {"id": 705, "category": "Food", "name": "æ™šé¤ï¼šæ¾€è°·æ©«ä¸", "hours": "19:30", "mapKeyword": "Miyashita Park", "note": "å®®ä¸‹å…¬åœ’"}
            ],
            [
                {"id": 801, "category": "Shopping", "name": "æœ€å¾Œè£œè²¨", "hours": "10:00", "mapKeyword": "Shinjuku", "note": "å”å‰è¨¶å¾·/è—¥å¦"},
                {"id": 802, "category": "Transport", "name": "å‰å¾€æˆç”°æ©Ÿå ´", "hours": "13:00", "mapKeyword": "Narita Express", "note": "æ­ä¹˜ NEX"},
                {"id": 803, "category": "Flight", "name": "20:40 èµ·é£› (BR197)", "hours": "20:40", "mapKeyword": "Narita Airport", "note": "å†è¦‹æ±äº¬"},
                {"id": 804, "category": "Flight", "name": "23:20 æŠµé”æ¡ƒåœ’", "hours": "23:20", "mapKeyword": "Taoyuan Airport", "note": "å¹³å®‰å›å®¶"}
            ]
        ];
        
        const drivePlan = [
            { "day": 2, "stops": [{"name": "Toyota Rent a Car", "note": "æ²³å£æ¹–ç«™å‰å–è»Š", "location": "Toyota Rent a Car Kawaguchiko Station", "parking": ""},{"name": "æ–°å€‰å±±æ·ºé–“å…¬åœ’", "note": "äº”é‡å¡”(ä¸Šåˆé †å…‰)", "location": "Chureito Pagoda", "parking": "Arakurayama Sengen Park Parking"},{"name": "ä¸å‹•èŒ¶å±‹ (æ±æˆ€è·¯)", "note": "åˆé¤", "location": "Houtou Fudou Higashikoiji", "parking": "Houtou Fudou Parking"},{"name": "å¤§çŸ³å…¬åœ’", "note": "æ²³å£æ¹–ç•”æ•£æ­¥", "location": "Oishi Park", "parking": "Oishi Park Parking"}] },
            { "day": 3, "stops": [{"name": "å¹³é‡ä¹‹æ¿±", "note": "è»Šæ‹é€†å¯Œå£«", "location": "Hirano no Hama", "parking": "Hirano no Hama Parking"},{"name": "é•·æ± è¦ªæ°´å…¬åœ’", "note": "æ‹å¤©éµ", "location": "Nagaike Water Park", "parking": "Nagaike Water Park Parking"},{"name": "å¿é‡å…«æµ·", "note": "è§€å…‰åæ‰€", "location": "Oshino Hakkai", "parking": "Oshino Hakkai Parking"},{"name": "Ogino è¶…å¸‚", "note": "æ¡è²·æ™šé¤", "location": "Ogino Kawaguchiko", "parking": "Ogino Kawaguchiko"}] },
            { "day": 4, "stops": [{"name": "æ²³å£æ¹–çºœè»Š", "note": "å¤©ä¸Šå±±å…¬åœ’", "location": "Mt. Fuji Panoramic Ropeway", "parking": "Ropeway Parking"},{"name": "å¯Œå£«å±±åå¸", "note": "ä¼´æ‰‹ç¦®", "location": "Fujisan Shokupan", "parking": "Fujisan Shokupan"},{"name": "Toyota Rent a Car", "note": "æ²³å£æ¹–ç«™å‰é‚„è»Š", "location": "Toyota Rent a Car Kawaguchiko Station", "parking": ""}] }
        ];

        const commonItems = ["è­·ç…§", "æ—¥å¹£", "SIMå¡", "ä¿¡ç”¨å¡", "å……é›»å™¨", "å¸¸å‚™è—¥", "ç‰™åˆ·ç‰™è†", "è½‰æ¥é ­"];
        const defaultUsers = [
            {"id": 1, "name": "å‰ä¼Š", "icon": "ğŸ¹", "list": commonItems.map(t => ({"text": t, "checked": false})), "flightOutCode": "TR 898", "flightOutDep": "06:40", "flightOutArr": "10:40", "flightInCode": "BR197", "flightInDep": "20:40", "flightInArr": "23:20"},
            {"id": 2, "name": "å°å…«", "icon": "ğŸ±", "list": commonItems.map(t => ({"text": t, "checked": false})), "flightOutCode": "TR 898", "flightOutDep": "06:40", "flightOutArr": "10:40", "flightInCode": "BR197", "flightInDep": "20:40", "flightInArr": "23:20"},
            {"id": 3, "name": "å…”å…”", "icon": "ğŸ°", "list": commonItems.map(t => ({"text": t, "checked": false})), "flightOutCode": "TR 898", "flightOutDep": "06:40", "flightOutArr": "10:40", "flightInCode": "BR197", "flightInDep": "20:40", "flightInArr": "23:20"},
            {"id": 4, "name": "å°æ¡ƒ", "icon": "ğŸ‘", "list": commonItems.map(t => ({"text": t, "checked": false})), "flightOutCode": "TR 898", "flightOutDep": "06:40", "flightOutArr": "10:40", "flightInCode": "BR197", "flightInDep": "20:40", "flightInArr": "23:20"}
        ];
        
        const hotels = [
            {"name": "éŒ¦ç³¸ç”ºæ°‘å®¿", "days": "Day 1-2", "img": "https://placehold.co/600x400/333/fff?text=BnB"},
            {"name": "Megu Fuji 2021", "days": "Day 3-4", "img": "https://placehold.co/600x400/333/fff?text=Megu"},
            {"name": "DOMO Hotel Shinjuku", "days": "Day 5-7", "img": "https://placehold.co/600x400/333/fff?text=DOMO"}
        ];

        const defaultShopping = {
            wish: [
                {"name": "Chiikawa Land", "desc": "åŸå®¿/æ±äº¬è»Šç«™é™å®š", "link": "", "img": "welcome.jpg"}, 
                {"name": "å¯Œå£«å±±æ¯", "desc": "æ˜Ÿå·´å…‹/ç”°å³¶ç¡å­", "link": "", "img": "2026.tokyo.jpg"},
                {"name": "Le Labo", "desc": "æ±äº¬é™å®š Gaiac 10", "link": "", "img": ""},
                {"name": "Porter", "desc": "å‰ç”°åŒ… (è¡¨åƒé“)", "link": "", "img": ""},
                {"name": "Human Made", "desc": "è—ç“¶è¯åå‘¨é‚Š", "link": "", "img": ""}
            ],
            cosme: [
                {"name": "Tirtir æ°£å¢Š", "desc": "ç´…ç›’é«˜é®ç‘•", "link": "", "img": ""}, 
                {"name": "Kate æ€ªç¸å”‡è†", "desc": "è‰²è™Ÿ 03/05/103", "link": "", "img": ""},
                {"name": "&Honey é«®æ²¹", "desc": "Melty ä¿®è­·ç³»åˆ—", "link": "", "img": ""},
                {"name": "Canmake", "desc": "æ£‰èŠ±ç³–èœœç²‰é¤…", "link": "", "img": ""},
                {"name": "Takami å°è—ç“¶", "desc": "è§’è³ªä»£è¬ç²¾è¯", "link": "", "img": ""}
            ],
            ldk: [
                {"name": "Lululun é¢è†œ", "desc": "æ±äº¬/å¯Œå£«å±±é™å®š", "link": "", "img": ""},
                {"name": "Fino é«®è†œ", "desc": "é«˜ CP å€¼å¿…å›¤", "link": "", "img": ""},
                {"name": "Excel çœ‰ç­†", "desc": "PD01 / PD02", "link": "", "img": ""},
                {"name": "Biore é˜²æ›¬", "desc": "æ°´æ„Ÿé˜²æ›¬ç²¾è¯", "link": "", "img": ""},
                {"name": "Nivea è—ç½", "desc": "æ—¥ç‰ˆæˆåˆ†ä¸åŒ", "link": "", "img": ""}
            ],
            souvenir: [
                {"name": "NY Perfect Cheese", "desc": "æ±äº¬ç«™å¿…æ’èµ·å¸è„†é¤…", "link": "", "img": ""},
                {"name": "Tokyo Banana", "desc": "çš®å¡ä¸˜/å“†å•¦Aå¤¢ç‰ˆ", "link": "", "img": ""},
                {"name": "Press Butter Sand", "desc": "ç„¦ç³–å¥¶æ²¹å¤¾å¿ƒ", "link": "", "img": ""},
                {"name": "Sugar Butter Tree", "desc": "ç ‚ç³–å¥¶æ²¹æ¨¹", "link": "", "img": ""},
                {"name": "Audrey", "desc": "è‰è“èŠ±æŸé¤…ä¹¾", "link": "", "img": ""}
            ]
        };

        const defaultFood = {
            Tokyo: [
                {"name": "AFURI æ‹‰éºµ", "desc": "æŸšå­é¹½å‘³ (åŸå®¿/å…­æœ¬æœ¨)", "link": "", "img":""}, 
                {"name": "HARBS", "desc": "æ°´æœåƒå±¤è›‹ç³•", "link": "", "img":""},
                {"name": "ç‰›å¡æ»‹æœ¬æ‘", "desc": "ç‚¸ç‰›æ’ (æ¾€è°·/æ–°å®¿)", "link": "", "img":""},
                {"name": "å…­å˜èˆ", "desc": "æ¿ƒåšæ²¾éºµ (æ±äº¬ä¸€ç•ªè¡—)", "link": "", "img":""},
                {"name": "Shake Shack", "desc": "æ˜æ²»ç¥å®®å¤–è‹‘åº— (çµ•ç¾)", "link": "", "img":""}
            ],
            Kamakura: [
                {"name": "Bills", "desc": "ä¸–ç•Œç¬¬ä¸€æ—©é¤ (ä¸ƒé‡Œæ¿±)", "link": "", "img":""}, 
                {"name": "Pacific Drive-In", "desc": "æµ·æ™¯å’–å•¡å»³", "link": "", "img":""},
                {"name": "Caraway", "desc": "æ’éšŠå’–å“©ååº—", "link": "", "img":""},
                {"name": "Yoridocoro", "desc": "æ±Ÿä¹‹é›»çª—æ™¯å®šé£Ÿ", "link": "", "img":""},
                {"name": "è±å³¶å±‹", "desc": "é´¿å­é¤…ä¹¾æœ¬åº—", "link": "", "img":""}
            ],
            Fuji: [
                {"name": "Houtou Fudou", "desc": "ä¸å‹•èŒ¶å±‹ (æ±æˆ€è·¯åº—)", "link": "", "img":""},
                {"name": "Fuji Tempura Idaten", "desc": "å¯Œå£«å¤©å©¦ç¾…", "link": "", "img":""},
                {"name": "Lake Bake", "desc": "æ¹–ç•”éºµåŒ… (å¤§çŸ³å…¬åœ’æ—)", "link": "", "img":""},
                {"name": "Sanrokuen", "desc": "å±±éº“åœ’ (åœçˆè£ç‡’çƒ¤)", "link": "", "img":""},
                {"name": "7-11 æ²³å£æ¹–", "desc": "ä¾¿åˆ©å•†åº—æ™¯è§€åº—", "link": "", "img":""}
            ]
        };

        const defaultPhoto = {
            Tokyo: [
                {"name": "SHIBUYA SKY", "desc": "é«˜ç©ºå±•æœ›å° (éœ€é ç´„)", "link": "", "img":""},
                {"name": "æ±äº¬éµå¡”", "desc": "èŠå…¬åœ’/åœ°ä¸‹åœè»Šå ´è¦–è§’", "link": "", "img":""},
                {"name": "è±ªå¾·å¯º", "desc": "æ‹›è²¡è²“ç™¼æºåœ°", "link": "", "img":""},
                {"name": "TeamLab Planets", "desc": "è±æ´²æ²‰æµ¸å¼è—è¡“", "link": "", "img":""},
                {"name": "æ·ºè‰é›·é–€", "desc": "ç¶“å…¸è§€å…‰åœ°æ¨™", "link": "", "img":""}
            ],
            Kamakura: [
                {"name": "éŒå€‰é«˜æ ¡å‰", "desc": "çŒç±ƒé«˜æ‰‹å¹³äº¤é“", "link": "", "img":""},
                {"name": "é•·è°·å¯º", "desc": "çœºæœ›æ¹˜å—æµ·å²¸", "link": "", "img":""},
                {"name": "é«˜å¾·é™¢", "desc": "éŒå€‰å¤§ä½›", "link": "", "img":""},
                {"name": "å ±åœ‹å¯º", "desc": "å¤¢å¹»ç«¹æ—", "link": "", "img":""},
                {"name": "ä¸ƒé‡Œæ¿±æµ·å²¸", "desc": "å¤•é™½èˆ‡æ±Ÿä¹‹å³¶", "link": "", "img":""}
            ],
            Fuji: [
                {"name": "æ–°å€‰å±±æ·ºé–“å…¬åœ’", "desc": "äº”é‡å¡” + å¯Œå£«å±±", "link": "", "img":""},
                {"name": "ç¾…æ£®æ²³å£æ¹–ç«™å‰", "desc": "ç¶“å…¸ä¾¿åˆ©å•†åº—æ™¯", "link": "", "img":""},
                {"name": "å¤§çŸ³å…¬åœ’", "desc": "æ²³å£æ¹–èŠ±æµ·", "link": "", "img":""},
                {"name": "æœ¬ç”ºå•†åº—è¡—", "desc": "æ˜­å’Œå¾©å¤è¡—é“", "link": "", "img":""},
                {"name": "å±±ä¸­æ¹–å¹³é‡ä¹‹æ¿±", "desc": "é€†å¯Œå£«çµ•æ™¯", "link": "", "img":""}
            ]
        };

        // State & Refs
        const users = ref(defaultUsers);
        const expenses = ref([]);
        const shoppingList = ref(defaultShopping);
        const foodList = ref(defaultFood);
        const photoSpots = ref(defaultPhoto);
        const itineraryData = ref(defaultItinerary);
        const daysUntilTrip = ref(0);
        
        // UI Refs
        const showModal=ref(false), showCommonModal=ref(false), showExpenseModal=ref(false), showUserModal=ref(false), showSyncModal=ref(false);
        const isEditing=ref(false), editForm=ref({}), newCommon=ref({}), newExpense=ref({currency:'JPY'}), editingUser=ref({});
        const commonType=ref(''), editIndex=ref(-1), currentUserId=ref(1), currentFlightUser=ref(1), prepUser=ref(1);
        const moneyTab=ref('record'), moneyMode=ref('select'), hotelTab=ref('stay'), flightMode=ref('select'), prepTab=ref('personal'), prepMode=ref('select');
        const foodLoc=ref('Tokyo'), shopCat=ref('wish'), photoArea=ref('Tokyo'), expenseType=ref('personal');
        const tokyoWeather=ref({temp:'--',icon:'â˜ï¸'}), kamakuraWeather=ref({temp:'--',icon:'â˜ï¸'}), fujiWeather=ref({temp:'--',icon:'â˜ï¸'});
        const itineraryMode = ref('normal'); 
        const japanesePhrases = ref([{jp:'ã™ã¿ã¾ã›ã‚“',tw:'ä¸å¥½æ„æ€'},{jp:'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™',tw:'æˆ‘è¦é€™å€‹'},{jp:'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™',tw:'æˆ‘è¦çµå¸³'},{jp:'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹',tw:'å»æ‰€åœ¨å“ªè£¡'},{jp:'è¢‹ã¯ã„ã‚Šã¾ã›ã‚“',tw:'ä¸ç”¨è¢‹å­'}]);

        // Static Data
        const apps = [{id:1,name:'è¡Œç¨‹',icon:'fa-solid fa-map-location-dot',bgClass:'bg-pink-400',view:'itinerary'},{id:2,name:'å°è²¡åº«',icon:'fa-solid fa-sack-dollar',bgClass:'bg-yellow-400',view:'money'},{id:3,name:'ä½å®¿æ©Ÿç¥¨',icon:'fa-solid fa-plane-arrival',bgClass:'bg-indigo-400',view:'hotel'},{id:4,name:'è¡Œå‰æº–å‚™',icon:'fa-solid fa-suitcase-rolling',bgClass:'bg-blue-400',view:'prep'},{id:5,name:'åƒåƒå–å–',icon:'fa-solid fa-utensils',bgClass:'bg-orange-400',view:'food'},{id:6,name:'å¿«æ¨‚Shop',icon:'fa-solid fa-bag-shopping',bgClass:'bg-purple-400',view:'shopping'},{id:7,name:'å¤©æ°£é€±å ±',icon:'fa-solid fa-cloud-sun',bgClass:'bg-sky-400',view:'weather'},{id:8,name:'ç¶²ç¾æ‰“å¡',icon:'fa-solid fa-camera',bgClass:'bg-rose-400',view:'photo'},{id:9,name:'ç¿»è­¯é†¬',icon:'fa-solid fa-language',bgClass:'bg-emerald-400',view:'japanese'}];
        const tripDays = [{week:'D1',title:'3/27'},{week:'D2',title:'3/28'},{week:'D3',title:'3/29'},{week:'D4',title:'3/30'},{week:'D5',title:'3/31'},{week:'D6',title:'4/01'},{week:'D7',title:'4/02'},{week:'D8',title:'4/03'}];
        const selectedDayIndex = ref(0);

        // Computed
        const getUserById = (id) => users.value.find(u=>u.id===id)||users.value[0];
        const currentPrepList = computed(() => getUserById(prepUser.value).list);
        const currentItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
        const getDrivePlanForDay = (idx) => { const p = drivePlan.find(d => d.day === idx); return p ? p.stops : []; };
        const getCurrentList = () => { if(currentView.value==='food') return foodList.value[foodLoc.value]; if(currentView.value==='shopping') return shoppingList.value[shopCat.value]; if(currentView.value==='photo') return photoSpots.value[photoArea.value]; return []; };
        const personalExpenses = computed(() => expenses.value.filter(e => e.user === currentUserId.value && e.type === 'personal').sort((a,b)=>b.id-a.id));
        const groupExpenses = computed(() => expenses.value.filter(e => e.type === 'group').sort((a,b)=>b.id-a.id));
        const userPersonalTotal = computed(() => personalExpenses.value.reduce((s,e) => s + Number(e.amount), 0));
        const settlements = computed(() => { const bal={}; users.value.forEach(u=>bal[u.id]=0); groupExpenses.value.forEach(e=>{const amt=Number(e.amount);bal[e.user]+=amt;}); const avg=Object.values(bal).reduce((a,b)=>a+b,0)/users.value.length; const net=[]; users.value.forEach(u=>net.push({id:u.id, val:bal[u.id]-avg})); const res=[]; const db=net.filter(n=>n.val<-1).sort((a,b)=>a.val-b.val); const cr=net.filter(n=>n.val>1).sort((a,b)=>b.val-a.val); let i=0,j=0; while(i<db.length&&j<cr.length){let amt=Math.min(-db[i].val, cr[j].val); res.push({from:db[i].id, to:cr[j].id, amount:Math.round(amt)}); db[i].val+=amt; cr[j].val-=amt; if(Math.abs(db[i].val)<1)i++; if(Math.abs(cr[j].val)<1)j++;} return res; });

        // Functions
        const BASE_RAW_URL = 'https://raw.githubusercontent.com/sunny5200820-maker/2026.tokyo.fuji.trip/main/';
        const getImg = (path) => { if (!path) return 'https://placehold.co/400x300/FFD1DC/ffffff?text=No+Image'; if (path.startsWith('http') || path.startsWith('data:image')) return path; const cleanName = path.replace(/^images\//, ''); if(cleanName === '2026.tokyo.jpg' || cleanName === 'welcome.jpg') return BASE_RAW_URL + cleanName; return BASE_RAW_URL + 'images/' + cleanName; };
        const handleImgError = (e) => { e.target.src='https://placehold.co/400x300/f3f4f6/cbd5e1?text=Image+N/A'; };
        const getPageTitle = (v) => apps.find(a=>a.view===v)?.name || v;
        const getIconByCategory = (c) => ({'Flight':'fa-plane','Sightseeing':'fa-camera','Food':'fa-utensils','Shopping':'fa-bag-shopping','Transport':'fa-train','Hotel':'fa-bed'}[c]||'fa-star');
        const getProgress = (uid) => { const l=getUserById(uid).list; return l.length?(l.filter(i=>i.checked).length/l.length)*100:0; };
        const getClothingAdvice = (t) => t<15?'ç™¼ç†±è¡£+å¤§è¡£':t<20?'æ´‹è”¥å¼ç©¿æ­':'è–„é•·è¢–';
        // ä¿®æ­£å¾Œçš„ getMapLink
        const getMapLink = (k) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}`;
        
        // Actions
        const enterSite = () => isWelcomeClosed.value=true;
        const selectMoneyUser = (id) => { currentUserId.value=id; moneyMode.value='list'; };
        const selectPrepUser = (id) => { prepUser.value=id; prepMode.value='list'; };
        const openUserEdit = (u) => { editingUser.value={...u}; showUserModal.value=true; };
        const saveUserEdit = () => { const idx=users.value.findIndex(u=>u.id===editingUser.value.id); if(idx!==-1)users.value[idx]={...editingUser.value}; showUserModal.value=false; };
        const triggerAvatarUpload = () => document.querySelector('input[type=file][ref=avatarInput]').click();
        const processAvatarUpload = (e) => { const r=new FileReader(); r.onload=ev=>editingUser.value.avatar=ev.target.result; r.readAsDataURL(e.target.files[0]); };
        const openExpenseModal = (t) => { expenseType.value=t; newExpense.value={amount:'',currency:'JPY',name:''}; showExpenseModal.value=true; };
        const addExpense = () => { expenses.value.push({...newExpense.value, id:Date.now(), user:currentUserId.value, type:expenseType.value, date:new Date().toLocaleDateString()}); showExpenseModal.value=false; };
        const deleteExpense = (id) => { if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) expenses.value=expenses.value.filter(e=>e.id!==id); };
        const openAddModal = () => { isEditing.value=false; editForm.value={category:'Sightseeing'}; showModal.value=true; };
        const editItem = (item,idx) => { isEditing.value=true; editIndex.value=idx; editForm.value={...item}; showModal.value=true; };
        const saveItem = () => { const target=itineraryData.value[selectedDayIndex.value]; if(isEditing.value) Object.assign(target[editIndex.value],editForm.value); else target.push({...editForm.value, id:Date.now()}); showModal.value=false; };
        const deleteItem = (idx) => { if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) itineraryData.value[selectedDayIndex.value].splice(idx,1); };
        const openAddCommonModal = (t) => { commonType.value=t; isEditing.value=false; newCommon.value={text1:'',text2:'',link:''}; showCommonModal.value=true; };
        const editCommonItem = (item,idx) => { commonType.value=currentView.value; isEditing.value=true; editIndex.value=idx; newCommon.value={text1:item.name, text2:item.desc, text3:item.img, link:item.link}; showCommonModal.value=true; };
        // ä¿®å¾©å¾Œçš„ saveCommonItem
        const saveCommonItem = () => { 
            const list = getCurrentList(); 
            let finalLink = newCommon.value.link; 
            if(!finalLink) { 
                if(currentView.value === 'shopping') finalLink = `https://www.google.com/search?q=${encodeURIComponent(newCommon.value.text1)}`; 
                else finalLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(newCommon.value.text1)}`; 
            } 
            const item = {name:newCommon.value.text1, desc:newCommon.value.text2, img:newCommon.value.text3, link:finalLink}; 
            if(isEditing.value) Object.assign(list[editIndex.value], item); else list.push(item); 
            showCommonModal.value=false; 
        };
        const deleteCommonItem = (idx) => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) getCurrentList().splice(idx,1); };
        const processCommonImageUpload = (e) => { const r=new FileReader(); r.onload=ev=>newCommon.value.text3=ev.target.result; r.readAsDataURL(e.target.files[0]); };
        const addPrepItem = () => { const t=prompt('æ–°å¢æª¢æŸ¥é …ç›®:'); if(t) currentPrepList.value.push({text:t,checked:false}); };
        const openCamera = () => { alert('ğŸ“· ç›¸æ©ŸåŠŸèƒ½å·²æ¨¡æ“¬å•Ÿå‹•\nè«‹é¸æ“‡ä¸€å¼µç…§ç‰‡ä¸Šå‚³ã€‚'); document.querySelector('input[ref=commonImageInput]').click(); };
        const speak = (t) => { const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; speechSynthesis.speak(u); };
        const saveAsHtml = () => { const d=JSON.stringify({users:users.value, expenses:expenses.value, shop:shoppingList.value, food:foodList.value, photo:photoSpots.value, itinerary:itineraryData.value}); const b=new Blob([document.documentElement.outerHTML.replace('//PLACEHOLDER',`const savedData=${d};`)],{type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='Trip_V17.00.html'; a.click(); };
        const resetItinerary = () => { if(confirm('è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤æ‰€æœ‰æ‚¨ä¿®æ”¹éçš„è³‡æ–™ä¸¦æ¢å¾©é è¨­å€¼ã€‚ç¢ºå®šå—ï¼Ÿ')) { localStorage.removeItem(STORAGE_KEY); location.reload(); }};
        const fetchWeather = async () => { try { const r=await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current_weather=true'); const d=await r.json(); tokyoWeather.value={temp:d.current_weather.temperature, icon:'â˜ï¸'}; } catch(e){} };
        const startDrag = (e) => { const el = e.target.closest('.fab-home'); const touch = e.touches?e.touches[0]:e; const shiftX = touch.clientX - el.getBoundingClientRect().left; const shiftY = touch.clientY - el.getBoundingClientRect().top; const moveAt = (pageX, pageY) => { el.style.left = pageX - shiftX + el.offsetWidth/2 + 'px'; el.style.top = pageY - shiftY + el.offsetHeight/2 + 'px'; el.style.transform = 'translate(-50%, -50%)'; }; const onMove = (event) => moveAt(event.touches?event.touches[0].pageX:event.pageX, event.touches?event.touches[0].pageY:event.pageY); document.addEventListener('mousemove', onMove); document.addEventListener('touchmove', onMove, {passive:false}); const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('touchmove', onMove); }; document.addEventListener('mouseup', onUp); document.addEventListener('touchend', onUp); };

        onMounted(() => {
            const s=localStorage.getItem(STORAGE_KEY);
            if(s) {
                try {
                    const d=JSON.parse(s);
                    if(d.users) users.value=d.users;
                    if(d.expenses) expenses.value=d.expenses;
                    if(d.shop) shoppingList.value=d.shop;
                    if(d.food) foodList.value=d.food;
                    if(d.photo) photoSpots.value=d.photo;
                    if(d.itinerary && d.itinerary.length > 0) itineraryData.value=d.itinerary;
                } catch(e) { console.error('Data sync failed'); }
            }
            daysUntilTrip.value = Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24));
            fetchWeather();
            
            setTimeout(() => {
                const loader = document.getElementById('loading-screen');
                if(loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);
                }
            }, 1000);
        });
        watch([users, expenses, shoppingList, foodList, photoSpots, itineraryData], () => { localStorage.setItem(STORAGE_KEY, JSON.stringify({users:users.value, expenses:expenses.value, shop:shoppingList.value, food:foodList.value, photo:photoSpots.value, itinerary:itineraryData.value})); }, {deep:true});

        return {
            currentView, isWelcomeClosed, showGoogleSearch, enterSite, apps, selectedDayIndex, tripDays, daysUntilTrip,
            users, expenses, shoppingList, foodList, photoSpots, itineraryData, editingUser,
            moneyTab, moneyMode, hotelTab, flightMode, prepTab, prepMode, foodLoc, shopCat, photoArea,
            showModal, showCommonModal, showExpenseModal, showUserModal, showSyncModal, isEditing, editForm, newCommon, newExpense, expenseType,
            currentUserId, currentFlightUser, prepUser, userPersonalTotal, settlements, personalExpenses, groupExpenses,
            currentItinerary, currentPrepList, getCurrentList, getUserById, getProgress, getImg, handleImgError, getPageTitle, getIconByCategory, getClothingAdvice,
            selectMoneyUser, selectPrepUser, openUserEdit, saveUserEdit, triggerAvatarUpload, processAvatarUpload,
            openExpenseModal, addExpense, deleteExpense, openAddModal, editItem, saveItem, deleteItem,
            openAddCommonModal, editCommonItem, saveCommonItem, deleteCommonItem, processCommonImageUpload,
            addPrepItem, openCamera, speak, saveAsHtml, resetItinerary, startDrag,
            tokyoWeather, kamakuraWeather, fujiWeather, itineraryMode, getDrivePlanForDay, getMapLink, japanesePhrases
        };
    }
}).mount('#app');
</script>
</body>
</html>
