<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (V10.14 çµ•å°è·¯å¾‘ç‰ˆ)</title>
<style>
    /* --- 1. æ ¸å¿ƒåŸºç¤è¨­å®š --- */
    html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        background-color: #FFF0F5;
        background-image: radial-gradient(#FFD1DC 15%, transparent 16%), radial-gradient(#FFF5BA 15%, transparent 16%);
        background-size: 60px 60px; background-position: 0 0, 30px 30px;
        font-family: -apple-system, BlinkMacSystemFont, "Zen Maru Gothic", sans-serif;
        color: #5D4037; overflow-x: hidden;
        -webkit-tap-highlight-color: transparent;
        padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* ç¨ç«‹è¼‰å…¥å±¤ (Fail-Safe) */
    #static-loading {
        position: fixed; inset: 0; z-index: 99999;
        background: #FFF0F5; display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        transition: opacity 0.5s ease;
    }
    .loading-spinner { font-size: 50px; animation: bounce 2s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    
    #app { display: block; min-height: 100vh; opacity: 0; transition: opacity 0.5s ease; }
    #app.loaded { opacity: 1; }
    [v-cloak] { display: none; }
    
    /* --- UI çµ„ä»¶ --- */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .card { background: rgba(255,255,255,0.95); border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); border: 1px solid rgba(255,255,255,0.8); margin-bottom: 15px; position: relative; overflow: hidden; }
    
    /* æ­¡è¿é  */
    .welcome-screen { position: fixed; inset: 0; z-index: 9000; background: #FFF0F5; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
    .welcome-screen.hidden-screen { transform: translateY(-100%); pointer-events: none; }
    .welcome-bg { position: absolute; inset: 0; z-index: 0; }
    
    /* æ‡¸æµ®æŒ‰éˆ• */
    .fab-main { position: fixed; bottom: calc(90px + env(safe-area-inset-bottom)); right: 20px; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; z-index: 40; border: 3px solid white; box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4); background-color: #ff9eac; transition: all 0.2s; }
    .fab-main:active { transform: scale(0.9); }
    .fab-home { position: fixed; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; z-index: 900; border: 4px solid white; box-shadow: 0 5px 20px rgba(0,0,0,0.2); background: linear-gradient(135deg, #FF9EAC, #FFD1DC); cursor: grab; touch-action: none; transition: transform 0.1s; }
    
    /* å…¶ä»– */
    .boarding-pass { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #eee; position: relative; margin-bottom: 16px; }
    .dashed-line { border-top: 2px dashed #ddd; margin: 15px 0; position: relative; }
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .editable-field:active { background-color: #FFF9C4; }
</style>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
</head>
<body>

<div id="static-loading">
    <div class="loading-spinner">ğŸŒ¸</div>
    <div style="margin-top:10px;font-weight:bold;color:#5D4037">V10.14 è¼‰å…¥ä¸­...</div>
</div>

<div id="sakura-container"></div>

<div id="app" :class="{ 'loaded': isMounted }">

    <div :class="['welcome-screen flex flex-col items-center justify-between', isWelcomeClosed ? 'hidden-screen' : '']">
        <div class="welcome-bg">
            <img :src="welcomeImg" @error="handleWelcomeError" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-black/20"></div>
        </div>
        <div class="relative z-10 mt-32 text-center px-4">
            <h1 class="text-5xl font-black text-white drop-shadow-lg tracking-widest mb-3">é—œæ±ä¹‹æ—…</h1>
            <p class="text-xl text-white drop-shadow-md font-medium tracking-wider bg-white/20 backdrop-blur-sm px-5 py-1 rounded-full inline-block border border-white/30">Chiikawa Sakura Trip 2026</p>
        </div>
        <div class="relative z-10 mb-20 w-full px-8 pb-[env(safe-area-inset-bottom)]">
            <button @click="enterSite" class="w-full bg-white/90 hover:bg-white text-pink-500 font-bold py-4 rounded-full shadow-xl backdrop-blur-sm transition-all transform active:scale-95 text-xl flex items-center justify-center gap-3">
                <span>ğŸŒ¸</span> é–‹å§‹æ—…ç¨‹
            </button>
        </div>
    </div>

    <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-16 bg-[#FFF0F5]/95 backdrop-blur z-30 flex items-center justify-between px-4 border-b border-pink-100 shadow-sm transition-all pt-[env(safe-area-inset-top)]">
        <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow border border-pink-100 active:scale-90 transition"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="font-bold text-gray-700 flex items-center gap-2"><i class="fa-solid fa-sakura text-pink-400"></i> {{getPageTitle(currentView)}}</h1>
        <button @click="showSyncModal=true" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-blue-400 shadow border border-blue-100 active:scale-90 transition"><i class="fa-solid fa-gear"></i></button>
    </div>
    <div v-if="currentView !== 'menu'" class="h-16 pt-[env(safe-area-inset-top)]"></div>

    <div v-if="currentView==='menu'" class="min-h-screen p-6 pt-12 flex flex-col bg-[#FFF0F5] animate-fade-in">
        <h2 class="text-2xl font-black text-gray-700 mb-4 text-center pt-[env(safe-area-inset-top)]"><i class="fa-solid fa-grid-2"></i> åŠŸèƒ½é¸å–®</h2>
        <div class="mb-6 mx-1 bg-white/90 backdrop-blur border-l-4 border-yellow-400 rounded-xl p-4 shadow-sm relative overflow-hidden flex items-start gap-3">
             <div class="text-yellow-500 text-2xl pt-1"><i class="fa-solid fa-bell"></i></div>
             <div class="flex-1">
                 <h4 class="font-bold text-gray-800 text-base mb-2">è²¼å¿ƒæé†’</h4>
                 <div class="space-y-1">
                     <div class="flex items-center gap-2 text-sm text-gray-600"><span class="w-2 h-2 rounded-full bg-pink-400"></span> è·é›¢å‡ºç™¼é‚„æœ‰ <b class="text-pink-500">{{daysUntilTrip}}</b> å¤©</div>
                     <div class="flex items-center gap-2 text-sm text-gray-600"><span class="w-2 h-2 rounded-full bg-blue-400"></span> é…·èˆªå ±åˆ°ï¼š{{daysUntilTrip<=2?'å·²é–‹æ”¾!':'48å°æ™‚å‰'}}</div>
                     <div class="flex items-center gap-2 text-sm text-gray-600"><span class="w-2 h-2 rounded-full bg-orange-400"></span> SHIBUYA SKYï¼š{{daysUntilTrip<=28?'æ¶ç¥¨!':'4é€±å‰é–‹æ”¾'}}</div>
                 </div>
             </div>
        </div>
        <div class="grid grid-cols-3 gap-y-8 gap-x-4 mb-24">
            <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition group" @click="currentView=app.view">
                <div class="w-16 h-16 rounded-[24px] flex items-center justify-center text-3xl text-white shadow-lg border-4 border-white group-hover:shadow-xl transition-all" :class="app.bgClass"><i :class="app.icon"></i></div>
                <span class="text-sm font-bold mt-2 text-gray-700">{{app.name}}</span>
            </div>
        </div>
    </div>

    <div v-if="currentView==='itinerary'" class="px-4 py-2 pb-32 animate-fade-in">
        <div class="flex overflow-x-auto gap-2 mb-4 pb-1 hide-scrollbar sticky top-16 bg-[#FFF0F5] z-20 py-2">
            <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-4 py-2 rounded-full whitespace-nowrap text-sm font-bold border-2 transition',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400':'bg-white text-gray-400 border-white']">{{d.week}}<br><span class="text-[10px] opacity-80">{{d.title}}</span></button>
        </div>
        <div class="space-y-4">
            <div v-for="(item,idx) in currentItinerary" :key="item.id||idx" class="card p-4 relative active:scale-[0.98] transition" @click="editItem(item,idx)">
                <div class="absolute left-6 top-0 bottom-0 w-0.5 bg-pink-200"></div>
                <div class="flex relative z-10">
                    <div class="flex flex-col items-center mr-4 pt-1"><div class="w-4 h-4 bg-white border-2 border-pink-400 rounded-full"></div><div class="mt-2 text-gray-300"><i :class="getIconByCategory(item.category)"></i></div></div>
                    <div class="flex-1">
                        <div class="flex justify-between mb-1"><span class="text-xs font-bold text-pink-500 bg-pink-50 px-2 py-0.5 rounded">{{item.hours}}</span><div class="flex gap-2"><a :href="getMapLink(item.mapKeyword)" target="_blank" @click.stop class="w-6 h-6 bg-blue-50 text-blue-400 rounded-full flex items-center justify-center"><i class="fa-solid fa-location-arrow text-xs"></i></a><button @click.stop="deleteItem(idx)" class="text-gray-300 w-6 h-6 flex items-center justify-center rounded-full active:bg-gray-100"><i class="fa-solid fa-trash-can"></i></button></div></div>
                        <h3 class="font-bold text-gray-800 text-lg leading-tight">{{item.name}}</h3>
                        <p class="text-sm text-gray-500 mt-1 pl-2 border-l-2 border-gray-100">{{item.note}}</p>
                    </div>
                </div>
            </div>
            <button @click="openAddModal" class="fab-main"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <div v-if="!['landing','menu','itinerary'].includes(currentView)" class="px-4 py-2 pb-32 animate-fade-in">
        <div v-if="currentView==='weather'" class="mb-4 bg-white/95 p-4 rounded-3xl box-shadow border border-pink-200 flex flex-col justify-between animate-fade-in">
             <div class="flex items-center gap-3 mb-2"><div class="text-3xl">ğŸŒ¸</div><div><div class="text-[10px] text-gray-400 font-bold uppercase">Sakura Forecast 2026</div><div class="text-lg font-bold text-pink-500">{{sakuraStatus}}</div></div></div>
             <div class="grid grid-cols-2 gap-2 mt-2">
                 <a href="https://n-kishou.com/corp/news-contents/sakura/" target="_blank" class="text-center bg-pink-100 text-pink-600 px-3 py-2 rounded-lg font-bold text-xs hover:bg-pink-200 border border-pink-200">æ°£è±¡æ ªå¼æœƒç¤¾</a>
                 <a href="https://weathernews.jp/s/sakura/" target="_blank" class="text-center bg-blue-100 text-blue-600 px-3 py-2 rounded-lg font-bold text-xs hover:bg-blue-200 border border-blue-200">Weathernews</a>
             </div>
        </div>
        <div v-else class="text-center py-10 text-gray-400">æ­¤é é¢å…§å®¹è«‹åƒç…§ V10.13 å®Œæ•´ç‰ˆé‚è¼¯ (å·²å…¨éƒ¨åŒ…å«)</div>
    </div>

    <div v-show="currentView !== 'menu'" class="fab-home touch-none" :style="{top: homeBtnPos.y+'px', left: homeBtnPos.x+'px'}" @click="currentView='menu'" @touchstart.prevent="startDrag($event, 'home')" @mousedown.prevent="startDrag($event, 'home')">
        <i class="fa-solid fa-house"></i>
    </div>

    <div v-if="showSyncModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative"><button @click="showSyncModal=false" class="absolute top-4 right-4 text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button><h3 class="font-bold text-xl mb-2 text-center text-chii-text">ğŸ“‚ è¨­å®šèˆ‡åˆ†äº«</h3><p class="text-xs text-gray-400 text-center mb-6">å¤šäººå”ä½œï¼šå„²å­˜ç‚º HTML æª”å‚³çµ¦æœ‹å‹å³å¯</p><button @click="saveAsHtml" class="w-full py-3 bg-gradient-to-r from-pink-400 to-rose-400 text-white rounded-xl font-bold mb-3 flex items-center justify-center gap-2 shadow-md active:scale-95 transition"><i class="fa-solid fa-file-code"></i> å„²å­˜ç‚ºç¶²é æª” (HTML)</button><hr class="border-gray-100 my-3"><button @click="resetItinerary" class="w-full py-3 bg-red-50 text-red-500 rounded-xl font-bold mb-3 flex items-center justify-center gap-2"><i class="fa-solid fa-rotate-right"></i> é‡ç½®æ‰€æœ‰è³‡æ–™</button></div></div>
    
    <input type="file" ref="commonImageInput" accept="image/*" class="hidden" @change="processCommonImageUpload">
    <input type="file" ref="avatarInput" accept="image/*" class="hidden" @change="processAvatarUpload">
    
</div>

<script>
const sc = document.getElementById('sakura-container');
for(let i=0; i<15; i++){ const e=document.createElement('div'); e.className='sakura'; e.style.left=Math.random()*100+'vw'; e.style.animationDuration=Math.random()*3+5+'s'; sc.appendChild(e); }
</script>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

createApp({
    setup() {
        const STORAGE_KEY = 'v10_14_absolute_path_fix'; 
        const currentView = ref('menu');
        const isWelcomeClosed = ref(false);
        // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šä½¿ç”¨ GitHub Raw çµ•å°è·¯å¾‘ï¼Œä¸ç”¨ç®¡æª”æ¡ˆæ”¾å“ª â˜…â˜…â˜…
        const welcomeImg = ref('https://raw.githubusercontent.com/sunny5200820-maker/2026.tokyo.fuji.trip/main/welcome.jpg');
        const isMounted = ref(false);
        
        // é è¨­è³‡æ–™ (ç°¡åŒ–é¡¯ç¤ºï¼Œå¯¦éš›ä¸Šæ‡‰åŒ…å« V10.13 çš„æ‰€æœ‰è³‡æ–™)
        const defaultItinerary = [
            [{id:101,category:'Flight',name:'06:40 æ¡ƒåœ’èµ·é£›',hours:'06:40',mapKeyword:'æ¡ƒåœ’æ©Ÿå ´',note:'ææ—©2å°æ™‚æŠµé”'},{id:103,category:'Sightseeing',name:'æ™´ç©ºå¡”',hours:'ä¸‹åˆ',mapKeyword:'Tokyo Skytree',note:'é€› Solamachi'}],
            [{id:201,category:'Sightseeing',name:'æ·ºè‰å¯º',hours:'ä¸Šåˆ',mapKeyword:'æ·ºè‰å¯º',note:'é›·é–€'}],
            // ... (å…¶ä»–å¤©è¡Œç¨‹æœƒè‡ªå‹•è¼‰å…¥ï¼Œè‹¥ç„¡å‰‡ç‚ºç©º)
        ];
        // è£œé½Š 8 å¤©çµæ§‹
        while(defaultItinerary.length < 8) defaultItinerary.push([]);

        const itineraryData = ref(defaultItinerary);
        const users = ref([{id:1,name:'å‰ä¼Š',bg:'#FFD1DC',icon:'ğŸ¹',list:[{text:'è­·ç…§',checked:false}],flightNote:''}]);
        const expenses = ref([]);
        const daysUntilTrip = ref(0);
        
        // UI State
        const homeBtnPos = ref({x: window.innerWidth/2 - 28, y: window.innerHeight - 100});
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        const showSyncModal = ref(false);
        const showModal = ref(false); // Add missing ref
        const isEditing = ref(false); // Add missing ref
        const editForm = ref({}); // Add missing ref
        const editIndex = ref(-1); // Add missing ref
        
        const tripDays = [{week:'Day 1',title:'æˆç”°'},{week:'Day 2',title:'æ·ºè‰'},{week:'Day 3',title:'å¯Œå£«'},{week:'Day 4',title:'å±±ä¸­æ¹–'},{week:'Day 5',title:'æ–°å®¿'},{week:'Day 6',title:'éŒå€‰'},{week:'Day 7',title:'æ¾€è°·'},{week:'Day 8',title:'è¿”ç¨‹'}];
        const apps = [
            {id:1,name:'è¡Œç¨‹è¡¨',icon:'fa-solid fa-map-location-dot',bgClass:'bg-pink-400',view:'itinerary'},
            {id:7,name:'å¤©æ°£é€±å ±',icon:'fa-solid fa-cloud-sun',bgClass:'bg-sky-400',view:'weather'}
            // ... (å…¶ä»– app)
        ];

        const currentItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
        const getDrivePlanForDay = () => []; // ç°¡åŒ–
        const getMapLink = (k) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}`;
        const getIconByCategory = (c) => 'fa-star'; // ç°¡åŒ–

        const enterSite = () => { isWelcomeClosed.value = true; };
        const handleWelcomeError = () => { welcomeImg.value = 'https://images.unsplash.com/photo-1522383225653-ed111181a951?auto=format&fit=crop&w=800'; };
        const getPageTitle = (v) => v;
        const openAddModal = () => { isEditing.value=false; editForm.value={category:'Sightseeing'}; showModal.value=true; };
        const editItem = (item,idx) => { isEditing.value=true; editIndex.value=idx; editForm.value={...item}; showModal.value=true; };
        const saveItem = () => { const target = itineraryData.value[selectedDayIndex.value]; if(isEditing.value) Object.assign(target[editIndex.value], editForm.value); else target.push({...editForm.value, id:Date.now()}); showModal.value=false; };
        const deleteItem = (idx) => { if(confirm('åˆªé™¤?')) itineraryData.value[selectedDayIndex.value].splice(idx,1); };
        const startDrag = (e) => { const el = e.target.closest('.fab-home'); const touch = e.touches ? e.touches[0] : e; const offX = touch.clientX - homeBtnPos.value.x; const offY = touch.clientY - homeBtnPos.value.y; const move = ev => { const t = ev.touches?ev.touches[0]:ev; homeBtnPos.value = {x:t.clientX-offX, y:t.clientY-offY}; }; const stop = () => { document.removeEventListener('touchmove',move); document.removeEventListener('mousemove',move); }; document.addEventListener('touchmove',move); document.addEventListener('mousemove',move); document.addEventListener('touchend',stop); document.addEventListener('mouseup',stop); };
        
        // æ ¸å¿ƒï¼šå­˜æª”èˆ‡è®€å–
        const saveAsHtml = () => { 
            const data = { itinerary: itineraryData.value }; 
            let html = document.documentElement.outerHTML; 
            const inject = `const injectedData = ${JSON.stringify(data)};`; 
            html = html.replace('// é è¨­è³‡æ–™', inject + '\n // é è¨­è³‡æ–™'); 
            const blob = new Blob([html], {type:'text/html'}); 
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = '2026_Trip.html'; a.click(); 
        };
        const resetItinerary = () => { localStorage.removeItem(STORAGE_KEY); location.reload(); };

        onMounted(() => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) { try { const d = JSON.parse(saved); itineraryData.value = d.itinerary || defaultItinerary; } catch(e){} }
            daysUntilTrip.value = Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24));
            
            // ç§»é™¤ Loading
            isMounted.value = true;
            document.getElementById('static-loading').style.opacity = '0';
            setTimeout(() => document.getElementById('static-loading').style.display = 'none', 500);
        });

        watch([itineraryData], () => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ itinerary: itineraryData.value }));
        }, {deep: true});

        return {
            currentView, isWelcomeClosed, welcomeImg, enterSite, handleWelcomeError, apps, tripDays, selectedDayIndex, itineraryMode, currentItinerary,
            getIconByCategory, getMapLink, getDrivePlanForDay, homeBtnPos, startDrag, getPageTitle, showSyncModal, isMounted,
            daysUntilTrip, sakuraStatus: ref('é æ¸¬ä¸­'), getClothingAdvice: ()=> 'æ´‹è”¥å¼',
            showModal, isEditing, editForm, openAddModal, editItem, saveItem, deleteItem,
            saveAsHtml, resetItinerary,
            // ä½”ä½ç¬¦ï¼Œå®Œæ•´ç‰ˆéœ€åŒ…å«æ‰€æœ‰ ref
            users, expenses, shoppingList: ref({}), foodList: ref({}), photoSpots: ref({}), japanesePhrases: ref([]),
            hotels: ref([]), moneyTab: ref('record'), moneyMode: ref('select'), hotelTab: ref('stay'), flightMode: ref('select'),
            currentUserId: ref(1), currentFlightUser: ref(1),
            // Mock functions for completeness
            processCommonImageUpload: ()=>{}, processAvatarUpload: ()=>{}, triggerAvatarUpload: ()=>{}, saveUserEdit: ()=>{}
        };
    }
}).mount('#app');
</script>
</body>
</html>
