<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (V22.00 Ultimate Privacy)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>

<script>
    tailwind.config={theme:{extend:{colors:{'chii-pink':'#FFD1DC','chii-deep-pink':'#FF9EAC','chii-blue':'#A2D2FF','chii-yellow':'#FFF5BA','chii-text':'#5D4037'},fontFamily:{sans:['Zen Maru Gothic','sans-serif']},animation:{'wiggle':'wiggle 3s ease-in-out infinite','float':'float 3s ease-in-out infinite','fade-in':'fadeIn 0.5s ease-out forwards','spin-slow':'spin 8s linear infinite','pulse-slow':'pulse 3s infinite'},keyframes:{wiggle:{'0%,100%':{transform:'rotate(-3deg)'},'50%':{transform:'rotate(3deg)'}},float:{'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-5px)'}},fadeIn:{from:{opacity:0,transform:'translateY(10px)'},to:{opacity:1,transform:'translateY(0)'}}}}}}
</script>

<style>
    /* æ ¸å¿ƒåŸºç¤ */
    html,body{margin:0;padding:0;width:100%;height:100%;background-color:#FFF0F5;background-image:radial-gradient(#FFD1DC 15%,transparent 16%),radial-gradient(#FFF5BA 15%,transparent 16%);background-size:60px 60px;background-position:0 0,30px 30px;font-family:"Zen Maru Gothic",sans-serif;color:#5D4037;overflow-x:hidden;-webkit-tap-highlight-color:transparent;padding-bottom:env(safe-area-inset-bottom)}
    input, textarea, select { font-size: 16px !important; font-family: inherit; }
    #app{display:block;min-height:100vh}
    [v-cloak]{display:none !important}
    .hide-scrollbar::-webkit-scrollbar{display:none}.hide-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    
    /* UI å…ƒä»¶ */
    .card{background:rgba(255,255,255,0.92);border-radius:24px;box-shadow:0 8px 30px rgba(255,105,180,0.12);border:1px solid rgba(255,255,255,0.8);margin-bottom:16px;position:relative;overflow:hidden;backdrop-filter:blur(10px);transition:transform 0.2s}
    .card:active { transform: scale(0.99); }
    
    /* æ‡¸æµ®å°èˆª */
    .fab-home{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);width:68px;height:68px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:white;z-index:900;border:4px solid white;box-shadow:0 10px 25px rgba(255,105,180,0.5);background:linear-gradient(135deg,#FF9EAC,#FFD1DC);cursor:grab;touch-action:none;transition:transform 0.2s}
    .fab-home:active{transform:translateX(-50%) scale(0.9);}
    .fab-main{position:fixed;bottom:calc(110px + env(safe-area-inset-bottom));right:20px;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;color:white;z-index:40;border:3px solid white;box-shadow:0 8px 20px rgba(0,0,0,0.15);background-color:#ff9eac;transition:all 0.2s}
    
    /* æ©Ÿç¥¨ç¥¨åˆ¸ */
    .boarding-pass { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.05); border: 1px solid white; margin-bottom: 20px; position: relative; }
    .cut-line { border-top: 2px dashed #ddd; position: relative; margin: 20px 0; }
    .cut-line::before, .cut-line::after { content: ''; position: absolute; top: -12px; width: 24px; height: 24px; background: #FFF0F5; border-radius: 50%; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
    .cut-line::before { left: -12px; } .cut-line::after { right: -12px; }

    /* æ­¡è¿é  */
    .welcome-screen{position:fixed;inset:0;z-index:9999;background:#FFF0F5;transition:transform 0.8s cubic-bezier(0.7,0,0.3,1); cursor: pointer;}
    .welcome-screen.hidden-screen{transform:translateY(-100%);pointer-events:none}
    
    /* Sakura */
    .sakura{position:fixed;top:-10px;background:#FFB7B2;border-radius:100% 0 100% 0;opacity:0.6;animation:fall linear infinite;z-index:0;pointer-events:none;width:14px;height:14px; box-shadow: 0 2px 5px rgba(255,105,180,0.2);}
    @keyframes fall{to{transform:translate(15vw,105vh) rotate(360deg)}}
</style>
</head>
<body>

<div id="crash-screen" style="display:none; position:fixed; inset:0; background:#fff; z-index:100000; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px;">
    <div class="text-6xl mb-4">ğŸ˜¿</div>
    <h2 class="text-2xl font-black mb-2 text-red-500">ç³»çµ±ç•°å¸¸</h2>
    <p class="text-gray-500 text-sm mb-4">åµæ¸¬åˆ°æ•¸æ“šè¡çªï¼Œè«‹å˜—è©¦ä¿®å¾©ã€‚</p>
    <button onclick="localStorage.clear();location.reload()" class="bg-red-500 text-white px-8 py-3 rounded-full font-bold shadow-lg">é‡ç½®èˆ‡ä¿®å¾©</button>
    <pre id="error-log" class="mt-4 text-[10px] text-gray-400 bg-gray-100 p-2 rounded text-left overflow-auto max-w-xs border"></pre>
</div>
<script>window.onerror=function(m,u,l){document.getElementById('crash-screen').style.display='flex';document.getElementById('error-log').innerText=`Error: ${m}\nLn: ${l}`;return false;}</script>

<div id="sakura-container"></div>

<div id="app" v-cloak>
    
    <div :class="['welcome-screen flex flex-col items-center justify-between', isWelcomeClosed ? 'hidden-screen' : '']">
        <div class="absolute inset-0 z-0" @click="enterSite"><img :src="getImg('welcome.jpg')" class="w-full h-full object-cover opacity-90"></div>
        
        <div class="absolute top-6 right-6 z-50">
            <button @click.stop="handleAuthClick" :class="['flex items-center gap-2 px-4 py-2 rounded-full backdrop-blur-md border border-white/50 shadow-lg font-bold text-sm transition', isLoggedIn ? 'bg-green-500/80 text-white' : 'bg-white/40 text-gray-800']">
                <i :class="isLoggedIn ? 'fa-solid fa-cloud' : 'fa-solid fa-cloud-arrow-up'"></i> {{ isLoggedIn ? 'å·²é€£ç·š' : 'é›²ç«¯ç™»å…¥' }}
            </button>
        </div>

        <div class="relative z-10 mt-40 text-center px-6" @click="enterSite">
            <div class="inline-block bg-white/40 backdrop-blur-md px-6 py-2 rounded-full text-white text-xs font-black tracking-[0.2em] border border-white/50 mb-6 animate-float shadow-lg">TOKYO â€¢ FUJI â€¢ KAMAKURA</div>
            <h1 class="text-7xl font-black text-white drop-shadow-lg tracking-widest mb-2 font-sans" style="text-shadow: 0 4px 10px rgba(255,105,180,0.3);">é—œæ±ä¹‹æ—…</h1>
            <p class="text-3xl text-white/90 font-bold tracking-widest drop-shadow-md">2026.03.27</p>
        </div>
        <div class="relative z-10 mb-28 w-full px-10 pb-[env(safe-area-inset-bottom)]" @click="enterSite">
            <div class="w-full bg-white/90 text-pink-500 font-black py-5 rounded-full shadow-2xl backdrop-blur-xl text-xl flex items-center justify-center gap-3 border border-white animate-pulse-slow">
                <span class="animate-spin-slow">ğŸŒ¸</span> é»æ“Šä»»æ„è™•é–‹å§‹
            </div>
        </div>
    </div>

    <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-[64px] bg-[#FFF0F5]/85 backdrop-blur-xl z-30 flex items-center justify-between px-4 border-b border-white/50 shadow-sm pt-[env(safe-area-inset-top)] box-content transition-all">
        <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow-md border border-white active:scale-90 transition"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="font-black text-gray-700 text-lg flex items-center gap-2"><i class="fa-solid fa-sakura text-pink-300"></i> {{getPageTitle(currentView)}}</h1>
        <div v-if="currentUser" class="w-10 h-10 rounded-full bg-white border border-pink-200 overflow-hidden shadow-sm flex items-center justify-center text-xl" @click="showPersonaModal=true">
            <img v-if="currentUser.avatar" :src="currentUser.avatar" class="w-full h-full object-cover">
            <span v-else>{{currentUser.icon}}</span>
        </div>
        <div v-else class="w-10"></div>
    </div>
    <div v-if="currentView !== 'menu'" class="h-[64px] pt-[env(safe-area-inset-top)] box-content"></div>

    <div v-if="currentView==='menu'" class="min-h-screen p-6 pt-12 flex flex-col pb-40 animate-fade-in">
        <h2 class="text-3xl font-black text-gray-700 mb-8 text-center pt-[env(safe-area-inset-top)]">æ—…ç¨‹ä¸­å¿ƒ</h2>
        
        <div class="mb-8 bg-white/70 backdrop-blur-xl border border-white rounded-[32px] p-6 shadow-xl relative overflow-hidden group">
             <div class="absolute -right-5 -top-5 w-24 h-24 bg-yellow-100 rounded-full blur-2xl opacity-50"></div>
             <div class="flex items-start gap-4 relative z-10">
                 <div class="bg-gradient-to-br from-yellow-200 to-yellow-400 w-12 h-12 rounded-2xl flex items-center justify-center text-white text-xl shrink-0 shadow-lg"><i class="fa-solid fa-bell"></i></div>
                 <div class="flex-1">
                     <div class="font-black text-gray-800 text-lg mb-1">å€’æ•¸ {{daysUntilTrip}} å¤©</div>
                     <div class="text-xs text-gray-500 font-bold leading-relaxed space-y-1">
                        <div v-for="alert in smartReminders" class="text-pink-500 flex items-start gap-1"><i class="fa-solid fa-circle-exclamation mt-0.5"></i> {{alert}}</div>
                        <div v-if="smartReminders.length===0" class="text-gray-400">ç›®å‰ç„¡ç·Šæ€¥å¾…è¾¦äº‹é …ã€‚</div>
                     </div>
                 </div>
             </div>
        </div>
        
        <div class="grid grid-cols-3 gap-x-4 gap-y-8 px-2">
            <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition duration-300 group" @click="currentView=app.view">
                <div class="w-[76px] h-[76px] rounded-[30px] flex items-center justify-center text-3xl text-white shadow-lg border-[4px] border-white relative overflow-hidden" :class="app.bgClass"><i :class="app.icon"></i></div>
                <span class="text-sm font-bold mt-3 text-gray-600 group-hover:text-pink-500 transition">{{app.name}}</span>
            </div>
        </div>
        <button @click="isWelcomeClosed=false" class="mt-8 mx-auto text-gray-400 text-sm font-bold border-b border-gray-300 pb-1">å›åˆ°æ­¡è¿é é¢</button>
    </div>

    <div v-if="currentView==='itinerary'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="flex overflow-x-auto gap-3 mb-6 hide-scrollbar sticky top-[68px] bg-[#FFF0F5]/95 z-20 py-3 -mx-5 px-5 backdrop-blur-md">
             <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-6 py-3 rounded-2xl text-sm font-black border-2 transition shrink-0 shadow-sm flex flex-col items-center min-w-[70px]',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400 shadow-lg scale-105':'bg-white text-gray-300 border-white']"><span>{{d.week}}</span><span class="text-[10px] mt-1 opacity-80">{{d.title}}</span></button>
        </div>
        
        <div v-if="[1,2,3].includes(selectedDayIndex)" class="flex justify-center mb-4">
            <div class="bg-white p-1 rounded-full border border-gray-200 shadow-sm flex">
                <button @click="itineraryMode='normal'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='normal'?'bg-pink-400 text-white':'text-gray-400']">ä¸€èˆ¬</button>
                <button @click="itineraryMode='drive'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='drive'?'bg-green-500 text-white':'text-gray-400']"><i class="fa-solid fa-car"></i> è‡ªé§•</button>
            </div>
        </div>

        <div class="space-y-4">
            <div v-for="(item,idx) in getCurrentItinerary()" :key="idx" class="card p-5 border-0 shadow-sm relative group">
                <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-pink-300 to-pink-100"></div>
                <div class="flex gap-4">
                    <div class="flex flex-col items-center pt-1 min-w-[50px]">
                        <span class="text-xs font-black text-gray-400 mb-2">{{item.hours}}</span>
                        <div class="w-10 h-10 rounded-full bg-pink-50 text-pink-400 flex items-center justify-center text-lg border border-pink-100"><i :class="getIconByCategory(item.category)"></i></div>
                    </div>
                    <div class="flex-1 py-1">
                        <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                        <p class="text-sm text-gray-500 line-clamp-2 font-medium mb-2">{{item.note}}</p>
                        <a :href="getMapLink(item.mapKeyword, item.name)" target="_blank" class="inline-flex items-center gap-1 text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded-full font-bold border border-blue-100 hover:bg-blue-100 transition"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="currentView==='money'" class="px-5 py-4 pb-40 animate-fade-in">
         <div v-if="!currentUser" class="text-center py-10 text-gray-400">è«‹å…ˆé»æ“Šå³ä¸Šè§’é ­åƒé¸æ“‡æ‚¨çš„èº«åˆ†</div>
         <div v-else>
             <div class="flex gap-2 mb-4 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm">
                 <button @click="moneyTab='record'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='record'?'bg-yellow-400 text-white shadow-md':'text-gray-400']">æˆ‘çš„å¸³æœ¬</button>
                 <button @click="moneyTab='split'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='split'?'bg-blue-400 text-white shadow-md':'text-gray-400']">åˆ†å¸³ä¸­å¿ƒ</button>
             </div>
             
             <div class="flex justify-between items-center mb-4 px-2">
                 <div class="text-xs font-bold text-gray-500 bg-white px-2 py-1 rounded shadow-sm border">1 JPY = <input v-model="exchangeRate" class="w-12 text-center text-blue-500 outline-none" type="number"> TWD</div>
                 <div class="text-xs text-gray-400">åŒ¯ç‡åŒæ­¥ä¸­...</div>
             </div>

             <div v-if="moneyTab==='record'">
                 <div class="card p-6 bg-gradient-to-br from-yellow-300 to-orange-400 text-white border-none shadow-orange-200 mb-4">
                    <div class="flex justify-between items-end">
                        <div><div class="text-xs font-bold opacity-80 mb-1">{{currentUser.name}} çš„æ”¯å‡º (TWD)</div><div class="text-4xl font-black">${{Math.round(myTotalExpenseTWD).toLocaleString()}}</div></div>
                        <div class="text-right"><div class="text-xs font-bold opacity-80 mb-1">ç´„åˆæ—¥å¹£</div><div class="text-xl font-bold">Â¥{{Math.round(myTotalExpenseTWD/exchangeRate).toLocaleString()}}</div></div>
                    </div>
                 </div>
                 <div class="space-y-3">
                    <div v-for="exp in myExpenses" :key="exp.id" class="card p-4 flex justify-between items-center !mb-0 !rounded-2xl">
                        <div><div class="font-bold text-gray-800">{{exp.name}}</div><div class="text-[10px] text-gray-400">{{exp.date}}</div></div>
                        <div class="text-right"><span class="font-black text-gray-700 block">{{exp.currency==='TWD'?'$':'Â¥'}}{{exp.amount}}</span><span class="text-[10px] text-gray-400">â‰ˆ ${{Math.round(getAmountInTWD(exp))}}</span></div>
                    </div>
                 </div>
                 <button @click="openExpenseModal" class="fab-main bg-yellow-400 text-white"><i class="fa-solid fa-pen"></i></button>
             </div>
             
             <div v-if="moneyTab==='split'">
                 <div class="card p-6 border-l-4 border-blue-400">
                     <h3 class="font-bold text-blue-500 mb-4">å³æ™‚çµç®— (ä»¥ TWD è¨ˆç®—)</h3>
                     <div v-if="settlements.length===0" class="text-center text-gray-400 text-sm">ç›®å‰ç„¡é ˆåˆ†å¸³</div>
                     <div v-else class="space-y-3">
                         <div v-for="s in settlements" class="flex justify-between items-center bg-blue-50 p-3 rounded-xl">
                             <span class="font-bold text-gray-700 text-sm">{{getUserName(s.from)}} <i class="fa-solid fa-arrow-right text-blue-300 mx-1"></i> {{getUserName(s.to)}}</span>
                             <span class="font-black text-blue-600">TWD ${{s.amount.toLocaleString()}}</span>
                         </div>
                     </div>
                 </div>
             </div>
         </div>
    </div>

    <div v-if="currentView==='hotel'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="flex gap-2 mb-6 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm">
            <button @click="hotelTab='stay'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='stay'?'bg-indigo-500 text-white':'text-gray-400']">ä½å®¿</button>
            <button @click="hotelTab='flight'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='flight'?'bg-pink-500 text-white':'text-gray-400']">æˆ‘çš„æ©Ÿç¥¨</button>
            <button @click="hotelTab='car'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='car'?'bg-green-500 text-white':'text-gray-400']">ç§Ÿè»Š</button>
        </div>
        
        <div v-if="hotelTab==='stay'" class="space-y-6">
            <div class="card !p-0 border-0 shadow-xl overflow-hidden"><div class="h-40 bg-gray-200 relative"><img :src="getImg('bnb.jpg')" class="w-full h-full object-cover"><div class="absolute bottom-4 left-5 text-white shadow-black drop-shadow-md"><h3 class="font-black text-2xl">éŒ¦ç³¸ç”ºæ°‘å®¿</h3></div></div><div class="p-4"><a href="https://www.google.com/maps/search/?api=1&query=Lotte+City+Hotel+Kinshicho" target="_blank" class="w-full flex items-center justify-center gap-2 bg-indigo-50 text-indigo-600 font-bold py-3 rounded-xl border border-indigo-100"><i class="fa-solid fa-location-dot"></i> å°èˆª</a></div></div>
            <div class="card !p-0 border-0 shadow-xl overflow-hidden"><div class="h-40 bg-gray-200 relative"><img :src="getImg('megu.jpg')" class="w-full h-full object-cover"><div class="absolute bottom-4 left-5 text-white shadow-black drop-shadow-md"><h3 class="font-black text-2xl">Megu Fuji</h3></div></div><div class="p-4"><a href="https://www.google.com/maps/search/?api=1&query=Megu+Fuji+2021" target="_blank" class="w-full flex items-center justify-center gap-2 bg-indigo-50 text-indigo-600 font-bold py-3 rounded-xl border border-indigo-100"><i class="fa-solid fa-location-dot"></i> å°èˆª</a></div></div>
        </div>

        <div v-if="hotelTab==='flight'" class="animate-fade-in">
             <div v-if="!currentUser" class="text-center py-10 text-gray-400">è«‹å…ˆé¸æ“‡èº«åˆ†ä»¥æŸ¥çœ‹æ©Ÿç¥¨</div>
             <div v-else class="boarding-pass p-0 border-l-4 border-pink-500">
                 <div class="bg-pink-50 p-4 flex items-center gap-3 border-b border-pink-100">
                     <div class="w-12 h-12 rounded-full bg-white border flex items-center justify-center text-2xl"><img v-if="currentUser.avatar" :src="currentUser.avatar" class="w-full h-full object-cover"><span v-else>{{currentUser.icon}}</span></div>
                     <div class="flex-1"><div class="font-black text-gray-800 text-lg">{{currentUser.name}} çš„æ©Ÿç¥¨</div><div class="text-xs text-gray-500">é›»å­ç¥¨åˆ¸</div></div>
                     <button v-if="isLoggedIn" class="text-gray-400" @click="openUserEdit(currentUser)"><i class="fa-solid fa-pen"></i></button>
                 </div>
                 <div class="p-5 space-y-4">
                     <div class="flex justify-between items-center"><span class="text-xs text-gray-500 font-bold">å»ç¨‹ TR898</span><span class="font-black text-xl text-gray-800">{{currentUser.flightOutSeat||'æœªé¸ä½'}}</span></div>
                     <div class="flex justify-between items-center"><span class="text-xs text-gray-500 font-bold">å›ç¨‹ BR197</span><span class="font-black text-xl text-gray-800">{{currentUser.flightInSeat||'æœªé¸ä½'}}</span></div>
                 </div>
             </div>
        </div>

        <div v-if="hotelTab==='car'" class="animate-fade-in space-y-4">
             <div class="card p-5 border-l-4 border-green-500"><h3 class="font-black text-lg mb-2">Toyota Rent a Car</h3><p class="text-xs text-gray-500 mb-2">æ²³å£æ¹–ç«™å‰åº—ã€‚å„ªé»ï¼šè·é›¢è¿‘ã€è»Šæ³æ–°ã€‚</p><a href="https://rent.toyota.co.jp/zh-tw/" target="_blank" class="block text-center bg-green-500 text-white font-bold py-2 rounded-xl">é ç´„å®˜ç¶²</a></div>
             <div class="card p-5 border-l-4 border-blue-500"><h3 class="font-black text-lg mb-2">Nippon Rent-A-Car</h3><p class="text-xs text-gray-500 mb-2">æ²³å£æ¹–ç‡Ÿæ¥­æ‰€ã€‚å„ªé»ï¼šæœå‹™å¥½ã€å¯ç•°åœ°é‚„è»Šã€‚</p><a href="https://www.nrgroup-global.com/tw/" target="_blank" class="block text-center bg-blue-500 text-white font-bold py-2 rounded-xl">é ç´„å®˜ç¶²</a></div>
        </div>
    </div>

    <div v-if="currentView==='prep'" class="px-5 py-4 pb-40 animate-fade-in">
        <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="block w-full bg-gradient-to-r from-blue-600 to-blue-400 text-white rounded-2xl p-4 mb-6 shadow-lg flex items-center justify-between active:scale-95 transition">
            <div class="flex items-center gap-3"><i class="fa-solid fa-qrcode text-3xl"></i><div><div class="font-bold text-lg">Visit Japan Web</div><div class="text-xs opacity-80">å…¥å¢ƒå¿…å‚™ï¼Œè«‹æå‰æˆªåœ–</div></div></div><i class="fa-solid fa-chevron-right"></i>
        </a>

        <div class="card p-5 bg-gradient-to-r from-indigo-50 to-purple-50 border-indigo-200 mb-6">
            <h4 class="font-bold text-indigo-800 text-sm mb-3"><i class="fa-solid fa-wand-magic-sparkles"></i> ç¥¨åˆ¸ç²¾éˆ (Auto)</h4>
            <div class="space-y-3">
                <div v-for="t in suggestedTickets" class="bg-white p-3 rounded-xl shadow-sm border border-indigo-100 flex justify-between items-center">
                    <span class="text-sm font-bold text-gray-700">{{t.name}}</span>
                    <a :href="t.link" target="_blank" class="text-xs bg-indigo-500 text-white px-3 py-1.5 rounded-full font-bold">è³¼ç¥¨</a>
                </div>
            </div>
        </div>

        <div v-if="!currentUser" class="text-center text-gray-400">è«‹å…ˆé¸æ“‡èº«åˆ†ä»¥ç®¡ç†è¡Œæ</div>
        <div v-else class="card p-0">
            <div class="bg-gray-50 p-3 border-b font-bold text-gray-700 flex justify-between"><span>{{currentUser.name}} çš„è¡Œæ</span><button v-if="isLoggedIn" @click="addPrepItem(currentUser)" class="text-xs bg-white border px-2 py-1 rounded text-blue-500">+ æ–°å¢</button></div>
            <div v-for="(item, idx) in currentUser.list" :key="idx" class="flex items-center p-3 border-b border-gray-100">
                <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-500 mr-3" @change="saveData">
                <span :class="['flex-1 text-sm font-bold', item.checked?'text-gray-300 line-through':'text-gray-700']">{{item.text}}</span>
                <button v-if="isLoggedIn" @click="currentUser.list.splice(idx,1);saveData()" class="text-gray-300"><i class="fa-solid fa-times"></i></button>
            </div>
        </div>
    </div>

    <div v-if="currentView==='shopping'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="grid grid-cols-2 gap-3 mb-6">
            <a href="https://www.cosme.net/ranking/" target="_blank" class="bg-green-50 text-green-600 p-3 rounded-xl text-center font-bold text-xs border border-green-200 block">ğŸ‘‘ COSME å¤§è³</a>
            <a href="https://www.shinyusha.co.jp/media/ldk-the-beauty/" target="_blank" class="bg-pink-50 text-pink-600 p-3 rounded-xl text-center font-bold text-xs border border-pink-200 block">ğŸ’„ LDK æ¯’èˆŒé›œèªŒ</a>
        </div>
        <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
            <button v-for="cat in ['cosme','ldk','souvenir']" @click="shopCat=cat" :class="['px-5 py-2 rounded-full font-bold text-xs whitespace-nowrap transition', shopCat===cat?'bg-pink-400 text-white':'bg-white text-gray-400']">{{{'cosme':'è—¥å¦æ¸…å–®','ldk':'LDKæ¨è–¦','souvenir':'ä¼´æ‰‹ç¦®'}[cat]}}</button>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div v-for="(item,idx) in shopping[shopCat]" class="card !p-0 border-0 shadow-lg group relative" :key="idx">
                 <div class="h-32 bg-gray-100 relative overflow-hidden"><img :src="item.img" class="w-full h-full object-cover" @error="handleImgError"></div>
                 <div class="p-3">
                     <div class="font-bold text-gray-800 text-sm mb-1 truncate">{{item.name}}</div>
                     <a :href="item.link || getSearchLink(item.name)" target="_blank" class="block text-center bg-gray-50 text-gray-500 text-[10px] py-1.5 rounded font-bold hover:bg-pink-500 hover:text-white transition">å®˜æ–¹/æœå°‹</a>
                 </div>
                 <div v-if="isLoggedIn" class="absolute top-1 right-1"><button @click="shopping[shopCat].splice(idx,1);saveData()" class="bg-white/90 p-1 rounded-full text-red-500 shadow"><i class="fa-solid fa-trash"></i></button></div>
            </div>
        </div>
        <button v-if="isLoggedIn" @click="openAddShopModal" class="fab-main bg-purple-400 text-white"><i class="fa-solid fa-plus"></i></button>
    </div>

    <div v-if="['food','photo'].includes(currentView)" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="flex gap-2 mb-4 justify-center">
            <button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="currentLoc=loc" :class="['px-5 py-2 rounded-full font-bold text-xs transition', currentLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc]}}</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div v-for="(item,idx) in spots[currentView][currentLoc]" :key="idx" class="card !p-0 border-0 shadow-lg group relative">
                 <div class="h-48 bg-gray-100 relative overflow-hidden"><img :src="item.img" class="w-full h-full object-cover" @error="handleImgError"></div>
                 <div class="p-4">
                     <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                     <p class="text-sm text-gray-500 mb-3">{{item.desc}}</p>
                     <a :href="getMapLink(item.link, item.name)" target="_blank" class="block w-full text-center bg-gray-50 text-gray-600 font-bold py-2 rounded-lg text-sm border hover:bg-orange-400 hover:text-white transition"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                 </div>
                 <div v-if="isLoggedIn" class="absolute top-2 right-2"><button @click="spots[currentView][currentLoc].splice(idx,1);saveData()" class="w-8 h-8 bg-white rounded-full shadow text-red-500"><i class="fa-solid fa-trash"></i></button></div>
            </div>
        </div>
        <button v-if="isLoggedIn" @click="openAddSpotModal" class="fab-main bg-orange-400 text-white"><i class="fa-solid fa-plus"></i></button>
    </div>

    <div v-if="currentView==='weather'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="bg-pink-50 p-4 rounded-2xl border border-pink-200 mb-6 shadow-sm relative overflow-hidden">
             <i class="fa-solid fa-fan text-pink-200 text-6xl absolute -right-4 -bottom-4 animate-spin-slow"></i>
             <div class="relative z-10 text-center">
                 <h3 class="font-black text-pink-500 mb-3 text-sm">ğŸŒ¸ 2026 æ«»èŠ±é æ¸¬</h3>
                 <div class="grid grid-cols-3 gap-2">
                     <div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">æ±äº¬</div><div class="font-bold text-pink-600">3/22</div></div>
                     <div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">éŒå€‰</div><div class="font-bold text-pink-600">3/25</div></div>
                     <div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">å¯Œå£«å±±</div><div class="font-bold text-pink-600">4/10</div></div>
                 </div>
             </div>
        </div>
        <div class="space-y-4">
            <div v-for="w in weatherData" class="card p-6 text-white relative" :class="w.bg">
                <div class="relative z-10"><div class="font-bold opacity-80 uppercase text-xs">{{w.name}}</div><div class="text-5xl font-black my-2">{{w.temp}}Â°C</div><div class="text-sm bg-white/20 backdrop-blur inline-block px-3 py-1 rounded-full">ğŸ‘• {{getClothingAdvice(w.temp)}}</div></div>
                <i class="fa-solid fa-cloud-sun absolute -right-6 -bottom-6 text-9xl opacity-20"></i>
            </div>
        </div>
    </div>

    <div v-if="currentView==='japanese'" class="px-5 py-4 pb-40 animate-fade-in">
        <button @click="$refs.cameraInput.click()" class="w-full bg-gray-900 text-white rounded-2xl p-4 mb-6 shadow-lg flex items-center justify-center gap-3 active:scale-95 transition">
            <i class="fa-solid fa-camera text-2xl"></i><span class="font-bold">é–‹å•Ÿç›¸æ©Ÿç¿»è­¯</span>
        </button>
        <input type="file" ref="cameraInput" accept="image/*" capture="environment" class="hidden">

        <div class="space-y-3">
             <div v-for="(p,idx) in japanesePhrases" :key="idx" class="card p-5 flex justify-between items-center cursor-pointer hover:shadow-md transition border-l-4 border-emerald-400" @click="expandCard(p)">
                 <div><div class="font-bold text-lg text-gray-800">{{p.jp}}</div><div class="text-xs text-gray-500">{{p.zh}}</div></div>
                 <i class="fa-solid fa-expand text-gray-300"></i>
             </div>
        </div>
    </div>

    <div v-show="currentView!=='menu'" class="fab-home" @click="currentView='menu'"><i class="fa-solid fa-house"></i></div>

    <div v-if="showPersonaModal" class="fixed inset-0 z-[2000] bg-black/80 flex items-center justify-center p-6 backdrop-blur-md animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl">
            <h3 class="font-black text-2xl mb-6 text-gray-700">è«‹é¸æ“‡æ‚¨çš„èº«åˆ†</h3>
            <div class="grid grid-cols-2 gap-4">
                <div v-for="u in users" :key="u.id" @click="setCurrentUser(u)" class="cursor-pointer hover:scale-105 transition">
                    <div class="w-20 h-20 mx-auto rounded-full bg-gray-100 border-4 border-white shadow-md flex items-center justify-center text-3xl mb-2 overflow-hidden">
                        <img v-if="u.avatar" :src="u.avatar" class="w-full h-full object-cover">
                        <span v-else>{{u.icon}}</span>
                    </div>
                    <div class="font-bold text-gray-600">{{u.name}}</div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showExpenseModal" class="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center">è¨˜ä¸€ç­†</h3>
            <input v-model="modalData.name" placeholder="é …ç›®" class="w-full p-3 bg-gray-50 rounded-xl mb-3 border font-bold">
            <div class="flex gap-2 mb-3">
                <input type="number" v-model="modalData.amount" placeholder="é‡‘é¡" class="flex-1 p-3 bg-gray-50 rounded-xl border font-black text-lg">
                <select v-model="modalData.currency" class="bg-gray-100 rounded-xl px-2 font-bold text-sm"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
            </div>
            <div class="mb-4">
                <label class="text-xs text-gray-400 font-bold ml-1">èª°å…ˆä»˜?</label>
                <div class="flex gap-2 mt-1 overflow-x-auto"><button v-for="u in users" :key="u.id" @click="modalData.whoPaid=u.id" :class="['px-3 py-1 rounded-full text-xs font-bold border transition', modalData.whoPaid===u.id?'bg-yellow-400 text-white':'bg-white text-gray-400']">{{u.name}}</button></div>
            </div>
            <div class="mb-4">
                <label class="text-xs text-gray-400 font-bold ml-1">åˆ†çµ¦èª°? (é»æ“Šé¸æ“‡)</label>
                <div class="flex gap-2 mt-1 overflow-x-auto"><button v-for="u in users" :key="u.id" @click="toggleShare(u.id)" :class="['px-3 py-1 rounded-full text-xs font-bold border transition', modalData.forWhom.includes(u.id)?'bg-blue-400 text-white':'bg-white text-gray-400']">{{u.name}}</button></div>
            </div>
            <button @click="saveExpense" class="w-full py-3 bg-yellow-400 text-white rounded-xl font-bold shadow-lg">å„²å­˜</button>
            <button @click="showExpenseModal=false" class="w-full py-3 mt-2 text-gray-400 font-bold">å–æ¶ˆ</button>
        </div>
    </div>

    <div v-if="expandedPhrase" class="fixed inset-0 z-[2000] bg-white flex flex-col items-center justify-center p-10 text-center" @click="expandedPhrase=null"><div class="text-6xl font-black mb-6">{{expandedPhrase.jp}}</div><div class="text-2xl font-bold text-gray-500">{{expandedPhrase.zh}}</div></div>
    <div v-if="showLoginModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-3xl p-8 shadow-2xl"><h3 class="text-2xl font-black text-center mb-6">ç®¡ç†å“¡ç™»å…¥</h3><input v-model="loginForm.email" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 font-bold" placeholder="Email"><input v-model="loginForm.password" type="password" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 font-bold" placeholder="Password"><button @click="doLogin" class="w-full py-4 bg-pink-500 text-white font-black rounded-2xl">ç™»å…¥</button></div></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3.3.4/dist/vue.esm-browser.js";

// Firebase Config
const firebaseConfig = { apiKey: "AIzaSyD3ojbkJVfDKmZQHRpZG-gp8gv7ajKdJr4", authDomain: "tokyo-trip-24b28.firebaseapp.com", projectId: "tokyo-trip-24b28", storageBucket: "tokyo-trip-24b28.firebasestorage.app", messagingSenderId: "518699705070", appId: "1:518699705070:web:56e95f603210d8d5d209ff" };

let auth, db; try { const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) {}

const defaultData = {
    users: [{id:1,name:'å‰ä¼Š',icon:'ğŸ¹',list:[]},{id:2,name:'å°å…«',icon:'ğŸ±',list:[]},{id:3,name:'å…”å…”',icon:'ğŸ°',list:[]},{id:4,name:'å°æ¡ƒ',icon:'ğŸ‘',list:[]}],
    itinerary: [
        [{hours:"06:40",category:"Flight",name:"TPE èµ·é£›",note:"T1"},{hours:"10:40",category:"Flight",name:"æŠµé” NRT",note:"å…¥å¢ƒ"},{hours:"14:00",category:"Sightseeing",name:"æ™´ç©ºå¡”",note:"é€›è¡—"},{hours:"18:00",category:"Food",name:"æ•˜æ•˜è‹‘",note:"æ™šé¤"}],
        [{hours:"07:08",category:"Transport",name:"å¯Œå£«å›éŠ",note:"å‰å¾€æ²³å£æ¹–"},{hours:"09:28",category:"Transport",name:"æŠµé”æ²³å£æ¹–",note:"å–è»Š"},{hours:"10:30",category:"Sightseeing",name:"æ–°å€‰å±±æ·ºé–“å…¬åœ’",note:"äº”é‡å¡”"},{hours:"12:30",category:"Food",name:"ä¸å‹•èŒ¶å±‹",note:"åˆé¤"},{hours:"14:30",category:"Sightseeing",name:"å¤§çŸ³å…¬åœ’",note:"èŠ±æµ·"}],
        [{hours:"06:00",category:"Sightseeing",name:"å¹³é‡ä¹‹æ¿±",note:"é€†å¯Œå£«"},{hours:"09:00",category:"Sightseeing",name:"é•·æ± è¦ªæ°´å…¬åœ’",note:"å¤©éµ"},{hours:"13:00",category:"Food",name:"å±±éº“åœ’",note:"åˆé¤"}],
        [{hours:"09:00",category:"Sightseeing",name:"å¤©ä¸Šå±±çºœè»Š",note:"çµ•æ™¯"},{hours:"11:00",category:"Shopping",name:"å¯Œå£«å±±åå¸",note:"ä¼´æ‰‹ç¦®"},{hours:"13:30",category:"Transport",name:"Toyota é‚„è»Š",note:"ç«™å‰"},{hours:"14:00",category:"Transport",name:"å›æ–°å®¿",note:"å·´å£«"}],
        [{hours:"09:00",category:"Transport",name:"æ±Ÿä¹‹é›»",note:"å¾€éŒå€‰"},{hours:"10:00",category:"Sightseeing",name:"éŒå€‰é«˜æ ¡å‰",note:"çŒç±ƒé«˜æ‰‹"},{hours:"12:00",category:"Food",name:"Bills",note:"é¬†é¤…"},{hours:"14:00",category:"Sightseeing",name:"é•·è°·å¯º",note:"å¤§ä½›"}],
        [{hours:"10:00",category:"Sightseeing",name:"æ±äº¬éµå¡”",note:"èŠå…¬åœ’"},{hours:"13:00",category:"Sightseeing",name:"éº»å¸ƒå°ä¹‹ä¸˜",note:"æ–°åœ°æ¨™"},{hours:"17:30",category:"Sightseeing",name:"SHIBUYA SKY",note:"å±•æœ›å°"},{hours:"19:30",category:"Food",name:"æ¾€è°·æ©«ä¸",note:"æ™šé¤"}],
        [{hours:"10:00",category:"Shopping",name:"æœ€å¾Œè£œè²¨",note:"å”å‰è¨¶å¾·"},{hours:"13:00",category:"Transport",name:"å¾€æˆç”°",note:"NEX"},{hours:"20:40",category:"Flight",name:"NRT èµ·é£›",note:"å›å®¶"}]
    ],
    // V22 æ–°å¢è‡ªé§•è¡Œç¨‹
    drivePlan: [
        [{hours:"10:00",name:"æ–°å€‰å±±æ·ºé–“å…¬åœ’",note:"äº”é‡å¡”"},{hours:"12:30",name:"ä¸å‹•èŒ¶å±‹",note:"æ±æˆ€è·¯åº—"},{hours:"14:30",name:"å¤§çŸ³å…¬åœ’",note:"èŠ±æµ·"}],
        [{hours:"06:00",name:"å¹³é‡ä¹‹æ¿±",note:"é€†å¯Œå£«"},{hours:"09:00",name:"é•·æ± è¦ªæ°´å…¬åœ’",note:"å¤©éµ"},{hours:"13:00",name:"å±±éº“åœ’",note:"çˆç«¯ç‡’"}],
        [{hours:"09:00",name:"å¤©ä¸Šå±±çºœè»Š",note:"å…”å­ç¥ç¤¾"},{hours:"11:00",name:"å¯Œå£«å±±åå¸",note:"ä¼´æ‰‹ç¦®"},{hours:"13:30",name:"æ²³å£æ¹–ç«™é‚„è»Š",note:"Toyota"}]
    ],
    expenses: [],
    spots: {food:{Tokyo:[],Kamakura:[],Fuji:[]},photo:{Tokyo:[],Kamakura:[],Fuji:[]}},
    shopping: {cosme:[],ldk:[],souvenir:[]},
    phrases: [{jp:'ã™ã¿ã¾ã›ã‚“',zh:'ä¸å¥½æ„æ€'}]
};

createApp({
    setup() {
        const currentView = ref('welcome');
        const currentUser = ref(null); // Privacy Shield
        const showPersonaModal = ref(false);
        const isLoggedIn = ref(false);
        const isWelcomeClosed = ref(false);
        const showLoginModal = ref(false);
        const loginForm = ref({email:'',password:''});
        
        // Data
        const users = ref(defaultData.users);
        const itinerary = ref(defaultData.itinerary);
        const drivePlan = ref(defaultData.drivePlan);
        const expenses = ref([]);
        const spots = ref(defaultData.spots);
        const shopping = ref(defaultData.shopping);
        const japanesePhrases = ref(defaultData.phrases);
        
        // State
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        const exchangeRate = ref(0.215);
        const moneyTab = ref('record');
        const hotelTab = ref('stay');
        const shopCat = ref('cosme');
        const currentLoc = ref('Tokyo');
        const weatherData = ref([{name:'Tokyo',temp:'--'},{name:'Kamakura',temp:'--'},{name:'Fuji',temp:'--'}]);
        
        // Modals
        const showExpenseModal = ref(false);
        const modalData = ref({});
        const expandedPhrase = ref(null);

        // Apps
        const apps = [{id:1,name:'è¡Œç¨‹',icon:'fa-solid fa-map',view:'itinerary'},{id:2,name:'å°è²¡åº«',icon:'fa-solid fa-yen-sign',view:'money'},{id:3,name:'ä½å®¿äº¤é€š',icon:'fa-solid fa-hotel',view:'hotel'},{id:4,name:'è¡Œå‰æº–å‚™',icon:'fa-solid fa-suitcase',view:'prep'},{id:5,name:'åƒåƒå–å–',icon:'fa-solid fa-utensils',view:'food'},{id:6,name:'ç¶²ç¾æ‰“å¡',icon:'fa-solid fa-camera',view:'photo'},{id:7,name:'å¿«æ¨‚è³¼',icon:'fa-solid fa-bag-shopping',view:'shopping'},{id:8,name:'å¤©æ°£',icon:'fa-solid fa-cloud-sun',view:'weather'},{id:9,name:'ç¿»è­¯',icon:'fa-solid fa-language',view:'japanese'}];
        const tripDays = [{week:'D1',title:'3/27'},{week:'D2',title:'3/28'},{week:'D3',title:'3/29'},{week:'D4',title:'3/30'},{week:'D5',title:'3/31'},{week:'D6',title:'4/01'},{week:'D7',title:'4/02'}];

        // 8. æ™ºèƒ½æé†’
        const daysUntilTrip = ref(Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24)));
        const smartReminders = computed(() => {
            const list = [];
            if(daysUntilTrip.value <= 30) list.push("å¯Œå£«å›éŠè™Ÿè©²æ¶ç¥¨äº†ï¼");
            if(daysUntilTrip.value <= 2) list.push("é…·èˆª/é•·æ¦® ç·šä¸Šå ±åˆ° (48hrå‰)");
            if(daysUntilTrip.value <= 30) list.push("SHIBUYA SKY é–‹æ”¾é ç´„ (30å¤©å‰)");
            if(daysUntilTrip.value <= 60) list.push("è¿ªå£«å°¼é–€ç¥¨ é–‹æ”¾é ç´„ (2å€‹æœˆå‰)");
            return list;
        });

        // 1. è¡Œç¨‹é‚è¼¯ (å«è‡ªé§•)
        const getCurrentItinerary = () => {
            if(itineraryMode.value === 'drive' && [1,2,3].includes(selectedDayIndex.value)) {
                return drivePlan.value[selectedDayIndex.value - 1] || [];
            }
            return itinerary.value[selectedDayIndex.value] || [];
        };

        // 2. è¨˜å¸³é‚è¼¯ (é›™å¹£åˆ¥+åˆ†å¸³)
        const myExpenses = computed(() => currentUser.value ? expenses.value.filter(e => e.whoPaid === currentUser.value.id || e.forWhom.includes(currentUser.value.id)) : []);
        const getAmountInTWD = (e) => e.currency === 'JPY' ? e.amount * exchangeRate.value : e.amount;
        const myTotalExpenseTWD = computed(() => {
            if(!currentUser.value) return 0;
            let total = 0;
            expenses.value.forEach(e => {
                const amtTWD = getAmountInTWD(e);
                if(e.forWhom.includes(currentUser.value.id)) {
                    total += amtTWD / e.forWhom.length;
                }
            });
            return total;
        });
        const settlements = computed(() => {
            const bal = {}; users.value.forEach(u=>bal[u.id]=0);
            expenses.value.forEach(e => {
                const amtTWD = getAmountInTWD(e);
                const payer = e.whoPaid;
                bal[payer] += amtTWD;
                const share = amtTWD / e.forWhom.length;
                e.forWhom.forEach(uid => bal[uid] -= share);
            });
            const res = [];
            const net = users.value.map(u => ({id:u.id, val: bal[u.id]}));
            const db = net.filter(n=>n.val < -1).sort((a,b)=>a.val-b.val);
            const cr = net.filter(n=>n.val > 1).sort((a,b)=>b.val-a.val);
            let i=0, j=0;
            while(i<db.length && j<cr.length) {
                let amt = Math.min(-db[i].val, cr[j].val);
                res.push({from:db[i].id, to:cr[j].id, amount:Math.round(amt)});
                db[i].val += amt; cr[j].val -= amt;
                if(Math.abs(db[i].val)<1) i++;
                if(Math.abs(cr[j].val)<1) j++;
            }
            return res;
        });

        // 7. åœ°åœ–é€£çµå„ªåŒ–
        const getMapLink = (k, n) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k || n)}`;
        const getSearchLink = (n) => `https://www.google.com/search?q=${encodeURIComponent(n)}`;
        const getImg = (p) => p.startsWith('data:') ? p : `https://raw.githubusercontent.com/sunny5200820-maker/2026.tokyo.fuji.trip/main/${p}`;
        const handleImgError = (e) => e.target.src = 'https://placehold.co/400x300?text=Image';
        const getUserName = (id) => users.value.find(u=>u.id===id)?.name || 'æœªçŸ¥';
        const getClothingAdvice = (t) => t<10?'ç¾½çµ¨+åœå·¾':t<15?'å¤§è¡£+ç™¼ç†±è¡£':'æ´‹è”¥å¼ç©¿æ­';

        // Actions
        const enterSite = () => { isWelcomeClosed.value = true; showPersonaModal.value = true; };
        const setCurrentUser = (u) => { currentUser.value = u; showPersonaModal.value = false; currentView.value = 'menu'; };
        const getPageTitle = (v) => apps.find(a=>a.view===v)?.name || v;
        const getIconByCategory = (c) => ({'Flight':'fa-plane','Sightseeing':'fa-camera','Food':'fa-utensils','Shopping':'fa-bag-shopping','Transport':'fa-train','Hotel':'fa-bed'}[c]||'fa-star');
        
        // Modal Actions
        const openExpenseModal = () => {
            modalData.value = {name:'', amount:'', currency:'JPY', whoPaid: currentUser.value.id, forWhom: users.value.map(u=>u.id)};
            showExpenseModal.value = true;
        };
        const toggleShare = (uid) => {
            const idx = modalData.value.forWhom.indexOf(uid);
            if(idx > -1) modalData.value.forWhom.splice(idx,1); else modalData.value.forWhom.push(uid);
        };
        const saveExpense = () => {
            if(!modalData.value.name || !modalData.value.amount) return;
            expenses.value.push({...modalData.value, id: Date.now(), date: new Date().toLocaleDateString()});
            saveData(); showExpenseModal.value = false;
        };
        const deleteExpense = (id) => { if(confirm('åˆªé™¤?')) { expenses.value = expenses.value.filter(e=>e.id!==id); saveData(); }};
        const addPrepItem = (u) => { u.list.push({text:'æ–°é …ç›®', checked:false}); saveData(); };
        const expandCard = (p) => expandedPhrase.value = p;
        
        // Auth & Save
        const handleAuthClick = () => { isLoggedIn.value ? (confirm('ç™»å‡º?') && signOut(auth)) : showLoginModal.value = true; };
        const doLogin = async () => { try { await signInWithEmailAndPassword(auth, loginForm.value.email, loginForm.value.password); showLoginModal.value=false; } catch(e){ alert(e.message); }};
        const saveData = async () => {
            if(db && isLoggedIn.value) await setDoc(doc(db, "trips", "kanto2026"), { users:users.value, expenses:expenses.value, itinerary:itinerary.value, drivePlan:drivePlan.value, spots:spots.value, shopping:shopping.value, phrases:japanesePhrases.value }, {merge:true});
            else localStorage.setItem('V22_LOCAL', JSON.stringify({ users:users.value, expenses:expenses.value, itinerary:itinerary.value, drivePlan:drivePlan.value, spots:spots.value, shopping:shopping.value, phrases:japanesePhrases.value }));
        };

        const suggestedTickets = computed(() => {
            const notes = JSON.stringify(itinerary.value);
            const list = [];
            if(notes.includes('è¿ªå£«å°¼')) list.push({name:'æ±äº¬è¿ªå£«å°¼é–€ç¥¨',link:'https://www.klook.com/zh-TW/activity/695-tokyo-disney-resort-1-day-pass-tokyo/'});
            if(notes.includes('SHIBUYA SKY')) list.push({name:'SHIBUYA SKY',link:'https://www.klook.com/zh-TW/activity/28522-shibuya-sky-ticket-tokyo/'});
            return list;
        });

        const fetchWeather = async () => {
            try {
                const getW = async (lat,lon,idx) => { const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`); const d = await r.json(); weatherData.value[idx].temp = d.current_weather.temperature; };
                await getW(35.6895, 139.6917, 0); await getW(35.3192, 139.5467, 1); await getW(35.3606, 138.7274, 2);
            } catch(e){}
        };

        onMounted(() => {
            if(auth) onAuthStateChanged(auth, u => { isLoggedIn.value=!!u; if(u) onSnapshot(doc(db,"trips","kanto2026"), d=>{ if(d.exists()) { const data=d.data(); users.value=data.users; expenses.value=data.expenses; itinerary.value=data.itinerary; drivePlan.value=data.drivePlan||defaultData.drivePlan; spots.value=data.spots; shopping.value=data.shopping; japanesePhrases.value=data.phrases; }}) });
            const local = localStorage.getItem('V22_LOCAL');
            if(local && !auth) { const d=JSON.parse(local); users.value=d.users; expenses.value=d.expenses; itinerary.value=d.itinerary; drivePlan.value=d.drivePlan; spots.value=d.spots; shopping.value=d.shopping; japanesePhrases.value=d.phrases; }
            fetchWeather();
        });

        return {
            currentView, isWelcomeClosed, isLoggedIn, enterSite, getPageTitle, apps, currentUser, showPersonaModal, setCurrentUser,
            daysUntilTrip, smartReminders, tripDays, selectedDayIndex, itineraryMode, getCurrentItinerary,
            moneyTab, exchangeRate, myExpenses, myTotalExpenseTWD, settlements, getUserName, openExpenseModal, showExpenseModal, modalData, toggleShare, saveExpense, deleteExpense,
            hotelTab, openUserEdit:()=>{},
            addPrepItem, suggestedTickets,
            shopCat, shopping, openAddShopModal:()=>{},
            currentLoc, spots, openAddSpotModal:()=>{},
            weatherData, getClothingAdvice,
            japanesePhrases, expandCard, expandedPhrase,
            getIconByCategory, getMapLink, getSearchLink, getImg, handleImgError,
            handleAuthClick, showLoginModal, loginForm, doLogin, saveData,
            addItineraryItem:()=>{ itinerary.value[selectedDayIndex.value].push({hours:'10:00',category:'Sightseeing',name:'æ–°è¡Œç¨‹',note:''}); saveData(); }
        };
    }
}).mount('#app');
</script>
</body>
</html>
