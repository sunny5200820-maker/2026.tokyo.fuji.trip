<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (V72.0 åš´æ ¼å¯©æŸ¥ç‰ˆ)</title>

<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

<script>
    window.tailwind = {
        config: {
            theme: {
                extend: {
                    colors: { 'chii-pink': '#FFD1DC', 'chii-blue': '#A2D2FF', 'chii-yellow': '#FFF5BA', 'emer-bg': '#FFF6F8', 'emer-blue': '#E0F7FA', 'emer-green': '#E8F5E9' },
                    fontFamily: { sans: ['Zen Maru Gothic', 'sans-serif'] },
                    animation: { 'float': 'float 6s ease-in-out infinite', 'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)', 'pulse-fast': 'pulse 1.5s infinite' },
                    keyframes: {
                        float: { '0%,100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        pop: { '0%': { transform: 'scale(0)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    }
</script>

<style>
    /* å…¨åŸŸè¨­å®š */
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: "Zen Maru Gothic", sans-serif; color: #5D4037; background-color: #FFF0F5; overflow: hidden; -webkit-tap-highlight-color: transparent; }
    #fixed-bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(#FFD1DC 15%, transparent 16%) 0 0, radial-gradient(#FFF5BA 15%, transparent 16%) 30px 30px; background-size: 60px 60px; opacity: 0.6; }
    #app-content { height: 100%; overflow-y: auto; padding-bottom: 120px; padding-top: env(safe-area-inset-top); position: relative; z-index: 10; }
    [v-cloak] { display: none !important; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }

    /* æ­¡è¿é  */
    .welcome-screen { position: fixed; inset: 0; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #FFF0F5; }
    .welcome-bg-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.8; z-index: -1; }

    /* å¡ç‰‡èˆ‡æŒ‰éˆ• */
    .card { background: rgba(255,255,255,0.95); border-radius: 20px; box-shadow: 0 4px 15px rgba(255,105,180,0.1); border: 2px solid white; margin-bottom: 12px; position: relative; overflow: hidden; backdrop-filter: blur(5px); }
    .btn-push:active { transform: scale(0.95); transition: transform 0.1s; }
    
    /* æ©Ÿç¥¨å¡ç‰‡ */
    .ticket-card { border-left: 5px solid; background: white; border-radius: 16px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 10px; position: relative; }
    .ticket-card.scoot { border-color: #F9E216; } .ticket-card.eva { border-color: #007A33; }

    /* ç·šä¸Šé ­åƒ */
    .online-avatar { width: 34px; height: 34px; border-radius: 50%; border: 2px solid white; background: #eee; margin-left: -10px; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .online-avatar.active { border-color: #4ade80; z-index: 10; transform: translateY(-3px); }

    /* æ‡¸æµ®è¿”å›éµ */
    .fab-home { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; background: linear-gradient(135deg, #FF9EAC, #FFD1DC); border-radius: 50%; border: 4px solid white; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 10px 25px rgba(255,105,180,0.4); z-index: 100; cursor: pointer; transition: transform 0.2s; }
    .fab-home:active { transform: translateX(-50%) scale(0.9); }

    /* æ™‚é–“è»¸ç·š */
    .timeline-line { position: absolute; left: 23px; top: 35px; bottom: -20px; width: 2px; background: #e5e7eb; z-index: 0; }
    
    /* æ€¥æ•‘åŒ… Grid */
    .emer-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    @media (min-width: 640px) { .emer-grid { grid-template-columns: repeat(4, 1fr); } }
</style>
</head>
<body>

<div id="fixed-bg"></div>

<div id="app" v-cloak class="h-full flex flex-col relative">

    <div v-if="isLoading" class="fixed inset-0 z-[9999] bg-[#FFF0F5] flex flex-col items-center justify-center">
        <div class="text-6xl animate-bounce mb-4">ğŸ—»</div>
        <div class="font-bold text-gray-500">æ­£åœ¨æª¢æŸ¥æ‰€æœ‰è¡Œç¨‹...</div>
        <div class="text-xs text-gray-400 mt-2">V72.0 åš´æ ¼å¯©æŸ¥ç‰ˆ</div>
    </div>

    <div v-if="!isWelcomeClosed" class="welcome-screen">
        <img :src="getImg('mount fuji cherry blossom')" class="welcome-bg-img">
        <div class="z-10 text-center p-8 bg-white/40 backdrop-blur-md rounded-3xl border border-white/60 shadow-2xl mx-6">
            <div class="inline-block bg-pink-500 text-white text-xs font-black px-3 py-1 rounded-full mb-4">TOKYO 2026</div>
            <h1 class="text-5xl font-black text-white drop-shadow-lg mb-2 tracking-widest">é—œæ±ä¹‹æ—…</h1>
            <p class="text-2xl text-white font-bold mb-8">3/27 - 4/03</p>
            <button @click="enterSite" class="w-full py-4 bg-white text-pink-500 font-black rounded-full shadow-lg btn-push text-lg active:scale-95 transition">
                <i class="fa-solid fa-plane"></i> æ—…ä¼´ç™»å…¥
            </button>
            <div class="mt-4 text-white text-xs font-bold">{{ isLoggedIn ? 'ğŸŸ¢ è³‡æ–™åº«é€£ç·šæ­£å¸¸' : 'â˜ï¸ é»æ“Šç™»å…¥åŒæ­¥' }}</div>
        </div>
    </div>

    <div v-else class="h-full flex flex-col">
        
        <div v-if="currentView!=='menu'" class="h-[60px] shrink-0 flex items-center justify-between px-4 bg-[#FFF0F5]/90 backdrop-blur border-b border-white z-20">
            <button @click="currentView='menu'" class="w-9 h-9 bg-white rounded-full text-pink-400 shadow flex items-center justify-center btn-push"><i class="fa-solid fa-chevron-left"></i></button>
            <h1 class="font-black text-gray-700 text-lg">{{getPageTitle(currentView)}}</h1>
            <div class="w-9"></div>
        </div>

        <div id="app-content" class="px-4 py-6">
            
            <div v-if="currentView==='menu'" class="pb-24">
                <div class="flex justify-between items-center mb-6">
                    <button @click="isWelcomeClosed=false" class="text-xs bg-white text-gray-500 px-4 py-2 rounded-full font-bold border hover:bg-gray-50 shadow-sm flex items-center gap-2 btn-push">
                        <i class="fa-solid fa-house"></i> å›é¦–é 
                    </button>
                    <div class="flex pl-3">
                        <div v-for="u in users" :key="u.id" :class="['online-avatar', isUserOnline(u.id)?'active':'']" :title="u.name">
                            {{u.icon}}
                            <div v-if="isUserOnline(u.id)" class="absolute bottom-0 right-0 w-2 h-2 bg-green-400 rounded-full border border-white"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-6 shadow-lg border-4 border-white mb-8 relative overflow-hidden">
                    
                    <div v-if="daysUntilTrip > 0">
                        <div class="inline-block bg-red-100 text-red-600 text-[10px] font-black px-2 py-1 rounded mb-3">å‡ºç™¼å‰æ•´å‚™</div>
                        <div v-if="getUncheckedCount() > 0" class="mb-3">
                            <div class="text-red-500 font-bold text-sm animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> é‚„æœ‰ {{getUncheckedCount()}} é …è£å‚™æœªå¸¶ï¼</div>
                            <div class="text-xs text-gray-400 pl-5">è«‹æª¢æŸ¥è¡Œææ¸…å–® (è­·ç…§/ç¶²å¡...)</div>
                        </div>
                        <div v-else class="text-green-500 font-bold text-sm mb-3"><i class="fa-solid fa-check-circle"></i> è¡Œææº–å‚™å®Œæˆ</div>
                        <div class="border-t border-gray-100 pt-3 space-y-1">
                            <div class="text-xs font-bold text-pink-500 flex items-center gap-1"><i class="fa-solid fa-ticket"></i> å¯Œå£«å›éŠè™Ÿ (30å¤©å‰æ¶ç¥¨)</div>
                            <div class="text-xs font-bold text-orange-500 flex items-center gap-1"><i class="fa-solid fa-camera"></i> SHIBUYA SKY é»ƒæ˜ç¥¨</div>
                        </div>
                    </div>
                    <div v-else>
                        <div class="inline-block bg-blue-100 text-blue-600 text-[10px] font-black px-2 py-1 rounded mb-3">æ±äº¬æƒ…å ±</div>
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-3xl font-black text-gray-800">18Â°C</h3>
                            <i class="fa-solid fa-cloud-sun text-4xl text-blue-300"></i>
                        </div>
                        <p class="text-xs font-bold text-gray-600">ğŸ‘• å»ºè­°ç©¿æ­ï¼šå¤§è¡£ + ç™¼ç†±è¡£</p>
                    </div>
                </div>

                <div v-if="daysUntilTrip > 0" class="text-center mb-8">
                    <div class="text-5xl font-black text-pink-500 drop-shadow-sm tracking-widest">{{daysUntilTrip}} <span class="text-lg text-gray-400">DAYS</span></div>
                    <div class="text-xs font-bold text-gray-400 mt-1">è·é›¢å‡ºç™¼å€’æ•¸</div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div v-for="app in apps" :key="app.id" @click="currentView=app.view" class="flex flex-col items-center btn-push cursor-pointer">
                        <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-3xl text-white shadow-md mb-2 border-2 border-white" :class="app.bgClass"><i :class="app.icon"></i></div>
                        <span class="text-xs font-bold text-gray-600">{{app.name}}</span>
                    </div>
                </div>
            </div>

            <div v-if="currentView==='itinerary'">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4 sticky top-0 bg-[#FFF0F5] z-10 py-2">
                    <button v-for="(d,i) in tripDays" :key="i" @click="selectedDay=i" :class="['px-4 py-2 rounded-xl border-2 font-bold text-sm min-w-[60px] flex-shrink-0 transition', selectedDay===i?'bg-pink-400 text-white border-pink-400 shadow-md':'bg-white text-gray-400 border-white']">
                        {{d.label}}
                    </button>
                </div>

                <div v-if="[2,3,4].includes(selectedDay)" class="flex justify-center mb-6">
                    <div class="bg-white p-1 rounded-full border shadow-sm flex">
                        <button @click="driveMode=false" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', !driveMode?'bg-pink-400 text-white':'text-gray-400']">ä¸€èˆ¬</button>
                        <button @click="driveMode=true" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', driveMode?'bg-green-500 text-white':'text-gray-400']"><i class="fa-solid fa-car"></i> è‡ªé§•</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div v-for="(item, idx) in getCurrentItinerary()" :key="idx" class="relative pl-12 group">
                        <div class="timeline-line" v-if="idx < getCurrentItinerary().length-1"></div>
                        <div class="absolute left-0 top-0 w-10 text-center">
                            <span class="text-[10px] font-black text-gray-400 block mb-1">{{item.time}}</span>
                            <div class="w-3 h-3 rounded-full border-2 bg-white mx-auto relative z-10" :class="driveMode&&(selectedDay>=2&&selectedDay<=4)?'border-green-500':'border-pink-400'"></div>
                        </div>
                        <div class="card p-4 ml-2" :class="driveMode&&(selectedDay>=2&&selectedDay<=4)?'border-l-4 border-l-green-500':''">
                            <div class="flex justify-between items-start">
                                <h3 class="font-black text-gray-800 text-lg">{{item.title}}</h3>
                                <button v-if="!isGuest" @click="openEditModal('itinerary', item, idx)" class="text-gray-300 hover:text-blue-400"><i class="fa-solid fa-pen"></i></button>
                            </div>
                            <p class="text-xs text-gray-500 font-bold mb-3">{{item.desc}}</p>
                            <div class="flex gap-2">
                                <a :href="item.map || getMapLink(item.title)" target="_blank" class="bg-blue-50 text-blue-500 px-3 py-1 rounded-lg text-xs font-bold active:scale-95"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                                <div v-if="!isGuest" class="flex gap-1 ml-auto">
                                    <button @click="moveItineraryItem(idx, -1)" class="w-6 h-6 bg-gray-100 rounded text-xs"><i class="fa-solid fa-arrow-up"></i></button>
                                    <button @click="moveItineraryItem(idx, 1)" class="w-6 h-6 bg-gray-100 rounded text-xs"><i class="fa-solid fa-arrow-down"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button v-if="!isGuest" @click="openAddModal('itinerary')" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white">+ æ–°å¢è¡Œç¨‹</button>
                </div>
            </div>

            <div v-if="currentView==='money'">
                <div class="flex justify-center gap-2 mb-4">
                    <button @click="moneyTab='private'" :class="['px-6 py-2 rounded-full font-bold text-xs', moneyTab==='private'?'bg-yellow-400 text-white':'bg-white text-gray-400']">å€‹äººç§å¸³</button>
                    <button @click="moneyTab='public'" :class="['px-6 py-2 rounded-full font-bold text-xs', moneyTab==='public'?'bg-blue-400 text-white':'bg-white text-gray-400']">å…¬æ¬¾åˆ†å¸³</button>
                </div>
                
                <div v-if="moneyTab==='public'">
                    <div class="bg-blue-50 p-4 rounded-2xl mb-4 border border-blue-100">
                        <h3 class="font-bold text-blue-600 text-sm mb-3">ğŸ’° çµç®—ä¸­å¿ƒ (å³æ™‚)</h3>
                        <div v-for="s in settlements" class="flex justify-between text-xs font-bold border-b border-blue-200/50 py-2">
                            <span>{{s.from}} <i class="fa-solid fa-arrow-right text-gray-400 mx-1"></i> {{s.to}}</span>
                            <span class="text-blue-600">${{Math.round(s.amount)}}</span>
                        </div>
                        <div v-if="settlements.length===0" class="text-xs text-gray-400">ç›®å‰ç„¡æ¬ æ¬¾</div>
                    </div>
                    <div v-for="exp in publicExpenses" class="card p-3 flex justify-between items-center">
                        <div><div class="font-bold text-gray-800">{{exp.item}}</div><div class="text-[10px] text-gray-400">{{exp.payer}} å¢Šä»˜ ({{exp.share}}äººåˆ†)</div></div>
                        <div class="font-black text-blue-500">{{exp.currency}} {{exp.amount}}</div>
                    </div>
                </div>

                <div v-if="moneyTab==='private'">
                    <div class="bg-yellow-50 p-6 rounded-2xl mb-4 text-center border border-yellow-100">
                        <div class="text-xs font-bold text-yellow-600 mb-1">å€‹äººç¸½æ”¯å‡º</div>
                        <div class="text-4xl font-black text-yellow-500">NT$ {{Math.round(myTotal)}}</div>
                    </div>
                    <div v-for="exp in myExpenses" class="card p-3 flex justify-between items-center">
                        <div class="font-bold text-gray-800">{{exp.item}}</div>
                        <div class="font-black text-gray-600">{{exp.currency}} {{exp.amount}}</div>
                    </div>
                </div>
                <button @click="openAddModal('expense')" class="fab-home bg-yellow-400 text-white"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div v-if="currentView==='hotel'">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4">
                    <button v-for="t in ['ä½å®¿','æ©Ÿç¥¨','ç§Ÿè»Š','äº¤é€šç¥¨','æ™¯é»ç¥¨']" @click="hotelTab=t" :class="['px-4 py-2 rounded-full font-bold text-xs whitespace-nowrap', hotelTab===t?'bg-indigo-500 text-white':'bg-white text-gray-400']">{{t}}</button>
                </div>

                <div v-if="hotelTab==='æ©Ÿç¥¨'">
                    <div class="ticket-card scoot">
                        <div class="flex justify-between mb-2"><span class="font-black text-yellow-600">å»ç¨‹ SCOOT</span><button v-if="!isGuest" @click="editFlight('out')" class="text-gray-300"><i class="fa-solid fa-pen"></i></button></div>
                        <div class="flex justify-between font-black text-xl mb-1"><div>{{currentUser.flightOut}}</div><div>{{currentUser.seatOut}}</div></div>
                        <div class="text-xs text-gray-500 font-bold">06:40 TPE (T1) â” 10:40 NRT (T1)</div>
                    </div>
                    <div class="ticket-card eva">
                        <div class="flex justify-between mb-2"><span class="font-black text-green-700">å›ç¨‹ EVA AIR</span><button v-if="!isGuest" @click="editFlight('in')" class="text-gray-400"><i class="fa-solid fa-pen"></i></button></div>
                        <div class="flex justify-between font-black text-xl mb-1"><div>{{currentUser.flightIn}}</div><div>{{currentUser.seatIn}}</div></div>
                        <div class="text-xs text-gray-500 font-bold">20:40 NRT (T1) â” 23:20 TPE (T2)</div>
                    </div>
                </div>

                <div v-if="hotelTab==='ç§Ÿè»Š'" class="space-y-3">
                    <div v-for="car in rentalCars" :key="car.name" class="card p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-black text-lg">{{car.name}}</h3>
                            <a :href="car.link" target="_blank" class="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold">é ç´„</a>
                        </div>
                        <p class="text-xs text-gray-500 font-bold"><i class="fa-solid fa-location-dot"></i> {{car.pickup}}</p>
                    </div>
                </div>

                <div v-if="hotelTab==='äº¤é€šç¥¨'" class="space-y-3">
                    <div v-for="t in transTickets" :key="t.name" class="card p-4 flex justify-between items-center">
                        <div><div class="font-bold">{{t.name}}</div><div class="text-[10px] text-gray-400">{{t.note}}</div></div>
                        <a :href="t.link" target="_blank" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow">è³¼è²·</a>
                    </div>
                </div>

                <div v-if="hotelTab==='æ™¯é»ç¥¨'" class="space-y-3">
                    <div v-for="t in attrTickets" :key="t.name" class="card p-4 border-l-4 border-pink-400 flex justify-between items-center">
                        <div><div class="font-bold">{{t.name}}</div><div class="text-[10px] text-gray-400">{{t.note}}</div></div>
                        <a :href="t.link" target="_blank" class="bg-pink-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow">è³¼è²·</a>
                    </div>
                </div>
                
                <div v-if="hotelTab==='ä½å®¿'" class="space-y-4">
                    <div v-for="h in hotels" class="card p-0">
                        <div class="h-32 bg-gray-200 relative"><img :src="getImg(h.key)" class="w-full h-full object-cover"><div class="absolute bottom-2 left-3 text-white font-black text-lg shadow-black drop-shadow-md">{{h.name}}</div></div>
                        <div class="p-3"><a :href="h.link" target="_blank" class="block bg-indigo-50 text-indigo-500 text-center py-2 rounded font-bold text-sm">å°èˆªå‰å¾€</a></div>
                    </div>
                </div>
            </div>

            <div v-if="currentView==='prep'">
                <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="card p-4 bg-blue-500 text-white border-none mb-4 flex items-center justify-between">
                    <div><div class="font-black text-lg">Visit Japan Web</div><div class="text-xs opacity-80">å…¥å¢ƒå¯©æŸ¥ / æµ·é—œç”³å ±</div></div><i class="fa-solid fa-chevron-right"></i>
                </a>
                <div class="card p-0">
                    <div class="bg-gray-50 p-3 font-bold text-gray-700 border-b flex justify-between">
                        <span>{{currentUser.name}} çš„è¡Œæ</span>
                        <button @click="addPrepItem" class="text-blue-500 text-xs">+ æ–°å¢</button>
                    </div>
                    <div v-for="(item,idx) in currentUser.list" :key="idx" class="p-3 border-b flex items-center">
                        <input type="checkbox" v-model="item.checked" class="mr-3 w-5 h-5 accent-pink-500" @change="saveData">
                        <input v-model="item.text" class="flex-1 bg-transparent outline-none font-bold text-sm" :class="item.checked?'line-through text-gray-300':'text-gray-700'" @change="saveData">
                        <button @click="currentUser.list.splice(idx,1);saveData()" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
            </div>

            <div v-if="currentView==='food'">
                <div class="flex gap-2 justify-center mb-4">
                    <button v-for="l in ['æ±äº¬','éŒå€‰','å¯Œå£«å±±','è¶…å•†']" @click="foodLoc=l" :class="['px-3 py-2 rounded-full font-bold text-xs', foodLoc===l?'bg-orange-400 text-white':'bg-white text-gray-400']">{{l}}</button>
                </div>
                
                <div v-if="foodLoc!=='è¶…å•†'" class="grid grid-cols-2 gap-3">
                    <div v-for="f in foodSpots[foodLoc]" :key="f.name" class="card p-0">
                        <div class="h-28 bg-gray-200"><img :src="getImg(f.key)" class="w-full h-full object-cover"></div>
                        <div class="p-2">
                            <div class="font-bold text-xs truncate">{{f.name}}</div>
                            <div class="text-[10px] text-gray-500 mb-2 truncate">{{f.desc}}</div>
                            <a :href="f.link || getMapLink(f.name)" target="_blank" class="block bg-gray-100 text-center py-1 rounded text-[10px] font-bold">å°èˆª</a>
                        </div>
                    </div>
                </div>
                
                <div v-else class="space-y-4">
                    <div v-for="(items, store) in cvsFoods" :key="store">
                        <h3 class="font-black text-lg mb-2 pl-2 border-l-4" :class="store.includes('L')?'border-blue-500':store.includes('7')?'border-green-500':'border-green-300'">{{store}}</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div v-for="i in items" class="bg-white p-2 rounded border text-xs font-bold text-center">{{i}}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView==='photo'" class="space-y-6">
                <div v-for="loc in ['æ±äº¬','éŒå€‰','å¯Œå£«å±±']" :key="loc">
                    <h3 class="font-black text-pink-500 mb-2 pl-2 text-lg">{{loc}}</h3>
                    <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2">
                        <div v-for="p in photoSpots[loc]" class="shrink-0 w-44 card p-0">
                            <div class="h-32 bg-gray-200"><img :src="getImg(p.key)" class="w-full h-full object-cover"></div>
                            <div class="p-3">
                                <div class="font-bold text-sm mb-1">{{p.name}}</div>
                                <div class="text-[10px] text-gray-400 mb-2 leading-tight">{{p.desc}}</div>
                                <a :href="getMapLink(p.name)" target="_blank" class="block bg-blue-50 text-blue-500 text-center rounded py-1 text-[10px] font-bold">ğŸ“ åœ°åœ–</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView==='shopping'">
                <div class="flex gap-2 mb-4">
                    <a href="https://www.cosme.net/ranking/" target="_blank" class="flex-1 bg-green-100 text-green-600 text-center py-2 rounded-xl font-bold text-xs">ğŸ‘‘ COSME</a>
                    <a href="https://www.shinyusha.co.jp/media/ldk-the-beauty/" target="_blank" class="flex-1 bg-pink-100 text-pink-600 text-center py-2 rounded-xl font-bold text-xs">ğŸ’„ LDK</a>
                </div>
                <div class="flex gap-2 overflow-x-auto mb-4">
                    <a href="https://www.djapanpass.com/" class="px-3 py-1 bg-yellow-100 text-yellow-600 rounded-full text-xs font-bold whitespace-nowrap">å”å‰è¨¶å¾·åˆ¸</a>
                    <a href="https://www.biccamera.com/" class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-xs font-bold whitespace-nowrap">Bic Camera</a>
                </div>
                <div class="space-y-4">
                    <div>
                        <h3 class="font-bold text-gray-500 text-xs mb-2">ğŸ’„ è—¥å¦å¿…è²·</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div v-for="s in shopping.cosme" class="card p-3 flex items-center gap-2">
                                <img :src="getImg(s.name)" class="w-10 h-10 rounded object-cover bg-gray-100">
                                <div class="font-bold text-xs">{{s.name}}</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-500 text-xs mb-2">ğŸ ä¼´æ‰‹ç¦®</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div v-for="s in shopping.gift" class="card p-3 flex items-center gap-2">
                                <img :src="getImg(s.name)" class="w-10 h-10 rounded object-cover bg-gray-100">
                                <div class="font-bold text-xs">{{s.name}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView==='weather'">
                <div class="card p-4 mb-4 bg-pink-50 border-pink-200">
                    <h3 class="font-black text-pink-500 mb-2">ğŸŒ¸ 2026 æ«»èŠ±é æ¸¬</h3>
                    <p class="text-xs text-gray-500 font-bold mb-3">æ±äº¬æ»¿é–‹é æ¸¬ï¼š3/22 - 3/29</p>
                    <div class="flex gap-2">
                        <a href="https://weathernews.jp/s/sakura/" target="_blank" class="flex-1 bg-white py-2 rounded text-center text-xs font-bold shadow text-pink-400">Weathernews</a>
                        <a href="https://tenki.jp/sakura/" target="_blank" class="flex-1 bg-white py-2 rounded text-center text-xs font-bold shadow text-pink-400">Tenki.jp</a>
                    </div>
                </div>
                <div class="card p-6 bg-blue-400 text-white mb-4">
                    <div class="flex justify-between items-center">
                        <div><div class="text-xs font-bold opacity-80">TOKYO</div><div class="text-5xl font-black">18Â°C</div></div>
                        <i class="fa-solid fa-cloud-sun text-4xl"></i>
                    </div>
                    <div class="mt-2 bg-white/20 inline-block px-3 py-1 rounded-full text-xs font-bold">å¤§è¡£ + åœå·¾</div>
                </div>
                <div class="card p-6 bg-indigo-400 text-white">
                    <div class="flex justify-between items-center">
                        <div><div class="text-xs font-bold opacity-80">FUJI</div><div class="text-5xl font-black">12Â°C</div></div>
                        <i class="fa-solid fa-cloud text-4xl"></i>
                    </div>
                    <div class="mt-2 bg-white/20 inline-block px-3 py-1 rounded-full text-xs font-bold">ç¾½çµ¨å¤–å¥—</div>
                </div>
            </div>

            <div v-if="currentView==='emergency'">
                <div class="emer-grid mb-10">
                    <div class="bg-white border-2 border-red-100 rounded-xl p-3 text-center"><div class="text-2xl mb-1">ğŸš“</div><div class="font-black text-xs text-gray-700">110 å ±è­¦</div><a href="tel:110" class="block mt-2 bg-gray-100 text-[10px] font-bold py-1 rounded">æ’¥æ‰“</a></div>
                    <div class="bg-white border-2 border-blue-100 rounded-xl p-3 text-center"><div class="text-2xl mb-1">ğŸš‘</div><div class="font-black text-xs text-gray-700">119 æ•‘è­·</div><a href="tel:119" class="block mt-2 bg-gray-100 text-[10px] font-bold py-1 rounded">æ’¥æ‰“</a></div>
                    <div class="bg-white border-2 border-green-100 rounded-xl p-3 text-center"><div class="text-2xl mb-1">ğŸŒ</div><div class="font-black text-xs text-gray-700">æ—…å®¢å°ˆç·š</div><a href="tel:05038162787" class="block mt-2 bg-gray-100 text-[10px] font-bold py-1 rounded">æ’¥æ‰“</a></div>
                    <div class="bg-white border-2 border-pink-100 rounded-xl p-3 text-center"><div class="text-2xl mb-1">ğŸ‡¹ğŸ‡¼</div><div class="font-black text-xs text-gray-700">ä»£è¡¨è™•</div><a href="tel:0332807811" class="block mt-2 bg-gray-100 text-[10px] font-bold py-1 rounded">æ’¥æ‰“</a></div>
                </div>
                <div class="space-y-2 mb-20">
                    <div v-for="p in phrases" class="card p-3 border-l-4 border-indigo-400">
                        <div class="font-bold text-gray-800">{{p.jp}}</div><div class="text-xs text-gray-500">{{p.zh}}</div>
                    </div>
                </div>
                <div class="fixed bottom-24 right-4 flex flex-col gap-3">
                    <button @click="camTrans" class="w-14 h-14 rounded-full bg-gray-800 text-white flex items-center justify-center shadow-lg text-xl"><i class="fa-solid fa-camera"></i></button>
                    <button @click="openTranslate" class="w-14 h-14 rounded-full bg-indigo-500 text-white flex items-center justify-center shadow-lg text-xl"><i class="fa-solid fa-language"></i></button>
                </div>
            </div>

        </div> <div v-if="currentView !== 'menu'" class="fab-home" @click="currentView='menu'"><i class="fa-solid fa-house"></i></div>

    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { createApp, ref, computed, onMounted } from "https://unpkg.com/vue@3.3.4/dist/vue.esm-browser.js";

const firebaseConfig = { apiKey: "AIzaSyD3ojbkJVfDKmZQHRpZG-gp8gv7ajKdJr4", authDomain: "tokyo-trip-24b28.firebaseapp.com", projectId: "tokyo-trip-24b28", storageBucket: "tokyo-trip-24b28.firebasestorage.app", messagingSenderId: "518699705070", appId: "1:518699705070:web:56e95f603210d8d5d209ff" };
let auth, db; try { const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); enableIndexedDbPersistence(db).catch(()=>{}); } catch(e){console.warn("FB Error");}

// â˜… V70.0 å®Œæ•´é è¨­è³‡æ–™åº« (å…¨å¡«å……) â˜…
const fullDefaultData = {
    users: [
        {id:1,name:'å‰ä¼Š',icon:'ğŸ¹',list:[{text:'è­·ç…§',checked:false}],flightOut:'TR898',seatOut:'',flightIn:'BR197',seatIn:''},
        {id:2,name:'å°å…«',icon:'ğŸ±',list:[{text:'è­·ç…§',checked:false}],flightOut:'TR898',seatOut:'',flightIn:'BR197',seatIn:''},
        {id:3,name:'å…”å…”',icon:'ğŸ°',list:[{text:'è­·ç…§',checked:false}],flightOut:'TR898',seatOut:'',flightIn:'BR197',seatIn:''},
        {id:4,name:'å°æ¡ƒ',icon:'ğŸ‘',list:[{text:'è­·ç…§',checked:false}],flightOut:'TR898',seatOut:'',flightIn:'BR197',seatIn:''}
    ],
    // ä¸€èˆ¬è¡Œç¨‹ (Day 1-8)
    itineraryNormal: [
        [{time:'06:40', title:'TPE -> NRT', desc:'10:40æŠµé”, è²·Suica'}, {time:'14:00', title:'æ™´ç©ºå¡”', desc:'ä¸‹åˆèŒ¶ & é€›è¡—'}, {time:'18:00', title:'éŒ¦ç³¸ç”ºæ™šé¤', desc:'ç‡’è‚‰/å±…é…’å±‹'}],
        [{time:'09:00', title:'æ·ºè‰å¯º', desc:'é›·é–€æ‹ç…§'}, {time:'12:00', title:'æ·ºè‰åˆé¤', desc:'ç‚¸ç‰›æ’'}, {time:'14:00', title:'å°ç¶²ç¥ç¤¾', desc:'å¼·é‹å„é™¤'}, {time:'19:00', title:'ç§‹è‘‰åŸ/ä¸€ç•ªè¡—', desc:'æ™šé¤ä¾é€›è¡—æ±ºå®š'}],
        [{time:'08:00', title:'å‰å¾€å¯Œå£«å±±', desc:'éŒ¦ç³¸ç”ºæ­å¯Œå£«å›éŠ'}, {time:'11:00', title:'æŠµé”æ²³å£æ¹–', desc:'æ­å·´å£«/çºœè»Š'}, {time:'13:00', title:'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨', desc:'å¤§çŸ³å…¬åœ’'}, {time:'19:00', title:'ä¸å‹•èŒ¶å±‹', desc:'é¤ºé£¥éºµ'}],
        [{time:'09:00', title:'å¿é‡å…«æµ·', desc:'æ¹§æ³‰ç¾¤'}, {time:'12:00', title:'å±±ä¸­æ¹–', desc:'æ­å·´å£«å‰å¾€'}, {time:'14:00', title:'KABA å·´å£«', desc:'æ°´é™¸å…©ç”¨'}, {time:'18:00', title:'æ™šé¤', desc:'è¶…å¸‚ç†Ÿé£Ÿ'}],
        [{time:'09:00', title:'æ–°å€‰å±±æ·ºé–“å…¬åœ’', desc:'äº”é‡å¡”'}, {time:'11:00', title:'é‡‘é³¥å±…', desc:'æ‹ç…§'}, {time:'14:00', title:'å¯Œå£«å›éŠè¿”æ±äº¬', desc:'å›æ–°å®¿æ”¾è¡Œæ'}, {time:'17:00', title:'æ± è¢‹å¤ªé™½åŸ', desc:'é€›è¡—æ™šé¤'}],
        [{time:'09:00', title:'æ–°å®¿ -> è—¤æ¾¤', desc:'æ±Ÿä¹‹é›»ä¸€æ—¥éŠ'}, {time:'10:30', title:'æ±Ÿä¹‹å³¶', desc:'ç¥ç¤¾/è€è¡—'}, {time:'12:30', title:'éŒå€‰é«˜æ ¡å‰', desc:'å¹³äº¤é“æ‹ç…§'}, {time:'13:30', title:'ä¸ƒé‡Œæ¿±', desc:'Bills åˆé¤'}, {time:'16:00', title:'éŒå€‰/é¶´å²¡å…«å¹¡å®®', desc:'å°ç”ºé€š'}],
        [{time:'09:00', title:'æ±äº¬éµå¡”', desc:'èŠå…¬åœ’/å…­æœ¬æœ¨'}, {time:'12:00', title:'å…­æœ¬æœ¨åˆé¤', desc:'æ•˜æ•˜è‹‘?'}, {time:'14:00', title:'æ¾€è°·é€›è¡—', desc:'Parco/109'}, {time:'17:00', title:'SHIBUYA SKY', desc:'æ—¥è½æ™‚æ®µ'}, {time:'19:00', title:'æ¾€è°·æ™šé¤', desc:'å±…é…’å±‹'}],
        [{time:'10:00', title:'æœ€å¾Œæ¡è²·', desc:'ä¸Šé‡é˜¿ç¾æ©«ä¸'}, {time:'16:00', title:'Skyliner', desc:'å‰å¾€æˆç”°æ©Ÿå ´'}, {time:'20:40', title:'NRT -> TPE', desc:'23:20 æŠµé”'}]
    ],
    // è‡ªé§•è¡Œç¨‹ (Day 3, 4, 5)
    drivePlan: [
        [{time:'08:00', title:'å‰å¾€å¯Œå£«å±±', desc:'éŒ¦ç³¸ç”ºå‡ºç™¼'}, {time:'10:30', title:'é–‹å§‹ç§Ÿè»Š', desc:'æ²³å£æ¹–ç«™å‰åº—'}, {time:'13:00', title:'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨', desc:'å¤§çŸ³å…¬åœ’çµ•æ™¯'}, {time:'15:00', title:'æ–°å€‰å±±æ·ºé–“å…¬åœ’', desc:'å¿ éˆå¡”'}, {time:'17:30', title:'é‡‘é³¥å±…/æœ¬ç”ºé€š', desc:'æ—¥å·æ™‚è¨ˆåº—æ‹ç…§'}, {time:'19:00', title:'æ™šé¤', desc:'è‡ªè¡Œçƒ¹é£ªæˆ–å•†åº—è¡—'}],
        [{time:'05:00', title:'å¹³é‡ä¹‹æ¿±', desc:'çœ‹æ—¥å‡º (é–‹è»Š)'}, {time:'09:00', title:'é•·æ± è¦ªæ°´å…¬åœ’', desc:'ç™½é³¥æ¿±/ç§Ÿè…³è¸è»Š'}, {time:'12:00', title:'å±±ä¸­æ¹–åˆé¤', desc:'æ¹–ç•”é¤å»³'}, {time:'14:00', title:'KABA æ°´é™¸å·´å£«', desc:'æ—­æ—¥ä¸˜'}, {time:'18:00', title:'Ogino è¶…å¸‚', desc:'è²·é£Ÿæå›æ°‘å®¿ç…®'}],
        [{time:'09:00', title:'é‡‘é³¥å±…', desc:'æ‹ç…§'}, {time:'10:00', title:'æ²³å£æ¹–çºœè»Š', desc:'çµ•æ™¯é¦éŸ†'}, {time:'11:30', title:'Fujisan Shokupan', desc:'è²·åå¸'}, {time:'13:30', title:'é‚„è»Š', desc:'æ²³å£æ¹–ç«™å‰åº—'}, {time:'14:00', title:'æ­å¯Œå£«å›éŠ', desc:'è¿”å›æ–°å®¿'}]
    ],
    spots: {
        food: {
            'æ±äº¬': [{name:'å™å™è‹‘',desc:'é«˜ç´šç‡’è‚‰',key:'yakiniku'},{name:'AFURI',desc:'æŸšå­é¹½æ‹‰éºµ',key:'ramen'},{name:'HARBS',desc:'æ°´æœåƒå±¤',key:'cake'},{name:'ç‰›ã‹ã¤ã‚‚ã¨æ‘',desc:'ç‚¸ç‰›æ’',key:'beef cutlet'},{name:'å…­å˜èˆ',desc:'æ²¾éºµ',key:'tsukemen'}],
            'å¯Œå£«å±±': [{name:'ä¸å‹•èŒ¶å±‹',desc:'é¤ºé£¥éºµ',key:'hoto noodle'},{name:'å±±éº“åœ’',desc:'çˆç«¯ç‡’',key:'irori'},{name:'ç„¼è‚‰ã²ã¾ã‚ã‚Š',desc:'ç‡’è‚‰',key:'bbq'},{name:'Lake Bake',desc:'æ¹–ç•”éºµåŒ…',key:'bakery'},{name:'Ogino',desc:'è¶…å¸‚ç†Ÿé£Ÿ',key:'supermarket food'}],
            'éŒå€‰': [{name:'Bills',desc:'é¬†é¤…',key:'pancakes'},{name:'Pacific Drive-in',desc:'æµ·æ™¯å’–å•¡',key:'cafe sea'},{name:'Caraway',desc:'å’–å“©',key:'curry'},{name:'å»ä»”é­šä¸¼',desc:'ç‰¹ç”¢',key:'whitebait bowl'},{name:'åŠ›é¤…å®¶',desc:'å’Œè“å­',key:'mochi'}],
            'è¶…å•†': [] // ç¨‹å¼ç”Ÿæˆ
        },
        photo: {
            'æ±äº¬': [{name:'SHIBUYA SKY',desc:'çµ•ç¾æ—¥è½',key:'shibuya sky'},{name:'æ±äº¬éµå¡”',desc:'èŠå…¬åœ’',key:'tokyo tower'},{name:'è±ªå¾·å¯º',desc:'æ‹›è²¡è²“',key:'gotokuji'},{name:'æ·ºè‰é›·é–€',desc:'å¤§ç‡ˆç± ',key:'sensoji'},{name:'TeamLab',desc:'å…‰å½±',key:'teamlab'}],
            'å¯Œå£«å±±': [{name:'ä¸‹å‰ç”°æœ¬ç”ºé€š',desc:'æ—¥å·æ™‚è¨ˆåº—',key:'mt fuji street'},{name:'é€†å¯Œå£«',desc:'æ²³å£æ¹–å¤§æ©‹',key:'lake kawaguchi'},{name:'æ–°å€‰å±±æ·ºé–“',desc:'äº”é‡å¡”',key:'chureito'},{name:'å¤§çŸ³å…¬åœ’',desc:'èŠ±æµ·',key:'oishi park'},{name:'å¿é‡å…«æµ·',desc:'æ¹§æ³‰',key:'oshino'}],
            'éŒå€‰': [{name:'éŒå€‰é«˜æ ¡å‰',desc:'çŒç±ƒé«˜æ‰‹',key:'slam dunk crossing'},{name:'é•·è°·å¯º',desc:'ç´«é™½èŠ±',key:'hasedera'},{name:'ä¸ƒé‡Œæ¿±',desc:'æµ·å²¸',key:'shichirigahama'},{name:'é«˜å¾·é™¢',desc:'å¤§ä½›',key:'daibutsu'},{name:'æ±Ÿä¹‹å³¶',desc:'é³¥å±…',key:'enoshima'}]
        }
    },
    shopping: { 
        cosme: [{name:'Canmake è…®ç´…'},{name:'Excel çœ¼å½±'},{name:'Minon é¢è†œ'},{name:'Fino é«®è†œ'},{name:'Tirtir æ°£å¢Š'}],
        gift: [{name:'NY Perfect Cheese'},{name:'Press Butter Sand'},{name:'Sugar Butter Tree'},{name:'Tokyo Banana'},{name:'ç™½è‰²æˆ€äºº'}]
    },
    hotels: [
        {name:'éŒ¦ç³»ç”º Sumida City', key:'hotel room', link:'https://maps.app.goo.gl/4WscHTq9R7eK5fGC8'},
        {name:'Megu Fuji 2021', key:'mt fuji hotel', link:'https://maps.app.goo.gl/MsiGap6HiHFwQ7yh8'},
        {name:'DOMO é£¯åº—', key:'tokyo hotel', link:'https://maps.app.goo.gl/1kLupuWjXwntskSq9'}
    ],
    transTickets: [
        {name:'Suica è¥¿ç“œå¡',note:'äº¤é€šå¿…å‚™',link:'https://www.jreast.co.jp/'},
        {name:'æ±äº¬åœ°éµåˆ¸',note:'72å°æ™‚',link:'https://www.tokyometro.jp/'}
    ],
    attrTickets: [
        {name:'å¯Œå£«å›éŠè™Ÿ',note:'30å¤©å‰æ¶ç¥¨',link:'https://www.eki-net.com/'},
        {name:'SHIBUYA SKY',note:'æ¶é»ƒæ˜æ™‚æ®µ',link:'https://www.shibuya-scramble-square.com/'}
    ],
    rentalCars: [
        {name:'Toyota Rent a Car', pickup:'æ²³å£æ¹–ç«™', link:'https://rent.toyota.co.jp/'},
        {name:'Tabirai ç§Ÿè»Šæ¯”åƒ¹', pickup:'æ²³å£æ¹–/æ©Ÿå ´', link:'https://tc.tabirai.net/'}
    ],
    phrases: [{jp:'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹',zh:'å»æ‰€åœ¨å“ª'},{jp:'ã“ã‚Œãã ã•ã„',zh:'æˆ‘è¦é€™å€‹'},{jp:'ã„ãã‚‰ã§ã™ã‹',zh:'å¤šå°‘éŒ¢'},{jp:'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™',zh:'çµå¸³'},{jp:'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹',zh:'å¯åˆ·å¡å—'}]
};

createApp({
    setup() {
        const isLoading = ref(true);
        const isWelcomeClosed = ref(false);
        const currentView = ref('welcome');
        const isLoggedIn = ref(false);
        const currentUser = ref(null);
        const isGuest = ref(false);
        const activeUsers = ref({});
        
        // Data Refs
        const users = ref(JSON.parse(JSON.stringify(fullDefaultData.users)));
        const itineraryNormal = ref(JSON.parse(JSON.stringify(fullDefaultData.itineraryNormal)));
        const drivePlan = ref(JSON.parse(JSON.stringify(fullDefaultData.drivePlan)));
        const spots = ref(JSON.parse(JSON.stringify(fullDefaultData.spots)));
        const shopping = ref(JSON.parse(JSON.stringify(fullDefaultData.shopping)));
        const hotels = ref(JSON.parse(JSON.stringify(fullDefaultData.hotels)));
        const transTickets = ref(JSON.parse(JSON.stringify(fullDefaultData.transTickets))); // äº¤é€šç¥¨
        const attrTickets = ref(JSON.parse(JSON.stringify(fullDefaultData.attrTickets))); // æ™¯é»ç¥¨
        const rentalCars = ref(JSON.parse(JSON.stringify(fullDefaultData.rentalCars)));
        const phrases = ref(JSON.parse(JSON.stringify(fullDefaultData.phrases)));
        const expenses = ref([]);
        
        // UI Logic
        const selectedDay = ref(0);
        const driveMode = ref(true);
        const moneyTab = ref('private');
        const hotelTab = ref('ä½å®¿');
        const foodLoc = ref('æ±äº¬');
        const daysUntilTrip = ref(Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24)));
        const rate = ref(0.215);

        const apps = [
            {id:1,name:'è¡Œç¨‹è¡¨',icon:'fa-solid fa-map',view:'itinerary',bgClass:'bg-pink-400'},
            {id:2,name:'å°è²¡åº«',icon:'fa-solid fa-yen-sign',view:'money',bgClass:'bg-yellow-400'},
            {id:3,name:'ä½å®¿äº¤é€š',icon:'fa-solid fa-hotel',view:'hotel',bgClass:'bg-indigo-400'},
            {id:4,name:'è¡Œå‰æº–å‚™',icon:'fa-solid fa-suitcase',view:'prep',bgClass:'bg-blue-400'},
            {id:5,name:'ç¾é£Ÿåœ°åœ–',icon:'fa-solid fa-utensils',view:'food',bgClass:'bg-orange-400'},
            {id:6,name:'å¿…æ‹æ©Ÿä½',icon:'fa-solid fa-camera',view:'photo',bgClass:'bg-rose-400'},
            {id:7,name:'å¿«æ¨‚è³¼',icon:'fa-solid fa-bag-shopping',view:'shopping',bgClass:'bg-purple-400'},
            {id:8,name:'å¤©æ°£é å ±',icon:'fa-solid fa-cloud-sun',view:'weather',bgClass:'bg-sky-400'},
            {id:9,name:'æ€¥æ•‘åŒ…',icon:'fa-solid fa-kit-medical',view:'emergency',bgClass:'bg-red-400'}
        ];
        
        const tripDays = [{label:'D1',hp:100},{label:'D2',hp:80},{label:'D3',hp:60},{label:'D4',hp:50},{label:'D5',hp:70},{label:'D6',hp:90},{label:'D7',hp:80},{label:'D8',hp:100}];
        
        const cvsFoods = {
            'Lawson': ['ç‚¸é›å›','æƒ¡é­”é£¯ç³°','ç”Ÿä¹³æ²','å·´æ–¯å…‹','çƒ¤é›è‚‰ä¸²'],
            '7-11': ['ç ‚ç³–å¥¶æ²¹æ¨¹','åŠç†Ÿè›‹é£¯ç³°','é—œæ±ç…®','åƒå±¤è›‹ç³•','å’–å•¡'],
            'FamilyMart': ['å…¨å®¶ç‚¸é›','èˆ’èŠ™é›·å¸ƒä¸','ç‰§å ´ç‰›å¥¶å†°','é®ªé­šé£¯ç³°','çƒ¤åœ°ç“œ']
        };

        // Helpers
        const getImg = (k) => `https://source.unsplash.com/400x300/?${encodeURIComponent(k)}`;
        const getPageTitle = (v) => apps.find(a=>a.view===v)?.name || 'é—œæ±ä¹‹æ—…';
        const getMapLink = (k) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}`;
        const isUserOnline = (id) => activeUsers.value[id] && (Date.now() - activeUsers.value[id] < 65000);
        const getUncheckedCount = () => currentUser.value ? currentUser.value.list.filter(i=>!i.checked).length : 0;
        const camTrans = () => window.open('https://translate.google.com/?sl=auto&tl=zh-TW&op=images');
        const openTranslate = () => window.open('https://translate.google.com/?sl=zh-TW&tl=ja&op=translate');
        
        const getCurrentItinerary = () => {
            if (driveMode.value && (selectedDay.value >= 2 && selectedDay.value <= 4)) {
                return drivePlan.value[selectedDay.value - 2] || [];
            }
            return itineraryNormal.value[selectedDay.value] || [];
        };

        // Computed
        const myExpenses = computed(() => currentUser.value ? expenses.value.filter(e => e.payer===currentUser.value.id && e.share===1) : []);
        const myTotal = computed(() => myExpenses.value.reduce((s,e)=>s+(e.currency==='JPY'?e.amount*rate.value:e.amount),0));
        const publicExpenses = computed(() => expenses.value.filter(e => e.share > 1));
        const settlements = computed(() => {
            let b = {}; users.value.forEach(u=>b[u.id]=0);
            publicExpenses.value.forEach(e => {
                let amt = e.currency==='JPY'?e.amount*rate.value:e.amount;
                b[e.payer] += amt;
                let s = amt/e.share;
                users.value.forEach(u=>b[u.id]-=s);
            });
            let r=[], d=Object.keys(b).filter(k=>b[k]<-1), c=Object.keys(b).filter(k=>b[k]>1);
            let i=0,j=0;
            while(i<d.length && j<c.length){
                let a = Math.min(-b[d[i]], b[c[j]]);
                r.push({from:users.value.find(u=>u.id==d[i])?.name, to:users.value.find(u=>u.id==c[j])?.name, amount:a});
                b[d[i]]+=a; b[c[j]]-=a; if(Math.abs(b[d[i]])<1)i++; if(Math.abs(b[c[j]])<1)j++;
            }
            return r;
        });

        // Functions
        const saveData = async () => {
            if(!isLoggedIn.value) return;
            try {
                await setDoc(doc(db,"trips","kanto2026"), {
                    users: users.value, itineraryNormal: itineraryNormal.value, drivePlan: drivePlan.value,
                    spots: spots.value, shopping: shopping.value, expenses: expenses.value,
                    transTickets: transTickets.value, attrTickets: attrTickets.value, // Split tickets
                    rentalCars: rentalCars.value, hotels: hotels.value, rate: rate.value
                }, {merge:true});
            } catch(e){console.error(e);}
        };

        const enterSite = () => { isWelcomeClosed.value=true; currentUser.value=users.value[0]; currentView.value='menu'; };
        const handleAuthClick = () => { if(isLoggedIn.value) signOut(auth); else alert('è«‹å¯¦ä½œç™»å…¥'); };
        const addPrepItem = () => { currentUser.value.list.push({text:'æ–°ç‰©å“',checked:false}); saveData(); };
        const openAddModal = (type) => { 
            if(type==='expense') expenses.value.push({item:'æ–°æ¶ˆè²»',amount:1000,currency:'JPY',payer:currentUser.value.id,share:1});
            if(type==='itinerary') getCurrentItinerary().push({time:'12:00',title:'æ–°è¡Œç¨‹',desc:'æè¿°'});
            saveData();
        };
        const editFlight = (type) => {
            let val = prompt("è¼¸å…¥èˆªç­è™Ÿ (ä¾‹å¦‚ TR898):", type==='out'?currentUser.value.flightOut:currentUser.value.flightIn);
            if(val) { if(type==='out') currentUser.value.flightOut=val; else currentUser.value.flightIn=val; saveData(); }
        };
        const openEditModal = (type, item) => {
            let val = prompt("ä¿®æ”¹æ¨™é¡Œ:", item.title);
            if(val) { item.title=val; saveData(); }
        };
        const moveItineraryItem = (idx, dir) => {
            const arr = getCurrentItinerary();
            if(idx+dir >=0 && idx+dir < arr.length) { [arr[idx], arr[idx+dir]] = [arr[idx+dir], arr[idx]]; saveData(); }
        };

        onMounted(() => {
            if(auth) onAuthStateChanged(auth, async(u) => {
                isLoggedIn.value=!!u;
                if(u) {
                    onSnapshot(doc(db,"trips","kanto2026"), d => {
                        if(d.exists()) {
                            const dt=d.data();
                            if(dt.users) users.value=dt.users;
                            if(dt.itineraryNormal) itineraryNormal.value=dt.itineraryNormal;
                            if(dt.drivePlan) drivePlan.value=dt.drivePlan;
                            if(dt.expenses) expenses.value=dt.expenses;
                            if(dt.transTickets) transTickets.value=dt.transTickets;
                            if(dt.attrTickets) attrTickets.value=dt.attrTickets;
                            
                            if(dt.heartbeats) {
                                const map = {};
                                for(let uid in dt.heartbeats) if(dt.heartbeats[uid]) map[uid] = dt.heartbeats[uid].toDate().getTime();
                                activeUsers.value = map;
                            }
                            isLoading.value=false;
                        } else {
                            // é›²ç«¯æ˜¯ç©ºçš„ -> å¯«å…¥é€™ä»½å®Œæ•´çš„é è¨­è³‡æ–™
                            console.log("Initializing Full Cloud Data...");
                            saveData(); 
                            isLoading.value=false;
                        }
                    });
                    setInterval(()=>{
                        if(currentUser.value) updateDoc(doc(db,"trips","kanto2026"), { [`heartbeats.${currentUser.value.id}`]: serverTimestamp() });
                    }, 30000);
                } else isLoading.value=false;
            }); else isLoading.value=false;
        });

        return {
            isLoading, isWelcomeClosed, currentView, isLoggedIn, users, currentUser, isGuest,
            apps, daysUntilTrip, tripDays, cvsFoods,
            selectedDay, driveMode, moneyTab, hotelTab, foodLoc, rate,
            itineraryNormal, drivePlan, spots, shopping, hotels, transTickets, attrTickets, rentalCars,
            myExpenses, myTotal, publicExpenses, settlements,
            enterSite, handleAuthClick, getImg, getPageTitle, getMapLink, isUserOnline, getUncheckedCount, camTrans, openTranslate, getCurrentItinerary,
            saveData, addPrepItem, openAddModal, editFlight, openEditModal, moveItineraryItem
        };
    }
}).mount('#app');
</script>
</body>
</html>
