<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#FFF0F5">
<title>關東之旅 2026 (Ultimate V36)</title>

<script>
    window.tailwind = {
        config: {
            theme: {
                extend: {
                    colors: {'chii-pink':'#FFD1DC','chii-deep-pink':'#FF9EAC','chii-blue':'#A2D2FF','chii-yellow':'#FFF5BA','chii-text':'#5D4037'},
                    fontFamily: {sans:['Zen Maru Gothic','sans-serif']},
                    animation: {'wiggle':'wiggle 3s ease-in-out infinite','float':'float 3s ease-in-out infinite','fade-in':'fadeIn 0.5s ease-out forwards','spin-slow':'spin 8s linear infinite','pulse-slow':'pulse 3s infinite'},
                    keyframes: {
                        wiggle: {'0%,100%':{transform:'rotate(-3deg)'},'50%':{transform:'rotate(3deg)'}},
                        float: {'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-5px)'}},
                        fadeIn: {from:{opacity:0,transform:'translateY(10px)'},to:{opacity:1,transform:'translateY(0)'}}
                    }
                }
            }
        }
    }
</script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>

<style>
    /* V36.0 Ultimate Core */
    html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        font-family: "Zen Maru Gothic", sans-serif;
        color: #5D4037;
        overflow: hidden; 
        -webkit-tap-highlight-color: transparent;
        background-color: #FFF0F5;
        overscroll-behavior: none;
    }

    /* iOS Input Fix */
    input, textarea, select { font-size: 16px !important; font-family: inherit; } 
    * { -webkit-overflow-scrolling: touch; }

    #app-content {
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        padding-bottom: 140px;
        padding-top: env(safe-area-inset-top);
    }

    body.modal-open #app-content { overflow: hidden; }

    #fixed-bg {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1;
        background-color: #FFF0F5;
        background-image: radial-gradient(#FFD1DC 15%, transparent 16%), radial-gradient(#FFF5BA 15%, transparent 16%);
        background-size: 60px 60px;
        background-position: 0 0, 30px 30px;
    }

    [v-cloak] { display: none !important; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    
    .card {
        background: rgba(255,255,255,0.92);
        border-radius: 24px;
        box-shadow: 0 8px 30px rgba(255,105,180,0.12);
        border: 1px solid rgba(255,255,255,0.8);
        margin-bottom: 0; 
        position: relative;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        overflow: hidden; 
        transform: translateZ(0); 
    }
    .card:active { transform: scale(0.99); }
    
    .list-move, .list-enter-active, .list-leave-active { transition: all 0.5s ease; }
    .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(30px); }
    .list-leave-active { position: absolute; }

    /* FABs */
    .fab-home {
        position: fixed; bottom: calc(25px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%);
        width: 68px; height: 68px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 28px; color: white; z-index: 90; border: 4px solid white;
        box-shadow: 0 10px 25px rgba(255,105,180,0.5); background: linear-gradient(135deg,#FF9EAC,#FFD1DC); cursor: pointer;
    }
    .fab-main {
        position: fixed; bottom: calc(100px + env(safe-area-inset-bottom)); right: 20px;
        width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 22px; color: white; z-index: 80; border: 3px solid white; box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .fab-search {
        position: fixed; bottom: calc(30px + env(safe-area-inset-bottom)); left: 20px;
        width: 54px; height: 54px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 24px; color: #5D4037; z-index: 90; border: 2px solid white; background: rgba(255,255,255,0.9);
        backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: all 0.3s;
    }
    .fab-search:active { transform: scale(0.9); background: white; }

    .welcome-screen {
        position: fixed; inset: 0; z-index: 9999; background: #FFF0F5;
        transition: transform 0.8s cubic-bezier(0.7,0,0.3,1); cursor: pointer; height: 100%;
    }
    .welcome-screen.hidden-screen { transform: translateY(-100%); pointer-events: none; }
    
    .sakura {
        position: fixed; top: -20px; background: #FFB7B2; border-radius: 100% 0 100% 0; opacity: 0.6;
        animation: fall linear infinite; z-index: 0; pointer-events: none; width: 14px; height: 14px;
    }
    @keyframes fall { to { transform: translate(10vw, 105vh) rotate(360deg); } }

    .timeline-connect {
        width: 2px; height: 50px; background: repeating-linear-gradient(to bottom, #FFD1DC 0, #FFD1DC 5px, transparent 5px, transparent 10px);
        margin: 0 auto; position: relative;
    }
    .timeline-badge {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; border: 1px solid #FFD1DC; border-radius: 12px; padding: 4px 10px; font-size: 11px; color: #FF9EAC; font-weight: bold;
        white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 5;
    }
    .drive-line { background: repeating-linear-gradient(to bottom, #4ade80 0, #4ade80 5px, transparent 5px, transparent 10px) !important; height: 60px !important; }
    .drive-badge { border-color: #4ade80 !important; color: #16a34a !important; background: #f0fdf4 !important; font-size: 12px !important; padding: 6px 14px !important; }

    .avatar-online { border-color: #4ade80 !important; box-shadow: 0 0 10px #4ade80 !important; filter: brightness(1); }
    .avatar-offline { border-color: #e5e7eb !important; filter: grayscale(100%) brightness(0.7); opacity: 0.6; }
    
    .cloud-status {
        position: fixed; bottom: calc(30px + env(safe-area-inset-bottom)); left: 80px;
        font-size: 10px; font-weight: bold; color: #aaa;
        display: flex; align-items: center; gap: 4px; z-index: 50;
        background: rgba(255,255,255,0.8); padding: 4px 8px; border-radius: 12px;
        backdrop-filter: blur(4px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;
    }
    .status-dot { width: 8px; height: 8px; rounded: 50%; border-radius: 50%; }
</style>
</head>
<body>

<div id="fixed-bg"></div>
<div id="sakura-container"></div>

<div id="app" v-cloak class="h-full flex flex-col">
    
    <div :class="['welcome-screen flex flex-col items-center justify-between', isWelcomeClosed ? 'hidden-screen' : '']">
        <div class="absolute inset-0 z-0"><img :src="getImg('welcome.jpg')" class="w-full h-full object-cover opacity-90" @error="handleImgError"></div>
        <div class="absolute top-6 right-6 z-50 pt-[env(safe-area-inset-top)]">
            <button @click.stop="handleAuthClick" :class="['flex items-center gap-2 px-4 py-2 rounded-full backdrop-blur-md border border-white/50 shadow-lg font-bold text-sm transition', isLoggedIn ? 'bg-green-500/80 text-white' : 'bg-white/40 text-gray-800']">
                <i :class="isLoggedIn ? 'fa-solid fa-cloud' : 'fa-solid fa-cloud-arrow-up'"></i> {{ isLoggedIn ? '已連線' : '雲端同步' }}
            </button>
        </div>
        <div class="relative z-10 mt-32 text-center px-6">
            <div class="inline-block bg-white/40 backdrop-blur-md px-6 py-2 rounded-full text-white text-xs font-black tracking-[0.2em] border border-white/50 mb-6 animate-float shadow-lg">DIAMOND ELITE</div>
            <h1 class="text-7xl font-black text-white drop-shadow-lg tracking-widest mb-2 font-sans" style="text-shadow: 0 4px 10px rgba(255,105,180,0.3);">關東之旅</h1>
            <p class="text-3xl text-white/90 font-bold tracking-widest drop-shadow-md">2026.03.27</p>
        </div>
        <div class="relative z-10 mb-20 w-full px-10 pb-[env(safe-area-inset-bottom)] space-y-4">
            <button @click="enterSite" class="w-full bg-white/90 text-pink-500 font-black py-4 rounded-full shadow-2xl backdrop-blur-xl text-xl flex items-center justify-center gap-3 border border-white animate-pulse-slow">
                <span class="animate-spin-slow">🌸</span> 旅伴登入
            </button>
            <button @click="enterAsGuest" class="w-full bg-gray-800/60 text-white font-bold py-3 rounded-full backdrop-blur-md text-sm border border-white/30 hover:bg-gray-800/80 transition">
                <i class="fa-solid fa-user-secret"></i> 訪客參觀 (唯讀)
            </button>
        </div>
    </div>

    <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-[60px] bg-[#FFF0F5]/90 backdrop-blur-xl z-30 flex items-center justify-between px-4 border-b border-white/50 shadow-sm pt-[env(safe-area-inset-top)] box-content transition-all">
        <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow-md border border-white active:scale-90 transition"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="font-black text-gray-700 text-lg flex items-center gap-2"><i class="fa-solid fa-sakura text-pink-300"></i> {{getPageTitle(currentView)}}</h1>
        <div class="flex items-center -space-x-2">
            <div v-for="u in users" :key="u.id" :class="['w-8 h-8 rounded-full border-2 relative overflow-hidden bg-white shadow-sm transition-all duration-300', (currentUser && currentUser.id === u.id) ? 'avatar-online z-10 scale-110' : 'avatar-offline']">
                <img v-if="u.avatar" :src="u.avatar" class="w-full h-full object-cover">
                <span v-else class="flex items-center justify-center h-full text-sm">{{u.icon}}</span>
            </div>
        </div>
    </div>
    <div v-if="currentView !== 'menu'" class="h-[60px] pt-[env(safe-area-inset-top)] box-content shrink-0"></div>

    <div id="app-content" class="flex-1">

        <div v-if="currentView==='menu'" class="p-6 pt-12 animate-fade-in pb-32">
            <div class="absolute top-6 right-6 flex items-center -space-x-2 pt-[env(safe-area-inset-top)]">
                <div v-for="u in users" :key="u.id" :class="['w-8 h-8 rounded-full border-2 relative overflow-hidden bg-white shadow-sm', (currentUser && currentUser.id === u.id) ? 'avatar-online' : 'avatar-offline']">
                    <img v-if="u.avatar" :src="u.avatar" class="w-full h-full object-cover">
                    <span v-else class="flex items-center justify-center h-full text-sm">{{u.icon}}</span>
                </div>
            </div>

            <h2 class="text-3xl font-black text-gray-700 mb-8 text-center pt-[env(safe-area-inset-top)]">旅程中心</h2>
            <div class="mb-8 bg-white/70 backdrop-blur-xl border border-white rounded-[32px] p-6 shadow-xl relative overflow-hidden">
                 <div class="flex items-start gap-4 relative z-10">
                     <div class="bg-gradient-to-br from-yellow-200 to-yellow-400 w-12 h-12 rounded-2xl flex items-center justify-center text-white text-xl shrink-0 shadow-lg"><i class="fa-solid fa-bell"></i></div>
                     <div class="flex-1">
                         <div class="font-black text-gray-800 text-lg mb-1">倒數 {{daysUntilTrip}} 天</div>
                         <div class="text-xs text-gray-500 font-bold leading-relaxed space-y-1">
                            <div v-for="alert in smartReminders" class="text-pink-500 flex items-start gap-1 font-black"><i class="fa-solid fa-circle-exclamation mt-0.5"></i> {{alert}}</div>
                            <div class="text-gray-400 mt-2 pt-2 border-t border-gray-200">
                                <div class="flex items-center gap-1"><i class="fa-solid fa-check text-green-400"></i> 護照期限檢查</div>
                                <div class="flex items-center gap-1"><i class="fa-solid fa-check text-green-400"></i> 行動電源充電</div>
                            </div>
                         </div>
                     </div>
                 </div>
            </div>
            <div class="grid grid-cols-3 gap-x-4 gap-y-8 px-2">
                <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition duration-300 group" @click="currentView=app.view">
                    <div class="w-[76px] h-[76px] rounded-[30px] flex items-center justify-center text-3xl text-white shadow-lg border-[4px] border-white relative overflow-hidden" :class="app.bgClass"><i :class="app.icon"></i></div>
                    <span class="text-sm font-bold mt-3 text-gray-600 group-hover:text-pink-500 transition">{{app.name}}</span>
                </div>
            </div>
            
            <button @click="isWelcomeClosed=false" class="mt-12 mx-auto text-gray-400 text-sm font-bold border-b border-gray-300 pb-1 block">回到歡迎頁面</button>
            <div v-if="isGuest" class="text-center mt-4 text-xs font-bold text-gray-400 bg-gray-200 rounded-full py-1 w-32 mx-auto">訪客模式</div>
        </div>

        <div v-if="currentView==='itinerary'" class="px-5 py-4 animate-fade-in">
            <div class="flex overflow-x-auto gap-3 mb-6 hide-scrollbar sticky top-0 bg-[#FFF0F5]/95 z-20 py-3 -mx-5 px-5 backdrop-blur-md">
                 <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-6 py-3 rounded-2xl text-sm font-black border-2 transition shrink-0 shadow-sm flex flex-col items-center min-w-[70px]',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400 shadow-lg scale-105':'bg-white text-gray-300 border-white']"><span>{{d.week}}</span><span class="text-[10px] mt-1 opacity-80">{{d.title}}</span></button>
            </div>
            <div v-if="[2,3].includes(selectedDayIndex)" class="flex justify-center mb-6">
                <div class="bg-white p-1 rounded-full border border-gray-200 shadow-sm flex">
                    <button @click="itineraryMode='normal'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='normal'?'bg-pink-400 text-white':'text-gray-400']">一般</button>
                    <button @click="itineraryMode='drive'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='drive'?'bg-green-500 text-white':'text-gray-400']"><i class="fa-solid fa-car"></i> 自駕</button>
                </div>
            </div>
            <div class="pb-20 relative">
                <transition-group name="list" tag="div">
                    <div v-for="(item,idx) in getCurrentItinerary()" :key="item.id || idx">
                        <div class="card p-5 border-0 shadow-sm relative group z-10 mb-4" @click="!isGuest && openEditItineraryModal(item, idx)">
                            <div class="absolute left-0 top-0 bottom-0 w-1.5" :class="itineraryMode==='drive' && [2,3].includes(selectedDayIndex)?'bg-green-400':'bg-gradient-to-b from-pink-300 to-pink-100'"></div>
                            <div v-if="!isGuest" class="absolute right-2 top-2 flex flex-col gap-1 z-20 opacity-80">
                                <button @click.stop="moveItem(idx, -1)" class="w-8 h-8 bg-white/80 rounded-full shadow text-gray-400 hover:text-pink-500 hover:bg-white flex items-center justify-center border border-gray-100" v-if="idx > 0"><i class="fa-solid fa-chevron-up"></i></button>
                                <button @click.stop="moveItem(idx, 1)" class="w-8 h-8 bg-white/80 rounded-full shadow text-gray-400 hover:text-pink-500 hover:bg-white flex items-center justify-center border border-gray-100" v-if="idx < getCurrentItinerary().length - 1"><i class="fa-solid fa-chevron-down"></i></button>
                            </div>
                            <div class="flex gap-4 pr-8">
                                <div class="flex flex-col items-center pt-1 min-w-[50px]">
                                    <span class="text-xs font-black text-gray-400 mb-2">{{item.hours}}</span>
                                    <div class="w-10 h-10 rounded-full text-lg flex items-center justify-center border" :class="itineraryMode==='drive' && [2,3].includes(selectedDayIndex)?'bg-green-50 text-green-500 border-green-100':'bg-pink-50 text-pink-400 border-pink-100'"><i :class="getIconByCategory(item.category)"></i></div>
                                </div>
                                <div class="flex-1 py-1">
                                    <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                                    <p class="text-sm text-gray-500 line-clamp-2 font-medium mb-2">{{item.note}}</p>
                                    <div class="flex gap-2 flex-wrap">
                                        <a :href="getMapLink(item.mapKeyword, item.name)" target="_blank" @click.stop class="inline-flex items-center gap-1 text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded-full font-bold border border-blue-100 hover:bg-blue-100 transition"><i class="fa-solid fa-location-arrow"></i> 導航</a>
                                        <a v-if="itineraryMode==='drive' && [2,3].includes(selectedDayIndex) && item.parkingLink" :href="getMapLink(item.parkingLink)" target="_blank" @click.stop class="inline-flex items-center gap-1 text-[10px] bg-green-50 text-green-600 px-2 py-1 rounded-full font-bold border border-green-200 hover:bg-green-100"><i class="fa-solid fa-square-parking"></i> 停車場</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-if="idx < getCurrentItinerary().length - 1" class="timeline-connect !h-[40px] mb-4" :class="{'drive-line': itineraryMode==='drive' && [2,3].includes(selectedDayIndex)}">
                            <div v-if="item.travelTime" class="timeline-badge" :class="{'drive-badge': itineraryMode==='drive' && [2,3].includes(selectedDayIndex)}">
                                <i v-if="itineraryMode==='drive' && [2,3].includes(selectedDayIndex)" class="fa-solid fa-car mr-1"></i>
                                <i v-else class="fa-solid fa-person-walking mr-1"></i>
                                {{item.travelTime}}
                            </div>
                        </div>
                    </div>
                </transition-group>
                <div v-if="getCurrentItinerary().length === 0" class="text-center text-gray-400 py-10 font-bold">本日無特定行程。</div>
                <button v-if="!isGuest" @click="openAddItineraryModal" class="w-full py-4 mt-6 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white/50 transition"><i class="fa-solid fa-plus"></i> 新增行程</button>
            </div>
        </div>

        <div v-if="currentView==='hotel'" class="px-5 py-4 animate-fade-in">
            <div class="flex gap-2 mb-6 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm shadow-sm">
                <button @click="hotelTab='stay'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='stay'?'bg-indigo-500 text-white':'text-gray-400']">住宿</button>
                <button @click="hotelTab='ticket'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='ticket'?'bg-pink-500 text-white':'text-gray-400']">交通票券</button>
                <button @click="hotelTab='flight'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='flight'?'bg-blue-500 text-white':'text-gray-400']">機票</button>
                <button @click="hotelTab='car'" :class="['px-4 py-2 rounded-full font-bold text-xs',hotelTab==='car'?'bg-green-500 text-white':'text-gray-400']">租車</button>
            </div>
            
            <div v-if="hotelTab==='stay'" class="space-y-6">
                <div class="card !p-0 border-0 shadow-xl overflow-hidden"><div class="h-40 bg-gray-200 relative"><img :src="getImg('bnb.jpg')" class="w-full h-full object-cover" @error="handleImgError"><div class="absolute bottom-4 left-5 text-white shadow-black drop-shadow-md"><h3 class="font-black text-2xl">錦糸町民宿</h3></div></div><div class="p-4"><a href="https://maps.app.goo.gl/cyLNVJttoAM61dmFA" target="_blank" class="w-full flex items-center justify-center gap-2 bg-indigo-50 text-indigo-600 font-bold py-3 rounded-xl border border-indigo-100"><i class="fa-solid fa-location-dot"></i> 導航</a></div></div>
                <div class="card !p-0 border-0 shadow-xl overflow-hidden"><div class="h-40 bg-gray-200 relative"><img :src="getImg('megu.jpg')" class="w-full h-full object-cover" @error="handleImgError"><div class="absolute bottom-4 left-5 text-white shadow-black drop-shadow-md"><h3 class="font-black text-2xl">Megu Fuji</h3></div></div><div class="p-4"><a :href="getMapLink('Megu Fuji 2026')" target="_blank" class="w-full flex items-center justify-center gap-2 bg-indigo-50 text-indigo-600 font-bold py-3 rounded-xl border border-indigo-100"><i class="fa-solid fa-location-dot"></i> 導航</a></div></div>
                <div class="card !p-0 border-0 shadow-xl overflow-hidden"><div class="h-40 bg-gray-200 relative"><img :src="getImg('domo.jpg')" class="w-full h-full object-cover" @error="handleImgError"><div class="absolute bottom-4 left-5 text-white shadow-black drop-shadow-md"><h3 class="font-black text-2xl">DOMO 民宿</h3></div></div><div class="p-4"><a href="https://www.google.com/maps/search/?api=1&query=DOMO+Hotel+Higashi+Shinjuku" target="_blank" class="w-full flex items-center justify-center gap-2 bg-indigo-50 text-indigo-600 font-bold py-3 rounded-xl border border-indigo-100"><i class="fa-solid fa-location-dot"></i> 導航 (東新宿)</a></div></div>
            </div>

            <div v-if="hotelTab==='ticket'" class="space-y-4 pb-20">
                <div v-for="(t, idx) in transportTickets" :key="idx" class="card overflow-hidden">
                    <div class="p-4 flex justify-between items-center border-l-4 border-pink-400">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-pink-50 flex items-center justify-center text-pink-500 text-xl"><i :class="t.icon||'fa-solid fa-ticket'"></i></div>
                            <div>
                                <div class="font-bold text-gray-800">{{t.name}}</div>
                                <div class="text-[10px] text-gray-400 font-bold mt-1">詳情與連結如下</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <a :href="t.url" target="_blank" class="bg-pink-500 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-md">購買</a>
                             <button v-if="!isGuest && t.custom" @click="transportTickets.splice(idx,1);saveData()" class="text-red-300 px-2"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 text-xs text-gray-600 font-medium border-t border-gray-100 leading-relaxed whitespace-pre-wrap">
                        <span class="font-bold text-pink-400 mb-1 block"><i class="fa-solid fa-circle-exclamation"></i> 注意事項：</span>
                        {{t.note}}
                    </div>
                </div>
                <button v-if="!isGuest" @click="openAddTransTicketModal" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold"><i class="fa-solid fa-plus"></i> 新增交通票券 (自動帶入)</button>
            </div>

            <div v-if="hotelTab==='flight'" class="animate-fade-in pb-20">
                 <div v-if="!currentUser" class="text-center py-20 text-gray-400 font-bold bg-white/50 rounded-3xl border border-dashed border-gray-300"><i class="fa-solid fa-eye-slash text-4xl mb-4"></i><br>請先選擇身分</div>
                 <div v-else class="space-y-4">
                     <div class="card !p-0 border-0 shadow-lg relative overflow-hidden group">
                         <div class="bg-blue-500 p-3 flex justify-between items-center text-white">
                             <span class="font-black text-sm tracking-widest"><i class="fa-solid fa-plane-departure mr-2"></i>去程機票 (OUT)</span>
                             <button v-if="!isGuest" @click="editFlight('out')" class="text-xs bg-white/20 px-2 py-1 rounded hover:bg-white/40"><i class="fa-solid fa-pen"></i></button>
                         </div>
                         <div class="p-5 relative bg-white">
                             <div class="flex justify-between items-end bg-gray-50 p-3 rounded-xl mb-3">
                                 <div><div class="text-[10px] text-gray-400 font-bold">FLIGHT</div>
                                 <a :href="flightStatusLink(currentUser.flightOut)" target="_blank" class="font-black text-xl text-blue-600 underline decoration-dashed underline-offset-4">{{currentUser.flightOut || 'TR898'}} <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a></div>
                                 <div class="text-right"><div class="text-[10px] text-gray-400 font-bold">SEAT</div><div class="font-black text-2xl text-blue-500">{{currentUser.flightOutSeat||'--'}}</div></div>
                             </div>
                             <div class="bg-yellow-50 p-3 text-xs text-yellow-800 font-bold border border-yellow-100 rounded-xl leading-relaxed whitespace-pre-wrap">
                                 <i class="fa-solid fa-circle-info mr-1"></i> {{getAirlineInfo(currentUser.flightOut, false) || '請確認航廈'}}
                             </div>
                         </div>
                     </div>
                     <div class="card !p-0 border-0 shadow-lg relative overflow-hidden group">
                         <div class="bg-indigo-500 p-3 flex justify-between items-center text-white">
                             <span class="font-black text-sm tracking-widest"><i class="fa-solid fa-plane-arrival mr-2"></i>回程機票 (IN)</span>
                             <button v-if="!isGuest" @click="editFlight('in')" class="text-xs bg-white/20 px-2 py-1 rounded hover:bg-white/40"><i class="fa-solid fa-pen"></i></button>
                         </div>
                         <div class="p-5 relative bg-white">
                             <div class="flex justify-between items-end bg-gray-50 p-3 rounded-xl mb-3">
                                 <div><div class="text-[10px] text-gray-400 font-bold">FLIGHT</div>
                                 <a :href="flightStatusLink(currentUser.flightIn)" target="_blank" class="font-black text-xl text-indigo-600 underline decoration-dashed underline-offset-4">{{currentUser.flightIn || 'BR197'}} <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a></div>
                                 <div class="text-right"><div class="text-[10px] text-gray-400 font-bold">SEAT</div><div class="font-black text-2xl text-indigo-500">{{currentUser.flightInSeat||'--'}}</div></div>
                             </div>
                              <div class="bg-yellow-50 p-3 text-xs text-yellow-800 font-bold border border-yellow-100 rounded-xl leading-relaxed whitespace-pre-wrap">
                                 <i class="fa-solid fa-circle-info mr-1"></i> {{getAirlineInfo(currentUser.flightIn, false) || '請確認航廈'}}
                             </div>
                         </div>
                     </div>
                 </div>
            </div>

            <div v-if="hotelTab==='car'" class="animate-fade-in space-y-4 pb-20">
                 <div v-for="(car, idx) in rentalCars" :key="idx" class="card overflow-hidden">
                     <div class="p-5 border-l-4" :class="idx%2===0?'border-green-500':'border-blue-400'">
                         <div class="flex justify-between items-start">
                             <h3 class="font-black text-lg mb-1">{{car.company}}</h3>
                             <button v-if="!isGuest" @click="deleteCar(idx)" class="text-red-300"><i class="fa-solid fa-trash"></i></button>
                         </div>
                         <p class="text-xs text-gray-500 font-bold mb-3"><i class="fa-solid fa-location-dot"></i> 取車：{{car.pickup}}</p>
                         <div class="bg-gray-50 p-2 rounded text-[10px] text-gray-500 mb-3" v-if="car.note">{{car.note}}</div>
                         <a :href="car.url" target="_blank" class="block text-center text-white font-bold py-2 rounded-xl" :class="idx%2===0?'bg-green-500':'bg-blue-400'">前往預約/查看</a>
                     </div>
                 </div>
                 <div v-if="rentalCars.length===0" class="text-center text-gray-400 py-10 font-bold">尚無租車紀錄。</div>
                 <button v-if="!isGuest" @click="openAddCarModal" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold"><i class="fa-solid fa-plus"></i> 新增租車預約</button>
            </div>
        </div>

        <div v-if="['shopping','food','photo','japanese','weather'].includes(currentView)" class="px-5 py-4 animate-fade-in">
             <div v-if="currentView==='shopping'">
                <div class="grid grid-cols-2 gap-3 mb-6"><a href="https://www.cosme.net/ranking/" target="_blank" class="bg-green-50 text-green-600 p-3 rounded-xl text-center font-bold text-xs border border-green-200 block">👑 COSME 大賞</a><a href="https://www.shinyusha.co.jp/media/ldk-the-beauty/" target="_blank" class="bg-pink-50 text-pink-600 p-3 rounded-xl text-center font-bold text-xs border border-pink-200 block">💄 LDK 毒舌雜誌</a></div>
                <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar"><button v-for="cat in ['cosme','ldk','souvenir']" @click="shopCat=cat" :class="['px-5 py-2 rounded-full font-bold text-xs whitespace-nowrap transition', shopCat===cat?'bg-pink-400 text-white':'bg-white text-gray-400']">{{{'cosme':'藥妝清單','ldk':'LDK推薦','souvenir':'伴手禮'}[cat]}}</button></div>
                <div class="grid grid-cols-2 gap-4 pb-20"><div v-for="(item,idx) in shopping[shopCat]" class="card !p-0 border-0 shadow-lg group relative" :key="idx"><div class="h-32 bg-gray-100 relative overflow-hidden"><img :src="item.img || 'https://placehold.co/300x300/pink/white?text=SHOP'" class="w-full h-full object-cover" @error="handleImgError"></div><div class="p-3"><div class="font-bold text-gray-800 text-sm mb-1 truncate">{{item.name}}</div><a :href="item.link || getSearchLink(item.name)" target="_blank" class="block text-center bg-gray-50 text-gray-500 text-[10px] py-1.5 rounded font-bold hover:bg-pink-500 hover:text-white transition">前往官網 / 搜尋</a></div><div v-if="!isGuest" class="absolute top-1 right-1 flex gap-1"><button @click="openEditModal('shopping', item, idx)" class="bg-white/90 p-1.5 rounded-full text-blue-400 shadow w-7 h-7 flex items-center justify-center"><i class="fa-solid fa-pen text-[10px]"></i></button><button @click="shopping[shopCat].splice(idx,1);saveData()" class="bg-white/90 p-1.5 rounded-full text-red-400 shadow w-7 h-7 flex items-center justify-center"><i class="fa-solid fa-trash text-[10px]"></i></button></div></div></div>
                <button v-if="!isGuest" @click="openAddShopModal" class="fab-main bg-purple-400 text-white"><i class="fa-solid fa-plus"></i></button>
             </div>
             
             <div v-if="['food','photo'].includes(currentView)">
                <div class="flex gap-2 mb-4 justify-center"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="currentLoc=loc" :class="['px-5 py-2 rounded-full font-bold text-xs transition', currentLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400']">{{{'Tokyo':'東京','Kamakura':'鎌倉','Fuji':'富士山'}[loc]}}</button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20">
                    <div v-for="(item,idx) in spots[currentView][currentLoc]" :key="idx" class="card !p-0 border-0 shadow-lg group relative">
                        <div class="h-48 bg-gray-100 relative overflow-hidden"><img :src="item.img || 'https://placehold.co/600x400/orange/white?text=SPOT'" class="w-full h-full object-cover" @error="handleImgError"></div>
                        <div class="p-4">
                            <h3 class="font-black text-gray-800 text-lg mb-1 flex items-center justify-between">
                                {{item.name}}
                                <span v-if="currentView==='food' && item.reserve" class="bg-red-500 text-white text-[10px] px-2 py-1 rounded-full font-bold shadow-sm animate-pulse-slow">需訂位</span>
                                <span v-if="currentView==='food' && !item.reserve" class="bg-green-100 text-green-600 text-[10px] px-2 py-1 rounded-full font-bold border border-green-200">免訂位</span>
                            </h3>
                            <p class="text-sm text-gray-500 mb-3 font-bold">{{item.desc}}</p>
                            
                            <div v-if="currentView==='food'" class="mb-3 space-y-2">
                                <div v-if="item.reserve" class="bg-red-50 border border-red-100 p-2 rounded-lg text-xs flex justify-between items-center">
                                    <span class="text-red-500 font-bold"><i class="fa-solid fa-clock"></i> 務必提前預約</span>
                                    <a v-if="item.reserveLink" :href="item.reserveLink" target="_blank" class="bg-red-500 text-white px-3 py-1.5 rounded text-[10px] font-bold shadow-sm hover:bg-red-600 active:scale-95 transition">立即預訂 <i class="fa-solid fa-arrow-right"></i></a>
                                </div>
                                <div v-if="item.note" class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-xs text-gray-700 leading-relaxed relative mt-2 shadow-sm">
                                    <i class="fa-solid fa-utensils text-yellow-400 text-xl absolute -top-2 -left-1"></i>
                                    <div class="pl-4">
                                        <span class="font-black text-yellow-600 block mb-1">老饕筆記：</span>
                                        {{item.note}}
                                    </div>
                                </div>
                            </div>

                            <a :href="getMapLink(item.link, item.name)" target="_blank" class="block w-full text-center bg-gray-50 text-gray-600 font-bold py-3 rounded-lg text-sm border hover:bg-orange-400 hover:text-white transition"><i class="fa-solid fa-location-arrow"></i> Google Maps 導航</a>
                        </div>
                        <div v-if="!isGuest" class="absolute top-2 right-2 flex gap-2"><button @click="openEditModal(currentView==='food'?'food':'spot', item, idx)" class="w-8 h-8 bg-white rounded-full shadow text-blue-500 flex items-center justify-center"><i class="fa-solid fa-pen"></i></button><button @click="spots[currentView][currentLoc].splice(idx,1);saveData()" class="w-8 h-8 bg-white rounded-full shadow text-red-500 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button></div>
                    </div>
                </div>
                <button v-if="!isGuest" @click="currentView==='food'?openAddFoodModal():openAddSpotModal()" class="fab-main bg-orange-400 text-white"><i class="fa-solid fa-plus"></i></button>
             </div>
             <div v-if="currentView==='japanese'">
                <div class="space-y-3 pb-20"><div v-for="(p,idx) in japanesePhrases" :key="idx" class="card p-5 flex justify-between items-center cursor-pointer hover:shadow-md transition border-l-4 border-emerald-400" @click="expandCard(p)"><div><div class="font-bold text-lg text-gray-800">{{p.jp}}</div><div class="text-xs text-gray-500 font-bold mt-1">{{p.zh}}</div></div><i class="fa-solid fa-expand text-gray-300"></i></div></div>
                <button v-if="!isGuest" @click="openAddPhraseModal" class="fab-main bg-emerald-500 text-white"><i class="fa-solid fa-plus"></i></button>
             </div>
             <div v-if="currentView==='weather'">
                 <div class="bg-pink-50 p-4 rounded-2xl border border-pink-200 mb-6 shadow-sm text-center relative overflow-hidden"><i class="fa-solid fa-fan text-pink-200 text-6xl absolute -right-4 -bottom-4 animate-spin-slow"></i><h3 class="font-black text-pink-500 mb-3 text-sm">🌸 2026 權威櫻花預測</h3><div class="grid grid-cols-2 gap-3 mb-3"><a href="https://weathernews.jp/s/sakura/" target="_blank" class="bg-white text-pink-500 py-2 rounded-lg text-xs font-bold shadow-sm hover:shadow-md transition">Weathernews</a><a href="https://tenki.jp/sakura/" target="_blank" class="bg-white text-pink-500 py-2 rounded-lg text-xs font-bold shadow-sm hover:shadow-md transition">日本氣象協會</a></div><div class="grid grid-cols-3 gap-2"><div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">東京</div><div class="font-bold text-pink-600">3/22</div></div><div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">鎌倉</div><div class="font-bold text-pink-600">3/25</div></div><div class="bg-white rounded-lg p-2"><div class="text-[10px] text-gray-400">富士山</div><div class="font-bold text-pink-600">4/10</div></div></div></div>
                 <div class="space-y-4"><div v-for="w in weatherData" class="card p-6 text-white relative" :class="w.bg"><div class="relative z-10"><div class="font-bold opacity-80 uppercase text-xs">{{w.name}}</div><div class="text-5xl font-black my-2">{{w.temp}}°C</div><div class="text-sm bg-white/20 backdrop-blur inline-block px-3 py-1 rounded-full">👕 {{getClothingAdvice(w.temp)}}</div></div></div></div>
             </div>
        </div>
        
        <div v-if="currentView==='prep'" class="px-5 py-4 animate-fade-in">
            <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="block w-full bg-gradient-to-r from-blue-600 to-blue-400 text-white rounded-2xl p-4 mb-6 shadow-lg flex items-center justify-between active:scale-95 transition"><div class="flex items-center gap-3"><i class="fa-solid fa-qrcode text-3xl"></i><div><div class="font-bold text-lg">Visit Japan Web</div></div></div><i class="fa-solid fa-chevron-right"></i></a>
            <div class="card p-5 bg-gradient-to-r from-purple-50 to-pink-50 border-purple-100 mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-purple-800 text-sm flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> 景點門票精靈</h4>
                    <button v-if="!isGuest" @click="openAddTicketModal" class="text-xs bg-white text-purple-500 px-2 py-1 rounded shadow-sm font-bold border"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div class="space-y-2">
                    <div v-for="(t, idx) in suggestedTickets" :key="t.name" class="bg-white p-3 rounded-xl shadow-sm border border-purple-100 flex justify-between items-center">
                        <span class="text-sm font-bold text-gray-700">{{t.name}}</span>
                        <div class="flex gap-2">
                            <a :href="t.url" target="_blank" class="text-xs bg-purple-500 text-white px-3 py-1.5 rounded-full font-bold">購票</a>
                            <button v-if="!isGuest" @click="suggestedTickets.splice(idx,1);saveData()" class="text-red-300 text-xs px-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                     <div v-if="suggestedTickets.length===0" class="text-xs text-gray-400 text-center py-2">無特定景點門票需求。</div>
                </div>
            </div>
            <div v-if="!currentUser || isGuest" class="text-center text-gray-400 font-bold bg-white/50 py-10 rounded-2xl border border-dashed"><i class="fa-solid fa-suitcase text-3xl mb-2"></i><br>{{isGuest?'訪客無法存取私人清單':'請登入以管理清單'}}</div>
            <div v-else class="card p-0">
                <div class="bg-gray-50 p-3 border-b font-bold text-gray-700 flex justify-between items-center">
                    <span class="flex items-center gap-2"><i class="fa-solid fa-clipboard-check text-blue-400"></i> {{currentUser.name}} 的行李</span>
                    <button @click="addPrepItem(currentUser)" class="text-xs bg-blue-500 text-white px-3 py-1 rounded-full font-bold shadow-blue-200 shadow">+ 新增</button>
                </div>
                <div v-for="(item, idx) in currentUser.list" :key="idx" class="flex items-center p-3 border-b border-gray-100 group">
                    <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-500 mr-3" @change="saveData">
                    <input v-model="item.text" @change="saveData" :class="['flex-1 text-sm font-bold bg-transparent outline-none', item.checked?'text-gray-300 line-through':'text-gray-700']">
                    <button @click="currentUser.list.splice(idx,1);saveData()" class="text-gray-200 hover:text-red-400 transition px-2"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>
        </div>
        
        <div v-if="currentView==='money'" class="px-5 py-4 animate-fade-in">
             <div v-if="isGuest" class="text-center py-20 text-gray-400 font-bold bg-white/50 rounded-3xl border border-dashed border-gray-300"><i class="fa-solid fa-user-secret text-4xl mb-4 text-gray-300"></i><br>訪客模式<br>無法存取財務資訊</div>
             <div v-else-if="!currentUser" class="text-center py-20 text-gray-400 font-bold bg-white/50 rounded-3xl border border-dashed border-gray-300"><i class="fa-solid fa-lock text-4xl mb-4 text-pink-300"></i><br>請先選擇身分</div>
             <div v-else>
                 <div class="flex gap-2 mb-4 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm shadow-sm">
                     <button @click="moneyTab='record'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='record'?'bg-yellow-400 text-white shadow-md':'text-gray-400']"><i class="fa-solid fa-user-lock"></i> 我的私帳</button>
                     <button @click="moneyTab='split'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='split'?'bg-blue-400 text-white shadow-md':'text-gray-400']"><i class="fa-solid fa-users"></i> 公款分帳</button>
                 </div>
                 <div class="flex justify-between items-center mb-4 px-2">
                     <div class="text-xs font-bold text-gray-500 bg-white px-3 py-1.5 rounded-full shadow-sm border border-pink-100">匯率: 1 JPY ≈ <input v-model="exchangeRate" class="w-14 text-center text-pink-500 font-black outline-none bg-transparent" type="number" step="0.001"> TWD</div>
                 </div>
                 <div v-if="moneyTab==='record'">
                     <div class="card p-6 bg-gradient-to-br from-yellow-300 to-orange-400 text-white border-none shadow-orange-200 mb-4">
                        <div class="flex justify-between items-end"><div><div class="text-xs font-bold opacity-80 mb-1">🔒 {{currentUser.name}} 的私人支出</div><div class="text-4xl font-black">TWD ${{Math.round(myPrivateTotalTWD).toLocaleString()}}</div></div></div>
                     </div>
                     <div class="space-y-3 pb-20">
                        <div v-for="exp in myPrivateExpenses" :key="exp.id" class="card p-4 flex justify-between items-center !mb-0 !rounded-2xl border-l-4 border-yellow-300">
                            <div><div class="font-bold text-gray-800">{{exp.name}}</div><div class="text-[10px] text-gray-400 flex items-center gap-1">{{getPaymentIcon(exp.method)}} {{exp.date}}</div></div>
                            <div class="text-right"><span class="font-black text-gray-700 block">{{exp.currency}} {{exp.amount}}</span></div>
                            <button @click="deleteExpense(exp.id)" class="ml-3 text-red-300"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <div v-if="myPrivateExpenses.length===0" class="text-center text-gray-400 text-sm mt-10">尚無紀錄</div>
                     </div>
                     <button @click="openExpenseModal('private')" class="fab-main bg-yellow-400 text-white"><i class="fa-solid fa-pen"></i></button>
                 </div>
                 <div v-if="moneyTab==='split'">
                     <div class="card p-5 border-l-4 border-blue-400 bg-blue-50/50">
                         <h3 class="font-bold text-blue-500 mb-4 flex items-center gap-2"><i class="fa-solid fa-calculator"></i> 智慧結算 (TWD)</h3>
                         <div v-if="settlements.length===0" class="text-center text-gray-400 text-sm py-4">目前收支平衡。</div>
                         <div v-else class="space-y-3">
                             <div v-for="s in settlements" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-blue-100"><span class="font-bold text-gray-700 text-sm">{{getUserName(s.from)}} <i class="fa-solid fa-angles-right text-blue-300 mx-1"></i> {{getUserName(s.to)}}</span><span class="font-black text-blue-600">${{s.amount.toLocaleString()}}</span></div>
                         </div>
                     </div>
                     <h3 class="font-bold text-gray-600 mt-6 mb-3 px-2">所有人公款明細</h3>
                     <div class="space-y-3 pb-20">
                        <div v-for="exp in groupExpenses" :key="exp.id" class="card p-4 !mb-0 !rounded-2xl border-l-4 border-blue-300 relative">
                             <div class="flex justify-between items-start mb-1"><div class="font-bold text-gray-800">{{exp.name}} <span class="text-[10px] text-gray-400 font-normal ml-1">{{getPaymentIcon(exp.method)}}</span></div><div class="font-black text-blue-500">{{exp.currency}} {{exp.amount}}</div></div>
                             <div class="flex justify-between items-end"><div class="text-xs text-gray-500 font-bold bg-gray-100 px-2 py-1 rounded inline-block"><span class="text-blue-500">{{getUserName(exp.whoPaid)}}</span> 付款 <i class="fa-solid fa-caret-right text-gray-400"></i> {{exp.forWhom.length}} 人均分</div><button v-if="exp.whoPaid === currentUser.id" @click="deleteExpense(exp.id)" class="text-red-300 p-2"><i class="fa-solid fa-trash-can"></i></button></div>
                        </div>
                     </div>
                     <button @click="openExpenseModal('split')" class="fab-main bg-blue-400 text-white"><i class="fa-solid fa-plus"></i></button>
                 </div>
             </div>
        </div>
    </div>

    <div v-if="currentView!=='menu'" class="fab-home" @click="currentView='menu'"><i class="fa-solid fa-house"></i></div>
    <a v-if="currentView!=='welcome'" :href="getSearchLink('')" target="_blank" class="fab-search"><i class="fa-brands fa-google"></i></a>

    <div class="cloud-status" @click="saveData">
        <div class="status-dot" :class="isSaving === 'saving' ? 'bg-yellow-400 animate-pulse' : isSaving === 'error' ? 'bg-red-500' : 'bg-green-400'"></div>
        <button v-if="isSaving === 'error'" class="underline ml-1 font-bold text-red-400">重試</button>
        <span v-else>{{ isSaving === 'saving' ? 'Saving...' : 'Synced' }}</span>
    </div>

    <div v-if="showPersonaModal" class="fixed inset-0 z-[2000] bg-black/85 flex items-center justify-center p-6 backdrop-blur-lg animate-fade-in"><div class="bg-white/95 w-full max-w-sm rounded-[32px] p-8 text-center shadow-2xl relative"><h3 class="font-black text-2xl mb-8 text-gray-700 tracking-wider">請問您是哪一位？</h3><div class="grid grid-cols-2 gap-6"><div v-for="u in users" :key="u.id" class="relative group cursor-pointer" @click="setCurrentUser(u)"><div class="w-24 h-24 mx-auto rounded-full bg-white border-4 border-gray-100 shadow-lg flex items-center justify-center text-4xl mb-3 overflow-hidden transition-all duration-300 group-hover:scale-110 group-hover:border-pink-300 group-hover:shadow-pink-200"><img v-if="u.avatar" :src="u.avatar" class="w-full h-full object-cover"><span v-else>{{u.icon}}</span></div><div class="font-black text-gray-600 text-lg group-hover:text-pink-500 transition">{{u.name}}</div><button v-if="!isGuest" @click.stop="openUserEditor(u)" class="absolute -top-1 -right-1 w-8 h-8 bg-gray-800 text-white rounded-full flex items-center justify-center shadow-md active:scale-90 transition z-10"><i class="fa-solid fa-pen text-xs"></i></button></div></div></div></div>
    <div v-if="showUserEditModal" class="fixed inset-0 z-[2100] bg-black/60 flex items-center justify-center p-6 backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-xl text-center"><h3 class="font-bold text-lg mb-4">編輯身分資料</h3><div class="w-24 h-24 mx-auto rounded-full bg-gray-100 border-4 border-white shadow mb-4 overflow-hidden relative cursor-pointer" @click="$refs.avatarInput.click()"><img v-if="editingUser.avatar" :src="editingUser.avatar" class="w-full h-full object-cover"><span v-else class="text-4xl flex items-center justify-center h-full">{{editingUser.icon}}</span><div class="absolute inset-0 bg-black/30 flex items-center justify-center text-white text-xs font-bold opacity-0 hover:opacity-100 transition">更換</div></div><input v-model="editingUser.name" class="w-full p-3 bg-gray-50 rounded-xl mb-4 text-center font-bold border" placeholder="輸入新暱稱"><div class="flex gap-2"><button @click="showUserEditModal=false" class="flex-1 py-2 bg-gray-100 rounded-xl font-bold text-gray-500">取消</button><button @click="saveUserChanges" class="flex-1 py-2 bg-pink-500 text-white rounded-xl font-bold shadow">儲存 (永久)</button></div></div></div>
    <div v-if="showExpenseModal" class="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-center">{{expenseMode==='private'?'記一筆私帳':'公款分帳'}}</h3><input v-model="modalData.name" placeholder="消費項目 (如: 晚餐)" class="w-full p-3 bg-gray-50 rounded-xl mb-3 border font-bold"><div class="flex gap-2 mb-3"><input type="number" v-model="modalData.amount" placeholder="金額" class="flex-1 p-3 bg-gray-50 rounded-xl border font-black text-lg"><select v-model="modalData.currency" class="bg-gray-100 rounded-xl px-2 font-bold text-sm outline-none"><option value="JPY">JPY</option><option value="TWD">TWD</option></select></div><div class="mb-4"><label class="text-xs font-bold text-gray-400 ml-1 mb-1 block">付款方式</label><div class="grid grid-cols-4 gap-2"><button v-for="m in ['cash','card','suica','other']" :key="m" @click="modalData.method=m" :class="['py-2 rounded-xl text-xs font-bold border transition', modalData.method===m?'bg-yellow-400 text-white border-yellow-400':'bg-white text-gray-400 border-gray-200']">{{ {'cash':'現金','card':'信用卡','suica':'西瓜卡','other':'其他'}[m] }}</button></div></div><div v-if="expenseMode==='split'" class="mb-4 bg-blue-50 p-3 rounded-xl"><label class="text-xs text-blue-500 font-bold ml-1 block mb-2">誰先墊錢?</label><div class="flex gap-2 overflow-x-auto hide-scrollbar"><button v-for="u in users" :key="u.id" @click="modalData.whoPaid=u.id" :class="['px-3 py-1 rounded-full text-xs font-bold border transition whitespace-nowrap', modalData.whoPaid===u.id?'bg-blue-500 text-white':'bg-white text-gray-400']">{{u.name}}</button></div><label class="text-xs text-blue-500 font-bold ml-1 block mt-3 mb-2">平分給誰?</label><div class="flex gap-2 overflow-x-auto hide-scrollbar"><button v-for="u in users" :key="u.id" @click="toggleShare(u.id)" :class="['px-3 py-1 rounded-full text-xs font-bold border transition whitespace-nowrap', modalData.forWhom.includes(u.id)?'bg-pink-400 text-white':'bg-white text-gray-400']">{{u.name}}</button></div></div><button @click="saveExpense" class="w-full py-3 bg-yellow-400 text-white rounded-xl font-bold shadow-lg">儲存</button><button @click="showExpenseModal=false" class="w-full py-3 mt-2 text-gray-400 font-bold">取消</button></div></div>
    <div v-if="showFlightModal" class="fixed inset-0 z-[1200] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-center">編輯機票 ({{flightMode==='out'?'去程':'回程'}})</h3><label class="text-xs font-bold text-gray-400 ml-1">航班代號</label><input v-model="tempFlightData.code" placeholder="如 TR898" class="w-full p-3 bg-gray-50 rounded-xl mb-3 border font-black uppercase"><label class="text-xs font-bold text-gray-400 ml-1">座位號碼</label><input v-model="tempFlightData.seat" placeholder="如 12A" class="w-full p-3 bg-gray-50 rounded-xl mb-6 border font-black uppercase"><button @click="saveFlight" class="w-full py-3 bg-pink-500 text-white rounded-xl font-bold shadow-lg">更新機票</button></div></div>
    <div v-if="showLoginModal" class="fixed inset-0 z-[2000] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-3xl p-8 shadow-2xl"><h3 class="text-2xl font-black text-center mb-6">同步雲端</h3><input v-model="loginForm.email" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 font-bold" placeholder="Email"><input v-model="loginForm.password" type="password" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 font-bold" placeholder="Password"><button @click="doLogin" class="w-full py-4 bg-pink-500 text-white font-black rounded-2xl">登入</button><button @click="showLoginModal=false" class="w-full py-2 mt-2 text-gray-400 font-bold">取消</button></div></div>

    <div v-if="showModal" class="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-center">{{modalTitle}}</h3>
            <div class="space-y-3">
                <div v-if="modalTitle==='新增交通票券'" class="mb-2">
                    <label class="text-xs font-bold text-gray-400 ml-1">快速模版 (自動帶入)</label>
                    <select v-model="modalData.type" @change="applyTicketTemplate" class="w-full p-2 bg-gray-100 rounded-xl font-bold text-sm">
                        <option value="">自訂</option><option value="suica">Suica 西瓜卡</option><option value="metro">東京地鐵券</option><option value="jrpass">JR 廣域周遊券</option><option value="fuji">富士回遊號</option>
                    </select>
                </div>
                <div v-for="f in modalFields" :key="f.key">
                    <label v-if="f.label" class="text-xs font-bold text-gray-400 ml-1 mb-1 block">{{f.label}}</label>
                    <div v-if="f.type==='checkbox'" class="flex items-center bg-gray-50 p-3 rounded-xl border">
                        <input type="checkbox" v-model="modalData[f.key]" class="w-5 h-5 accent-pink-500 mr-3">
                        <span class="font-bold text-gray-700 text-sm">{{f.text||f.label}}</span>
                    </div>
                    <div v-else-if="f.key==='note' && modalData.reserve" class="bg-red-50 p-2 rounded text-xs text-red-500 font-bold mb-2">* 提醒：請記得在下方填入預訂連結</div>
                    <textarea v-else-if="f.type==='textarea'" v-model="modalData[f.key]" :placeholder="f.placeholder" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-pink-300 h-24"></textarea>
                    <input v-else-if="f.onInput" v-model="modalData[f.key]" @input="f.onInput" :placeholder="f.placeholder" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-pink-300">
                    <input v-else v-model="modalData[f.key]" :placeholder="f.placeholder" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-pink-300">
                </div>
                <button v-if="modalHasImg" @click="$refs.modalImgInput.click()" class="w-full py-3 bg-blue-50 text-blue-500 rounded-xl font-bold border border-blue-100">{{modalData.img?'更換圖片':'上傳圖片'}}</button>
                <div v-if="modalTitle==='新增翻譯'" class="text-xs text-gray-400 text-center pt-2">* 填寫中文，可按下方按鈕自動翻譯</div>
                <div v-if="modalTitle==='新增行程' && modalData.name" class="text-center">
                    <a :href="getDirLink(modalData.name)" target="_blank" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full font-bold border border-gray-300 shadow-sm"><i class="fa-solid fa-route"></i> 🔍 估算時間 (Google Maps)</a>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">取消</button>
                <button v-if="modalTitle==='新增翻譯'" @click="openGoogleTranslate(modalData.zh)" class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-bold shadow-lg">去 G 翻譯</button>
                <button @click="handleModalSave" class="flex-1 py-3 bg-pink-500 text-white rounded-xl font-bold shadow-lg">儲存</button>
            </div>
            <button v-if="isEditingItem" @click="handleModalDelete" class="w-full mt-2 text-red-300 py-2 font-bold text-xs"><i class="fa-solid fa-trash"></i> 刪除此項目</button>
        </div>
        <input type="file" ref="modalImgInput" accept="image/*" class="hidden" @change="processModalImg">
    </div>

    <div v-if="expandedPhrase" class="fixed inset-0 z-[5000] bg-white flex flex-col items-center justify-center p-10 text-center"><div class="flex-1 flex flex-col items-center justify-center w-full"><div class="text-[80px] leading-tight font-black mb-10 text-gray-800 break-words w-full">{{expandedPhrase.jp}}</div><div class="text-3xl font-bold text-gray-500 mb-16">{{expandedPhrase.zh}}</div><button @click.stop="speakJapanese(expandedPhrase.jp)" class="w-24 h-24 rounded-full bg-emerald-500 text-white text-4xl shadow-xl flex items-center justify-center active:scale-90 transition animate-pulse-slow"><i class="fa-solid fa-volume-high"></i></button><div class="mt-4 text-emerald-600 font-bold">點擊播放發音</div></div><button class="mb-10 w-16 h-16 rounded-full bg-gray-100 text-gray-400 text-2xl flex items-center justify-center shadow-md active:scale-90" @click="expandedPhrase=null"><i class="fa-solid fa-times"></i></button></div>
    
    <input type="file" ref="avatarInput" accept="image/*" class="hidden" @change="processAvatarUpload">

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3.3.4/dist/vue.esm-browser.js";

const firebaseConfig = { apiKey: "AIzaSyD3ojbkJVfDKmZQHRpZG-gp8gv7ajKdJr4", authDomain: "tokyo-trip-24b28.firebaseapp.com", projectId: "tokyo-trip-24b28", storageBucket: "tokyo-trip-24b28.firebasestorage.app", messagingSenderId: "518699705070", appId: "1:518699705070:web:56e95f603210d8d5d209ff" };
let auth, db; try { const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); enableIndexedDbPersistence(db).catch(e=>{console.log("Persistence enabled")}); } catch (e) { console.warn("Firebase Init Fail", e); }

const defaultData = {
    users: [{id:1,name:'吉伊',icon:'🐹',list:[]},{id:2,name:'小八',icon:'🐱',list:[]},{id:3,name:'兔兔',icon:'🐰',list:[]},{id:4,name:'小桃',icon:'🍑',list:[]}],
    itinerary: [
        [{hours:"06:40",category:"Flight",name:"TPE 起飛",note:"T1 辦理登機",mapKeyword:"桃園機場 T1"},{hours:"10:40",category:"Flight",name:"NRT 抵達",note:"領取行李/購買西瓜卡",mapKeyword:"成田機場"},{hours:"14:00",category:"Sightseeing",name:"晴空塔",note:"下午行程",mapKeyword:"東京晴空塔",travelTime:"⬇ 60-90min (電車/巴士)"},{hours:"18:00",category:"Food",name:"錦糸町周遭",note:"晚餐",mapKeyword:"錦糸町站 美食",travelTime:"⬇ 15min (步行)"}],
        [{hours:"09:00",category:"Sightseeing",name:"淺草寺",note:"雷門/仲見世通",mapKeyword:"淺草寺",travelTime:"⬇ 20min (電車)"},{hours:"12:00",category:"Food",name:"淺草周遭",note:"午餐",mapKeyword:"淺草站 美食",travelTime:"⬇ 5min (步行)"},{hours:"14:00",category:"Sightseeing",name:"小網神社/上野公園",note:"強運厄除/公園散步",mapKeyword:"小網神社",travelTime:"⬇ 25min (電車)"},{hours:"18:00",category:"Shopping",name:"秋葉原/東京一番街",note:"動漫或逛街",mapKeyword:"秋葉原",travelTime:"⬇ 15min (電車)"},{hours:"20:00",category:"Food",name:"晚餐",note:"依逛街行程決定",mapKeyword:"東京車站 美食"}],
        [{hours:"08:00",category:"Transport",name:"前往富士山",note:"錦糸町出發 (富士回遊)",mapKeyword:"錦糸町站",travelTime:"⬇ 120min (JR特急)"},{hours:"10:30",category:"Transport",name:"開始租車",note:"富士山租車 3天2夜",mapKeyword:"河口湖 租車",travelTime:"⬇ 0min"},{hours:"13:00",category:"Sightseeing",name:"河口湖自然生活館",note:"大石公園絕景",mapKeyword:"河口湖自然生活館",travelTime:"⬇ 20min (車)"},{hours:"15:00",category:"Sightseeing",name:"新倉山淺間公園",note:"忠靈塔瞭望台 (需爬階梯)",mapKeyword:"新倉山淺間公園",travelTime:"⬇ 25min (車)"},{hours:"17:30",category:"Sightseeing",name:"金鳥居/本町商店街",note:"日川時計店拍照",mapKeyword:"富士吉田本町通り",travelTime:"⬇ 10min (車)"},{hours:"19:00",category:"Food",name:"晚餐",note:"自行烹飪或商店街",mapKeyword:"Ogino 河口湖店"}],
        [{hours:"05:00",category:"Sightseeing",name:"平野之濱",note:"看日出 (視天氣)",mapKeyword:"平野の浜",travelTime:"⬇ 30min (車)"},{hours:"09:00",category:"Sightseeing",name:"長池親水公園/白鳥濱",note:"山中湖租自行車",mapKeyword:"長池親水公園",travelTime:"⬇ 15min (車)"},{hours:"12:00",category:"Food",name:"山中湖餐廳",note:"午餐",mapKeyword:"山中湖 美食",travelTime:"⬇ 0min"},{hours:"14:00",category:"Sightseeing",name:"KABA 水陸巴士",note:"旭日丘湖畔綠地公園",mapKeyword:"KABA BUS",travelTime:"⬇ 10min (車)"},{hours:"18:00",category:"Food",name:"晚餐",note:"自行烹飪 (Ogino超市)",mapKeyword:"Ogino 河口湖店",travelTime:"⬇ 30min (車)"}],
        [{hours:"09:00",category:"Sightseeing",name:"河口湖纜車",note:"金鳥居/絕景鞦韆",mapKeyword:"河口湖 富士山全景纜車",travelTime:"⬇ 20min (車)"},{hours:"11:00",category:"Shopping",name:"Fujisan Shokupan",note:"購買伴手禮點心",mapKeyword:"Fujisan Shokupan",travelTime:"⬇ 10min (車)"},{hours:"14:00",category:"Transport",name:"富士回遊",note:"返回東京新宿 (放行李)",mapKeyword:"河口湖站",travelTime:"⬇ 120min (JR特急)"},{hours:"16:30",category:"Shopping",name:"池袋太陽城",note:"逛街行程",mapKeyword:"池袋太陽城",travelTime:"⬇ 20min (電車)"},{hours:"19:00",category:"Food",name:"太陽城餐廳",note:"晚餐",mapKeyword:"池袋太陽城 美食"}],
        [{hours:"09:00",category:"Transport",name:"前往藤澤",note:"新宿出發 (江之電一日遊)",mapKeyword:"新宿站",travelTime:"⬇ 60min (小田急)"},{hours:"10:30",category:"Sightseeing",name:"江之島/鎌倉高校",note:"灌籃高手平交道",mapKeyword:"鎌倉高校前站",travelTime:"⬇ 20min (江之電)"},{hours:"13:00",category:"Food",name:"七里濱餐廳",note:"午餐",mapKeyword:"七里濱 美食",travelTime:"⬇ 10min (江之電)"},{hours:"15:00",category:"Sightseeing",name:"鎌倉/鶴岡八幡宮",note:"小町通逛街",mapKeyword:"鶴岡八幡宮",travelTime:"⬇ 20min (江之電)"},{hours:"18:00",category:"Transport",name:"返回新宿",note:"晚餐: 新宿或烹飪",mapKeyword:"新宿站",travelTime:"⬇ 60min (小田急)"}],
        [{hours:"09:00",category:"Sightseeing",name:"東京鐵塔/麻布台",note:"六本木周遭拍照",mapKeyword:"麻布台Hills",travelTime:"⬇ 30min (地鐵)"},{hours:"12:00",category:"Food",name:"六本木餐廳",note:"午餐",mapKeyword:"六本木 美食",travelTime:"⬇ 10min (步行)"},{hours:"14:00",category:"Shopping",name:"前往澀谷",note:"逛街",mapKeyword:"澀谷站",travelTime:"⬇ 15min (地鐵)"},{hours:"17:00",category:"Sightseeing",name:"SHIBUYA SKY",note:"絕美日落/十字路口",mapKeyword:"SHIBUYA SKY",travelTime:"⬇ 5min (步行)"},{hours:"20:00",category:"Food",name:"澀谷餐廳",note:"晚餐",mapKeyword:"澀谷 美食"}],
        [{hours:"10:00",category:"Sightseeing",name:"自由行程",note:"最後採買",mapKeyword:"上野阿美橫丁",travelTime:"⬇ 0min"},{hours:"20:40",category:"Flight",name:"NRT 起飛",note:"成田機場報到",mapKeyword:"成田機場"},{hours:"23:20",category:"Flight",name:"TPE 抵達",note:"回到溫暖的家",mapKeyword:"桃園機場"}]
    ],
    drivePlan: [
        [{hours:"08:00",category:"Transport",name:"前往富士山",note:"錦糸町出發",travelTime:"🚗 120min"}, {hours:"10:30",category:"Transport",name:"開始租車",note:"河口湖 租車",travelTime:"🚗 20min",parkingLink:"https://www.google.com/maps/search/Toyota+Rent+a+Car+Kawaguchiko"}, {hours:"13:00",category:"Sightseeing",name:"河口湖自然生活館",note:"大石公園絕景",travelTime:"🚗 20min",parkingLink:"https://www.google.com/maps/search/Oishi+Park+Parking"}, {hours:"15:00",category:"Sightseeing",name:"新倉山淺間公園",note:"忠靈塔瞭望台",travelTime:"🚗 15min",parkingLink:"https://www.google.com/maps/search/Arakurayama+Sengen+Park+Parking"}, {hours:"17:30",category:"Sightseeing",name:"金鳥居/本町商店街",note:"日川時計店拍照",travelTime:"🚗 10min",parkingLink:"https://www.google.com/maps/search/Shimoyoshida+Honcho+Street+Parking"}, {hours:"19:00",category:"Food",name:"晚餐",note:"自行烹飪或商店街"}],
        [{hours:"05:00",category:"Sightseeing",name:"平野之濱",note:"看日出",travelTime:"🚗 30min",parkingLink:"https://www.google.com/maps/search/Hirano+no+Hama+Parking"}, {hours:"09:00",category:"Sightseeing",name:"長池親水公園/白鳥濱",note:"山中湖租自行車",travelTime:"🚗 15min",parkingLink:"https://www.google.com/maps/search/Nagaike+Water+Park+Parking"}, {hours:"12:00",category:"Food",name:"山中湖餐廳",note:"午餐",travelTime:"🚗 20min"}, {hours:"14:00",category:"Sightseeing",name:"KABA 水陸巴士",note:"旭日丘湖畔綠地公園",travelTime:"🚗 30min",parkingLink:"https://www.google.com/maps/search/Asahigaoka+Lakeside+Greenspace+Park+Parking"}, {hours:"18:00",category:"Food",name:"晚餐",note:"自行烹飪 (Ogino超市)"}]
    ],
    transportTickets: [
        {name:'東京地鐵券 (24/48/72h)', url:'https://www.tokyometro.jp/tcn/ticket/travel/index.html', icon:'fa-solid fa-subway', note:'【使用範圍】\n東京 Metro 9條線 + 都營地鐵 4條線\n\n【不適用】\nJR 山手線、私鐵 (如百合海鷗號)\n\n【啟用】\n第一次進站起算小時，建議連續使用。'},
        {name:'Suica 西瓜卡', url:'https://www.jreast.co.jp/tc/pass/suica.html', icon:'fa-solid fa-mobile-screen', note:'【手機版】\niPhone 錢包直接新增 > 交通卡 > Suica\n\n【儲值】\n可使用 Apple Pay (Mastercard/JCB)\n\n【實體卡】\n目前缺貨，建議使用 Welcome Suica (成田機場買)'},
        {name:'JR 東京廣域周遊券', url:'https://www.jreast.co.jp/multi/zh-CHT/pass/tokyowide.html', icon:'fa-solid fa-ticket', note:'【售價】\n15,000 日圓 (3天)\n\n【必用行程】\n1. 東京 <-> 河口湖 (富士回遊)\n2. 東京 <-> 輕井澤/日光\n3. 成田機場 (N\'EX)\n\n* 需連續3天使用，請計算總車資是否划算。'},
        {name:'富士回遊號 (JR)', url:'https://www.eki-net.com/zh-CHT/jreast-train-reservation/Top/Index', icon:'fa-solid fa-train', note:'【重要】\n全車指定席，無站票！\n請務必提前 30 天由 Eki-net 預約。\n\n持有廣域周遊券者，仍需去機台劃位 (免費)。'}
    ],
    rentalCars: [
        {company: 'Toyota Rent a Car', pickup: '河口湖站前店', url: 'https://rent.toyota.co.jp/zh-tw/', note: '需準備台灣駕照 + 日文譯本'},
        {company: 'Tabirai 比價網', pickup: '依照方案', url: 'https://tc.tabirai.net/car/', note: '多間租車公司比價'}
    ],
    expenses: [],
    // V36.0 Fully Populated Food Data
    spots: {
        food: {
            Tokyo: [
                {name:'AFURI',desc:'清新柚子鹽拉麵',link:'AFURI 原宿', reserve:false, note:'【免訂位】建議避開用餐尖峰，柚子鹽拉麵必點。'},
                {name:'叙叙苑',desc:'高級燒肉景觀餐廳',link:'叙叙苑 晴空塔', reserve:true, reserveLink:'https://www.tablecheck.com/zh-TW/shops/jojoen-tokyoskytreetown-solamachi/reserve', note:'【需訂位】午間套餐CP值最高，窗邊位置需一個月前預訂。'},
                {name:'HARBS',desc:'必吃水果千層蛋糕',link:'HARBS LUMINE EST', reserve:false, note:'【免訂位】內用每人低消一杯飲料，亦可外帶回飯店吃。'},
                {name:'淺草今半',desc:'百年壽喜燒老店',link:'淺草今半 國際通', reserve:true, reserveLink:'https://www.asakusaimahan.co.jp/english/guide', note:'【需訂位】午間壽喜燒定食較划算，百年老店服務極佳。'},
                {name:'炸牛排 本村',desc:'自行煎烤軟嫩牛排',link:'牛かつもと村 澀谷', reserve:false, note:'【現場排隊】只能現場排隊，建議開店前15分鐘到。'}
            ],
            Kamakura: [
                {name:'Bills',desc:'世界第一好吃鬆餅',link:'Bills 七里ヶ浜', reserve:true, reserveLink:'https://billsjapan.com/en/shichirigahama', note:'【需訂位】戶外座位可看海景，鬆餅製作需20分鐘。'},
                {name:'Caraway',desc:'排隊咖哩名店',link:'Caraway Curry', reserve:false, note:'【現場排隊】份量非常大，女生建議點小飯。只收現金。'},
                {name:'Pacific Drive-in',desc:'海景夏威夷餐廳',link:'Pacific Drive-in', reserve:false, note:'【現場排隊】週末人潮多，蒜蓉蝦飯是招牌。'},
                {name:'力餅家',desc:'百年老舖權五郎力餅',link:'力餅家', reserve:false, note:'保存期限短，建議當天吃完。'},
                {name:'鎌倉釜飯',desc:'吻仔魚釜飯',link:'鎌倉釜飯 かまかま', reserve:true, reserveLink:'https://www.kamakama.jp/', note:'【建議訂位】最後可以加高湯變茶泡飯，一飯兩吃。'}
            ],
            Fuji: [
                {name:'不動茶屋',desc:'特色雲朵建築餺飥麵',link:'不動茶屋 東戀路', reserve:false, note:'【現場排隊】東戀路店建築最美，翻桌率快。'},
                {name:'山麓園',desc:'炭火爐端燒體驗',link:'山麓園', reserve:true, reserveLink:'https://sanrokuen.com/', note:'【建議訂位】體驗圍爐裏燒烤，身上會有炭火味。'},
                {name:'湖波',desc:'河口湖景觀定食',link:'湖波食事處', reserve:false, note:'【現場排隊】靠窗位置可看富士山，天婦羅定食推薦。'},
                {name:'Hana 燒肉',desc:'當地人推薦燒肉',link:'Hana Yakiniku', reserve:true, reserveLink:'https://www.hotpepper.jp/strJ000354673/yoyaku/', note:'【需訂位】CP值高的單點燒肉，建議預約。'},
                {name:'The Park',desc:'富士山吐司',link:'Food Labo', reserve:false, note:'富士山造型吐司，拍照打卡必備。'}
            ]
        },
        photo: {
            Tokyo: [{name:'SHIBUYA SKY',desc:'東京最美展望台',link:'SHIBUYA SKY'},{name:'豪德寺',desc:'滿滿招財貓',link:'豪德寺'},{name:'東京鐵塔',desc:'芝公園最佳機位',link:'芝公園 4號地'},{name:'淺草雷門',desc:'經典地標大燈籠',link:'雷門'},{name:'TeamLab',desc:'光影藝術展',link:'TeamLab Planets'}],
            Kamakura: [{name:'鎌倉高校前',desc:'灌籃高手平交道',link:'鎌倉高校前駅'},{name:'長谷寺',desc:'眺望湘南海岸',link:'長谷寺'},{name:'報國寺',desc:'絕美竹林',link:'報國寺'},{name:'江島神社',desc:'海上鳥居',link:'江島神社'},{name:'七里濱',desc:'最美海岸線',link:'七里ヶ浜 海岸'}],
            Fuji: [{name:'新倉山淺間公園',desc:'五重塔與富士山',link:'新倉山淺間公園'},{name:'下吉田',desc:'日川時計店本町通',link:'日川時計店'},{name:'大石公園',desc:'花海富士山',link:'大石公園'},{name:'河口湖車站',desc:'LAWSON 富士山',link:'河口湖駅'},{name:'平野之濱',desc:'寧靜湖畔倒影',link:'平野の浜'}]
        }
    },
    shopping: {
        cosme: [{name:'Canmake 臥蠶盤',link:'https://www.canmake.com/'},{name:'Kate 怪獸唇膏',link:'https://www.nomorerules.net/'},{name:'Tirtir 氣墊粉餅',link:''},{name:'Cezanne 珠光修容',link:'https://www.cezanne.co.jp/'},{name:'Excel 眼影',link:'https://noevirgroup.jp/excel/'}],
        ldk: [{name:'MINON 胺基酸面膜',link:'https://www.daiichisankyo-hc.co.jp/site_minon/'},{name:'Quality 1st 面膜',link:''},{name:'IHADA 化妝水',link:''},{name:'Elixir 小金管',link:''},{name:'Fino 髮膜',link:''}],
        souvenir: [{name:'NY Perfect Cheese',link:''},{name:'Press Butter Sand',link:'https://buttersand.com/'},{name:'Sugar Butter Tree',link:''},{name:'Tokyo Banana',link:'https://www.tokyobanana.jp/'},{name:'白色戀人',link:'https://www.ishiya.co.jp/'}]
    },
    phrases: [{jp:'すみません',zh:'不好意思/請問'},{jp:'これください',zh:'我要這個'},{jp:'いくらですか',zh:'請問多少錢'},{jp:'お会計お願いします',zh:'我要結帳'},{jp:'袋いりません',zh:'不用袋子'},{jp:'トイレはどこですか',zh:'廁所在哪裡'},{jp:'写真を撮ってもいいですか',zh:'可以拍照嗎'},{jp:'英語メニューありますか',zh:'有英文菜單嗎'},{jp:'おすすめは何ですか',zh:'有推薦的嗎'},{jp:'水ください',zh:'請給我水'}]
};

createApp({
    setup() {
        const currentView = ref('welcome');
        const currentUser = ref(null);
        const isGuest = ref(false); 
        const showPersonaModal = ref(false);
        const showUserEditModal = ref(false);
        const editingUser = ref({});
        const isWelcomeClosed = ref(false);
        const showLoginModal = ref(false);
        const loginForm = ref({email:'',password:''});
        const isLoggedIn = ref(false);
        const isSaving = ref('synced'); 
        
        const users = ref(defaultData.users);
        const itinerary = ref(defaultData.itinerary);
        const drivePlan = ref(defaultData.drivePlan);
        const expenses = ref([]);
        const spots = ref(defaultData.spots);
        const shopping = ref(defaultData.shopping);
        const japanesePhrases = ref(defaultData.phrases);
        const suggestedTickets = ref([]); 
        const transportTickets = ref(defaultData.transportTickets);
        const rentalCars = ref(defaultData.rentalCars);
        
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        const exchangeRate = ref(0.215);
        const moneyTab = ref('record');
        const hotelTab = ref('stay');
        const shopCat = ref('cosme');
        const currentLoc = ref('Tokyo');
        const weatherData = ref([{name:'Tokyo',temp:'--',bg:'bg-blue-400'},{name:'Kamakura',temp:'--',bg:'bg-indigo-400'},{name:'Fuji',temp:'--',bg:'bg-purple-400'}]);
        
        const showExpenseModal = ref(false);
        const modalData = ref({});
        const expenseMode = ref('private'); 
        const expandedPhrase = ref(null);
        const showModal = ref(false);
        const modalTitle = ref('');
        const modalFields = ref([]);
        const modalHasImg = ref(false);
        const modalCallback = ref(null);
        const isEditingItem = ref(false); 
        const modalDeleteCallback = ref(null);
        const showFlightModal = ref(false);
        const tempFlightData = ref({code:'',seat:''});
        const flightMode = ref('out'); 

        const apps = [{id:1,name:'行程',icon:'fa-solid fa-map',view:'itinerary',bgClass:'bg-pink-400'},{id:2,name:'小財庫',icon:'fa-solid fa-yen-sign',view:'money',bgClass:'bg-yellow-400'},{id:3,name:'住宿交通',icon:'fa-solid fa-hotel',view:'hotel',bgClass:'bg-indigo-400'},{id:4,name:'行前準備',icon:'fa-solid fa-suitcase',view:'prep',bgClass:'bg-blue-400'},{id:5,name:'吃吃喝喝',icon:'fa-solid fa-utensils',view:'food',bgClass:'bg-orange-400'},{id:6,name:'網美打卡',icon:'fa-solid fa-camera',view:'photo',bgClass:'bg-rose-400'},{id:7,name:'快樂購',icon:'fa-solid fa-bag-shopping',view:'shopping',bgClass:'bg-purple-400'},{id:8,name:'天氣',icon:'fa-solid fa-cloud-sun',view:'weather',bgClass:'bg-sky-400'},{id:9,name:'翻譯',icon:'fa-solid fa-language',view:'japanese',bgClass:'bg-emerald-400'}];
        const tripDays = [{week:'D1',title:'3/27'},{week:'D2',title:'3/28'},{week:'D3',title:'3/29'},{week:'D4',title:'3/30'},{week:'D5',title:'3/31'},{week:'D6',title:'4/01'},{week:'D7',title:'4/02'},{week:'D8',title:'4/03'}];
        const daysUntilTrip = ref(Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24)));
        
        const smartReminders = computed(() => { 
            const l=[]; const diffDays = daysUntilTrip.value;
            const text = JSON.stringify(itinerary.value);
            if(text.includes('富士回遊')) {
                if(diffDays <= 33 && diffDays > 30) l.push("富士回遊號：準備搶票 (30天前)！");
                if(diffDays <= 30) l.push("🔴 富士回遊號：現在可以搶票了！");
            }
            if(diffDays <= 2) l.push("線上預辦登機 (48hr前)");
            return l; 
        });

        const initTickets = () => {
             const text = JSON.stringify(itinerary.value);
             const list = [];
             if(text.includes('SHIBUYA')) list.push({name:'SHIBUYA SKY', url:'https://www.klook.com/zh-TW/activity/70672-shibuya-sky-tokyo/'});
             if(suggestedTickets.value.length === 0) suggestedTickets.value = list;
        };

        const getCurrentItinerary = () => {
             if(itineraryMode.value === 'drive' && [2,3].includes(selectedDayIndex.value)) {
                 return drivePlan.value[selectedDayIndex.value-2] || [];
             }
             return itinerary.value[selectedDayIndex.value] || [];
        };

        const getAmountInTWD = (e) => e.currency==='JPY' ? e.amount*exchangeRate.value : e.amount;
        const myPrivateExpenses = computed(() => currentUser.value ? expenses.value.filter(e => e.whoPaid===currentUser.value.id && e.forWhom.length===1 && e.forWhom[0]===currentUser.value.id) : []);
        const myPrivateTotalTWD = computed(() => myPrivateExpenses.value.reduce((sum, e) => sum + getAmountInTWD(e), 0));
        const groupExpenses = computed(() => expenses.value.filter(e => e.forWhom.length > 1 || (e.forWhom.length===1 && e.forWhom[0]!==e.whoPaid)));
        const getPaymentIcon = (m) => ({'cash':'💵','card':'💳','suica':'🐧','other':'🔖'}[m]||'💵');

        const settlements = computed(() => { 
            const b={}; users.value.forEach(u=>b[u.id]=0); 
            groupExpenses.value.forEach(e=>{ 
                const t=getAmountInTWD(e); b[e.whoPaid]+=t; const s=t/e.forWhom.length; e.forWhom.forEach(i=>b[i]-=s); 
            }); 
            const r=[]; const n=users.value.map(u=>({id:u.id,v:b[u.id]})); 
            const d=n.filter(x=>x.v<-1).sort((x,y)=>x.v-y.v); const c=n.filter(x=>x.v>1).sort((x,y)=>y.v-x.v); 
            let i=0,j=0; 
            while(i<d.length&&j<c.length){ 
                let a=Math.min(-d[i].v,c[j].v); r.push({from:d[i].id,to:c[j].id,amount:Math.round(a)}); 
                d[i].v+=a; c[j].v-=a; if(Math.abs(d[i].v)<1)i++; if(Math.abs(c[j].v)<1)j++; 
            } 
            return r; 
        });

        // Helpers (V36.0 Universal Link & App Force)
        const getMapLink = (k,n) => {
            let q = k || n; if(!q) return '';
            if(q.startsWith('http')) return q;
            // Force App Launch via Universal Link
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
        };
        const getSearchLink = (n) => `https://www.google.com/search?q=${encodeURIComponent(n)}`;
        const getImg = (p) => p.startsWith('data:')?p:`https://raw.githubusercontent.com/sunny5200820-maker/2026.tokyo.fuji.trip/main/${p}`;
        const handleImgError = (e) => e.target.src='https://placehold.co/400x300/pink/white?text=IMAGE';
        const getUserName = (id) => users.value.find(u=>u.id===id)?.name||'未知';
        const getClothingAdvice = (t) => t<10?'羽絨+圍巾':t<15?'大衣+發熱衣':'洋蔥式穿搭';
        const getPageTitle = (view) => ({'itinerary':'行程表','money':'小財庫','hotel':'住宿交通','prep':'行前準備','food':'美食地圖','photo':'打卡景點','shopping':'購物清單','weather':'天氣預報','japanese':'翻譯蒟蒻'}[view]||'關東之旅');
        const getIconByCategory = (cat) => ({'Flight':'fa-solid fa-plane','Sightseeing':'fa-solid fa-camera','Food':'fa-solid fa-utensils','Shopping':'fa-solid fa-bag-shopping','Transport':'fa-solid fa-train-subway','Hotel':'fa-solid fa-bed'}[cat]||'fa-solid fa-location-dot');
        const flightStatusLink = (code) => code ? `https://www.flightradar24.com/data/flights/${code.toLowerCase()}` : '';
        const getAirlineInfo = (flightCode, isShort) => {
            if(!flightCode) return null; const c = flightCode.toUpperCase();
            if(c.startsWith('TR')) return isShort?"酷航 Scoot":"【酷航 Scoot】\n📍 報到：桃園 T1 / 成田 T1 南翼\n🧳 手提：10kg (嚴格秤重)";
            if(c.startsWith('BR')) return isShort?"長榮 EVA":"【長榮 EVA】\n📍 報到：桃園 T2 / 成田 T1 南翼\n🧳 託運：計件制 23kg x 2 件";
            return '請確認電子機票上的航廈資訊';
        };
        const getDirLink = (dest) => {
            const list = getCurrentItinerary();
            let origin = list.length > 0 ? list[list.length-1].mapKeyword || list[list.length-1].name : "";
            // Force App Launch for Directions
            return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}&travelmode=transit`;
        };

        const enterSite = () => { isGuest.value=false; isWelcomeClosed.value=true; showPersonaModal.value=true; };
        const enterAsGuest = () => { isGuest.value=true; currentUser.value = {id:999, name:'訪客', icon:'🕵️', list:[]}; isWelcomeClosed.value=true; currentView.value='menu'; };
        const loadUserData = () => {
             const localUsers = localStorage.getItem('V25_50_USERS');
             if(localUsers) { const parsed = JSON.parse(localUsers); users.value = users.value.map(defU => { const saved = parsed.find(p => p.id === defU.id); return saved ? {...defU, ...saved} : defU; }); }
        };
        const persistUsers = () => { localStorage.setItem('V25_50_USERS', JSON.stringify(users.value)); saveData(); };
        const setCurrentUser = (u) => { 
            if(isGuest.value) return; currentUser.value=u; 
            if(currentUser.value.list.length === 0) { currentUser.value.list = JSON.parse(JSON.stringify(defaultPrepList)); persistUsers(); }
            localStorage.setItem('V25_LAST_USER_ID', u.id); showPersonaModal.value=false; currentView.value='menu'; 
        };
        const openUserEditor = (u) => { editingUser.value={...u}; showUserEditModal.value=true; };
        const saveUserChanges = () => { if(isGuest.value) return; const idx=users.value.findIndex(u=>u.id===editingUser.value.id); if(idx!==-1){ users.value[idx]={...editingUser.value}; if(currentUser.value && currentUser.value.id === editingUser.value.id) currentUser.value = users.value[idx]; } persistUsers(); showUserEditModal.value=false; };
        const processAvatarUpload = (e) => { const r=new FileReader(); r.onload=ev=>editingUser.value.avatar=ev.target.result; r.readAsDataURL(e.target.files[0]); };
        const handleAuthClick = () => isLoggedIn.value ? (confirm('登出雲端?')&&signOut(auth)) : showLoginModal.value=true;
        const doLogin = async () => { try{await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth,loginForm.value.email,loginForm.value.password);showLoginModal.value=false;}catch(e){alert(e.message);} };
        const openExpenseModal = (mode) => { expenseMode.value = mode; modalData.value={name:'', amount:'', currency:'JPY', method:'cash', whoPaid: currentUser.value.id, forWhom: mode==='private' ? [currentUser.value.id] : users.value.map(u=>u.id)}; showExpenseModal.value=true; };
        const toggleShare = (id) => { const i=modalData.value.forWhom.indexOf(id); i>-1?modalData.value.forWhom.splice(i,1):modalData.value.forWhom.push(id); };
        const saveExpense = () => { expenses.value.push({...modalData.value,id:Date.now(),date:new Date().toLocaleDateString()}); saveData(); showExpenseModal.value=false; };
        const deleteExpense = (id) => { if(isGuest.value) return; if(confirm('確定刪除此筆記錄?')){expenses.value=expenses.value.filter(e=>e.id!==id); saveData();} };
        const addPrepItem = (u) => { if(isGuest.value) return; u.list.push({text:'新項目',checked:false}); saveData(); };
        const expandCard = (p) => expandedPhrase.value=p;
        const speakJapanese = (text) => { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; window.speechSynthesis.speak(u); };
        
        // V36.0 Advanced Auto-Fill for Food (Forced Update)
        const autoFillFoodInfo = () => {
            const name = modalData.value.name;
            if(!name) return;
            const n = name.toLowerCase();
            // Intelligent Mapping
            if(n.includes('叙叙苑') || n.includes('敘敘苑')) { 
                modalData.value.reserve=true; 
                modalData.value.reserveLink='https://www.tablecheck.com/zh-TW/shops/jojoen-tokyoskytreetown-solamachi/reserve';
                modalData.value.note='【需訂位】午間套餐CP值最高，窗邊位置需一個月前預訂。'; 
            } else if(n.includes('六歌仙')) {
                modalData.value.reserve=true;
                modalData.value.reserveLink='https://rokkasen.co.jp/cn/';
                modalData.value.note='【需訂位】吃到飽熱門店，建議提前兩週預約。';
            } else if(n.includes('afuri')) { 
                modalData.value.reserve=false; 
                modalData.value.note='【免訂位】建議避開用餐尖峰，柚子鹽拉麵必點。'; 
            } else if(n.includes('harbs')) { 
                modalData.value.reserve=false; 
                modalData.value.note='【現場排隊】內用每人低消一杯飲料，水果千層必點。'; 
            } else if(n.includes('炸牛排') || n.includes('本村')) { 
                modalData.value.reserve=false; 
                modalData.value.note='【現場排隊】只能現場排隊，翻桌率約45分鐘。'; 
            }
        };

        const openAddShopModal = () => { modalTitle.value='新增商品'; modalFields.value=[{key:'name',label:'商品名稱'},{key:'link',label:'官方連結 (選填)'}]; modalData.value={name:'',link:'',img:''}; modalHasImg.value=true; isEditingItem.value=false; modalCallback.value=()=>{shopping.value[shopCat.value].push(modalData.value); saveData();}; showModal.value=true; };
        const openAddSpotModal = () => { modalTitle.value='新增景點'; modalFields.value=[{key:'name',label:'名稱'},{key:'desc',label:'描述'},{key:'link',label:'地圖關鍵字'}]; modalData.value={name:'',desc:'',link:'',img:''}; modalHasImg.value=true; isEditingItem.value=false; modalCallback.value=()=>{spots.value.photo[currentLoc.value].push(modalData.value); saveData();}; showModal.value=true; };
        
        // V36.0 Food Modal
        const openAddFoodModal = () => {
            modalTitle.value='新增美食';
            modalFields.value=[
                {key:'name',label:'餐廳名稱', onInput: autoFillFoodInfo}, 
                {key:'desc',label:'描述 (如: 招牌菜)'},
                {key:'reserve',label:'需要訂位?', type:'checkbox'},
                {key:'reserveLink',label:'預約連結 (選填)'},
                {key:'note',label:'老饕筆記 (如: 排隊攻略)', type:'textarea'},
                {key:'link',label:'地圖關鍵字'}
            ];
            modalData.value={name:'',desc:'',reserve:false,reserveLink:'',note:'',link:'',img:''}; 
            modalHasImg.value=true; isEditingItem.value=false; 
            modalCallback.value=()=>{ 
                if(!modalData.value.note) autoFillFoodInfo();
                spots.value.food[currentLoc.value].push(modalData.value); saveData(); 
            }; 
            showModal.value=true;
        };

        const openAddPhraseModal = () => { modalTitle.value='新增翻譯'; modalFields.value=[{key:'zh',label:'中文 (可自動翻譯)'},{key:'jp',label:'日文'}]; modalData.value={zh:'',jp:''}; modalHasImg.value=false; isEditingItem.value=false; modalCallback.value=()=>{japanesePhrases.value.push(modalData.value); saveData();}; showModal.value=true; };
        const openAddTicketModal = () => { modalTitle.value='新增門票'; modalFields.value=[{key:'name',label:'景點名稱'},{key:'url',label:'購票連結'}]; modalData.value={name:'',url:'https://', custom:true}; modalHasImg.value=false; isEditingItem.value=false; modalCallback.value=()=>{suggestedTickets.value.push(modalData.value); saveData();}; showModal.value=true; };
        const openAddTransTicketModal = () => { modalTitle.value='新增交通票券'; modalFields.value=[{key:'name',label:'票券名稱'},{key:'url',label:'資訊連結'},{key:'note',label:'注意事項 (支援換行)', type:'textarea'}]; modalData.value={name:'',url:'https://', note:'', icon:'fa-solid fa-ticket', custom:true, type:''}; modalHasImg.value=false; isEditingItem.value=false; modalCallback.value=()=>{transportTickets.value.push(modalData.value); saveData();}; showModal.value=true; };
        const applyTicketTemplate = () => { const t = modalData.value.type; if(t==='suica') { modalData.value.name='Suica 西瓜卡'; modalData.value.icon='fa-solid fa-mobile-screen'; modalData.value.url='https://www.jreast.co.jp/tc/pass/suica.html'; modalData.value.note='【手機版】\niPhone 錢包直接新增 > 交通卡 > Suica\n\n【儲值】\n可使用 Apple Pay'; } if(t==='metro') { modalData.value.name='東京地鐵券'; modalData.value.icon='fa-solid fa-subway'; modalData.value.url='https://www.tokyometro.jp/tcn/ticket/travel/index.html'; modalData.value.note='【使用範圍】\n東京 Metro 9條線 + 都營地鐵 4條線\n\n【啟用】\n第一次進站起算小時。'; } if(t==='jrpass') { modalData.value.name='JR 東京廣域周遊券'; modalData.value.icon='fa-solid fa-ticket'; modalData.value.url='https://www.jreast.co.jp/multi/zh-CHT/pass/tokyowide.html'; modalData.value.note='【售價】\n15,000 日圓 (3天)\n\n【必用行程】\n1. 富士回遊\n2. 機場快線 N\'EX'; } if(t==='fuji') { modalData.value.name='富士回遊號 (JR)'; modalData.value.icon='fa-solid fa-train'; modalData.value.url='https://www.eki-net.com/zh-CHT/jreast-train-reservation/Top/Index'; modalData.value.note='【重要】\n全車指定席，無站票！\n請務必提前 30 天由 Eki-net 預約。'; } };
        const openAddCarModal = () => { modalTitle.value = '新增租車預約'; modalFields.value = [{key:'company',label:'租車公司 (如 Toyota)'},{key:'pickup',label:'取車地點'},{key:'url',label:'預約連結/官網'},{key:'note',label:'備註 (車型/保險)'}]; modalData.value = {company:'', pickup:'', url:'', note:''}; modalHasImg.value = false; isEditingItem.value = false; modalCallback.value = () => { rentalCars.value.push(modalData.value); saveData(); }; showModal.value = true; };
        const deleteCar = (idx) => { if(confirm('確定刪除此租車紀錄？')) { rentalCars.value.splice(idx,1); saveData(); } };
        const openAddItineraryModal = () => { modalTitle.value = '新增行程'; modalFields.value = [{key:'hours',label:'時間 (如 14:00)'},{key:'name',label:'行程名稱'},{key:'note',label:'備註/說明'},{key:'mapKeyword',label:'地圖關鍵字 (留空自動抓取)'},{key:'travelTime',label:'下個點交通時間'}]; modalData.value = {hours:'', name:'', note:'', mapKeyword:'', travelTime:'', category:'Sightseeing'}; modalHasImg.value = false; isEditingItem.value = false; modalCallback.value = () => { const arr = (itineraryMode.value === 'drive' && [2,3].includes(selectedDayIndex.value)) ? drivePlan.value[selectedDayIndex.value-2] : itinerary.value[selectedDayIndex.value]; arr.push(modalData.value); arr.sort((a,b) => a.hours.localeCompare(b.hours)); saveData(); }; showModal.value = true; };
        const openEditItineraryModal = (item, idx) => { if(isGuest.value) return; modalTitle.value = '編輯行程'; modalFields.value = [{key:'hours',label:'時間'}, {key:'name',label:'名稱'}, {key:'note',label:'備註'}, {key:'mapKeyword',label:'地圖關鍵字'}, {key:'travelTime',label:'交通時間'}]; modalData.value = {...item}; modalHasImg.value = false; isEditingItem.value = true; const targetArray = (itineraryMode.value === 'drive' && [2,3].includes(selectedDayIndex.value)) ? drivePlan.value[selectedDayIndex.value-2] : itinerary.value[selectedDayIndex.value]; modalCallback.value = () => { targetArray[idx] = modalData.value; targetArray.sort((a,b) => a.hours.localeCompare(b.hours)); saveData(); }; modalDeleteCallback.value = () => { targetArray.splice(idx, 1); saveData(); }; showModal.value = true; };
        const moveItem = (index, direction) => { if (isGuest.value) return; const targetArray = (itineraryMode.value === 'drive' && [2,3].includes(selectedDayIndex.value)) ? drivePlan.value[selectedDayIndex.value-2] : itinerary.value[selectedDayIndex.value]; if (direction === -1 && index > 0) { [targetArray[index], targetArray[index - 1]] = [targetArray[index - 1], targetArray[index]]; } else if (direction === 1 && index < targetArray.length - 1) { [targetArray[index], targetArray[index + 1]] = [targetArray[index + 1], targetArray[index]]; } saveData(); };
        
        const openEditModal = (type, item, idx) => {
            if(isGuest.value) return;
            modalTitle.value = '編輯內容';
            modalData.value = {...item};
            modalHasImg.value = true;
            isEditingItem.value = true;
            if(type === 'shopping') {
                modalFields.value=[{key:'name',label:'商品名稱'},{key:'link',label:'連結'}];
                modalCallback.value = () => { shopping.value[shopCat.value][idx] = modalData.value; saveData(); };
                modalDeleteCallback.value = () => { shopping.value[shopCat.value].splice(idx, 1); saveData(); };
            } else if (type === 'spot') {
                modalFields.value=[{key:'name',label:'名稱'},{key:'desc',label:'描述'},{key:'link',label:'地圖關鍵字'}];
                modalCallback.value = () => { spots.value.photo[currentLoc.value][idx] = modalData.value; saveData(); };
                modalDeleteCallback.value = () => { spots.value.photo[currentLoc.value].splice(idx, 1); saveData(); };
            } else if (type === 'food') {
                modalFields.value=[
                    {key:'name',label:'名稱',onInput:autoFillFoodInfo},
                    {key:'desc',label:'描述'},
                    {key:'reserve',label:'需訂位?',type:'checkbox'},
                    {key:'reserveLink',label:'預約連結 (選填)'},
                    {key:'note',label:'筆記',type:'textarea'},
                    {key:'link',label:'地圖關鍵字'}
                ];
                modalCallback.value = () => { spots.value.food[currentLoc.value][idx] = modalData.value; saveData(); };
                modalDeleteCallback.value = () => { spots.value.food[currentLoc.value].splice(idx, 1); saveData(); };
            }
            showModal.value = true;
        };

        const handleModalSave = () => { if(modalCallback.value)modalCallback.value(); showModal.value=false; };
        const handleModalDelete = () => { if(confirm('確定刪除？') && modalDeleteCallback.value) { modalDeleteCallback.value(); showModal.value=false; } };
        const processModalImg = (e) => { const r=new FileReader(); r.onload=ev=>modalData.value.img=ev.target.result; r.readAsDataURL(e.target.files[0]); };
        const openGoogleTranslate = (text) => { window.open(`https://translate.google.com/?sl=zh-TW&tl=ja&text=${encodeURIComponent(text)}&op=translate`, '_blank'); };
        const editFlight = (mode) => { if(isGuest.value) return; flightMode.value = mode; tempFlightData.value.code = mode==='out' ? (currentUser.value.flightOut||'') : (currentUser.value.flightIn||''); tempFlightData.value.seat = mode==='out' ? (currentUser.value.flightOutSeat||'') : (currentUser.value.flightInSeat||''); showFlightModal.value = true; };
        const saveFlight = () => { if(flightMode.value === 'out') { currentUser.value.flightOut = tempFlightData.value.code; currentUser.value.flightOutSeat = tempFlightData.value.seat; } else { currentUser.value.flightIn = tempFlightData.value.code; currentUser.value.flightInSeat = tempFlightData.value.seat; } const idx = users.value.findIndex(u=>u.id===currentUser.value.id); if(idx!==-1) users.value[idx] = currentUser.value; persistUsers(); saveData(); showFlightModal.value = false; };

        // V36.0 Fortress Save Logic (Sequential + Sanitizer + Optimistic Lock)
        let saveQueue = Promise.resolve();
        const isOffline = ref(!navigator.onLine);
        window.addEventListener('offline', () => { isOffline.value = true; isSaving.value = 'error'; });
        window.addEventListener('online', () => { isOffline.value = false; saveData(); });

        // V36.0 Data Sanitizer (Fixes old data structure issues)
        const sanitizeData = (data) => {
            if(!data.spots.food) data.spots.food = defaultData.spots.food;
            // Forcefully repair any missing fields in food data
            for (const city in data.spots.food) {
                if(!data.spots.food[city]) data.spots.food[city] = [];
                data.spots.food[city] = data.spots.food[city].map(item => ({
                    ...item,
                    reserve: item.reserve !== undefined ? item.reserve : false,
                    reserveLink: item.reserveLink || '',
                    note: item.note || ''
                }));
            }
            return data;
        };

        const saveData = async () => { 
            if(isGuest.value) return;
            isSaving.value = 'saving';
            
            // Queue Pattern: Ensure operations are sequential
            saveQueue = saveQueue.then(async () => {
                let data = {
                    users:users.value, itinerary:itinerary.value, expenses:expenses.value, spots:spots.value, 
                    shopping:shopping.value, phrases:japanesePhrases.value, drivePlan:drivePlan.value, 
                    tickets:suggestedTickets.value, transportTickets:transportTickets.value, rentalCars:rentalCars.value
                };
                
                data = sanitizeData(data); // Apply fix

                try {
                    // Level 1: Instant Local Storage
                    localStorage.setItem('V25_DIAMOND_DATA', JSON.stringify(data));
                    
                    // Level 2: Firebase Cloud Sync
                    if(db && isLoggedIn.value && !isOffline.value) {
                        await setDoc(doc(db,"trips","kanto2026"), data, {merge:true}); 
                        // Debounce success message
                        setTimeout(() => isSaving.value = 'synced', 500);
                    } else if (isOffline.value) {
                        isSaving.value = 'error'; // Visual cue
                    }
                } catch(e) { 
                    console.error("Save Failed:", e); 
                    isSaving.value = 'error'; 
                }
            });
        };

        const fetchWeather = async () => { try{ const g=async(la,lo,i)=>{const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${la}&longitude=${lo}&current_weather=true`);const d=await r.json();weatherData.value[i].temp=d.current_weather.temperature;}; await g(35.68,139.69,0); await g(35.31,139.54,1); await g(35.36,138.72,2); }catch(e){} };
        const initSakura = () => { const container = document.getElementById('sakura-container'); if(!container) return; setInterval(() => { const petal = document.createElement('div'); petal.className = 'sakura'; petal.style.left = Math.random() * 100 + 'vw'; petal.style.animationDuration = Math.random() * 3 + 2 + 's'; petal.style.opacity = Math.random(); container.appendChild(petal); setTimeout(() => petal.remove(), 5000); }, 400); };
        window.onbeforeunload = (e) => { if (isSaving.value === 'saving') { const msg = "資料同步中..."; e.returnValue = msg; return msg; } };
        watch(showModal, (val) => { document.body.classList.toggle('modal-open', val); });
        watch(showExpenseModal, (val) => { document.body.classList.toggle('modal-open', val); });
        watch(showFlightModal, (val) => { document.body.classList.toggle('modal-open', val); });

        onMounted(() => {
            initSakura(); loadUserData(); initTickets(); 
            if(auth) onAuthStateChanged(auth, u=>{ isLoggedIn.value=!!u; if(u&&db) onSnapshot(doc(db,"trips","kanto2026"),d=>{if(d.exists()){const dt=d.data(); 
                if(dt.users) users.value = dt.users; 
                itinerary.value=dt.itinerary||itinerary.value; expenses.value=dt.expenses||[]; 
                spots.value=dt.spots||spots.value; shopping.value=dt.shopping||shopping.value; 
                japanesePhrases.value=dt.phrases||japanesePhrases.value; drivePlan.value=dt.drivePlan||drivePlan.value;
                if(dt.tickets) suggestedTickets.value=dt.tickets;
                if(dt.transportTickets) transportTickets.value=dt.transportTickets;
                if(dt.rentalCars) rentalCars.value=dt.rentalCars; 
                
                // V36.0 Force Retroactive Update for Food Notes
                if(dt.spots && dt.spots.food) {
                    const tempSpots = sanitizeData(dt).spots;
                    // Check specific high-value targets if note is missing
                    const targets = {
                        '叙叙苑': {r:true, rl:'https://www.tablecheck.com/zh-TW/shops/jojoen-tokyoskytreetown-solamachi/reserve', n:'【需訂位】午間套餐CP值最高，窗邊位置需一個月前預訂。'},
                        'AFURI': {r:false, n:'【免訂位】建議避開用餐尖峰，柚子鹽拉麵必點。'}
                    };
                    for(const city in tempSpots.food) {
                        tempSpots.food[city].forEach(item => {
                            for(const key in targets) {
                                if(item.name.includes(key) && !item.note) {
                                    item.reserve = targets[key].r;
                                    if(targets[key].rl) item.reserveLink = targets[key].rl;
                                    item.note = targets[key].n;
                                }
                            }
                        });
                    }
                    spots.value = tempSpots;
                }
            }}) });
            
            const l=localStorage.getItem('V25_DIAMOND_DATA'); 
            if(l && !isLoggedIn.value){ 
                try { const d=JSON.parse(l); 
                    if(d.itinerary) itinerary.value = d.itinerary; if(d.expenses) expenses.value=d.expenses;
                    if(d.spots) spots.value=d.spots; if(d.shopping) shopping.value=d.shopping;
                    if(d.phrases) japanesePhrases.value=d.phrases; if(d.drivePlan) drivePlan.value=d.drivePlan;
                    if(d.tickets) suggestedTickets.value=d.tickets; if(d.transportTickets) transportTickets.value=d.transportTickets;
                    if(d.rentalCars) rentalCars.value=d.rentalCars;
                } catch(e) { console.log('Data Reset'); }
            }
            const lastId = localStorage.getItem('V25_LAST_USER_ID');
            if(lastId) { const u = users.value.find(user => user.id === parseInt(lastId)); if(u) setCurrentUser(u); }
            fetchWeather();
        });

        return {
            users, currentView, isWelcomeClosed, enterSite, enterAsGuest, isGuest, apps, getPageTitle,
            daysUntilTrip, smartReminders, tripDays, selectedDayIndex, getCurrentItinerary,
            moneyTab, exchangeRate, myPrivateExpenses, myPrivateTotalTWD, groupExpenses, settlements, getUserName, openExpenseModal, showExpenseModal, modalData, toggleShare, saveExpense, deleteExpense, expenseMode, getPaymentIcon,
            hotelTab, shopCat, shopping, openAddShopModal, currentLoc, spots, openAddSpotModal, weatherData, getClothingAdvice, japanesePhrases, expandCard, expandedPhrase, openAddPhraseModal,
            showModal, modalTitle, modalFields, modalHasImg, handleModalSave, handleModalDelete, isEditingItem, processModalImg, getIconByCategory, getMapLink, getSearchLink, getImg, handleImgError, saveData,
            currentUser, showPersonaModal, setCurrentUser, openUserEditor, showUserEditModal, editingUser, saveUserChanges, processAvatarUpload,
            addPrepItem, openEditModal, showFlightModal, tempFlightData, editFlight, saveFlight, flightMode, speakJapanese,
            handleAuthClick, showLoginModal, loginForm, doLogin, isLoggedIn, itineraryMode, suggestedTickets, openAddTicketModal,
            isSaving, openAddItineraryModal, openEditItineraryModal, openGoogleTranslate,
            transportTickets, openAddTransTicketModal, getAirlineInfo, flightStatusLink, getDirLink, applyTicketTemplate,
            rentalCars, openAddCarModal, deleteCar, moveItem, openAddFoodModal, autoFillFoodInfo
        };
    }
}).mount('#app');
</script>
</body>
</html>
