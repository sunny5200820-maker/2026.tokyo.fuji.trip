<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (V10.11 æ——è‰¦ç‰ˆ)</title>
<style>
    /* --- æ ¸å¿ƒåŸºç¤ --- */
    html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        background-color: #FFF0F5;
        background-image: radial-gradient(#FFD1DC 15%, transparent 16%), radial-gradient(#FFF5BA 15%, transparent 16%);
        background-size: 60px 60px; background-position: 0 0, 30px 30px;
        font-family: -apple-system, BlinkMacSystemFont, "Zen Maru Gothic", sans-serif;
        color: #5D4037; overflow-x: hidden;
        -webkit-tap-highlight-color: transparent;
        padding-bottom: env(safe-area-inset-bottom);
    }
    
    #app { display: block; min-height: 100vh; }
    [v-cloak] { display: none; }
    
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* å¡ç‰‡èˆ‡é™°å½±å„ªåŒ– */
    .card { background: rgba(255,255,255,0.95); border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); border: 1px solid rgba(255,255,255,0.8); margin-bottom: 15px; position: relative; overflow: hidden; }
    
    /* æ­¡è¿é å‹•ç•« */
    .welcome-screen { position: fixed; inset: 0; z-index: 9999; background: #FFF0F5; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
    .welcome-screen.hidden-screen { transform: translateY(-100%); pointer-events: none; }
    .welcome-bg { position: absolute; inset: 0; z-index: 0; }
    .welcome-bg::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.4)); }

    /* æ‡¸æµ®æŒ‰éˆ•ç³»çµ± */
    .fab-main { position: fixed; bottom: calc(90px + env(safe-area-inset-bottom)); right: 20px; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; z-index: 40; border: 3px solid white; box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4); background-color: #ff9eac; transition: all 0.2s; }
    .fab-main:active { transform: scale(0.9); }

    /* Home éµ (ç¨ç«‹å±¤ç´š) */
    .fab-home { position: fixed; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; z-index: 900; border: 4px solid white; box-shadow: 0 5px 20px rgba(0,0,0,0.2); background: linear-gradient(135deg, #FF9EAC, #FFD1DC); cursor: grab; touch-action: none; transition: transform 0.1s; }
    .fab-home:active { transform: scale(0.9); cursor: grabbing; }

    /* æ©Ÿç¥¨èˆ‡æ«»èŠ± */
    .boarding-pass { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #eee; position: relative; margin-bottom: 16px; }
    .dashed-line { border-top: 2px dashed #ddd; margin: 15px 0; position: relative; }
    .sakura { position: fixed; top: -10px; background: #FFB7B2; border-radius: 100% 0 100% 0; opacity: 0.6; animation: fall linear infinite; z-index: 0; pointer-events: none; width: 12px; height: 12px; }
    @keyframes fall { to { transform: translate(15vw, 105vh) rotate(360deg); } }
    
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .watercolor-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .card:active .watercolor-img { transform: scale(1.05); }
    .editable-field:active { background-color: #FFF9C4; }
</style>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
</head>
<body>

<div id="sakura-container"></div>

<div id="app" v-cloak>

    <div :class="['welcome-screen flex flex-col items-center justify-between', isWelcomeClosed ? 'hidden-screen' : '']">
        <div class="welcome-bg">
            <img :src="welcomeImg" @error="handleWelcomeError" class="w-full h-full object-cover">
        </div>
        <div class="relative z-10 mt-32 text-center px-4">
            <h1 class="text-5xl font-black text-white drop-shadow-lg tracking-widest mb-3">é—œæ±ä¹‹æ—…</h1>
            <p class="text-xl text-white drop-shadow-md font-medium tracking-wider bg-white/20 backdrop-blur-sm px-5 py-1 rounded-full inline-block border border-white/30">Chiikawa Sakura Trip 2026</p>
        </div>
        <div class="relative z-10 mb-20 w-full px-8 pb-[env(safe-area-inset-bottom)]">
            <button @click="enterSite" class="w-full bg-white/90 hover:bg-white text-pink-500 font-bold py-4 rounded-full shadow-xl backdrop-blur-sm transition-all transform active:scale-95 text-xl flex items-center justify-center gap-3">
                <span>ğŸŒ¸</span> é–‹å§‹æ—…ç¨‹
            </button>
        </div>
    </div>

    <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-16 bg-[#FFF0F5]/95 backdrop-blur z-30 flex items-center justify-between px-4 border-b border-pink-100 shadow-sm transition-all pt-[env(safe-area-inset-top)]">
        <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow border border-pink-100 active:scale-90 transition"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="font-bold text-gray-700 flex items-center gap-2"><i class="fa-solid fa-sakura text-pink-400"></i> {{getPageTitle(currentView)}}</h1>
        <button @click="showSyncModal=true" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-blue-400 shadow border border-blue-100 active:scale-90 transition"><i class="fa-solid fa-gear"></i></button>
    </div>
    <div v-if="currentView !== 'menu'" class="h-16 pt-[env(safe-area-inset-top)]"></div>

    <div v-if="currentView==='menu'" class="min-h-screen p-6 pt-12 flex flex-col bg-[#FFF0F5] animate-fade-in">
        <h2 class="text-2xl font-black text-gray-700 mb-4 text-center pt-[env(safe-area-inset-top)]"><i class="fa-solid fa-grid-2"></i> åŠŸèƒ½é¸å–®</h2>
        <div class="mb-6 mx-1 bg-white/90 backdrop-blur border-l-4 border-yellow-400 rounded-xl p-4 shadow-sm relative overflow-hidden flex items-start gap-3">
             <div class="text-yellow-500 text-2xl pt-1"><i class="fa-solid fa-bell"></i></div>
             <div class="flex-1">
                 <h4 class="font-bold text-gray-800 text-base mb-1">æ—…ç¨‹å€’æ•¸</h4>
                 <div class="text-sm text-gray-600 font-bold mb-1">è·é›¢ 2026.03.27 é‚„æœ‰ï¼š</div>
                 <div class="text-3xl font-black text-pink-500">{{daysUntilTrip}} <span class="text-sm text-gray-400">å¤©</span></div>
             </div>
             <div class="absolute -right-2 -bottom-4 text-yellow-100 text-8xl -z-10"><i class="fa-solid fa-clock"></i></div>
        </div>
        <div class="grid grid-cols-3 gap-y-8 gap-x-4 mb-24">
            <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition group" @click="currentView=app.view">
                <div class="w-16 h-16 rounded-[24px] flex items-center justify-center text-3xl text-white shadow-lg border-4 border-white group-hover:shadow-xl transition-all" :class="app.bgClass"><i :class="app.icon"></i></div>
                <span class="text-sm font-bold mt-2 text-gray-700">{{app.name}}</span>
            </div>
        </div>
    </div>

    <div v-if="currentView==='itinerary'" class="px-4 py-2 pb-32 animate-fade-in">
        <div class="flex overflow-x-auto gap-2 mb-4 pb-1 hide-scrollbar sticky top-16 bg-[#FFF0F5] z-20 py-2">
            <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-4 py-2 rounded-full whitespace-nowrap text-sm font-bold border-2 transition',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400':'bg-white text-gray-400 border-white']">{{d.week}}<br><span class="text-[10px] opacity-80">{{d.title}}</span></button>
        </div>
        <div v-if="[2,3,4].includes(selectedDayIndex)" class="mb-4 flex justify-center">
            <div class="bg-white p-1 rounded-full border border-gray-200 flex shadow-sm">
                <button @click="itineraryMode='normal'" :class="['px-4 py-1 rounded-full text-xs font-bold transition', itineraryMode==='normal'?'bg-pink-400 text-white':'text-gray-400']">ä¸€èˆ¬è¡Œç¨‹</button>
                <button @click="itineraryMode='drive'" :class="['px-4 py-1 rounded-full text-xs font-bold transition', itineraryMode==='drive'?'bg-green-500 text-white':'text-gray-400']"><i class="fa-solid fa-car"></i> è‡ªé§•åœ°åœ–</button>
            </div>
        </div>
        <div v-if="itineraryMode==='drive' && [2,3,4].includes(selectedDayIndex)" class="animate-fade-in">
             <div class="bg-green-100 border-l-4 border-green-500 p-4 mb-4 rounded-r-xl">
                <h3 class="font-bold text-green-800 text-sm">ä»Šæ—¥è‡ªé§•é‡é»</h3>
                <p class="text-xs text-green-600 mt-1">é»æ“Š ğŸ…¿ï¸ æŒ‰éˆ•å¯ç›´æ¥å°èˆªè‡³åœè»Šå ´ã€‚</p>
            </div>
            <div class="space-y-4 border-l-2 border-green-200 ml-2 pl-4 py-2">
                <div v-for="(stop, sIdx) in getDrivePlanForDay(selectedDayIndex)" :key="sIdx" class="card p-4 relative">
                     <div class="absolute -left-[25px] top-4 w-4 h-4 rounded-full border-2 border-green-400 bg-white z-10"></div>
                     <div class="flex justify-between items-start">
                         <div><h5 class="font-bold text-gray-800">{{stop.name}}</h5><p class="text-xs text-gray-500 mt-1">{{stop.note}}</p></div>
                         <div class="flex flex-col gap-2 shrink-0">
                             <a :href="getMapLink(stop.location)" target="_blank" class="bg-blue-50 text-blue-500 px-3 py-1.5 rounded-lg text-xs font-bold border border-blue-100 flex items-center gap-1 justify-center"><i class="fa-solid fa-location-dot"></i> åœ°é»</a>
                             <a v-if="stop.parking" :href="getMapLink(stop.parking)" target="_blank" class="bg-green-50 text-green-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-green-200 flex items-center gap-1 justify-center"><i class="fa-solid fa-square-parking"></i> åœè»Š</a>
                         </div>
                     </div>
                </div>
            </div>
        </div>
        <div v-else class="space-y-4">
            <div v-if="!currentItinerary || currentItinerary.length === 0" class="text-center py-10 text-gray-400">
                <i class="fa-solid fa-ghost text-4xl mb-2"></i><br>ç›®å‰æ²’æœ‰è¡Œç¨‹<br><span class="text-xs">è«‹é»æ“Šå³ä¸‹è§’ + æ–°å¢</span>
            </div>
            <div v-for="(item,idx) in currentItinerary" :key="item.id||idx" class="card p-4 relative active:scale-[0.98] transition" @click="editItem(item,idx)">
                <div class="absolute left-6 top-0 bottom-0 w-0.5 bg-pink-200"></div>
                <div class="flex relative z-10">
                    <div class="flex flex-col items-center mr-4 pt-1"><div class="w-4 h-4 bg-white border-2 border-pink-400 rounded-full"></div><div class="mt-2 text-gray-300"><i :class="getIconByCategory(item.category)"></i></div></div>
                    <div class="flex-1">
                        <div class="flex justify-between mb-1"><span class="text-xs font-bold text-pink-500 bg-pink-50 px-2 py-0.5 rounded">{{item.hours}}</span><div class="flex gap-2"><a :href="getMapLink(item.mapKeyword)" target="_blank" @click.stop class="w-6 h-6 bg-blue-50 text-blue-400 rounded-full flex items-center justify-center"><i class="fa-solid fa-location-arrow text-xs"></i></a><button @click.stop="deleteItem(idx)" class="text-gray-300 w-6 h-6 flex items-center justify-center rounded-full active:bg-gray-100"><i class="fa-solid fa-trash-can"></i></button></div></div>
                        <h3 class="font-bold text-gray-800 text-lg leading-tight">{{item.name}}</h3>
                        <p class="text-sm text-gray-500 mt-1 pl-2 border-l-2 border-gray-100">{{item.note}}</p>
                    </div>
                </div>
            </div>
            <button @click="openAddModal" class="fab-main"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <div v-if="currentView==='hotel'" class="px-4 py-2 pb-32 animate-fade-in">
        <div class="flex gap-2 mb-4 justify-center"><button @click="hotelTab='stay'" :class="['px-6 py-2 rounded-full font-bold shadow-sm transition',hotelTab==='stay'?'bg-indigo-400 text-white':'bg-white text-gray-400']">ä½å®¿</button><button @click="hotelTab='flight'" :class="['px-6 py-2 rounded-full font-bold shadow-sm transition',hotelTab==='flight'?'bg-pink-400 text-white':'bg-white text-gray-400']">æ©Ÿç¥¨</button></div>
        <div v-if="hotelTab==='stay'" class="space-y-5">
            <div v-for="h in hotels" class="card p-5 border border-indigo-100 relative overflow-hidden group hover:shadow-lg transition">
                <div class="absolute top-0 right-0 bg-indigo-500 text-white text-xs font-bold px-3 py-1 rounded-bl-xl shadow-sm">{{h.days}}</div>
                <h3 class="font-bold text-xl mt-2 text-gray-800 pr-12">{{h.name}}</h3>
                <a :href="h.link" target="_blank" class="block mt-4 bg-gradient-to-r from-indigo-500 to-blue-500 text-white py-3 text-center rounded-xl font-bold shadow-md hover:shadow-lg transition active:scale-95"><i class="fa-solid fa-map-location-dot mr-2"></i> é–‹å•Ÿåœ°åœ–å°èˆª</a>
            </div>
        </div>
        <div v-if="hotelTab==='flight'">
            <div v-if="flightMode==='select'" class="grid grid-cols-2 gap-4">
                <div v-for="user in users" :key="user.id" class="card p-5 text-center cursor-pointer hover:bg-pink-50 transition relative" @click="currentFlightUser=user.id;flightMode='list'">
                    <button @click.stop="openUserEdit(user)" class="absolute top-2 right-2 text-gray-300 hover:text-blue-500 bg-white rounded-full w-6 h-6 shadow"><i class="fa-solid fa-pen text-xs"></i></button>
                    <div class="text-4xl mb-2 flex justify-center"><img v-if="user.avatar" :src="user.avatar" class="w-12 h-12 rounded-full object-cover border-2 border-pink-200"><span v-else>{{user.icon}}</span></div>
                    <div class="font-bold text-gray-700">{{user.name}}</div>
                </div>
            </div>
            <div v-if="flightMode==='list'">
                <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg text-gray-700">{{getUserById(currentFlightUser).name}} çš„æ©Ÿç¥¨</h3><button @click="flightMode='select'" class="text-xs bg-white px-3 py-1 rounded-full shadow text-gray-500">åˆ‡æ›</button></div>
                <div class="boarding-pass">
                    <div class="bg-yellow-400 px-4 py-2 text-gray-800 font-bold text-xs flex justify-between"><span>OUTBOUND å»ç¨‹</span><span>{{getUserById(currentFlightUser).name}}</span></div>
                    <div class="p-4 flex justify-between items-center">
                        <div class="text-center"><div class="text-3xl font-black text-gray-800">TPE</div><div class="text-xs text-gray-400">æ¡ƒåœ’</div></div>
                        <div class="flex-1 px-4 text-center"><i class="fa-solid fa-plane text-yellow-300 text-xl"></i><div class="text-[10px] text-gray-400 font-bold mt-1 editable-field p-1 rounded" @click="editFlightField('out_code')">{{getUserById(currentFlightUser).flightOutCode || 'TR 898'}}</div></div>
                        <div class="text-center"><div class="text-3xl font-black text-gray-800">NRT</div><div class="text-xs text-gray-400">æˆç”°</div></div>
                    </div>
                    <div class="dashed-line"></div>
                    <div class="px-4 pb-4 flex justify-between text-sm">
                        <div class="font-bold text-gray-600 editable-field p-1 rounded" @click="editFlightField('out_dep')">{{getUserById(currentFlightUser).flightOutDep || '06:40'}} <span class="text-[10px] font-normal text-gray-400">Depart</span></div>
                        <div class="font-bold text-gray-600 editable-field p-1 rounded" @click="editFlightField('out_arr')">{{getUserById(currentFlightUser).flightOutArr || '10:40'}} <span class="text-[10px] font-normal text-gray-400">Arrive</span></div>
                    </div>
                </div>
                 <div class="boarding-pass">
                    <div class="bg-blue-400 px-4 py-2 text-white font-bold text-xs flex justify-between"><span>INBOUND å›ç¨‹</span><span>{{getUserById(currentFlightUser).name}}</span></div>
                    <div class="p-4 flex justify-between items-center">
                        <div class="text-center"><div class="text-3xl font-black text-gray-800">NRT</div><div class="text-xs text-gray-400">æˆç”°</div></div>
                        <div class="flex-1 px-4 text-center"><i class="fa-solid fa-plane fa-rotate-180 text-blue-300 text-xl"></i><div class="text-[10px] text-gray-400 font-bold mt-1 editable-field p-1 rounded" @click="editFlightField('in_code')">{{getUserById(currentFlightUser).flightInCode || 'BR197'}}</div></div>
                        <div class="text-center"><div class="text-3xl font-black text-gray-800">TPE</div><div class="text-xs text-gray-400">æ¡ƒåœ’</div></div>
                    </div>
                    <div class="dashed-line"></div>
                    <div class="px-4 pb-4 flex justify-between text-sm">
                        <div class="font-bold text-gray-600 editable-field p-1 rounded" @click="editFlightField('in_dep')">{{getUserById(currentFlightUser).flightInDep || '20:40'}} <span class="text-[10px] font-normal text-gray-400">Depart</span></div>
                        <div class="font-bold text-gray-600 editable-field p-1 rounded" @click="editFlightField('in_arr')">{{getUserById(currentFlightUser).flightInArr || '23:20'}} <span class="text-[10px] font-normal text-gray-400">Arrive</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="['food','shopping','photo'].includes(currentView)" class="px-4 py-2 pb-32 animate-fade-in">
        <div v-if="currentView==='food'" class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar justify-center sticky top-16 bg-[#FFF0F5] z-20 py-2"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="foodLoc=loc" :class="['px-6 py-2 rounded-full text-sm font-bold shadow-sm transition whitespace-nowrap',foodLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400 border border-gray-100']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc]}}</button></div>
        <div v-if="currentView==='shopping'" class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar justify-center"><button v-for="cat in ['wish','cosme','ldk','souvenir']" @click="shopCat=cat" :class="['px-5 py-2 rounded-full text-sm font-bold shadow-sm transition whitespace-nowrap',shopCat===cat?'bg-pink-400 text-white':'bg-white text-gray-400 border border-gray-100']">{{{'wish':'æˆ‘çš„é¡˜æœ›','cosme':'è—¥å¦','ldk':'LDK','souvenir':'ä¼´æ‰‹ç¦®'}[cat]}}</button></div>
        <div v-if="currentView==='photo'" class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar justify-center"><button v-for="area in ['Tokyo','Kamakura','Fuji']" @click="photoArea=area" :class="['px-6 py-2 rounded-full text-sm font-bold shadow-sm transition whitespace-nowrap',photoArea===area?'bg-rose-400 text-white':'bg-white text-gray-400 border border-gray-100']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[area]}}</button></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div v-for="(item,idx) in getCurrentList()" :key="item.id||idx" class="card overflow-hidden hover:shadow-lg transition group">
                <div class="h-56 relative bg-gray-100 cursor-pointer" @click="openImage(item.img)">
                    <img :src="item.img" class="w-full h-full object-cover watercolor-img" @error="handleImgError">
                    <div class="absolute top-2 right-2 flex gap-2"><button @click.stop="editCommonItem(item,idx)" class="w-8 h-8 bg-white/90 rounded-full flex items-center justify-center shadow text-blue-400"><i class="fa-solid fa-pen"></i></button><button @click.stop="deleteCommonItem(idx)" class="w-8 h-8 bg-white/90 rounded-full flex items-center justify-center shadow text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                </div>
                <div class="p-5"><h3 class="font-bold text-xl text-gray-800 mb-1">{{item.name}}</h3><p class="text-sm text-gray-500 mb-4 leading-relaxed">{{item.desc}}</p><a v-if="item.link" :href="item.link" target="_blank" class="block text-center bg-blue-500 text-white py-2.5 rounded-xl font-bold text-sm shadow-sm hover:bg-blue-600 transition">{{ currentView === 'shopping' ? 'å‰å¾€å®˜æ–¹ç¶²ç«™' : 'é€£çµ / å°èˆª' }}</a></div>
            </div>
        </div>
        <button @click="openAddCommonModal(currentView)" class="fab-main hover:scale-110"><i class="fa-solid fa-plus"></i></button>
    </div>

    <div v-if="['money','prep','weather','japanese'].includes(currentView)" class="px-4 py-2 pb-32 animate-fade-in">
        <div v-if="currentView==='money'">
             <div class="flex justify-between items-center mb-4 sticky top-16 bg-[#FFF0F5] z-20 py-2"><div class="flex bg-white rounded-xl p-1 shadow-sm"><button @click="moneyTab='record'" :class="['px-4 py-1.5 rounded-lg text-sm font-bold transition',moneyTab==='record'?'bg-yellow-200 text-yellow-800':'text-gray-400']">è¨˜å¸³</button><button @click="moneyTab='split'" :class="['px-4 py-1.5 rounded-lg text-sm font-bold transition',moneyTab==='split'?'bg-blue-200 text-blue-800':'text-gray-400']">åˆ†å¸³</button></div><div class="text-xs font-bold text-gray-500 bg-white px-3 py-1 rounded-full border">åŒ¯ç‡: {{exchangeRate}}</div></div>
             <div v-if="moneyTab==='record' && moneyMode==='select'" class="grid grid-cols-2 gap-4"><div v-for="user in users" :key="user.id" class="card p-4 text-center cursor-pointer hover:-translate-y-1 transition relative group" @click="selectMoneyUser(user.id)"><div class="w-16 h-16 mx-auto rounded-full bg-gray-100 overflow-hidden mb-2 text-3xl flex items-center justify-center border-4 border-white shadow"><img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover"><span v-else>{{user.icon}}</span></div><div class="font-bold text-gray-700">{{user.name}}</div></div></div>
             <div v-if="moneyTab==='record' && moneyMode==='list'"><div class="flex justify-between items-center mb-3 px-1"><h3 class="font-bold text-gray-700 flex items-center gap-2">{{getUserById(currentUserId).name}} çš„å¸³æœ¬</h3><button @click="moneyMode='select'" class="text-xs bg-white px-3 py-1 rounded shadow text-gray-500">åˆ‡æ›</button></div><div class="card p-4 mb-4 bg-gradient-to-r from-yellow-50 to-orange-50 border-yellow-200 border relative overflow-hidden"><div class="text-xs text-yellow-600 font-bold mb-1">å€‹äººç¸½æ”¯å‡º</div><div class="text-2xl font-black text-gray-800">Â¥{{Number(userPersonalTotal).toLocaleString()}}</div></div><div class="space-y-3"><div v-for="exp in personalExpenses" :key="exp.id" class="card p-3 flex justify-between items-center"><div><div class="font-bold text-gray-800 text-sm">{{exp.name}}</div><div class="text-[10px] text-gray-400">{{exp.date}}</div></div><div class="text-right font-bold text-gray-800">Â¥{{Number(exp.amount).toLocaleString()}}<button @click="deleteExpense(exp.id)" class="text-red-300 ml-2 text-xs"><i class="fa-solid fa-trash"></i></button></div></div></div><button @click="openExpenseModal('personal')" class="fab-main bg-yellow-400 text-gray-800 hover:bg-yellow-300"><i class="fa-solid fa-pen"></i></button></div>
             <div v-if="moneyTab==='split'"><div class="card p-4 border-l-4 border-blue-400 mb-4"><h3 class="font-bold mb-2 flex gap-2 items-center"><i class="fa-solid fa-calculator text-blue-400"></i> åˆ†å¸³çµæœ</h3><div v-if="settlements.length===0" class="text-sm text-gray-400 text-center py-4">ç„¡é ˆåˆ†å¸³</div><div v-for="s in settlements" class="flex justify-between text-sm py-2 border-b border-gray-100 last:border-0"><span>{{getUserById(s.from).name}} <i class="fa-solid fa-arrow-right text-xs text-gray-300 mx-1"></i> {{getUserById(s.to).name}}</span><span class="font-bold text-gray-800">Â¥{{s.amount.toLocaleString()}}</span></div></div><div class="text-sm font-bold text-gray-500 mb-2 ml-1">å…¬å¸³æ˜ç´°</div><div class="space-y-2"><div v-for="exp in groupExpenses" :key="exp.id" class="bg-white p-3 rounded-lg border flex justify-between"><div><div class="font-bold text-sm text-gray-700">{{exp.name}}</div><div class="text-[10px] text-blue-400">{{getUserById(exp.user).name}} å…ˆä»˜</div></div><div class="text-right font-bold text-gray-800">Â¥{{Number(exp.amount).toLocaleString()}}<button @click="deleteExpense(exp.id)" class="text-red-300 ml-2"><i class="fa-solid fa-trash"></i></button></div></div></div><button @click="openExpenseModal('group')" class="fab-main bg-blue-400 text-white hover:bg-blue-500"><i class="fa-solid fa-users"></i></button></div>
        </div>
        <div v-if="currentView==='prep'">
             <div class="flex gap-2 mb-4 justify-center sticky top-16 bg-[#FFF0F5] z-20 py-2"><button @click="prepTab='personal'" :class="['px-6 py-2 rounded-full font-bold whitespace-nowrap shadow-sm transition',prepTab==='personal'?'bg-pink-400 text-white':'bg-white text-gray-400']">å€‹äººæº–å‚™</button><button @click="prepTab='car'" :class="['px-6 py-2 rounded-full font-bold whitespace-nowrap shadow-sm transition',prepTab==='car'?'bg-green-400 text-white':'bg-white text-gray-400']">ç§Ÿè»Š</button></div>
             <div v-if="prepTab==='personal' && prepMode==='select'" class="grid grid-cols-2 gap-4"><div v-for="user in users" :key="user.id" class="card p-4 cursor-pointer hover:bg-pink-50 transition relative group" @click="selectPrepUser(user.id)"><div class="flex justify-between items-center mb-2"><div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl overflow-hidden border border-white shadow-sm"><img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover"><span v-else>{{user.icon}}</span></div><div class="font-bold text-gray-700">{{user.name}}</div></div><div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden"><div class="h-full bg-pink-400 transition-all duration-500" :style="{width: getProgress(user.id)+'%', backgroundColor: user.bg}"></div></div><div class="text-right text-[10px] text-gray-400 mt-1">{{Math.round(getProgress(user.id))}}%</div></div></div>
             <div v-if="prepTab==='personal' && prepMode==='list'"><div class="flex justify-between items-center mb-4 px-1"><h3 class="font-bold text-xl text-gray-700 flex items-center gap-2">{{getUserById(prepUser).name}} çš„æ¸…å–®</h3><button @click="prepMode='select'" class="bg-white px-3 py-1.5 rounded-full shadow text-xs font-bold text-gray-500 border">è¿”å›</button></div><div class="card p-5 min-h-[300px] mb-20"><div v-for="(item,idx) in currentPrepList" :key="idx" class="flex items-center gap-3 py-3 border-b border-dashed border-gray-200"><input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-400 rounded cursor-pointer"><input v-model="item.text" class="flex-1 text-sm bg-transparent outline-none font-medium" :class="{'line-through text-gray-300':item.checked}"><button @click="currentPrepList.splice(idx,1)" class="ml-auto text-gray-300 p-2"><i class="fa-solid fa-xmark"></i></button></div><button @click="addPrepItem" class="w-full mt-6 py-3 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 font-bold hover:bg-gray-50 transition text-sm">+ æ–°å¢é …ç›®</button></div></div>
             <div v-if="prepTab==='car'" class="card p-5 border-l-4 border-green-400 animate-fade-in"><h3 class="font-bold text-lg mb-2 text-gray-700">è‡ªé§•æ¨è–¦</h3><div class="grid gap-2 text-sm font-bold"><a href="https://www2.tocoo.jp/cn" target="_blank" class="block bg-gray-50 p-3 rounded-lg text-gray-700 hover:bg-green-50 flex justify-between"><span>ğŸš— ToCoo! æ¯”åƒ¹</span><i class="fa-solid fa-chevron-right text-gray-300"></i></a><a href="https://rent.toyota.co.jp/zh-tw/" target="_blank" class="block bg-gray-50 p-3 rounded-lg text-gray-700 hover:bg-green-50 flex justify-between"><span>ğŸš™ Toyota Rent a Car</span><i class="fa-solid fa-chevron-right text-gray-300"></i></a></div></div>
        </div>
        <div v-if="currentView==='weather'">
             <div class="mb-4 bg-white/95 p-4 rounded-3xl box-shadow border border-pink-200 flex items-center justify-between animate-fade-in"><div class="flex items-center gap-3"><div class="text-3xl">ğŸŒ¸</div><div><div class="text-[10px] text-gray-400 font-bold uppercase">Sakura Forecast</div><div class="text-lg font-bold text-pink-500">{{sakuraStatus}}</div></div></div><div class="flex flex-col gap-1 text-right"><a href="https://n-kishou.com/corp/news-contents/sakura/" target="_blank" class="text-[10px] bg-pink-100 text-pink-600 px-3 py-1 rounded-full font-bold hover:bg-pink-200">æ°£è±¡æ ªå¼æœƒç¤¾</a></div></div>
             <div class="space-y-4 animate-fade-in"><div v-for="w in [{t:'æ±äº¬',d:tokyoWeather},{t:'éŒå€‰',d:kamakuraWeather},{t:'å¯Œå£«å±±',d:fujiWeather}]" class="card p-5 border-l-4 border-sky-400"><div class="flex justify-between items-center mb-2"><div><div class="font-bold text-gray-500 text-xs">{{w.t}}</div><div class="text-4xl font-black text-gray-800 tracking-tighter">{{w.d.temp}}Â°</div></div><div class="text-4xl drop-shadow-sm">{{w.d.icon}}</div></div></div></div>
        </div>
        <div v-if="currentView==='japanese'">
             <button @click="openCamera" class="w-full bg-gradient-to-r from-emerald-500 to-green-400 rounded-3xl p-6 text-white text-center mb-6 shadow-xl relative overflow-hidden active:scale-95 transition group"><i class="fa-solid fa-camera text-8xl absolute -right-6 -bottom-6 opacity-20 rotate-12"></i><h3 class="font-bold text-2xl mb-2">ğŸ“¸ é–‹å•Ÿæ‡¸æµ®é¡é ­</h3><p class="text-sm opacity-90 font-medium">ç›´æ¥æ‹ç…§ç¿»è­¯</p></button>
             <div class="space-y-3"><div v-for="(phrase,idx) in japanesePhrases" :key="idx" @click="speak(phrase.jp)" class="card p-5 flex items-center justify-between cursor-pointer active:scale-95 transition border-l-[6px] border-emerald-400"><div><div class="font-bold text-xl text-gray-800 mb-1">{{phrase.jp}}</div><div class="text-sm text-gray-500 font-medium">{{phrase.tw}}</div></div><div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-500 text-xl shadow-inner"><i class="fa-solid fa-volume-high"></i></div><button @click.stop="japanesePhrases.splice(idx,1)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400 p-2"><i class="fa-solid fa-trash"></i></button></div></div>
             <button @click="openAddCommonModal('jp')" class="fab-main bg-emerald-500 hover:bg-emerald-600"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <div v-show="currentView !== 'menu'" class="fab-home touch-none" :style="{top: homeBtnPos.y+'px', left: homeBtnPos.x+'px'}" @click="currentView='menu'" @touchstart.prevent="startDrag($event, 'home')" @mousedown.prevent="startDrag($event, 'home')">
        <i class="fa-solid fa-house"></i>
    </div>

    <div v-if="showLightbox" class="fixed inset-0 z-[100] bg-white/95 backdrop-blur flex items-center justify-center p-4 animate-fade-in" @click="showLightbox=false"><img :src="currentZoomImg" class="max-w-full max-h-[80vh] rounded-2xl shadow-2xl border-4 border-white" @click.stop><button class="absolute top-6 right-6 text-gray-400 hover:text-gray-800 text-4xl"><i class="fa-solid fa-circle-xmark"></i></button></div>
    <div v-if="showModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-center">{{isEditing?'ç·¨è¼¯':'æ–°å¢'}}</h3><input v-model="editForm.name" placeholder="åç¨±" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border"><div class="flex gap-2 mb-3"><input v-model="editForm.hours" placeholder="æ™‚é–“" class="w-1/3 p-3 bg-gray-50 rounded-xl outline-none border"><select v-model="editForm.category" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none border"><option value="Sightseeing">æ™¯é»</option><option value="Food">ç¾é£Ÿ</option><option value="Shopping">è³¼ç‰©</option><option value="Transport">äº¤é€š</option></select></div><input v-model="editForm.mapKeyword" placeholder="åœ°åœ–é—œéµå­—" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border"><textarea v-model="editForm.note" class="w-full p-3 bg-gray-50 rounded-xl h-24 mb-4 outline-none border resize-none" placeholder="å‚™è¨»"></textarea><div class="flex gap-3"><button @click="showModal=false" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="saveItem" class="flex-1 bg-pink-400 text-white py-3 rounded-xl font-bold shadow-md">å„²å­˜</button></div></div></div>
    <div v-if="showCommonModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-center">{{isEditing?'ç·¨è¼¯':'æ–°å¢'}}</h3><input v-model="newCommon.text1" placeholder="åç¨±/æ—¥æ–‡" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border"><textarea v-if="commonType!=='jp'" v-model="newCommon.text2" class="w-full p-3 bg-gray-50 rounded-xl h-24 mb-3 outline-none border resize-none" placeholder="æè¿°"></textarea><input v-else v-model="newCommon.text2" placeholder="ä¸­æ–‡ç¿»è­¯" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border"><div v-if="commonType!=='jp'" class="flex items-center gap-3 mb-4"><div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center border overflow-hidden"><img v-if="newCommon.text3" :src="newCommon.text3" class="w-full h-full object-cover"><i v-else class="fa-solid fa-image text-gray-300"></i></div><button @click="$refs.commonImageInput.click()" class="text-xs bg-blue-50 text-blue-500 px-3 py-2 rounded-lg font-bold border border-blue-100">ä¸Šå‚³åœ–ç‰‡</button></div><div class="flex gap-3"><button @click="showCommonModal=false" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="saveCommonItem" class="flex-1 bg-blue-400 text-white py-3 rounded-xl font-bold shadow-md">å„²å­˜</button></div></div></div>
    <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-center">è¨˜å¸³</h3><input v-model="newExpense.name" placeholder="é …ç›®" class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border"><div class="flex gap-2 mb-3"><input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none border"><select v-model="newExpense.currency" class="w-24 p-3 bg-gray-50 rounded-xl outline-none border font-bold text-gray-600"><option value="JPY">JPY</option><option value="TWD">TWD</option></select></div><div class="mb-3"><label class="text-xs text-gray-400 font-bold ml-1">{{expenseType==='group'?'èª°å…ˆå¢Šä»˜?':'èª°èŠ±çš„?'}}</label><div class="flex gap-2 mt-1 overflow-x-auto pb-1"><button v-for="u in users" :key="u.id" @click="currentUserId=u.id" :class="['px-3 py-1 rounded-full text-xs font-bold border transition',currentUserId===u.id?'bg-yellow-100 border-yellow-300 text-yellow-700':'bg-white border-gray-200 text-gray-400']">{{u.name}}</button></div></div><div class="flex gap-3"><button @click="showExpenseModal=false" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="addExpense" class="flex-1 bg-yellow-400 text-gray-800 py-3 rounded-xl font-bold shadow-md">å„²å­˜</button></div></div></div>
    <div v-if="showUserModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center"><h3 class="font-bold text-lg mb-4">ç·¨è¼¯æˆå“¡è³‡æ–™</h3><div class="w-24 h-24 mx-auto bg-gray-100 rounded-full mb-4 relative border-4 border-white shadow overflow-hidden" @click="triggerAvatarUpload"><img v-if="editingUser.avatar" :src="editingUser.avatar" class="w-full h-full object-cover"><div v-else class="w-full h-full flex items-center justify-center text-4xl">{{editingUser.icon}}</div></div><input v-model="editingUser.name" class="w-full p-3 bg-gray-50 rounded-xl mb-4 text-center font-bold outline-none border focus:border-pink-300" placeholder="åå­—"><div class="flex gap-3"><button @click="showUserModal=false" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="saveUserEdit" class="flex-1 bg-pink-400 text-white py-3 rounded-xl font-bold shadow-md">å„²å­˜</button></div></div></div>
    <div v-if="showSyncModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative"><button @click="showSyncModal=false" class="absolute top-4 right-4 text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button><h3 class="font-bold text-xl mb-2 text-center text-chii-text">ğŸ“‚ è¨­å®š</h3><p class="text-xs text-gray-400 text-center mb-6">å„²å­˜ HTML å¯ä¿ç•™æ‰€æœ‰åœ–ç‰‡èˆ‡è³‡æ–™</p><button @click="saveAsHtml" class="w-full py-3 bg-gradient-to-r from-pink-400 to-rose-400 text-white rounded-xl font-bold mb-3 flex items-center justify-center gap-2 shadow-md active:scale-95 transition"><i class="fa-solid fa-file-code"></i> å„²å­˜ç‚ºç¶²é æª”</button><hr class="border-gray-100 my-3"><button @click="resetItinerary" class="w-full py-3 bg-red-50 text-red-500 rounded-xl font-bold mb-3 flex items-center justify-center gap-2"><i class="fa-solid fa-rotate-right"></i> é‡ç½®æ‰€æœ‰è³‡æ–™</button></div></div>
    
    <input type="file" ref="commonImageInput" accept="image/*" class="hidden" @change="processCommonImageUpload">
    <input type="file" ref="avatarInput" accept="image/*" class="hidden" @change="processAvatarUpload">
    <input type="file" ref="cameraInput" accept="image/*" capture="environment" class="hidden">
    
</div>

<script>
const sc = document.getElementById('sakura-container');
for(let i=0; i<15; i++){ const e=document.createElement('div'); e.className='sakura'; e.style.left=Math.random()*100+'vw'; e.style.animationDuration=Math.random()*3+5+'s'; sc.appendChild(e); }
</script>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

createApp({
    setup() {
        const STORAGE_KEY = 'v10_11_complete'; // FORCE NEW KEY to ensure 5-item lists load
        const currentView = ref('menu');
        const isWelcomeClosed = ref(false);
        const welcomeImg = ref('images/welcome.jpg');
        
        // --- å®Œæ•´è³‡æ–™ (å·²è£œé½Š 5+ é …ç›®) ---
        const defaultShopping = {
            wish: [{name:'Chiikawaç©å¶',desc:'åŸå®¿KiddyLandé™å®š',img:'https://placehold.co/200/FFD1DC/555?text=Chiikawa'}, {name:'å¯Œå£«å±±æ¯',desc:'æ˜Ÿå·´å…‹é™å®š',img:'https://placehold.co/200/A2D2FF/555?text=Cup'}, {name:'Le Laboé¦™æ°´',desc:'ä»£å®˜å±±åº—',img:'https://placehold.co/200/EEE/555?text=LeLabo'}, {name:'PorteråŒ…',desc:'å‰ç”°åŒ…',img:'https://placehold.co/200/333/FFF?text=Porter'}, {name:'Blue Bottleè±†',desc:'æ¸…æ¾„ç™½æ²³',img:'https://placehold.co/200/FFF/333?text=Coffee'}],
            cosme: [{name:'Tirtirç´…ç›’æ°£å¢Š',desc:'é®ç‘•åŠ›å¼·',img:'https://placehold.co/200/FF0000/FFF?text=Tirtir'}, {name:'Kateæ€ªç¸å”‡è†',desc:'è‰²è™Ÿ:03/05',img:'https://placehold.co/200/000/FFF?text=Kate'}, {name:'&Honeyé«®æ²¹',desc:'ä¿æ¿•ä¿®è­·',img:'https://placehold.co/200/FFD700/FFF?text=Honey'}, {name:'Canmakeèœœç²‰',desc:'æ£‰èŠ±ç³–èœœç²‰',img:'https://placehold.co/200/FFC0CB/555?text=Canmake'}, {name:'Melano CC',desc:'ç¾ç™½ç²¾è¯',img:'https://placehold.co/200/FFA500/FFF?text=CC'}],
            ldk: [{name:'Lululuné¢è†œ',desc:'åœ°å€é™å®šç‰ˆ',img:'https://placehold.co/200/FF69B4/FFF?text=Mask'}, {name:'Finoé«®è†œ',desc:'é«˜CPå€¼',img:'https://placehold.co/200/C0C0C0/000?text=Fino'}, {name:'Excelçœ‰ç­†',desc:'æ–°æ‰‹å‹å–„',img:'https://placehold.co/200/8B4513/FFF?text=Excel'}, {name:'Bioreé˜²æ›¬',desc:'æ°´æ„Ÿé˜²æ›¬',img:'https://placehold.co/200/87CEEB/FFF?text=Biore'}, {name:'Niveaè—ç½',desc:'è¬ç”¨ä¿æ¿•',img:'https://placehold.co/200/00008B/FFF?text=Nivea'}],
            souvenir: [{name:'NY Cheese',desc:'æ±äº¬ç«™æ’éšŠ',img:'https://placehold.co/200/FFA500/FFF?text=NY'}, {name:'Tokyo Banana',desc:'ç¶“å…¸ä¸æ•—',img:'https://placehold.co/200/FFFF00/000?text=Banana'}, {name:'Press Butter Sand',desc:'ç„¦ç³–å¥¶æ²¹',img:'https://placehold.co/200/A52A2A/FFF?text=Sand'}, {name:'Sugar Butter Tree',desc:'ç ‚ç³–å¥¶æ²¹æ¨¹',img:'https://placehold.co/200/FFFACD/555?text=Tree'}, {name:'å°é›é¥…é ­',desc:'Hiyoko',img:'https://placehold.co/200/FFFFE0/555?text=Hiyoko'}]
        };
        const defaultFood = {
            Tokyo: [{name:'AFURIæ‹‰éºµ',desc:'æŸšå­é¹½å‘³',img:'https://placehold.co/200/FFD700/000?text=AFURI'}, {name:'HARBS',desc:'æ°´æœåƒå±¤',img:'https://placehold.co/200/FFFACD/555?text=HARBS'}, {name:'ç‰›å¡æ»‹',desc:'ç‚¸ç‰›æ’',img:'https://placehold.co/200/8B0000/FFF?text=Beef'}, {name:'å…­å˜èˆ',desc:'æ²¾éºµ',img:'https://placehold.co/200/A52A2A/FFF?text=Ramen'}, {name:'Shake Shack',desc:'æ˜æ²»ç¥å®®å¤–è‹‘',img:'https://placehold.co/200/006400/FFF?text=Burger'}],
            Kamakura: [{name:'Bills',desc:'ä¸–ç•Œç¬¬ä¸€æ—©é¤',img:'https://placehold.co/200/FFF/000?text=Bills'}, {name:'Pacific Drive-In',desc:'æµ·æ™¯å’–å•¡',img:'https://placehold.co/200/87CEFA/FFF?text=DriveIn'}, {name:'Caraway',desc:'æ’éšŠå’–å“©',img:'https://placehold.co/200/8B4513/FFF?text=Curry'}, {name:'å»ä»”é­šä¸¼',desc:'æ±Ÿä¹‹å³¶åç”¢',img:'https://placehold.co/200/F0F8FF/000?text=Fish'}, {name:'è±å³¶å±‹',desc:'é´¿å­é¤…ä¹¾',img:'https://placehold.co/200/FFFFF0/555?text=Cookie'}],
            Fuji: [{name:'Houtou Fudou',desc:'ä¸å‹•èŒ¶å±‹',img:'https://placehold.co/200/FFF/000?text=Noodle'}, {name:'å¯Œå£«å¤©å©¦ç¾…',desc:'Idaten',img:'https://placehold.co/200/FFA500/FFF?text=Tempura'}, {name:'Lake Bake',desc:'æ¹–ç•”éºµåŒ…',img:'https://placehold.co/200/8B4513/FFF?text=Bread'}, {name:'Shaw s Sushi',desc:'å£½å¸',img:'https://placehold.co/200/FA8072/FFF?text=Sushi'}, {name:'7-11æ²³å£æ¹–',desc:'ä¾¿åˆ©å•†åº—',img:'https://placehold.co/200/008000/FFF?text=711'}]
        };
        const defaultPhoto = {
            Tokyo: [{name:'SHIBUYA SKY',desc:'é«˜ç©ºå±•æœ›',img:'https://placehold.co/200/87CEEB/FFF?text=SKY'}, {name:'æ±äº¬éµå¡”',desc:'èŠå…¬åœ’',img:'https://placehold.co/200/FF0000/FFF?text=Tower'}, {name:'è±ªå¾·å¯º',desc:'æ‹›è²¡è²“',img:'https://placehold.co/200/FFF/000?text=Cat'}, {name:'æ·ºè‰é›·é–€',desc:'ç¶“å…¸åœ°æ¨™',img:'https://placehold.co/200/FF4500/FFF?text=Gate'}, {name:'TeamLab',desc:'è±æ´²',img:'https://placehold.co/200/000/FFF?text=Lab'}],
            Kamakura: [{name:'éŒå€‰é«˜æ ¡å‰',desc:'çŒç±ƒé«˜æ‰‹',img:'https://placehold.co/200/00BFFF/FFF?text=SlamDunk'}, {name:'é•·è°·å¯º',desc:'ç´«é™½èŠ±',img:'https://placehold.co/200/9370DB/FFF?text=Flower'}, {name:'é«˜å¾—é™¢',desc:'å¤§ä½›',img:'https://placehold.co/200/808080/FFF?text=Buddha'}, {name:'å ±åœ‹å¯º',desc:'ç«¹æ—',img:'https://placehold.co/200/228B22/FFF?text=Bamboo'}, {name:'ä¸ƒé‡Œæ¿±',desc:'æµ·å²¸ç·š',img:'https://placehold.co/200/1E90FF/FFF?text=Beach'}],
            Fuji: [{name:'æ–°å€‰å±±æ·ºé–“å…¬åœ’',desc:'äº”é‡å¡”+å¯Œå£«å±±',img:'https://placehold.co/200/FF6347/FFF?text=Pagoda'}, {name:'ç¾…æ£®æ²³å£æ¹–',desc:'ä¾¿åˆ©åº—æ™¯',img:'https://placehold.co/200/0000CD/FFF?text=Lawson'}, {name:'å¤§çŸ³å…¬åœ’',desc:'èŠ±æµ·',img:'https://placehold.co/200/FF69B4/FFF?text=Park'}, {name:'æœ¬ç”ºå•†åº—è¡—',desc:'æ˜­å’Œè¡—é“',img:'https://placehold.co/200/696969/FFF?text=Street'}, {name:'å±±ä¸­æ¹–å¤©éµ',desc:'ç™½é³¥ä¹‹æ¿±',img:'https://placehold.co/200/F0F8FF/000?text=Swan'}]
        };

        const defaultItinerary = [
            [{id:101,category:'Flight',name:'06:40 æ¡ƒåœ’èµ·é£›',hours:'06:40',mapKeyword:'æ¡ƒåœ’æ©Ÿå ´',note:'ææ—©2å°æ™‚æŠµé”'},{id:102,category:'Flight',name:'10:40 æŠµé”æˆç”°æ©Ÿå ´',hours:'10:40',mapKeyword:'æˆç”°æ©Ÿå ´',note:'å‡ºé—œ/é ˜è»Š/è²·ç¥¨'},{id:103,category:'Sightseeing',name:'æ™´ç©ºå¡”',hours:'ä¸‹åˆ',mapKeyword:'Tokyo Skytree',note:'é€› Solamachi'},{id:104,category:'Food',name:'æ™šé¤ï¼šéŒ¦ç³¸ç”ºå‘¨é­',hours:'æ™šä¸Š',mapKeyword:'éŒ¦ç³¸ç”ºç¾é£Ÿ',note:''}],
            [{id:201,category:'Sightseeing',name:'æ·ºè‰å¯º',hours:'ä¸Šåˆ',mapKeyword:'æ·ºè‰å¯º',note:'é›·é–€'},{id:202,category:'Food',name:'åˆé¤ï¼šæ·ºè‰å¯ºå‘¨é­',hours:'ä¸­åˆ',mapKeyword:'æ·ºè‰åˆé¤',note:''},{id:203,category:'Sightseeing',name:'å°ç¶²ç¥ç¤¾',hours:'ä¸‹åˆ',mapKeyword:'å°ç¶²ç¥ç¤¾',note:'å¼·é‹å„é™¤'},{id:204,category:'Sightseeing',name:'ä¸Šé‡æ©è³œå…¬åœ’',hours:'ä¸‹åˆ',mapKeyword:'ä¸Šé‡æ©è³œå…¬åœ’',note:''},{id:205,category:'Shopping',name:'ç§‹è‘‰åŸ / æ±äº¬ä¸€ç•ªè¡—',hours:'æ™šä¸Š',mapKeyword:'æ±äº¬ç«™ä¸€ç•ªè¡—',note:'ä¾é«”åŠ›æ±ºå®š'},{id:206,category:'Food',name:'æ™šé¤',hours:'æ™šä¸Š',mapKeyword:'æ±äº¬è»Šç«™ç¾é£Ÿ',note:'ä¾é€›è¡—åœ°é»æ±ºå®š'}],
            [{id:301,category:'Transport',name:'å‰å¾€å¯Œå£«å±± (ç§Ÿè»Š)',hours:'ä¸Šåˆ',mapKeyword:'æ²³å£æ¹–',note:'éŒ¦ç³¸ç”ºå‡ºç™¼ï¼Œ3å¤©2å¤œè‡ªé§•é–‹å§‹'},{id:302,category:'Sightseeing',name:'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨',hours:'ä¸‹åˆ',mapKeyword:'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨',note:'å¤§çŸ³å…¬åœ’'},{id:303,category:'Sightseeing',name:'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾',hours:'ä¸‹åˆ',mapKeyword:'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾',note:'çˆ¬æ¨“æ¢¯çœ‹äº”é‡å¡”'},{id:304,category:'Sightseeing',name:'é‡‘é³¥å±… & æœ¬ç”ºå•†åº—è¡—',hours:'å‚æ™š',mapKeyword:'å¯Œå£«å‰ç”°æœ¬ç”ºé€šã‚Š',note:'æ‹è¡—æ™¯'},{id:305,category:'Food',name:'æ™šé¤',hours:'æ™šä¸Š',mapKeyword:'å¯Œå£«å‰ç”°ç¾é£Ÿ',note:'è‡ªç‚Šæˆ–å¤–é£Ÿ'}],
            [{id:401,category:'Sightseeing',name:'å¹³é‡ä¹‹æ¿±æ—¥å‡º',hours:'æ¸…æ™¨',mapKeyword:'å¹³é‡ä¹‹æ¿±',note:'é€†å¯Œå£«'},{id:402,category:'Sightseeing',name:'é•·æ± è¦ªæ°´å…¬åœ’ & ç™½é³¥æ¿±',hours:'ä¸Šåˆ',mapKeyword:'é•·æ± è¦ªæ°´å…¬åœ’',note:'ç§Ÿè‡ªè¡Œè»ŠéŠæ¹–'},{id:403,category:'Food',name:'åˆé¤ï¼šå±±ä¸­æ¹–',hours:'ä¸­åˆ',mapKeyword:'å±±ä¸­æ¹–åˆé¤',note:''},{id:404,category:'Sightseeing',name:'KABA æ°´é™¸å·´å£«',hours:'ä¸‹åˆ',mapKeyword:'å±±ä¸­æ¹–KABA',note:'æ—­æ—¥ä¸˜æ¹–ç•”'},{id:405,category:'Shopping',name:'Ogino è¶…å¸‚',hours:'å‚æ™š',mapKeyword:'Ogino æ²³å£æ¹–åº—',note:'è²·æ™šé¤é£Ÿæ'}],
            [{id:501,category:'Sightseeing',name:'é‡‘é³¥å±… / çºœè»Š / é¦éŸ†',hours:'æ—©ä¸Š',mapKeyword:'æ²³å£æ¹–å¯Œå£«å±±å…¨æ™¯çºœè»Š',note:'çµ•æ™¯é¦éŸ†'},{id:502,category:'Shopping',name:'Fujisan Shokupan',hours:'ä¸­åˆ',mapKeyword:'Fujisan Shokupan',note:'è²·ä¼´æ‰‹ç¦®'},{id:503,category:'Transport',name:'æ­å¯Œå£«å›éŠè¿”æ–°å®¿',hours:'ä¸‹åˆ',mapKeyword:'æ–°å®¿ç«™',note:'é‚„è»Šå¾Œæ­è»Š'},{id:504,category:'Shopping',name:'æ± è¢‹å¤ªé™½åŸ',hours:'æ™šä¸Š',mapKeyword:'æ± è¢‹å¤ªé™½åŸ',note:'æ”¾è¡Œæå¾Œå‰å¾€'},{id:505,category:'Food',name:'æ™šé¤ï¼šå¤ªé™½åŸå…§',hours:'æ™šä¸Š',mapKeyword:'æ± è¢‹å¤ªé™½åŸç¾é£Ÿ',note:''}],
            [{id:601,category:'Transport',name:'å‰å¾€è—¤æ¾¤ (æ±Ÿä¹‹é›»)',hours:'ä¸Šåˆ',mapKeyword:'è—¤æ¾¤ç«™',note:'éŒå€‰ä¸€æ—¥éŠ'},{id:602,category:'Sightseeing',name:'æ±Ÿä¹‹å³¶ / éŒå€‰é«˜æ ¡å‰',hours:'ä¸Šåˆ',mapKeyword:'æ±Ÿä¹‹å³¶',note:''},{id:603,category:'Sightseeing',name:'ä¸ƒé‡Œæ¿± / éŒå€‰',hours:'ä¸‹åˆ',mapKeyword:'éŒå€‰å°ç”ºé€š',note:''},{id:604,category:'Food',name:'åˆé¤ï¼šä¸ƒé‡Œæ¿±',hours:'ä¸­åˆ',mapKeyword:'ä¸ƒé‡Œæ¿±ç¾é£Ÿ',note:''},{id:605,category:'Transport',name:'è¿”å›æ–°å®¿',hours:'å‚æ™š',mapKeyword:'æ–°å®¿ç«™',note:''},{id:606,category:'Food',name:'æ™šé¤',hours:'æ™šä¸Š',mapKeyword:'æ–°å®¿ç¾é£Ÿ',note:'å¤–é£Ÿæˆ–è‡ªç‚Š'}],
            [{id:701,category:'Sightseeing',name:'æ±äº¬éµå¡”',hours:'ä¸Šåˆ',mapKeyword:'èŠå…¬åœ’',note:'æ‹ç…§'},{id:702,category:'Sightseeing',name:'å…­æœ¬æœ¨ / éº»å¸ƒå°',hours:'ä¸­åˆ',mapKeyword:'éº»å¸ƒå°ä¹‹ä¸˜',note:''},{id:703,category:'Food',name:'åˆé¤ï¼šå…­æœ¬æœ¨å‘¨é­',hours:'ä¸­åˆ',mapKeyword:'å…­æœ¬æœ¨ç¾é£Ÿ',note:''},{id:704,category:'Sightseeing',name:'æ¾€è°· / SHIBUYA SKY',hours:'ä¸‹åˆ',mapKeyword:'SHIBUYA SKY',note:'å‚æ™šçœ‹å¤•é™½'},{id:705,category:'Shopping',name:'æ¾€è°·åå­—è·¯å£ / æ¡è²·',hours:'æ™šä¸Š',mapKeyword:'æ¾€è°·åå­—è·¯å£',note:'æœ€å¾Œè£œè²¨'},{id:706,category:'Food',name:'æ™šé¤ï¼šæ¾€è°·',hours:'æ™šä¸Š',mapKeyword:'æ¾€è°·ç¾é£Ÿ',note:''}],
            [{id:801,category:'Sightseeing',name:'è‡ªç”±è¡Œç¨‹',hours:'ç™½å¤©',mapKeyword:'æ±äº¬',note:'æ•´ç†è¡Œæ'},{id:802,category:'Flight',name:'20:40 æˆç”°èµ·é£›',hours:'20:40',mapKeyword:'æˆç”°æ©Ÿå ´',note:'ææ—©æŠµé”'},{id:803,category:'Flight',name:'23:20 æŠµé”æ¡ƒåœ’',hours:'23:20',mapKeyword:'æ¡ƒåœ’æ©Ÿå ´',note:'å¹³å®‰å›å®¶'}]
        ];
        
        const defaultUsers = [
            {id:1,name:'å‰ä¼Š',bg:'#FFD1DC',icon:'ğŸ¹',list:['è­·ç…§'],flightNote:''},
            {id:2,name:'å°å…«',bg:'#A2D2FF',icon:'ğŸ±',list:['è­·ç…§'],flightNote:''},
            {id:3,name:'å…”å…”',bg:'#FFF5BA',icon:'ğŸ°',list:['è­·ç…§'],flightNote:''},
            {id:4,name:'å°æ¡ƒ',bg:'#FFB7B2',icon:'ğŸ‘',list:['è­·ç…§'],flightNote:''}
        ];
        
        const hotels = [
            {name:'éŒ¦ç³¸ç”º Sumida City',days:'Day 1-2',link:'https://www.google.com/maps/search/éŒ¦ç³¸ç”º+é£¯åº—'},
            {name:'Megu Fuji 2021',days:'Day 3-4',link:'https://www.google.com/maps/search/Megu+Fuji+2021'},
            {name:'DOMO Hotel (æ–°å®¿)',days:'Day 5-7',link:'https://www.google.com/maps/search/DOMO+Hotel+Shinjuku'} 
        ];

        const drivePlan = [
            { day: 2, title: 'Day 3: å‰å¾€å¯Œå£«å±±', stops: [{name: 'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨', note: 'å¤§çŸ³å…¬åœ’èŠ±ç”°', location: 'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨', parking: 'å¤§çŸ³å…¬åœ’é§è»Šå ´'},{name: 'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾', note: 'äº”é‡å¡”', location: 'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾', parking: 'æ–°å€‰å±±æµ…é–“å…¬åœ’ é§è»Šå ´'},{name: 'é‡‘é³¥å±…', note: 'å•†åº—è¡—è¡—æ™¯', location: 'é‡‘é³¥å±…', parking: 'å¯Œå£«å±±é§… é§è»Šå ´'}] },
            { day: 3, title: 'Day 4: å±±ä¸­æ¹–', stops: [{name: 'å¹³é‡ä¹‹æ¿±', note: 'é€†å¯Œå£«', location: 'å¹³é‡ã®æµœ', parking: 'å¹³é‡ã®æµœ é§è»Šå ´'},{name: 'é•·æ± è¦ªæ°´å…¬åœ’', note: 'é¨è»ŠéŠæ¹–', location: 'é•·æ± è¦ªæ°´å…¬åœ’', parking: 'é•·æ± è¦ªæ°´å…¬åœ’ é§è»Šå ´'},{name: 'KABA æ°´é™¸å·´å£«', note: 'æ—­æ—¥ä¸˜', location: 'æ—­æ—¥ä¸˜æ¹–ç•”ç·‘åœ°å…¬åœ’', parking: 'æ£®ã®é§… æ—­æ—¥ä¸˜ é§è»Šå ´'}] },
            { day: 4, title: 'Day 5: è¿”ç¨‹', stops: [{name: 'æ²³å£æ¹–çºœè»Š', note: 'å¤©ä¸Šå±±å…¬åœ’', location: 'æ²³å£æ¹–å¯Œå£«å±±å…¨æ™¯çºœè»Š', parking: 'æ²³å£æ¹–ç•”çœŒå–¶é§è»Šå ´'},{name: 'Fujisan Shokupan', note: 'åå¸ä¼´æ‰‹ç¦®', location: 'Fujisan Shokupan', parking: 'Fujisan Shokupan'}] }
        ];

        // Reactive State (Init with defaults)
        const itineraryData = ref(defaultItinerary);
        const users = ref(defaultUsers);
        const expenses = ref([]);
        const daysUntilTrip = ref(0);
        const shoppingList = ref(defaultShopping);
        const foodList = ref(defaultFood);
        const photoSpots = ref(defaultPhoto);
        const japanesePhrases = ref([{jp:'ã™ã¿ã¾ã›ã‚“',tw:'ä¸å¥½æ„æ€'},{jp:'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™',tw:'æˆ‘è¦é€™å€‹'},{jp:'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™',tw:'æˆ‘è¦çµå¸³'},{jp:'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹',tw:'å»æ‰€åœ¨å“ªè£¡'},{jp:'å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã„ã„ã§ã™ã‹',tw:'å¯ä»¥æ‹ç…§å—'}]);
        
        // UI
        const homeBtnPos = ref({x: window.innerWidth/2 - 28, y: window.innerHeight - 100});
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        const showModal = ref(false);
        const showCommonModal = ref(false);
        const showExpenseModal = ref(false);
        const showSyncModal = ref(false);
        const showUserModal = ref(false);
        const isEditing = ref(false);
        const editForm = ref({});
        const newCommon = ref({text1:'',text2:'',text3:''});
        const newExpense = ref({name:'',amount:'',currency:'JPY',category:'é£Ÿ'});
        const commonType = ref('');
        const editIndex = ref(-1);
        const editingUser = ref({});
        const searchQuery = ref('');
        const showLightbox = ref(false);
        const currentZoomImg = ref('');
        const moneyTab = ref('record');
        const moneyMode = ref('select');
        const currentUserId = ref(1);
        const expenseType = ref('personal');
        const prepTab = ref('personal');
        const prepMode = ref('select');
        const prepUser = ref(1);
        const hotelTab = ref('stay');
        const flightMode = ref('select');
        const currentFlightUser = ref(1);
        const foodLoc = ref('Tokyo');
        const shopCat = ref('wish');
        const photoArea = ref('Tokyo');
        
        const tokyoWeather = ref({temp:'--',icon:'â˜ï¸'});
        const kamakuraWeather = ref({temp:'--',icon:'â˜ï¸'});
        const fujiWeather = ref({temp:'--',icon:'â˜ï¸'});
        const sakuraStatus = ref('é æ¸¬ä¸­');
        const exchangeRate = ref(0.22);
        
        const tripDays = [{week:'Day 1',title:'æˆç”°/éŒ¦ç³¸ç”º'},{week:'Day 2',title:'æ·ºè‰/ä¸Šé‡'},{week:'Day 3',title:'å¯Œå£«å±±å‡ºç™¼'},{week:'Day 4',title:'å±±ä¸­æ¹–'},{week:'Day 5',title:'è¿”å›æ–°å®¿'},{week:'Day 6',title:'éŒå€‰'},{week:'Day 7',title:'æ¾€è°·/å…­æœ¬æœ¨'},{week:'Day 8',title:'è¿”ç¨‹'}];
        const apps = [
            {id:1,name:'è¡Œç¨‹è¡¨',icon:'fa-solid fa-map-location-dot',bgClass:'bg-pink-400',view:'itinerary'},
            {id:2,name:'å°è²¡åº«',icon:'fa-solid fa-sack-dollar',bgClass:'bg-yellow-400',view:'money'},
            {id:3,name:'ä½å®¿æ©Ÿç¥¨',icon:'fa-solid fa-plane-arrival',bgClass:'bg-indigo-400',view:'hotel'},
            {id:4,name:'å€‹äººæº–å‚™',icon:'fa-solid fa-suitcase-rolling',bgClass:'bg-blue-400',view:'prep'},
            {id:5,name:'åƒåƒå–å–',icon:'fa-solid fa-utensils',bgClass:'bg-orange-400',view:'food'},
            {id:6,name:'å¿«æ¨‚Shop',icon:'fa-solid fa-bag-shopping',bgClass:'bg-purple-400',view:'shopping'},
            {id:7,name:'å¤©æ°£é€±å ±',icon:'fa-solid fa-cloud-sun',bgClass:'bg-sky-400',view:'weather'},
            {id:8,name:'ç¶²ç¾æ‰“å¡',icon:'fa-solid fa-camera',bgClass:'bg-rose-400',view:'photo'},
            {id:9,name:'å³æ™‚æ•‘å‘½',icon:'fa-solid fa-comment-medical',bgClass:'bg-emerald-400',view:'japanese'}
        ];

        const currentItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
        const getDrivePlanForDay = (idx) => { const p = drivePlan.find(d => d.day === idx); return p ? p.stops : []; };
        const getUserById = (id) => users.value.find(u => u.id === id) || users.value[0];
        const currentPrepList = computed(() => getUserById(prepUser.value).list || []);
        const personalExpenses = computed(() => expenses.value.filter(e => e.user === currentUserId.value && e.type === 'personal'));
        const groupExpenses = computed(() => expenses.value.filter(e => e.type === 'group'));
        const userPersonalTotal = computed(() => personalExpenses.value.reduce((s,e) => s + Number(e.amount), 0));
        const settlements = computed(() => {
            const bal = {}; users.value.forEach(u=>bal[u.id]=0);
            groupExpenses.value.forEach(e=>{ const amt=Number(e.amount); if(bal[e.user]!==undefined) bal[e.user]+=amt; });
            const avg = Object.values(bal).reduce((a,b)=>a+b,0)/users.value.length;
            const net = {}; users.value.forEach(u=>net[u.id]=bal[u.id]-avg);
            const res=[]; const debt=[]; const cred=[];
            for(let id in net) { if(net[id]<-1) debt.push({u:id,a:-net[id]}); else if(net[id]>1) cred.push({u:id,a:net[id]}); }
            let i=0,j=0; while(i<debt.length && j<cred.length){ let amt = Math.min(debt[i].a, cred[j].a); if(amt>0) res.push({from:debt[i].u, to:cred[j].u, amount:Math.round(amt)}); debt[i].a-=amt; cred[j].a-=amt; if(debt[i].a<1) i++; if(cred[j].a<1) j++; } return res;
        });
        const getCurrentList = () => { if(currentView.value==='food') return foodList.value[foodLoc.value]||[]; if(currentView.value==='shopping') return shoppingList.value[shopCat.value]||[]; if(currentView.value==='photo') return photoSpots.value[photoArea.value]||[]; return []; };

        const enterSite = () => { isWelcomeClosed.value = true; };
        const handleWelcomeError = () => { welcomeImg.value = 'https://images.unsplash.com/photo-1522383225653-ed111181a951?auto=format&fit=crop&w=800'; };
        const getPageTitle = (v) => ({'itinerary':'è¡Œç¨‹è¡¨','money':'å°è²¡åº«','menu':'åŠŸèƒ½é¸å–®','prep':'è¡Œå‰æº–å‚™','weather':'å¤©æ°£é€±å ±','food':'åƒåƒå–å–','shopping':'å¿«æ¨‚Shop','photo':'ç¶²ç¾æ‰“å¡','hotel':'ä½å®¿èˆ‡æ©Ÿç¥¨','japanese':'å³æ™‚æ•‘å‘½'}[v] || v);
        const getMapLink = (k) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}`;
        const getIconByCategory = (c) => ({'Flight':'fa-plane','Sightseeing':'fa-camera','Food':'fa-utensils','Shopping':'fa-bag-shopping','Transport':'fa-train'}[c]||'fa-star');
        
        const openAddModal = () => { isEditing.value=false; editForm.value={category:'Sightseeing'}; showModal.value=true; };
        const editItem = (item,idx) => { isEditing.value=true; editIndex.value=idx; editForm.value={...item}; showModal.value=true; };
        const saveItem = () => { if(!itineraryData.value[selectedDayIndex.value]) itineraryData.value[selectedDayIndex.value]=[]; const target = itineraryData.value[selectedDayIndex.value]; if(isEditing.value) Object.assign(target[editIndex.value], editForm.value); else target.push({...editForm.value, id:Date.now()}); showModal.value=false; };
        const deleteItem = (idx) => { if(confirm('ç¢ºå®šåˆªé™¤?')) itineraryData.value[selectedDayIndex.value].splice(idx,1); };
        
        const openAddCommonModal = (t) => { commonType.value=t; isEditing.value=false; newCommon.value={text1:'',text2:'',text3:''}; showCommonModal.value=true; };
        const editCommonItem = (item,idx) => { commonType.value=currentView.value==='japanese'?'jp':currentView.value; isEditing.value=true; editIndex.value=idx; newCommon.value={text1:item.name||item.jp, text2:item.desc||item.tw, text3:item.img}; showCommonModal.value=true; };
        const saveCommonItem = () => { const list = commonType.value==='jp' ? japanesePhrases.value : getCurrentList(); const item = commonType.value==='jp' ? {jp:newCommon.value.text1, tw:newCommon.value.text2} : {name:newCommon.value.text1, desc:newCommon.value.text2, img:newCommon.value.text3, link:getMapLink(newCommon.value.text1)}; if(isEditing.value) Object.assign(list[editIndex.value], item); else list.push(item); showCommonModal.value=false; };
        const deleteCommonItem = (idx) => { if(confirm('ç¢ºå®šåˆªé™¤?')) getCurrentList().splice(idx,1); };
        const processCommonImageUpload = (e) => { const r = new FileReader(); r.onload=ev=>newCommon.value.text3=ev.target.result; r.readAsDataURL(e.target.files[0]); };
        
        const openExpenseModal = (t) => { expenseType.value=t; newExpense.value={amount:'',currency:'JPY',category:'é£Ÿ'}; showExpenseModal.value=true; };
        const addExpense = () => { expenses.value.push({...newExpense.value, id:Date.now(), user:currentUserId.value, type:expenseType.value, date:new Date().toLocaleDateString()}); showExpenseModal.value=false; };
        const deleteExpense = (id) => { expenses.value = expenses.value.filter(e=>e.id!==id); };
        
        const selectMoneyUser = (id) => { currentUserId.value=id; moneyMode.value='list'; };
        const selectPrepUser = (id) => { prepUser.value=id; prepMode.value='list'; };
        const addPrepItem = () => { const t=prompt('é …ç›®åç¨±'); if(t) getUserById(prepUser.value).list.push({text:t,checked:false}); };
        const getProgress = (uid) => { const l=getUserById(uid).list||[]; return l.length ? (l.filter(i=>i.checked).length/l.length)*100 : 0; };
        
        const openUserEdit = (user) => { editingUser.value = {...user}; showUserModal.value = true; };
        const saveUserEdit = () => { const idx = users.value.findIndex(u => u.id === editingUser.value.id); if(idx !== -1) users.value[idx] = {...editingUser.value}; showUserModal.value = false; };
        const processAvatarUpload = (e) => { const r = new FileReader(); r.onload = (ev) => { editingUser.value.avatar = ev.target.result; }; r.readAsDataURL(e.target.files[0]); };
        const triggerAvatarUpload = () => { document.querySelector('input[type=file]').click(); };
        
        const editFlightField = (field) => { const u = getUserById(currentFlightUser.value); const keyMap = {'out_code':'flightOutCode','out_dep':'flightOutDep','out_arr':'flightOutArr','in_code':'flightInCode','in_dep':'flightInDep','in_arr':'flightInArr'}; const val = prompt('è¼¸å…¥è³‡è¨Š', u[keyMap[field]]||''); if(val!==null) u[keyMap[field]] = val; };
        
        const handleImgError = (e) => { e.target.src = 'https://placehold.co/400x300/FFD1DC/555?text=No+Image'; };
        const openImage = (src) => { currentZoomImg.value = src; showLightbox.value = true; };
        const startDrag = (e) => { const el = e.target.closest('.fab-home'); const touch = e.touches ? e.touches[0] : e; const offX = touch.clientX - homeBtnPos.value.x; const offY = touch.clientY - homeBtnPos.value.y; const move = ev => { const t = ev.touches?ev.touches[0]:ev; homeBtnPos.value = {x:t.clientX-offX, y:t.clientY-offY}; }; const stop = () => { document.removeEventListener('touchmove',move); document.removeEventListener('mousemove',move); }; document.addEventListener('touchmove',move); document.addEventListener('mousemove',move); document.addEventListener('touchend',stop); document.addEventListener('mouseup',stop); };
        const getClothingAdvice = (t) => (t<15?'å¤§è¡£+åœå·¾':t<20?'è–„å¤–å¥—':'çŸ­è¢–');
        const speak = (t) => { const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; speechSynthesis.speak(u); };

        const saveAsHtml = () => { const data = { itinerary: itineraryData.value, users: users.value, expenses: expenses.value, shop: shoppingList.value, food: foodList.value, photo: photoSpots.value }; let html = document.documentElement.outerHTML; const inject = `const injectedData = ${JSON.stringify(data)};`; html = html.replace('// --- å®Œæ•´è³‡æ–™', inject + '\n // --- å®Œæ•´è³‡æ–™'); const blob = new Blob([html], {type:'text/html'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = '2026_Kanto_Trip_Complete.html'; a.click(); };
        const resetItinerary = () => { if(confirm('âš ï¸ é€™å°‡å¼·åˆ¶é‡ç½®è³‡æ–™ã€‚ç¢ºå®šå—ï¼Ÿ')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } };

        onMounted(() => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) { 
                try { 
                    const d = JSON.parse(saved); 
                    if(d.itinerary) itineraryData.value = d.itinerary;
                    if(d.users) users.value = d.users;
                    if(d.expenses) expenses.value = d.expenses;
                    if(d.shop) shoppingList.value = d.shop;
                    if(d.food) foodList.value = d.food;
                    if(d.photo) photoSpots.value = d.photo;
                } catch(e) { console.error(e); } 
            }
            daysUntilTrip.value = Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24));
        });

        watch([itineraryData, users, expenses, shoppingList, foodList, photoSpots], () => {
            const data = { itinerary: itineraryData.value, users: users.value, expenses: expenses.value, shop: shoppingList.value, food: foodList.value, photo: photoSpots.value };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }, {deep: true});

        return {
            currentView, isWelcomeClosed, welcomeImg, enterSite, handleWelcomeError, apps, tripDays, selectedDayIndex, itineraryMode, currentItinerary,
            getIconByCategory, getMapLink, getDrivePlanForDay, hotels, homeBtnPos, startDrag, getPageTitle, showSyncModal, 
            showModal, isEditing, editForm, openAddModal, editItem, saveItem, deleteItem,
            showCommonModal, newCommon, commonType, openAddCommonModal, editCommonItem, saveCommonItem, deleteCommonItem, processCommonImageUpload,
            moneyTab, moneyMode, users, currentUserId, expenses, selectMoneyUser, getUserById, userPersonalTotal, personalExpenses, groupExpenses, settlements, openExpenseModal, showExpenseModal, newExpense, addExpense, deleteExpense, exchangeRate, expenseType,
            prepTab, prepMode, prepUser, currentPrepList, selectPrepUser, addPrepItem, getProgress,
            foodLoc, shopCat, photoArea, getCurrentList,
            hotelTab, flightMode, currentFlightUser, editFlightField,
            tokyoWeather, kamakuraWeather, fujiWeather, sakuraStatus, getClothingAdvice, japanesePhrases, speak,
            showLightbox, currentZoomImg, openImage, handleImgError,
            showUserModal, editingUser, openUserEdit, saveUserEdit, triggerAvatarUpload, processAvatarUpload,
            saveAsHtml, resetItinerary
        };
    }
}).mount('#app');
</script>
</body>
</html>
