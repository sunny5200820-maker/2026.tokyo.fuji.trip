<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—œæ±8æ—¥å¥³å­æ—… | å‰ä¼Šå¡å“‡é¢¨ V2.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chiika-pink': '#FFD1DC',
                        'chiika-blue': '#A2D2FF',
                        'chiika-yellow': '#FFF5BA',
                        'chiika-text': '#5D5D5D',
                    },
                    fontFamily: {
                        sans: ['Zen Maru Gothic', 'sans-serif'],
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #A2D2FF; 
            font-family: 'Zen Maru Gothic', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .banner-container {
            height: 250px;
            background-image: url('./banner.jpg'); 
            background-size: cover;
            background-position: center;
            position: relative;
        }
        /* è‹¥æ²’æœ‰ banner.jpgï¼Œä½¿ç”¨å‚™ç”¨æ¼¸å±¤ */
        .banner-fallback {
            background: linear-gradient(180deg, #A2D2FF 0%, #FFD1DC 100%);
        }
        .app-content {
            background-color: #FFF5F7;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            margin-top: -30px; 
            position: relative;
            z-index: 10;
            min-height: calc(100vh - 220px);
            padding-bottom: 140px; /* å¢åŠ åº•éƒ¨ç©ºé–“çµ¦å…©æ’æŒ‰éˆ• */
        }
        .floating-tabs {
            position: fixed;
            bottom: 20px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 40;
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            backdrop-filter: blur(5px);
            width: max-content;
            max-width: 95vw;
            overflow-x: auto;
        }
        .tab-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: #9CA3AF;
            transition: all 0.2s;
            position: relative;
            flex-shrink: 0;
        }
        .tab-btn.active {
            background: #FFD1DC;
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(255, 209, 220, 0.6);
        }
        .tab-label {
            position: absolute;
            bottom: -18px;
            font-size: 9px;
            width: max-content;
            color: #888;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .tab-btn.active .tab-label { opacity: 1; color: #FF8FAB; font-weight: bold; }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(255, 183, 178, 0.2);
            transition: transform 0.1s;
        }
        .card:active { transform: scale(0.98); }

        /* å¤©æ°£å°å¡å‹•ç•« */
        .weather-chiika {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        [v-cloak] { display: none; }
        .loading-placeholder {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-weight: bold; color: #fff; font-size: 1.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div id="app">
    <div class="loading-placeholder" v-if="!isMounted">
        <i class="fa-solid fa-spinner fa-spin mr-2"></i> æ­£åœ¨æº–å‚™è¡Œç¨‹...
    </div>

    <div v-if="isMounted" v-cloak>
        <div class="banner-container relative" :class="{'banner-fallback': !hasBanner}">
            <div class="absolute top-4 right-4 z-20 flex gap-2">
                <button @click="exportData" class="bg-white/80 backdrop-blur text-gray-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm hover:bg-white"><i class="fa-solid fa-download mr-1"></i>åŒ¯å‡ºè¡Œç¨‹</button>
                <label class="bg-white/80 backdrop-blur text-gray-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm hover:bg-white cursor-pointer">
                    <i class="fa-solid fa-upload mr-1"></i>åŒ¯å…¥
                    <input type="file" @change="importData" class="hidden" accept=".json">
                </label>
            </div>
            <div class="absolute bottom-10 left-6 text-white drop-shadow-md z-10">
                <h1 class="text-3xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">é—œæ±8æ—¥å¥³å­æ—… ğŸŒ¸</h1>
                <p class="text-sm opacity-90 mt-1" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">å¯Œå£«å±±è‡ªé§• x å‰ä¼Šå¡å“‡</p>
            </div>
        </div>

        <div class="app-content px-4 py-6">

            <div v-if="currentTab === 'itinerary'">
                <div class="flex overflow-x-auto hide-scrollbar gap-3 mb-6 pb-2">
                    <div v-for="(day, index) in tripDays" :key="index" 
                        @click="changeDay(index)"
                        :class="['flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all', 
                                selectedDayIndex === index ? 'bg-chiika-pink text-white shadow-md transform scale-105' : 'bg-white text-gray-400']">
                        <span class="text-xs font-bold">{{ day.week }}</span>
                        <span class="text-2xl font-bold">{{ day.dateNum }}</span>
                    </div>
                </div>

                <div class="rounded-2xl p-4 mb-6 flex items-center justify-between shadow-md text-white relative overflow-hidden transition-all duration-500" 
                    :style="weatherBackground">
                    <div class="absolute -top-4 -right-4 w-24 h-24 bg-white opacity-20 rounded-full blur-xl"></div>
                    <div class="flex items-center gap-4 z-10">
                        <div class="text-4xl filter drop-shadow-lg weather-chiika">{{ weatherIcon }}</div>
                        <div>
                            <div class="text-lg font-bold flex items-center gap-2">
                                {{ locationName }} 
                                <span v-if="isFujiArea" class="text-xs bg-white/20 px-2 py-0.5 rounded-full border border-white/30">
                                    ğŸ—» èƒ½è¦‹åº¦ {{ fujiVisibility }}%
                                </span>
                            </div>
                            <div class="text-xs opacity-95 font-medium">{{ weatherDesc }}</div>
                        </div>
                    </div>
                    <div class="text-right z-10">
                        <div class="text-3xl font-bold">{{ currentTemp }}Â°C</div>
                        <div class="text-xs opacity-80">é™é›¨æ©Ÿç‡ {{ rainChance }}%</div>
                    </div>
                </div>

                <div class="space-y-0 min-h-[300px]">
                    <div v-if="currentDayItinerary.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-bed text-4xl mb-2 opacity-50"></i>
                        <p>ä»Šå¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹å‘¦<br>é»æ“Šå³ä¸‹è§’æ–°å¢ï¼</p>
                    </div>

                    <div v-for="(item, idx) in currentDayItinerary" :key="item.id" class="relative group">
                        <div v-if="idx > 0" class="ml-5 border-l-2 border-dashed border-gray-300 h-8 flex items-center pl-6 text-xs text-gray-400">
                            <i :class="getTransportIcon(item.transportType)" class="mr-2"></i>
                            <span>ç´„ {{ item.travelTime }} åˆ†</span>
                        </div>
                        
                        <div @click="openMap(item.name)" 
                            :class="['card p-4 flex gap-4 cursor-pointer relative transition hover:shadow-md', item.category === 'Flight' ? 'bg-gradient-to-r from-blue-50 to-purple-50' : 'bg-white']">
                            
                            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center flex-shrink-0 text-chiika-blue text-xl">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-lg leading-tight text-gray-700">{{ item.name }}</h3>
                                    <button @click.stop="deleteItem(idx)" class="text-gray-300 hover:text-red-400 p-2 -mr-2 -mt-2 z-20">
                                        <i class="fa-solid fa-trash-can text-sm"></i>
                                    </button>
                                </div>
                                <div v-if="item.hours" class="text-xs mt-1 text-gray-500">
                                    <i class="fa-regular fa-clock mr-1"></i> {{ item.hours }}
                                </div>
                                <div v-if="item.ticket" class="text-xs mt-1 text-pink-500 font-bold">
                                    <i class="fa-solid fa-ticket mr-1"></i> {{ item.ticket }}
                                </div>
                                <p class="text-xs mt-2 text-gray-500 leading-relaxed">{{ item.note }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="showAddModal = true" class="fixed bottom-28 right-6 w-14 h-14 bg-chiika-blue text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-30 hover:bg-blue-300 transition-colors transform active:scale-95 animate-bounce-slow">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'food'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-orange-300">
                    é™„è¿‘åƒåƒå–å–
                    <span class="text-xs font-normal text-gray-400 ml-2 block mt-1">åŸºæ–¼è¡Œç¨‹åœ°é»æ¨è–¦</span>
                </h2>
                
                <div class="grid grid-cols-1 gap-4">
                    <a v-for="(rec, idx) in recommendedFood" :key="idx" 
                       :href="rec.mapLink" target="_blank"
                       class="card p-0 flex flex-row overflow-hidden h-28 cursor-pointer hover:opacity-90 transition relative">
                        <div class="w-28 bg-gray-200 flex-shrink-0 relative">
                             <div class="absolute inset-0 flex items-center justify-center bg-orange-100 text-orange-300">
                                <i :class="rec.icon" class="text-3xl"></i>
                            </div>
                        </div>
                        <div class="p-3 flex flex-col justify-center flex-1">
                            <div class="flex justify-between">
                                <span class="text-xs bg-orange-100 text-orange-500 px-2 py-0.5 rounded-md font-bold mb-1 w-max">{{ rec.type }}</span>
                                <span class="text-xs text-gray-400"><i class="fa-solid fa-location-dot mr-1"></i>{{ rec.area }}</span>
                            </div>
                            <h3 class="font-bold text-gray-700 leading-tight mb-1">{{ rec.name }}</h3>
                            <p class="text-xs text-gray-500 line-clamp-2">{{ rec.desc }}</p>
                        </div>
                        <div class="absolute bottom-2 right-2 text-blue-400 text-xs">
                            <i class="fa-solid fa-map-location-dot mr-1"></i>å°èˆª
                        </div>
                    </a>
                </div>
                <div class="mt-8 text-center">
                    <button @click="openGoogleMapSearch" class="bg-white border-2 border-orange-300 text-orange-400 px-6 py-3 rounded-full font-bold shadow-sm hover:bg-orange-50 transition">
                        <i class="fa-brands fa-google mr-2"></i>æœå°‹é™„è¿‘ç¾é£Ÿ
                    </button>
                </div>
            </div>

            <div v-if="currentTab === 'japanese'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-green-300">å³æ™‚æ•‘å‘½æ—¥æ–‡</h2>
                
                <div class="grid grid-cols-1 gap-3">
                    <div v-for="(phrase, idx) in japanesePhrases" :key="idx" 
                         @click="speak(phrase.jp)"
                         class="card p-4 flex items-center justify-between cursor-pointer hover:bg-green-50 active:scale-95 transition border-l-4 border-transparent hover:border-green-300">
                        <div>
                            <div class="font-bold text-lg text-gray-800">{{ phrase.jp }}</div>
                            <div class="text-xs text-gray-400">{{ phrase.romaji }}</div>
                            <div class="text-sm text-green-600 font-medium mt-1">{{ phrase.tw }}</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 shadow-sm">
                            <i class="fa-solid fa-volume-high"></i>
                        </div>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200 text-sm text-gray-600">
                    <i class="fa-solid fa-lightbulb text-yellow-500 mr-2"></i>å°æ’‡æ­¥ï¼šé»æ“Šå¡ç‰‡ï¼Œæ‰‹æ©Ÿæœƒç›´æ¥å”¸å‡ºä¾†çµ¦åº—å“¡è½å–”ï¼
                </div>
            </div>

            <div v-if="currentTab === 'prep'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-pink-300">è¡Œå‰æº–å‚™æ¸…å–®</h2>
                <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" 
                class="block w-full bg-gradient-to-r from-pink-400 to-red-400 text-white p-4 rounded-xl shadow-lg mb-6 flex items-center justify-between hover:opacity-90 transition transform active:scale-95">
                    <div class="flex items-center gap-3">
                        <div class="bg-white text-pink-500 w-10 h-10 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-qrcode text-xl"></i>
                        </div>
                        <div>
                            <div class="font-bold text-lg">Visit Japan Web</div>
                            <div class="text-xs opacity-90">å…¥å¢ƒæ—¥æœ¬å¿…å¡«ï¼ŒæŒ‰æ­¤å‰å¾€</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right opacity-70"></i>
                </a>
                <div class="bg-white rounded-2xl shadow-sm p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-4 bg-chiika-yellow opacity-50"></div>
                    <div v-for="(item, idx) in prepList" :key="idx" class="notepad-item">
                        <input type="checkbox" v-model="item.checked" class="notepad-checkbox flex-shrink-0">
                        <span :class="['flex-1 text-sm font-medium transition', item.checked ? 'strikethrough' : 'text-gray-700']">{{ item.text }}</span>
                        <button @click="removePrepItem(idx)" class="text-gray-300 hover:text-red-400 p-2"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <input v-model="newPrepInput" @keyup.enter="addPrepItem" placeholder="æ–°å¢æº–å‚™é …ç›®..." class="flex-1 bg-gray-50 border-b-2 border-gray-200 p-2 text-sm outline-none focus:border-chiika-pink transition">
                        <button @click="addPrepItem" class="text-chiika-pink font-bold text-sm px-2">æ–°å¢</button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'shopping'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-blue-300">è³¼ç‰©é¡˜æœ›æ¸…å–®</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="card p-3 flex flex-col items-center relative group">
                        <button @click="shoppingList.splice(idx, 1)" class="absolute top-2 right-2 w-6 h-6 bg-white rounded-full text-red-400 shadow flex items-center justify-center z-10">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        <div class="w-full h-32 bg-gray-100 rounded-lg mb-2 overflow-hidden flex items-center justify-center">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <i v-else class="fa-regular fa-image text-gray-300 text-3xl"></i>
                        </div>
                        <div class="font-bold text-sm text-center w-full truncate text-gray-700">{{ item.name }}</div>
                    </div>
                    <div @click="showShopModal = true" class="card p-3 flex flex-col items-center justify-center min-h-[160px] cursor-pointer border-2 border-dashed border-gray-300 hover:border-pink-300 bg-transparent shadow-none transition">
                        <i class="fa-solid fa-plus text-3xl text-gray-300"></i>
                        <div class="text-xs text-gray-400 mt-2">æ–°å¢å•†å“</div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'expenses'">
                <div class="flex bg-white rounded-full p-1 mb-6 shadow-sm">
                    <button @click="expenseMode = 'personal'" :class="['flex-1 py-2 rounded-full text-sm font-bold transition', expenseMode === 'personal' ? 'bg-chiika-yellow text-gray-700 shadow-sm' : 'text-gray-400 hover:bg-gray-50']">å€‹äººè¨˜å¸³</button>
                    <button @click="expenseMode = 'split'" :class="['flex-1 py-2 rounded-full text-sm font-bold transition', expenseMode === 'split' ? 'bg-chiika-pink text-white shadow-sm' : 'text-gray-400 hover:bg-gray-50']">åˆ†å¸³è¡¨</button>
                </div>

                <div v-if="expenseMode === 'personal'">
                    <div class="bg-chiika-yellow text-gray-700 p-6 rounded-2xl mb-4 text-center shadow-lg relative overflow-hidden">
                        <i class="fa-solid fa-coins absolute -bottom-4 -right-4 text-6xl text-yellow-200 opacity-50"></i>
                        <div class="text-sm opacity-80">å€‹äººç¸½èŠ±è²» (JPY)</div>
                        <div class="text-4xl font-bold mt-1">Â¥ {{ totalExpenses.toLocaleString() }}</div>
                    </div>
                    <div class="space-y-3">
                        <div v-for="(exp, idx) in expenses" :key="idx" class="card p-3 flex justify-between items-center relative group">
                            <button @click="expenses.splice(idx, 1)" class="absolute -left-2 -top-2 w-6 h-6 bg-red-400 text-white rounded-full text-xs hidden group-hover:flex items-center justify-center shadow-md"><i class="fa-solid fa-xmark"></i></button>
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i :class="getCategoryIcon(exp.category)"></i></div>
                                <div>
                                    <div class="font-bold text-sm text-gray-700">{{ exp.name }}</div>
                                    <div class="text-xs text-gray-400">{{ exp.date }} Â· {{ exp.payment }}</div>
                                </div>
                            </div>
                            <div class="font-bold text-gray-700">Â¥{{ parseInt(exp.amount).toLocaleString() }}</div>
                        </div>
                    </div>
                    <button @click="showExpenseModal = true" class="fixed bottom-28 right-6 w-14 h-14 bg-yellow-400 text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-30 transition transform active:scale-95"><i class="fa-solid fa-plus"></i></button>
                </div>

                <div v-if="expenseMode === 'split'">
                    <div class="mb-4 bg-white p-4 rounded-xl shadow-sm border border-pink-100">
                        <div class="flex justify-between items-center mb-3">
                            <div class="text-sm text-gray-700 font-bold">åˆ†å¸³æˆå“¡è¨­å®š</div>
                            <button @click="saveMembers" class="text-xs text-pink-500 font-bold" v-if="isMembersChanged">å„²å­˜è¨­å®š</button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <div v-for="(member, idx) in splitMembers" :key="idx" class="bg-pink-50 px-3 py-1 rounded-full text-sm shadow-sm flex items-center gap-2 border border-pink-200">
                                <span class="text-gray-700">{{ member }}</span>
                                <button @click="removeMember(idx)" class="text-pink-300 hover:text-red-500 text-xs"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                            <button @click="addMember" class="px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-500 hover:bg-gray-200 transition border border-gray-200 border-dashed">
                                <i class="fa-solid fa-plus mr-1"></i>æ–°å¢
                            </button>
                        </div>
                    </div>

                    <h3 class="font-bold text-chiika-text mb-3 pl-2 border-l-4 border-pink-300">å…¬æ¬¾æ”¯å‡ºè¨˜éŒ„</h3>
                    <div class="space-y-3">
                        <div v-for="(bill, idx) in splitBills" :key="idx" class="card p-4 border border-pink-50 relative">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-bold text-lg text-gray-700">{{ bill.item }}</div>
                                <div class="font-bold text-pink-500">Â¥{{ parseInt(bill.amount).toLocaleString() }}</div>
                            </div>
                            <div class="flex justify-between items-center text-xs text-gray-500 bg-gray-50 p-2 rounded-lg">
                                <div class="flex items-center gap-1">
                                    <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">å…ˆå¢Š</span>
                                    <span class="font-bold text-gray-700">{{ bill.payer }}</span>
                                </div>
                                <button @click="splitBills.splice(idx, 1)" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <div v-if="splitBills.length === 0" class="text-center text-gray-400 text-sm py-8 bg-white rounded-2xl border-2 border-dashed border-gray-200">
                            ç›®å‰æ²’æœ‰åˆ†å¸³è¨˜éŒ„<br>é»æ“Šå³ä¸‹è§’æ–°å¢
                        </div>
                    </div>
                    <button @click="showSplitModal = true" class="fixed bottom-28 right-6 w-14 h-14 bg-chiika-pink text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-30 transition transform active:scale-95"><i class="fa-solid fa-hand-holding-dollar"></i></button>
                </div>
            </div>
        </div>

        <div class="floating-tabs hide-scrollbar">
            <button @click="currentTab = 'itinerary'" :class="['tab-btn', currentTab === 'itinerary' ? 'active' : '']">
                <i class="fa-solid fa-map-location-dot"></i><span class="tab-label">è¡Œç¨‹</span>
            </button>
            <button @click="currentTab = 'food'" :class="['tab-btn', currentTab === 'food' ? 'active' : '']">
                <i class="fa-solid fa-utensils"></i><span class="tab-label">åƒå–</span>
            </button>
            <button @click="currentTab = 'prep'" :class="['tab-btn', currentTab === 'prep' ? 'active' : '']">
                <i class="fa-solid fa-suitcase-rolling"></i><span class="tab-label">è¡Œå‰</span>
            </button>
            <button @click="currentTab = 'shopping'" :class="['tab-btn', currentTab === 'shopping' ? 'active' : '']">
                <i class="fa-solid fa-basket-shopping"></i><span class="tab-label">è³¼ç‰©</span>
            </button>
            <button @click="currentTab = 'expenses'" :class="['tab-btn', currentTab === 'expenses' ? 'active' : '']">
                <i class="fa-solid fa-sack-dollar"></i><span class="tab-label">èŠ±è²»</span>
            </button>
            <button @click="currentTab = 'japanese'" :class="['tab-btn', currentTab === 'japanese' ? 'active' : '']">
                <i class="fa-solid fa-comment-dots"></i><span class="tab-label">æ•‘å‘½</span>
            </button>
        </div>

        <div v-if="showAddModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-center text-gray-700">æ–°å¢è¡Œç¨‹è‡³ <span class="text-chiika-pink">{{ tripDays[selectedDayIndex].week }}</span></h3>
                <div class="space-y-3">
                    <input v-model="newItem.name" placeholder="åç¨± (ä¾‹: æ¾€è°·Parco)" class="w-full p-2 border rounded-lg bg-gray-50 focus:border-chiika-blue outline-none">
                    <input v-model="newItem.hours" placeholder="æ™‚é–“ (ä¾‹: 14:00)" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                    <select v-model="newItem.category" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                        <option value="Sightseeing">ğŸ“¸ æ™¯é»</option>
                        <option value="Food">ğŸœ ç¾é£Ÿ</option>
                        <option value="Shopping">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="Transport">ğŸš… äº¤é€š</option>
                        <option value="Hotel">ğŸ¨ ä½å®¿</option>
                        <option value="Other">âœ¨ å…¶ä»–</option>
                    </select>
                    <textarea v-model="newItem.note" placeholder="å‚™è¨»..." class="w-full p-2 border rounded-lg bg-gray-50 outline-none h-20"></textarea>
                    
                    <div class="flex gap-2 pt-2">
                        <button @click="showAddModal = false" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-600">å–æ¶ˆ</button>
                        <button @click="addItem" class="flex-1 py-2 bg-chiika-blue text-white rounded-lg shadow-md">æ–°å¢</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showShopModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
             <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-center text-gray-700">åŠ å…¥è³¼ç‰©è»Š</h3>
                <input v-model="newShopItem.name" placeholder="å•†å“åç¨±" class="w-full p-2 border rounded-lg mb-3 bg-gray-50 focus:border-pink-300 outline-none">
                <label class="block w-full p-4 border-2 border-dashed border-gray-300 rounded-lg text-center text-gray-400 cursor-pointer hover:bg-gray-50 hover:border-pink-300 transition">
                    <i class="fa-solid fa-camera mb-1 text-2xl"></i><br>ä¸Šå‚³åœ–ç‰‡
                    <input type="file" @change="handleImageUpload" class="hidden">
                </label>
                <div v-if="newShopItem.image" class="mt-2 text-center text-xs text-green-500 font-bold">å·²é¸æ“‡åœ–ç‰‡</div>
                <div class="flex gap-2 mt-4">
                    <button @click="showShopModal = false" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-600">å–æ¶ˆ</button>
                    <button @click="addShopItem" class="flex-1 py-2 bg-pink-400 text-white rounded-lg shadow-md">ç¢ºå®š</button>
                </div>
            </div>
        </div>

        <div v-if="showExpenseModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-center text-gray-700">å€‹äººè¨˜å¸³</h3>
                <div class="space-y-3">
                    <input v-model="newExpense.name" placeholder="é …ç›®åç¨±" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                    <input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡ (JPY)" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                    <div class="flex gap-2 pt-2">
                        <button @click="showExpenseModal = false" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-600">å–æ¶ˆ</button>
                        <button @click="addExpense" class="flex-1 py-2 bg-yellow-400 text-white rounded-lg shadow-md">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showSplitModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 border-4 border-chiika-pink shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-center text-gray-700">æ–°å¢å…¬æ¬¾æ”¯å‡º</h3>
                <div class="space-y-3">
                    <div class="text-xs text-gray-400 font-bold ml-1">èª°å…ˆå¢ŠéŒ¢ï¼Ÿ</div>
                    <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                        <button v-for="m in splitMembers" :key="m" @click="newSplit.payer = m"
                            :class="['px-3 py-1 rounded-full text-sm border whitespace-nowrap transition', newSplit.payer === m ? 'bg-chiika-pink text-white border-chiika-pink shadow-sm' : 'border-gray-300 text-gray-500']">
                            {{ m }}
                        </button>
                    </div>
                    <input v-model="newSplit.item" placeholder="é …ç›® (ä¾‹: ç§Ÿè»Šè²»)" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                    <input type="number" v-model="newSplit.amount" placeholder="ç¸½é‡‘é¡ (JPY)" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                    <div class="flex gap-2 pt-2">
                        <button @click="showSplitModal = false" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-600">å–æ¶ˆ</button>
                        <button @click="addSplitBill" class="flex-1 py-2 bg-chiika-pink text-white rounded-lg shadow-md">æ–°å¢è¨˜éŒ„</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const isMounted = ref(false);
            const currentTab = ref('itinerary');
            const selectedDayIndex = ref(0);
            const hasBanner = ref(true); // æª¢æ¸¬åœ–ç‰‡æ˜¯å¦å­˜åœ¨

            // å¤©æ°£ç›¸é—œç‹€æ…‹
            const weatherIcon = ref('ğŸŒ¤ï¸');
            const currentTemp = ref('--');
            const rainChance = ref('0');
            const weatherDesc = ref('è®€å–ä¸­...');
            const fujiVisibility = ref('??');
            const weatherBackground = ref('background: linear-gradient(to right, #60a5fa, #a78bfa)');

            // è³‡æ–™å„²å­˜ Key
            const STORAGE_KEY = 'tokyo_trip_v2';

            // UI State
            const showAddModal = ref(false);
            const showShopModal = ref(false);
            const showExpenseModal = ref(false);
            const showSplitModal = ref(false);
            const expenseMode = ref('personal');
            const isMembersChanged = ref(false);

            const tripDays = [
                { date: '2026-03-27', week: 'Fri', dateNum: '27' },
                { date: '2026-03-28', week: 'Sat', dateNum: '28' },
                { date: '2026-03-29', week: 'Sun', dateNum: '29' },
                { date: '2026-03-30', week: 'Mon', dateNum: '30' },
                { date: '2026-03-31', week: 'Tue', dateNum: '31' },
                { date: '2026-04-01', week: 'Wed', dateNum: '01' },
                { date: '2026-04-02', week: 'Thu', dateNum: '02' },
                { date: '2026-04-03', week: 'Fri', dateNum: '03' }
            ];

            // é è¨­è¡Œç¨‹ (å¦‚æœæ²’æœ‰å­˜æª”)
            const defaultItinerary = [
                 [ 
                    { id: 1, category: 'Flight', name: 'é…·èˆª TR898 èµ·é£›', hours: '06:40', note: 'æ¡ƒåœ’ç¬¬ä¸€èˆªå»ˆ', travelTime: 0, transportType: 'flight' },
                    { id: 2, category: 'Flight', name: 'æŠµé”æ±äº¬æˆç”°', hours: '10:40', note: 'æˆç”°ç¬¬ä¸€èˆªå»ˆ', travelTime: 240, transportType: 'flight' },
                    { id: 3, category: 'Sightseeing', name: 'æ™´ç©ºå¡”', hours: '10:00-21:00', ticket: 'Â¥2100', note: 'å¿…æ‹åœ°æ¨™', travelTime: 60, transportType: 'train' }
                ], [], [], [], [], [], [], [] 
            ];

            const itineraryData = ref(defaultItinerary);
            const shoppingList = ref([{ name: 'å‰ä¼Šå¡å“‡ç©å¶', image: '' }]);
            const prepList = ref([{ text: 'è­·ç…§ (æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)', checked: false }, { text: 'æ—¥å¹£ç¾é‡‘', checked: false }]);
            const expenses = ref([]);
            const splitMembers = ref(['æˆ‘', 'å°å…«', 'å…”å…”']);
            const splitBills = ref([]);

            // Models
            const newItem = ref({ name: '', category: 'Sightseeing', hours: '', ticket: '', note: '', travelTime: 15, transportType: 'walk' });
            const newShopItem = ref({ name: '', image: null });
            const newExpense = ref({ category: 'Food', name: '', amount: '', payment: 'ç¾é‡‘', date: '' });
            const newSplit = ref({ item: '', amount: '', payer: 'æˆ‘' });
            const newPrepInput = ref('');

            // å³æ™‚æ—¥æ–‡è³‡æ–™
            const japanesePhrases = [
                { jp: 'ã™ã¿ã¾ã›ã‚“', romaji: 'Sumimasen', tw: 'ä¸å¥½æ„æ€ / è«‹å•' },
                { jp: 'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™', romaji: 'Kore o onegaishimasu', tw: 'æˆ‘è¦é€™å€‹ (é»é¤ç”¨)' },
                { jp: 'ã„ãã‚‰ã§ã™ã‹ï¼Ÿ', romaji: 'Ikura desu ka?', tw: 'è«‹å•å¤šå°‘éŒ¢ï¼Ÿ' },
                { jp: 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', romaji: 'Okaikei o onegaishimasu', tw: 'æˆ‘è¦çµå¸³' },
                { jp: 'è¢‹ã¯ã„ã‚Šã¾ã›ã‚“', romaji: 'Fukuro wa irimasen', tw: 'ä¸ç”¨å¡‘è† è¢‹' },
                { jp: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', romaji: 'Toire wa doko desu ka?', tw: 'å»æ‰€åœ¨å“ªè£¡ï¼Ÿ' },
                { jp: 'åŠ©ã‘ã¦ãã ã•ã„', romaji: 'Tasukete kudasai', tw: 'è«‹æ•‘æ•‘æˆ‘ (ç·Šæ€¥)' },
                { jp: 'è‹±èªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹', romaji: 'Eigo menyu wa arimasu ka', tw: 'æœ‰è‹±æ–‡èœå–®å—ï¼Ÿ' }
            ];

            // æ¨è–¦ç¾é£Ÿè³‡æ–™
            const foodRecommendations = {
                'Tokyo': [
                    { name: 'AFURI æ‹‰éºµ', type: 'æŸšå­æ‹‰éºµ', area: 'åŸå®¿/å…­æœ¬æœ¨', desc: 'æ¸…çˆ½æŸšå­é¹½å‘³ï¼Œå¥³ç”Ÿæœ€æ„›', icon: 'fa-solid fa-bowl-food', mapLink: 'https://www.google.com/maps/search/AFURI+Tokyo' },
                    { name: 'HARBS', type: 'æ°´æœåƒå±¤', area: 'æ–°å®¿/æ¾€è°·', desc: 'è¶…å¤§ä»½é‡æ°´æœåƒå±¤è›‹ç³•ï¼Œå¿…åƒ', icon: 'fa-solid fa-cake-candles', mapLink: 'https://www.google.com/maps/search/HARBS+Tokyo' },
                    { name: 'ç‰›ã‹ã¤ã‚‚ã¨æ‘', type: 'ç‚¸ç‰›æ’', area: 'å„è™•', desc: 'è‡ªå·±ç”¨çŸ³æ¿çƒ¤çš„åŠç†Ÿç‚¸ç‰›æ’', icon: 'fa-solid fa-fire-burner', mapLink: 'https://www.google.com/maps/search/Gyukatsu+Motomura+Tokyo' }
                ],
                'Fuji': [
                    { name: 'Houtou Fudou', type: 'é¤ºé£¥éºµ', area: 'æ²³å£æ¹–', desc: 'å±±æ¢¨ç¸£é„‰åœŸæ–™ç†ï¼Œé›²æœµå»ºç¯‰è¶…å¯æ„›', icon: 'fa-solid fa-cloud', mapLink: 'https://www.google.com/maps/search/Houtou+Fudou' },
                    { name: 'å¯Œå£«å±±åå¸', type: 'åå¸', area: 'æ²³å£æ¹–', desc: 'åˆ‡é–‹å°±æ˜¯å¯Œå£«å±±å½¢ç‹€çš„ç”Ÿåå¸', icon: 'fa-solid fa-bread-slice', mapLink: 'https://www.google.com/maps/search/Fujisan+Shokupan' },
                    { name: 'Lake Bake', type: 'å’–å•¡å»³', area: 'å¤§çŸ³å…¬åœ’', desc: 'çœ‹è‘—å¯Œå£«å±±åƒéºµåŒ…å–å’–å•¡', icon: 'fa-solid fa-mug-hot', mapLink: 'https://www.google.com/maps/search/Lake+Bake+Kawaguchiko' }
                ],
                'Kamakura': [
                    { name: 'Bills', type: 'é¬†é¤…', area: 'ä¸ƒé‡Œæ¿±', desc: 'ä¸–ç•Œç¬¬ä¸€æ—©é¤ï¼Œç„¡æ•µæµ·æ™¯', icon: 'fa-solid fa-pancakes', mapLink: 'https://www.google.com/maps/search/Bills+Shichirigahama' },
                    { name: 'Caraway', type: 'å’–å“©', area: 'éŒå€‰', desc: 'æ’éšŠååº—ï¼Œæ¿ƒåšç³»æ—¥å¼å’–å“©', icon: 'fa-solid fa-spoon', mapLink: 'https://www.google.com/maps/search/Caraway+Curry+Kamakura' }
                ]
            };

            // Computed
            const currentDayItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
            const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
            
            // åˆ¤æ–·ç›®å‰æ˜¯å“ªä¸€å€ (ç”¨æ–¼å¤©æ°£èˆ‡ç¾é£Ÿæ¨è–¦)
            const currentLocationKey = computed(() => {
                const dayIndex = selectedDayIndex.value;
                if (dayIndex >= 2 && dayIndex <= 4) return 'Fuji'; // Day 3,4,5
                if (dayIndex === 5) return 'Kamakura'; // Day 6
                return 'Tokyo'; // Others
            });

            const locationName = computed(() => {
                const map = { 'Tokyo': 'æ±äº¬ Tokyo', 'Fuji': 'å¯Œå£«å±± Fuji', 'Kamakura': 'éŒå€‰ Kamakura' };
                return map[currentLocationKey.value];
            });

            const isFujiArea = computed(() => currentLocationKey.value === 'Fuji');

            const recommendedFood = computed(() => {
                return foodRecommendations[currentLocationKey.value] || foodRecommendations['Tokyo'];
            });

            // å­˜æª”é‚è¼¯
            const saveData = () => {
                const data = {
                    itinerary: itineraryData.value,
                    shopping: shoppingList.value,
                    prep: prepList.value,
                    expenses: expenses.value,
                    splitMembers: splitMembers.value,
                    splitBills: splitBills.value
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            };

            const loadData = () => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        itineraryData.value = parsed.itinerary || defaultItinerary;
                        shoppingList.value = parsed.shopping || [];
                        prepList.value = parsed.prep || [];
                        expenses.value = parsed.expenses || [];
                        splitMembers.value = parsed.splitMembers || ['æˆ‘'];
                        splitBills.value = parsed.splitBills || [];
                    } catch (e) { console.error('Load Error', e); }
                }
            };

            // Watchers è‡ªå‹•å­˜æª”
            watch([itineraryData, shoppingList, prepList, expenses, splitMembers, splitBills], () => {
                saveData();
            }, { deep: true });

            // Methods
            const changeDay = (index) => {
                selectedDayIndex.value = index;
                fetchWeather(); // åˆ‡æ›æ—¥æœŸæ™‚æ›´æ–°å¤©æ°£
            };

            const getCategoryIcon = (cat) => {
                const map = { 'Sightseeing': 'fa-camera', 'Food': 'fa-utensils', 'Shopping': 'fa-bag-shopping', 'Flight': 'fa-plane', 'Transport': 'fa-train-subway', 'Hotel': 'fa-hotel', 'Other': 'fa-star' };
                return map[cat] || 'fa-star';
            };
            const getTransportIcon = (type) => {
                const map = { 'walk': 'fa-person-walking', 'car': 'fa-car', 'train': 'fa-train-subway', 'bike': 'fa-bicycle', 'flight': 'fa-plane' };
                return map[type] || 'fa-person-walking';
            };

            const openMap = (keyword) => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword)}`, '_blank');
            };

            const openGoogleMapSearch = () => {
                const area = locationName.value.split(' ')[0]; // å–ä¸­æ–‡å
                window.open(`https://www.google.com/maps/search/${area}+ç¾é£Ÿ`, '_blank');
            };

            const speak = (text) => {
                const msg = new SpeechSynthesisUtterance();
                msg.text = text;
                msg.lang = 'ja-JP';
                window.speechSynthesis.speak(msg);
            };

            // è¡Œç¨‹ç·¨è¼¯åŠŸèƒ½
            const addItem = () => {
                if(!newItem.value.name) return;
                // ç¢ºä¿ç•¶å¤©é™£åˆ—å­˜åœ¨
                if (!itineraryData.value[selectedDayIndex.value]) {
                    itineraryData.value[selectedDayIndex.value] = [];
                }
                itineraryData.value[selectedDayIndex.value].push({ ...newItem.value, id: Date.now() });
                showAddModal.value = false;
                newItem.value = { name: '', category: 'Sightseeing', hours: '', ticket: '', note: '', travelTime: 15, transportType: 'walk' };
            };

            const deleteItem = (idx) => {
                if(confirm('ç¢ºå®šåˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ')) {
                    itineraryData.value[selectedDayIndex.value].splice(idx, 1);
                }
            };

            // åˆ†å¸³æˆå“¡ç®¡ç†
            const addMember = () => {
                const name = prompt('è«‹è¼¸å…¥æ–°æˆå“¡åå­—ï¼š');
                if (name) {
                    splitMembers.value.push(name);
                    isMembersChanged.value = true;
                }
            };
            const removeMember = (idx) => {
                if(confirm(`ç§»é™¤æˆå“¡ ${splitMembers.value[idx]}ï¼Ÿ`)) {
                    splitMembers.value.splice(idx, 1);
                    isMembersChanged.value = true;
                }
            };
            const saveMembers = () => {
                saveData(); // å¼·åˆ¶å­˜æª”
                isMembersChanged.value = false;
                alert('æˆå“¡å·²æ›´æ–°ï¼');
            };

            // åŒ¯å‡ºåŒ¯å…¥åŠŸèƒ½
            const exportData = () => {
                const dataStr = JSON.stringify(localStorage.getItem(STORAGE_KEY));
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'tokyo_trip_data.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = JSON.parse(e.target.result); // é€™è£¡è§£é–‹çš„æ˜¯ stringified JSON
                        // æœ‰æ™‚å€™ export æœƒå¤šåŒ…ä¸€å±¤ quoteï¼Œéœ€è¦æ³¨æ„
                        const actualData = typeof content === 'string' ? content : JSON.stringify(content);
                        localStorage.setItem(STORAGE_KEY, actualData);
                        loadData();
                        alert('è¡Œç¨‹åŒ¯å…¥æˆåŠŸï¼');
                    } catch (err) {
                        alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                    }
                };
                reader.readAsText(file);
            };
            
            // å…¶ä»–åŸæœ‰åŠŸèƒ½
            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => newShopItem.value.image = e.target.result;
                    reader.readAsDataURL(file);
                }
            };
            const addShopItem = () => {
                if(!newShopItem.value.name) return;
                shoppingList.value.push({ ...newShopItem.value });
                showShopModal.value = false;
                newShopItem.value = { name: '', image: null };
            };
            const addExpense = () => {
                if(!newExpense.value.amount) return;
                const today = new Date();
                const dateStr = `${(today.getMonth()+1).toString().padStart(2, '0')}/${today.getDate().toString().padStart(2, '0')}`;
                expenses.value.push({ ...newExpense.value, date: dateStr });
                showExpenseModal.value = false;
                newExpense.value = { category: 'Food', name: '', amount: '', payment: 'ç¾é‡‘', date: '' };
            };
            const addSplitBill = () => {
                if(!newSplit.value.amount || !newSplit.value.item) return;
                splitBills.value.push({ ...newSplit.value });
                showSplitModal.value = false;
                newSplit.value = { item: '', amount: '', payer: splitMembers.value[0] || 'æˆ‘' };
            };
            const addPrepItem = () => {
                if(!newPrepInput.value) return;
                prepList.value.push({ text: newPrepInput.value, checked: false });
                newPrepInput.value = '';
            };
            const removePrepItem = (idx) => prepList.value.splice(idx, 1);

            // ä¸²æ¥çœŸå¯¦æ°£è±¡ API (Open-Meteo)
            const fetchWeather = async () => {
                weatherDesc.value = 'æ›´æ–°ä¸­...';
                
                // å®šç¾©åº§æ¨™
                const coords = {
                    'Tokyo': { lat: 35.6895, lon: 139.6917 },
                    'Fuji': { lat: 35.3606, lon: 138.7274 },
                    'Kamakura': { lat: 35.3192, lon: 139.5467 }
                };
                
                const target = coords[currentLocationKey.value];
                
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${target.lat}&longitude=${target.lon}&current=temperature_2m,precipitation_probability,weather_code,cloud_cover&timezone=Asia%2FTokyo`);
                    const data = await res.json();
                    
                    const current = data.current;
                    currentTemp.value = current.temperature_2m;
                    rainChance.value = current.precipitation_probability || 0;
                    
                    // è§£æå¤©æ°£ä»£ç¢¼ç‚ºå‰ä¼Šå¡å“‡åœ–ç¤º
                    const code = current.weather_code;
                    if (code <= 3) { // æ™´å¤©/å¤šé›²
                        weatherIcon.value = 'ğŸŒ¤ï¸'; // é€™è£¡å¯ä»¥ç”¨å‰ä¼Šå¡å“‡åœ–ç‰‡é€£çµ <img src="...">
                        weatherDesc.value = 'æ˜¯å€‹å¥½å¤©æ°£ï¼';
                        weatherBackground.value = 'background: linear-gradient(to right, #60a5fa, #a78bfa)';
                    } else if (code <= 67) { // é›¨å¤©
                        weatherIcon.value = 'â˜”'; 
                        weatherDesc.value = 'å¥½åƒåœ¨å“­å“­...';
                        weatherBackground.value = 'background: linear-gradient(to right, #475569, #64748b)';
                    } else if (code >= 95) { // é›·é›¨
                        weatherIcon.value = 'âš¡';
                        weatherDesc.value = 'å“‡ï¼å¿«èº²èµ·ä¾†ï¼';
                        weatherBackground.value = 'background: linear-gradient(to right, #334155, #475569)';
                    } else {
                        weatherIcon.value = 'â˜ï¸';
                        weatherDesc.value = 'é™°é™°çš„æ„Ÿè¦º';
                    }

                    // ä¼°ç®—å¯Œå£«å±±èƒ½è¦‹åº¦ (è¶Šå°‘é›²è¶Šæ¸…æ¥š)
                    if (currentLocationKey.value === 'Fuji') {
                        const clouds = current.cloud_cover;
                        // ç°¡å–®å…¬å¼ï¼šèƒ½è¦‹åº¦ = 100 - é›²é‡ (ç¨å¾®åŠ æ¬Š)
                        let visibility = 100 - clouds;
                        if (visibility < 0) visibility = 0;
                        fujiVisibility.value = visibility;
                    }

                } catch (e) {
                    console.error("Weather API Error", e);
                    weatherDesc.value = 'ç„¡æ³•å–å¾—å¤©æ°£';
                }
            };

            onMounted(() => {
                loadData();
                isMounted.value = true;
                // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ç„¡å‰‡åˆ‡æ›æ¨£å¼
                const img = new Image();
                img.src = './banner.jpg';
                img.onerror = () => hasBanner.value = false;
                
                fetchWeather(); // åˆå§‹å¤©æ°£
            });

            return {
                isMounted, hasBanner,
                currentTab, selectedDayIndex, tripDays, changeDay,
                currentDayItinerary, locationName, isFujiArea,
                
                // Weather
                weatherIcon, currentTemp, rainChance, weatherDesc, fujiVisibility, weatherBackground,

                // Itinerary
                showAddModal, newItem, addItem, deleteItem, getCategoryIcon, getTransportIcon, openMap,
                
                // Food
                recommendedFood, openGoogleMapSearch,

                // Shopping & Prep
                shoppingList, showShopModal, newShopItem, handleImageUpload, addShopItem,
                prepList, newPrepInput, addPrepItem, removePrepItem,

                // Expenses & Split
                expenses, totalExpenses, showExpenseModal, newExpense, addExpense, expenseMode,
                splitMembers, splitBills, showSplitModal, newSplit, addMember, removeMember, saveMembers, isMembersChanged, addSplitBill,
                
                // Japanese
                japanesePhrases, speak,

                // Data
                exportData, importData
            };
        }
    }).mount('#app');
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—œæ±8æ—¥å¥³å­æ—… | å‰ä¼Šå¡å“‡é¢¨ V2.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chiika-pink': '#FFD1DC',
                        'chiika-blue': '#A2D2FF',
                        'chiika-yellow': '#FFF5BA',
                        'chiika-text': '#5D5D5D',
                    },
                    fontFamily: {
                        sans: ['Zen Maru Gothic', 'sans-serif'],
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #A2D2FF; 
            font-family: 'Zen Maru Gothic', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .banner-container {
            height: 250px;
            background-image: url('./banner.jpg'); 
            background-size: cover;
            background-position: center;
            position: relative;
        }
        /* è‹¥æ²’æœ‰ banner.jpgï¼Œä½¿ç”¨å‚™ç”¨æ¼¸å±¤ */
        .banner-fallback {
            background: linear-gradient(180deg, #A2D2FF 0%, #FFD1DC 100%);
        }
        .app-content {
            background-color: #FFF5F7;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            margin-top: -30px; 
            position: relative;
            z-index: 10;
            min-height: calc(100vh - 220px);
            padding-bottom: 140px; /* å¢åŠ åº•éƒ¨ç©ºé–“çµ¦å…©æ’æŒ‰éˆ• */
        }
        .floating-tabs {
            position: fixed;
            bottom: 20px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 40;
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            backdrop-filter: blur(5px);
            width: max-content;
            max-width: 95vw;
            overflow-x: auto;
        }
        .tab-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: #9CA3AF;
            transition: all 0.2s;
            position: relative;
            flex-shrink: 0;
        }
        .tab-btn.active {
            background: #FFD1DC;
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(255, 209, 220, 0.6);
        }
        .tab-label {
            position: absolute;
            bottom: -18px;
            font-size: 9px;
            width: max-content;
            color: #888;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .tab-btn.active .tab-label { opacity: 1; color: #FF8FAB; font-weight: bold; }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(255, 183, 178, 0.2);
            transition: transform 0.1s;
        }
        .card:active { transform: scale(0.98); }

        /* å¤©æ°£å°å¡å‹•ç•« */
        .weather-chiika {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        [v-cloak] { display: none; }
        .loading-placeholder {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-weight: bold; color: #fff; font-size: 1.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div id="app">
    <div class="loading-placeholder" v-if="!isMounted">
        <i class="fa-solid fa-spinner fa-spin mr-2"></i> æ­£åœ¨æº–å‚™è¡Œç¨‹...
    </div>

    <div v-if="isMounted" v-cloak>
        <div class="banner-container relative" :class="{'banner-fallback': !hasBanner}">
            <div class="absolute top-4 right-4 z-20 flex gap-2">
                <button @click="exportData" class="bg-white/80 backdrop-blur text-gray-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm hover:bg-white"><i class="fa-solid fa-download mr-1"></i>åŒ¯å‡ºè¡Œç¨‹</button>
                <label class="bg-white/80 backdrop-blur text-gray-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm hover:bg-white cursor-pointer">
                    <i class="fa-solid fa-upload mr-1"></i>åŒ¯å…¥
                    <input type="file" @change="importData" class="hidden" accept=".json">
                </label>
            </div>
            <div class="absolute bottom-10 left-6 text-white drop-shadow-md z-10">
                <h1 class="text-3xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">é—œæ±8æ—¥å¥³å­æ—… ğŸŒ¸</h1>
                <p class="text-sm opacity-90 mt-1" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">å¯Œå£«å±±è‡ªé§• x å‰ä¼Šå¡å“‡</p>
            </div>
        </div>

        <div class="app-content px-4 py-6">

            <div v-if="currentTab === 'itinerary'">
                <div class="flex overflow-x-auto hide-scrollbar gap-3 mb-6 pb-2">
                    <div v-for="(day, index) in tripDays" :key="index" 
                        @click="changeDay(index)"
                        :class="['flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all', 
                                selectedDayIndex === index ? 'bg-chiika-pink text-white shadow-md transform scale-105' : 'bg-white text-gray-400']">
                        <span class="text-xs font-bold">{{ day.week }}</span>
                        <span class="text-2xl font-bold">{{ day.dateNum }}</span>
                    </div>
                </div>

                <div class="rounded-2xl p-4 mb-6 flex items-center justify-between shadow-md text-white relative overflow-hidden transition-all duration-500" 
                    :style="weatherBackground">
                    <div class="absolute -top-4 -right-4 w-24 h-24 bg-white opacity-20 rounded-full blur-xl"></div>
                    <div class="flex items-center gap-4 z-10">
                        <div class="text-4xl filter drop-shadow-lg weather-chiika">{{ weatherIcon }}</div>
                        <div>
                            <div class="text-lg font-bold flex items-center gap-2">
                                {{ locationName }} 
                                <span v-if="isFujiArea" class="text-xs bg-white/20 px-2 py-0.5 rounded-full border border-white/30">
                                    ğŸ—» èƒ½è¦‹åº¦ {{ fujiVisibility }}%
                                </span>
                            </div>
                            <div class="text-xs opacity-95 font-medium">{{ weatherDesc }}</div>
                        </div>
                    </div>
                    <div class="text-right z-10">
                        <div class="text-3xl font-bold">{{ currentTemp }}Â°C</div>
                        <div class="text-xs opacity-80">é™é›¨æ©Ÿç‡ {{ rainChance }}%</div>
                    </div>
                </div>

                <div class="space-y-0 min-h-[300px]">
                    <div v-if="currentDayItinerary.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-bed text-4xl mb-2 opacity-50"></i>
                        <p>ä»Šå¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹å‘¦<br>é»æ“Šå³ä¸‹è§’æ–°å¢ï¼</p>
                    </div>

                    <div v-for="(item, idx) in currentDayItinerary" :key="item.id" class="relative group">
                        <div v-if="idx > 0" class="ml-5 border-l-2 border-dashed border-gray-300 h-8 flex items-center pl-6 text-xs text-gray-400">
                            <i :class="getTransportIcon(item.transportType)" class="mr-2"></i>
                            <span>ç´„ {{ item.travelTime }} åˆ†</span>
                        </div>
                        
                        <div @click="openMap(item.name)" 
                            :class="['card p-4 flex gap-4 cursor-pointer relative transition hover:shadow-md', item.category === 'Flight' ? 'bg-gradient-to-r from-blue-50 to-purple-50' : 'bg-white']">
                            
                            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center flex-shrink-0 text-chiika-blue text-xl">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-lg leading-tight text-gray-700">{{ item.name }}</h3>
                                    <button @click.stop="deleteItem(idx)" class="text-gray-300 hover:text-red-400 p-2 -mr-2 -mt-2 z-20">
                                        <i class="fa-solid fa-trash-can text-sm"></i>
                                    </button>
                                </div>
                                <div v-if="item.hours" class="text-xs mt-1 text-gray-500">
                                    <i class="fa-regular fa-clock mr-1"></i> {{ item.hours }}
                                </div>
                                <div v-if="item.ticket" class="text-xs mt-1 text-pink-500 font-bold">
                                    <i class="fa-solid fa-ticket mr-1"></i> {{ item.ticket }}
                                </div>
                                <p class="text-xs mt-2 text-gray-500 leading-relaxed">{{ item.note }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="showAddModal = true" class="fixed bottom-28 right-6 w-14 h-14 bg-chiika-blue text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-30 hover:bg-blue-300 transition-colors transform active:scale-95 animate-bounce-slow">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'food'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-orange-300">
                    é™„è¿‘åƒåƒå–å–
                    <span class="text-xs font-normal text-gray-400 ml-2 block mt-1">åŸºæ–¼è¡Œç¨‹åœ°é»æ¨è–¦</span>
                </h2>
                
                <div class="grid grid-cols-1 gap-4">
                    <a v-for="(rec, idx) in recommendedFood" :key="idx" 
                       :href="rec.mapLink" target="_blank"
                       class="card p-0 flex flex-row overflow-hidden h-28 cursor-pointer hover:opacity-90 transition relative">
                        <div class="w-28 bg-gray-200 flex-shrink-0 relative">
                             <div class="absolute inset-0 flex items-center justify-center bg-orange-100 text-orange-300">
                                <i :class="rec.icon" class="text-3xl"></i>
                            </div>
                        </div>
                        <div class="p-3 flex flex-col justify-center flex-1">
                            <div class="flex justify-between">
                                <span class="text-xs bg-orange-100 text-orange-500 px-2 py-0.5 rounded-md font-bold mb-1 w-max">{{ rec.type }}</span>
                                <span class="text-xs text-gray-400"><i class="fa-solid fa-location-dot mr-1"></i>{{ rec.area }}</span>
                            </div>
                            <h3 class="font-bold text-gray-700 leading-tight mb-1">{{ rec.name }}</h3>
                            <p class="text-xs text-gray-500 line-clamp-2">{{ rec.desc }}</p>
                        </div>
                        <div class="absolute bottom-2 right-2 text-blue-400 text-xs">
                            <i class="fa-solid fa-map-location-dot mr-1"></i>å°èˆª
                        </div>
                    </a>
                </div>
                <div class="mt-8 text-center">
                    <button @click="openGoogleMapSearch" class="bg-white border-2 border-orange-300 text-orange-400 px-6 py-3 rounded-full font-bold shadow-sm hover:bg-orange-50 transition">
                        <i class="fa-brands fa-google mr-2"></i>æœå°‹é™„è¿‘ç¾é£Ÿ
                    </button>
                </div>
            </div>

            <div v-if="currentTab === 'japanese'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-green-300">å³æ™‚æ•‘å‘½æ—¥æ–‡</h2>
                
                <div class="grid grid-cols-1 gap-3">
                    <div v-for="(phrase, idx) in japanesePhrases" :key="idx" 
                         @click="speak(phrase.jp)"
                         class="card p-4 flex items-center justify-between cursor-pointer hover:bg-green-50 active:scale-95 transition border-l-4 border-transparent hover:border-green-300">
                        <div>
                            <div class="font-bold text-lg text-gray-800">{{ phrase.jp }}</div>
                            <div class="text-xs text-gray-400">{{ phrase.romaji }}</div>
                            <div class="text-sm text-green-600 font-medium mt-1">{{ phrase.tw }}</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 shadow-sm">
                            <i class="fa-solid fa-volume-high"></i>
                        </div>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200 text-sm text-gray-600">
                    <i class="fa-solid fa-lightbulb text-yellow-500 mr-2"></i>å°æ’‡æ­¥ï¼šé»æ“Šå¡ç‰‡ï¼Œæ‰‹æ©Ÿæœƒç›´æ¥å”¸å‡ºä¾†çµ¦åº—å“¡è½å–”ï¼
                </div>
            </div>

            <div v-if="currentTab === 'prep'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-pink-300">è¡Œå‰æº–å‚™æ¸…å–®</h2>
                <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" 
                class="block w-full bg-gradient-to-r from-pink-400 to-red-400 text-white p-4 rounded-xl shadow-lg mb-6 flex items-center justify-between hover:opacity-90 transition transform active:scale-95">
                    <div class="flex items-center gap-3">
                        <div class="bg-white text-pink-500 w-10 h-10 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-qrcode text-xl"></i>
                        </div>
                        <div>
                            <div class="font-bold text-lg">Visit Japan Web</div>
                            <div class="text-xs opacity-90">å…¥å¢ƒæ—¥æœ¬å¿…å¡«ï¼ŒæŒ‰æ­¤å‰å¾€</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right opacity-70"></i>
                </a>
                <div class="bg-white rounded-2xl shadow-sm p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-4 bg-chiika-yellow opacity-50"></div>
                    <div v-for="(item, idx) in prepList" :key="idx" class="notepad-item">
                        <input type="checkbox" v-model="item.checked" class="notepad-checkbox flex-shrink-0">
                        <span :class="['flex-1 text-sm font-medium transition', item.checked ? 'strikethrough' : 'text-gray-700']">{{ item.text }}</span>
                        <button @click="removePrepItem(idx)" class="text-gray-300 hover:text-red-400 p-2"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <input v-model="newPrepInput" @keyup.enter="addPrepItem" placeholder="æ–°å¢æº–å‚™é …ç›®..." class="flex-1 bg-gray-50 border-b-2 border-gray-200 p-2 text-sm outline-none focus:border-chiika-pink transition">
                        <button @click="addPrepItem" class="text-chiika-pink font-bold text-sm px-2">æ–°å¢</button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'shopping'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-blue-300">è³¼ç‰©é¡˜æœ›æ¸…å–®</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="card p-3 flex flex-col items-center relative group">
                        <button @click="shoppingList.splice(idx, 1)" class="absolute top-2 right-2 w-6 h-6 bg-white rounded-full text-red-400 shadow flex items-center justify-center z-10">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        <div class="w-full h-32 bg-gray-100 rounded-lg mb-2 overflow-hidden flex items-center justify-center">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <i v-else class="fa-regular fa-image text-gray-300 text-3xl"></i>
                        </div>
                        <div class="font-bold text-sm text-center w-full truncate text-gray-700">{{ item.name }}</div>
                    </div>
                    <div @click="showShopModal = true" class="card p-3 flex flex-col items-center justify-center min-h-[160px] cursor-pointer border-2 border-dashed border-gray-300 hover:border-pink-300 bg-transparent shadow-none transition">
                        <i class="fa-solid fa-plus text-3xl text-gray-300"></i>
                        <div class="text-xs text-gray-400 mt-2">æ–°å¢å•†å“</div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'expenses'">
                <div class="flex bg-white rounded-full p-1 mb-6 shadow-sm">
                    <button @click="expenseMode = 'personal'" :class="['flex-1 py-2 rounded-full text-sm font-bold transition', expenseMode === 'personal' ? 'bg-chiika-yellow text-gray-700 shadow-sm' : 'text-gray-400 hover:bg-gray-50']">å€‹äººè¨˜å¸³</button>
                    <button @click="expenseMode = 'split'" :class="['flex-1 py-2 rounded-full text-sm font-bold transition', expenseMode === 'split' ? 'bg-chiika-pink text-white shadow-sm' : 'text-gray-400 hover:bg-gray-50']">åˆ†å¸³è¡¨</button>
                </div>

                <div v-if="expenseMode === 'personal'">
                    <div class="bg-chiika-yellow text-gray-700 p-6 rounded-2xl mb-4 text-center shadow-lg relative overflow-hidden">
                        <i class="fa-solid fa-coins absolute -bottom-4 -right-4 text-6xl text-yellow-200 opacity-50"></i>
                        <div class="text-sm opacity-80">å€‹äººç¸½èŠ±è²» (JPY)</div>
                        <div class="text-4xl font-bold mt-1">Â¥ {{ totalExpenses.toLocaleString() }}</div>
                    </div>
                    <div class="space-y-3">
                        <div v-for="(exp, idx) in expenses" :key="idx" class="card p-3 flex justify-between items-center relative group">
                            <button @click="expenses.splice(idx, 1)" class="absolute -left-2 -top-2 w-6 h-6 bg-red-400 text-white rounded-full text-xs hidden group-hover:flex items-center justify-center shadow-md"><i class="fa-solid fa-xmark"></i></button>
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i :class="getCategoryIcon(exp.category)"></i></div>
                                <div>
                                    <div class="font-bold text-sm text-gray-700">{{ exp.name }}</div>
                                    <div class="text-xs text-gray-400">{{ exp.date }} Â· {{ exp.payment }}</div>
                                </div>
                            </div>
                            <div class="font-bold text-gray-700">Â¥{{ parseInt(exp.amount).toLocaleString() }}</div>
                        </div>
                    </div>
                    <button @click="showExpenseModal = true" class="fixed bottom-28 right-6 w-14 h-14 bg-yellow-400 text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-30 transition transform active:scale-95"><i class="fa-solid fa-plus"></i></button>
                </div>

                <div v-if="expenseMode === 'split'">
                    <div class="mb-4 bg-white p-4 rounded-xl shadow-sm border border-pink-100">
                        <div class="flex justify-between items-center mb-3">
                            <div class="text-sm text-gray-700 font-bold">åˆ†å¸³æˆå“¡è¨­å®š</div>
                            <button @click="saveMembers" class="text-xs text-pink-500 font-bold" v-if="isMembersChanged">å„²å­˜è¨­å®š</button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <div v-for="(member, idx) in splitMembers" :key="idx" class="bg-pink-50 px-3 py-1 rounded-full text-sm shadow-sm flex items-center gap-2 border border-pink-200">
                                <span class="text-gray-700">{{ member }}</span>
                                <button @click="removeMember(idx)" class="text-pink-300 hover:text-red-500 text-xs"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                            <button @click="addMember" class="px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-500 hover:bg-gray-200 transition border border-gray-200 border-dashed">
                                <i class="fa-solid fa-plus mr-1"></i>æ–°å¢
                            </button>
                        </div>
                    </div>

                    <h3 class="font-bold text-chiika-text mb-3 pl-2 border-l-4 border-pink-300">å…¬æ¬¾æ”¯å‡ºè¨˜éŒ„</h3>
                    <div class="space-y-3">
                        <div v-for="(bill, idx) in splitBills" :key="idx" class="card p-4 border border-pink-50 relative">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-bold text-lg text-gray-700">{{ bill.item }}</div>
                                <div class="font-bold text-pink-500">Â¥{{ parseInt(bill.amount).toLocaleString() }}</div>
                            </div>
                            <div class="flex justify-between items-center text-xs text-gray-500 bg-gray-50 p-2 rounded-lg">
                                <div class="flex items-center gap-1">
                                    <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">å…ˆå¢Š</span>
                                    <span class="font-bold text-gray-700">{{ bill.payer }}</span>
                                </div>
                                <button @click="splitBills.splice(idx, 1)" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <div v-if="splitBills.length === 0" class="text-center text-gray-400 text-sm py-8 bg-white rounded-2xl border-2 border-dashed border-gray-200">
                            ç›®å‰æ²’æœ‰åˆ†å¸³è¨˜éŒ„<br>é»æ“Šå³ä¸‹è§’æ–°å¢
                        </div>
                    </div>
                    <button @click="showSplitModal = true" class="fixed bottom-28 right-6 w-14 h-14 bg-chiika-pink text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-30 transition transform active:scale-95"><i class="fa-solid fa-hand-holding-dollar"></i></button>
                </div>
            </div>
        </div>

        <div class="floating-tabs hide-scrollbar">
            <button @click="currentTab = 'itinerary'" :class="['tab-btn', currentTab === 'itinerary' ? 'active' : '']">
                <i class="fa-solid fa-map-location-dot"></i><span class="tab-label">è¡Œç¨‹</span>
            </button>
            <button @click="currentTab = 'food'" :class="['tab-btn', currentTab === 'food' ? 'active' : '']">
                <i class="fa-solid fa-utensils"></i><span class="tab-label">åƒå–</span>
            </button>
            <button @click="currentTab = 'prep'" :class="['tab-btn', currentTab === 'prep' ? 'active' : '']">
                <i class="fa-solid fa-suitcase-rolling"></i><span class="tab-label">è¡Œå‰</span>
            </button>
            <button @click="currentTab = 'shopping'" :class="['tab-btn', currentTab === 'shopping' ? 'active' : '']">
                <i class="fa-solid fa-basket-shopping"></i><span class="tab-label">è³¼ç‰©</span>
            </button>
            <button @click="currentTab = 'expenses'" :class="['tab-btn', currentTab === 'expenses' ? 'active' : '']">
                <i class="fa-solid fa-sack-dollar"></i><span class="tab-label">èŠ±è²»</span>
            </button>
            <button @click="currentTab = 'japanese'" :class="['tab-btn', currentTab === 'japanese' ? 'active' : '']">
                <i class="fa-solid fa-comment-dots"></i><span class="tab-label">æ•‘å‘½</span>
            </button>
        </div>

        <div v-if="showAddModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-center text-gray-700">æ–°å¢è¡Œç¨‹è‡³ <span class="text-chiika-pink">{{ tripDays[selectedDayIndex].week }}</span></h3>
                <div class="space-y-3">
                    <input v-model="newItem.name" placeholder="åç¨± (ä¾‹: æ¾€è°·Parco)" class="w-full p-2 border rounded-lg bg-gray-50 focus:border-chiika-blue outline-none">
                    <input v-model="newItem.hours" placeholder="æ™‚é–“ (ä¾‹: 14:00)" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                    <select v-model="newItem.category" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                        <option value="Sightseeing">ğŸ“¸ æ™¯é»</option>
                        <option value="Food">ğŸœ ç¾é£Ÿ</option>
                        <option value="Shopping">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="Transport">ğŸš… äº¤é€š</option>
                        <option value="Hotel">ğŸ¨ ä½å®¿</option>
                        <option value="Other">âœ¨ å…¶ä»–</option>
                    </select>
                    <textarea v-model="newItem.note" placeholder="å‚™è¨»..." class="w-full p-2 border rounded-lg bg-gray-50 outline-none h-20"></textarea>
                    
                    <div class="flex gap-2 pt-2">
                        <button @click="showAddModal = false" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-600">å–æ¶ˆ</button>
                        <button @click="addItem" class="flex-1 py-2 bg-chiika-blue text-white rounded-lg shadow-md">æ–°å¢</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showShopModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
             <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-center text-gray-700">åŠ å…¥è³¼ç‰©è»Š</h3>
                <input v-model="newShopItem.name" placeholder="å•†å“åç¨±" class="w-full p-2 border rounded-lg mb-3 bg-gray-50 focus:border-pink-300 outline-none">
                <label class="block w-full p-4 border-2 border-dashed border-gray-300 rounded-lg text-center text-gray-400 cursor-pointer hover:bg-gray-50 hover:border-pink-300 transition">
                    <i class="fa-solid fa-camera mb-1 text-2xl"></i><br>ä¸Šå‚³åœ–ç‰‡
                    <input type="file" @change="handleImageUpload" class="hidden">
                </label>
                <div v-if="newShopItem.image" class="mt-2 text-center text-xs text-green-500 font-bold">å·²é¸æ“‡åœ–ç‰‡</div>
                <div class="flex gap-2 mt-4">
                    <button @click="showShopModal = false" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-600">å–æ¶ˆ</button>
                    <button @click="addShopItem" class="flex-1 py-2 bg-pink-400 text-white rounded-lg shadow-md">ç¢ºå®š</button>
                </div>
            </div>
        </div>

        <div v-if="showExpenseModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-center text-gray-700">å€‹äººè¨˜å¸³</h3>
                <div class="space-y-3">
                    <input v-model="newExpense.name" placeholder="é …ç›®åç¨±" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                    <input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡ (JPY)" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                    <div class="flex gap-2 pt-2">
                        <button @click="showExpenseModal = false" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-600">å–æ¶ˆ</button>
                        <button @click="addExpense" class="flex-1 py-2 bg-yellow-400 text-white rounded-lg shadow-md">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showSplitModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 border-4 border-chiika-pink shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-center text-gray-700">æ–°å¢å…¬æ¬¾æ”¯å‡º</h3>
                <div class="space-y-3">
                    <div class="text-xs text-gray-400 font-bold ml-1">èª°å…ˆå¢ŠéŒ¢ï¼Ÿ</div>
                    <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                        <button v-for="m in splitMembers" :key="m" @click="newSplit.payer = m"
                            :class="['px-3 py-1 rounded-full text-sm border whitespace-nowrap transition', newSplit.payer === m ? 'bg-chiika-pink text-white border-chiika-pink shadow-sm' : 'border-gray-300 text-gray-500']">
                            {{ m }}
                        </button>
                    </div>
                    <input v-model="newSplit.item" placeholder="é …ç›® (ä¾‹: ç§Ÿè»Šè²»)" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                    <input type="number" v-model="newSplit.amount" placeholder="ç¸½é‡‘é¡ (JPY)" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                    <div class="flex gap-2 pt-2">
                        <button @click="showSplitModal = false" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-600">å–æ¶ˆ</button>
                        <button @click="addSplitBill" class="flex-1 py-2 bg-chiika-pink text-white rounded-lg shadow-md">æ–°å¢è¨˜éŒ„</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const isMounted = ref(false);
            const currentTab = ref('itinerary');
            const selectedDayIndex = ref(0);
            const hasBanner = ref(true); // æª¢æ¸¬åœ–ç‰‡æ˜¯å¦å­˜åœ¨

            // å¤©æ°£ç›¸é—œç‹€æ…‹
            const weatherIcon = ref('ğŸŒ¤ï¸');
            const currentTemp = ref('--');
            const rainChance = ref('0');
            const weatherDesc = ref('è®€å–ä¸­...');
            const fujiVisibility = ref('??');
            const weatherBackground = ref('background: linear-gradient(to right, #60a5fa, #a78bfa)');

            // è³‡æ–™å„²å­˜ Key
            const STORAGE_KEY = 'tokyo_trip_v2';

            // UI State
            const showAddModal = ref(false);
            const showShopModal = ref(false);
            const showExpenseModal = ref(false);
            const showSplitModal = ref(false);
            const expenseMode = ref('personal');
            const isMembersChanged = ref(false);

            const tripDays = [
                { date: '2026-03-27', week: 'Fri', dateNum: '27' },
                { date: '2026-03-28', week: 'Sat', dateNum: '28' },
                { date: '2026-03-29', week: 'Sun', dateNum: '29' },
                { date: '2026-03-30', week: 'Mon', dateNum: '30' },
                { date: '2026-03-31', week: 'Tue', dateNum: '31' },
                { date: '2026-04-01', week: 'Wed', dateNum: '01' },
                { date: '2026-04-02', week: 'Thu', dateNum: '02' },
                { date: '2026-04-03', week: 'Fri', dateNum: '03' }
            ];

            // é è¨­è¡Œç¨‹ (å¦‚æœæ²’æœ‰å­˜æª”)
            const defaultItinerary = [
                 [ 
                    { id: 1, category: 'Flight', name: 'é…·èˆª TR898 èµ·é£›', hours: '06:40', note: 'æ¡ƒåœ’ç¬¬ä¸€èˆªå»ˆ', travelTime: 0, transportType: 'flight' },
                    { id: 2, category: 'Flight', name: 'æŠµé”æ±äº¬æˆç”°', hours: '10:40', note: 'æˆç”°ç¬¬ä¸€èˆªå»ˆ', travelTime: 240, transportType: 'flight' },
                    { id: 3, category: 'Sightseeing', name: 'æ™´ç©ºå¡”', hours: '10:00-21:00', ticket: 'Â¥2100', note: 'å¿…æ‹åœ°æ¨™', travelTime: 60, transportType: 'train' }
                ], [], [], [], [], [], [], [] 
            ];

            const itineraryData = ref(defaultItinerary);
            const shoppingList = ref([{ name: 'å‰ä¼Šå¡å“‡ç©å¶', image: '' }]);
            const prepList = ref([{ text: 'è­·ç…§ (æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)', checked: false }, { text: 'æ—¥å¹£ç¾é‡‘', checked: false }]);
            const expenses = ref([]);
            const splitMembers = ref(['æˆ‘', 'å°å…«', 'å…”å…”']);
            const splitBills = ref([]);

            // Models
            const newItem = ref({ name: '', category: 'Sightseeing', hours: '', ticket: '', note: '', travelTime: 15, transportType: 'walk' });
            const newShopItem = ref({ name: '', image: null });
            const newExpense = ref({ category: 'Food', name: '', amount: '', payment: 'ç¾é‡‘', date: '' });
            const newSplit = ref({ item: '', amount: '', payer: 'æˆ‘' });
            const newPrepInput = ref('');

            // å³æ™‚æ—¥æ–‡è³‡æ–™
            const japanesePhrases = [
                { jp: 'ã™ã¿ã¾ã›ã‚“', romaji: 'Sumimasen', tw: 'ä¸å¥½æ„æ€ / è«‹å•' },
                { jp: 'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™', romaji: 'Kore o onegaishimasu', tw: 'æˆ‘è¦é€™å€‹ (é»é¤ç”¨)' },
                { jp: 'ã„ãã‚‰ã§ã™ã‹ï¼Ÿ', romaji: 'Ikura desu ka?', tw: 'è«‹å•å¤šå°‘éŒ¢ï¼Ÿ' },
                { jp: 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', romaji: 'Okaikei o onegaishimasu', tw: 'æˆ‘è¦çµå¸³' },
                { jp: 'è¢‹ã¯ã„ã‚Šã¾ã›ã‚“', romaji: 'Fukuro wa irimasen', tw: 'ä¸ç”¨å¡‘è† è¢‹' },
                { jp: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', romaji: 'Toire wa doko desu ka?', tw: 'å»æ‰€åœ¨å“ªè£¡ï¼Ÿ' },
                { jp: 'åŠ©ã‘ã¦ãã ã•ã„', romaji: 'Tasukete kudasai', tw: 'è«‹æ•‘æ•‘æˆ‘ (ç·Šæ€¥)' },
                { jp: 'è‹±èªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹', romaji: 'Eigo menyu wa arimasu ka', tw: 'æœ‰è‹±æ–‡èœå–®å—ï¼Ÿ' }
            ];

            // æ¨è–¦ç¾é£Ÿè³‡æ–™
            const foodRecommendations = {
                'Tokyo': [
                    { name: 'AFURI æ‹‰éºµ', type: 'æŸšå­æ‹‰éºµ', area: 'åŸå®¿/å…­æœ¬æœ¨', desc: 'æ¸…çˆ½æŸšå­é¹½å‘³ï¼Œå¥³ç”Ÿæœ€æ„›', icon: 'fa-solid fa-bowl-food', mapLink: 'https://www.google.com/maps/search/AFURI+Tokyo' },
                    { name: 'HARBS', type: 'æ°´æœåƒå±¤', area: 'æ–°å®¿/æ¾€è°·', desc: 'è¶…å¤§ä»½é‡æ°´æœåƒå±¤è›‹ç³•ï¼Œå¿…åƒ', icon: 'fa-solid fa-cake-candles', mapLink: 'https://www.google.com/maps/search/HARBS+Tokyo' },
                    { name: 'ç‰›ã‹ã¤ã‚‚ã¨æ‘', type: 'ç‚¸ç‰›æ’', area: 'å„è™•', desc: 'è‡ªå·±ç”¨çŸ³æ¿çƒ¤çš„åŠç†Ÿç‚¸ç‰›æ’', icon: 'fa-solid fa-fire-burner', mapLink: 'https://www.google.com/maps/search/Gyukatsu+Motomura+Tokyo' }
                ],
                'Fuji': [
                    { name: 'Houtou Fudou', type: 'é¤ºé£¥éºµ', area: 'æ²³å£æ¹–', desc: 'å±±æ¢¨ç¸£é„‰åœŸæ–™ç†ï¼Œé›²æœµå»ºç¯‰è¶…å¯æ„›', icon: 'fa-solid fa-cloud', mapLink: 'https://www.google.com/maps/search/Houtou+Fudou' },
                    { name: 'å¯Œå£«å±±åå¸', type: 'åå¸', area: 'æ²³å£æ¹–', desc: 'åˆ‡é–‹å°±æ˜¯å¯Œå£«å±±å½¢ç‹€çš„ç”Ÿåå¸', icon: 'fa-solid fa-bread-slice', mapLink: 'https://www.google.com/maps/search/Fujisan+Shokupan' },
                    { name: 'Lake Bake', type: 'å’–å•¡å»³', area: 'å¤§çŸ³å…¬åœ’', desc: 'çœ‹è‘—å¯Œå£«å±±åƒéºµåŒ…å–å’–å•¡', icon: 'fa-solid fa-mug-hot', mapLink: 'https://www.google.com/maps/search/Lake+Bake+Kawaguchiko' }
                ],
                'Kamakura': [
                    { name: 'Bills', type: 'é¬†é¤…', area: 'ä¸ƒé‡Œæ¿±', desc: 'ä¸–ç•Œç¬¬ä¸€æ—©é¤ï¼Œç„¡æ•µæµ·æ™¯', icon: 'fa-solid fa-pancakes', mapLink: 'https://www.google.com/maps/search/Bills+Shichirigahama' },
                    { name: 'Caraway', type: 'å’–å“©', area: 'éŒå€‰', desc: 'æ’éšŠååº—ï¼Œæ¿ƒåšç³»æ—¥å¼å’–å“©', icon: 'fa-solid fa-spoon', mapLink: 'https://www.google.com/maps/search/Caraway+Curry+Kamakura' }
                ]
            };

            // Computed
            const currentDayItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
            const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
            
            // åˆ¤æ–·ç›®å‰æ˜¯å“ªä¸€å€ (ç”¨æ–¼å¤©æ°£èˆ‡ç¾é£Ÿæ¨è–¦)
            const currentLocationKey = computed(() => {
                const dayIndex = selectedDayIndex.value;
                if (dayIndex >= 2 && dayIndex <= 4) return 'Fuji'; // Day 3,4,5
                if (dayIndex === 5) return 'Kamakura'; // Day 6
                return 'Tokyo'; // Others
            });

            const locationName = computed(() => {
                const map = { 'Tokyo': 'æ±äº¬ Tokyo', 'Fuji': 'å¯Œå£«å±± Fuji', 'Kamakura': 'éŒå€‰ Kamakura' };
                return map[currentLocationKey.value];
            });

            const isFujiArea = computed(() => currentLocationKey.value === 'Fuji');

            const recommendedFood = computed(() => {
                return foodRecommendations[currentLocationKey.value] || foodRecommendations['Tokyo'];
            });

            // å­˜æª”é‚è¼¯
            const saveData = () => {
                const data = {
                    itinerary: itineraryData.value,
                    shopping: shoppingList.value,
                    prep: prepList.value,
                    expenses: expenses.value,
                    splitMembers: splitMembers.value,
                    splitBills: splitBills.value
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            };

            const loadData = () => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        itineraryData.value = parsed.itinerary || defaultItinerary;
                        shoppingList.value = parsed.shopping || [];
                        prepList.value = parsed.prep || [];
                        expenses.value = parsed.expenses || [];
                        splitMembers.value = parsed.splitMembers || ['æˆ‘'];
                        splitBills.value = parsed.splitBills || [];
                    } catch (e) { console.error('Load Error', e); }
                }
            };

            // Watchers è‡ªå‹•å­˜æª”
            watch([itineraryData, shoppingList, prepList, expenses, splitMembers, splitBills], () => {
                saveData();
            }, { deep: true });

            // Methods
            const changeDay = (index) => {
                selectedDayIndex.value = index;
                fetchWeather(); // åˆ‡æ›æ—¥æœŸæ™‚æ›´æ–°å¤©æ°£
            };

            const getCategoryIcon = (cat) => {
                const map = { 'Sightseeing': 'fa-camera', 'Food': 'fa-utensils', 'Shopping': 'fa-bag-shopping', 'Flight': 'fa-plane', 'Transport': 'fa-train-subway', 'Hotel': 'fa-hotel', 'Other': 'fa-star' };
                return map[cat] || 'fa-star';
            };
            const getTransportIcon = (type) => {
                const map = { 'walk': 'fa-person-walking', 'car': 'fa-car', 'train': 'fa-train-subway', 'bike': 'fa-bicycle', 'flight': 'fa-plane' };
                return map[type] || 'fa-person-walking';
            };

            const openMap = (keyword) => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword)}`, '_blank');
            };

            const openGoogleMapSearch = () => {
                const area = locationName.value.split(' ')[0]; // å–ä¸­æ–‡å
                window.open(`https://www.google.com/maps/search/${area}+ç¾é£Ÿ`, '_blank');
            };

            const speak = (text) => {
                const msg = new SpeechSynthesisUtterance();
                msg.text = text;
                msg.lang = 'ja-JP';
                window.speechSynthesis.speak(msg);
            };

            // è¡Œç¨‹ç·¨è¼¯åŠŸèƒ½
            const addItem = () => {
                if(!newItem.value.name) return;
                // ç¢ºä¿ç•¶å¤©é™£åˆ—å­˜åœ¨
                if (!itineraryData.value[selectedDayIndex.value]) {
                    itineraryData.value[selectedDayIndex.value] = [];
                }
                itineraryData.value[selectedDayIndex.value].push({ ...newItem.value, id: Date.now() });
                showAddModal.value = false;
                newItem.value = { name: '', category: 'Sightseeing', hours: '', ticket: '', note: '', travelTime: 15, transportType: 'walk' };
            };

            const deleteItem = (idx) => {
                if(confirm('ç¢ºå®šåˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ')) {
                    itineraryData.value[selectedDayIndex.value].splice(idx, 1);
                }
            };

            // åˆ†å¸³æˆå“¡ç®¡ç†
            const addMember = () => {
                const name = prompt('è«‹è¼¸å…¥æ–°æˆå“¡åå­—ï¼š');
                if (name) {
                    splitMembers.value.push(name);
                    isMembersChanged.value = true;
                }
            };
            const removeMember = (idx) => {
                if(confirm(`ç§»é™¤æˆå“¡ ${splitMembers.value[idx]}ï¼Ÿ`)) {
                    splitMembers.value.splice(idx, 1);
                    isMembersChanged.value = true;
                }
            };
            const saveMembers = () => {
                saveData(); // å¼·åˆ¶å­˜æª”
                isMembersChanged.value = false;
                alert('æˆå“¡å·²æ›´æ–°ï¼');
            };

            // åŒ¯å‡ºåŒ¯å…¥åŠŸèƒ½
            const exportData = () => {
                const dataStr = JSON.stringify(localStorage.getItem(STORAGE_KEY));
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'tokyo_trip_data.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = JSON.parse(e.target.result); // é€™è£¡è§£é–‹çš„æ˜¯ stringified JSON
                        // æœ‰æ™‚å€™ export æœƒå¤šåŒ…ä¸€å±¤ quoteï¼Œéœ€è¦æ³¨æ„
                        const actualData = typeof content === 'string' ? content : JSON.stringify(content);
                        localStorage.setItem(STORAGE_KEY, actualData);
                        loadData();
                        alert('è¡Œç¨‹åŒ¯å…¥æˆåŠŸï¼');
                    } catch (err) {
                        alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                    }
                };
                reader.readAsText(file);
            };
            
            // å…¶ä»–åŸæœ‰åŠŸèƒ½
            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => newShopItem.value.image = e.target.result;
                    reader.readAsDataURL(file);
                }
            };
            const addShopItem = () => {
                if(!newShopItem.value.name) return;
                shoppingList.value.push({ ...newShopItem.value });
                showShopModal.value = false;
                newShopItem.value = { name: '', image: null };
            };
            const addExpense = () => {
                if(!newExpense.value.amount) return;
                const today = new Date();
                const dateStr = `${(today.getMonth()+1).toString().padStart(2, '0')}/${today.getDate().toString().padStart(2, '0')}`;
                expenses.value.push({ ...newExpense.value, date: dateStr });
                showExpenseModal.value = false;
                newExpense.value = { category: 'Food', name: '', amount: '', payment: 'ç¾é‡‘', date: '' };
            };
            const addSplitBill = () => {
                if(!newSplit.value.amount || !newSplit.value.item) return;
                splitBills.value.push({ ...newSplit.value });
                showSplitModal.value = false;
                newSplit.value = { item: '', amount: '', payer: splitMembers.value[0] || 'æˆ‘' };
            };
            const addPrepItem = () => {
                if(!newPrepInput.value) return;
                prepList.value.push({ text: newPrepInput.value, checked: false });
                newPrepInput.value = '';
            };
            const removePrepItem = (idx) => prepList.value.splice(idx, 1);

            // ä¸²æ¥çœŸå¯¦æ°£è±¡ API (Open-Meteo)
            const fetchWeather = async () => {
                weatherDesc.value = 'æ›´æ–°ä¸­...';
                
                // å®šç¾©åº§æ¨™
                const coords = {
                    'Tokyo': { lat: 35.6895, lon: 139.6917 },
                    'Fuji': { lat: 35.3606, lon: 138.7274 },
                    'Kamakura': { lat: 35.3192, lon: 139.5467 }
                };
                
                const target = coords[currentLocationKey.value];
                
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${target.lat}&longitude=${target.lon}&current=temperature_2m,precipitation_probability,weather_code,cloud_cover&timezone=Asia%2FTokyo`);
                    const data = await res.json();
                    
                    const current = data.current;
                    currentTemp.value = current.temperature_2m;
                    rainChance.value = current.precipitation_probability || 0;
                    
                    // è§£æå¤©æ°£ä»£ç¢¼ç‚ºå‰ä¼Šå¡å“‡åœ–ç¤º
                    const code = current.weather_code;
                    if (code <= 3) { // æ™´å¤©/å¤šé›²
                        weatherIcon.value = 'ğŸŒ¤ï¸'; // é€™è£¡å¯ä»¥ç”¨å‰ä¼Šå¡å“‡åœ–ç‰‡é€£çµ <img src="...">
                        weatherDesc.value = 'æ˜¯å€‹å¥½å¤©æ°£ï¼';
                        weatherBackground.value = 'background: linear-gradient(to right, #60a5fa, #a78bfa)';
                    } else if (code <= 67) { // é›¨å¤©
                        weatherIcon.value = 'â˜”'; 
                        weatherDesc.value = 'å¥½åƒåœ¨å“­å“­...';
                        weatherBackground.value = 'background: linear-gradient(to right, #475569, #64748b)';
                    } else if (code >= 95) { // é›·é›¨
                        weatherIcon.value = 'âš¡';
                        weatherDesc.value = 'å“‡ï¼å¿«èº²èµ·ä¾†ï¼';
                        weatherBackground.value = 'background: linear-gradient(to right, #334155, #475569)';
                    } else {
                        weatherIcon.value = 'â˜ï¸';
                        weatherDesc.value = 'é™°é™°çš„æ„Ÿè¦º';
                    }

                    // ä¼°ç®—å¯Œå£«å±±èƒ½è¦‹åº¦ (è¶Šå°‘é›²è¶Šæ¸…æ¥š)
                    if (currentLocationKey.value === 'Fuji') {
                        const clouds = current.cloud_cover;
                        // ç°¡å–®å…¬å¼ï¼šèƒ½è¦‹åº¦ = 100 - é›²é‡ (ç¨å¾®åŠ æ¬Š)
                        let visibility = 100 - clouds;
                        if (visibility < 0) visibility = 0;
                        fujiVisibility.value = visibility;
                    }

                } catch (e) {
                    console.error("Weather API Error", e);
                    weatherDesc.value = 'ç„¡æ³•å–å¾—å¤©æ°£';
                }
            };

            onMounted(() => {
                loadData();
                isMounted.value = true;
                // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ç„¡å‰‡åˆ‡æ›æ¨£å¼
                const img = new Image();
                img.src = './banner.jpg';
                img.onerror = () => hasBanner.value = false;
                
                fetchWeather(); // åˆå§‹å¤©æ°£
            });

            return {
                isMounted, hasBanner,
                currentTab, selectedDayIndex, tripDays, changeDay,
                currentDayItinerary, locationName, isFujiArea,
                
                // Weather
                weatherIcon, currentTemp, rainChance, weatherDesc, fujiVisibility, weatherBackground,

                // Itinerary
                showAddModal, newItem, addItem, deleteItem, getCategoryIcon, getTransportIcon, openMap,
                
                // Food
                recommendedFood, openGoogleMapSearch,

                // Shopping & Prep
                shoppingList, showShopModal, newShopItem, handleImageUpload, addShopItem,
                prepList, newPrepInput, addPrepItem, removePrepItem,

                // Expenses & Split
                expenses, totalExpenses, showExpenseModal, newExpense, addExpense, expenseMode,
                splitMembers, splitBills, showSplitModal, newSplit, addMember, removeMember, saveMembers, isMembersChanged, addSplitBill,
                
                // Japanese
                japanesePhrases, speak,

                // Data
                exportData, importData
            };
        }
    }).mount('#app');
</script>

</body>
</html>
