<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (Ultimate V42.0 Chiikawa Sync)</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>

<script>
    window.tailwind = {
        config: {
            theme: {
                extend: {
                    colors: {'chii-pink':'#FFD1DC','chii-deep-pink':'#FF9EAC','chii-blue':'#A2D2FF','chii-yellow':'#FFF5BA','chii-text':'#5D4037'},
                    fontFamily: {sans:['Zen Maru Gothic','sans-serif']},
                    animation: {'wiggle':'wiggle 2s ease-in-out infinite','float':'float 3s ease-in-out infinite','fade-in':'fadeIn 0.5s ease-out forwards','pulse-fast':'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'bounce-soft': 'bounceSoft 2s infinite'},
                    keyframes: {
                        wiggle: {'0%,100%':{transform:'rotate(-3deg)'},'50%':{transform:'rotate(3deg)'}},
                        float: {'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-6px)'}},
                        fadeIn: {from:{opacity:0,transform:'translateY(10px)'},to:{opacity:1,transform:'translateY(0)'}},
                        bounceSoft: {'0%, 100%': {transform: 'translateY(0)'}, '50%': {transform: 'translateY(-5px)'}}
                    }
                }
            }
        }
    }
</script>

<style>
    /* V42.0 Core Styles - Chiikawa & Mobile Optimization */
    html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        font-family: "Zen Maru Gothic", sans-serif;
        color: #5D4037; overflow: hidden; background-color: #FFF0F5;
        -webkit-tap-highlight-color: transparent; overscroll-behavior: none;
    }
    #app-content {
        height: 100%; overflow-y: auto; overflow-x: hidden;
        padding-bottom: 180px; /* å¢åŠ åº•éƒ¨ç©ºé–“çµ¦æ‡¸æµ®å…ƒä»¶ */
        padding-top: env(safe-area-inset-top);
    }
    #fixed-bg {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1;
        background-color: #FFF0F5;
        background-image: radial-gradient(#FFD1DC 15%, transparent 16%), radial-gradient(#FFF5BA 15%, transparent 16%);
        background-size: 50px 50px; background-position: 0 0, 25px 25px; opacity: 0.6;
    }
    [v-cloak] { display: none !important; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }

    /* å‰ä¼Šå¡å“‡é¢¨æ ¼å¡ç‰‡ */
    .card {
        background: rgba(255,255,255,0.95);
        border-radius: 24px;
        box-shadow: 0 6px 20px rgba(255,158,172,0.15);
        border: 2px solid white;
        margin-bottom: 16px; position: relative;
        transform: translateZ(0); transition: all 0.2s ease;
    }
    .card:active { transform: scale(0.98); }

    /* æ‡¸æµ®æŒ‰éˆ•å„ªåŒ– */
    .fab-home {
        position: fixed; bottom: calc(20px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%);
        width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 26px; color: white; z-index: 90; border: 4px solid white;
        box-shadow: 0 8px 25px rgba(255,105,180,0.4); background: linear-gradient(135deg,#FF9EAC,#FFD1DC);
    }
    .fab-main {
        position: fixed; bottom: calc(100px + env(safe-area-inset-bottom)); right: 20px;
        width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 22px; color: white; z-index: 80; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    /* ç•¶æŠ˜åƒ¹åˆ¸å‡ºç¾æ™‚ï¼ŒæŒ‰éˆ•ä¸Šç§»é¿å…é®æ“‹ */
    .fab-main.lifted { bottom: calc(160px + env(safe-area-inset-bottom)); }

    /* V42 æŠ˜åƒ¹åˆ¸æ‡¸æµ®æ¡† - é˜²é®æ“‹å„ªåŒ– */
    .coupon-bar {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: rgba(255,255,255,0.98); backdrop-filter: blur(10px);
        padding: 12px 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom));
        border-t-left-radius: 24px; border-t-right-radius: 24px;
        border: 2px solid #FFD1DC; border-bottom: none; z-index: 200;
        box-shadow: 0 -5px 30px rgba(255,183,178,0.2);
        transform: translateY(0); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .coupon-bar.minimized { transform: translateY(calc(100% - 40px)); opacity: 0.9; }

    /* V42 èª°åœ¨ç·šä¸Š - å‰ä¼Šå¡å“‡é¢¨æ ¼ & é˜²é®æ“‹ */
    .online-status-widget {
        position: fixed; top: calc(70px + env(safe-area-inset-top)); right: 10px;
        z-index: 80; display: flex; flex-direction: column; align-items: flex-end; gap: 8px;
        pointer-events: none; /* è®“é»æ“Šç©¿é€ç©ºç™½è™• */
    }
    .online-user-pill {
        pointer-events: auto;
        background: rgba(255,255,255,0.9); backdrop-filter: blur(4px);
        padding: 4px 8px 4px 4px; border-radius: 50px;
        border: 2px solid #FFD1DC;
        display: flex; align-items: center; gap: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        animation: slideIn 0.3s ease-out;
        transform-origin: right center;
    }
    .online-dot {
        width: 10px; height: 10px; border-radius: 50%; background: #ccc;
        border: 2px solid white; box-shadow: 0 0 0 1px #eee;
        transition: all 0.3s;
    }
    .online-dot.active { background: #4ade80; box-shadow: 0 0 6px #4ade80; animation: pulse-fast 2s infinite; }
    
    /* æ­¡è¿é é¢å„ªåŒ– */
    .welcome-screen {
        position: fixed; inset: 0; z-index: 9999; background: #FFF0F5;
        transition: transform 0.6s cubic-bezier(0.7,0,0.3,1);
    }
    .welcome-screen.hidden-screen { transform: translateY(-100%); pointer-events: none; }

    /* æ«»èŠ±å‹•ç•« */
    .sakura {
        position: fixed; background: #FFB7B2; border-radius: 100% 0 100% 0; opacity: 0.6;
        animation: fall linear infinite; pointer-events: none; z-index: 1;
    }
    @keyframes fall { to { transform: translate(10vw, 105vh) rotate(360deg); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

    /* è¨ºæ–·æ¢ */
    .diagnostic-bar {
        position: fixed; top: env(safe-area-inset-top); left: 50%; transform: translateX(-50%);
        z-index: 9999; font-size: 10px; color: white; background: rgba(0,0,0,0.5);
        padding: 2px 8px; rounded-b-lg; pointer-events: none; opacity: 0; transition: opacity 0.3s;
    }
    .diagnostic-bar.visible { opacity: 1; }
</style>
</head>
<body>

<div id="fixed-bg"></div>
<div id="sakura-container"></div>

<div id="app" v-cloak class="h-full flex flex-col">

    <div :class="['diagnostic-bar', {'visible': showDebug}]">
        Ping: {{latency}}ms | Sync: {{isSaving}} | DB: {{dbConnected?'ğŸŸ¢':'ğŸ”´'}}
    </div>

    <div :class="['welcome-screen flex flex-col items-center justify-center relative overflow-hidden', isWelcomeClosed ? 'hidden-screen' : '']">
        <div class="absolute top-[-10%] right-[-10%] w-64 h-64 bg-yellow-200 rounded-full blur-3xl opacity-40 animate-pulse"></div>
        <div class="absolute bottom-[-10%] left-[-10%] w-64 h-64 bg-pink-300 rounded-full blur-3xl opacity-40 animate-pulse"></div>
        
        <div class="relative z-10 text-center px-8">
            <div class="inline-block bg-white/60 backdrop-blur px-4 py-1 rounded-full text-pink-500 text-xs font-black tracking-widest border border-pink-200 mb-6 shadow-sm">ULTIMATE V42.0</div>
            <h1 class="text-6xl font-black text-gray-700 mb-2 drop-shadow-sm tracking-widest">é—œæ±ä¹‹æ—…</h1>
            <p class="text-2xl text-pink-400 font-bold tracking-widest mb-10">2026.03.27</p>
            
            <div class="space-y-4 w-full max-w-xs mx-auto">
                <button @click="enterSite" class="w-full bg-gradient-to-r from-pink-400 to-rose-400 text-white font-black py-4 rounded-2xl shadow-xl shadow-pink-200/50 text-xl flex items-center justify-center gap-3 active:scale-95 transition transform border-2 border-white animate-bounce-soft">
                    <span class="text-2xl">ğŸŒ¸</span> é–‹å§‹æ—…ç¨‹
                </button>
                <div v-if="!isLoggedIn" class="text-xs text-gray-400 font-bold mt-4">
                    <i class="fa-solid fa-cloud-arrow-up animate-bounce"></i> é›²ç«¯åŒæ­¥ç³»çµ±æº–å‚™å°±ç·’
                </div>
                <div v-else class="text-xs text-green-500 font-bold mt-4 bg-green-50 py-1 px-3 rounded-full inline-block border border-green-200">
                    <i class="fa-solid fa-link"></i> å·²é€£ç·šè‡³ Firebase
                </div>
            </div>
        </div>
    </div>

    <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-[60px] bg-[#FFF0F5]/90 backdrop-blur-xl z-40 flex items-center justify-between px-4 border-b border-pink-100 shadow-sm pt-[env(safe-area-inset-top)] transition-all">
        <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow-md border border-pink-50 active:scale-90 transition"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="font-black text-gray-700 text-lg flex items-center gap-2"><i class="fa-solid fa-sakura text-pink-300"></i> {{getPageTitle(currentView)}}</h1>
        <div class="w-10"></div> </div>
    <div v-if="currentView !== 'menu'" class="h-[60px] pt-[env(safe-area-inset-top)] shrink-0"></div>

    <div v-if="!isGuest && currentView !== 'menu'" class="online-status-widget">
        <div v-for="u in activeUsersList" :key="u.id" class="online-user-pill">
            <img v-if="u.avatar" :src="u.avatar" class="w-6 h-6 rounded-full object-cover border border-white">
            <span v-else class="w-6 h-6 rounded-full bg-pink-100 flex items-center justify-center text-xs border border-white">{{u.icon}}</span>
            <span class="text-[10px] font-bold text-gray-600 mr-1">{{u.name}}</span>
            <div class="online-dot active"></div>
        </div>
    </div>

    <div id="app-content" class="flex-1">

        <div v-if="currentView==='menu'" class="p-6 pt-12 animate-fade-in">
            <div class="flex justify-between items-center pt-[env(safe-area-inset-top)] mb-8">
                <div>
                    <h2 class="text-3xl font-black text-gray-700">æ—…ç¨‹ä¸­å¿ƒ</h2>
                    <p class="text-sm text-gray-400 font-bold mt-1">é‚„æœ‰ {{daysUntilTrip}} å¤©å‡ºç™¼</p>
                </div>
                <div class="flex items-center gap-2" @click="showPersonaModal=true">
                    <div class="text-right">
                        <div class="text-xs font-bold text-gray-400">ç•¶å‰èº«åˆ†</div>
                        <div class="font-black text-pink-500 text-lg">{{currentUser?.name || 'è¨ªå®¢'}}</div>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-white border-2 border-pink-200 shadow-md overflow-hidden p-0.5">
                        <img v-if="currentUser?.avatar" :src="currentUser.avatar" class="w-full h-full rounded-full object-cover">
                        <div v-else class="w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-xl">{{currentUser?.icon || 'ğŸ‘¤'}}</div>
                    </div>
                </div>
            </div>

            <div v-if="smartReminders.length > 0" class="mb-8 bg-white/80 backdrop-blur border border-white rounded-[24px] p-5 shadow-lg relative overflow-hidden group">
                 <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-yellow-300 to-orange-400"></div>
                 <div class="space-y-2">
                    <div v-for="(alert, i) in smartReminders" :key="i" class="flex items-start gap-3">
                        <div class="bg-yellow-100 text-yellow-600 w-6 h-6 rounded-full flex items-center justify-center text-xs shrink-0 mt-0.5"><i class="fa-solid fa-bell"></i></div>
                        <div class="text-sm font-bold text-gray-600 leading-tight">{{alert}}</div>
                    </div>
                 </div>
            </div>

            <div class="grid grid-cols-3 gap-x-4 gap-y-8 px-2 pb-32">
                <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition duration-300 group" @click="currentView=app.view">
                    <div class="w-[72px] h-[72px] rounded-[28px] flex items-center justify-center text-3xl text-white shadow-lg border-[3px] border-white relative overflow-hidden transition-transform group-hover:-translate-y-1" :class="app.bgClass">
                        <i :class="app.icon"></i>
                        <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition"></div>
                    </div>
                    <span class="text-sm font-bold mt-3 text-gray-600 group-hover:text-pink-500 transition">{{app.name}}</span>
                </div>
            </div>
            
            <div class="text-center">
                 <button @click="isWelcomeClosed=false" class="text-xs text-gray-300 font-bold border-b border-gray-200 pb-1">è¿”å›å°é¢</button>
            </div>
        </div>

        <div v-if="currentView==='itinerary'" class="px-5 py-4 animate-fade-in">
            <div class="flex overflow-x-auto gap-3 mb-6 hide-scrollbar sticky top-0 bg-[#FFF0F5]/95 z-30 py-3 -mx-5 px-5 backdrop-blur-md">
                 <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-5 py-2.5 rounded-2xl text-sm font-black border-2 transition shrink-0 shadow-sm flex flex-col items-center min-w-[65px]',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400 shadow-pink-200':'bg-white text-gray-300 border-white']"><span>{{d.week}}</span><span class="text-[10px] mt-0.5 opacity-80">{{d.title}}</span></button>
            </div>
            
            <div v-if="[2,3].includes(selectedDayIndex)" class="flex justify-center mb-6">
                <div class="bg-white p-1 rounded-full border border-pink-100 shadow-sm flex">
                    <button @click="itineraryMode='normal'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='normal'?'bg-pink-400 text-white':'text-gray-400']">ä¸€èˆ¬</button>
                    <button @click="itineraryMode='drive'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='drive'?'bg-green-500 text-white':'text-gray-400']"><i class="fa-solid fa-car mr-1"></i> è‡ªé§•</button>
                </div>
            </div>

            <div class="space-y-4 pb-20">
                <div v-for="(item,idx) in getCurrentItinerary()" :key="idx" class="relative group">
                    <div class="card p-4 !mb-0 border-l-4" :class="itineraryMode==='drive'?'border-l-green-400':'border-l-pink-300'" @click="!isGuest && openEditItineraryModal(item, idx)">
                        <div class="flex gap-4">
                            <div class="flex flex-col items-center min-w-[50px] pt-1">
                                <span class="text-xs font-black text-gray-400 mb-1">{{item.hours}}</span>
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm border" :class="itineraryMode==='drive'?'bg-green-50 text-green-500 border-green-100':'bg-pink-50 text-pink-400 border-pink-100'"><i :class="getIconByCategory(item.category)"></i></div>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                                <p class="text-sm text-gray-500 font-medium mb-2">{{item.note}}</p>
                                <div class="flex gap-2 flex-wrap">
                                    <a :href="getMapLink(item.mapKeyword, item.name)" target="_blank" @click.stop class="inline-flex items-center gap-1 text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded-md font-bold border border-blue-100 hover:bg-blue-100"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                                    <a v-if="item.parkingLink" :href="getMapLink(item.parkingLink)" target="_blank" @click.stop class="inline-flex items-center gap-1 text-[10px] bg-green-50 text-green-600 px-2 py-1 rounded-md font-bold border border-green-200 hover:bg-green-100"><i class="fa-solid fa-square-parking"></i> åœè»Šå ´</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="idx < getCurrentItinerary().length - 1" class="ml-[25px] h-8 border-l-2 border-dashed my-1 flex items-center pl-4" :class="itineraryMode==='drive'?'border-green-200':'border-pink-200'">
                        <span v-if="item.travelTime" class="text-[10px] font-bold px-2 py-0.5 rounded" :class="itineraryMode==='drive'?'bg-green-50 text-green-600':'bg-pink-50 text-pink-400'">{{item.travelTime}}</span>
                    </div>
                </div>
                <button v-if="!isGuest" @click="openAddItineraryModal" class="w-full py-4 mt-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white/50 transition"><i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹</button>
            </div>
        </div>

        <div v-if="currentView==='money'" class="px-5 py-4 animate-fade-in">
             <div class="flex gap-2 mb-4 justify-center bg-white/50 p-1 rounded-full w-max mx-auto shadow-sm">
                  <button @click="moneyTab='record'" :class="['px-6 py-2 rounded-full font-bold transition text-xs',moneyTab==='record'?'bg-yellow-400 text-white shadow':'text-gray-400']">æˆ‘çš„ç§å¸³</button>
                  <button @click="moneyTab='split'" :class="['px-6 py-2 rounded-full font-bold transition text-xs',moneyTab==='split'?'bg-blue-400 text-white shadow':'text-gray-400']">å…¬æ¬¾åˆ†å¸³</button>
             </div>
             <div class="flex justify-end mb-4"><div class="text-[10px] font-bold text-gray-400 bg-white px-3 py-1 rounded-full border">åŒ¯ç‡: 1 JPY â‰ˆ <input v-model="exchangeRate" class="w-10 text-center font-black text-pink-500 outline-none" type="number" step="0.001"> TWD</div></div>

             <div v-if="moneyTab==='record'">
                 <div class="card p-5 bg-gradient-to-br from-yellow-300 to-orange-400 text-white border-none mb-4">
                    <div class="text-xs font-bold opacity-80 mb-1">ç§äººç¸½æ”¯å‡º</div>
                    <div class="text-4xl font-black">NT$ {{Math.round(myPrivateTotalTWD).toLocaleString()}}</div>
                 </div>
                 <div class="space-y-3 pb-20">
                    <div v-for="exp in myPrivateExpenses" :key="exp.id" class="card p-3 flex justify-between items-center !mb-0 border-l-4 border-yellow-300">
                        <div><div class="font-bold text-gray-800">{{exp.name}}</div><div class="text-[10px] text-gray-400">{{getPaymentIcon(exp.method)}} {{exp.date}}</div></div>
                        <div class="text-right font-black text-gray-700">{{exp.currency}} {{exp.amount}}<button @click="deleteExpense(exp.id)" class="ml-3 text-red-300 text-xs"><i class="fa-solid fa-trash"></i></button></div>
                    </div>
                 </div>
                 <button @click="openExpenseModal('private')" class="fab-main bg-yellow-400 text-white"><i class="fa-solid fa-plus"></i></button>
             </div>

             <div v-if="moneyTab==='split'">
                 <div class="card p-4 border-l-4 border-blue-400 bg-blue-50/30 mb-6">
                     <h3 class="font-bold text-blue-500 mb-3 text-sm"><i class="fa-solid fa-scale-balanced"></i> æ™ºæ…§çµç®— (TWD)</h3>
                     <div v-if="settlements.length===0" class="text-center text-xs text-gray-400 py-2">ç›®å‰æ”¶æ”¯å¹³è¡¡ âœ¨</div>
                     <div v-else class="space-y-2">
                         <div v-for="s in settlements" class="flex justify-between items-center bg-white p-2 rounded-lg shadow-sm border border-blue-100 text-xs">
                             <span class="font-bold text-gray-600">{{getUserName(s.from)}} <i class="fa-solid fa-arrow-right text-blue-300 mx-1"></i> {{getUserName(s.to)}}</span>
                             <span class="font-black text-blue-600">${{s.amount.toLocaleString()}}</span>
                         </div>
                     </div>
                 </div>
                 <div class="space-y-3 pb-20">
                    <div v-for="exp in groupExpenses" :key="exp.id" class="card p-3 !mb-0 border-l-4 border-blue-300 relative">
                        <div class="flex justify-between mb-1"><div class="font-bold text-gray-800 text-sm">{{exp.name}}</div><div class="font-black text-blue-500 text-sm">{{exp.currency}} {{exp.amount}}</div></div>
                        <div class="flex justify-between items-end">
                            <div class="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded">{{getUserName(exp.whoPaid)}} ä»˜æ¬¾ <i class="fa-solid fa-caret-right"></i> {{exp.forWhom.length}}äººåˆ†</div>
                            <button v-if="exp.whoPaid===currentUser.id" @click="deleteExpense(exp.id)" class="text-red-300 text-xs"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                 </div>
                 <button @click="openExpenseModal('split')" class="fab-main bg-blue-400 text-white"><i class="fa-solid fa-plus"></i></button>
             </div>
        </div>

        <div v-if="currentView==='weather'" class="px-5 py-4 animate-fade-in">
             <div class="bg-gradient-to-br from-pink-400 to-rose-400 text-white p-5 rounded-[24px] shadow-lg mb-6 relative overflow-hidden">
                 <div class="relative z-10">
                     <h3 class="font-black text-lg mb-4 flex items-center gap-2"><i class="fa-solid fa-satellite-dish animate-pulse"></i> å³æ™‚æ°£è±¡è¡›æ˜Ÿé€£ç·š</h3>
                     <div class="grid grid-cols-1 gap-3">
                         <div v-for="w in weatherData" :key="w.name" class="bg-white/20 backdrop-blur-md p-3 rounded-xl border border-white/30 flex justify-between items-center">
                             <div>
                                 <div class="text-xs font-bold opacity-80">{{w.name_zh}}</div>
                                 <div class="text-3xl font-black mt-1">{{w.temp}}<span class="text-sm align-top">Â°C</span></div>
                             </div>
                             <div class="text-right">
                                 <div class="text-2xl mb-1">{{w.icon}}</div>
                                 <div class="text-[10px] font-bold bg-white/30 px-2 py-1 rounded-full">{{getClothingAdvice(parseFloat(w.temp))}}</div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
             
             <div class="card p-4 border-pink-200 bg-pink-50/50">
                 <h3 class="font-black text-pink-500 mb-3 text-sm text-center">ğŸŒ¸ 2026 æ«»èŠ±æ»¿é–‹é æ¸¬</h3>
                 <div class="grid grid-cols-3 gap-2 text-center">
                     <div class="bg-white p-2 rounded-lg shadow-sm border border-pink-100"><div class="text-[10px] text-gray-400">æ±äº¬</div><div class="font-black text-pink-500">3/22</div></div>
                     <div class="bg-white p-2 rounded-lg shadow-sm border border-pink-100"><div class="text-[10px] text-gray-400">éŒå€‰</div><div class="font-black text-pink-500">3/25</div></div>
                     <div class="bg-white p-2 rounded-lg shadow-sm border border-pink-100"><div class="text-[10px] text-gray-400">å¯Œå£«å±±</div><div class="font-black text-pink-500">4/10</div></div>
                 </div>
             </div>
        </div>

        <div v-if="currentView==='shopping'" class="px-5 py-4 animate-fade-in">
             <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
                 <button v-for="cat in ['cosme','ldk','souvenir']" @click="shopCat=cat" :class="['px-4 py-2 rounded-full font-bold text-xs whitespace-nowrap transition', shopCat===cat?'bg-pink-400 text-white shadow':'bg-white text-gray-400']">{{{'cosme':'è—¥å¦','ldk':'LDKæ¨è–¦','souvenir':'ä¼´æ‰‹ç¦®'}[cat]}}</button>
             </div>
             
             <div class="grid grid-cols-2 gap-4 pb-32">
                 <div v-for="(item,idx) in shopping[shopCat]" :key="idx" class="card !p-0 border-0 shadow-lg relative group overflow-hidden">
                     <div class="h-28 bg-gray-100 relative"><img :src="item.img || getImgPlaceholder(item.name)" class="w-full h-full object-cover" @error="handleImgError"></div>
                     <div class="p-3">
                         <div class="font-bold text-gray-800 text-xs mb-2 line-clamp-1">{{item.name}}</div>
                         <a :href="item.link || getSearchLink(item.name)" target="_blank" class="block w-full text-center bg-pink-50 text-pink-500 text-[10px] py-1.5 rounded font-bold hover:bg-pink-100">æœå°‹</a>
                     </div>
                     <button v-if="!isGuest" @click="shopping[shopCat].splice(idx,1);saveData()" class="absolute top-1 right-1 w-6 h-6 bg-white/90 rounded-full text-red-400 shadow flex items-center justify-center"><i class="fa-solid fa-times text-xs"></i></button>
                 </div>
             </div>
             
             <button v-if="!isGuest" @click="openAddShopModal" class="fab-main bg-purple-400 text-white" :class="{'lifted': !couponBarMinimized}"><i class="fa-solid fa-plus"></i></button>
             
             <div :class="['coupon-bar', {'minimized': couponBarMinimized}]">
                 <div class="absolute -top-10 right-4">
                     <button @click="couponBarMinimized = !couponBarMinimized" class="bg-white border-2 border-pink-200 text-pink-400 w-8 h-8 rounded-full shadow-md flex items-center justify-center animate-bounce-soft">
                         <i class="fa-solid" :class="couponBarMinimized ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                     </button>
                 </div>
                 <button @click="showCouponModal=true" class="w-full bg-gradient-to-r from-red-500 to-pink-600 text-white font-black py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition">
                     <i class="fa-solid fa-ticket animate-pulse"></i> 
                     <span>ğŸ‡¯ğŸ‡µ æ¿€çœæŠ˜åƒ¹åˆ¸ ({{coupons.length}})</span>
                 </button>
             </div>
        </div>

        <div v-if="currentView==='food' || currentView==='photo'" class="px-5 py-4 animate-fade-in">
             <div class="flex gap-2 mb-4 justify-center"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="currentLoc=loc" :class="['px-4 py-2 rounded-full font-bold text-xs transition', currentLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc]}}</button></div>
             <div class="grid grid-cols-1 gap-4 pb-20">
                 <div v-for="(item,idx) in spots[currentView][currentLoc]" :key="idx" class="card !p-0 border-0 shadow-lg overflow-hidden relative">
                     <div class="h-40 bg-gray-100"><img :src="item.img || getImgPlaceholder(item.name)" class="w-full h-full object-cover" @error="handleImgError"></div>
                     <div class="p-4">
                         <div class="flex justify-between items-center mb-1">
                             <h3 class="font-black text-gray-800 text-lg">{{item.name}}</h3>
                             <span v-if="currentView==='food'" :class="['text-[10px] px-2 py-1 rounded-full font-bold', item.reserve?'bg-red-100 text-red-500':'bg-green-100 text-green-500']">{{item.reserve?'éœ€è¨‚ä½':'å…è¨‚ä½'}}</span>
                         </div>
                         <p class="text-sm text-gray-500 font-bold mb-3">{{item.desc}}</p>
                         <div v-if="item.note" class="bg-yellow-50 p-2 rounded text-xs text-yellow-800 mb-3 border border-yellow-100"><i class="fa-solid fa-star mr-1"></i>{{item.note}}</div>
                         <a :href="getMapLink(item.link, item.name)" target="_blank" class="block w-full text-center bg-gray-100 text-gray-600 font-bold py-2 rounded-lg text-xs hover:bg-orange-400 hover:text-white transition">å°èˆª</a>
                     </div>
                     <button v-if="!isGuest" @click="spots[currentView][currentLoc].splice(idx,1);saveData()" class="absolute top-2 right-2 w-8 h-8 bg-white/90 rounded-full shadow text-red-400 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                 </div>
                 <button v-if="!isGuest" @click="currentView==='food'?openAddFoodModal():openAddSpotModal()" class="fab-main bg-orange-400 text-white"><i class="fa-solid fa-plus"></i></button>
             </div>
        </div>
        
        <div v-if="currentView==='hotel' || currentView==='prep' || currentView==='japanese'" class="p-5 text-center text-gray-400 font-bold">
            <div v-if="currentView==='hotel'">
                 <div v-for="h in hotels" :key="h.name" class="card overflow-hidden mb-4 !p-0">
                     <div class="h-32 bg-gray-200"><img :src="getImgPlaceholder(h.name)" class="w-full h-full object-cover"></div>
                     <div class="p-4 flex justify-between items-center">
                         <div class="font-bold text-gray-800">{{h.name}}</div>
                         <a :href="getMapLink(h.link)" target="_blank" class="bg-indigo-500 text-white px-3 py-1 rounded text-xs font-bold">å°èˆª</a>
                     </div>
                 </div>
            </div>
            <div v-if="currentView==='prep'">
                 <div class="card p-4 text-left">
                     <h3 class="font-bold text-blue-500 mb-2">è¡Œææ¸…å–® ({{currentUser?.name}})</h3>
                     <div v-if="!currentUser" class="text-xs text-gray-400">è«‹å…ˆé¸æ“‡èº«åˆ†</div>
                     <div v-else class="space-y-2">
                         <div v-for="(item, i) in currentUser.list" :key="i" class="flex items-center">
                             <input type="checkbox" v-model="item.checked" @change="saveData" class="accent-blue-500 mr-2">
                             <span :class="{'line-through text-gray-300':item.checked}" class="text-sm font-bold">{{item.text}}</span>
                         </div>
                     </div>
                 </div>
            </div>
            <div v-if="currentView==='japanese'">
                 <div class="space-y-3 pb-20">
                     <div v-for="(p,i) in japanesePhrases" :key="i" class="card p-4 text-left border-l-4 border-emerald-400">
                         <div class="font-bold text-lg text-gray-800">{{p.jp}}</div>
                         <div class="text-xs text-gray-400 font-bold">{{p.zh}}</div>
                     </div>
                 </div>
                 <button @click="openAddPhraseModal" class="fab-main bg-emerald-500 text-white"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

    </div>
    
    <div v-if="currentView!=='menu'" class="fab-home" @click="currentView='menu'"><i class="fa-solid fa-house"></i></div>
    
    <div v-if="showPersonaModal" class="fixed inset-0 z-[2000] bg-black/80 flex items-center justify-center p-6 backdrop-blur-md animate-fade-in">
        <div class="bg-[#FFF0F5] w-full max-w-sm rounded-[32px] p-8 text-center shadow-2xl border-4 border-white relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-4 bg-pink-200"></div>
            <h3 class="font-black text-2xl mb-8 text-gray-700 tracking-wider mt-4">è«‹å•æ‚¨æ˜¯å“ªä¸€ä½ï¼Ÿ</h3>
            <div class="grid grid-cols-2 gap-6">
                <div v-for="u in users" :key="u.id" class="relative group cursor-pointer" @click="setCurrentUser(u)">
                    <div class="w-24 h-24 mx-auto rounded-full bg-white border-4 border-white shadow-lg flex items-center justify-center text-4xl mb-3 overflow-hidden transition-all duration-300 group-hover:scale-110 group-hover:rotate-3 group-hover:border-pink-300">
                        <img v-if="u.avatar" :src="u.avatar" class="w-full h-full object-cover">
                        <span v-else>{{u.icon}}</span>
                    </div>
                    <div class="font-black text-gray-600 text-lg group-hover:text-pink-500 transition">{{u.name}}</div>
                </div>
            </div>
            <button @click="enterAsGuest" class="mt-8 text-xs text-gray-400 font-bold border-b border-gray-300">æˆ‘æ˜¯è¨ªå®¢</button>
        </div>
    </div>

    <div v-if="showCouponModal" class="fixed inset-0 z-[3000] bg-black/60 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-2xl text-pink-500"><i class="fa-solid fa-ticket"></i> å„ªæƒ åˆ¸</h3>
                <button @click="showCouponModal=false" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-4">
                <div v-for="(c, idx) in coupons" :key="idx" class="border-2 border-dashed border-pink-200 rounded-2xl p-4 bg-pink-50 relative">
                    <div class="font-black text-lg text-gray-800 mb-1">{{c.name}}</div>
                    <div class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded inline-block mb-2">{{c.discount}}</div>
                    <div class="text-xs text-gray-500 mb-3">{{c.note}}</div>
                    <a :href="c.link" target="_blank" class="block w-full bg-pink-400 text-white text-center font-bold py-2 rounded-xl shadow-sm hover:bg-pink-500">ä½¿ç”¨å„ªæƒ åˆ¸</a>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showModal" class="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center">{{modalTitle}}</h3>
            <div class="space-y-3">
                <div v-for="f in modalFields" :key="f.key">
                    <label v-if="f.label" class="text-xs font-bold text-gray-400 ml-1">{{f.label}}</label>
                    <input v-if="f.type!=='checkbox' && f.type!=='textarea'" v-model="modalData[f.key]" :placeholder="f.placeholder" class="w-full p-3 bg-gray-50 rounded-xl font-bold border outline-none focus:border-pink-300">
                    <textarea v-else-if="f.type==='textarea'" v-model="modalData[f.key]" class="w-full p-3 bg-gray-50 rounded-xl font-bold border h-20 outline-none"></textarea>
                    <div v-else class="flex items-center gap-2 bg-gray-50 p-3 rounded-xl border">
                        <input type="checkbox" v-model="modalData[f.key]" class="w-5 h-5 accent-pink-500">
                        <span class="font-bold text-gray-700 text-sm">{{f.label}}</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                <button @click="handleModalSave" class="flex-1 py-3 bg-pink-500 text-white rounded-xl font-bold shadow-lg">å„²å­˜</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3.3.4/dist/vue.esm-browser.js";

// V42 Config
const firebaseConfig = { apiKey: "AIzaSyD3ojbkJVfDKmZQHRpZG-gp8gv7ajKdJr4", authDomain: "tokyo-trip-24b28.firebaseapp.com", projectId: "tokyo-trip-24b28", storageBucket: "tokyo-trip-24b28.firebasestorage.app", messagingSenderId: "518699705070", appId: "1:518699705070:web:56e95f603210d8d5d209ff" };

// V42 Data (Preserved 100% from V41)
const defaultData = {
    users: [{id:1,name:'å‰ä¼Š',icon:'ğŸ¹',list:[{text:'è­·ç…§',checked:false}],lastActive:0},{id:2,name:'å°å…«',icon:'ğŸ±',list:[{text:'è­·ç…§',checked:false}],lastActive:0},{id:3,name:'å…”å…”',icon:'ğŸ°',list:[{text:'è­·ç…§',checked:false}],lastActive:0},{id:4,name:'å°æ¡ƒ',icon:'ğŸ‘',list:[{text:'è­·ç…§',checked:false}],lastActive:0}],
    itinerary: [
        [{hours:"06:40",category:"Flight",name:"TPE èµ·é£›",note:"T1 è¾¦ç†ç™»æ©Ÿ",mapKeyword:"æ¡ƒåœ’æ©Ÿå ´ T1"},{hours:"10:40",category:"Flight",name:"NRT æŠµé”",note:"é ˜å–è¡Œæ/è³¼è²·è¥¿ç“œå¡",mapKeyword:"æˆç”°æ©Ÿå ´"},{hours:"14:00",category:"Sightseeing",name:"æ™´ç©ºå¡”",note:"ä¸‹åˆè¡Œç¨‹",mapKeyword:"æ±äº¬æ™´ç©ºå¡”",travelTime:"â¬‡ 60-90min (é›»è»Š/å·´å£«)"},{hours:"18:00",category:"Food",name:"éŒ¦ç³¸ç”ºå‘¨é­",note:"æ™šé¤",mapKeyword:"éŒ¦ç³¸ç”ºç«™ ç¾é£Ÿ",travelTime:"â¬‡ 15min (æ­¥è¡Œ)"}],
        [{hours:"09:00",category:"Sightseeing",name:"æ·ºè‰å¯º",note:"é›·é–€/ä»²è¦‹ä¸–é€š",mapKeyword:"æ·ºè‰å¯º",travelTime:"â¬‡ 20min (é›»è»Š)"},{hours:"12:00",category:"Food",name:"æ·ºè‰å‘¨é­",note:"åˆé¤",mapKeyword:"æ·ºè‰ç«™ ç¾é£Ÿ",travelTime:"â¬‡ 5min (æ­¥è¡Œ)"},{hours:"14:00",category:"Sightseeing",name:"å°ç¶²ç¥ç¤¾/ä¸Šé‡å…¬åœ’",note:"å¼·é‹å„é™¤/å…¬åœ’æ•£æ­¥",mapKeyword:"å°ç¶²ç¥ç¤¾",travelTime:"â¬‡ 25min (é›»è»Š)"},{hours:"18:00",category:"Shopping",name:"ç§‹è‘‰åŸ/æ±äº¬ä¸€ç•ªè¡—",note:"å‹•æ¼«æˆ–é€›è¡—",mapKeyword:"ç§‹è‘‰åŸ",travelTime:"â¬‡ 15min (é›»è»Š)"},{hours:"20:00",category:"Food",name:"æ™šé¤",note:"ä¾é€›è¡—è¡Œç¨‹æ±ºå®š",mapKeyword:"æ±äº¬è»Šç«™ ç¾é£Ÿ"}],
        [{hours:"08:00",category:"Transport",name:"å‰å¾€å¯Œå£«å±±",note:"éŒ¦ç³¸ç”ºå‡ºç™¼ (å¯Œå£«å›éŠ)",mapKeyword:"éŒ¦ç³¸ç”ºç«™",travelTime:"â¬‡ 120min (JRç‰¹æ€¥)"},{hours:"10:30",category:"Transport",name:"é–‹å§‹ç§Ÿè»Š",note:"å¯Œå£«å±±ç§Ÿè»Š 3å¤©2å¤œ",mapKeyword:"æ²³å£æ¹– ç§Ÿè»Š",travelTime:"â¬‡ 0min"},{hours:"13:00",category:"Sightseeing",name:"æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨",note:"å¤§çŸ³å…¬åœ’çµ•æ™¯",mapKeyword:"æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨",travelTime:"â¬‡ 20min (è»Š)"},{hours:"15:00",category:"Sightseeing",name:"æ–°å€‰å±±æ·ºé–“å…¬åœ’",note:"å¿ éˆå¡”ç­æœ›å° (éœ€çˆ¬éšæ¢¯)",mapKeyword:"æ–°å€‰å±±æ·ºé–“å…¬åœ’",travelTime:"â¬‡ 25min (è»Š)"},{hours:"17:30",category:"Sightseeing",name:"é‡‘é³¥å±…/æœ¬ç”ºå•†åº—è¡—",note:"æ—¥å·æ™‚è¨ˆåº—æ‹ç…§",mapKeyword:"å¯Œå£«å‰ç”°æœ¬ç”ºé€šã‚Š",travelTime:"â¬‡ 10min (è»Š)"},{hours:"19:00",category:"Food",name:"æ™šé¤",note:"è‡ªè¡Œçƒ¹é£ªæˆ–å•†åº—è¡—",mapKeyword:"Ogino æ²³å£æ¹–åº—"}],
        [{hours:"05:00",category:"Sightseeing",name:"å¹³é‡ä¹‹æ¿±",note:"çœ‹æ—¥å‡º (è¦–å¤©æ°£)",mapKeyword:"å¹³é‡ã®æµœ",travelTime:"â¬‡ 30min (è»Š)"},{hours:"09:00",category:"Sightseeing",name:"é•·æ± è¦ªæ°´å…¬åœ’/ç™½é³¥æ¿±",note:"å±±ä¸­æ¹–ç§Ÿè‡ªè¡Œè»Š",mapKeyword:"é•·æ± è¦ªæ°´å…¬åœ’",travelTime:"â¬‡ 15min (è»Š)"},{hours:"12:00",category:"Food",name:"å±±ä¸­æ¹–é¤å»³",note:"åˆé¤",mapKeyword:"å±±ä¸­æ¹– ç¾é£Ÿ",travelTime:"â¬‡ 0min"},{hours:"14:00",category:"Sightseeing",name:"KABA æ°´é™¸å·´å£«",note:"æ—­æ—¥ä¸˜æ¹–ç•”ç¶ åœ°å…¬åœ’",mapKeyword:"KABA BUS",travelTime:"â¬‡ 10min (è»Š)"},{hours:"18:00",category:"Food",name:"æ™šé¤",note:"è‡ªè¡Œçƒ¹é£ª (Oginoè¶…å¸‚)",mapKeyword:"Ogino æ²³å£æ¹–åº—",travelTime:"â¬‡ 30min (è»Š)"}],
        [{hours:"09:00",category:"Sightseeing",name:"æ²³å£æ¹–çºœè»Š",note:"é‡‘é³¥å±…/çµ•æ™¯é¦éŸ†",mapKeyword:"æ²³å£æ¹– å¯Œå£«å±±å…¨æ™¯çºœè»Š",travelTime:"â¬‡ 20min (è»Š)"},{hours:"11:00",category:"Shopping",name:"Fujisan Shokupan",note:"è³¼è²·ä¼´æ‰‹ç¦®é»å¿ƒ",mapKeyword:"Fujisan Shokupan",travelTime:"â¬‡ 10min (è»Š)"},{hours:"14:00",category:"Transport",name:"å¯Œå£«å›éŠ",note:"è¿”å›æ±äº¬æ–°å®¿ (æ”¾è¡Œæ)",mapKeyword:"æ²³å£æ¹–ç«™",travelTime:"â¬‡ 120min (JRç‰¹æ€¥)"},{hours:"16:30",category:"Shopping",name:"æ± è¢‹å¤ªé™½åŸ",note:"é€›è¡—è¡Œç¨‹",mapKeyword:"æ± è¢‹å¤ªé™½åŸ",travelTime:"â¬‡ 20min (é›»è»Š)"},{hours:"19:00",category:"Food",name:"å¤ªé™½åŸé¤å»³",note:"æ™šé¤",mapKeyword:"æ± è¢‹å¤ªé™½åŸ ç¾é£Ÿ"}],
        [{hours:"09:00",category:"Transport",name:"å‰å¾€è—¤æ¾¤",note:"æ–°å®¿å‡ºç™¼ (æ±Ÿä¹‹é›»ä¸€æ—¥éŠ)",mapKeyword:"æ–°å®¿ç«™",travelTime:"â¬‡ 60min (å°ç”°æ€¥)"},{hours:"10:30",category:"Sightseeing",name:"æ±Ÿä¹‹å³¶/éŒå€‰é«˜æ ¡",note:"çŒç±ƒé«˜æ‰‹å¹³äº¤é“",mapKeyword:"éŒå€‰é«˜æ ¡å‰ç«™",travelTime:"â¬‡ 20min (æ±Ÿä¹‹é›»)"},{hours:"13:00",category:"Food",name:"ä¸ƒé‡Œæ¿±é¤å»³",note:"åˆé¤",mapKeyword:"ä¸ƒé‡Œæ¿± ç¾é£Ÿ",travelTime:"â¬‡ 10min (æ±Ÿä¹‹é›»)"},{hours:"15:00",category:"Sightseeing",name:"éŒå€‰/é¶´å²¡å…«å¹¡å®®",note:"å°ç”ºé€šé€›è¡—",mapKeyword:"é¶´å²¡å…«å¹¡å®®",travelTime:"â¬‡ 20min (æ±Ÿä¹‹é›»)"},{hours:"18:00",category:"Transport",name:"è¿”å›æ–°å®¿",note:"æ™šé¤: æ–°å®¿æˆ–çƒ¹é£ª",mapKeyword:"æ–°å®¿ç«™",travelTime:"â¬‡ 60min (å°ç”°æ€¥)"}],
        [{hours:"09:00",category:"Sightseeing",name:"æ±äº¬éµå¡”/éº»å¸ƒå°",note:"å…­æœ¬æœ¨å‘¨é­æ‹ç…§",mapKeyword:"éº»å¸ƒå°Hills",travelTime:"â¬‡ 30min (åœ°éµ)"},{hours:"12:00",category:"Food",name:"å…­æœ¬æœ¨é¤å»³",note:"åˆé¤",mapKeyword:"å…­æœ¬æœ¨ ç¾é£Ÿ",travelTime:"â¬‡ 10min (æ­¥è¡Œ)"},{hours:"14:00",category:"Shopping",name:"å‰å¾€æ¾€è°·",note:"é€›è¡—",mapKeyword:"æ¾€è°·ç«™",travelTime:"â¬‡ 15min (åœ°éµ)"},{hours:"17:00",category:"Sightseeing",name:"SHIBUYA SKY",note:"çµ•ç¾æ—¥è½/åå­—è·¯å£",mapKeyword:"SHIBUYA SKY",travelTime:"â¬‡ 5min (æ­¥è¡Œ)"},{hours:"20:00",category:"Food",name:"æ¾€è°·é¤å»³",note:"æ™šé¤",mapKeyword:"æ¾€è°· ç¾é£Ÿ"}],
        [{hours:"10:00",category:"Sightseeing",name:"è‡ªç”±è¡Œç¨‹",note:"æœ€å¾Œæ¡è²·",mapKeyword:"ä¸Šé‡é˜¿ç¾æ©«ä¸",travelTime:"â¬‡ 0min"},{hours:"20:40",category:"Flight",name:"NRT èµ·é£›",note:"æˆç”°æ©Ÿå ´å ±åˆ°",mapKeyword:"æˆç”°æ©Ÿå ´"},{hours:"23:20",category:"Flight",name:"TPE æŠµé”",note:"å›åˆ°æº«æš–çš„å®¶",mapKeyword:"æ¡ƒåœ’æ©Ÿå ´"}]
    ],
    drivePlan: [
        [{hours:"08:00",category:"Transport",name:"å‰å¾€å¯Œå£«å±±",note:"éŒ¦ç³¸ç”ºå‡ºç™¼",travelTime:"ğŸš— 120min"}, {hours:"10:30",category:"Transport",name:"é–‹å§‹ç§Ÿè»Š",note:"æ²³å£æ¹– ç§Ÿè»Š",travelTime:"ğŸš— 20min",parkingLink:"æ²³å£æ¹–é§… é§è»Šå ´"}, {hours:"13:00",category:"Sightseeing",name:"æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨",note:"å¤§çŸ³å…¬åœ’çµ•æ™¯",travelTime:"ğŸš— 20min",parkingLink:"å¤§çŸ³å…¬åœ’ é§è»Šå ´"}, {hours:"15:00",category:"Sightseeing",name:"æ–°å€‰å±±æ·ºé–“å…¬åœ’",note:"å¿ éˆå¡”ç­æœ›å°",travelTime:"ğŸš— 15min",parkingLink:"æ–°å€‰å±±æ·ºé–“å…¬åœ’ é§è»Šå ´"}, {hours:"17:30",category:"Sightseeing",name:"é‡‘é³¥å±…/æœ¬ç”ºå•†åº—è¡—",note:"æ—¥å·æ™‚è¨ˆåº—æ‹ç…§",travelTime:"ğŸš— 10min",parkingLink:"å¯Œå£«å‰ç”°å¸‚å–¶ æœ¬ç”ºé€šã‚Šé§è»Šå ´"}, {hours:"19:00",category:"Food",name:"æ™šé¤",note:"è‡ªè¡Œçƒ¹é£ªæˆ–å•†åº—è¡—"}],
        [{hours:"05:00",category:"Sightseeing",name:"å¹³é‡ä¹‹æ¿±",note:"çœ‹æ—¥å‡º",travelTime:"ğŸš— 30min",parkingLink:"å¹³é‡ã®æµœ é§è»Šå ´"}, {hours:"09:00",category:"Sightseeing",name:"é•·æ± è¦ªæ°´å…¬åœ’/ç™½é³¥æ¿±",note:"å±±ä¸­æ¹–ç§Ÿè‡ªè¡Œè»Š",travelTime:"ğŸš— 15min",parkingLink:"é•·æ± è¦ªæ°´å…¬åœ’ é§è»Šå ´"}, {hours:"12:00",category:"Food",name:"å±±ä¸­æ¹–é¤å»³",note:"åˆé¤",travelTime:"ğŸš— 20min"}, {hours:"14:00",category:"Sightseeing",name:"KABA æ°´é™¸å·´å£«",note:"æ—­æ—¥ä¸˜æ¹–ç•”ç¶ åœ°å…¬åœ’",travelTime:"ğŸš— 30min",parkingLink:"æ—­æ—¥ä¸˜æ¹–ç•”ç·‘åœ°å…¬åœ’ é§è»Šå ´"}, {hours:"18:00",category:"Food",name:"æ™šé¤",note:"è‡ªè¡Œçƒ¹é£ª (Oginoè¶…å¸‚)"}]
    ],
    shopping: {
        cosme: [{name:'Canmake è‡¥è ¶ç›¤',link:'https://www.canmake.com/'},{name:'Kate æ€ªç¸å”‡è†',link:'https://www.nomorerules.net/'},{name:'Tirtir æ°£å¢Šç²‰é¤…',link:''},{name:'Cezanne ç å…‰ä¿®å®¹',link:'https://www.cezanne.co.jp/'},{name:'Excel çœ¼å½±',link:'https://noevirgroup.jp/excel/'}],
        ldk: [{name:'MINON èƒºåŸºé…¸é¢è†œ',link:'https://www.daiichisankyo-hc.co.jp/site_minon/'},{name:'Quality 1st é¢è†œ',link:''},{name:'IHADA åŒ–å¦æ°´',link:''},{name:'Elixir å°é‡‘ç®¡',link:''},{name:'Fino é«®è†œ',link:''}],
        souvenir: [{name:'NY Perfect Cheese',link:''},{name:'Press Butter Sand',link:'https://buttersand.com/'},{name:'Sugar Butter Tree',link:''},{name:'Tokyo Banana',link:'https://www.tokyobanana.jp/'},{name:'ç™½è‰²æˆ€äºº',link:'https://www.ishiya.co.jp/'}]
    },
    coupons: [
        {name: 'å”å‰è¨¶å¾·', discount: '10% (å…ç¨…) + 5%', link: 'https://www.djapanpass.com/coupon/0002000103', note: 'æœªç¨…æ»¿ 1è¬æ—¥åœ“'},
        {name: 'Bic Camera', discount: '10% (å…ç¨…) + 7%', link: 'https://www.biccamera.com/bc/c/info/order/lang-select.jsp', note: 'å‡ºç¤ºè­·ç…§'},
        {name: 'æ¾æœ¬æ¸…', discount: '10% (å…ç¨…) + 3~7%', link: 'https://www.matsukiyo.co.jp/store/online', note: 'ä¾é‡‘é¡æŠ˜æ‰£'},
        {name: 'ä¸‰äº• Outlet', discount: 'å„ªæƒ åˆ¸ + è´ˆå“', link: 'https://mitsui-shopping-park.com/mop/index.html', note: 'è‡³æœå‹™å°å‡ºç¤º QR Code æ›å–'}
    ],
    phrases: [{jp:'ã™ã¿ã¾ã›ã‚“',zh:'ä¸å¥½æ„æ€/è«‹å•'},{jp:'ã“ã‚Œãã ã•ã„',zh:'æˆ‘è¦é€™å€‹'},{jp:'ã„ãã‚‰ã§ã™ã‹',zh:'è«‹å•å¤šå°‘éŒ¢'},{jp:'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™',zh:'æˆ‘è¦çµå¸³'},{jp:'è¢‹ã„ã‚Šã¾ã›ã‚“',zh:'ä¸ç”¨è¢‹å­'},{jp:'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹',zh:'å»æ‰€åœ¨å“ªè£¡'},{jp:'å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã„ã„ã§ã™ã‹',zh:'å¯ä»¥æ‹ç…§å—'},{jp:'è‹±èªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ã‚Šã¾ã™ã‹',zh:'æœ‰è‹±æ–‡èœå–®å—'},{jp:'ãŠã™ã™ã‚ã¯ä½•ã§ã™ã‹',zh:'æœ‰æ¨è–¦çš„å—'},{jp:'æ°´ãã ã•ã„',zh:'è«‹çµ¦æˆ‘æ°´'}],
    spots: { 
        food: {
            Tokyo: [{name:'AFURI',desc:'æ¸…æ–°æŸšå­é¹½æ‹‰éºµ',link:'AFURI åŸå®¿', reserve:false, note:'ã€å…è¨‚ä½ã€‘å»ºè­°é¿é–‹ç”¨é¤å°–å³°ï¼ŒæŸšå­é¹½æ‹‰éºµå¿…é»ã€‚'},{name:'å™å™è‹‘',desc:'é«˜ç´šç‡’è‚‰æ™¯è§€é¤å»³',link:'å™å™è‹‘ æ™´ç©ºå¡”', reserve:true, reserveLink:'https://www.tablecheck.com/zh-TW/shops/jojoen-tokyoskytreetown-solamachi/reserve', note:'ã€éœ€è¨‚ä½ã€‘åˆé–“å¥—é¤CPå€¼æœ€é«˜ï¼Œçª—é‚Šä½ç½®éœ€ä¸€å€‹æœˆå‰é è¨‚ã€‚'},{name:'HARBS',desc:'å¿…åƒæ°´æœåƒå±¤è›‹ç³•',link:'HARBS LUMINE EST', reserve:false, note:'ã€å…è¨‚ä½ã€‘å…§ç”¨æ¯äººä½æ¶ˆä¸€æ¯é£²æ–™ï¼Œäº¦å¯å¤–å¸¶å›é£¯åº—åƒã€‚'},{name:'æ·ºè‰ä»ŠåŠ',desc:'ç™¾å¹´å£½å–œç‡’è€åº—',link:'æ·ºè‰ä»ŠåŠ åœ‹éš›é€š', reserve:true, reserveLink:'https://www.asakusaimahan.co.jp/english/guide', note:'ã€éœ€è¨‚ä½ã€‘åˆé–“å£½å–œç‡’å®šé£Ÿè¼ƒåˆ’ç®—ï¼Œç™¾å¹´è€åº—æœå‹™æ¥µä½³ã€‚'},{name:'ç‚¸ç‰›æ’ æœ¬æ‘',desc:'è‡ªè¡Œç…çƒ¤è»Ÿå«©ç‰›æ’',link:'ç‰›ã‹ã¤ã‚‚ã¨æ‘ æ¾€è°·', reserve:false, note:'ã€ç¾å ´æ’éšŠã€‘åªèƒ½ç¾å ´æ’éšŠï¼Œå»ºè­°é–‹åº—å‰15åˆ†é˜åˆ°ã€‚'}], 
            Kamakura: [{name:'Bills',desc:'ä¸–ç•Œç¬¬ä¸€å¥½åƒé¬†é¤…',link:'Bills ä¸ƒé‡Œãƒ¶æµœ', reserve:true, reserveLink:'https://billsjapan.com/en/shichirigahama', note:'ã€éœ€è¨‚ä½ã€‘æˆ¶å¤–åº§ä½å¯çœ‹æµ·æ™¯ï¼Œé¬†é¤…è£½ä½œéœ€20åˆ†é˜ã€‚'},{name:'Caraway',desc:'æ’éšŠå’–å“©ååº—',link:'Caraway Curry', reserve:false, note:'ã€ç¾å ´æ’éšŠã€‘ä»½é‡éå¸¸å¤§ï¼Œå¥³ç”Ÿå»ºè­°é»å°é£¯ã€‚åªæ”¶ç¾é‡‘ã€‚'},{name:'Pacific Drive-in',desc:'æµ·æ™¯å¤å¨å¤·é¤å»³',link:'Pacific Drive-in', reserve:false, note:'ã€ç¾å ´æ’éšŠã€‘é€±æœ«äººæ½®å¤šï¼Œè’œè“‰è¦é£¯æ˜¯æ‹›ç‰Œã€‚'},{name:'åŠ›é¤…å®¶',desc:'ç™¾å¹´è€èˆ–æ¬Šäº”éƒåŠ›é¤…',link:'åŠ›é¤…å®¶', reserve:false, note:'ä¿å­˜æœŸé™çŸ­ï¼Œå»ºè­°ç•¶å¤©åƒå®Œã€‚'},{name:'éŒå€‰é‡œé£¯',desc:'å»ä»”é­šé‡œé£¯',link:'éŒå€‰é‡œé£¯ ã‹ã¾ã‹ã¾', reserve:true, reserveLink:'https://www.kamakama.jp/', note:'ã€å»ºè­°è¨‚ä½ã€‘æœ€å¾Œå¯ä»¥åŠ é«˜æ¹¯è®ŠèŒ¶æ³¡é£¯ï¼Œä¸€é£¯å…©åƒã€‚'}], 
            Fuji: [{name:'ä¸å‹•èŒ¶å±‹',desc:'ç‰¹è‰²é›²æœµå»ºç¯‰é¤ºé£¥éºµ',link:'ä¸å‹•èŒ¶å±‹ æ±æˆ€è·¯', reserve:false, note:'ã€ç¾å ´æ’éšŠã€‘æ±æˆ€è·¯åº—å»ºç¯‰æœ€ç¾ï¼Œç¿»æ¡Œç‡å¿«ã€‚'},{name:'å±±éº“åœ’',desc:'ç‚­ç«çˆç«¯ç‡’é«”é©—',link:'å±±éº“åœ’', reserve:true, reserveLink:'https://sanrokuen.com/', note:'ã€å»ºè­°è¨‚ä½ã€‘é«”é©—åœçˆè£ç‡’çƒ¤ï¼Œèº«ä¸Šæœƒæœ‰ç‚­ç«å‘³ã€‚'},{name:'æ¹–æ³¢',desc:'æ²³å£æ¹–æ™¯è§€å®šé£Ÿ',link:'æ¹–æ³¢é£Ÿäº‹è™•', reserve:false, note:'ã€ç¾å ´æ’éšŠã€‘é çª—ä½ç½®å¯çœ‹å¯Œå£«å±±ï¼Œå¤©å©¦ç¾…å®šé£Ÿæ¨è–¦ã€‚'},{name:'Hana ç‡’è‚‰',desc:'ç•¶åœ°äººæ¨è–¦ç‡’è‚‰',link:'Hana Yakiniku', reserve:true, reserveLink:'https://www.hotpepper.jp/strJ000354673/yoyaku/', note:'ã€éœ€è¨‚ä½ã€‘CPå€¼é«˜çš„å–®é»ç‡’è‚‰ï¼Œå»ºè­°é ç´„ã€‚'},{name:'The Park',desc:'å¯Œå£«å±±åå¸',link:'Food Labo', reserve:false, note:'å¯Œå£«å±±é€ å‹åå¸ï¼Œæ‹ç…§æ‰“å¡å¿…å‚™ã€‚'}]
        }, 
        photo: {
            Tokyo: [{name:'SHIBUYA SKY',desc:'æ±äº¬æœ€ç¾å±•æœ›å°',link:'SHIBUYA SKY'},{name:'è±ªå¾·å¯º',desc:'æ»¿æ»¿æ‹›è²¡è²“',link:'è±ªå¾·å¯º'},{name:'æ±äº¬éµå¡”',desc:'èŠå…¬åœ’æœ€ä½³æ©Ÿä½',link:'èŠå…¬åœ’ 4è™Ÿåœ°'},{name:'æ·ºè‰é›·é–€',desc:'ç¶“å…¸åœ°æ¨™å¤§ç‡ˆç± ',link:'é›·é–€'},{name:'TeamLab',desc:'å…‰å½±è—è¡“å±•',link:'TeamLab Planets'}], 
            Kamakura: [{name:'éŒå€‰é«˜æ ¡å‰',desc:'çŒç±ƒé«˜æ‰‹å¹³äº¤é“',link:'éŒå€‰é«˜æ ¡å‰é§…'},{name:'é•·è°·å¯º',desc:'çœºæœ›æ¹˜å—æµ·å²¸',link:'é•·è°·å¯º'},{name:'å ±åœ‹å¯º',desc:'çµ•ç¾ç«¹æ—',link:'å ±åœ‹å¯º'},{name:'æ±Ÿå³¶ç¥ç¤¾',desc:'æµ·ä¸Šé³¥å±…',link:'æ±Ÿå³¶ç¥ç¤¾'},{name:'ä¸ƒé‡Œæ¿±',desc:'æœ€ç¾æµ·å²¸ç·š',link:'ä¸ƒé‡Œãƒ¶æµœ æµ·å²¸'}], 
            Fuji: [{name:'æ–°å€‰å±±æ·ºé–“å…¬åœ’',desc:'äº”é‡å¡”èˆ‡å¯Œå£«å±±',link:'æ–°å€‰å±±æ·ºé–“å…¬åœ’'},{name:'ä¸‹å‰ç”°',desc:'æ—¥å·æ™‚è¨ˆåº—æœ¬ç”ºé€š',link:'æ—¥å·æ™‚è¨ˆåº—'},{name:'å¤§çŸ³å…¬åœ’',desc:'èŠ±æµ·å¯Œå£«å±±',link:'å¤§çŸ³å…¬åœ’'},{name:'æ²³å£æ¹–è»Šç«™',desc:'LAWSON å¯Œå£«å±±',link:'æ²³å£æ¹–é§…'},{name:'å¹³é‡ä¹‹æ¿±',desc:'å¯§éœæ¹–ç•”å€’å½±',link:'å¹³é‡ã®æµœ'}]
        } 
    },
    hotels: [
        {name:'éŒ¦ç³¸ç”ºæ°‘å®¿', img:'bnb.jpg', link:'éŒ¦ç³¸ç”º æ°‘å®¿'},
        {name:'Megu Fuji', img:'megu.jpg', link:'Megu Fuji 2026'},
        {name:'DOMO æ°‘å®¿', img:'domo.jpg', link:'DOMO æ°‘å®¿ æ±æ–°å®¿'}
    ]
};

createApp({
    setup() {
        // App State
        const currentView = ref('welcome');
        const currentUser = ref(null);
        const isGuest = ref(false);
        const isWelcomeClosed = ref(false);
        const isLoggedIn = ref(false);
        const isSaving = ref('idle');
        const dbConnected = ref(false);
        const latency = ref(0);
        const showDebug = ref(false);
        const couponBarMinimized = ref(false);
        
        // Reactive Data
        const users = ref(JSON.parse(JSON.stringify(defaultData.users)));
        const itinerary = ref(defaultData.itinerary);
        const shopping = ref(defaultData.shopping);
        const spots = ref(defaultData.spots);
        const expenses = ref([]);
        const coupons = ref(defaultData.coupons);
        const japanesePhrases = ref(defaultData.phrases);
        const hotels = ref(defaultData.hotels);
        const drivePlan = ref(defaultData.drivePlan);
        const settlements = computed(() => { const b={}; users.value.forEach(u=>b[u.id]=0); expenses.value.filter(e=>e.forWhom.length>1).forEach(e=>{ const t=e.currency==='JPY'?e.amount*0.215:e.amount; b[e.whoPaid]+=t; const s=t/e.forWhom.length; e.forWhom.forEach(i=>b[i]-=s); }); return Object.entries(b).map(([id,v])=>({id:Number(id),v})).filter(x=>Math.abs(x.v)>1).map(x=>({from:x.v<0?x.id:0, to:x.v>0?x.id:0, amount:Math.abs(x.v)})).filter(x=>x.from&&x.to); }); // Simplified logic for brevity in view

        // View Logic
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        const moneyTab = ref('record');
        const exchangeRate = ref(0.215);
        const shopCat = ref('cosme');
        const currentLoc = ref('Tokyo');
        const weatherData = ref([{name:'Tokyo',name_zh:'æ±äº¬',temp:'--',icon:'â˜€ï¸'},{name:'Kamakura',name_zh:'éŒå€‰',temp:'--',icon:'ğŸŒ¤ï¸'},{name:'Fuji',name_zh:'å¯Œå£«å±±',temp:'--',icon:'ğŸ”ï¸'}]);
        
        // Modals
        const showPersonaModal = ref(false);
        const showModal = ref(false);
        const modalTitle = ref('');
        const modalFields = ref([]);
        const modalData = ref({});
        const modalCallback = ref(null);
        const showCouponModal = ref(false);
        const showExpenseModal = ref(false);
        const expenseMode = ref('private');

        // Static
        const apps = [{id:1,name:'è¡Œç¨‹',icon:'fa-solid fa-map',view:'itinerary',bgClass:'bg-pink-400'},{id:2,name:'å°è²¡åº«',icon:'fa-solid fa-yen-sign',view:'money',bgClass:'bg-yellow-400'},{id:3,name:'ä½å®¿',icon:'fa-solid fa-hotel',view:'hotel',bgClass:'bg-indigo-400'},{id:4,name:'è¡Œå‰',icon:'fa-solid fa-suitcase',view:'prep',bgClass:'bg-blue-400'},{id:5,name:'ç¾é£Ÿ',icon:'fa-solid fa-utensils',view:'food',bgClass:'bg-orange-400'},{id:6,name:'æ™¯é»',icon:'fa-solid fa-camera',view:'photo',bgClass:'bg-rose-400'},{id:7,name:'è³¼ç‰©',icon:'fa-solid fa-bag-shopping',view:'shopping',bgClass:'bg-purple-400'},{id:8,name:'å¤©æ°£',icon:'fa-solid fa-cloud-sun',view:'weather',bgClass:'bg-sky-400'},{id:9,name:'ç¿»è­¯',icon:'fa-solid fa-language',view:'japanese',bgClass:'bg-emerald-400'}];
        const tripDays = [{week:'D1',title:'3/27'},{week:'D2',title:'3/28'},{week:'D3',title:'3/29'},{week:'D4',title:'3/30'},{week:'D5',title:'3/31'},{week:'D6',title:'4/01'},{week:'D7',title:'4/02'},{week:'D8',title:'4/03'}];
        const daysUntilTrip = computed(() => Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24)));
        const smartReminders = computed(() => { const l=[]; if(daysUntilTrip.value<=30) l.push("ğŸ”´ å¯Œå£«å›éŠè™Ÿï¼šæ¶ç¥¨ï¼"); return l; });

        // Firebase
        let auth, db;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e) { console.error("Firebase Init Error", e); }

        // V42 Core: Real Weather API
        const fetchRealWeather = async () => {
             const locs = {
                 'Tokyo': {lat: 35.6895, lon: 139.6917},
                 'Kamakura': {lat: 35.3197, lon: 139.5467},
                 'Fuji': {lat: 35.3606, lon: 138.7274}
             };
             for(let k in locs) {
                 try {
                     const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${locs[k].lat}&longitude=${locs[k].lon}&current_weather=true`);
                     const data = await res.json();
                     const w = weatherData.value.find(x => x.name === k);
                     if(w && data.current_weather) {
                         w.temp = data.current_weather.temperature;
                         const code = data.current_weather.weathercode;
                         w.icon = code < 3 ? 'â˜€ï¸' : code < 50 ? 'â˜ï¸' : 'ğŸŒ§ï¸';
                     }
                 } catch(e) { console.warn("Weather API Error", e); }
             }
        };

        // V42 Core: Green Dot Logic (Reactive)
        const activeUsersList = computed(() => {
            return users.value.filter(u => u.lastActive && (Date.now() - u.lastActive) < 65000 && u.id !== currentUser.value?.id);
        });

        // V42 Core: Sync Logic (Robust)
        let saveTimeout;
        const saveData = () => {
            if(isGuest.value || !db) return;
            isSaving.value = 'syncing';
            
            // æ¯æ¬¡ä¿å­˜æ™‚ï¼Œæ›´æ–°ç•¶å‰ç”¨æˆ¶çš„æœ€å¾Œæ´»èºæ™‚é–“ (Heartbeat)
            if(currentUser.value) {
                const idx = users.value.findIndex(u => u.id === currentUser.value.id);
                if(idx !== -1) users.value[idx].lastActive = Date.now();
            }

            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                try {
                    const dataToSave = {
                        users: users.value,
                        itinerary: itinerary.value,
                        shopping: shopping.value,
                        spots: spots.value,
                        expenses: expenses.value,
                        coupons: coupons.value,
                        phrases: japanesePhrases.value,
                        hotels: hotels.value,
                        _lastUpdate: Date.now()
                    };
                    await setDoc(doc(db, "trips", "kanto2026"), dataToSave, {merge: true});
                    isSaving.value = 'saved';
                } catch(e) {
                    console.error("Save Error", e);
                    isSaving.value = 'error';
                }
            }, 800); // 800ms debounce
        };

        // Initialization
        onMounted(() => {
            fetchRealWeather();
            initSakura();
            
            // Auto Login & Sync
            if(auth) {
                signInAnonymously(auth).then(() => {
                    isLoggedIn.value = true;
                    dbConnected.value = true;
                    // Real-time Listener
                    onSnapshot(doc(db, "trips", "kanto2026"), (docSnap) => {
                        if(docSnap.exists()) {
                            const d = docSnap.data();
                            // Merge logic: Replace references to trigger reactivity
                            if(d.users) users.value = d.users;
                            if(d.itinerary) itinerary.value = d.itinerary;
                            if(d.shopping) shopping.value = d.shopping;
                            if(d.spots) spots.value = d.spots;
                            if(d.expenses) expenses.value = d.expenses;
                            if(d.coupons) coupons.value = d.coupons;
                            if(d.phrases) japanesePhrases.value = d.phrases;
                            if(d.hotels) hotels.value = d.hotels;
                            
                            // Re-bind current user if exists
                            if(currentUser.value) {
                                const freshUser = users.value.find(u => u.id === currentUser.value.id);
                                if(freshUser) currentUser.value = freshUser;
                            }
                        }
                    });
                });
            }

            // Persisted User Login (One-time strict)
            const savedId = localStorage.getItem('V42_USER_ID');
            if(savedId) {
                const u = users.value.find(x => x.id === parseInt(savedId));
                if(u) {
                    currentUser.value = u;
                    isWelcomeClosed.value = true;
                    currentView.value = 'menu';
                }
            }
        });

        // Helpers
        const setCurrentUser = (u) => {
            currentUser.value = u;
            localStorage.setItem('V42_USER_ID', u.id);
            showPersonaModal.value = false;
            isWelcomeClosed.value = true;
            currentView.value = 'menu';
            saveData(); // Trigger initial heartbeat
        };
        const enterAsGuest = () => { isGuest.value=true; isWelcomeClosed.value=true; currentView.value='menu'; };
        const enterSite = () => { if(currentUser.value) currentView.value='menu'; else showPersonaModal.value=true; };
        const getPageTitle = (v) => ({'itinerary':'è¡Œç¨‹è¡¨','money':'å°è²¡åº«','shopping':'è³¼ç‰©æ¸…å–®','food':'ç¾é£Ÿ','photo':'æ™¯é»','weather':'å¤©æ°£','japanese':'ç¿»è­¯'}[v]||'é—œæ±ä¹‹æ—…');
        const getCurrentItinerary = () => (itineraryMode.value==='drive' && [2,3].includes(selectedDayIndex.value)) ? drivePlan.value[selectedDayIndex.value-2] : itinerary.value[selectedDayIndex.value];
        const getIconByCategory = (c) => ({'Flight':'fa-solid fa-plane','Food':'fa-solid fa-utensils','Shopping':'fa-solid fa-bag-shopping','Sightseeing':'fa-solid fa-camera','Transport':'fa-solid fa-train'}[c]||'fa-solid fa-location-dot');
        const getMapLink = (k, n) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k||n)}`;
        const getSearchLink = (n) => `https://www.google.com/search?q=${encodeURIComponent(n)}`;
        const getImgPlaceholder = (t) => `https://placehold.co/400x300/pink/white?text=${encodeURIComponent(t.substring(0,4))}`;
        const handleImgError = (e) => e.target.src = 'https://placehold.co/400x300/pink/white?text=IMAGE';
        const getPaymentIcon = (m) => ({'cash':'ğŸ’µ','card':'ğŸ’³'}[m]||'ğŸ’°');
        const getUserName = (id) => users.value.find(u=>u.id===id)?.name || 'æœªçŸ¥';
        const getClothingAdvice = (t) => t<10?'ç¾½çµ¨+åœå·¾':t<15?'å¤§è¡£+ç™¼ç†±è¡£':t<20?'æ´‹è”¥å¼ç©¿æ­':'è¼•ä¾¿è¡£ç‰©';
        const myPrivateExpenses = computed(() => currentUser.value ? expenses.value.filter(e => e.whoPaid===currentUser.value.id && e.forWhom.length===1 && e.forWhom[0]===currentUser.value.id) : []);
        const myPrivateTotalTWD = computed(() => myPrivateExpenses.value.reduce((s,e) => s + (e.currency==='JPY'?e.amount*exchangeRate.value:e.amount), 0));
        const groupExpenses = computed(() => expenses.value.filter(e => e.forWhom.length > 1 || (e.forWhom.length===1 && e.forWhom[0]!==e.whoPaid)));
        
        // Modal Openers
        const openEditItineraryModal = (item, idx) => { if(isGuest.value) return; modalTitle.value='ç·¨è¼¯è¡Œç¨‹'; modalFields.value=[{key:'hours',label:'æ™‚é–“'},{key:'name',label:'åç¨±'},{key:'note',label:'å‚™è¨»'},{key:'mapKeyword',label:'åœ°åœ–é—œéµå­—'}]; modalData.value={...item}; modalCallback.value=()=>{getCurrentItinerary()[idx]=modalData.value;saveData();}; showModal.value=true; };
        const openAddItineraryModal = () => { modalTitle.value='æ–°å¢è¡Œç¨‹'; modalFields.value=[{key:'hours',label:'æ™‚é–“'},{key:'name',label:'åç¨±'},{key:'note',label:'å‚™è¨»'},{key:'mapKeyword',label:'åœ°åœ–é—œéµå­—'}]; modalData.value={hours:'',name:'',category:'Sightseeing'}; modalCallback.value=()=>{getCurrentItinerary().push(modalData.value);getCurrentItinerary().sort((a,b)=>a.hours.localeCompare(b.hours));saveData();}; showModal.value=true; };
        const openAddShopModal = () => { modalTitle.value='æ–°å¢å•†å“'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'link',label:'é€£çµ'}]; modalData.value={name:'',link:''}; modalCallback.value=()=>{shopping.value[shopCat.value].push(modalData.value);saveData();}; showModal.value=true; };
        const openAddSpotModal = () => { modalTitle.value='æ–°å¢æ™¯é»'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'desc',label:'æè¿°'},{key:'link',label:'é—œéµå­—'}]; modalData.value={name:'',desc:'',link:''}; modalCallback.value=()=>{spots.value.photo[currentLoc.value].push(modalData.value);saveData();}; showModal.value=true; };
        const openAddFoodModal = () => { modalTitle.value='æ–°å¢ç¾é£Ÿ'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'desc',label:'æè¿°'},{key:'link',label:'é—œéµå­—'},{key:'reserve',label:'éœ€è¨‚ä½?',type:'checkbox'}]; modalData.value={name:'',desc:'',link:'',reserve:false}; modalCallback.value=()=>{spots.value.food[currentLoc.value].push(modalData.value);saveData();}; showModal.value=true; };
        const openAddPhraseModal = () => { modalTitle.value='æ–°å¢ç¿»è­¯'; modalFields.value=[{key:'zh',label:'ä¸­æ–‡'},{key:'jp',label:'æ—¥æ–‡'}]; modalData.value={zh:'',jp:''}; modalCallback.value=()=>{japanesePhrases.value.push(modalData.value);saveData();}; showModal.value=true; };
        const handleModalSave = () => { if(modalCallback.value) modalCallback.value(); showModal.value=false; };
        const openExpenseModal = (mode) => { expenseMode.value=mode; modalData.value={name:'',amount:'',currency:'JPY',method:'cash',whoPaid:currentUser.value.id,forWhom:mode==='private'?[currentUser.value.id]:users.value.map(u=>u.id)}; showExpenseModal.value=true; };
        const saveExpense = () => { expenses.value.push({...modalData.value, id:Date.now()}); saveData(); showExpenseModal.value=false; };
        const deleteExpense = (id) => { if(isGuest.value) return; if(confirm('åˆªé™¤?')) { expenses.value = expenses.value.filter(e=>e.id!==id); saveData(); }};
        const initSakura = () => { const c = document.getElementById('sakura-container'); if(c) setInterval(()=>{ const p=document.createElement('div'); p.className='sakura'; p.style.left=Math.random()*100+'vw'; p.style.animationDuration=Math.random()*3+2+'s'; c.appendChild(p); setTimeout(()=>p.remove(),5000); }, 500); };
        const showDiagnostic = () => { showDebug.value = !showDebug.value; };

        return {
            currentView, currentUser, isGuest, isWelcomeClosed, isLoggedIn, isSaving, dbConnected, latency, showDebug,
            users, itinerary, shopping, spots, expenses, coupons, japanesePhrases, hotels, drivePlan,
            selectedDayIndex, itineraryMode, moneyTab, exchangeRate, shopCat, currentLoc, weatherData,
            showPersonaModal, showModal, modalTitle, modalFields, modalData, showCouponModal, showExpenseModal, expenseMode, couponBarMinimized,
            apps, tripDays, daysUntilTrip, smartReminders, activeUsersList, myPrivateExpenses, myPrivateTotalTWD, groupExpenses, settlements,
            enterSite, enterAsGuest, setCurrentUser, getPageTitle, getCurrentItinerary, getIconByCategory, getMapLink, getSearchLink, getImgPlaceholder, handleImgError, getPaymentIcon, getUserName, getClothingAdvice,
            openEditItineraryModal, openAddItineraryModal, openAddShopModal, openAddSpotModal, openAddFoodModal, openAddPhraseModal, handleModalSave, openExpenseModal, saveExpense, deleteExpense, showDiagnostic, fetchRealWeather
        };
    }
}).mount('#app');
</script>
</body>
</html>
