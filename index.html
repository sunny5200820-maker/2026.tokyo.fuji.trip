<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (V67.0 æˆ°æƒ…å®¤)</title>

<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

<script>
    window.tailwind = {
        config: {
            theme: {
                extend: {
                    colors: { 'chii-pink': '#FFD1DC', 'chii-blue': '#A2D2FF', 'chii-yellow': '#FFF5BA', 'emer-bg': '#FFF6F8', 'emer-blue': '#E0F7FA', 'emer-green': '#E8F5E9' },
                    fontFamily: { sans: ['Zen Maru Gothic', 'sans-serif'] },
                    animation: { 'float': 'float 6s ease-in-out infinite', 'pop': 'pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)', 'pulse-fast': 'pulse 1.5s infinite', 'siren': 'siren 1s infinite', 'wiggle': 'wiggle 3s ease-in-out infinite' },
                    keyframes: {
                        float: { '0%,100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        pop: { '0%': { transform: 'scale(0)' }, '100%': { transform: 'scale(1)' } },
                        siren: { '0%, 100%': { opacity: 1 }, '50%': { opacity: 0.5 } },
                        wiggle: { '0%,100%': { transform: 'rotate(-3deg)' }, '50%': { transform: 'rotate(3deg)' } }
                    }
                }
            }
        }
    }
</script>

<style>
    /* å…¨åŸŸè¨­å®š */
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: "Zen Maru Gothic", sans-serif; color: #5D4037; background-color: #FFF0F5; overflow: hidden; -webkit-tap-highlight-color: transparent; }
    #fixed-bg { position: fixed; inset: 0; z-index: -1; background-color: #FFF0F5; background-image: radial-gradient(#FFD1DC 15%, transparent 16%), radial-gradient(#FFF5BA 15%, transparent 16%); background-size: 60px 60px; background-position: 0 0, 30px 30px; opacity: 0.6; }
    
    #app-content { height: 100%; overflow-y: auto; padding-bottom: 120px; padding-top: env(safe-area-inset-top); transition: all 0.3s; }
    [v-cloak] { display: none !important; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }

    /* å¡ç‰‡èˆ‡æŒ‰éˆ• */
    .card { background: rgba(255,255,255,0.95); border-radius: 24px; box-shadow: 0 8px 25px rgba(255,105,180,0.15); border: 2px solid rgba(255,255,255,0.8); margin-bottom: 16px; backdrop-filter: blur(10px); position: relative; overflow: hidden; transition: transform 0.2s; }
    .card:active { transform: scale(0.98); border-color: #FFD1DC; }
    .btn-push { transition: transform 0.1s; } .btn-push:active { transform: scale(0.9); }

    /* ç·šä¸Šç‹€æ…‹ */
    .online-header-bubble { position: fixed; top: calc(12px + env(safe-area-inset-top)); right: 12px; z-index: 300; display: flex; gap: -5px; pointer-events: none; }
    .online-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; background: white; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-left: -10px; position: relative; transition: transform 0.3s; pointer-events: auto; }
    .online-avatar.active { border-color: #4ade80; transform: translateY(2px); z-index: 10; box-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
    .online-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .online-avatar .dot { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #ccc; border-radius: 50%; border: 2px solid white; }
    .online-avatar.active .dot { background: #4ade80; }

    /* æ‡¸æµ®è¿”å›éµ */
    .fab-home { position: fixed; bottom: calc(30px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); width: 64px; height: 64px; background: linear-gradient(135deg, #FF9EAC, #FFD1DC); border-radius: 50%; border: 4px solid white; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 10px 20px rgba(255,105,180,0.4); z-index: 90; cursor: pointer; transition: transform 0.2s; }
    .fab-home:active { transform: translateX(-50%) scale(0.9); }

    /* è¡Œç¨‹é€£æ¥ç·š */
    .timeline-connect { width: 2px; height: 30px; background: linear-gradient(to bottom, #FFD1DC, transparent); margin-left: 24px; margin-top: -10px; margin-bottom: -10px; position: relative; z-index: 0; }
    .timeline-badge { position: absolute; top: 50%; left: 10px; transform: translateY(-50%); background: #FFF0F5; color: #FF9EAC; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; border: 1px solid #FFD1DC; white-space: nowrap; }

    /* æ­¡è¿é  */
    .welcome-bg { position: absolute; inset: 0; z-index: 0; overflow: hidden; }
    .welcome-bg img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
    .glass-panel { background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); }

    /* æˆ°æƒ…çœ‹æ¿ */
    .dashboard-card { background: white; border-radius: 28px; padding: 20px; box-shadow: 0 10px 30px rgba(255,105,180,0.1); border: 4px solid white; margin-bottom: 24px; position: relative; overflow: hidden; }
    .dashboard-badge { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-black; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .alert-row { display: flex; items-center; gap: 8px; font-size: 13px; font-bold; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed #eee; }
    .alert-row:last-child { border-bottom: none; }

    /* å…¶ä»– UI */
    .hp-bar-bg { width: 100%; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 4px; }
    .hp-bar-fill { height: 100%; transition: width 0.5s; }
    .hp-high { background: #10b981; } .hp-med { background: #f59e0b; } .hp-low { background: #ef4444; }
    .suitcase-track { width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; border: 2px solid white; position: relative; overflow: hidden; }
    .suitcase-fill { height: 100%; background: linear-gradient(90deg, #60a5fa, #3b82f6); display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold; transition: width 0.5s; }
    .photo-card { height: 180px; position: relative; border-radius: 20px; overflow: hidden; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 12px; }
    .photo-card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .photo-info { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); padding: 12px; color: white; }
    
    /* ç·Šæ€¥åœ°åœ– */
    .emer-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media(min-width: 640px) { .emer-grid { grid-template-columns: 1fr 1fr; } }
    .emer-box { padding: 16px; border-radius: 20px; border: 3px solid white; position: relative; min-height: 140px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .emer-dialog { position: absolute; background: white; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
</style>
</head>
<body>

<div id="fixed-bg"></div>

<div id="app" v-cloak class="h-full flex flex-col relative">

    <div v-if="isLoading" class="fixed inset-0 z-[9999] bg-[#FFF0F5] flex flex-col items-center justify-center">
        <div class="text-6xl animate-bounce">ğŸ§¬</div>
        <div class="mt-4 font-black text-pink-500 text-xl tracking-widest">å¤šäººåŒæ­¥é€£ç·šä¸­...</div>
        <div class="text-xs text-gray-400 mt-2">V67.0 æˆ°æƒ…å®¤ç‰ˆ</div>
    </div>

    <div v-if="!isWelcomeClosed" class="welcome-screen h-full flex flex-col items-center justify-between p-6 relative overflow-hidden">
        <div class="welcome-bg"><img :src="getUnsplashUrl('cherry blossom illustration')" class="animate-float"></div>
        
        <div class="relative z-10 pt-20 text-center">
             <div class="inline-block glass-panel px-6 py-2 rounded-full text-white text-xs font-black tracking-[0.2em] mb-6 border border-white/40">TOKYO TRIP</div>
             <h1 class="text-7xl font-black text-white drop-shadow-lg tracking-widest mb-2" style="text-shadow: 0 4px 10px rgba(255,105,180,0.5);">é—œæ±ä¹‹æ—…</h1>
             <p class="text-3xl text-white/90 font-bold tracking-widest drop-shadow-md">2026.03.27</p>
        </div>

        <div class="relative z-10 w-full max-w-xs space-y-4 mb-10">
            <button @click="enterSite" class="w-full bg-white/90 backdrop-blur text-pink-500 font-black py-4 rounded-full shadow-2xl border-2 border-white btn-push text-lg flex items-center justify-center gap-2"><i class="fa-solid fa-plane"></i> æ—…ä¼´ç™»å…¥</button>
            <button @click="handleAuthClick" class="w-full glass-panel text-white font-bold py-3 rounded-full text-sm btn-push">
                {{ isLoggedIn ? 'ğŸŸ¢ é›²ç«¯å·²é€£ç·š' : 'â˜ï¸ ç™»å…¥é›²ç«¯åŒæ­¥' }}
            </button>
        </div>
    </div>

    <div v-if="isWelcomeClosed" class="h-full flex flex-col relative">
        
        <div class="online-header-bubble">
            <div v-for="u in users" :key="u.id" :class="['online-avatar', isUserOnline(u.id) ? 'active' : '']" :title="u.name">
                <div class="w-full h-full flex items-center justify-center text-lg bg-gray-50">{{u.icon}}</div>
                <div class="dot"></div>
            </div>
        </div>

        <div v-if="currentView !== 'menu'" class="h-[60px] shrink-0 bg-[#FFF0F5]/90 backdrop-blur flex items-center justify-between px-4 border-b border-white shadow-sm z-30 pt-[env(safe-area-inset-top)] box-content">
            <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full text-pink-400 shadow flex items-center justify-center btn-push"><i class="fa-solid fa-chevron-left"></i></button>
            <h1 class="font-black text-gray-700 text-lg"><i class="fa-solid fa-sakura text-pink-300 mr-2"></i>{{getPageTitle(currentView)}}</h1>
            <div class="w-10"></div>
        </div>

        <div id="app-content" class="flex-1 px-4 py-4">
            
            <div v-if="currentView==='menu'" class="pt-6 pb-32">
                
                <div class="flex justify-between items-center mb-6">
                    <button @click="isWelcomeClosed=false" class="text-xs bg-white text-gray-500 px-4 py-2 rounded-full font-bold border-2 border-gray-100 hover:bg-gray-50 shadow-sm transition flex items-center gap-2 btn-push">
                        <i class="fa-solid fa-house"></i> å›é¦–é 
                    </button>
                    <div class="text-xs text-gray-400 font-bold bg-white/50 px-3 py-1 rounded-full flex items-center gap-1">
                        <div class="w-2 h-2 rounded-full bg-green-400"></div> {{currentUser ? currentUser.name : 'è¨ªå®¢'}}
                    </div>
                </div>

                <div class="dashboard-card">
                    <div v-if="daysUntilTrip > 0">
                        <div class="dashboard-badge bg-red-100 text-red-600"><i class="fa-solid fa-triangle-exclamation"></i> å‡ºç™¼å‰æª¢æŸ¥</div>
                        
                        <div v-if="getUncheckedItemsCount(currentUser) > 0" class="mb-4">
                            <div class="alert-row text-red-500">
                                <i class="fa-solid fa-suitcase"></i> {{currentUser.name}} é‚„æœ‰ {{getUncheckedItemsCount(currentUser)}} é …ç‰©å“æœªå¸¶ï¼
                            </div>
                            <div class="text-xs text-gray-500 pl-6">
                                å°šæœªå‹¾é¸ï¼š{{ getUncheckedItemName(currentUser) }} ç­‰...
                            </div>
                        </div>
                        <div v-else class="mb-4 text-green-500 font-black flex items-center gap-2">
                            <i class="fa-solid fa-check-circle"></i> è¡Œææº–å‚™å®Œæˆï¼
                        </div>

                        <div class="border-t border-gray-100 pt-3">
                            <div v-for="alert in smartReminders" class="alert-row text-pink-500">
                                <i class="fa-solid fa-ticket animate-pulse"></i> {{alert}}
                            </div>
                            <div v-if="smartReminders.length===0" class="text-xs font-bold text-gray-400">ç›®å‰ç„¡ç·Šæ€¥ç¥¨åˆ¸ä»»å‹™ ğŸ‘Œ</div>
                        </div>
                    </div>

                    <div v-else>
                        <div class="dashboard-badge bg-blue-100 text-blue-600"><i class="fa-solid fa-location-dot"></i> æ—…ç¨‹æƒ…å ±</div>
                        
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="font-black text-3xl text-gray-800">æ±äº¬ {{weatherData[0].temp}}Â°C</h3>
                                <p class="text-xs font-bold text-blue-400 mt-1"><i class="fa-solid fa-shirt"></i> {{getClothingAdvice(weatherData[0].temp)}}</p>
                            </div>
                            <i class="fa-solid fa-cloud-sun text-5xl text-blue-200"></i>
                        </div>
                        <div class="bg-blue-50 p-2 rounded-lg text-xs font-bold text-blue-600 mb-3">
                            ğŸŒ‚ éš¨èº«æé†’ï¼šè­·ç…§ã€éŒ¢åŒ…ã€é›¨å‚˜
                        </div>

                        <div class="border-t border-gray-100 pt-3">
                            <div v-if="shopping[shopCat].length > 0" class="alert-row text-pink-500">
                                <i class="fa-solid fa-basket-shopping"></i> é‚„æœ‰ {{shopping[shopCat].length}} å€‹è—¥å¦/ä¼´æ‰‹ç¦®æœªè²·ï¼
                            </div>
                            <div v-else class="text-xs font-bold text-green-500">è³¼ç‰©æ¸…å–®å·²æ¸…ç©º ğŸ’¯</div>
                        </div>
                    </div>
                </div>

                <div class="text-center mb-8" v-if="daysUntilTrip > 0">
                    <div class="text-5xl font-black text-pink-500 drop-shadow-sm tracking-widest">{{daysUntilTrip}} <span class="text-lg text-gray-400">DAYS</span></div>
                    <div class="text-xs font-bold text-gray-400 tracking-widest mt-1">è·é›¢å‡ºç™¼å€’æ•¸</div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div v-for="app in apps" :key="app.id" @click="currentView=app.view" class="flex flex-col items-center btn-push cursor-pointer">
                        <div class="w-[72px] h-[72px] rounded-[24px] flex items-center justify-center text-3xl text-white shadow-lg border-[3px] border-white mb-2" :class="app.bgClass">
                            <i :class="app.icon"></i>
                        </div>
                        <span class="text-xs font-bold text-gray-600">{{app.name}}</span>
                    </div>
                </div>
            </div>

            <div v-if="currentView==='itinerary'">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4 pb-2 sticky top-0 z-20 bg-[#FFF0F5]/95 backdrop-blur py-2">
                    <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" 
                        :class="['flex-shrink-0 px-4 py-2 rounded-xl border-2 font-bold text-sm flex flex-col items-center min-w-[60px] transition-all', selectedDayIndex===i ? 'bg-pink-400 text-white border-pink-400 shadow-md scale-105' : 'bg-white text-gray-400 border-white']">
                        <span>{{d.week}}</span>
                        <div class="hp-bar-bg w-8"><div class="hp-bar-fill" :class="getStaminaColor(i)" :style="{width: getStamina(i)+'%'}"></div></div>
                    </button>
                </div>

                <div v-if="[2,3].includes(selectedDayIndex)" class="flex justify-center mb-4">
                    <div class="bg-white p-1 rounded-full border shadow-sm flex">
                        <button @click="itineraryMode='normal'" :class="['px-4 py-1 rounded-full text-xs font-bold transition', itineraryMode==='normal'?'bg-pink-400 text-white':'text-gray-400']">ä¸€èˆ¬</button>
                        <button @click="itineraryMode='drive'" :class="['px-4 py-1 rounded-full text-xs font-bold transition', itineraryMode==='drive'?'bg-green-500 text-white':'text-gray-400']"><i class="fa-solid fa-car"></i> è‡ªé§•</button>
                    </div>
                </div>

                <div class="space-y-0 pb-20">
                    <div v-for="(item, idx) in getCurrentItinerary()" :key="idx">
                        <div class="card p-4 flex gap-3 items-start group z-10 relative" @click="!isGuest && openEditItineraryModal(item, idx)">
                            <div class="flex flex-col items-center min-w-[50px]">
                                <span class="text-xs font-black text-gray-400 mb-1">{{item.hours}}</span>
                                <div class="w-8 h-8 rounded-full bg-pink-50 text-pink-400 flex items-center justify-center border border-pink-100"><i :class="getIconByCategory(item.category)"></i></div>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-black text-gray-800 text-lg">{{item.name}}</h3>
                                <p class="text-sm text-gray-500 font-bold mb-2">{{item.note}}</p>
                                <div class="flex flex-wrap gap-2">
                                    <a :href="getMapLink(item.mapKeyword)" target="_blank" @click.stop class="bg-blue-50 text-blue-500 px-2 py-1 rounded-lg text-xs font-bold border border-blue-100"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                                </div>
                            </div>
                            <div v-if="!isGuest" class="flex flex-col gap-1 opacity-20 group-hover:opacity-100 transition">
                                <button @click.stop="moveItineraryItem(idx, -1)" class="w-6 h-6 bg-gray-100 rounded text-gray-500 text-xs"><i class="fa-solid fa-chevron-up"></i></button>
                                <button @click.stop="moveItineraryItem(idx, 1)" class="w-6 h-6 bg-gray-100 rounded text-gray-500 text-xs"><i class="fa-solid fa-chevron-down"></i></button>
                            </div>
                        </div>
                        <div v-if="idx < getCurrentItinerary().length - 1" class="timeline-connect">
                            <div class="timeline-badge" v-if="item.travelTime">{{item.travelTime}}</div>
                            <div class="timeline-badge" v-else>â¬‡ ç§»å‹•ä¸­</div>
                        </div>
                    </div>
                    <button v-if="!isGuest" @click="openAddItineraryModal" class="w-full py-4 mt-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white">+ æ–°å¢è¡Œç¨‹</button>
                </div>
            </div>

            <div v-if="currentView==='money'">
                <div class="flex justify-center gap-2 mb-4">
                    <button @click="moneyTab='record'" :class="['px-6 py-2 rounded-full font-bold text-sm transition', moneyTab==='record'?'bg-yellow-400 text-white shadow':'bg-white text-gray-400']">æˆ‘çš„ç§å¸³</button>
                    <button @click="moneyTab='split'" :class="['px-6 py-2 rounded-full font-bold text-sm transition', moneyTab==='split'?'bg-blue-400 text-white shadow':'bg-white text-gray-400']">å…¬æ¬¾åˆ†å¸³</button>
                </div>
                
                <div class="bg-white px-4 py-2 rounded-xl mb-4 flex items-center justify-between border border-gray-100 shadow-sm">
                    <span class="text-xs font-bold text-gray-400">ç›®å‰åŒ¯ç‡ (JPY -> TWD)</span>
                    <input v-model="exchangeRate" type="number" step="0.001" class="w-16 text-right font-black text-yellow-500 outline-none" @change="saveData">
                </div>

                <div v-if="moneyTab==='record'">
                    <div class="card bg-gradient-to-r from-yellow-300 to-orange-400 border-none text-white p-6 mb-4">
                        <div class="text-xs font-bold opacity-80 mb-1">ç§äººç¸½æ”¯å‡º</div>
                        <div class="text-4xl font-black">NT$ {{ Math.round(myPrivateTotalTWD).toLocaleString() }}</div>
                    </div>
                    <div v-for="exp in myPrivateExpenses" :key="exp.id" class="card p-4 flex justify-between items-center">
                        <div><div class="font-bold text-gray-800">{{exp.name}}</div><div class="text-xs text-gray-400">{{exp.date}}</div></div>
                        <div class="text-right">
                            <div class="font-black text-gray-700">{{exp.currency}} {{exp.amount}}</div>
                            <button @click="deleteExpense(exp.id)" class="text-red-300 text-xs"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <button @click="openExpenseModal('private')" class="fab-home bg-yellow-400 text-white"><i class="fa-solid fa-plus"></i></button>
                </div>

                <div v-if="moneyTab==='split'">
                    <div class="card bg-blue-50 border-blue-200 p-4 mb-4">
                        <h3 class="font-bold text-blue-500 mb-2 text-sm"><i class="fa-solid fa-calculator"></i> å»ºè­°çµç®— (å°å¹£)</h3>
                        <div v-for="s in settlements" class="flex justify-between text-sm font-bold border-b border-blue-100 py-2 last:border-0">
                            <span class="text-gray-600">{{getUserName(s.from)}} âœ {{getUserName(s.to)}}</span>
                            <span class="text-blue-600">${{s.amount}}</span>
                        </div>
                    </div>
                    <div v-for="exp in groupExpenses" :key="exp.id" class="card p-4">
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-gray-800">{{exp.name}}</span>
                            <span class="font-black text-blue-500">{{exp.currency}} {{exp.amount}}</span>
                        </div>
                        <div class="flex justify-between items-end">
                            <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded font-bold">{{getUserName(exp.whoPaid)}} å¢Šä»˜ âœ {{exp.forWhom.length}}äººåˆ†</span>
                            <button v-if="exp.whoPaid===currentUser.id" @click="deleteExpense(exp.id)" class="text-red-300 px-2"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <button @click="openExpenseModal('split')" class="fab-home bg-blue-400 text-white"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>

            <div v-if="currentView==='hotel'">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4">
                    <button v-for="tab in ['stay','ticket','flight','car']" @click="hotelTab=tab" 
                        :class="['px-4 py-2 rounded-full font-bold text-xs whitespace-nowrap transition', hotelTab===tab?'bg-indigo-500 text-white':'bg-white text-gray-400']">
                        {{ {'stay':'ä½å®¿','ticket':'ç¥¨åˆ¸','flight':'æ©Ÿç¥¨','car':'ç§Ÿè»Š'}[tab] }}
                    </button>
                </div>

                <div v-if="hotelTab==='stay'" class="space-y-4">
                    <div v-for="(h, idx) in hotels" :key="idx" class="card !p-0">
                        <div class="h-32 bg-gray-200 relative"><img :src="getImg(h.name)" class="w-full h-full object-cover"><div class="absolute bottom-2 left-3 text-white font-black text-xl drop-shadow-md">{{h.name}}</div></div>
                        <div class="p-3"><a :href="getMapLink(h.name)" target="_blank" class="block w-full bg-indigo-50 text-indigo-500 text-center font-bold py-2 rounded-lg text-sm">å°èˆªå‰å¾€</a></div>
                    </div>
                </div>

                <div v-if="hotelTab==='ticket'" class="space-y-4">
                    <div v-for="(t, idx) in transportTickets" :key="idx" class="card p-4">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2"><i class="fa-solid fa-ticket text-pink-500 text-xl"></i><span class="font-black text-lg">{{t.name}}</span></div>
                            <a :href="t.url" target="_blank" class="bg-pink-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow">è³¼è²·/ä½¿ç”¨</a>
                        </div>
                        <p class="text-xs text-gray-500 font-bold bg-gray-50 p-2 rounded">{{t.note}}</p>
                    </div>
                </div>

                <div v-if="hotelTab==='flight'" class="space-y-4">
                     <div class="card p-4 border-l-4 border-blue-500">
                        <div class="flex justify-between items-center mb-2"><span class="font-black text-gray-800">å»ç¨‹ (OUT)</span><button v-if="!isGuest" @click="editFlight('out')" class="text-gray-400"><i class="fa-solid fa-pen"></i></button></div>
                        <div class="flex justify-between items-end bg-blue-50 p-3 rounded-xl">
                            <div><div class="text-xs text-blue-300 font-bold">FLIGHT</div><div class="text-2xl font-black text-blue-600">{{currentUser.flightOut||'--'}}</div></div>
                            <div class="text-right"><div class="text-xs text-blue-300 font-bold">SEAT</div><div class="text-2xl font-black text-blue-600">{{currentUser.flightOutSeat||'--'}}</div></div>
                        </div>
                     </div>
                     <div class="card p-4 border-l-4 border-indigo-500">
                        <div class="flex justify-between items-center mb-2"><span class="font-black text-gray-800">å›ç¨‹ (IN)</span><button v-if="!isGuest" @click="editFlight('in')" class="text-gray-400"><i class="fa-solid fa-pen"></i></button></div>
                        <div class="flex justify-between items-end bg-indigo-50 p-3 rounded-xl">
                            <div><div class="text-xs text-indigo-300 font-bold">FLIGHT</div><div class="text-2xl font-black text-indigo-600">{{currentUser.flightIn||'--'}}</div></div>
                            <div class="text-right"><div class="text-xs text-indigo-300 font-bold">SEAT</div><div class="text-2xl font-black text-indigo-600">{{currentUser.flightInSeat||'--'}}</div></div>
                        </div>
                     </div>
                </div>

                <div v-if="hotelTab==='car'" class="space-y-4">
                    <div v-for="(car,idx) in rentalCars" :key="idx" class="card p-4">
                        <h3 class="font-black text-lg mb-1">{{car.company}}</h3>
                        <p class="text-xs text-gray-500 font-bold mb-3"><i class="fa-solid fa-location-dot"></i> å–è»Šï¼š{{car.pickup}}</p>
                        <a :href="car.url" target="_blank" class="block w-full bg-green-500 text-white text-center font-bold py-2 rounded-lg text-sm shadow">å‰å¾€é ç´„</a>
                    </div>
                </div>
            </div>

            <div v-if="currentView==='prep'">
                <div class="bg-blue-50 rounded-2xl p-4 mb-4 border-2 border-blue-200 border-dashed text-center">
                    <div class="text-blue-500 font-black text-xs uppercase mb-2">Packing Status</div>
                    <div class="suitcase-track mb-2"><div class="suitcase-fill" :style="{width: getPackingProgress(currentUser)+'%'}">{{getPackingProgress(currentUser)}}%</div></div>
                </div>

                <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="card p-4 flex items-center justify-between mb-4 bg-gradient-to-r from-blue-600 to-blue-400 text-white border-none">
                    <div class="flex items-center gap-3"><i class="fa-solid fa-qrcode text-3xl"></i><div><div class="font-bold">Visit Japan Web</div><div class="text-xs opacity-80">å…¥å¢ƒå¯©æŸ¥ / æµ·é—œç”³å ±</div></div></div><i class="fa-solid fa-chevron-right"></i>
                </a>

                <div class="card p-0">
                    <div class="bg-gray-50 p-3 font-bold text-gray-600 flex justify-between items-center border-b">
                        <span><i class="fa-solid fa-list-check mr-2"></i>{{currentUser.name}} çš„æ¸…å–®</span>
                        <button @click="addPrepItem" class="text-blue-500 text-xs bg-blue-100 px-2 py-1 rounded-full">+ æ–°å¢</button>
                    </div>
                    <div v-for="(item,idx) in currentUser.list" :key="idx" class="flex items-center p-3 border-b border-gray-100">
                        <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-500 mr-3" @change="saveData">
                        <input v-model="item.text" @change="saveData" :class="['flex-1 bg-transparent outline-none font-bold text-sm', item.checked?'text-gray-300 line-through':'text-gray-700']">
                        <button @click="currentUser.list.splice(idx,1);saveData()" class="text-gray-300 px-2"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
            </div>

            <div v-if="currentView==='food'">
                <div class="flex gap-2 justify-center mb-4">
                    <button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="currentLoc=loc" :class="['px-4 py-2 rounded-full font-bold text-xs transition', currentLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400']">{{loc}}</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div v-for="(item,idx) in spots.food[currentLoc]" :key="idx" class="card p-0 pb-3">
                         <div class="h-40 bg-gray-200 relative"><img :src="getUnsplashUrl(item.name + ' food')" class="w-full h-full object-cover"><div v-if="item.reserve" class="absolute top-2 right-2 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-full">éœ€é ç´„</div></div>
                         <div class="px-4 pt-3">
                             <h3 class="font-black text-lg">{{item.name}}</h3>
                             <p class="text-xs text-gray-500 font-bold mb-3">{{item.desc}}</p>
                             <div class="flex gap-2">
                                 <button @click="quickExpense(item)" class="flex-1 bg-yellow-400 text-white font-bold py-2 rounded-lg text-xs">ğŸ’° è¨˜å¸³</button>
                                 <a :href="getMapLink(item.name)" target="_blank" class="flex-1 bg-gray-100 text-gray-500 text-center font-bold py-2 rounded-lg text-xs">ğŸ“ å°èˆª</a>
                             </div>
                         </div>
                    </div>
                </div>
                <button v-if="!isGuest" @click="openAddFoodModal" class="fab-home bg-orange-400 text-white"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div v-if="currentView==='photo'">
                <div class="flex gap-2 justify-center mb-4">
                    <button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="currentLoc=loc" :class="['px-4 py-2 rounded-full font-bold text-xs transition', currentLoc===loc?'bg-rose-400 text-white':'bg-white text-gray-400']">{{loc}}</button>
                </div>
                <div class="space-y-4">
                    <div v-for="(spot,idx) in spots.photo[currentLoc]" :key="idx" class="photo-card" @click="openLightbox(getUnsplashUrl(spot.link))">
                        <img :src="getUnsplashUrl(spot.link)">
                        <div class="photo-info">
                            <h3 class="font-black text-lg">{{spot.name}}</h3>
                            <p class="text-xs opacity-90 mb-2">{{spot.desc}}</p>
                            <a :href="getMapLink(spot.name)" target="_blank" @click.stop class="bg-white/20 backdrop-blur border border-white/50 px-3 py-1 rounded-full text-[10px] font-bold">ğŸ“ å°èˆªå»æ‹</a>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView==='shopping'">
                <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
                    <button v-for="cat in ['cosme','ldk','souvenir']" @click="shopCat=cat" :class="['px-4 py-2 rounded-full font-bold text-xs whitespace-nowrap', shopCat===cat?'bg-purple-400 text-white':'bg-white text-gray-400']">{{{'cosme':'è—¥å¦','ldk':'LDK','souvenir':'ä¼´æ‰‹ç¦®'}[cat]}}</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(item,idx) in shopping[shopCat]" :key="idx" class="card p-3">
                        <div class="h-24 bg-gray-100 rounded-xl mb-2 relative overflow-hidden"><img :src="getUnsplashUrl(item.name)" class="w-full h-full object-cover opacity-80"></div>
                        <div class="font-bold text-gray-800 text-sm truncate mb-1">{{item.name}}</div>
                        <a :href="`https://www.google.com/search?q=${item.name}`" target="_blank" class="block bg-gray-100 text-gray-500 text-center font-bold py-1 rounded text-[10px]">æœå°‹åœ–ç‰‡</a>
                    </div>
                </div>
                <button v-if="!isGuest" @click="openAddShopModal" class="fab-home bg-purple-400 text-white"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div v-if="currentView==='weather'">
                <div v-for="w in weatherData" :key="w.name" class="card p-6 text-white mb-4" :class="w.bg">
                    <div class="flex justify-between items-center">
                        <div><div class="text-xs font-bold opacity-80 tracking-widest uppercase">{{w.id}}</div><div class="text-5xl font-black my-2">{{w.temp}}Â°</div></div>
                        <i :class="w.icon" class="text-4xl opacity-80"></i>
                    </div>
                    <div class="bg-white/20 inline-block px-3 py-1 rounded-full text-xs font-bold backdrop-blur">ğŸ‘• {{getClothingAdvice(w.temp)}}</div>
                </div>
                <button @click="fetchWeather" class="w-full py-3 bg-white text-blue-500 font-bold rounded-2xl shadow-sm border border-blue-100">ğŸ”„ æ›´æ–°å¤©æ°£</button>
            </div>

            <div v-if="currentView==='emergency'">
                <div class="emer-grid mb-20">
                    <div class="emer-box bg-white border-red-100">
                        <div class="emer-dialog top-2 left-2">é‡åˆ°å±éšªæ‰“110</div>
                        <div class="flex justify-center my-4 text-6xl text-gray-200"><i class="fa-solid fa-user-shield"></i></div>
                        <a href="tel:110" class="block w-full bg-gray-800 text-white text-center py-2 rounded-xl font-bold">æ’¥æ‰“ 110 (è­¦å¯Ÿ)</a>
                    </div>
                    <div class="emer-box bg-emer-blue border-blue-100">
                        <div class="emer-dialog top-2 right-2">å—å‚·ç”Ÿç—…æ‰“119</div>
                        <div class="flex justify-center my-4 text-6xl text-blue-200"><i class="fa-solid fa-truck-medical"></i></div>
                        <a href="tel:119" class="block w-full bg-blue-500 text-white text-center py-2 rounded-xl font-bold">æ’¥æ‰“ 119 (æ•‘è­·)</a>
                    </div>
                    <div class="emer-box bg-pink-50 border-pink-100 col-span-full">
                        <div class="flex justify-between items-center mb-2"><h3 class="font-black text-pink-500">å°ç£é§æ—¥ä»£è¡¨è™•</h3><span class="text-xs font-bold text-pink-400">ç·Šæ€¥: 090-6866-0101</span></div>
                        <a href="tel:09068660101" class="block w-full bg-pink-500 text-white text-center py-3 rounded-xl font-bold shadow animate-pulse">æ’¥æ‰“ç·Šæ€¥è¯çµ¡é›»è©±</a>
                    </div>
                </div>
                <div class="fixed bottom-24 right-4 flex flex-col gap-3 z-50">
                    <button @click="handleCameraTranslate" class="w-14 h-14 rounded-full bg-gray-800 text-white flex items-center justify-center text-xl shadow-lg border-2 border-white"><i class="fa-solid fa-camera"></i></button>
                    <button @click="showTranslateModal=true" class="w-14 h-14 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xl shadow-lg border-2 border-white animate-bounce"><i class="fa-solid fa-language"></i></button>
                </div>
            </div>

        </div> <div v-if="currentView !== 'menu'" class="fab-home" @click="currentView='menu'"><i class="fa-solid fa-house"></i></div>

        <div v-if="showTranslateModal" class="fixed inset-0 z-[2000] bg-black/60 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
            <div class="bg-white w-full sm:max-w-md h-[80vh] sm:h-auto sm:rounded-3xl rounded-t-3xl p-6 flex flex-col shadow-2xl">
                <div class="flex justify-between items-center mb-4"><h3 class="font-black text-2xl text-indigo-500">ç¿»è­¯è’Ÿè’»</h3><button @click="showTranslateModal=false" class="text-gray-400"><i class="fa-solid fa-times text-2xl"></i></button></div>
                <div class="flex-1 overflow-y-auto space-y-3">
                    <div v-for="(p,idx) in phrases" :key="idx" class="card p-4 border-l-4 border-indigo-400 cursor-pointer" @click="speak(p.jp)">
                        <div class="font-bold text-lg text-gray-800">{{p.jp}}</div>
                        <div class="text-xs text-gray-500 font-bold">{{p.zh}}</div>
                        <i class="fa-solid fa-volume-high absolute right-4 top-4 text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showModal" class="fixed inset-0 z-[3000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="font-bold text-lg mb-4 text-center">{{modalTitle}}</h3>
                <div class="space-y-3 mb-6">
                    <div v-for="f in modalFields" :key="f.key">
                        <label v-if="f.label" class="text-xs font-bold text-gray-400 ml-1">{{f.label}}</label>
                        <input v-model="modalData[f.key]" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-pink-300 font-bold text-gray-700">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button @click="showModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                    <button @click="handleModalSave" class="flex-1 py-3 bg-pink-500 text-white rounded-xl font-bold shadow-lg">å„²å­˜</button>
                </div>
            </div>
        </div>

        <div v-if="showPersonaModal" class="fixed inset-0 z-[2000] bg-black/80 flex items-center justify-center p-6 backdrop-blur-md">
            <div class="bg-white w-full max-w-sm rounded-[32px] p-8 text-center border-4 border-pink-200">
                <h3 class="font-black text-2xl mb-6 text-pink-500">è«‹å•æ‚¨æ˜¯å“ªä¸€ä½ï¼Ÿ</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="u in users" :key="u.id" @click="setCurrentUser(u)" class="group cursor-pointer relative">
                        <div class="w-20 h-20 mx-auto rounded-2xl bg-gray-50 border-2 border-gray-100 flex items-center justify-center text-4xl mb-2 group-hover:border-pink-400 group-hover:scale-110 transition">{{u.icon}}</div>
                        <div class="font-black text-gray-600">{{u.name}}</div>
                        <button @click.stop="openEditUser(u)" class="absolute -top-1 -right-1 w-6 h-6 bg-gray-300 rounded-full text-white text-xs flex items-center justify-center"><i class="fa-solid fa-pen"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { createApp, ref, computed, onMounted } from "https://unpkg.com/vue@3.3.4/dist/vue.esm-browser.js";

const firebaseConfig = { apiKey: "AIzaSyD3ojbkJVfDKmZQHRpZG-gp8gv7ajKdJr4", authDomain: "tokyo-trip-24b28.firebaseapp.com", projectId: "tokyo-trip-24b28", storageBucket: "tokyo-trip-24b28.firebasestorage.app", messagingSenderId: "518699705070", appId: "1:518699705070:web:56e95f603210d8d5d209ff" };
let auth, db; try { const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); enableIndexedDbPersistence(db).catch(()=>{}); } catch(e){console.warn("FB Error");}

// Fallback Only (Cloud First)
const fallbackData = {
    users: [{id:1,name:'å‰ä¼Š',icon:'ğŸ¹',list:[],flightOut:'',flightIn:''},{id:2,name:'å°å…«',icon:'ğŸ±',list:[],flightOut:'',flightIn:''},{id:3,name:'å…”å…”',icon:'ğŸ°',list:[],flightOut:'',flightIn:''},{id:4,name:'å°æ¡ƒ',icon:'ğŸ‘',list:[],flightOut:'',flightIn:''}],
    itinerary: [], spots: { food:{Tokyo:[],Kamakura:[],Fuji:[]}, photo:{Tokyo:[],Kamakura:[],Fuji:[]} }, shopping: { cosme:[], ldk:[], souvenir:[] }, hotels: [], transportTickets: [], rentalCars: [],
    phrases: [{jp:'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹',zh:'å»æ‰€åœ¨å“ª'},{jp:'ã“ã‚Œãã ã•ã„',zh:'æˆ‘è¦é€™å€‹'},{jp:'ã„ãã‚‰ã§ã™ã‹',zh:'å¤šå°‘éŒ¢'},{jp:'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™',zh:'çµå¸³'},{jp:'åŠ©ã‘ã¦ãã ã•ã„',zh:'æ•‘å‘½'}]
};

createApp({
    setup() {
        const isLoading = ref(true);
        const currentView = ref('welcome');
        const isWelcomeClosed = ref(false);
        const isLoggedIn = ref(false);
        const showPersonaModal = ref(false);
        const showTranslateModal = ref(false);
        const showModal = ref(false);
        const currentUser = ref(null);
        const isGuest = ref(false);
        const activeUsers = ref({});
        
        const users = ref(fallbackData.users);
        const itinerary = ref([]);
        const spots = ref(fallbackData.spots);
        const shopping = ref(fallbackData.shopping);
        const hotels = ref([]);
        const transportTickets = ref([]);
        const rentalCars = ref([]);
        const phrases = ref(fallbackData.phrases);
        const expenses = ref([]);
        const exchangeRate = ref(0.215);
        
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        const moneyTab = ref('record');
        const hotelTab = ref('stay');
        const currentLoc = ref('Tokyo');
        const shopCat = ref('cosme');
        const modalTitle = ref('');
        const modalFields = ref([]);
        const modalData = ref({});
        const modalCallback = ref(null);

        const apps = [
            {id:1,name:'è¡Œç¨‹è¡¨',icon:'fa-solid fa-map',view:'itinerary',bgClass:'bg-pink-400'},
            {id:2,name:'å°è²¡åº«',icon:'fa-solid fa-yen-sign',view:'money',bgClass:'bg-yellow-400'},
            {id:3,name:'ä½å®¿äº¤é€š',icon:'fa-solid fa-hotel',view:'hotel',bgClass:'bg-indigo-400'},
            {id:4,name:'è¡Œå‰æº–å‚™',icon:'fa-solid fa-suitcase',view:'prep',bgClass:'bg-blue-400'},
            {id:5,name:'ç¾é£Ÿåœ°åœ–',icon:'fa-solid fa-utensils',view:'food',bgClass:'bg-orange-400'},
            {id:6,name:'å¿…æ‹æ©Ÿä½',icon:'fa-solid fa-camera',view:'photo',bgClass:'bg-rose-400'},
            {id:7,name:'å¿«æ¨‚è³¼',icon:'fa-solid fa-bag-shopping',view:'shopping',bgClass:'bg-purple-400'},
            {id:8,name:'å¤©æ°£é å ±',icon:'fa-solid fa-cloud-sun',view:'weather',bgClass:'bg-sky-400'},
            {id:9,name:'æ€¥æ•‘åŒ…',icon:'fa-solid fa-kit-medical',view:'emergency',bgClass:'bg-red-400'}
        ];

        const tripDays = [{week:'D1'},{week:'D2'},{week:'D3'},{week:'D4'},{week:'D5'},{week:'D6'},{week:'D7'},{week:'D8'}];
        const daysUntilTrip = ref(Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24)));
        const smartReminders = computed(() => { const l=[]; if(daysUntilTrip.value<=30) l.push("å¯Œå£«å›éŠè™Ÿï¼šæº–å‚™æ¶ç¥¨"); if(daysUntilTrip.value<=28) l.push("SHIBUYA SKYï¼šæ¶é»ƒæ˜ç¥¨"); return l; });
        const weatherData = ref([{id:'Tokyo',temp:18,icon:'fa-solid fa-cloud-sun',bg:'bg-blue-400'},{id:'Fuji',temp:12,icon:'fa-solid fa-cloud',bg:'bg-indigo-400'}]);

        // Helpers
        const getImg = (p) => p && !p.startsWith('http') ? `https://source.unsplash.com/400x300/?${encodeURIComponent(p)}` : p; 
        const getUnsplashUrl = (k) => `https://source.unsplash.com/600x800/?${encodeURIComponent(k)}`;
        const getMapLink = (k) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}`;
        const getPageTitle = (v) => apps.find(a=>a.view===v)?.name || 'é—œæ±ä¹‹æ—…';
        const getIconByCategory = (c) => ({'Flight':'fa-solid fa-plane','Sightseeing':'fa-solid fa-camera','Food':'fa-solid fa-utensils','Shopping':'fa-solid fa-bag-shopping','Transport':'fa-solid fa-train-subway'}[c]||'fa-solid fa-location-dot');
        const getStamina = (i) => [100,80,60,50,70,90,80,100][i] || 100;
        const getStaminaColor = (i) => getStamina(i)<60?'hp-low':getStamina(i)<80?'hp-med':'hp-high';
        
        const myPrivateExpenses = computed(() => currentUser.value ? expenses.value.filter(e => e.whoPaid===currentUser.value.id && e.forWhom.length===1) : []);
        const myPrivateTotalTWD = computed(() => myPrivateExpenses.value.reduce((s,e) => s + (e.currency==='JPY'?e.amount*exchangeRate.value:e.amount), 0));
        const groupExpenses = computed(() => expenses.value.filter(e => e.forWhom.length > 1 || e.whoPaid !== e.forWhom[0]));
        const settlements = computed(() => {
            let bal = {}; users.value.forEach(u=>bal[u.id]=0);
            groupExpenses.value.forEach(e => {
                let amt = e.currency==='JPY' ? e.amount*exchangeRate.value : e.amount;
                bal[e.whoPaid] += amt;
                let share = amt / e.forWhom.length;
                e.forWhom.forEach(uid => bal[uid] -= share);
            });
            let res=[], debtors=Object.keys(bal).filter(k=>bal[k]<-1).map(k=>({id:parseInt(k),val:bal[k]}));
            let creditors=Object.keys(bal).filter(k=>bal[k]>1).map(k=>({id:parseInt(k),val:bal[k]}));
            debtors.sort((a,b)=>a.val-b.val); creditors.sort((a,b)=>b.val-a.val);
            let i=0,j=0; while(i<debtors.length && j<creditors.length){
                let amt = Math.min(-debtors[i].val, creditors[j].val);
                res.push({from:debtors[i].id, to:creditors[j].id, amount:Math.round(amt)});
                debtors[i].val += amt; creditors[j].val -= amt;
                if(Math.abs(debtors[i].val)<1) i++; if(Math.abs(creditors[j].val)<1) j++;
            }
            return res;
        });

        // Functions
        const saveData = async () => {
            if(!isLoggedIn.value) return;
            if(users.value.length === 0) return;
            try {
                await setDoc(doc(db,"trips","kanto2026"), {
                    users:users.value, itinerary:itinerary.value, spots:spots.value, shopping:shopping.value,
                    expenses:expenses.value, hotels:hotels.value, transportTickets:transportTickets.value, 
                    rentalCars:rentalCars.value, phrases:phrases.value, exchangeRate:exchangeRate.value
                }, {merge:true});
            } catch(e){console.error(e);}
        };

        const updateHeartbeat = async () => {
             if(!isLoggedIn.value || !currentUser.value) return;
             try { await updateDoc(doc(db,"trips","kanto2026"), { [`heartbeats.${currentUser.value.id}`]: serverTimestamp() }); } catch(e){}
        };
        const isUserOnline = (id) => {
            const last = activeUsers.value[id];
            return last && (Date.now() - last) < 65000; // 65ç§’å…§æœ‰å¿ƒè·³è¦–ç‚ºåœ¨ç·š
        };

        const enterSite = () => { isGuest.value=false; isWelcomeClosed.value=true; showPersonaModal.value=true; };
        const handleAuthClick = () => { if(isLoggedIn.value) signOut(auth); else alert('è«‹å¯¦ä½œç™»å…¥ Modal'); }; 
        const setCurrentUser = (u) => { currentUser.value=u; showPersonaModal.value=false; currentView.value='menu'; updateHeartbeat(); };
        const openEditUser = (u) => { 
            modalTitle.value='ç·¨è¼¯è§’è‰²'; modalFields.value=[{key:'name',label:'åå­—'},{key:'icon',label:'åœ–ç¤º(Emoji)'}];
            modalData.value={...u};
            modalCallback.value=()=>{ const idx = users.value.findIndex(user=>user.id===u.id); if(idx!==-1) users.value[idx] = modalData.value; saveData(); };
            showModal.value=true; 
        };
        const getUserName = (id) => users.value.find(u=>u.id===id)?.name || 'æœªçŸ¥';
        const getCurrentItinerary = () => {
             let dayData = itinerary.value[selectedDayIndex.value];
             if(!dayData) { itinerary.value[selectedDayIndex.value] = []; return itinerary.value[selectedDayIndex.value]; }
             return dayData;
        };
        const moveItineraryItem = (idx, dir) => {
            const arr = getCurrentItinerary();
            if(idx+dir >=0 && idx+dir < arr.length) { [arr[idx], arr[idx+dir]] = [arr[idx+dir], arr[idx]]; saveData(); }
        };
        
        // War Room Logic
        const getUncheckedItemsCount = (u) => u && u.list ? u.list.filter(i=>!i.checked).length : 0;
        const getUncheckedItemName = (u) => { const item = u.list.find(i=>!i.checked); return item ? item.text : ''; };

        const getPackingProgress = (u) => { if(!u || !u.list.length) return 0; return Math.round((u.list.filter(i=>i.checked).length / u.list.length)*100); };
        const openEditItineraryModal = (item, idx) => {
            modalTitle.value='ç·¨è¼¯è¡Œç¨‹'; modalFields.value=[{key:'hours',label:'æ™‚é–“'},{key:'name',label:'åç¨±'},{key:'note',label:'å‚™è¨»'},{key:'mapKeyword',label:'åœ°åœ–é—œéµå­—'},{key:'travelTime',label:'äº¤é€šæ™‚é–“(é¸å¡«)'}];
            modalData.value={...item}; modalCallback.value=()=>{ getCurrentItinerary()[idx]=modalData.value; saveData(); }; showModal.value=true;
        };
        const openAddItineraryModal = () => {
            modalTitle.value='æ–°å¢è¡Œç¨‹'; modalFields.value=[{key:'hours',label:'æ™‚é–“'},{key:'name',label:'åç¨±'},{key:'note',label:'å‚™è¨»'},{key:'mapKeyword',label:'åœ°åœ–é—œéµå­—'}];
            modalData.value={hours:'',name:'',note:'',category:'Sightseeing'}; modalCallback.value=()=>{ getCurrentItinerary().push(modalData.value); getCurrentItinerary().sort((a,b)=>a.hours.localeCompare(b.hours)); saveData(); }; showModal.value=true;
        };
        const openExpenseModal = (mode) => {
            modalTitle.value = mode==='private'?'è¨˜ä¸€ç­†ç§å¸³':'å…¬æ¬¾åˆ†å¸³'; modalFields.value = [{key:'name',label:'é …ç›®'},{key:'amount',label:'é‡‘é¡'},{key:'currency',label:'å¹£åˆ¥ (JPY/TWD)'}];
            modalData.value = {name:'',amount:'',currency:'JPY',whoPaid:currentUser.value.id,forWhom:mode==='private'?[currentUser.value.id]:users.value.map(u=>u.id)};
            modalCallback.value = () => { expenses.value.push({...modalData.value, id:Date.now(), date:new Date().toLocaleDateString()}); saveData(); }; showModal.value=true;
        };
        const deleteExpense = (id) => { if(confirm('åˆªé™¤?')) { expenses.value=expenses.value.filter(e=>e.id!==id); saveData(); } };
        const quickExpense = (item) => { modalTitle.value='å¿«é€Ÿè¨˜å¸³'; modalFields.value=[{key:'amount',label:'é‡‘é¡ (JPY)'}]; modalData.value={name:item.name,amount:'',currency:'JPY',whoPaid:currentUser.value.id,forWhom:[currentUser.value.id]}; modalCallback.value=()=>{expenses.value.push({...modalData.value,id:Date.now(),date:new Date().toLocaleDateString()}); saveData();}; showModal.value=true; };
        const editFlight = (type) => { 
            modalTitle.value=type==='out'?'å»ç¨‹æ©Ÿç¥¨':'å›ç¨‹æ©Ÿç¥¨'; modalFields.value=[{key:'flight',label:'èˆªç­è™Ÿ'},{key:'seat',label:'åº§ä½'}];
            modalData.value={flight:type==='out'?currentUser.value.flightOut:currentUser.value.flightIn, seat:type==='out'?currentUser.value.flightOutSeat:currentUser.value.flightInSeat};
            modalCallback.value=()=>{ if(type==='out'){currentUser.value.flightOut=modalData.value.flight;currentUser.value.flightOutSeat=modalData.value.seat;}else{currentUser.value.flightIn=modalData.value.flight;currentUser.value.flightInSeat=modalData.value.seat;} saveData(); }; showModal.value=true; 
        };
        const addPrepItem = () => { currentUser.value.list.push({text:'æ–°é …ç›®',checked:false}); saveData(); };
        const openAddFoodModal = () => { modalTitle.value='æ–°å¢ç¾é£Ÿ'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'desc',label:'æè¿°'}]; modalData.value={name:'',desc:'',reserve:false,img:''}; modalCallback.value=()=>{ spots.value.food[currentLoc.value].push(modalData.value); saveData(); }; showModal.value=true; };
        const openAddShopModal = () => { modalTitle.value='æ–°å¢å•†å“'; modalFields.value=[{key:'name',label:'åç¨±'}]; modalData.value={name:'',img:''}; modalCallback.value=()=>{ shopping.value[shopCat.value].push(modalData.value); saveData(); }; showModal.value=true; };
        const handleModalSave = () => { if(modalCallback.value) modalCallback.value(); showModal.value=false; };
        const speak = (txt) => { const u=new SpeechSynthesisUtterance(txt); u.lang='ja-JP'; speechSynthesis.speak(u); };
        const handleCameraTranslate = () => window.open('https://translate.google.com/?sl=auto&tl=zh-TW&op=images', '_blank');
        const fetchWeather = async () => { /* API Mock */ alert('å¤©æ°£è³‡æ–™å·²æ›´æ–°'); };
        const getClothingAdvice = (t) => t<15?'å¤§è¡£+ç™¼ç†±è¡£':t<20?'è–„å¤–å¥—':'çŸ­è¢–';

        onMounted(() => {
            if(auth) onAuthStateChanged(auth, async(u) => {
                isLoggedIn.value=!!u;
                if(u) {
                    onSnapshot(doc(db,"trips","kanto2026"), d => {
                        if(d.exists()) {
                            const dt=d.data();
                            if(dt.users && dt.users.length) users.value=dt.users;
                            if(dt.itinerary) itinerary.value=dt.itinerary;
                            if(dt.spots) spots.value=dt.spots;
                            if(dt.shopping) shopping.value=dt.shopping;
                            if(dt.expenses) expenses.value=dt.expenses;
                            if(dt.hotels) hotels.value=dt.hotels;
                            if(dt.transportTickets) transportTickets.value=dt.transportTickets;
                            if(dt.rentalCars) rentalCars.value=dt.rentalCars;
                            if(dt.phrases) phrases.value=dt.phrases;
                            if(dt.exchangeRate) exchangeRate.value=dt.exchangeRate;
                            
                            // Heartbeats
                            if(dt.heartbeats) {
                                const now = Date.now();
                                const map = {};
                                for(let uid in dt.heartbeats) {
                                    if(dt.heartbeats[uid]) map[parseInt(uid)] = dt.heartbeats[uid].toDate().getTime();
                                }
                                activeUsers.value = map;
                            }

                            isLoading.value=false;
                        } else {
                            console.log("No cloud data. Initializing...");
                            saveData(); 
                            isLoading.value=false;
                        }
                    });
                    setInterval(updateHeartbeat, 30000);
                } else isLoading.value=false;
            }); else isLoading.value=false;
        });

        return {
            isLoading, isWelcomeClosed, isLoggedIn, showPersonaModal, showTranslateModal, showModal, currentUser, isGuest,
            currentView, selectedDayIndex, itineraryMode, moneyTab, hotelTab, currentLoc, shopCat, exchangeRate,
            users, apps, tripDays, daysUntilTrip, smartReminders, weatherData,
            myPrivateExpenses, myPrivateTotalTWD, groupExpenses, settlements,
            spots, shopping, hotels, transportTickets, rentalCars, phrases, activeUsers, isUserOnline,
            enterSite, handleAuthClick, setCurrentUser, openEditUser, getPageTitle, getImg, getUnsplashUrl, getMapLink, getIconByCategory, getStamina, getStaminaColor, getPackingProgress, getUserName, getCurrentItinerary,
            openEditItineraryModal, openAddItineraryModal, moveItineraryItem,
            openExpenseModal, deleteExpense, quickExpense, editFlight, addPrepItem, openAddFoodModal, openAddShopModal, handleModalSave,
            speak, handleCameraTranslate, fetchWeather, getClothingAdvice,
            modalTitle, modalFields, modalData,
            getUncheckedItemsCount, getUncheckedItemName
        };
    }
}).mount('#app');
</script>
</body>
</html>
