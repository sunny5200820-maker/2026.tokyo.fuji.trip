<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—œæ±8æ—¥å¥³å­æ—… | å‰ä¼Šå¡å“‡é¢¨ V5.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chii-pink': '#FFD1DC',
                        'chii-blue': '#A2D2FF',
                        'chii-yellow': '#FFF5BA',
                        'chii-text': '#5D5D5D',
                    },
                    fontFamily: {
                        sans: ['Zen Maru Gothic', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #FFF5F7; 
            font-family: 'Zen Maru Gothic', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        /* æ«»èŠ±é£„è½å‹•ç•« */
        .sakura {
            position: fixed;
            top: -10px;
            background: #FFD1DC;
            border-radius: 100% 0 100% 0;
            opacity: 0.5;
            animation: fall linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        @keyframes fall {
            to { transform: translate(10vw, 105vh) rotate(360deg); }
        }

        /* App Icon Style */
        .app-icon {
            width: 70px;
            height: 70px;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            margin-bottom: 8px;
        }
        .app-icon:active { transform: scale(0.9); }
        .app-label { font-size: 13px; font-weight: bold; color: #5D5D5D; text-align: center; }

        /* Custom Scrollbar */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Banner */
        .banner-container {
            height: 200px;
            background-image: url('./banner.jpg');
            background-size: cover;
            background-position: center;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            position: relative;
            box-shadow: 0 4px 20px rgba(255, 209, 220, 0.4);
            margin-bottom: 20px;
        }
        .banner-fallback {
            background: linear-gradient(135deg, #A2D2FF 0%, #FFD1DC 100%);
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

        /* Weather Card Gradient */
        .weather-bg {
            background: linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%);
        }

        /* Modal Transition */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="sakura-container"></div>

<div id="app">
    <div v-if="!isMounted" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <i class="fa-solid fa-spinner fa-spin text-4xl text-chii-pink mb-4"></i>
        <div class="text-chii-text font-bold">æ­£åœ¨è¼‰å…¥ç¾å¥½æ—…ç¨‹...</div>
    </div>

    <div v-if="isMounted" v-cloak class="min-h-screen pb-24 relative z-10">
        
        <div v-if="currentView !== 'home'" class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-sm z-40 px-4 py-3 flex justify-between items-center shadow-sm">
            <button @click="goHome" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-chii-pink hover:text-white transition">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <h1 class="font-bold text-lg text-gray-700">{{ getPageTitle(currentView) }}</h1>
            <button @click="showSyncModal = true" class="w-10 h-10 rounded-full text-blue-400 hover:bg-blue-50 flex items-center justify-center">
                <i class="fa-solid fa-cloud-arrow-up"></i>
            </button>
        </div>
        <div v-if="currentView !== 'home'" class="h-16"></div> <div v-if="currentView === 'home'" class="animate-fade-in">
            <div class="banner-container" :class="{'banner-fallback': !hasBanner}">
                <div class="absolute inset-0 bg-black/10 rounded-b-[30px]"></div>
                <div class="absolute bottom-6 left-6 text-white">
                    <div class="text-xs opacity-90 mb-1 tracking-widest">TOKYO TRIP</div>
                    <h1 class="text-3xl font-black drop-shadow-md">é—œæ±å¥³å­æ—… ğŸŒ¸</h1>
                    <div class="mt-2 text-sm bg-white/20 backdrop-blur-md px-3 py-1 rounded-full inline-block">
                        <i class="fa-solid fa-location-arrow mr-1"></i>å¯Œå£«å±±è‡ªé§• x å‰ä¼Šå¡å“‡
                    </div>
                </div>
                <button @click="showSyncModal = true" class="absolute top-4 right-4 bg-white/30 backdrop-blur text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-sm border border-white/50">
                    <i class="fa-solid fa-rotate mr-1"></i>åŒæ­¥/å­˜æª”
                </button>
            </div>

            <div class="px-6 grid grid-cols-3 gap-y-8 gap-x-4">
                <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer group" @click="currentView = app.view">
                    <div class="app-icon" :class="app.color">
                        <i :class="app.icon"></i>
                    </div>
                    <span class="app-label group-hover:text-chii-pink transition">{{ app.name }}</span>
                </div>
            </div>

            <div class="px-4 mt-8">
                <div @click="currentView = 'weather'" class="weather-bg rounded-2xl p-4 text-white relative overflow-hidden shadow-lg cursor-pointer transform hover:scale-[1.02] transition">
                    <div class="absolute right-[-10px] top-[-10px] text-8xl opacity-20"><i class="fa-solid fa-cloud"></i></div>
                    <div class="flex justify-between items-end relative z-10">
                        <div>
                            <div class="text-sm font-bold opacity-90 mb-1"><i class="fa-solid fa-location-dot mr-1"></i>{{ locationName }}</div>
                            <div class="text-4xl font-bold">{{ currentTemp }}Â°C</div>
                            <div class="text-xs mt-1">{{ weatherDesc }}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl animate-float">{{ weatherIcon }}</div>
                            <div v-if="isFujiArea" class="text-xs font-bold mt-2 bg-white/20 px-2 py-1 rounded">èƒ½è¦‹åº¦ {{ fujiVisibility }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'itinerary'" class="px-4">
            <div class="flex overflow-x-auto hide-scrollbar gap-2 mb-4 pb-2 sticky top-16 bg-white/95 backdrop-blur py-2 z-30">
                <button v-for="(day, index) in tripDays" :key="index" 
                    @click="changeDay(index)"
                    :class="['flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition border', 
                            selectedDayIndex === index ? 'bg-chii-pink text-white border-chii-pink shadow-md' : 'bg-white text-gray-400 border-gray-100']">
                    {{ day.week }}
                </button>
            </div>

            <div class="space-y-4">
                <div v-if="currentDayItinerary.length === 0" class="text-center py-10 text-gray-400">
                    <i class="fa-solid fa-calendar-plus text-4xl mb-3 opacity-30"></i>
                    <p>é»æ“Šå³ä¸‹è§’æ–°å¢è¡Œç¨‹ï¼</p>
                </div>
                <div v-for="(item, idx) in currentDayItinerary" :key="item.id" class="card p-4 relative border-l-[6px]" :class="getBorderColor(item.category)">
                    <div class="flex justify-between items-start" @click="editItem(item, idx)">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold px-2 py-0.5 rounded text-white" :class="getCategoryColor(item.category)">{{ getCategoryName(item.category) }}</span>
                                <span class="text-xs text-gray-400 font-mono"><i class="fa-regular fa-clock mr-1"></i>{{ item.hours }}</span>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg">{{ item.name }}</h3>
                            <p class="text-sm text-gray-500 mt-1 whitespace-pre-wrap">{{ item.note }}</p>
                        </div>
                        <div class="flex flex-col gap-2 ml-2">
                             <a v-if="item.mapKeyword" :href="getMapLink(item.mapKeyword)" target="_blank" @click.stop class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center hover:bg-blue-100">
                                <i class="fa-solid fa-location-dot"></i>
                            </a>
                            <button @click.stop="deleteItem(idx)" class="w-8 h-8 rounded-full bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-100">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button @click="openAddModal" class="fixed bottom-6 right-6 w-14 h-14 bg-chii-pink text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-40 hover:scale-110 transition animate-bounce-slow">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div v-if="currentView === 'money'" class="px-4">
            <div class="flex bg-white rounded-xl p-1 mb-6 shadow-sm border border-gray-100">
                <button @click="moneyTab = 'record'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition', moneyTab === 'record' ? 'bg-chii-yellow text-gray-700 shadow-sm' : 'text-gray-400']">è¨˜å¸³</button>
                <button @click="moneyTab = 'split'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition', moneyTab === 'split' ? 'bg-chii-pink text-white shadow-sm' : 'text-gray-400']">åˆ†å¸³çµç®—</button>
            </div>

            <div v-if="moneyTab === 'record'">
                <div class="card p-5 mb-4 bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-100">
                    <div class="flex justify-between items-end">
                        <div>
                            <div class="text-xs text-gray-500 font-bold mb-1">ç¸½æ”¯å‡º ({{ currentUser }})</div>
                            <div class="text-3xl font-black text-gray-800">Â¥{{ userTotalExpense.toLocaleString() }}</div>
                        </div>
                        <div class="text-right">
                             <select v-model="currentUser" class="bg-white border border-gray-200 text-sm rounded-lg p-1 outline-none font-bold">
                                <option v-for="u in expenseUsers" :key="u" :value="u">{{ u }}</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="space-y-3 pb-20">
                    <div v-for="exp in filteredExpenses" :key="exp.id" class="card p-3 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl">{{ getExpenseIcon(exp.category) }}</div>
                            <div>
                                <div class="font-bold text-gray-700">{{ exp.name }}</div>
                                <div class="text-xs text-gray-400">{{ exp.date }} Â· {{ exp.category }}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-800">Â¥{{ Number(exp.amount).toLocaleString() }}</div>
                            <button @click="deleteExpense(exp.id)" class="text-xs text-red-300 mt-1 px-2">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
                <button @click="openExpenseModal" class="fixed bottom-6 right-6 w-14 h-14 bg-chii-yellow text-gray-700 rounded-full shadow-lg flex items-center justify-center text-2xl z-40 hover:scale-110 transition">
                    <i class="fa-solid fa-pen"></i>
                </button>
            </div>

            <div v-if="moneyTab === 'split'">
                <div class="card p-4 mb-4">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">ğŸ‘¥ æˆå“¡ç®¡ç†</h3>
                    <div class="flex flex-wrap gap-2">
                        <div v-for="(u, idx) in expenseUsers" :key="u" class="bg-gray-100 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                            {{ u }}
                            <button @click="removeUser(idx)" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <button @click="addUser" class="px-3 py-1 rounded-full text-sm border border-dashed border-gray-300 text-gray-500 hover:bg-gray-50">+ æ–°å¢</button>
                    </div>
                </div>

                <div class="card p-5 border-l-4 border-chii-blue">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fa-solid fa-calculator text-blue-400"></i> åˆ†å¸³å»ºè­°</h3>
                    
                    <div v-if="settlements.length === 0" class="text-center text-gray-400 py-4 text-sm">
                        ç›®å‰æ”¶æ”¯å¹³è¡¡æˆ–ç„¡è³‡æ–™
                    </div>

                    <div v-else class="space-y-3">
                        <div v-for="(s, idx) in settlements" :key="idx" class="flex items-center justify-between bg-blue-50 p-3 rounded-lg">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-red-500">{{ s.from }}</span>
                                <i class="fa-solid fa-arrow-right-long text-gray-400 text-xs"></i>
                                <span class="font-bold text-green-600">{{ s.to }}</span>
                            </div>
                            <div class="font-bold text-gray-800">Â¥{{ s.amount.toLocaleString() }}</div>
                        </div>
                         <p class="text-xs text-gray-400 mt-3 text-center">*è¨ˆç®—é‚è¼¯ï¼šç¸½æ”¯å‡º / äººæ•¸ = å¹³å‡æ‡‰ä»˜</p>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'japanese'" class="px-4">
            <div class="grid grid-cols-1 gap-3">
                <div v-for="(phrase, idx) in japanesePhrases" :key="idx" 
                        @click="speak(phrase.jp)"
                        class="card p-4 flex items-center justify-between cursor-pointer active:scale-95 transition border-l-4 border-green-300 hover:bg-green-50">
                    <div>
                        <div class="font-bold text-lg text-gray-800">{{ phrase.jp }}</div>
                        <div class="text-xs text-gray-400 font-mono mb-1">{{ phrase.romaji }}</div>
                        <div class="text-sm text-green-600 font-bold">{{ phrase.tw }}</div>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xl shadow-sm">
                        <i class="fa-solid fa-volume-high"></i>
                    </div>
                </div>
            </div>
            <div class="mt-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200 text-sm text-gray-600 text-center">
                <i class="fa-solid fa-lightbulb text-yellow-500 mr-1"></i>é»æ“Šå¡ç‰‡å³å¯ç™¼éŸ³
            </div>
        </div>

        <div v-if="['food', 'shopping', 'prep', 'search', 'photo'].includes(currentView)" class="px-4">
            
            <div v-if="currentView === 'search'" class="mt-10">
                <div class="card p-6 text-center">
                    <img src="https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_92x30dp.png" class="h-8 mx-auto mb-6">
                    <input v-model="searchQuery" @keyup.enter="doGoogleSearch" placeholder="æœå°‹æ±äº¬æ™¯é»..." class="w-full p-3 bg-gray-50 border rounded-full text-center outline-none focus:ring-2 focus:ring-blue-200 mb-4">
                    <button @click="doGoogleSearch" class="w-full bg-blue-500 text-white font-bold py-3 rounded-full shadow-lg hover:bg-blue-600 transition">Go!</button>
                    <div class="mt-6 grid grid-cols-2 gap-3">
                        <button @click="quickSearch('æ±äº¬ç¾é£Ÿ')" class="bg-orange-50 text-orange-600 py-2 rounded-lg text-sm font-bold">ğŸ” æ±äº¬ç¾é£Ÿ</button>
                        <button @click="quickSearch('å¯Œå£«å±±å¤©æ°£')" class="bg-blue-50 text-blue-600 py-2 rounded-lg text-sm font-bold">ğŸ” å¯Œå£«å±±å¤©æ°£</button>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'prep'">
                <div class="bg-white rounded-2xl shadow-sm p-4 relative mb-4">
                    <div class="absolute top-0 left-0 w-full h-3 bg-chii-yellow opacity-50 rounded-t-2xl"></div>
                    <div v-for="(item, idx) in prepList" :key="idx" class="flex items-center gap-3 py-3 border-b border-gray-50 last:border-0">
                        <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-400">
                        <input v-model="item.text" class="flex-1 text-sm bg-transparent outline-none" :class="{'line-through text-gray-300': item.checked}">
                        <button @click="prepList.splice(idx, 1)" class="text-gray-300"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
                <button @click="addPrepItem" class="w-full py-3 bg-gray-100 rounded-xl text-gray-500 font-bold border-2 border-dashed border-gray-200 hover:bg-white hover:border-pink-300 transition">+ æ–°å¢é …ç›®</button>
            </div>

            <div v-if="currentView === 'shopping'">
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="card p-3 flex flex-col items-center relative group">
                        <button @click="shoppingList.splice(idx, 1)" class="absolute top-2 right-2 w-6 h-6 bg-gray-100 rounded-full text-gray-400 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                        <div class="w-full h-24 bg-blue-50 rounded-lg mb-2 flex items-center justify-center text-3xl text-blue-200">
                            <i class="fa-solid fa-bag-shopping"></i>
                        </div>
                        <div class="font-bold text-sm text-center w-full truncate">{{ item.name }}</div>
                        <div class="text-xs text-gray-400">{{ item.tag }}</div>
                    </div>
                    <div @click="addShopItem" class="card p-3 flex flex-col items-center justify-center min-h-[140px] cursor-pointer border-2 border-dashed border-gray-300 hover:border-blue-300 shadow-none">
                        <i class="fa-solid fa-plus text-2xl text-gray-300"></i>
                    </div>
                </div>
            </div>

             <div v-if="currentView === 'photo'">
                <div class="space-y-4">
                    <div v-for="(spot, idx) in photoSpots" :key="idx" class="card p-0 overflow-hidden">
                        <a :href="spot.link" target="_blank" class="block">
                            <div class="h-32 bg-gray-200 relative">
                                <img :src="spot.img" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/600x400/FFD1DC/white?text=Photo+Spot'">
                                <div class="absolute bottom-2 left-2 bg-white/80 backdrop-blur px-2 py-1 rounded text-xs font-bold">{{ spot.area }}</div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-bold text-lg mb-1">{{ spot.name }}</h3>
                                <p class="text-sm text-gray-500">{{ spot.desc }}</p>
                                <div class="mt-2 text-right text-xs text-blue-400 font-bold"><i class="fa-solid fa-location-arrow mr-1"></i>å°èˆª</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

             <div v-if="currentView === 'food'">
                <div class="space-y-3">
                    <div v-for="(food, idx) in foodList" :key="idx" class="card p-4 flex gap-4">
                        <div class="w-20 h-20 bg-orange-100 rounded-lg flex-shrink-0 flex items-center justify-center text-3xl">
                            {{ food.emoji }}
                        </div>
                        <div>
                            <span class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-bold">{{ food.area }}</span>
                            <h3 class="font-bold text-lg text-gray-800">{{ food.name }}</h3>
                            <p class="text-xs text-gray-500 mt-1">{{ food.desc }}</p>
                            <a :href="getMapLink(food.name)" target="_blank" class="inline-block mt-2 text-xs text-blue-400 border border-blue-200 px-2 py-1 rounded hover:bg-blue-50">
                                æœå°‹åœ°é»
                            </a>
                        </div>
                    </div>
                </div>
             </div>
        </div>
        
        <transition name="modal">
            <div v-if="showModal" class="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center">
                <div class="bg-white w-full sm:w-96 rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up">
                    <h3 class="font-bold text-lg mb-4 text-center text-gray-700">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                    <div class="space-y-3">
                        <input v-model="editForm.name" placeholder="è¡Œç¨‹åç¨± (ä¾‹: æ·ºè‰å¯º)" class="w-full p-3 bg-gray-50 border-none rounded-xl outline-none focus:ring-2 focus:ring-chii-pink">
                        <div class="flex gap-2">
                            <input v-model="editForm.hours" placeholder="æ™‚é–“ (10:00)" class="w-1/3 p-3 bg-gray-50 border-none rounded-xl outline-none">
                            <select v-model="editForm.category" class="flex-1 p-3 bg-gray-50 border-none rounded-xl outline-none">
                                <option value="Sightseeing">ğŸ“¸ æ™¯é»</option>
                                <option value="Food">ğŸœ ç¾é£Ÿ</option>
                                <option value="Shopping">ğŸ›ï¸ è³¼ç‰©</option>
                                <option value="Transport">ğŸš… äº¤é€š</option>
                                <option value="Hotel">ğŸ¨ ä½å®¿</option>
                            </select>
                        </div>
                        <input v-model="editForm.mapKeyword" placeholder="åœ°åœ–é—œéµå­— (ç•™ç©ºå‰‡æœå°‹åç¨±)" class="w-full p-3 bg-gray-50 border-none rounded-xl outline-none text-sm">
                        <textarea v-model="editForm.note" placeholder="å‚™è¨»..." class="w-full p-3 bg-gray-50 border-none rounded-xl outline-none h-20 resize-none"></textarea>
                        <div class="flex gap-3 pt-2">
                            <button @click="showModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                            <button @click="saveItem" class="flex-1 py-3 bg-chii-pink text-white rounded-xl font-bold shadow-md">å„²å­˜</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl">
                    <h3 class="font-bold text-lg mb-4 text-center">è¨˜ä¸€ç­† ({{ currentUser }})</h3>
                    <div class="space-y-3">
                        <input v-model="newExpense.name" placeholder="é …ç›® (ä¾‹: æ‹‰éºµ)" class="w-full p-3 bg-gray-50 rounded-xl outline-none">
                        <input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡ (æ—¥å¹£)" class="w-full p-3 bg-gray-50 rounded-xl outline-none font-mono">
                        <div class="flex flex-wrap gap-2 justify-center py-2">
                            <button v-for="cat in ['é£Ÿ','è¡£','ä½','è¡Œ','æ¨‚']" :key="cat" 
                                @click="newExpense.category = cat"
                                :class="['w-10 h-10 rounded-full font-bold text-sm transition', newExpense.category === cat ? 'bg-chii-yellow text-gray-800 scale-110' : 'bg-gray-100 text-gray-400']">
                                {{ cat }}
                            </button>
                        </div>
                        <button @click="addExpense" class="w-full py-3 bg-chii-yellow text-gray-800 rounded-xl font-bold shadow">å„²å­˜</button>
                        <button @click="showExpenseModal = false" class="w-full py-2 text-gray-400 text-sm">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showSyncModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl relative">
                    <button @click="showSyncModal = false" class="absolute top-4 right-4 text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
                    <h3 class="font-bold text-xl mb-2 text-center text-chii-text">â˜ï¸ é›²ç«¯åŒæ­¥</h3>
                    <p class="text-xs text-gray-400 text-center mb-4">å°‡ä»£ç¢¼å‚³çµ¦æœ‹å‹ï¼Œæˆ–æ˜¯è²¼ä¸Šæœ‹å‹çš„ä»£ç¢¼ä¾†åŒæ­¥ã€‚</p>
                    
                    <div class="bg-gray-50 p-3 rounded-xl mb-4 break-all text-xs text-gray-500 font-mono h-24 overflow-y-auto border border-gray-100">
                        {{ syncCode || 'é»æ“ŠåŒ¯å‡ºç”Ÿæˆä»£ç¢¼...' }}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="generateSyncCode" class="py-2 bg-blue-100 text-blue-600 rounded-lg font-bold text-sm hover:bg-blue-200">
                            <i class="fa-solid fa-copy mr-1"></i>åŒ¯å‡º/è¤‡è£½
                        </button>
                        <button @click="pasteSyncCode" class="py-2 bg-pink-100 text-pink-600 rounded-lg font-bold text-sm hover:bg-pink-200">
                            <i class="fa-solid fa-paste mr-1"></i>è²¼ä¸Š/åŒ¯å…¥
                        </button>
                    </div>
                    <div v-if="syncMsg" class="text-center text-xs mt-3 font-bold" :class="syncMsgColor">{{ syncMsg }}</div>
                </div>
            </div>
        </transition>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // === State ===
            const isMounted = ref(false);
            const currentView = ref('home'); // home, itinerary, money, japanese, food, shopping, prep, search, photo, weather
            const hasBanner = ref(true);
            const STORAGE_KEY = 'tokyo_trip_v5';

            // Apps Config for Dashboard
            const apps = [
                { id: 1, name: 'è¡Œç¨‹è¡¨', icon: 'fa-solid fa-map-location-dot', color: 'bg-gradient-to-br from-pink-300 to-pink-400', view: 'itinerary' },
                { id: 2, name: 'è¡Œå‰æº–å‚™', icon: 'fa-solid fa-suitcase-rolling', color: 'bg-gradient-to-br from-blue-300 to-blue-400', view: 'prep' },
                { id: 3, name: 'åƒåƒå–å–', icon: 'fa-solid fa-utensils', color: 'bg-gradient-to-br from-orange-300 to-orange-400', view: 'food' },
                { id: 4, name: 'å¿«æ¨‚Shop', icon: 'fa-solid fa-bag-shopping', color: 'bg-gradient-to-br from-purple-300 to-purple-400', view: 'shopping' },
                { id: 5, name: 'Googleæœ', icon: 'fa-brands fa-google', color: 'bg-gradient-to-br from-green-300 to-green-400', view: 'search' },
                { id: 6, name: 'å¤©æ°£é€±å ±', icon: 'fa-solid fa-cloud-sun', color: 'bg-gradient-to-br from-sky-300 to-sky-500', view: 'weather' }, // Actually shows on home, but button details
                { id: 7, name: 'å°è²¡åº«', icon: 'fa-solid fa-sack-dollar', color: 'bg-gradient-to-br from-yellow-300 to-yellow-500', view: 'money' },
                { id: 8, name: 'ç¶²ç¾æ‰“å¡', icon: 'fa-solid fa-camera', color: 'bg-gradient-to-br from-rose-300 to-rose-400', view: 'photo' },
                { id: 9, name: 'å³æ™‚æ•‘å‘½', icon: 'fa-solid fa-comment-medical', color: 'bg-gradient-to-br from-emerald-400 to-teal-500', view: 'japanese' },
            ];

            // Weather Data
            const weatherIcon = ref('ğŸŒ¤ï¸');
            const currentTemp = ref('--');
            const weatherDesc = ref('è®€å–ä¸­...');
            const fujiVisibility = ref('--');
            
            // Itinerary Data
            const selectedDayIndex = ref(0);
            const tripDays = [
                { week: 'Day 1', dateNum: 'å‡ºç™¼' }, { week: 'Day 2', dateNum: 'å¸‚å€' },
                { week: 'Day 3', dateNum: 'å¯Œå£«' }, { week: 'Day 4', dateNum: 'å±±ä¸­' },
                { week: 'Day 5', dateNum: 'æ²³å£' }, { week: 'Day 6', dateNum: 'éŒå€‰' },
                { week: 'Day 7', dateNum: 'æ¾€è°·' }, { week: 'Day 8', dateNum: 'è¿”ç¨‹' }
            ];
            const itineraryData = ref(Array(8).fill([])); // Initialize empty arrays

            // Money Data
            const moneyTab = ref('record'); // record, split
            const expenseUsers = ref(['æˆ‘', 'æœ‹å‹A']);
            const currentUser = ref('æˆ‘');
            const expenses = ref([]);
            const newExpense = ref({ name: '', amount: '', category: 'é£Ÿ' });

            // Lists
            const prepList = ref([{ text: 'è­·ç…§', checked: false }, { text: 'æ—¥å¹£', checked: false }]);
            const shoppingList = ref([{ name: 'Chiikawa ç©å¶', tag: 'å¿…è²·' }]);
            
            // Japanese Data
            const japanesePhrases = [
                { jp: 'ã™ã¿ã¾ã›ã‚“', romaji: 'Sumimasen', tw: 'ä¸å¥½æ„æ€ / è«‹å•' },
                { jp: 'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™', romaji: 'Kore o onegaishimasu', tw: 'æˆ‘è¦é€™å€‹' },
                { jp: 'ãŠã„ãã‚‰ã§ã™ã‹ï¼Ÿ', romaji: 'Oikura desu ka?', tw: 'è«‹å•å¤šå°‘éŒ¢ï¼Ÿ' },
                { jp: 'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™', romaji: 'Okaikei onegaishimasu', tw: 'æˆ‘è¦çµå¸³' },
                { jp: 'è¢‹ã¯ã„ã‚Šã¾ã›ã‚“', romaji: 'Fukuro wa irimasen', tw: 'ä¸ç”¨è¢‹å­' },
                { jp: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹', romaji: 'Toire wa doko desu ka', tw: 'å»æ‰€åœ¨å“ªï¼Ÿ' },
                { jp: 'åŠ©ã‘ã¦ãã ã•ã„ï¼', romaji: 'Tasukete kudasai!', tw: 'æ•‘å‘½ï¼(ç·Šæ€¥)' },
            ];

            // Modals & Forms
            const showModal = ref(false);
            const showExpenseModal = ref(false);
            const showSyncModal = ref(false);
            const isEditing = ref(false);
            const editIndex = ref(-1);
            const editForm = ref({ name: '', hours: '', note: '', category: 'Sightseeing', mapKeyword: '' });
            const searchQuery = ref('');
            const syncCode = ref('');
            const syncMsg = ref('');
            const syncMsgColor = ref('');

            // Static Data for Food & Photo
            const foodList = [
                { name: 'AFURI æ‹‰éºµ', area: 'åŸå®¿/å…­æœ¬æœ¨', emoji: 'ğŸœ', desc: 'æ¸…çˆ½æŸšå­é¹½æ‹‰éºµï¼Œå¥³ç”Ÿæœ€æ„›' },
                { name: 'HARBS æ°´æœåƒå±¤', area: 'æ–°å®¿/æ¾€è°·', emoji: 'ğŸ°', desc: 'å¿…åƒå¤§ä»½é‡è›‹ç³•' },
                { name: 'Houtou Fudou', area: 'æ²³å£æ¹–', emoji: 'ğŸ²', desc: 'é›²æœµå»ºç¯‰é¤ºé£¥éºµ' },
            ];
            const photoSpots = [
                { name: 'SHIBUYA SKY', area: 'æ±äº¬', img: 'https://images.unsplash.com/photo-1536098561742-ca998e48cbcc?auto=format&fit=crop&w=600&q=80', desc: 'ç„¡æ•µå¤œæ™¯é€æ˜é›»æ‰¶æ¢¯', link: 'http://googleusercontent.com/maps.google.com/search?q=SHIBUYA+SKY' },
                { name: 'ä¸‹å‰ç”° æœ¬ç”ºé€š', area: 'å¯Œå£«å±±', img: 'https://images.unsplash.com/photo-1589451814294-26d36298dd22?auto=format&fit=crop&w=600&q=80', desc: 'å¾©å¤è¡—é“å·¨å¤§å¯Œå£«å±±', link: 'http://googleusercontent.com/maps.google.com/search?q=å¯Œå£«å‰ç”°æœ¬ç”ºé€š' },
            ];

            // === Computed ===
            const currentDayItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
            const userTotalExpense = computed(() => expenses.value.filter(e => e.user === currentUser.value).reduce((s, e) => s + Number(e.amount), 0));
            const filteredExpenses = computed(() => expenses.value.filter(e => e.user === currentUser.value).sort((a,b) => b.id - a.id));
            
            // Location Logic
            const currentLocationKey = computed(() => {
                if (selectedDayIndex.value >= 2 && selectedDayIndex.value <= 4) return 'Fuji';
                if (selectedDayIndex.value === 5) return 'Kamakura';
                return 'Tokyo';
            });
            const locationName = computed(() => ({ 'Tokyo': 'æ±äº¬', 'Fuji': 'å¯Œå£«å±±', 'Kamakura': 'éŒå€‰' }[currentLocationKey.value]));
            const isFujiArea = computed(() => currentLocationKey.value === 'Fuji');

            // Split Bill Logic (Greedy Algorithm simplified)
            const settlements = computed(() => {
                const balances = {};
                expenseUsers.value.forEach(u => balances[u] = 0);
                const totalAmount = expenses.value.reduce((s, e) => s + Number(e.amount), 0);
                const perPerson = totalAmount / expenseUsers.value.length;
                
                // Calculate Net Balance
                expenses.value.forEach(e => {
                    if(balances[e.user] !== undefined) balances[e.user] += Number(e.amount);
                });
                const netBalances = {};
                expenseUsers.value.forEach(u => netBalances[u] = balances[u] - perPerson);

                // Settle
                const debtors = [], creditors = [];
                for(const u in netBalances) {
                    if(netBalances[u] < -1) debtors.push({ u, amount: -netBalances[u] });
                    else if(netBalances[u] > 1) creditors.push({ u, amount: netBalances[u] });
                }
                
                const results = [];
                let i = 0, j = 0;
                while(i < debtors.length && j < creditors.length) {
                    const amount = Math.min(debtors[i].amount, creditors[j].amount);
                    if(amount > 0) {
                        results.push({ from: debtors[i].u, to: creditors[j].u, amount: Math.round(amount) });
                    }
                    debtors[i].amount -= amount;
                    creditors[j].amount -= amount;
                    if(debtors[i].amount < 1) i++;
                    if(creditors[j].amount < 1) j++;
                }
                return results;
            });

            // === Methods ===
            const goHome = () => currentView.value = 'home';
            const getPageTitle = (view) => apps.find(a => a.view === view)?.name || 'Back';
            
            // Weather
            const fetchWeather = async () => {
                weatherDesc.value = 'æ›´æ–°ä¸­...';
                const coords = { 'Tokyo': { lat: 35.6895, lon: 139.6917 }, 'Fuji': { lat: 35.3606, lon: 138.7274 }, 'Kamakura': { lat: 35.3192, lon: 139.5467 } };
                const target = coords[currentLocationKey.value];
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${target.lat}&longitude=${target.lon}&current=temperature_2m,weather_code,cloud_cover&timezone=Asia%2FTokyo`);
                    const data = await res.json();
                    currentTemp.value = data.current.temperature_2m;
                    const code = data.current.weather_code;
                    if (code <= 3) { weatherIcon.value = 'ğŸŒ¤ï¸'; weatherDesc.value = 'å¥½å¤©æ°£'; }
                    else if (code <= 67) { weatherIcon.value = 'â˜”'; weatherDesc.value = 'æœ‰é›¨'; }
                    else { weatherIcon.value = 'â˜ï¸'; weatherDesc.value = 'å¤šé›²'; }
                    
                    if (isFujiArea.value) fujiVisibility.value = Math.max(0, 100 - data.current.cloud_cover);
                } catch(e) { weatherDesc.value = 'N/A'; }
            };

            // Itinerary
            const changeDay = (idx) => { selectedDayIndex.value = idx; fetchWeather(); };
            const openAddModal = () => { isEditing.value = false; editForm.value = { name: '', category: 'Sightseeing' }; showModal.value = true; };
            const editItem = (item, idx) => { isEditing.value = true; editIndex.value = idx; editForm.value = {...item}; showModal.value = true; };
            const saveItem = () => {
                const list = itineraryData.value[selectedDayIndex.value] || [];
                const newItem = { ...editForm.value, id: isEditing.value ? editForm.value.id : Date.now() };
                if (isEditing.value) list[editIndex.value] = newItem;
                else { if(!itineraryData.value[selectedDayIndex.value]) itineraryData.value[selectedDayIndex.value] = []; itineraryData.value[selectedDayIndex.value].push(newItem); }
                showModal.value = false;
            };
            const deleteItem = (idx) => { if(confirm('åˆªé™¤ï¼Ÿ')) itineraryData.value[selectedDayIndex.value].splice(idx, 1); };
            const getBorderColor = (c) => ({'Sightseeing':'border-pink-300','Food':'border-orange-300','Shopping':'border-purple-300','Transport':'border-blue-300'}[c]||'border-gray-300');
            const getCategoryColor = (c) => ({'Sightseeing':'bg-pink-300','Food':'bg-orange-300','Shopping':'bg-purple-300','Transport':'bg-blue-300'}[c]||'bg-gray-300');
            const getCategoryName = (c) => ({'Sightseeing':'æ™¯é»','Food':'ç¾é£Ÿ','Shopping':'è³¼ç‰©','Transport':'äº¤é€š','Hotel':'ä½å®¿'}[c]||'å…¶ä»–');
            const getMapLink = (k) => k ? (k.startsWith('http') ? k : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}`) : '#';

            // Money
            const openExpenseModal = () => { newExpense.value = { name: '', amount: '', category: 'é£Ÿ' }; showExpenseModal.value = true; };
            const addExpense = () => {
                if(!newExpense.value.name || !newExpense.value.amount) return;
                expenses.value.push({ id: Date.now(), user: currentUser.value, ...newExpense.value, date: `${new Date().getMonth()+1}/${new Date().getDate()}` });
                showExpenseModal.value = false;
            };
            const deleteExpense = (id) => { if(confirm('åˆªé™¤ï¼Ÿ')) expenses.value = expenses.value.filter(e => e.id !== id); };
            const addUser = () => { const name = prompt('è¼¸å…¥äººå:'); if(name) expenseUsers.value.push(name); };
            const removeUser = (idx) => { if(confirm('åˆªé™¤å°‡æœƒå½±éŸ¿åˆ†å¸³è¨ˆç®—ï¼Œç¢ºå®šï¼Ÿ')) expenseUsers.value.splice(idx, 1); };
            const getExpenseIcon = (c) => ({'é£Ÿ':'ğŸœ','è¡£':'ğŸ‘—','ä½':'ğŸ¨','è¡Œ':'ğŸš…','æ¨‚':'ğŸ¡'}[c]||'ğŸ’¸');

            // Search
            const doGoogleSearch = () => { if(searchQuery.value) window.open(`https://www.google.com/search?q=${encodeURIComponent(searchQuery.value)}`); };
            const quickSearch = (q) => { searchQuery.value = q; doGoogleSearch(); };

            // Japanese
            const speak = (text) => {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ja-JP';
                window.speechSynthesis.speak(u);
            };

            // Cloud Sync (JSON export/import)
            const getAllData = () => JSON.stringify({ itinerary: itineraryData.value, expenses: expenses.value, expenseUsers: expenseUsers.value, prep: prepList.value, shopping: shoppingList.value });
            const generateSyncCode = () => {
                syncCode.value = btoa(unescape(encodeURIComponent(getAllData()))); // Simple Base64 encode
                navigator.clipboard.writeText(syncCode.value);
                syncMsg.value = 'ä»£ç¢¼å·²è¤‡è£½ï¼å‚³çµ¦æœ‹å‹å§'; syncMsgColor.value = 'text-green-500';
            };
            const pasteSyncCode = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    const data = JSON.parse(decodeURIComponent(escape(atob(text))));
                    // Merge Data
                    itineraryData.value = data.itinerary;
                    expenses.value = data.expenses;
                    expenseUsers.value = data.expenseUsers;
                    prepList.value = data.prep;
                    shoppingList.value = data.shopping;
                    syncCode.value = '';
                    syncMsg.value = 'åŒæ­¥æˆåŠŸï¼'; syncMsgColor.value = 'text-green-500';
                    setTimeout(() => showSyncModal.value = false, 1500);
                } catch(e) {
                    syncMsg.value = 'ä»£ç¢¼éŒ¯èª¤æˆ–ç„¡æ³•è®€å–å‰ªè²¼ç°¿'; syncMsgColor.value = 'text-red-500';
                }
            };

            // Lifecycle
            const saveData = () => localStorage.setItem(STORAGE_KEY, getAllData());
            
            onMounted(() => {
                // Sakura Effect
                const sakuraContainer = document.getElementById('sakura-container');
                for(let i=0; i<10; i++){
                    const el = document.createElement('div');
                    el.className = 'sakura';
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.animationDuration = Math.random() * 3 + 2 + 's';
                    el.style.width = Math.random() * 10 + 10 + 'px';
                    el.style.height = el.style.width;
                    sakuraContainer.appendChild(el);
                }

                // Load Data
                const saved = localStorage.getItem(STORAGE_KEY);
                if(saved) {
                    try {
                        const d = JSON.parse(saved);
                        itineraryData.value = d.itinerary || itineraryData.value;
                        expenses.value = d.expenses || [];
                        expenseUsers.value = d.expenseUsers || expenseUsers.value;
                        prepList.value = d.prep || prepList.value;
                        shoppingList.value = d.shopping || shoppingList.value;
                    } catch(e){}
                }
                
                // Image check
                const img = new Image(); img.src = './banner.jpg'; img.onerror = () => hasBanner.value = false;
                
                fetchWeather();
                isMounted.value = true;
            });

            watch([itineraryData, expenses, expenseUsers, prepList, shoppingList], saveData, { deep: true });

            return {
                isMounted, currentView, hasBanner, apps, goHome, getPageTitle,
                // Weather
                weatherIcon, currentTemp, weatherDesc, fujiVisibility, locationName, isFujiArea,
                // Itinerary
                tripDays, selectedDayIndex, currentDayItinerary, changeDay, openAddModal, editItem, deleteItem,
                getBorderColor, getCategoryColor, getCategoryName, getMapLink, showModal, editForm, saveItem, isEditing,
                // Money
                moneyTab, expenseUsers, currentUser, userTotalExpense, filteredExpenses, settlements, 
                showExpenseModal, newExpense, openExpenseModal, addExpense, deleteExpense, addUser, removeUser, getExpenseIcon,
                // Japanese
                japanesePhrases, speak,
                // Search & Others
                searchQuery, doGoogleSearch, quickSearch, foodList, photoSpots, prepList, shoppingList, addPrepItem: ()=>prepList.value.push({text:'',checked:false}), addShopItem: ()=>shoppingList.value.push({name:'æ–°å•†å“',tag:''}),
                // Sync
                showSyncModal, syncCode, generateSyncCode, pasteSyncCode, syncMsg, syncMsgColor
            };
        }
    }).mount('#app');
</script>
</body>
</html>
