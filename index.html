<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FFF6F8">
<title>é—œæ±ä¹‹æ—… 2026 (V62.0 æ··åˆåŒæ­¥ç‰ˆ)</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>

<script>
    window.tailwind = {
        config: {
            theme: {
                extend: {
                    colors: { 'chii-pink': '#FFD1DC', 'chii-bg': '#FFF6F8' },
                    fontFamily: { sans: ['Zen Maru Gothic', 'sans-serif'] },
                    animation: { 'float': 'float 6s ease-in-out infinite', 'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)' },
                    keyframes: {
                        float: { '0%,100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        pop: { '0%': { transform: 'scale(0)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    }
</script>

<style>
    body { background-color: #FFF6F8; font-family: "Zen Maru Gothic", sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .card { background: rgba(255,255,255,0.95); border-radius: 24px; box-shadow: 0 8px 30px rgba(255,105,180,0.1); border: 2px solid white; margin-bottom: 16px; overflow: hidden; position: relative; }
    
    /* æ¼«ç•«å¼ç·Šæ€¥æ•‘é›£ CSS */
    .comic-box { background: white; border: 3px solid #5D4037; border-radius: 20px; padding: 10px; position: relative; box-shadow: 4px 4px 0 rgba(93,64,55,0.1); min-height: 140px; display: flex; flex-direction: column; }
    .comic-title { background: #5D4037; color: white; padding: 2px 8px; border-radius: 12px; font-weight: 900; font-size: 12px; display: inline-block; margin-bottom: 5px; z-index: 10; width: fit-content; }
    .comic-bubble { background: white; border: 2px solid #5D4037; border-radius: 12px; padding: 6px; font-size: 11px; font-weight: bold; position: relative; z-index: 10; margin-bottom: 4px; box-shadow: 2px 2px 0 #eee; }
    
    /* éŠæˆ²åŒ– CSS */
    .hp-bar { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 4px; }
    .hp-fill { height: 100%; transition: width 0.5s; }
    .packing-suitcase { width: 70px; height: 50px; background: #3b82f6; border-radius: 10px; border: 3px solid #1e40af; position: relative; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; overflow: hidden; }
    .packing-fill { position: absolute; bottom: 0; left: 0; right: 0; background: #60a5fa; transition: height 0.5s; z-index: 0; }
    
    /* ç‹€æ…‹ç‡ˆ */
    .sync-status { position: fixed; top: 10px; left: 10px; z-index: 100; font-size: 10px; padding: 4px 8px; border-radius: 20px; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); font-weight: bold; color: #555; display: flex; align-items: center; gap: 4px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    
    [v-cloak] { display: none; }
</style>
</head>
<body>

<div id="app" v-cloak class="h-full flex flex-col relative overflow-hidden">
    
    <div class="sync-status">
        <div class="status-dot" :class="syncStatusColor"></div>
        {{ syncStatusText }}
    </div>

    <div v-if="!isWelcomeClosed" class="fixed inset-0 z-50 bg-[#FFF6F8] flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-8 animate-float">
            <div class="text-6xl mb-2">ğŸŒ¸</div>
            <h1 class="text-4xl font-black text-gray-700">é—œæ±ä¹‹æ—…</h1>
            <p class="text-pink-400 font-bold tracking-widest mt-2">2026.03.27</p>
        </div>
        <button @click="showPersonaModal=true; isWelcomeClosed=true" class="w-full max-w-xs bg-pink-500 text-white font-black py-4 rounded-full shadow-xl text-lg active:scale-95 transition">
            é–‹å•Ÿæ—…ç¨‹æ›¸
        </button>
        <p class="mt-4 text-xs text-gray-400 font-bold">V62.0 æ··åˆé›²ç«¯åŒæ­¥ç‰ˆ</p>
    </div>

    <div v-if="isWelcomeClosed" class="flex-1 overflow-y-auto pb-32 relative z-10">
        
        <div v-if="currentView!=='menu'" class="sticky top-0 z-30 bg-[#FFF6F8]/95 backdrop-blur px-4 py-3 flex items-center justify-between shadow-sm">
            <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full text-pink-500 shadow active:scale-90 transition flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
            <h2 class="font-black text-gray-700 text-lg">{{getPageTitle(currentView)}}</h2>
            <div class="w-10"></div>
        </div>

        <div v-if="currentView==='menu'" class="p-6 pt-12">
            <div class="flex items-center gap-3 mb-8 cursor-pointer" @click="currentView='money'">
                <div class="w-14 h-14 bg-white rounded-full shadow-lg flex items-center justify-center text-3xl border-2 border-pink-100 animate-pop">{{getBudgetMood()}}</div>
                <div>
                    <div class="text-xs font-bold text-gray-400">ç›®å‰é ç®—å¿ƒæƒ…</div>
                    <div class="font-black text-gray-700 text-lg whitespace-pre-line">{{getGreeting()}}</div>
                </div>
            </div>

            <div class="card p-6 bg-gradient-to-br from-white to-pink-50 mb-8 flex items-center gap-4" @click="currentView='itinerary'">
                <div class="w-12 h-12 bg-yellow-300 rounded-2xl flex items-center justify-center text-white text-xl shadow-lg"><i class="fa-solid fa-clock"></i></div>
                <div>
                    <div class="font-black text-2xl text-gray-800">å€’æ•¸ {{daysUntilTrip}} å¤©</div>
                    <div class="text-xs text-pink-500 font-bold mt-1" v-if="smartReminders.length>0"><i class="fa-solid fa-circle-exclamation"></i> {{smartReminders[0]}}</div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div v-for="app in apps" :key="app.id" @click="currentView=app.view" class="flex flex-col items-center group active:scale-95 transition">
                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-2xl text-white shadow-md mb-2" :class="app.bgClass"><i :class="app.icon"></i></div>
                    <span class="text-xs font-bold text-gray-600">{{app.name}}</span>
                </div>
            </div>
        </div>

        <div v-if="currentView==='emergency'" class="p-4">
            <div class="flex justify-center gap-2 mb-4 sticky top-16 z-20">
                <button @click="emergTab='map'" :class="['px-4 py-2 rounded-full font-bold text-sm shadow transition', emergTab==='map'?'bg-red-400 text-white':'bg-white text-gray-400']">æ¼«ç•«åœ°åœ–</button>
                <button @click="emergTab='trans'" :class="['px-4 py-2 rounded-full font-bold text-sm shadow transition', emergTab==='trans'?'bg-emerald-400 text-white':'bg-white text-gray-400']">ç¿»è­¯è’Ÿè’»</button>
            </div>

            <div v-if="emergTab==='map'" class="grid grid-cols-2 gap-3">
                <div class="comic-box border-blue-500">
                    <div class="comic-title bg-blue-500">è­¦å¯Ÿ (110)</div>
                    <div class="absolute right-1 top-8 opacity-20 text-4xl text-blue-300"><i class="fa-solid fa-taxi"></i></div>
                    <div class="comic-bubble">é‡åˆ°å±éšªæ‰“110ï¼<br>å‰ä¼Šï¼šè­¦å¯Ÿå…ˆç”Ÿï¼</div>
                    <div class="mt-auto text-[10px] font-bold text-gray-500 border-t border-dashed border-gray-300 pt-2">
                        ğŸš“ å ±è­¦å°ˆç·šï¼š110<br>ğŸ“ æ±äº¬è­¦è¦–å»³
                    </div>
                </div>
                <div class="comic-box border-red-400">
                    <div class="comic-title bg-red-400">æ•‘è­· (119)</div>
                    <div class="absolute right-1 top-8 opacity-20 text-4xl text-red-300"><i class="fa-solid fa-truck-medical"></i></div>
                    <div class="comic-bubble">å…”å…”ï¼šUraï¼(å—å‚·æ‰“119)<br>æ•‘è­·è»Šæœƒä¾†ï½</div>
                    <div class="mt-auto text-[10px] font-bold text-gray-500 border-t border-dashed border-gray-300 pt-2">
                        ğŸš‘ æ•‘è­·å°ˆç·šï¼š119<br>ğŸ¥ å¯Œå£«å‰ç”°é†«é™¢
                    </div>
                </div>
                <div class="comic-box border-pink-400 col-span-2 flex-row items-center min-h-[100px]">
                    <div class="flex-1">
                        <div class="comic-title bg-pink-400">å°ç£æ—…å®¢å”åŠ©</div>
                        <div class="comic-bubble mb-0">å°å…«ï¼šè­·ç…§éºå¤±æˆ–ç·Šæ€¥ç‹€æ³ï¼Œå¯ä»¥æ‰¾é€™è£¡å–”ï¼(æ‹¿å‡ºåœ°åœ–)</div>
                        <div class="text-[10px] font-bold text-gray-500 mt-2">
                            â˜ï¸ 03-3280-7811 (ä»£è¡¨è™•)<br>ğŸ“ 090-6866-0101 (ç·Šæ€¥)
                        </div>
                    </div>
                    <div class="text-4xl text-pink-200 ml-2"><i class="fa-solid fa-passport"></i></div>
                </div>
                 <div class="comic-box border-green-400 col-span-2 flex-row items-center min-h-[80px]">
                    <div class="flex-1">
                        <div class="comic-title bg-green-400">ä¸­è‹±éŸ“æ”¯æ´</div>
                        <div class="text-xs font-bold text-gray-600 mt-1">
                            Visitor Hotline: 050-3816-2787
                        </div>
                    </div>
                    <div class="text-3xl text-green-200 ml-2"><i class="fa-solid fa-headset"></i></div>
                </div>
            </div>

            <div v-if="emergTab==='trans'" class="space-y-3">
                <div v-for="(p,idx) in japanesePhrases" :key="idx" class="card p-4 flex justify-between items-center border-l-4 border-emerald-400" @click="alert(p.jp)">
                    <div><div class="font-bold text-lg">{{p.jp}}</div><div class="text-xs text-gray-400 font-bold">{{p.zh}}</div></div>
                    <i class="fa-solid fa-volume-high text-emerald-200"></i>
                </div>
                <button @click="openAddPhraseModal" class="w-full py-3 bg-emerald-100 text-emerald-600 rounded-xl font-bold dashed border-2 border-emerald-200">+ æ–°å¢ç¿»è­¯</button>
            </div>
        </div>

        <div v-if="currentView==='itinerary'" class="p-4">
             <div class="flex overflow-x-auto gap-2 mb-4 pb-2 hide-scrollbar">
                <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['min-w-[70px] p-2 rounded-xl border-2 flex flex-col items-center transition', selectedDayIndex===i?'bg-pink-400 border-pink-400 text-white':'bg-white border-white text-gray-400']">
                    <span class="text-sm font-black">{{d.week}}</span>
                    <div class="hp-bar w-full"><div class="hp-fill" :class="getStaminaColor(i)" :style="{width: getStamina(i)+'%'}"></div></div>
                </button>
             </div>
             
             <div v-if="getStamina(selectedDayIndex)<50" class="bg-red-100 text-red-500 p-2 rounded-lg text-xs font-bold mb-4 text-center animate-pulse border border-red-200">
                ğŸ° Yha?? é«”åŠ›é€æ”¯è­¦å‘Šï¼(HPä½)
             </div>

             <div v-if="[2,3].includes(selectedDayIndex)" class="flex justify-center mb-4 bg-white p-1 rounded-full w-max mx-auto shadow-sm">
                 <button @click="itineraryMode='normal'" :class="['px-4 py-1 rounded-full text-xs font-bold', itineraryMode==='normal'?'bg-pink-400 text-white':'text-gray-400']">ä¸€èˆ¬</button>
                 <button @click="itineraryMode='drive'" :class="['px-4 py-1 rounded-full text-xs font-bold', itineraryMode==='drive'?'bg-green-500 text-white':'text-gray-400']">è‡ªé§•</button>
             </div>

             <div class="space-y-4">
                <div v-for="(item,idx) in getCurrentItinerary()" :key="idx" class="card p-4 relative group">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5" :class="itineraryMode==='drive'?'bg-green-400':'bg-pink-300'"></div>
                    <div class="pl-4">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs font-black text-gray-400 bg-gray-100 px-2 py-0.5 rounded">{{item.hours}}</span>
                            <div class="flex gap-1">
                                <a :href="getMapLink(item.mapKeyword)" target="_blank" class="text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded-full font-bold">å°èˆª</a>
                                <a v-if="item.ticketLink" :href="item.ticketLink" target="_blank" class="text-[10px] bg-red-50 text-red-500 px-2 py-1 rounded-full font-bold">è³¼ç¥¨</a>
                            </div>
                        </div>
                        <h3 class="font-bold text-gray-800 text-lg">{{item.name}}</h3>
                        <p class="text-sm text-gray-500">{{item.note}}</p>
                    </div>
                    <button @click="openEditItinerary(item,idx)" class="absolute top-2 right-2 text-gray-300 hover:text-blue-400"><i class="fa-solid fa-pen"></i></button>
                </div>
                <button @click="openAddItinerary" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white">+ æ–°å¢è¡Œç¨‹</button>
             </div>
        </div>

        <div v-if="currentView==='prep'" class="p-4">
            <div class="bg-blue-50 border-4 border-blue-200 border-dashed rounded-3xl p-6 mb-6 text-center">
                <div class="text-blue-400 font-black text-xs tracking-widest mb-2">PACKING STATUS</div>
                <div class="flex justify-center mb-2">
                    <div class="packing-suitcase">
                        <div class="packing-fill" :style="{height: getPackingProgress()+'%'}"></div>
                        <span class="relative z-10 text-xl">{{getPackingProgress()}}%</span>
                    </div>
                </div>
                <div class="text-xs font-bold text-gray-400">{{getPackingProgress()===100?'æº–å‚™å®Œæˆï¼å‡ºç™¼ï¼':'åŠ æ²¹ï¼Œå¿«å¡æ»¿å®ƒï¼'}}</div>
            </div>
            
            <div class="card p-0 overflow-hidden">
                <div class="bg-gray-50 p-3 border-b font-bold text-gray-600 flex justify-between">
                    <span>{{currentUser?.name || 'æˆ‘çš„'}} æ¸…å–®</span>
                    <button @click="addPrepItem" class="text-blue-500 text-xs">+ æ–°å¢</button>
                </div>
                <div v-for="(item,idx) in (currentUser?.list || [])" :key="idx" class="p-3 border-b flex items-center">
                    <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-500 mr-3" @change="saveData">
                    <input v-model="item.text" class="flex-1 bg-transparent outline-none font-bold text-gray-700" :class="{'line-through text-gray-300':item.checked}" @change="saveData">
                    <button @click="currentUser.list.splice(idx,1);saveData()" class="text-gray-300"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>
        </div>

        <div v-if="currentView==='money'" class="p-4">
             <div class="flex justify-center gap-2 mb-4 bg-white p-1 rounded-full w-max mx-auto shadow-sm">
                <button @click="moneyTab='record'" :class="['px-4 py-2 rounded-full font-bold text-sm', moneyTab==='record'?'bg-yellow-400 text-white':'text-gray-400']">ç§å¸³</button>
                <button @click="moneyTab='split'" :class="['px-4 py-2 rounded-full font-bold text-sm', moneyTab==='split'?'bg-blue-400 text-white':'text-gray-400']">å…¬æ¬¾</button>
             </div>
             
             <div class="space-y-3 pb-20">
                <div v-for="exp in (moneyTab==='record'?myPrivateExpenses:groupExpenses)" :key="exp.id" class="card p-4 flex justify-between items-center border-l-4" :class="moneyTab==='record'?'border-yellow-300':'border-blue-300'">
                    <div><div class="font-bold text-gray-800">{{exp.name}}</div><div class="text-[10px] text-gray-400">{{exp.date}}</div></div>
                    <div class="font-black text-gray-700">{{exp.currency}} {{exp.amount}}</div>
                </div>
                <button @click="openExpenseModal" class="fixed bottom-24 right-4 w-14 h-14 bg-yellow-400 text-white rounded-full shadow-lg text-2xl flex items-center justify-center border-4 border-white active:scale-95 transition"><i class="fa-solid fa-plus"></i></button>
             </div>
        </div>

        <div v-if="currentView==='food'" class="p-4">
             <div class="flex justify-center gap-2 mb-4"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="currentLoc=loc" :class="['px-4 py-1 rounded-full text-xs font-bold transition', currentLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400']">{{loc}}</button></div>
             
             <div class="grid gap-4">
                 <div v-for="(item,idx) in spots.food[currentLoc]" :key="idx" class="card p-0">
                     <div class="h-32 bg-gray-200 relative"><img :src="getImg(item.img)" class="w-full h-full object-cover" @error="handleImgError"></div>
                     <div class="p-4">
                         <div class="flex justify-between items-start mb-2">
                             <h3 class="font-black text-lg">{{item.name}}</h3>
                             <span class="text-[10px] font-bold px-2 py-1 rounded text-white" :class="item.reserve?'bg-red-500':'bg-green-500'">{{item.reserve?'éœ€é ç´„':'å…é ç´„'}}</span>
                         </div>
                         <button @click="quickExpense(item)" class="w-full py-2 bg-yellow-400 text-white rounded-lg font-bold text-sm mb-2 shadow-sm active:scale-95"><i class="fa-solid fa-file-invoice-dollar"></i> åƒå®Œäº† (ä¸€éµè¨˜å¸³)</button>
                         <a :href="getMapLink(item.link)" target="_blank" class="block text-center text-gray-400 text-xs font-bold py-2 bg-gray-100 rounded-lg">å°èˆª</a>
                     </div>
                 </div>
             </div>
        </div>
        
    </div>

    <div v-if="currentView!=='menu'" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-16 h-16 bg-gradient-to-br from-pink-300 to-pink-400 rounded-full border-4 border-white shadow-xl flex items-center justify-center text-white text-2xl cursor-pointer z-40 active:scale-90 transition" @click="currentView='menu'">
        <i class="fa-solid fa-house"></i>
    </div>

    <div v-if="showPersonaModal" class="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 text-center shadow-2xl border-4 border-pink-200">
            <h3 class="font-black text-xl mb-6 text-pink-500"><i class="fa-solid fa-paw"></i> è«‹å•æ‚¨æ˜¯å“ªä¸€ä½ï¼Ÿ</h3>
            <div class="grid grid-cols-2 gap-4">
                <div v-for="u in users" :key="u.id" @click="login(u)" class="cursor-pointer group">
                    <div class="w-20 h-20 mx-auto bg-gray-100 rounded-full mb-2 flex items-center justify-center text-4xl border-4 border-white shadow-md group-hover:border-pink-400 transition overflow-hidden">
                        <span v-if="!u.avatar">{{u.icon}}</span>
                        <img v-else :src="u.avatar" class="w-full h-full object-cover">
                    </div>
                    <div class="font-bold text-gray-600">{{u.name}}</div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showExpenseModal" class="fixed inset-0 z-[70] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl">
            <h3 class="font-bold text-lg mb-4 text-center">è¨˜ä¸€ç­†</h3>
            <input v-model="modalData.name" placeholder="é …ç›®" class="w-full bg-gray-50 p-3 rounded-xl mb-3 font-bold border">
            <input v-model="modalData.amount" type="number" placeholder="é‡‘é¡" class="w-full bg-gray-50 p-3 rounded-xl mb-4 font-black border">
            <div class="flex gap-2">
                <button @click="showExpenseModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                <button @click="confirmExpense" class="flex-1 py-3 bg-yellow-400 text-white rounded-xl font-bold shadow">å„²å­˜</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3.3.4/dist/vue.esm-browser.js";

// === Firebase Config (ä¿ç•™é›²ç«¯åŠŸèƒ½) ===
const firebaseConfig = { apiKey: "AIzaSyD3ojbkJVfDKmZQHRpZG-gp8gv7ajKdJr4", authDomain: "tokyo-trip-24b28.firebaseapp.com", projectId: "tokyo-trip-24b28", storageBucket: "tokyo-trip-24b28.firebasestorage.app", messagingSenderId: "518699705070", appId: "1:518699705070:web:56e95f603210d8d5d209ff" };
let db;
try { const app = initializeApp(firebaseConfig); db = getFirestore(app); enableIndexedDbPersistence(db).catch(e=>{}); } catch(e) { console.warn('Firebase Offline'); }

// === V62.0 æ··åˆæ¶æ§‹æ ¸å¿ƒï¼šé è¨­è³‡æ–™ (ç¢ºä¿ç„¡ç¶²æ™‚ç¬é–“è¼‰å…¥) ===
const DEFAULT_DATA = {
    users: [
        {id:1, name:'å‰ä¼Š', icon:'ğŸ¹', list:[{text:'è­·ç…§',checked:false},{text:'ç¶²å¡',checked:false}]},
        {id:2, name:'å°å…«', icon:'ğŸ±', list:[{text:'ç›¸æ©Ÿ',checked:false},{text:'æ—¥å¹£',checked:false}]},
        {id:3, name:'å…”å…”', icon:'ğŸ°', list:[{text:'é­”æ³•æ‰‹æ–',checked:false}]},
        {id:4, name:'å°æ¡ƒ', icon:'ğŸ‘', list:[{text:'å¯æ„›çš„è¡£æœ',checked:false}]}
    ],
    itinerary: [
        [{hours:'06:40',name:'TPE èµ·é£›',mapKeyword:'æ¡ƒåœ’æ©Ÿå ´',note:'T1 è¾¦ç†ç™»æ©Ÿ'}, {hours:'14:00',name:'æ™´ç©ºå¡”',mapKeyword:'æ±äº¬æ™´ç©ºå¡”',note:'ä¸‹åˆèŒ¶'}],
        [{hours:'09:00',name:'æ·ºè‰å¯º',mapKeyword:'æ·ºè‰å¯º',note:'é›·é–€æ‹ç…§'}, {hours:'18:00',name:'ç§‹è‘‰åŸ',mapKeyword:'ç§‹è‘‰åŸ',note:'é€›è¡—'}],
        [{hours:'08:00',name:'å‰å¾€å¯Œå£«å±±',mapKeyword:'éŒ¦ç³¸ç”ºç«™',note:'å¯Œå£«å›éŠè™Ÿ (éœ€æ¶ç¥¨)', ticketLink:'https://www.eki-net.com/zh-CHT/jreast-train-reservation/Top/Index'}, {hours:'13:00',name:'æ²³å£æ¹–',mapKeyword:'æ²³å£æ¹–',note:'ç§Ÿè»Š'}],
        [{hours:'05:00',name:'å¹³é‡ä¹‹æ¿±',mapKeyword:'å¹³é‡ã®æµœ',note:'é€†å¯Œå£«æ—¥å‡º'}, {hours:'14:00',name:'KABAå·´å£«',mapKeyword:'å±±ä¸­æ¹–',note:'æ°´é™¸å…©ç”¨'}],
        [{hours:'09:00',name:'çºœè»Š',mapKeyword:'æ²³å£æ¹–çºœè»Š',note:'çµ•æ™¯é¦éŸ†'}, {hours:'16:00',name:'æ± è¢‹',mapKeyword:'æ± è¢‹å¤ªé™½åŸ',note:'è¿”å›æ±äº¬'}],
        [{hours:'10:00',name:'éŒå€‰é«˜æ ¡å‰',mapKeyword:'éŒå€‰é«˜æ ¡å‰',note:'çŒç±ƒé«˜æ‰‹å¹³äº¤é“'}, {hours:'15:00',name:'æ±Ÿå³¶ç¥ç¤¾',mapKeyword:'æ±Ÿå³¶ç¥ç¤¾',note:'çˆ¬æ¨“æ¢¯'}],
        [{hours:'17:00',name:'SHIBUYA SKY',mapKeyword:'SHIBUYA SKY',note:'æ—¥è½ (éœ€é ç´„)', ticketLink:'https://www.kkday.com/'}],
        [{hours:'20:40',name:'NRT èµ·é£›',mapKeyword:'æˆç”°æ©Ÿå ´',note:'å›ç¨‹'}]
    ],
    spots: {
        food: {
            Tokyo: [{name:'ç‰›ã‹ã¤ã‚‚ã¨æ‘',img:'food1.jpg',reserve:false,link:'ç‰›ã‹ã¤ã‚‚ã¨æ‘'}, {name:'å™å™è‹‘',img:'food2.jpg',reserve:true,link:'å™å™è‹‘'}],
            Kamakura: [{name:'Bills é¬†é¤…',img:'food3.jpg',reserve:true,link:'Bills ä¸ƒé‡Œãƒ¶æµœ'}, {name:'å»ä»”é­šä¸¼',img:'food4.jpg',reserve:false,link:'éŒå€‰ é‡œé£¯'}],
            Fuji: [{name:'ä¸å‹•èŒ¶å±‹',img:'food5.jpg',reserve:false,link:'ä¸å‹•èŒ¶å±‹'}, {name:'å±±éº“åœ’',img:'food6.jpg',reserve:true,link:'å±±éº“åœ’'}]
        }
    },
    expenses: [],
    phrases: [{jp:'ã™ã¿ã¾ã›ã‚“',zh:'ä¸å¥½æ„æ€'}, {jp:'ã“ã‚Œãã ã•ã„',zh:'æˆ‘è¦é€™å€‹'}, {jp:'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹',zh:'å»æ‰€åœ¨å“ªè£¡'}]
};

createApp({
    setup() {
        // === 1. åˆå§‹åŒ– (ä½¿ç”¨é è¨­è³‡æ–™ï¼Œçµ•å°ä¸æœƒç™½å±) ===
        const users = ref(JSON.parse(JSON.stringify(DEFAULT_DATA.users)));
        const itinerary = ref(JSON.parse(JSON.stringify(DEFAULT_DATA.itinerary)));
        const spots = ref(JSON.parse(JSON.stringify(DEFAULT_DATA.spots)));
        const japanesePhrases = ref(JSON.parse(JSON.stringify(DEFAULT_DATA.phrases)));
        const expenses = ref([]);
        const syncStatus = ref('local'); // local, syncing, synced

        // UI ç‹€æ…‹
        const currentView = ref('welcome');
        const isWelcomeClosed = ref(false);
        const showPersonaModal = ref(false);
        const currentUser = ref(null);
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        const emergTab = ref('map');
        const moneyTab = ref('record');
        const currentLoc = ref('Tokyo');
        const showExpenseModal = ref(false);
        const modalData = ref({});
        
        // === 2. é›²ç«¯åŒæ­¥é‚è¼¯ (é‡è¦ä¿®å¾©) ===
        onMounted(() => {
            if(db) {
                // ç›£è½é›²ç«¯è³‡æ–™ (å¤šæ–¹åŒæ­¥)
                onSnapshot(doc(db, "trips", "kanto2026"), (docSnap) => {
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        // æ··åˆé‚è¼¯ï¼šé›²ç«¯æœ‰è³‡æ–™å°±è¦†è“‹æœ¬åœ°ï¼Œæ²’è³‡æ–™å°±ä¿æŒæœ¬åœ°
                        if(cloudData.users) users.value = cloudData.users;
                        if(cloudData.itinerary) itinerary.value = cloudData.itinerary;
                        if(cloudData.expenses) expenses.value = cloudData.expenses;
                        if(cloudData.spots) spots.value = cloudData.spots;
                        if(cloudData.phrases) japanesePhrases.value = cloudData.phrases;
                        syncStatus.value = 'synced';
                    } else {
                        // é›²ç«¯æ˜¯ç©ºçš„ (ç¬¬ä¸€æ¬¡ä½¿ç”¨)ï¼ŒæŠŠæœ¬åœ°é è¨­è³‡æ–™ä¸Šå‚³
                        saveData();
                    }
                });
            }
        });

        // å­˜æª”é‚è¼¯ (é˜²æ‰‹æŠ– Debounce)
        let saveTimer;
        const saveData = () => {
            syncStatus.value = 'syncing';
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                if(db) {
                    setDoc(doc(db, "trips", "kanto2026"), {
                        users: users.value,
                        itinerary: itinerary.value,
                        expenses: expenses.value,
                        spots: spots.value,
                        phrases: japanesePhrases.value,
                        lastUpdate: new Date().toISOString()
                    }, {merge: true});
                    syncStatus.value = 'synced';
                }
            }, 1000);
        };

        // === 3. æ¥­å‹™é‚è¼¯ ===
        const apps = [
            {id:1,name:'è¡Œç¨‹',icon:'fa-solid fa-map',view:'itinerary',bgClass:'bg-pink-400'},
            {id:2,name:'å°è²¡åº«',icon:'fa-solid fa-yen-sign',view:'money',bgClass:'bg-yellow-400'},
            {id:3,name:'æº–å‚™',icon:'fa-solid fa-suitcase',view:'prep',bgClass:'bg-blue-400'},
            {id:4,name:'ç¾é£Ÿ',icon:'fa-solid fa-utensils',view:'food',bgClass:'bg-orange-400'},
            {id:9,name:'æ€¥é›£',icon:'fa-solid fa-kit-medical',view:'emergency',bgClass:'bg-red-400'}
        ];
        const tripDays = [{week:'D1'},{week:'D2'},{week:'D3'},{week:'D4'},{week:'D5'},{week:'D6'},{week:'D7'},{week:'D8'}];
        const daysUntilTrip = ref(Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24)));
        const smartReminders = computed(() => daysUntilTrip.value <= 30 && daysUntilTrip.value > 0 ? ['å¯Œå£«å›éŠè™Ÿï¼šè©²æ¶ç¥¨äº†ï¼'] : []);

        const getPageTitle = (v) => apps.find(a=>a.view===v)?.name || 'é—œæ±ä¹‹æ—…';
        const getBudgetMood = () => {
             const budget = 30000;
             const spent = expenses.value.filter(e=>e.whoPaid===currentUser.value?.id).reduce((sum,e)=>sum+parseInt(e.amount),0);
             const r = spent/budget;
             return r>1?'ğŸ˜­':r>0.8?'ğŸ˜°':'ğŸ˜Š';
        };
        const getGreeting = () => {
            if(!currentUser.value) return 'è«‹å…ˆé¸æ“‡è§’è‰²';
            const n = currentUser.value.name;
            if(n.includes('å‰ä¼Š')) return 'å“‡...å“‡æ¯å“‡æ¯...\n(åŠªåŠ›è¨˜å¸³ä¸­)';
            if(n.includes('å°å…«')) return 'ä»Šå¤©ä¹Ÿè¦åŠªåŠ›å–”ï¼\n(å¾®ç¬‘)';
            if(n.includes('å…”å…”')) return 'Hula!!!\n(èˆˆå¥®)';
            if(n.includes('å°æ¡ƒ')) return 'å“¼...\nè¦èª‡çæˆ‘å¯æ„›å–”ï¼';
            return `æ­¡è¿ï¼Œ${n}ï¼`;
        };
        const getStamina = (i) => i===2 || i===3 ? 40 : 80;
        const getStaminaColor = (i) => getStamina(i) < 50 ? 'bg-red-500' : 'bg-green-400';
        const getPackingProgress = () => {
            if(!currentUser.value) return 0;
            const l = currentUser.value.list;
            return l.length ? Math.round((l.filter(i=>i.checked).length / l.length)*100) : 0;
        };
        
        const myPrivateExpenses = computed(() => expenses.value.filter(e => e.whoPaid === currentUser.value?.id));
        const groupExpenses = computed(() => expenses.value.filter(e => e.whoPaid !== currentUser.value?.id));

        const getImg = (p) => `https://placehold.co/600x400/pink/white?text=${p}`;
        const handleImgError = (e) => e.target.src = 'https://placehold.co/600x400/pink/white?text=No+Image';
        const getMapLink = (k) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}`;
        
        const syncStatusText = computed(() => syncStatus.value==='synced'?'å·²åŒæ­¥':syncStatus.value==='syncing'?'åŒæ­¥ä¸­...':'é›¢ç·šæ¨¡å¼');
        const syncStatusColor = computed(() => syncStatus.value==='synced'?'bg-green-400':syncStatus.value==='syncing'?'bg-yellow-400 animate-pulse':'bg-gray-400');

        // æ“ä½œè¡Œç‚º
        const login = (u) => { currentUser.value = u; showPersonaModal.value = false; currentView.value = 'menu'; };
        const getCurrentItinerary = () => itinerary.value[selectedDayIndex.value] || [];
        const openAddItinerary = () => { itinerary.value[selectedDayIndex.value].push({hours:'??:??',name:'æ–°è¡Œç¨‹',mapKeyword:''}); saveData(); };
        const openEditItinerary = (item,idx) => { const n=prompt('ä¿®æ”¹åç¨±',item.name); if(n) { item.name=n; saveData(); } };
        const openAddPhraseModal = () => { const j=prompt('æ—¥æ–‡'); const z=prompt('ä¸­æ–‡'); if(j&&z) { japanesePhrases.value.push({jp:j,zh:z}); saveData(); } };
        const addPrepItem = () => { if(currentUser.value) { currentUser.value.list.push({text:'æ–°ç‰©å“',checked:false}); saveData(); } };
        
        const openExpenseModal = () => { showExpenseModal.value = true; modalData.value = {name:'', amount:''}; };
        const quickExpense = (item) => { showExpenseModal.value = true; modalData.value = {name: item.name, amount:''}; };
        const confirmExpense = () => {
            if(currentUser.value && modalData.value.amount) {
                expenses.value.push({
                    id: Date.now(),
                    name: modalData.value.name,
                    amount: modalData.value.amount,
                    currency: 'JPY',
                    date: new Date().toLocaleDateString(),
                    whoPaid: currentUser.value.id
                });
                saveData();
            }
            showExpenseModal.value = false;
        };

        return {
            users, itinerary, spots, japanesePhrases, expenses,
            currentView, isWelcomeClosed, showPersonaModal, currentUser, 
            selectedDayIndex, itineraryMode, emergTab, moneyTab, currentLoc,
            showExpenseModal, modalData,
            apps, tripDays, daysUntilTrip, smartReminders,
            getPageTitle, getBudgetMood, getGreeting, getStamina, getStaminaColor, getPackingProgress,
            getImg, handleImgError, getMapLink, syncStatusText, syncStatusColor,
            myPrivateExpenses, groupExpenses,
            login, getCurrentItinerary, openAddItinerary, openEditItinerary, openAddPhraseModal,
            addPrepItem, openExpenseModal, quickExpense, confirmExpense, saveData
        };
    }
}).mount('#app');
</script>
</body>
</html>
