<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (V10.55 æ°‘å®¿ä¿®æ­£ç‰ˆ)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
<script>
    tailwind.config={
        theme:{
            extend:{
                colors:{'chii-pink':'#FFD1DC','chii-deep-pink':'#FF9EAC','chii-blue':'#A2D2FF','chii-yellow':'#FFF5BA','chii-text':'#5D4037'},
                fontFamily:{sans:['Zen Maru Gothic','sans-serif']},
                animation:{'wiggle':'wiggle 3s ease-in-out infinite','float':'float 3s ease-in-out infinite','fade-in':'fadeIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards'},
                keyframes:{
                    wiggle:{'0%,100%':{transform:'rotate(-3deg)'},'50%':{transform:'rotate(3deg)'}},
                    float:{'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-5px)'}},
                    fadeIn:{from:{opacity:0,transform:'translateY(15px)'},to:{opacity:1,transform:'translateY(0)'}}
                }
            }
        }
    }
</script>
<style>
    /* åŸºç¤è¨­å®š & æ‰‹æ©Ÿé©é… */
    html,body{margin:0;padding:0;width:100%;height:100%;background-color:#FFF0F5;background-image:radial-gradient(#FFD1DC 15%,transparent 16%),radial-gradient(#FFF5BA 15%,transparent 16%);background-size:60px 60px;background-position:0 0,30px 30px;font-family:-apple-system,BlinkMacSystemFont,"Zen Maru Gothic",sans-serif;color:#5D4037;overflow-x:hidden;-webkit-tap-highlight-color:transparent;padding-bottom:env(safe-area-inset-bottom)}
    input, textarea, select { font-size: 16px !important; } /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
    #app{display:block;min-height:100vh}
    [v-cloak]{display:none !important}
    
    /* æ»¾å‹•æ¢éš±è— */
    .hide-scrollbar::-webkit-scrollbar{display:none}.hide-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    
    /* å¡ç‰‡èˆ‡ç»ç’ƒæ“¬æ…‹ */
    .card{background:rgba(255,255,255,0.92);border-radius:24px;box-shadow:0 8px 30px rgba(0,0,0,0.04);border:1px solid rgba(255,255,255,0.6);margin-bottom:16px;position:relative;overflow:hidden;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
    
    /* æ­¡è¿é é¢ */
    .welcome-screen{position:fixed;inset:0;z-index:9999;background:#FFF0F5;transition:transform 0.8s cubic-bezier(0.65, 0, 0.35, 1);cursor:pointer}
    .welcome-screen.hidden-screen{transform:translateY(-100%);pointer-events:none}
    .welcome-bg{position:absolute;inset:0;z-index:0}.welcome-bg::after{content:'';position:absolute;inset:0;background:linear-gradient(to bottom,rgba(255,255,255,0.2),rgba(255,240,245,0.6))} 
    
    /* æŒ‰éˆ•èˆ‡äº’å‹• */
    .fab-main{position:fixed;bottom:calc(90px + env(safe-area-inset-bottom));right:20px;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;color:white;z-index:40;border:3px solid white;box-shadow:0 8px 20px rgba(255,105,180,0.3);background-color:#ff9eac;transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)}.fab-main:active{transform:scale(0.9)}
    .fab-home{position:fixed;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;color:white;z-index:900;border:4px solid white;box-shadow:0 5px 20px rgba(0,0,0,0.15);background:linear-gradient(135deg,#FF9EAC,#FFD1DC);cursor:grab;touch-action:none;transition:transform 0.1s}.fab-home:active{transform:scale(0.9);cursor:grabbing}
    
    /* Google æ‡¸æµ®æœå°‹ */
    .google-float { position: fixed; bottom: calc(160px + env(safe-area-inset-bottom)); right: 20px; z-index: 39; display: flex; align-items: center; justify-content: flex-end; transition: all 0.3s; }
    .google-btn { width: 48px; height: 48px; border-radius: 50%; background: white; border: 2px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #4285F4; shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s; }
    .google-bar { width: 0; overflow: hidden; height: 48px; background: white; border-radius: 24px; display: flex; align-items: center; transition: all 0.3s; margin-right: -24px; opacity: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .google-float.active .google-bar { width: 240px; margin-right: 12px; opacity: 1; padding: 0 10px; border: 1px solid #eee; }
    
    /* ç‰¹æ®Šæ¨£å¼ */
    .boarding-pass{background:white;border-radius:20px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,0.05);border:1px solid #f0f0f0;position:relative;margin-bottom:16px}
    .dashed-line{border-top:2px dashed #e0e0e0;margin:15px 0;position:relative}
    .sakura{position:fixed;top:-10px;background:#FFB7B2;border-radius:100% 0 100% 0;opacity:0.6;animation:fall linear infinite;z-index:0;pointer-events:none;width:12px;height:12px}@keyframes fall{to{transform:translate(15vw,105vh) rotate(360deg)}}
    .watercolor-img{width:100%;height:100%;object-fit:cover;transition:transform 0.6s}.card:active .watercolor-img{transform:scale(1.05)}
    
    /* è¼‰å…¥èˆ‡éŒ¯èª¤ç•«é¢ */
    #crash-screen { display: none; position: fixed; inset: 0; background: #fff0f5; z-index: 100000; padding: 20px; text-align: center; color: #b71c1c; overflow: auto; }
    #loading-screen { position: fixed; inset: 0; background: #fff0f5; z-index: 99999; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.5s; pointer-events: none; }
</style>
</head>
<body>

<div id="crash-screen">
    <h2 class="text-2xl font-bold mb-4">âš ï¸ ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤</h2>
    <p class="mb-4">è«‹æˆªåœ–æ­¤ç•«é¢ä¸¦å›å ±ã€‚</p>
    <pre id="error-log" class="text-left bg-white p-4 rounded border text-xs overflow-auto h-64"></pre>
</div>

<div id="loading-screen">
    <div style="font-size: 60px;" class="animate-bounce">ğŸŒ¸</div>
    <div class="mt-4 font-bold text-gray-600 text-lg">Trip 2026 Loading...</div>
</div>

<script>
    window.onerror = function(msg, url, line, col, error) {
        const l = document.getElementById('loading-screen');
        if(l) l.style.display = 'none';
        document.getElementById('crash-screen').style.display = 'block';
        document.getElementById('error-log').innerText = `${msg}\nLine: ${line}:${col}\n${error?error.stack:''}`;
    };
</script>

<div id="sakura-container"></div>

<div id="app" v-cloak>
    <div :class="['welcome-screen flex flex-col items-center justify-between', isWelcomeClosed ? 'hidden-screen' : '']" @click="enterSite">
        <div class="welcome-bg">
            <img :src="getImg('welcome.jpg')" @error="handleImgError" class="w-full h-full object-cover opacity-90">
        </div>
        <div class="relative z-10 mt-36 text-center px-6">
            <div class="inline-block bg-white/30 backdrop-blur-md px-4 py-1 rounded-full text-white text-sm font-bold tracking-widest border border-white/40 mb-4 shadow-lg animate-float">TOKYO â€¢ FUJI â€¢ KAMAKURA</div>
            <h1 class="text-6xl font-black text-white drop-shadow-xl tracking-widest mb-2 font-serif">é—œæ±ä¹‹æ—…</h1>
            <p class="text-2xl text-white/90 font-medium tracking-wider drop-shadow-md">2026.03.27 - 04.03</p>
        </div>
        <div class="relative z-10 mb-24 w-full px-10 pb-[env(safe-area-inset-bottom)]">
            <div class="text-white/80 text-center text-sm mb-4 animate-pulse">é»æ“Šä»»æ„è™•é–‹å§‹æ—…ç¨‹</div>
            <button class="w-full bg-white/95 hover:bg-white text-pink-500 font-black py-4 rounded-full shadow-2xl backdrop-blur-md transition-all transform active:scale-95 text-xl flex items-center justify-center gap-3">
                <span>ğŸŒ¸</span> Let's Go!
            </button>
        </div>
    </div>

    <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-[60px] bg-[#FFF0F5]/90 backdrop-blur-md z-30 flex items-center justify-between px-4 border-b border-pink-100/50 shadow-sm transition-all pt-[env(safe-area-inset-top)] box-content">
        <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow border border-pink-100 active:scale-90 transition"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="font-bold text-gray-700 text-lg flex items-center gap-2 tracking-wide"><i class="fa-solid fa-sakura text-pink-400 animate-spin-slow"></i> {{getPageTitle(currentView)}}</h1>
        <button @click="showSyncModal=true" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-blue-400 shadow border border-blue-100 active:scale-90 transition"><i class="fa-solid fa-sliders"></i></button>
    </div>
    <div v-if="currentView !== 'menu'" class="h-[60px] pt-[env(safe-area-inset-top)] box-content"></div>

    <div :class="['google-float', showGoogleSearch?'active':'']" v-if="isWelcomeClosed">
        <div class="google-bar">
            <form action="https://www.google.com/search" target="_blank" class="w-full flex">
                <input name="q" placeholder="Google æœå°‹..." class="w-full bg-transparent outline-none text-sm text-gray-700 placeholder-gray-400">
                <button type="submit" class="text-blue-500 px-2"><i class="fa-solid fa-magnifying-glass"></i></button>
            </form>
        </div>
        <div class="google-btn" @click="showGoogleSearch=!showGoogleSearch">
            <i class="fa-brands fa-google"></i>
        </div>
    </div>

    <div v-if="currentView==='menu'" class="min-h-screen p-6 pt-12 flex flex-col bg-[#FFF0F5] animate-fade-in pb-32">
        <h2 class="text-2xl font-black text-gray-700 mb-6 text-center pt-[env(safe-area-inset-top)] flex items-center justify-center gap-2"><i class="fa-solid fa-grid-2 text-pink-400"></i> åŠŸèƒ½é¸å–®</h2>
        
        <div class="mb-8 mx-1 bg-white/80 backdrop-blur-xl border border-white/60 rounded-3xl p-5 shadow-lg relative overflow-hidden flex items-start gap-4">
             <div class="bg-yellow-100 w-12 h-12 rounded-2xl flex items-center justify-center text-yellow-500 text-xl shrink-0"><i class="fa-solid fa-bell"></i></div>
             <div class="flex-1">
                 <h4 class="font-bold text-gray-800 text-lg mb-2">æ—…ç¨‹å€’æ•¸</h4>
                 <div class="space-y-1.5">
                     <div class="flex items-center gap-2 text-sm text-gray-600 font-medium"><span class="w-2 h-2 rounded-full bg-pink-400"></span> è·é›¢å‡ºç™¼ <b class="text-pink-500 text-lg mx-1">{{daysUntilTrip}}</b> å¤©</div>
                     <div class="flex items-center gap-2 text-xs text-gray-500"><span class="w-2 h-2 rounded-full bg-blue-400"></span> é…·èˆªå ±åˆ°ï¼š{{daysUntilTrip<=2?'å·²é–‹æ”¾!':'48å°æ™‚å‰'}}</div>
                 </div>
             </div>
        </div>
        
        <div class="grid grid-cols-3 gap-y-10 gap-x-6 px-2">
            <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition group" @click="currentView=app.view">
                <div class="w-[72px] h-[72px] rounded-[28px] flex items-center justify-center text-3xl text-white shadow-lg border-[5px] border-white group-hover:shadow-xl transition-all relative overflow-hidden" :class="app.bgClass">
                    <div class="absolute inset-0 bg-black/5 group-hover:bg-transparent transition"></div>
                    <i :class="app.icon"></i>
                </div>
                <span class="text-sm font-bold mt-3 text-gray-700 tracking-wide">{{app.name}}</span>
            </div>
        </div>
    </div>

    <div v-if="currentView==='itinerary'" class="px-4 py-2 pb-32 animate-fade-in">
        <div class="flex overflow-x-auto gap-2 mb-6 pb-2 hide-scrollbar sticky top-[76px] pt-[env(safe-area-inset-top)] bg-[#FFF0F5]/95 backdrop-blur z-20 py-3 -mx-4 px-4">
            <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-5 py-2.5 rounded-full whitespace-nowrap text-sm font-bold border transition-all shadow-sm',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400 shadow-md scale-105':'bg-white text-gray-400 border-white']">{{d.week}}<span class="ml-1.5 text-[10px] opacity-80 font-normal">{{d.title}}</span></button>
        </div>
        
        <div v-if="[2,3,4].includes(selectedDayIndex)" class="mb-6 flex justify-center">
            <div class="bg-white p-1.5 rounded-full border border-gray-100 flex shadow-md">
                <button @click="itineraryMode='normal'" :class="['px-6 py-2 rounded-full text-xs font-bold transition-all', itineraryMode==='normal'?'bg-pink-400 text-white shadow-sm':'text-gray-400 hover:bg-gray-50']">ä¸€èˆ¬è¡Œç¨‹</button>
                <button @click="itineraryMode='drive'" :class="['px-6 py-2 rounded-full text-xs font-bold transition-all', itineraryMode==='drive'?'bg-green-500 text-white shadow-sm':'text-gray-400 hover:bg-gray-50']"><i class="fa-solid fa-car"></i> è‡ªé§•åœ°åœ–</button>
            </div>
        </div>

        <div v-if="itineraryMode==='drive' && [2,3,4].includes(selectedDayIndex)" class="animate-fade-in space-y-4">
             <div class="bg-green-50 border border-green-200 p-4 rounded-2xl flex items-start gap-3">
                <i class="fa-solid fa-circle-info text-green-500 mt-1"></i>
                <div><h3 class="font-bold text-green-800 text-sm">ä»Šæ—¥é§•é§›é‡é»</h3><p class="text-xs text-green-600 mt-1">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¯ç›´æ¥é–‹å•Ÿ Google Maps å°èˆªã€‚</p></div>
            </div>
            <div class="pl-4 border-l-2 border-green-200 space-y-6 py-2">
                <div v-for="(stop, sIdx) in getDrivePlanForDay(selectedDayIndex)" :key="sIdx" class="card p-5 relative !overflow-visible !mb-0">
                     <div class="absolute -left-[25px] top-6 w-4 h-4 rounded-full border-2 border-green-400 bg-white z-10 shadow-sm"></div>
                     <div class="flex justify-between items-start gap-2">
                         <div><h5 class="font-bold text-gray-800 text-lg">{{stop.name}}</h5><p class="text-sm text-gray-500 mt-1 font-medium">{{stop.note}}</p></div>
                         <div class="flex flex-col gap-2 shrink-0">
                             <a :href="getMapLink(stop.location)" target="_blank" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-bold border border-blue-100 flex items-center gap-2 hover:bg-blue-100"><i class="fa-solid fa-location-dot"></i> å°èˆª</a>
                             <a v-if="stop.parking" :href="getMapLink(stop.parking)" target="_blank" class="bg-green-50 text-green-600 px-4 py-2 rounded-xl text-xs font-bold border border-green-200 flex items-center gap-2 hover:bg-green-100"><i class="fa-solid fa-square-parking"></i> åœè»Š</a>
                         </div>
                     </div>
                </div>
            </div>
        </div>
        
        <div v-else class="space-y-4">
            <div v-for="(item,idx) in currentItinerary" :key="item.id||idx" class="card p-5 relative active:scale-[0.98] transition !border-0 shadow-sm" @click="editItem(item,idx)">
                <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-pink-300 to-pink-100"></div>
                <div class="flex items-start gap-4">
                    <div class="flex flex-col items-center pt-1"><div class="text-xs font-bold text-gray-400 mb-1">{{item.hours}}</div><div class="w-10 h-10 rounded-full bg-pink-50 text-pink-400 flex items-center justify-center border border-pink-100"><i :class="getIconByCategory(item.category)"></i></div></div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-gray-800 text-lg leading-tight truncate">{{item.name}}</h3>
                        <p v-if="item.note" class="text-sm text-gray-500 mt-1 line-clamp-2">{{item.note}}</p>
                        <div class="flex gap-2 mt-3">
                            <a :href="getMapLink(item.mapKeyword)" target="_blank" @click.stop class="px-3 py-1 bg-gray-50 text-gray-500 rounded-lg text-xs font-bold border flex items-center gap-1"><i class="fa-solid fa-location-arrow"></i> åœ°åœ–</a>
                            <button @click.stop="deleteItem(idx)" class="px-3 py-1 bg-red-50 text-red-400 rounded-lg text-xs font-bold flex items-center gap-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <button @click="openAddModal" class="fab-main"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <div v-if="currentView==='hotel'" class="px-4 py-2 pb-32 animate-fade-in">
        <div class="flex gap-2 mb-6 justify-center bg-white p-1 rounded-full shadow-sm border mx-auto w-fit">
            <button @click="hotelTab='stay'" :class="['px-6 py-2 rounded-full font-bold transition-all',hotelTab==='stay'?'bg-indigo-500 text-white shadow-md':'text-gray-400 hover:bg-gray-50']">ä½å®¿</button>
            <button @click="hotelTab='flight'" :class="['px-6 py-2 rounded-full font-bold transition-all',hotelTab==='flight'?'bg-pink-500 text-white shadow-md':'text-gray-400 hover:bg-gray-50']">æ©Ÿç¥¨</button>
        </div>
        
        <div v-if="hotelTab==='stay'" class="space-y-6">
            <div v-for="h in hotels" class="card !p-0 border-0 shadow-lg group">
                <div class="h-32 bg-gray-200 relative overflow-hidden">
                    <img :src="getImg(h.img)" class="w-full h-full object-cover group-hover:scale-110 transition duration-700" @error="handleImgError">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                    <div class="absolute bottom-3 left-4 text-white">
                        <div class="text-xs font-bold bg-indigo-500 px-2 py-0.5 rounded mb-1 inline-block">{{h.days}}</div>
                        <h3 class="font-bold text-xl text-shadow">{{h.name}}</h3>
                    </div>
                </div>
                <div class="p-5">
                    <p class="text-sm text-gray-500 mb-4 flex items-start gap-2"><i class="fa-solid fa-map-pin text-indigo-400 mt-1"></i> {{h.address}}</p>
                    <a :href="h.link.startsWith('http') ? h.link : getMapLink(h.address)" target="_blank" class="w-full block bg-gray-50 hover:bg-indigo-50 text-indigo-600 font-bold py-3 rounded-xl text-center border border-indigo-100 transition"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                </div>
            </div>
        </div>

        <div v-if="hotelTab==='flight'">
             <div v-if="flightMode==='select'" class="grid grid-cols-2 gap-4">
                <div v-for="user in users" :key="user.id" class="card p-6 text-center cursor-pointer hover:bg-pink-50 transition relative" @click="currentFlightUser=user.id;flightMode='list'">
                    <button @click.stop="openUserEdit(user)" class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-blue-500 bg-white rounded-full shadow-sm border"><i class="fa-solid fa-pen text-xs"></i></button>
                    <div class="w-16 h-16 mx-auto rounded-full p-1 border-2 border-dashed border-pink-200 mb-3"><img v-if="user.avatar" :src="user.avatar" class="w-full h-full rounded-full object-cover"><div v-else class="w-full h-full flex items-center justify-center text-3xl bg-gray-50 rounded-full">{{user.icon}}</div></div>
                    <div class="font-bold text-gray-700">{{user.name}}</div>
                </div>
            </div>
            <div v-if="flightMode==='list'">
                <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg text-gray-700">{{getUserById(currentFlightUser).name}} çš„æ©Ÿç¥¨</h3><button @click="flightMode='select'" class="text-xs bg-white px-4 py-1.5 rounded-full shadow border text-gray-500">åˆ‡æ›æˆå“¡</button></div>
                <div class="boarding-pass">
                    <div class="bg-yellow-400 px-5 py-3 text-gray-800 font-black text-sm flex justify-between tracking-wider"><span>OUTBOUND å»ç¨‹</span><span>{{getUserById(currentFlightUser).name}}</span></div>
                    <div class="p-5 flex justify-between items-center">
                        <div class="text-center"><div class="text-4xl font-black text-gray-800 tracking-tighter">TPE</div><div class="text-xs text-gray-400 font-bold">TAIPEI</div></div>
                        <div class="flex-1 px-4 text-center"><i class="fa-solid fa-plane text-yellow-400 text-2xl"></i><div class="text-xs text-gray-400 font-bold mt-1 bg-gray-50 rounded py-1" @click="editFlightField('out_code')">{{getUserById(currentFlightUser).flightOutCode}}</div></div>
                        <div class="text-center"><div class="text-4xl font-black text-gray-800 tracking-tighter">NRT</div><div class="text-xs text-gray-400 font-bold">TOKYO</div></div>
                    </div>
                    <div class="dashed-line"></div>
                    <div class="px-6 pb-6 flex justify-between">
                        <div @click="editFlightField('out_dep')"> <div class="text-xs text-gray-400 font-bold">DEPART</div> <div class="text-2xl font-bold text-gray-700">{{getUserById(currentFlightUser).flightOutDep}}</div> </div>
                        <div class="text-right" @click="editFlightField('out_arr')"> <div class="text-xs text-gray-400 font-bold">ARRIVE</div> <div class="text-2xl font-bold text-gray-700">{{getUserById(currentFlightUser).flightOutArr}}</div> </div>
                    </div>
                </div>
                <div class="boarding-pass">
                    <div class="bg-blue-400 px-5 py-3 text-white font-black text-sm flex justify-between tracking-wider"><span>INBOUND å›ç¨‹</span><span>{{getUserById(currentFlightUser).name}}</span></div>
                    <div class="p-5 flex justify-between items-center">
                        <div class="text-center"><div class="text-4xl font-black text-gray-800 tracking-tighter">NRT</div><div class="text-xs text-gray-400 font-bold">TOKYO</div></div>
                        <div class="flex-1 px-4 text-center"><i class="fa-solid fa-plane fa-rotate-180 text-blue-300 text-2xl"></i><div class="text-xs text-gray-400 font-bold mt-1 bg-gray-50 rounded py-1" @click="editFlightField('in_code')">{{getUserById(currentFlightUser).flightInCode}}</div></div>
                        <div class="text-center"><div class="text-4xl font-black text-gray-800 tracking-tighter">TPE</div><div class="text-xs text-gray-400 font-bold">TAIPEI</div></div>
                    </div>
                    <div class="dashed-line"></div>
                    <div class="px-6 pb-6 flex justify-between">
                        <div @click="editFlightField('in_dep')"> <div class="text-xs text-gray-400 font-bold">DEPART</div> <div class="text-2xl font-bold text-gray-700">{{getUserById(currentFlightUser).flightInDep}}</div> </div>
                        <div class="text-right" @click="editFlightField('in_arr')"> <div class="text-xs text-gray-400 font-bold">ARRIVE</div> <div class="text-2xl font-bold text-gray-700">{{getUserById(currentFlightUser).flightInArr}}</div> </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="['food','shopping','photo'].includes(currentView)" class="px-4 py-2 pb-32 animate-fade-in">
        <div v-if="currentView==='food'" class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar justify-center sticky top-16 bg-[#FFF0F5]/95 backdrop-blur z-20 py-2"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="foodLoc=loc" :class="['px-6 py-2 rounded-full text-sm font-bold shadow-sm transition whitespace-nowrap',foodLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400 border border-gray-100']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc]}}</button></div>
        <div v-if="currentView==='shopping'" class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar justify-center"><button v-for="cat in ['wish','cosme','ldk','souvenir']" @click="shopCat=cat" :class="['px-5 py-2 rounded-full text-sm font-bold shadow-sm transition whitespace-nowrap',shopCat===cat?'bg-pink-400 text-white':'bg-white text-gray-400 border border-gray-100']">{{{'wish':'é¡˜æœ›','cosme':'è—¥å¦','ldk':'LDK','souvenir':'ä¼´æ‰‹ç¦®'}[cat]}}</button></div>
        <div v-if="currentView==='photo'" class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar justify-center"><button v-for="area in ['Tokyo','Kamakura','Fuji']" @click="photoArea=area" :class="['px-6 py-2 rounded-full text-sm font-bold shadow-sm transition whitespace-nowrap',photoArea===area?'bg-rose-400 text-white':'bg-white text-gray-400 border border-gray-100']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[area]}}</button></div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div v-for="(item,idx) in getCurrentList()" :key="item.id||idx" class="card overflow-hidden hover:shadow-lg transition group border-0">
                <div class="h-48 relative bg-gray-100 cursor-pointer overflow-hidden" @click="openImage(item.img)">
                    <img :src="getImg(item.img)" class="w-full h-full object-cover transition duration-700 group-hover:scale-110" @error="handleImgError">
                    <div class="absolute top-2 right-2 flex gap-2"><button @click.stop="editCommonItem(item,idx)" class="w-8 h-8 bg-white/90 rounded-full flex items-center justify-center shadow text-blue-400"><i class="fa-solid fa-pen"></i></button><button @click.stop="deleteCommonItem(idx)" class="w-8 h-8 bg-white/90 rounded-full flex items-center justify-center shadow text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                </div>
                <div class="p-5">
                    <h3 class="font-bold text-lg text-gray-800 mb-1">{{item.name}}</h3>
                    <p class="text-sm text-gray-500 mb-4 leading-relaxed line-clamp-2">{{item.desc}}</p>
                    <a :href="item.link.startsWith('http') ? item.link : getMapLink(item.link)" target="_blank" class="block text-center bg-gray-50 text-gray-600 hover:bg-gray-100 hover:text-blue-500 py-2.5 rounded-xl font-bold text-sm border transition"><i class="fa-solid fa-location-dot"></i> å°èˆª / è©³æƒ…</a>
                </div>
            </div>
        </div>
        <button @click="openAddCommonModal(currentView)" class="fab-main hover:rotate-90"><i class="fa-solid fa-plus"></i></button>
    </div>

    <div v-if="currentView==='weather'" class="px-4 py-2 pb-32 animate-fade-in">
         <div class="mb-6 bg-gradient-to-br from-blue-400 to-blue-500 p-6 rounded-3xl shadow-lg text-white relative overflow-hidden">
             <i class="fa-solid fa-cloud-sun text-9xl absolute -right-4 -bottom-4 opacity-20"></i>
             <div class="relative z-10">
                 <div class="text-xs font-bold opacity-80 mb-1 uppercase tracking-wider">Tokyo Forecast</div>
                 <div class="text-5xl font-black mb-2">{{tokyoWeather.temp}}Â°C</div>
                 <div class="text-sm font-medium opacity-90">ç©¿æ­ï¼š{{getClothingAdvice(tokyoWeather.temp)}}</div>
             </div>
         </div>
         <div class="space-y-4">
            <div v-for="w in [{t:'éŒå€‰ Kamakura',d:kamakuraWeather},{t:'å¯Œå£«å±± Mt.Fuji',d:fujiWeather}]" class="card p-5 flex items-center justify-between">
                <div>
                    <div class="font-bold text-gray-500 text-xs uppercase">{{w.t}}</div>
                    <div class="text-3xl font-black text-gray-800">{{w.d.temp}}Â°C</div>
                    <div class="text-xs text-gray-400 mt-1">{{getClothingAdvice(w.d.temp)}}</div>
                </div>
                <div class="text-4xl text-gray-300"><i class="fa-solid fa-temperature-half"></i></div>
            </div>
         </div>
         <div class="mt-6 text-center text-xs text-gray-400">æ•¸æ“šä¾†æºï¼šOpen-Meteo API (å³æ™‚é å ±)</div>
    </div>
    
    <div v-if="['money','prep','japanese'].includes(currentView)" class="px-4 py-2 pb-32 animate-fade-in">
        <div v-if="currentView==='money'">
             <div class="flex justify-between items-center mb-4 sticky top-16 bg-[#FFF0F5]/95 backdrop-blur z-20 py-2"><div class="flex bg-white rounded-xl p-1 shadow-sm border"><button @click="moneyTab='record'" :class="['px-4 py-1.5 rounded-lg text-sm font-bold transition',moneyTab==='record'?'bg-yellow-400 text-white shadow-sm':'text-gray-400']">è¨˜å¸³</button><button @click="moneyTab='split'" :class="['px-4 py-1.5 rounded-lg text-sm font-bold transition',moneyTab==='split'?'bg-blue-400 text-white shadow-sm':'text-gray-400']">åˆ†å¸³</button></div><div class="text-xs font-bold text-gray-500 bg-white px-3 py-1 rounded-full border">åŒ¯ç‡: {{exchangeRate}}</div></div>
             <div v-if="moneyTab==='record'" class="space-y-4">
                 <div v-if="moneyMode==='select'" class="grid grid-cols-2 gap-4"><div v-for="user in users" :key="user.id" class="card p-6 text-center cursor-pointer hover:-translate-y-1 transition border-0 shadow-sm" @click="selectMoneyUser(user.id)"><div class="w-14 h-14 mx-auto rounded-full bg-gray-100 mb-3 text-3xl flex items-center justify-center overflow-hidden border-2 border-white shadow"><img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover"><span v-else>{{user.icon}}</span></div><div class="font-bold text-gray-700">{{user.name}}</div></div></div>
                 <div v-else>
                     <div class="flex items-center gap-2 mb-4"><button @click="moneyMode='select'" class="w-8 h-8 rounded-full bg-white border flex items-center justify-center text-gray-400"><i class="fa-solid fa-chevron-left"></i></button><h3 class="font-bold text-lg text-gray-700">{{getUserById(currentUserId).name}} çš„éŒ¢åŒ…</h3></div>
                     <div class="card p-6 bg-gradient-to-r from-yellow-400 to-orange-400 text-white border-0 mb-4"><div class="text-xs opacity-80 font-bold mb-1">å€‹äººç¸½æ”¯å‡º</div><div class="text-3xl font-black">Â¥{{Number(userPersonalTotal).toLocaleString()}}</div></div>
                     <div class="space-y-2"><div v-for="exp in personalExpenses" :key="exp.id" class="card p-4 flex justify-between items-center !mb-2 !rounded-xl"><div><div class="font-bold text-gray-800">{{exp.name}}</div><div class="text-xs text-gray-400">{{exp.date}}</div></div><div class="flex items-center gap-3"><span class="font-bold text-lg text-gray-700">Â¥{{Number(exp.amount).toLocaleString()}}</span><button @click="deleteExpense(exp.id)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div></div></div>
                     <button @click="openExpenseModal('personal')" class="fab-main bg-yellow-400 text-white"><i class="fa-solid fa-pen"></i></button>
                 </div>
             </div>
             <div v-if="moneyTab==='split'">
                 <div class="card p-5 border-l-4 border-blue-400 mb-4"><h3 class="font-bold mb-3 flex gap-2 items-center text-blue-500"><i class="fa-solid fa-calculator"></i> çµç®—å»ºè­°</h3><div v-if="settlements.length===0" class="text-sm text-gray-400 text-center py-4">ç›®å‰æ²’æœ‰æ¬ æ¬¾</div><div v-for="s in settlements" class="flex justify-between text-sm py-2 border-b border-dashed border-gray-200 last:border-0"><div class="flex items-center gap-2"><span class="font-bold">{{getUserById(s.from).name}}</span><i class="fa-solid fa-arrow-right text-gray-300 text-xs"></i><span class="font-bold">{{getUserById(s.to).name}}</span></div><span class="font-bold text-blue-500">Â¥{{s.amount.toLocaleString()}}</span></div></div>
                 <div class="text-sm font-bold text-gray-500 mb-2 ml-1">å…¬å¸³æ˜ç´° (èª°å…ˆå¢Šä»˜)</div>
                 <div class="space-y-2"><div v-for="exp in groupExpenses" :key="exp.id" class="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm"><div><div class="font-bold text-gray-700">{{exp.name}}</div><div class="text-xs text-blue-400 font-bold mt-0.5">{{getUserById(exp.user).name}} å¢Šä»˜</div></div><div class="flex items-center gap-3"><span class="font-bold text-gray-800">Â¥{{Number(exp.amount).toLocaleString()}}</span><button @click="deleteExpense(exp.id)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div></div></div>
                 <button @click="openExpenseModal('group')" class="fab-main bg-blue-400 text-white"><i class="fa-solid fa-users"></i></button>
             </div>
        </div>
        <div v-if="currentView==='prep'">
            <div class="flex gap-2 mb-4 justify-center sticky top-16 bg-[#FFF0F5]/95 backdrop-blur z-20 py-2"><button @click="prepTab='personal'" :class="['px-6 py-2 rounded-full font-bold shadow-sm transition',prepTab==='personal'?'bg-pink-400 text-white':'bg-white text-gray-400']">è¡Œææ¸…å–®</button><button @click="prepTab='car'" :class="['px-6 py-2 rounded-full font-bold shadow-sm transition',prepTab==='car'?'bg-green-400 text-white':'bg-white text-gray-400']">ç§Ÿè»Šè³‡è¨Š</button></div>
            <div v-if="prepTab==='personal'">
                <div v-if="prepMode==='select'" class="grid grid-cols-2 gap-4"><div v-for="user in users" :key="user.id" class="card p-5 cursor-pointer hover:bg-pink-50 transition" @click="selectPrepUser(user.id)"><div class="flex justify-between items-center mb-3"><div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-xl overflow-hidden border border-white shadow"><img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover"><span v-else>{{user.icon}}</span></div><div class="font-bold text-gray-700">{{user.name}}</div></div><div class="h-2.5 w-full bg-gray-100 rounded-full overflow-hidden"><div class="h-full bg-pink-400 transition-all duration-1000" :style="{width: getProgress(user.id)+'%'}"></div></div><div class="text-right text-xs text-gray-400 mt-1 font-bold">{{Math.round(getProgress(user.id))}}% å®Œæˆ</div></div></div>
                <div v-else>
                     <div class="flex items-center gap-2 mb-4"><button @click="prepMode='select'" class="w-8 h-8 rounded-full bg-white border flex items-center justify-center text-gray-400"><i class="fa-solid fa-chevron-left"></i></button><h3 class="font-bold text-lg text-gray-700">{{getUserById(prepUser).name}} çš„æ¸…å–®</h3></div>
                     <div class="card p-0 overflow-hidden"><div class="bg-pink-50 p-4 border-b border-pink-100 flex justify-between items-center"><span class="font-bold text-pink-500 text-sm">æª¢æŸ¥é …ç›®</span><button @click="addPrepItem" class="text-xs bg-white text-pink-500 px-3 py-1 rounded-full border border-pink-200 font-bold">+ æ–°å¢</button></div>
                     <div class="p-2 divide-y divide-gray-100"><div v-for="(item,idx) in currentPrepList" :key="idx" class="flex items-center gap-3 p-3"><div class="relative flex items-center"><input type="checkbox" v-model="item.checked" class="peer w-6 h-6 border-2 border-gray-300 rounded-lg checked:bg-pink-500 checked:border-pink-500 transition appearance-none"><i class="fa-solid fa-check text-white absolute left-1 top-1.5 text-xs opacity-0 peer-checked:opacity-100 pointer-events-none"></i></div><input v-model="item.text" class="flex-1 text-sm bg-transparent outline-none font-medium text-gray-700 transition" :class="{'line-through text-gray-300':item.checked}"><button @click="currentPrepList.splice(idx,1)" class="text-gray-300 p-2 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button></div></div></div>
                </div>
            </div>
            <div v-if="prepTab==='car'" class="card p-6 border-l-4 border-green-500"><h3 class="font-bold text-lg mb-4 text-gray-800">è‡ªé§•é‡è¦è³‡è¨Š</h3><ul class="space-y-3 text-sm text-gray-600 list-disc pl-4 mb-4"><li>å–è»Šæ™‚éœ€å‡ºç¤ºï¼š<b class="text-red-500">å°ç£é§•ç…§ + æ—¥æ–‡è­¯æœ¬ + è­·ç…§</b></li><li>æ‰€æœ‰ä¹˜å®¢çš†éœ€ç¹«å®‰å…¨å¸¶ã€‚</li><li>å³é§•é å·¦è¡Œé§›ï¼Œè½‰å½å£è¨£ã€Œå·¦å°å³å¤§ã€ã€‚</li></ul><div class="grid gap-3"><a href="https://rent.toyota.co.jp/zh-tw/" target="_blank" class="bg-gray-50 hover:bg-green-50 p-3 rounded-xl border border-gray-200 text-center font-bold text-green-700 transition">TOYOTA Rent a Car</a></div></div>
        </div>
        <div v-if="currentView==='japanese'">
             <button @click="openCamera" class="w-full bg-gradient-to-r from-emerald-500 to-green-400 rounded-3xl p-8 text-white text-center mb-6 shadow-xl relative overflow-hidden active:scale-95 transition group"><i class="fa-solid fa-camera text-9xl absolute -right-8 -bottom-8 opacity-20 rotate-12"></i><h3 class="font-bold text-2xl mb-2">ğŸ“¸ æ‹ç…§ç¿»è­¯</h3><p class="text-sm opacity-90 font-medium">Google Lens å•Ÿå‹•ä¸­...</p></button>
             <div class="space-y-3"><div v-for="(phrase,idx) in japanesePhrases" :key="idx" @click="speak(phrase.jp)" class="card p-5 flex items-center justify-between cursor-pointer active:scale-95 transition border-l-[6px] border-emerald-400"><div><div class="font-bold text-xl text-gray-800 mb-1">{{phrase.jp}}</div><div class="text-sm text-gray-500 font-medium">{{phrase.tw}}</div></div><div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-500 text-xl shadow-inner"><i class="fa-solid fa-volume-high"></i></div><button @click.stop="japanesePhrases.splice(idx,1)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400 p-2"><i class="fa-solid fa-trash"></i></button></div></div>
             <button @click="openAddCommonModal('jp')" class="fab-main bg-emerald-500 hover:bg-emerald-600"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <div v-show="currentView !== 'menu'" class="fab-home touch-none" :style="{top: homeBtnPos.y+'px', left: homeBtnPos.x+'px'}" @click="currentView='menu'" @touchstart.prevent="startDrag($event, 'home')" @mousedown.prevent="startDrag($event, 'home')">
        <i class="fa-solid fa-house"></i>
    </div>

    <div v-if="showLightbox" class="fixed inset-0 z-[100] bg-white/95 backdrop-blur flex items-center justify-center p-4 animate-fade-in" @click="showLightbox=false"><img :src="currentZoomImg" class="max-w-full max-h-[80vh] rounded-2xl shadow-2xl border-4 border-white" @click.stop><button class="absolute top-6 right-6 text-gray-400 hover:text-gray-800 text-4xl"><i class="fa-solid fa-circle-xmark"></i></button></div>
    
    <div v-if="showModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-center">{{isEditing?'ç·¨è¼¯è¡Œç¨‹':'æ–°å¢è¡Œç¨‹'}}</h3><input v-model="editForm.name" placeholder="åç¨±" class="w-full p-4 bg-gray-50 rounded-xl mb-3 outline-none border focus:border-pink-300 font-bold"><div class="flex gap-2 mb-3"><input v-model="editForm.hours" placeholder="æ™‚é–“" class="w-1/3 p-4 bg-gray-50 rounded-xl outline-none border focus:border-pink-300"><select v-model="editForm.category" class="flex-1 p-4 bg-gray-50 rounded-xl outline-none border focus:border-pink-300"><option value="Sightseeing">ğŸ“¸ æ™¯é»</option><option value="Food">ğŸ´ ç¾é£Ÿ</option><option value="Shopping">ğŸ›ï¸ è³¼ç‰©</option><option value="Transport">ğŸš„ äº¤é€š</option><option value="Flight">âœˆï¸ èˆªç­</option></select></div><input v-model="editForm.mapKeyword" placeholder="åœ°åœ–é—œéµå­— (ç”¨æ–¼å°èˆª)" class="w-full p-4 bg-gray-50 rounded-xl mb-3 outline-none border focus:border-pink-300"><textarea v-model="editForm.note" class="w-full p-4 bg-gray-50 rounded-xl h-24 mb-4 outline-none border focus:border-pink-300 resize-none" placeholder="å‚™è¨»ç­†è¨˜..."></textarea><div class="flex gap-3"><button @click="showModal=false" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="saveItem" class="flex-1 bg-pink-400 text-white py-3 rounded-xl font-bold shadow-md">å„²å­˜</button></div></div></div>
    
    <div v-if="showCommonModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-center">{{isEditing?'ç·¨è¼¯é …ç›®':'æ–°å¢é …ç›®'}}</h3><input v-model="newCommon.text1" placeholder="åç¨±/æ—¥æ–‡" class="w-full p-4 bg-gray-50 rounded-xl mb-3 outline-none border focus:border-pink-300 font-bold"><textarea v-if="commonType!=='jp'" v-model="newCommon.text2" class="w-full p-4 bg-gray-50 rounded-xl h-24 mb-3 outline-none border resize-none" placeholder="ç°¡çŸ­æè¿°..."></textarea><input v-else v-model="newCommon.text2" placeholder="ä¸­æ–‡ç¿»è­¯" class="w-full p-4 bg-gray-50 rounded-xl mb-3 outline-none border"><div v-if="commonType!=='jp'" class="flex items-center gap-3 mb-4"><div class="w-20 h-20 bg-gray-100 rounded-xl flex items-center justify-center border overflow-hidden shrink-0"><img v-if="newCommon.text3" :src="newCommon.text3" class="w-full h-full object-cover"><i v-else class="fa-solid fa-image text-gray-300 text-xl"></i></div><button @click="$refs.commonImageInput.click()" class="flex-1 bg-blue-50 text-blue-500 h-12 rounded-xl font-bold border border-blue-100 hover:bg-blue-100 transition">ä¸Šå‚³åœ–ç‰‡</button></div><div class="flex gap-3"><button @click="showCommonModal=false" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="saveCommonItem" class="flex-1 bg-blue-400 text-white py-3 rounded-xl font-bold shadow-md">å„²å­˜</button></div></div></div>
    
    <div v-if="showUserModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center"><h3 class="font-bold text-lg mb-4">ç·¨è¼¯æˆå“¡è³‡æ–™</h3><div class="w-24 h-24 mx-auto bg-gray-100 rounded-full mb-4 relative border-4 border-white shadow overflow-hidden group cursor-pointer" @click="triggerAvatarUpload"><img v-if="editingUser.avatar" :src="editingUser.avatar" class="w-full h-full object-cover"><div v-else class="w-full h-full flex items-center justify-center text-4xl">{{editingUser.icon}}</div><div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white text-xs font-bold">æ›´æ›ç…§ç‰‡</div></div><input v-model="editingUser.name" class="w-full p-3 bg-gray-50 rounded-xl mb-4 text-center font-bold outline-none border focus:border-pink-300" placeholder="åå­—"><div class="flex gap-3"><button @click="showUserModal=false" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="saveUserEdit" class="flex-1 bg-pink-400 text-white py-3 rounded-xl font-bold shadow-md">å„²å­˜</button></div></div></div>
    
    <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-center">è¨˜ä¸€ç­†</h3><input v-model="newExpense.name" placeholder="æ¶ˆè²»é …ç›®" class="w-full p-4 bg-gray-50 rounded-xl mb-3 outline-none border focus:border-yellow-300 font-bold"><div class="flex gap-2 mb-3"><input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡" class="flex-1 p-4 bg-gray-50 rounded-xl outline-none border focus:border-yellow-300 text-lg font-bold"><div class="w-24 flex items-center justify-center bg-gray-100 rounded-xl font-bold text-gray-500">JPY</div></div><div class="mb-4"><label class="text-xs text-gray-400 font-bold ml-1 mb-1 block">{{expenseType==='group'?'èª°å…ˆå¢Šä»˜?':'èª°èŠ±çš„?'}}</label><div class="flex gap-2 overflow-x-auto pb-1"><button v-for="u in users" :key="u.id" @click="currentUserId=u.id" :class="['px-4 py-2 rounded-full text-xs font-bold border transition shrink-0',currentUserId===u.id?'bg-yellow-400 border-yellow-400 text-white shadow-md':'bg-white border-gray-200 text-gray-400']">{{u.name}}</button></div></div><div class="flex gap-3"><button @click="showExpenseModal=false" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="addExpense" class="flex-1 bg-yellow-400 text-white py-3 rounded-xl font-bold shadow-md">å„²å­˜</button></div></div></div>

    <div v-if="showSyncModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative"><button @click="showSyncModal=false" class="absolute top-4 right-4 text-gray-300 w-8 h-8 flex items-center justify-center rounded-full bg-gray-50"><i class="fa-solid fa-xmark"></i></button><h3 class="font-bold text-xl mb-1 text-center text-gray-800">è¨­å®šèˆ‡å‚™ä»½</h3><p class="text-xs text-gray-400 text-center mb-6">V10.55 Final Correction</p><button @click="isWelcomeClosed=false;showSyncModal=false" class="w-full py-3 bg-gray-50 hover:bg-gray-100 text-gray-600 rounded-xl font-bold mb-3 flex items-center justify-center gap-3 transition"><i class="fa-solid fa-house-user"></i> å›åˆ°æ­¡è¿é é¢</button><button @click="saveAsHtml" class="w-full py-3 bg-gradient-to-r from-blue-400 to-indigo-400 text-white rounded-xl font-bold mb-3 flex items-center justify-center gap-3 shadow-md active:scale-95 transition"><i class="fa-solid fa-download"></i> ä¸‹è¼‰å‚™ä»½ (HTML)</button><hr class="border-gray-100 my-4"><button @click="resetItinerary" class="w-full py-3 bg-red-50 text-red-500 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-red-100 transition"><i class="fa-solid fa-triangle-exclamation"></i> é‡ç½®æ‰€æœ‰è³‡æ–™</button></div></div>
    
    <input type="file" ref="commonImageInput" accept="image/*" class="hidden" @change="processCommonImageUpload">
    <input type="file" ref="avatarInput" accept="image/*" class="hidden" @change="processAvatarUpload">
</div>

<script>
const sc = document.getElementById('sakura-container');
for(let i=0; i<12; i++){ const e=document.createElement('div'); e.className='sakura'; e.style.left=Math.random()*100+'vw'; e.style.animationDuration=Math.random()*3+6+'s'; sc.appendChild(e); }
</script>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

createApp({
    setup() {
        const STORAGE_KEY = 'v10_55_bnb_fix';
        const currentView = ref('menu');
        const isWelcomeClosed = ref(false);
        const showGoogleSearch = ref(false);
        
        const BASE_RAW_URL = 'https://raw.githubusercontent.com/sunny5200820-maker/2026.tokyo.fuji.trip/main/';
        const getImg = (path) => {
            if (!path) return 'https://placehold.co/400x300/FFD1DC/ffffff?text=No+Image';
            if (path.startsWith('http') || path.startsWith('data:image')) return path;
            const cleanName = path.replace(/^images\//, '');
            if(cleanName === '2026.tokyo.jpg' || cleanName === 'welcome.jpg') return BASE_RAW_URL + cleanName;
            return BASE_RAW_URL + 'images/' + cleanName;
        };
        const handleImgError = (e) => { e.target.src = 'https://placehold.co/400x300/f3f4f6/cbd5e1?text=Image+Missing'; };

        // --- ä½å®¿è³‡æ–™ä¿®æ­£ (æ°‘å®¿) ---
        const hotels = [
            // ç¬¬ä¸€é–“ä¿®æ­£ç‚ºéŒ¦ç³¸ç”ºæ°‘å®¿ï¼Œé€£çµä½¿ç”¨ä½¿ç”¨è€…æŒ‡å®šé€£çµ
            {name:'éŒ¦ç³¸ç”ºæ°‘å®¿ (Sumida City)', days:'Day 1-2', link:'https://maps.app.goo.gl/cyLNVJttoAM61dmFA', img:'https://placehold.co/400x300/333/fff?text=Kinshicho+BnB', address:'æ±äº¬éƒ½å¢¨ç”°åŒºéŒ¦ç³¸ç”º (ä¾é€£çµå°èˆª)'},
            {name:'Megu Fuji 2021',days:'Day 3-4',link:'Megu Fuji 2021',img:'https://placehold.co/400x300/333/fff?text=Megu+Fuji',address:'å±±æ¢¨çœŒå¯Œå£«å‰ç”°å¸‚å¯Œå£«è¦‹2-7-6'},
            {name:'DOMO Hotel Shinjuku',days:'Day 5-7',link:'DOMO Hotel Shinjuku',img:'https://placehold.co/400x300/333/fff?text=DOMO+Hotel',address:'æ±äº¬éƒ½æ–°å®¿åŒºç™¾äººç”º1-15-25'}
        ];
        
        // --- è¡Œç¨‹è³‡æ–™ä¿®æ­£ (Day 1) ---
        const defaultItinerary = [
            [{id:101,category:'Flight',name:'06:40 æ¡ƒåœ’èµ·é£› (TR898)',hours:'06:40',mapKeyword:'Taoyuan Airport',note:'T1èˆªå»ˆï¼Œææ—©2.5å°æ™‚æŠµé”'},{id:102,category:'Flight',name:'10:40 æŠµé”æˆç”° (NRT)',hours:'10:40',mapKeyword:'Narita Airport',note:'å…¥å¢ƒå¯©æŸ¥ -> é ˜è¡Œæ -> ç§Ÿè»Š/æ­è»Š'},
             // ä¿®æ­£ï¼šå‰å¾€æ°‘å®¿
             {id:103,category:'Transport',name:'å‰å¾€éŒ¦ç³¸ç”ºæ°‘å®¿',hours:'12:30',mapKeyword:'Kinshicho Station',note:'å¯„æ”¾è¡Œæ (é€£çµè«‹è¦‹ä½å®¿é )'},{id:104,category:'Sightseeing',name:'æ™´ç©ºå¡” Solamachi',hours:'14:00',mapKeyword:'Tokyo Skytree',note:'é€›è¡—/æ°´æ—é¤¨'},{id:105,category:'Food',name:'æ™šé¤ï¼šæ•˜æ•˜è‹‘ç‡’è‚‰',hours:'18:00',mapKeyword:'Jojoen Skytree',note:'é«˜ç©ºæ™¯è§€ç‡’è‚‰'}],
            [{id:201,category:'Sightseeing',name:'æ·ºè‰å¯º & é›·é–€',hours:'09:00',mapKeyword:'Senso-ji',note:'è¶æ—©å»é¿é–‹äººæ½®'},{id:202,category:'Food',name:'åˆé¤ï¼šæ·ºè‰ä»ŠåŠ',hours:'12:00',mapKeyword:'Asakusa Imahan',note:'å£½å–œç‡’è€åº—'},{id:203,category:'Sightseeing',name:'ä¸Šé‡æ©è³œå…¬åœ’',hours:'14:00',mapKeyword:'Ueno Park',note:'è³æ«»ç†±é»'},{id:204,category:'Shopping',name:'é˜¿ç¾æ©«ç”º',hours:'16:00',mapKeyword:'Ameyoko',note:'è—¥å¦/é›¶é£Ÿæ¡è²·'},{id:205,category:'Food',name:'æ™šé¤ï¼šé³¥è²´æ—',hours:'19:00',mapKeyword:'Torikizoku Ueno',note:'å¹³åƒ¹ä¸²ç‡’'}],
            [{id:301,category:'Transport',name:'å–è»Šå‰å¾€æ²³å£æ¹–',hours:'09:00',mapKeyword:'Kinshicho Station',note:'é–‹å§‹è‡ªé§•ï¼Œè»Šç¨‹ç´„2å°æ™‚'},{id:302,category:'Food',name:'åˆé¤ï¼šä¸å‹•èŒ¶å±‹',hours:'12:00',mapKeyword:'Houtou Fudou Higashikoiji',note:'æ±æˆ€è·¯åº—ï¼Œé›²æœµå»ºç¯‰'},{id:303,category:'Sightseeing',name:'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨',hours:'14:00',mapKeyword:'Oishi Park',note:'å¤§çŸ³å…¬åœ’è³èŠ±'},{id:304,category:'Hotel',name:'Check-in: Megu Fuji',hours:'16:00',mapKeyword:'Megu Fuji 2021',note:'ç¨ä½œä¼‘æ¯'},{id:305,category:'Food',name:'æ™šé¤ï¼šè¶…å¸‚æ¡è²·',hours:'18:00',mapKeyword:'Ogino Kawaguchiko',note:'è²·å’Œç‰›å›é£¯åº—ç…'}],
            [{id:401,category:'Sightseeing',name:'å±±ä¸­æ¹–å¹³é‡ä¹‹æ¿±',hours:'06:00',mapKeyword:'Hirano no Hama',note:'çœ‹é€†å¯Œå£«æ—¥å‡º'},{id:402,category:'Sightseeing',name:'é•·æ± è¦ªæ°´å…¬åœ’',hours:'09:00',mapKeyword:'Nagaike Water Park',note:'é¤µå¤©éµ/æ‹å¯Œå£«å±±'},{id:403,category:'Sightseeing',name:'å¿é‡å…«æµ·',hours:'11:00',mapKeyword:'Oshino Hakkai',note:'åæ°´ç™¾é¸'},{id:404,category:'Food',name:'åˆé¤ï¼šå±±éº“åœ’',hours:'13:00',mapKeyword:'Sanrokuen',note:'çˆç«¯ç‡’é«”é©—'},{id:405,category:'Sightseeing',name:'KABA æ°´é™¸å·´å£«',hours:'15:00',mapKeyword:'Yamanakako KABA',note:'éŠæ¹–é«”é©—'}],
            [{id:501,category:'Sightseeing',name:'æ–°å€‰å±±æ·ºé–“å…¬åœ’',hours:'08:00',mapKeyword:'Chureito Pagoda',note:'çˆ¬398éšæ¢¯çœ‹äº”é‡å¡”'},{id:502,category:'Sightseeing',name:'ä¸‹å‰ç”°æœ¬ç”ºé€š',hours:'10:30',mapKeyword:'Honcho Street Fujiyoshida',note:'æ‹è¡—æ™¯'},{id:503,category:'Transport',name:'è¿”å›æ±äº¬ (é‚„è»Š)',hours:'13:00',mapKeyword:'Shinjuku Station',note:'å‰å¾€æ–°å®¿é‚„è»Š'},{id:504,category:'Hotel',name:'Check-in: DOMO Hotel',hours:'16:00',mapKeyword:'DOMO Hotel Shinjuku',note:'å…¥ä½æ–°å®¿'},{id:505,category:'Food',name:'æ™šé¤ï¼šæ–°å®¿æ­Œèˆä¼ç”º',hours:'18:00',mapKeyword:'Kabukicho',note:'å±…é…’å±‹æ¢éšª'}],
            [{id:601,category:'Transport',name:'æ­ä¹˜æ±Ÿä¹‹é›»',hours:'09:00',mapKeyword:'Fujisawa Station',note:'å‰å¾€éŒå€‰'},{id:602,category:'Sightseeing',name:'éŒå€‰é«˜æ ¡å‰',hours:'10:00',mapKeyword:'Kamakura Kokomae',note:'çŒç±ƒé«˜æ‰‹å¹³äº¤é“'},{id:603,category:'Food',name:'åˆé¤ï¼šBills',hours:'12:00',mapKeyword:'Bills Shichirigahama',note:'æµ·é‚Šé¬†é¤…'},{id:604,category:'Sightseeing',name:'éŒå€‰å¤§ä½› & é•·è°·å¯º',hours:'14:00',mapKeyword:'Kotoku-in',note:'åƒæ‹œ'},{id:605,category:'Sightseeing',name:'æ±Ÿä¹‹å³¶å¤•é™½',hours:'17:00',mapKeyword:'Enoshima Sea Candle',note:'ç¨šå…’ä¹‹æ·µ'}],
            [{id:701,category:'Sightseeing',name:'æ±äº¬éµå¡”',hours:'10:00',mapKeyword:'Tokyo Tower',note:'èŠå…¬åœ’é‡é¤'},{id:702,category:'Sightseeing',name:'éº»å¸ƒå°ä¹‹ä¸˜',hours:'13:00',mapKeyword:'Azabudai Hills',note:'æ–°åœ°æ¨™é€›è¡—'},{id:703,category:'Shopping',name:'æ¾€è°· Parco / Loft',hours:'15:00',mapKeyword:'Shibuya Parco',note:'ä»»å¤©å ‚/å¯¶å¯å¤¢ä¸­å¿ƒ'},{id:704,category:'Sightseeing',name:'SHIBUYA SKY',hours:'17:30',mapKeyword:'SHIBUYA SKY',note:'é ç´„å¤•é™½æ™‚æ®µ'},{id:705,category:'Food',name:'æ™šé¤ï¼šæ¾€è°·æ©«ä¸',hours:'19:30',mapKeyword:'Miyashita Park',note:'å®®ä¸‹å…¬åœ’'}],
            [{id:801,category:'Shopping',name:'æœ€å¾Œè£œè²¨',hours:'10:00',mapKeyword:'Shinjuku',note:'å”å‰è¨¶å¾·/è—¥å¦'},{id:802,category:'Transport',name:'å‰å¾€æˆç”°æ©Ÿå ´',hours:'13:00',mapKeyword:'Narita Express',note:'æ­ä¹˜ NEX'},{id:803,category:'Flight',name:'20:40 èµ·é£› (BR197)',hours:'20:40',mapKeyword:'Narita Airport',note:'å†è¦‹æ±äº¬'},{id:804,category:'Flight',name:'23:20 æŠµé”æ¡ƒåœ’',hours:'23:20',mapKeyword:'Taoyuan Airport',note:'å¹³å®‰å›å®¶'}]
        ];
        
        const defaultShopping = {
            wish: [{name:'Chiikawa Land',desc:'åŸå®¿/æ±äº¬è»Šç«™é™å®š',link:'Kiddy Land Harajuku',img:'welcome.jpg'}, {name:'å¯Œå£«å±±æ¯',desc:'æ˜Ÿå·´å…‹/ç”°å³¶ç¡å­',link:'Starbucks Japan',img:'2026.tokyo.jpg'}, {name:'Le Labo',desc:'æ±äº¬é™å®š Gaiac 10',link:'Le Labo Daikanyama',img:''}, {name:'Porter',desc:'å‰ç”°åŒ… (è¡¨åƒé“)',link:'Porter Omotesando',img:''}, {name:'Human Made',desc:'è—ç“¶è¯åå‘¨é‚Š',link:'Human Made Offline Store',img:''}],
            cosme: [{name:'Tirtir æ°£å¢Š',desc:'ç´…ç›’é«˜é®ç‘•',link:'Tirtir',img:''}, {name:'Kate æ€ªç¸å”‡è†',desc:'è‰²è™Ÿ 03/05/103',link:'Kate Lip Monster',img:''}, {name:'&Honey é«®æ²¹',desc:'Melty ä¿®è­·ç³»åˆ—',link:'and honey hair oil',img:''}, {name:'Canmake',desc:'æ£‰èŠ±ç³–èœœç²‰é¤…',link:'Canmake Tokyo',img:''}, {name:'Takami å°è—ç“¶',desc:'è§’è³ªä»£è¬ç²¾è¯',link:'Takami Skin Peel',img:''}],
            ldk: [{name:'Lululun é¢è†œ',desc:'æ±äº¬/å¯Œå£«å±±é™å®š',link:'Lululun Mask',img:''}, {name:'Fino é«®è†œ',desc:'é«˜ CP å€¼å¿…å›¤',link:'Fino Hair Mask',img:''}, {name:'Excel çœ‰ç­†',desc:'PD01 / PD02',link:'Excel Makeup',img:''}, {name:'Biore é˜²æ›¬',desc:'æ°´æ„Ÿé˜²æ›¬ç²¾è¯',link:'Biore UV',img:''}, {name:'Nivea è—ç½',desc:'æ—¥ç‰ˆæˆåˆ†ä¸åŒ',link:'Nivea Japan',img:''}],
            souvenir: [{name:'NY Perfect Cheese',desc:'æ±äº¬ç«™å¿…æ’èµ·å¸è„†é¤…',link:'New York Perfect Cheese',img:''}, {name:'Tokyo Banana',desc:'çš®å¡ä¸˜/å“†å•¦Aå¤¢ç‰ˆ',link:'Tokyo Banana',img:''}, {name:'Press Butter Sand',desc:'ç„¦ç³–å¥¶æ²¹å¤¾å¿ƒ',link:'Press Butter Sand',img:''}, {name:'Sugar Butter Tree',desc:'ç ‚ç³–å¥¶æ²¹æ¨¹',link:'Sugar Butter Tree',img:''}, {name:'Audrey',desc:'è‰è“èŠ±æŸé¤…ä¹¾',link:'Audrey Tokyo',img:''}]
        };
        const defaultFood = {
            Tokyo: [{name:'AFURI æ‹‰éºµ',desc:'æŸšå­é¹½å‘³ (åŸå®¿/å…­æœ¬æœ¨)',link:'AFURI Harajuku',img:'afuri-ramen.jpg'}, {name:'HARBS',desc:'æ°´æœåƒå±¤è›‹ç³•',link:'HARBS Lumine Est',img:'harbs-fruit-crepe.jpg'}, {name:'ç‰›å¡æ»‹æœ¬æ‘',desc:'ç‚¸ç‰›æ’ (æ¾€è°·/æ–°å®¿)',link:'Gyukatsu Motomura',img:''}, {name:'å…­å˜èˆ',desc:'æ¿ƒåšæ²¾éºµ (æ±äº¬ä¸€ç•ªè¡—)',link:'Rokurinsha',img:''}, {name:'Shake Shack',desc:'æ˜æ²»ç¥å®®å¤–è‹‘åº— (çµ•ç¾)',link:'Shake Shack Gaien',img:''}],
            Kamakura: [{name:'Bills',desc:'ä¸–ç•Œç¬¬ä¸€æ—©é¤ (ä¸ƒé‡Œæ¿±)',link:'Bills Shichirigahama',img:''}, {name:'Pacific Drive-In',desc:'æµ·æ™¯å’–å•¡å»³',link:'Pacific Drive-In',img:''}, {name:'Caraway',desc:'æ’éšŠå’–å“©ååº—',link:'Caraway Curry',img:''}, {name:'Yoridocoro',desc:'æ±Ÿä¹‹é›»çª—æ™¯å®šé£Ÿ',link:'Yoridocoro',img:''}, {name:'è±å³¶å±‹',desc:'é´¿å­é¤…ä¹¾æœ¬åº—',link:'Toshimaya Honten',img:''}],
            Fuji: [{name:'Houtou Fudou',desc:'ä¸å‹•èŒ¶å±‹ (æ±æˆ€è·¯åº—)',link:'Houtou Fudou Higashikoiji',img:''}, {name:'Fuji Tempura Idaten',desc:'å¯Œå£«å¤©å©¦ç¾…',link:'Fuji Tempura Idaten',img:''}, {name:'Lake Bake',desc:'æ¹–ç•”éºµåŒ… (å¤§çŸ³å…¬åœ’æ—)',link:'Lake Bake',img:''}, {name:'Sanrokuen',desc:'å±±éº“åœ’ (åœçˆè£ç‡’çƒ¤)',link:'Sanrokuen',img:''}, {name:'7-11 æ²³å£æ¹–',desc:'ä¾¿åˆ©å•†åº—æ™¯è§€åº—',link:'Lawson Kawaguchiko Station',img:''}]
        };
        const defaultPhoto = {
            Tokyo: [{name:'SHIBUYA SKY',desc:'é«˜ç©ºå±•æœ›å° (éœ€é ç´„)',link:'SHIBUYA SKY',img:''}, {name:'æ±äº¬éµå¡”',desc:'èŠå…¬åœ’/åœ°ä¸‹åœè»Šå ´è¦–è§’',link:'Tokyo Tower Shiba Park',img:''}, {name:'è±ªå¾·å¯º',desc:'æ‹›è²¡è²“ç™¼æºåœ°',link:'Gotokuji Temple',img:''}, {name:'TeamLab Planets',desc:'è±æ´²æ²‰æµ¸å¼è—è¡“',link:'teamLab Planets TOKYO',img:''}, {name:'æ·ºè‰é›·é–€',desc:'ç¶“å…¸è§€å…‰åœ°æ¨™',link:'Kaminarimon',img:''}],
            Kamakura: [{name:'éŒå€‰é«˜æ ¡å‰',desc:'çŒç±ƒé«˜æ‰‹å¹³äº¤é“',link:'Kamakura Kokomae Station',img:''}, {name:'é•·è°·å¯º',desc:'çœºæœ›æ¹˜å—æµ·å²¸',link:'Hasedera Kamakura',img:''}, {name:'é«˜å¾·é™¢',desc:'éŒå€‰å¤§ä½›',link:'Kotoku-in',img:''}, {name:'å ±åœ‹å¯º',desc:'å¤¢å¹»ç«¹æ—',link:'Hokokuji Temple',img:''}, {name:'ä¸ƒé‡Œæ¿±æµ·å²¸',desc:'å¤•é™½èˆ‡æ±Ÿä¹‹å³¶',link:'Shichirigahama Beach',img:''}],
            Fuji: [{name:'æ–°å€‰å±±æ·ºé–“å…¬åœ’',desc:'äº”é‡å¡” + å¯Œå£«å±±',link:'Arakurayama Sengen Park',img:''}, {name:'ç¾…æ£®æ²³å£æ¹–ç«™å‰',desc:'ç¶“å…¸ä¾¿åˆ©å•†åº—æ™¯',link:'Lawson Kawaguchiko Station',img:''}, {name:'å¤§çŸ³å…¬åœ’',desc:'æ²³å£æ¹–èŠ±æµ·',link:'Oishi Park',img:''}, {name:'æœ¬ç”ºå•†åº—è¡—',desc:'æ˜­å’Œå¾©å¤è¡—é“',link:'Honcho Street Fujiyoshida',img:''}, {name:'å±±ä¸­æ¹–å¹³é‡ä¹‹æ¿±',desc:'é€†å¯Œå£«çµ•æ™¯',link:'Hirano no Hama',img:''}]
        };

        const commonItems = ['è­·ç…§', 'æ—¥å¹£', 'SIMå¡', 'ä¿¡ç”¨å¡', 'å……é›»å™¨', 'å¸¸å‚™è—¥', 'è½‰æ¥é ­', 'ç‰™åˆ·ç‰™è†'];
        const defaultUsers = [
            {id:1,name:'å‰ä¼Š',bg:'#FFD1DC',icon:'ğŸ¹',list:[...commonItems, 'é§•ç…§/æ—¥æ–‡è­¯æœ¬'].map(t=>({text:t,checked:false})),flightOutCode:'TR 898',flightOutDep:'06:40',flightOutArr:'10:40',flightInCode:'BR197',flightInDep:'20:40',flightInArr:'23:20'},
            {id:2,name:'å°å…«',bg:'#A2D2FF',icon:'ğŸ±',list:[...commonItems].map(t=>({text:t,checked:false})),flightOutCode:'TR 898',flightOutDep:'06:40',flightOutArr:'10:40',flightInCode:'BR197',flightInDep:'20:40',flightInArr:'23:20'},
            {id:3,name:'å…”å…”',bg:'#FFF5BA',icon:'ğŸ°',list:[...commonItems].map(t=>({text:t,checked:false})),flightOutCode:'TR 898',flightOutDep:'06:40',flightOutArr:'10:40',flightInCode:'BR197',flightInDep:'20:40',flightInArr:'23:20'},
            {id:4,name:'å°æ¡ƒ',bg:'#FFB7B2',icon:'ğŸ‘',list:[...commonItems].map(t=>({text:t,checked:false})),flightOutCode:'TR 898',flightOutDep:'06:40',flightOutArr:'10:40',flightInCode:'BR197',flightInDep:'20:40',flightInArr:'23:20'}
        ];
        
        const drivePlan = [
            { day: 2, stops: [{name: 'ä¸å‹•èŒ¶å±‹ (æ±æˆ€è·¯)', note: 'ç‰¹è‰²å»ºç¯‰åˆé¤', location: 'Houtou Fudou Higashikoiji', parking: 'Houtou Fudou Parking'},{name: 'å¤§çŸ³å…¬åœ’', note: 'æ²³å£æ¹–ç•”æ•£æ­¥', location: 'Oishi Park', parking: 'Oishi Park Parking'},{name: 'Megu Fuji', note: 'é£¯åº— Check-in', location: 'Megu Fuji 2021', parking: 'Megu Fuji Parking'}] },
            { day: 3, stops: [{name: 'å¹³é‡ä¹‹æ¿±', note: 'è»Šæ‹é€†å¯Œå£«', location: 'Hirano no Hama', parking: 'Hirano no Hama Parking'},{name: 'å¿é‡å…«æµ·', note: 'è§€å…‰åæ‰€', location: 'Oshino Hakkai', parking: 'Oshino Hakkai Parking'},{name: 'Ogino è¶…å¸‚', note: 'æ¡è²·æ™šé¤', location: 'Ogino Kawaguchiko', parking: 'Ogino Kawaguchiko'}] },
            { day: 4, stops: [{name: 'æ–°å€‰å±±æ·ºé–“å…¬åœ’', note: 'æ—©èµ·çˆ¬å±±', location: 'Arakurayama Sengen Park', parking: 'Arakurayama Sengen Park Parking'},{name: 'æ–°å®¿', note: 'é‚„è»Š', location: 'Toyota Rent a Car Shinjuku', parking: ''}] }
        ];

        // --- State ---
        const itineraryData = ref(defaultItinerary);
        const users = ref(defaultUsers);
        const expenses = ref([]);
        const shoppingList = ref(defaultShopping);
        const foodList = ref(defaultFood);
        const photoSpots = ref(defaultPhoto);
        const daysUntilTrip = ref(0);
        
        const homeBtnPos = ref({x: window.innerWidth - 80, y: window.innerHeight - 150});
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        
        const showModal = ref(false);
        const showCommonModal = ref(false);
        const showExpenseModal = ref(false);
        const showSyncModal = ref(false);
        const showUserModal = ref(false);
        const showLightbox = ref(false);
        
        const isEditing = ref(false);
        const editForm = ref({});
        const newCommon = ref({text1:'',text2:'',text3:''});
        const newExpense = ref({name:'',amount:'',currency:'JPY',category:'é£Ÿ'});
        const commonType = ref('');
        const editIndex = ref(-1);
        const editingUser = ref({});
        const currentZoomImg = ref('');
        
        const moneyTab = ref('record');
        const moneyMode = ref('select');
        const currentUserId = ref(1);
        const expenseType = ref('personal');
        const prepTab = ref('personal');
        const prepMode = ref('select');
        const prepUser = ref(1);
        const hotelTab = ref('stay');
        const flightMode = ref('select');
        const currentFlightUser = ref(1);
        const foodLoc = ref('Tokyo');
        const shopCat = ref('wish');
        const photoArea = ref('Tokyo');
        
        const tokyoWeather = ref({temp:'--',icon:'â˜ï¸'});
        const kamakuraWeather = ref({temp:'--',icon:'â˜ï¸'});
        const fujiWeather = ref({temp:'--',icon:'â˜ï¸'});
        const exchangeRate = ref(0.215);
        
        const tripDays = [{week:'Day 1',title:'3/27'},{week:'Day 2',title:'3/28'},{week:'Day 3',title:'3/29'},{week:'Day 4',title:'3/30'},{week:'Day 5',title:'3/31'},{week:'Day 6',title:'4/01'},{week:'Day 7',title:'4/02'},{week:'Day 8',title:'4/03'}];
        const apps = [
            {id:1,name:'è¡Œç¨‹è¡¨',icon:'fa-solid fa-map-location-dot',bgClass:'bg-pink-400',view:'itinerary'},
            {id:2,name:'å°è²¡åº«',icon:'fa-solid fa-sack-dollar',bgClass:'bg-yellow-400',view:'money'},
            {id:3,name:'ä½å®¿æ©Ÿç¥¨',icon:'fa-solid fa-plane-arrival',bgClass:'bg-indigo-400',view:'hotel'},
            {id:4,name:'è¡Œå‰æº–å‚™',icon:'fa-solid fa-suitcase-rolling',bgClass:'bg-blue-400',view:'prep'},
            {id:5,name:'åƒåƒå–å–',icon:'fa-solid fa-utensils',bgClass:'bg-orange-400',view:'food'},
            {id:6,name:'å¿«æ¨‚Shop',icon:'fa-solid fa-bag-shopping',bgClass:'bg-purple-400',view:'shopping'},
            {id:7,name:'å¤©æ°£é€±å ±',icon:'fa-solid fa-cloud-sun',bgClass:'bg-sky-400',view:'weather'},
            {id:8,name:'ç¶²ç¾æ‰“å¡',icon:'fa-solid fa-camera',bgClass:'bg-rose-400',view:'photo'},
            {id:9,name:'å³æ™‚æ•‘å‘½',icon:'fa-solid fa-language',bgClass:'bg-emerald-400',view:'japanese'}
        ];
        const japanesePhrases = ref([{jp:'ã™ã¿ã¾ã›ã‚“',tw:'ä¸å¥½æ„æ€'},{jp:'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™',tw:'æˆ‘è¦é€™å€‹'},{jp:'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™',tw:'æˆ‘è¦çµå¸³'},{jp:'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹',tw:'å»æ‰€åœ¨å“ªè£¡'},{jp:'è¢‹ã¯ã„ã‚Šã¾ã›ã‚“',tw:'ä¸ç”¨è¢‹å­'}]);

        // --- Helpers ---
        const getCurrentList = () => { if(currentView.value==='food') return foodList.value[foodLoc.value]||[]; if(currentView.value==='shopping') return shoppingList.value[shopCat.value]||[]; if(currentView.value==='photo') return photoSpots.value[photoArea.value]||[]; return []; };
        const getUserById = (id) => users.value.find(u => u.id === id) || users.value[0];
        const getProgress = (uid) => { const l=getUserById(uid).list||[]; return l.length ? (l.filter(i=>i.checked).length/l.length)*100 : 0; };
        const getMapLink = (k) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}`;
        const getClothingAdvice = (t) => {
            const temp = parseFloat(t);
            if(isNaN(temp)) return 'è¼‰å…¥ä¸­...';
            if(temp < 10) return 'ç™¼ç†±è¡£ + æ¯›è¡£ + ç¾½çµ¨/å¤§è¡£ (åœå·¾å¿…å‚™)';
            if(temp < 15) return 'æ´‹è”¥å¼ç©¿æ­ï¼šç™¼ç†±è¡£ + è¡›è¡£ + é¢¨è¡£';
            if(temp < 20) return 'è–„é•·è¢– + é‡ç¹”å¤–å¥— + è¼•ä¾¿å¤–å¥—';
            return 'èˆ’é©çŸ­è¢– + è–„è¥¯è¡« (æ—©æ™šæº«å·®å¤§)';
        };
        const getPageTitle = (v) => ({'itinerary':'è¡Œç¨‹è¡¨','money':'å°è²¡åº«','menu':'åŠŸèƒ½é¸å–®','prep':'è¡Œå‰æº–å‚™','weather':'å¤©æ°£é€±å ±','food':'åƒåƒå–å–','shopping':'å¿«æ¨‚Shop','photo':'ç¶²ç¾æ‰“å¡','hotel':'ä½å®¿èˆ‡æ©Ÿç¥¨','japanese':'å³æ™‚æ•‘å‘½'}[v] || v);
        const getIconByCategory = (c) => ({'Flight':'fa-plane','Sightseeing':'fa-camera','Food':'fa-utensils','Shopping':'fa-bag-shopping','Transport':'fa-train','Hotel':'fa-bed'}[c]||'fa-star');
        const getDrivePlanForDay = (idx) => { const p = drivePlan.find(d => d.day === idx); return p ? p.stops : []; };
        const currentItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
        const currentPrepList = computed(() => getUserById(prepUser.value).list || []);
        const personalExpenses = computed(() => expenses.value.filter(e => e.user === currentUserId.value && e.type === 'personal'));
        const groupExpenses = computed(() => expenses.value.filter(e => e.type === 'group'));
        const userPersonalTotal = computed(() => personalExpenses.value.reduce((s,e) => s + Number(e.amount), 0));
        const settlements = computed(() => {
            const bal = {}; users.value.forEach(u=>bal[u.id]=0);
            groupExpenses.value.forEach(e=>{ const amt=Number(e.amount); if(bal[e.user]!==undefined) bal[e.user]+=amt; });
            const avg = Object.values(bal).reduce((a,b)=>a+b,0)/users.value.length;
            const net = {}; users.value.forEach(u=>net[u.id]=bal[u.id]-avg);
            const res=[]; const debt=[]; const cred=[];
            for(let id in net) { if(net[id]<-1) debt.push({u:id,a:-net[id]}); else if(net[id]>1) cred.push({u:id,a:net[id]}); }
            let i=0,j=0; while(i<debt.length && j<cred.length){ let amt = Math.min(debt[i].a, cred[j].a); if(amt>0) res.push({from:debt[i].u, to:cred[j].u, amount:Math.round(amt)}); debt[i].a-=amt; cred[j].a-=amt; if(debt[i].a<1) i++; if(cred[j].a<1) j++; } return res;
        });

        const enterSite = () => { isWelcomeClosed.value = true; };
        const openAddModal = () => { isEditing.value=false; editForm.value={category:'Sightseeing'}; showModal.value=true; };
        const editItem = (item,idx) => { isEditing.value=true; editIndex.value=idx; editForm.value={...item}; showModal.value=true; };
        const saveItem = () => { if(!itineraryData.value[selectedDayIndex.value]) itineraryData.value[selectedDayIndex.value]=[]; const target = itineraryData.value[selectedDayIndex.value]; if(isEditing.value) Object.assign(target[editIndex.value], editForm.value); else target.push({...editForm.value, id:Date.now()}); showModal.value=false; };
        const deleteItem = (idx) => { if(confirm('ç¢ºå®šåˆªé™¤?')) itineraryData.value[selectedDayIndex.value].splice(idx,1); };
        const openAddCommonModal = (t) => { commonType.value=t; isEditing.value=false; newCommon.value={text1:'',text2:'',text3:''}; showCommonModal.value=true; };
        const editCommonItem = (item,idx) => { commonType.value=currentView.value==='japanese'?'jp':currentView.value; isEditing.value=true; editIndex.value=idx; newCommon.value={text1:item.name||item.jp, text2:item.desc||item.tw, text3:item.img}; showCommonModal.value=true; };
        const saveCommonItem = () => { const list = commonType.value==='jp' ? japanesePhrases.value : getCurrentList(); const item = commonType.value==='jp' ? {jp:newCommon.value.text1, tw:newCommon.value.text2} : {name:newCommon.value.text1, desc:newCommon.value.text2, img:newCommon.value.text3, link:newCommon.value.text1}; if(isEditing.value) Object.assign(list[editIndex.value], item); else list.push(item); showCommonModal.value=false; };
        const deleteCommonItem = (idx) => { if(confirm('ç¢ºå®šåˆªé™¤?')) getCurrentList().splice(idx,1); };
        const processCommonImageUpload = (e) => { const r = new FileReader(); r.onload=ev=>newCommon.value.text3=ev.target.result; r.readAsDataURL(e.target.files[0]); };
        const openExpenseModal = (t) => { expenseType.value=t; newExpense.value={amount:'',currency:'JPY',category:'é£Ÿ'}; showExpenseModal.value=true; };
        const addExpense = () => { expenses.value.push({...newExpense.value, id:Date.now(), user:currentUserId.value, type:expenseType.value, date:new Date().toLocaleDateString()}); showExpenseModal.value=false; };
        const deleteExpense = (id) => { expenses.value = expenses.value.filter(e=>e.id!==id); };
        const selectMoneyUser = (id) => { currentUserId.value=id; moneyMode.value='list'; };
        const selectPrepUser = (id) => { prepUser.value=id; prepMode.value='list'; };
        const addPrepItem = () => { const t=prompt('é …ç›®åç¨±'); if(t) getUserById(prepUser.value).list.push({text:t,checked:false}); };
        const openUserEdit = (user) => { editingUser.value = {...user}; showUserModal.value = true; };
        const saveUserEdit = () => { const idx = users.value.findIndex(u => u.id === editingUser.value.id); if(idx !== -1) users.value[idx] = {...editingUser.value}; showUserModal.value = false; };
        const processAvatarUpload = (e) => { const r = new FileReader(); r.onload = (ev) => { editingUser.value.avatar = ev.target.result; }; r.readAsDataURL(e.target.files[0]); };
        const triggerAvatarUpload = () => { document.querySelector('input[type=file]').click(); };
        const editFlightField = (field) => { const u = getUserById(currentFlightUser.value); const keyMap = {'out_code':'flightOutCode','out_dep':'flightOutDep','out_arr':'flightOutArr','in_code':'flightInCode','in_dep':'flightInDep','in_arr':'flightInArr'}; const val = prompt('è¼¸å…¥è³‡è¨Š', u[keyMap[field]]||''); if(val!==null) u[keyMap[field]] = val; };
        const openImage = (src) => { currentZoomImg.value = getImg(src); showLightbox.value = true; };
        const startDrag = (e) => { const touch = e.touches ? e.touches[0] : e; const offX = touch.clientX - homeBtnPos.value.x; const offY = touch.clientY - homeBtnPos.value.y; const move = ev => { const t = ev.touches?ev.touches[0]:ev; homeBtnPos.value = {x:t.clientX-offX, y:t.clientY-offY}; }; const stop = () => { document.removeEventListener('touchmove',move); document.removeEventListener('mousemove',move); }; document.addEventListener('touchmove',move); document.addEventListener('mousemove',move); document.addEventListener('touchend',stop); document.addEventListener('mouseup',stop); };
        const speak = (t) => { const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; speechSynthesis.speak(u); };
        const openCamera = () => { alert('ğŸ“· ç›¸æ©ŸåŠŸèƒ½ (éœ€HTTPSç’°å¢ƒ)\næ­¤ç‚ºæ¼”ç¤ºï¼šé»æ“Šå¾Œå¯å‘¼å«ç³»çµ±ç›¸æ©Ÿã€‚'); document.querySelector('input[type=file]').click(); };
        const saveAsHtml = () => { const data = { itinerary: itineraryData.value, users: users.value, expenses: expenses.value, shop: shoppingList.value, food: foodList.value, photo: photoSpots.value }; let html = document.documentElement.outerHTML; const inject = `const injectedData = ${JSON.stringify(data)};`; html = html.replace('// --- ä½å®¿è³‡æ–™ä¿®æ­£', inject + '\n // --- ä½å®¿è³‡æ–™ä¿®æ­£'); const blob = new Blob([html], {type:'text/html'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = '2026_Kanto_Trip_V10.55.html'; a.click(); };
        const resetItinerary = () => { if(confirm('âš ï¸ ç¢ºå®šé‡ç½®ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰è‡ªè¨‚è³‡æ–™ä¸¦æ¢å¾©é è¨­å€¼ã€‚')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } };
        const fetchWeather = async () => {
            try {
                const url = 'https://api.open-meteo.com/v1/forecast?latitude=35.6895,35.3192,35.4854&longitude=139.6917,139.5467,138.8037&current_weather=true';
                const res = await fetch(url);
                const data = await res.json();
                if(data && data.length >= 3) {
                    tokyoWeather.value = { temp: data[0].current_weather.temperature, icon: 'â˜ï¸' };
                    kamakuraWeather.value = { temp: data[1].current_weather.temperature, icon: 'ğŸŒ¤ï¸' };
                    fujiWeather.value = { temp: data[2].current_weather.temperature, icon: 'ğŸ—»' };
                }
            } catch(e) { console.log('Weather fetch failed, using fallback'); }
        };

        onMounted(() => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                try {
                    const d = JSON.parse(saved);
                    if(d.itinerary) itineraryData.value = d.itinerary;
                    if(d.users) users.value = d.users;
                    if(d.expenses) expenses.value = d.expenses;
                    if(d.shop) shoppingList.value = d.shop;
                    if(d.food) foodList.value = d.food;
                    if(d.photo) photoSpots.value = d.photo;
                } catch(e) { console.error(e); }
            }
            daysUntilTrip.value = Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24));
            fetchWeather();
            setTimeout(() => {
                const l = document.getElementById('loading-screen');
                if(l) { l.style.opacity = '0'; setTimeout(()=>l.style.display='none',500); }
            }, 800);
        });

        watch([itineraryData, users, expenses, shoppingList, foodList, photoSpots], () => {
            const data = { itinerary: itineraryData.value, users: users.value, expenses: expenses.value, shop: shoppingList.value, food: foodList.value, photo: photoSpots.value };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }, {deep: true});

        return {
            currentView, isWelcomeClosed, enterSite, apps, tripDays, selectedDayIndex, itineraryMode, currentItinerary,
            getIconByCategory, getMapLink, getDrivePlanForDay, hotels, homeBtnPos, startDrag, getPageTitle, showSyncModal,
            daysUntilTrip, getClothingAdvice, showGoogleSearch,
            showModal, isEditing, editForm, openAddModal, editItem, saveItem, deleteItem,
            saveAsHtml, resetItinerary,
            users, expenses, shoppingList, foodList, photoSpots, japanesePhrases,
            moneyTab, moneyMode, hotelTab, flightMode, currentUserId, currentFlightUser, expenseType,
            prepTab, prepMode, prepUser, currentPrepList, selectMoneyUser, selectPrepUser, addPrepItem, getProgress,
            foodLoc, shopCat, photoArea, getCurrentList,
            tokyoWeather, kamakuraWeather, fujiWeather, speak,
            showLightbox, currentZoomImg, openImage, handleImgError, getImg,
            showUserModal, editingUser, openUserEdit, saveUserEdit, triggerAvatarUpload, processAvatarUpload,
            showCommonModal, newCommon, commonType, openAddCommonModal, editCommonItem, saveCommonItem, deleteCommonItem, processCommonImageUpload,
            showExpenseModal, newExpense, addExpense, deleteExpense, exchangeRate, editFlightField,
            openCamera, userPersonalTotal, settlements, personalExpenses, groupExpenses
        };
    }
}).mount('#app');
</script>
</body>
</html>
