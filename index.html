<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (V60.0 Ultimate)</title>

<script>
    window.tailwind = {
        config: {
            theme: {
                extend: {
                    colors: {
                        'chii-bg': '#FFF6F8', // å¥¶æ²¹ç²‰åº•
                        'chii-pink': '#FFD1DC',
                        'chii-blue': '#A2D2FF',
                        'chii-green': '#D0F0C0', // è–„ç¶ 
                        'chii-text': '#5D4037'
                    },
                    fontFamily: { sans: ['Zen Maru Gothic', 'sans-serif'] },
                    animation: {
                        'wiggle': 'wiggle 3s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'spin-slow': 'spin 8s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pop': 'pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        wiggle: { '0%,100%': { transform: 'rotate(-3deg)' }, '50%': { transform: 'rotate(3deg)' } },
                        float: { '0%,100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeIn: { from: { opacity: 0, transform: 'translateY(10px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        pop: { '0%': { transform: 'scale(0)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    }
</script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>

<style>
    /* V60 æ ¸å¿ƒæ¨£å¼ä¿®å¾© */
    html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        font-family: "Zen Maru Gothic", sans-serif;
        color: #5D4037;
        overflow: hidden; 
        -webkit-tap-highlight-color: transparent;
        background-color: #FFF6F8; /* å¥¶æ²¹ç²‰åº• */
        overscroll-behavior: none;
    }

    /* èƒŒæ™¯è£é£¾ */
    #fixed-bg { 
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; 
        background-color: #FFF6F8; 
        background-image: 
            radial-gradient(#FFD1DC 15%, transparent 16%), 
            radial-gradient(#D0F0C0 10%, transparent 11%),
            radial-gradient(#A2D2FF 10%, transparent 11%);
        background-size: 60px 60px, 120px 120px, 90px 90px;
        background-position: 0 0, 40px 40px, 20px 80px;
        opacity: 0.6;
    }

    #app-content {
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        padding-bottom: 180px; 
        padding-top: env(safe-area-inset-top);
    }
    #app-content.view-shopping { padding-bottom: 250px !important; }

    /* é€šç”¨å¡ç‰‡æ¨£å¼ */
    .card { 
        background: rgba(255,255,255,0.95); 
        border-radius: 24px; 
        box-shadow: 0 8px 30px rgba(255,105,180,0.12); 
        border: 2px solid rgba(255,255,255,0.8); 
        margin-bottom: 16px; 
        position: relative; 
        backdrop-filter: blur(10px); 
        transition: all 0.2s ease; 
        overflow: hidden; 
        transform: translateZ(0); 
    }
    .card:active { transform: scale(0.98); }

    /* ç·Šæ€¥æ•‘åŠ©åœ°åœ–å°ˆç”¨æ¨£å¼ (æ¼«ç•«é¢¨æ ¼) */
    .comic-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto auto;
        gap: 12px;
        padding: 10px;
    }
    .comic-box {
        background: white;
        border-radius: 20px;
        border: 3px solid #5D4037;
        padding: 10px;
        position: relative;
        overflow: hidden;
        min-height: 160px;
        box-shadow: 4px 4px 0px rgba(93, 64, 55, 0.1);
        display: flex;
        flex-col: column;
    }
    .comic-box.full-width { grid-column: span 2; }
    .comic-title {
        font-weight: 900;
        font-size: 14px;
        margin-bottom: 5px;
        z-index: 10;
        position: relative;
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        color: white;
    }
    .comic-bubble {
        background: white;
        border: 2px solid #5D4037;
        border-radius: 12px;
        padding: 6px;
        font-size: 10px;
        font-weight: bold;
        position: relative;
        z-index: 10;
        margin-bottom: 4px;
        box-shadow: 2px 2px 0 #eee;
    }
    .comic-bubble::after {
        content: ''; position: absolute; bottom: -6px; left: 10px;
        border-width: 6px 6px 0; border-style: solid;
        border-color: #5D4037 transparent; display: block; width: 0;
    }
    .comic-info {
        background: rgba(255,255,255,0.9);
        border-radius: 8px;
        padding: 6px;
        font-size: 10px;
        font-weight: bold;
        color: #555;
        margin-top: auto;
        z-index: 10;
        border: 1px dashed #ccc;
    }
    .comic-bg-icon {
        position: absolute;
        bottom: -10px;
        right: -10px;
        font-size: 80px;
        opacity: 0.1;
        z-index: 0;
    }

    /* V60 Gamification CSS */
    .hp-bar-container { width: 100%; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 5px; }
    .hp-bar-fill { height: 100%; transition: width 0.5s ease, background-color 0.5s ease; }
    .hp-low { background-color: #ef4444; } .hp-med { background-color: #f59e0b; } .hp-high { background-color: #10b981; }

    .packing-suitcase { 
        width: 80px; height: 60px; background: #3b82f6; border-radius: 12px; 
        position: relative; overflow: hidden; border: 3px solid #1e40af; 
        display: flex; align-items: center; justify-content: center;
        color: white; font-weight: 900; box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
    }
    .packing-fill { 
        position: absolute; bottom: 0; left: 0; right: 0; 
        background: #60a5fa; transition: height 0.5s ease; z-index: 0; 
    }

    /* å…¶ä»–è¼”åŠ©æ¨£å¼ */
    [v-cloak] { display: none !important; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .fab-home { position: fixed; bottom: calc(25px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); width: 68px; height: 68px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; z-index: 90; border: 4px solid white; box-shadow: 0 10px 25px rgba(255,105,180,0.5); background: linear-gradient(135deg,#FF9EAC,#FFD1DC); cursor: pointer; }
    .fab-main { position: fixed; bottom: calc(100px + env(safe-area-inset-bottom)); right: 20px; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; z-index: 80; border: 3px solid white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); transition: all 0.3s; }
    .fab-search { position: fixed; bottom: calc(30px + env(safe-area-inset-bottom)); left: 20px; width: 54px; height: 54px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #5D4037; z-index: 90; border: 2px solid white; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }

    /* åœ–ç‰‡å®¹å™¨å„ªåŒ– */
    .img-container { width: 100%; padding-bottom: 75%; position: relative; overflow: hidden; background: #eee; }
    .img-container img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    .img-fallback { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; }

    /* é›²ç«¯ç‹€æ…‹ç‡ˆ */
    .cloud-status { position: fixed; top: calc(15px + env(safe-area-inset-top)); left: 15px; font-size: 10px; font-weight: bold; color: #555; display: flex; align-items: center; gap: 4px; z-index: 300; background: rgba(255,255,255,0.8); padding: 4px 10px; border-radius: 20px; backdrop-filter: blur(4px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
</style>
</head>
<body>

<div id="fixed-bg"></div>
<div id="sakura-container"></div>

<div id="app" v-cloak class="h-full flex flex-col">

    <div v-if="!isWelcomeClosed" class="welcome-screen h-full flex flex-col items-center justify-between relative overflow-hidden">
        <div class="absolute inset-0 z-0"><img :src="getImg('welcome.jpg')" class="w-full h-full object-cover opacity-80" @error="handleImgError"></div>
        <div class="absolute top-6 right-6 z-50 pt-[env(safe-area-inset-top)]">
            <button @click.stop="handleAuthClick" :class="['flex items-center gap-2 px-4 py-2 rounded-full backdrop-blur-md border border-white/50 shadow-lg font-bold text-sm transition', isLoggedIn ? 'bg-green-500/80 text-white' : 'bg-white/40 text-gray-800']">
                <i :class="isLoggedIn ? 'fa-solid fa-cloud' : 'fa-solid fa-cloud-arrow-up'"></i> {{ isLoggedIn ? 'å·²é€£ç·š' : 'é›²ç«¯åŒæ­¥' }}
            </button>
        </div>
        <div class="relative z-10 mt-32 text-center px-6">
            <div class="inline-block bg-white/40 backdrop-blur-md px-6 py-2 rounded-full text-white text-xs font-black tracking-[0.2em] border border-white/50 mb-6 animate-float shadow-lg">V60.0 ULTIMATE</div>
            <h1 class="text-6xl font-black text-white drop-shadow-lg tracking-widest mb-2 font-sans" style="text-shadow: 0 4px 10px rgba(255,105,180,0.5);">é—œæ±ä¹‹æ—…</h1>
            <p class="text-2xl text-white/90 font-bold tracking-widest drop-shadow-md">2026.03.27</p>
        </div>
        <div class="relative z-10 mb-20 w-full px-10 pb-[env(safe-area-inset-bottom)] space-y-4">
            <button @click="enterSite" class="w-full bg-white/90 text-pink-500 font-black py-4 rounded-full shadow-2xl backdrop-blur-xl text-xl flex items-center justify-center gap-3 border border-white animate-pulse-fast">
                <span class="animate-spin-slow">ğŸŒ¸</span> æ—…ä¼´ç™»å…¥
            </button>
            <button @click="enterAsGuest" class="w-full bg-gray-800/60 text-white font-bold py-3 rounded-full backdrop-blur-md text-sm border border-white/30 hover:bg-gray-800/80 transition">
                <i class="fa-solid fa-user-secret"></i> è¨ªå®¢åƒè§€
            </button>
        </div>
    </div>
    <div v-if="isWelcomeClosed" class="h-full flex flex-col relative">
        
        <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-[60px] bg-[#FFF6F8]/90 backdrop-blur-xl z-30 flex items-center justify-between px-4 border-b border-white/50 shadow-sm pt-[env(safe-area-inset-top)] box-content transition-all">
            <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow-md border border-white active:scale-95 transition"><i class="fa-solid fa-chevron-left"></i></button>
            <h1 class="font-black text-gray-700 text-lg flex items-center gap-2 absolute left-1/2 transform -translate-x-1/2"><i class="fa-solid fa-sakura text-pink-300"></i> {{getPageTitle(currentView)}}</h1>
            <div class="w-10"></div>
        </div>
        <div v-if="currentView !== 'menu'" class="h-[60px] pt-[env(safe-area-inset-top)] box-content shrink-0"></div>

        <div class="cloud-status" @click="showDiagnostic">
            <div class="status-dot" :class="statusColor"></div>
            <span class="ml-1">{{ statusText }}</span>
        </div>
        <div class="fixed top-[calc(12px+env(safe-area-inset-top))] right-12 z-30 flex gap-1 pointer-events-none">
             <div v-for="u in users" :key="u.id" :class="['w-8 h-8 rounded-full border-2 bg-white overflow-hidden transition-all', isUserOnline(u.id)?'border-green-400 -translate-y-1 shadow-md':'border-white opacity-50']">
                 <img v-if="u.avatar" :src="u.avatar" class="w-full h-full object-cover">
                 <div v-else class="w-full h-full flex items-center justify-center text-xs">{{u.icon}}</div>
             </div>
        </div>

        <div id="app-content" class="flex-1" :class="{'view-shopping': currentView === 'shopping'}">

            <div v-if="currentView==='menu'" class="p-6 pt-12 animate-fade-in pb-32">
                <div class="absolute top-6 left-6 pt-[env(safe-area-inset-top)] flex items-center gap-2 cursor-pointer" @click="currentView='money'">
                    <div class="w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center text-2xl border-2 border-pink-100 animate-pop">
                        {{ getBudgetMood() }}
                    </div>
                    <div class="text-[10px] font-bold text-gray-400 bg-white/60 px-2 py-1 rounded-full backdrop-blur-sm">é ç®—ç›£æ§</div>
                </div>

                <h2 class="text-2xl font-black text-gray-700 mb-8 text-center pt-[env(safe-area-inset-top)] whitespace-pre-line leading-relaxed">{{ getGreeting() }}</h2>
                
                <div class="mb-8 bg-white/70 backdrop-blur-xl border border-white rounded-[32px] p-6 shadow-xl relative overflow-hidden group" @click="currentView='itinerary'">
                      <div class="flex items-start gap-4 relative z-10">
                          <div class="bg-gradient-to-br from-yellow-200 to-yellow-400 w-12 h-12 rounded-2xl flex items-center justify-center text-white text-xl shrink-0 shadow-lg"><i class="fa-solid fa-calendar-days"></i></div>
                          <div class="flex-1">
                              <div class="font-black text-gray-800 text-lg mb-1">å€’æ•¸ {{daysUntilTrip}} å¤©</div>
                              <div class="text-xs text-gray-500 font-bold leading-relaxed space-y-1">
                                 <div v-for="alert in smartReminders" class="text-pink-500 flex items-start gap-1 font-black"><i class="fa-solid fa-circle-exclamation mt-0.5"></i> {{alert}}</div>
                                 <div v-if="smartReminders.length===0" class="text-gray-400">ç›®å‰æ²’æœ‰ç·Šæ€¥äº‹é …</div>
                              </div>
                          </div>
                      </div>
                </div>

                <div class="grid grid-cols-3 gap-x-4 gap-y-8 px-2">
                    <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition duration-300 group" @click="currentView=app.view">
                        <div class="w-[72px] h-[72px] rounded-[28px] flex items-center justify-center text-2xl text-white shadow-lg border-[4px] border-white relative overflow-hidden" :class="app.bgClass">
                            <i :class="app.icon"></i>
                        </div>
                        <span class="text-sm font-bold mt-3 text-gray-600 group-hover:text-pink-500 transition">{{app.name}}</span>
                    </div>
                </div>
            </div>

            <div v-if="currentView==='emergency'" class="animate-fade-in pb-20">
                <div class="sticky top-0 z-20 bg-[#FFF6F8]/95 backdrop-blur px-5 py-3 flex gap-2 justify-center shadow-sm">
                    <button @click="emergTab='map'" :class="['px-6 py-2 rounded-full font-bold text-sm transition', emergTab==='map'?'bg-red-400 text-white shadow-md':'bg-white text-gray-400']">ğŸš¨ æ•‘åŠ©åœ°åœ–</button>
                    <button @click="emergTab='trans'" :class="['px-6 py-2 rounded-full font-bold text-sm transition', emergTab==='trans'?'bg-emerald-400 text-white shadow-md':'bg-white text-gray-400']">ğŸ’¬ ç¿»è­¯è’Ÿè’»</button>
                </div>

                <div v-if="emergTab==='map'" class="p-4">
                    <div class="text-center mb-4">
                        <h2 class="text-xl font-black text-gray-700">ã¡ã„ã‹ã‚ã®æ—…éŠæ€¥é›£æ•‘åŠ©åœ°åœ– ğŸš¨</h2>
                        <p class="text-xs text-gray-500 font-bold">å®‰å¿ƒæ—…ç¨‹ âœ¿ æ±äº¬ãƒ»éŒå€‰ãƒ»å¯Œå£«å±±</p>
                    </div>
                    <div class="comic-grid">
                        <div class="comic-box border-l-[6px] border-l-blue-500">
                            <div class="comic-title bg-blue-500">è­¦å¯Ÿæ±‚åŠ© (110)</div>
                            <div class="absolute right-2 top-10 opacity-80"><img :src="getImg('chii-police.png')" class="w-16 h-16 object-contain" @error="handleImgError"></div>
                            <div class="comic-bubble">é‡åˆ°å±éšªå°±æ‰“110ï¼<br>è­¦å¯Ÿæœƒå¹«å¿™å–”ï½ï¼</div>
                            <div class="comic-info mt-auto">
                                ğŸš“ å ±è­¦å°ˆç·šï¼š110<br>
                                ğŸ“ æ±äº¬è­¦è¦–å»³<br>
                                ğŸ“ éŒå€‰è­¦å¯Ÿç½²
                            </div>
                            <i class="fa-solid fa-taxi comic-bg-icon text-blue-200"></i>
                        </div>
                        <div class="comic-box border-l-[6px] border-l-red-400">
                            <div class="comic-title bg-red-400">é†«ç™‚æ€¥æ•‘ (119)</div>
                            <div class="absolute right-2 top-10 opacity-80"><img :src="getImg('usagi-doc.png')" class="w-16 h-16 object-contain" @error="handleImgError"></div>
                            <div class="comic-bubble">å—å‚·æˆ–ç”Ÿç—…æ‰“119ï¼<br>æ•‘è­·è»Šæœƒä¾†ï½ï¼</div>
                            <div class="comic-info mt-auto">
                                ğŸš‘ æ•‘è­·å°ˆç·šï¼š119<br>
                                ğŸ¥ æ±äº¬é†«ç™‚ä¸­å¿ƒ<br>
                                ğŸ¥ å¯Œå£«å‰ç”°å¸‚ç«‹é†«é™¢
                            </div>
                            <i class="fa-solid fa-kit-medical comic-bg-icon text-red-200"></i>
                        </div>
                        <div class="comic-box border-l-[6px] border-l-green-400">
                            <div class="comic-title bg-green-400">å¤–åœ‹æ—…å®¢æ”¯æ´</div>
                            <div class="absolute right-2 top-10 opacity-80"><img :src="getImg('chii-phone.png')" class="w-16 h-16 object-contain" @error="handleImgError"></div>
                            <div class="comic-bubble">é€™æ”¯é›»è©±æœ‰ä¸­æ–‡å–”ï¼<br>éœ€è¦å¹«å¿™å¯ä»¥æ‰“ï½</div>
                            <div class="comic-info mt-auto">
                                â˜ï¸ Visitor Hotline<br>
                                ğŸ“ 050-3816-2787<br>
                                (24å°æ™‚ ä¸­/è‹±/éŸ“)
                            </div>
                            <i class="fa-solid fa-headset comic-bg-icon text-green-200"></i>
                        </div>
                        <div class="comic-box border-l-[6px] border-l-pink-400">
                            <div class="comic-title bg-pink-400">å°ç£æ—…å®¢å°ˆå€</div>
                            <div class="absolute right-2 top-10 opacity-80"><img :src="getImg('hachi-flag.png')" class="w-16 h-16 object-contain" @error="handleImgError"></div>
                            <div class="comic-bubble">å°ç£ä»£è¡¨è™•åœ¨é€™è£¡ï¼<br>è­·ç…§éºå¤±æ‰¾é€™é‚Š</div>
                            <div class="comic-info mt-auto">
                                ğŸ›ï¸ é§æ—¥ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•<br>
                                ğŸ“ æ¸¯å€ç™½é‡‘å°5-20-2<br>
                                ğŸ“ æ€¥é›£ï¼š090-6866-0101
                            </div>
                            <i class="fa-solid fa-passport comic-bg-icon text-pink-200"></i>
                        </div>
                        <div class="comic-box full-width bg-white/50 border-dashed border-gray-300 min-h-[100px] flex-row items-center justify-between">
                            <div class="text-sm font-bold text-gray-600">
                                ğŸ“± <span class="text-blue-500">110</span> (è­¦) / <span class="text-red-500">119</span> (æ•‘)<br>
                                ğŸ“ <span class="text-green-600">050-3816-2787</span> (æ”¯æ´)<br>
                                ğŸ‡¹ğŸ‡¼ <span class="text-pink-500">03-3280-7811</span> (ä»£è¡¨è™•)
                            </div>
                            <div class="w-24"><img :src="getImg('all-safe.png')" class="w-full" @error="handleImgError"></div>
                        </div>
                    </div>
                </div>

                <div v-if="emergTab==='trans'" class="p-5 space-y-3">
                     <div v-for="(p,idx) in japanesePhrases" :key="idx" class="card p-5 flex justify-between items-center cursor-pointer hover:shadow-md transition border-l-4 border-emerald-400" @click="expandCard(p)">
                         <div><div class="font-bold text-lg text-gray-800">{{p.jp}}</div><div class="text-xs text-gray-500 font-bold mt-1">{{p.zh}}</div></div>
                         <i class="fa-solid fa-expand text-gray-300"></i>
                     </div>
                     <button v-if="!isGuest" @click="openAddPhraseModal" class="fab-main bg-emerald-500 text-white"><i class="fa-solid fa-plus"></i></button>
                     <div class="fab-camera text-white bg-emerald-600" @click="handleCameraTranslate"><i class="fa-solid fa-camera"></i></div>
                </div>
            </div>

            <div v-if="currentView==='itinerary'" class="px-5 py-4 animate-fade-in">
                <div class="flex overflow-x-auto gap-3 mb-6 hide-scrollbar sticky top-0 bg-[#FFF6F8]/95 z-20 py-3 -mx-5 px-5 backdrop-blur-md">
                     <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-6 py-3 rounded-2xl text-sm font-black border-2 transition shrink-0 shadow-sm flex flex-col items-center min-w-[70px]',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400 shadow-lg scale-105':'bg-white text-gray-300 border-white']">
                        <span>{{d.week}}</span>
                        <div class="hp-bar-container w-10 mt-1">
                            <div class="hp-bar-fill" :class="getStaminaColor(i)" :style="{width: getStamina(i)+'%'}"></div>
                        </div>
                     </button>
                </div>

                <div v-if="getStamina(selectedDayIndex) < 50" class="bg-red-50 text-red-500 p-3 rounded-xl text-xs font-bold mb-4 flex items-center justify-center animate-pulse border border-red-200">
                    <span class="mr-2 text-xl">ğŸ°</span> Yha?? é«”åŠ›æ¶ˆè€—éå¤§ï¼Œæœƒæ­»æ‰å–”ï¼Ÿ (HPä½)
                </div>

                <div v-if="[2,3].includes(selectedDayIndex)" class="flex justify-center mb-6">
                    <div class="bg-white p-1 rounded-full border border-gray-200 shadow-sm flex">
                        <button @click="itineraryMode='normal'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='normal'?'bg-pink-400 text-white':'text-gray-400']">ä¸€èˆ¬</button>
                        <button @click="itineraryMode='drive'" :class="['px-4 py-1.5 rounded-full text-xs font-bold transition', itineraryMode==='drive'?'bg-green-500 text-white':'text-gray-400']"><i class="fa-solid fa-car"></i> è‡ªé§•</button>
                    </div>
                </div>

                <div class="pb-20 relative">
                    <transition-group name="list" tag="div">
                        <div v-for="(item,idx) in getCurrentItinerary()" :key="item.id || idx">
                            <div class="card p-5 border-0 shadow-sm relative group z-10 mb-4" @click="!isGuest && openEditItineraryModal(item, idx)">
                                <div class="absolute left-0 top-0 bottom-0 w-1.5" :class="itineraryMode==='drive' && [2,3].includes(selectedDayIndex)?'bg-green-400':'bg-gradient-to-b from-pink-300 to-pink-100'"></div>
                                <div class="flex gap-4 pr-8">
                                    <div class="flex flex-col items-center pt-1 min-w-[50px]">
                                        <span class="text-xs font-black text-gray-400 mb-2">{{item.hours}}</span>
                                        <div class="w-10 h-10 rounded-full text-lg flex items-center justify-center border" :class="itineraryMode==='drive' && [2,3].includes(selectedDayIndex)?'bg-green-50 text-green-500 border-green-100':'bg-pink-50 text-pink-400 border-pink-100'"><i :class="getIconByCategory(item.category)"></i></div>
                                    </div>
                                    <div class="flex-1 py-1">
                                        <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                                        <p class="text-sm text-gray-500 line-clamp-2 font-medium mb-2">{{item.note}}</p>
                                        <div class="flex gap-2 flex-wrap">
                                            <a :href="getMapLink(item.mapKeyword, item.name)" target="_blank" @click.stop class="inline-flex items-center gap-1 text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded-full font-bold border border-blue-100 hover:bg-blue-100 transition active:scale-95"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                                            <a v-if="item.name.includes('å¯Œå£«å›éŠ') && item.name.includes('éŒ¦ç³¸ç”º')" href="https://www.eki-net.com/zh-CHT/jreast-train-reservation/Top/Index" target="_blank" @click.stop class="inline-flex items-center gap-1 text-[10px] bg-red-50 text-red-500 px-2 py-1 rounded-full font-bold border border-red-100"><i class="fa-solid fa-ticket"></i> éŒ¦ç³¸ç”ºå‡ºç™¼è³¼ç¥¨</a>
                                            <a v-if="item.name.includes('SHIBUYA SKY')" href="https://www.kkday.com/zh-tw/product/133300" target="_blank" @click.stop class="inline-flex items-center gap-1 text-[10px] bg-orange-50 text-orange-500 px-2 py-1 rounded-full font-bold border border-orange-100"><i class="fa-solid fa-ticket"></i> é ç´„é»ƒæ˜ç¥¨</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </transition-group>
                    <button v-if="!isGuest" @click="openAddItineraryModal" class="w-full py-4 mt-6 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white/50 transition active:scale-95"><i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹</button>
                </div>
            </div>

            <div v-if="currentView==='prep'" class="px-5 py-4 animate-fade-in">
                 <div class="bg-blue-50 rounded-3xl p-6 mb-6 text-center border-4 border-blue-200 border-dashed relative overflow-hidden">
                     <div class="text-blue-500 font-black text-sm mb-4 uppercase tracking-widest">Packing Status</div>
                     <div class="flex justify-center mb-4">
                         <div class="packing-suitcase" :class="{'full': getPackingProgress(currentUser)===100}">
                             <div class="packing-fill" :style="{height: getPackingProgress(currentUser)+'%'}"></div>
                             <span class="relative z-10 text-xl">{{getPackingProgress(currentUser)}}%</span>
                         </div>
                     </div>
                     <div v-if="getPackingProgress(currentUser)===100" class="text-green-500 font-black animate-bounce">Ready to Go! âœˆï¸</div>
                     <div v-else class="text-gray-400 text-xs font-bold">å¿«æŠŠè¡Œæå¡æ»¿ï¼</div>
                 </div>

                 <div v-if="!currentUser || isGuest" class="text-center text-gray-400 font-bold bg-white/50 py-10 rounded-2xl border border-dashed"><i class="fa-solid fa-suitcase text-3xl mb-2"></i><br>è«‹ç™»å…¥ä»¥ç®¡ç†è¡Œæ</div>
                 <div v-else class="card p-0">
                    <div class="bg-gray-50 p-3 border-b font-bold text-gray-700 flex justify-between items-center">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-clipboard-check text-blue-400"></i> {{currentUser.name}} çš„è£å‚™</span>
                        <button @click="addPrepItem(currentUser)" class="text-xs bg-blue-500 text-white px-3 py-1 rounded-full font-bold shadow-blue-200 shadow active:scale-95 transition">+ æ–°å¢</button>
                    </div>
                    <div v-for="(item, idx) in currentUser.list" :key="idx" class="flex items-center p-3 border-b border-gray-100 group">
                        <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-500 mr-3" @change="saveData">
                        <input v-model="item.text" @change="saveData" :class="['flex-1 text-sm font-bold bg-transparent outline-none', item.checked?'text-gray-300 line-through':'text-gray-700']">
                        <button @click="currentUser.list.splice(idx,1);saveData()" class="text-gray-200 hover:text-red-400 transition px-2"><i class="fa-solid fa-times"></i></button>
                    </div>
                 </div>
            </div>

            <div v-if="currentView==='food' || currentView==='photo'" class="px-5 py-4 animate-fade-in">
                <div class="flex gap-2 mb-4 justify-center"><button v-for="loc in ['Tokyo','Kamakura','Fuji']" @click="currentLoc=loc" :class="['px-5 py-2 rounded-full font-bold text-xs transition active:scale-95', currentLoc===loc?'bg-orange-400 text-white':'bg-white text-gray-400']">{{{'Tokyo':'æ±äº¬','Kamakura':'éŒå€‰','Fuji':'å¯Œå£«å±±'}[loc]}}</button></div>
                
                <div v-if="currentView==='food'" class="map-cover-container">
                    <img :src="getMapCover(currentLoc)" class="map-cover" @error="handleImgError">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20 px-2">
                    <div v-for="(item,idx) in spots[currentView][currentLoc]" :key="idx" class="food-card relative group">
                        <div v-if="currentView==='food'" class="raid-badge" :class="getRaidClass(item)"><i :class="getRaidIcon(item)"></i> {{getRaidLabel(item)}}</div>
                        
                        <div class="item-img-container" @click.stop="openLightbox(item.img)">
                            <div class="img-fallback">åœ–ç‰‡å¾…è£œ</div>
                            <img v-if="item.img" :src="getImg(item.img)" class="relative z-10 group-hover:scale-110" @error="handleImgError">
                        </div>

                        <div class="p-4 relative">
                            <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                            <p class="text-sm text-gray-500 mb-3 font-bold">{{item.desc}}</p>
                            
                            <div v-if="currentView==='food'" class="mb-3 space-y-2">
                                <button @click="quickExpense(item)" class="w-full bg-yellow-400 text-white font-bold py-2 rounded-lg text-xs flex items-center justify-center gap-1 active:scale-95 transition shadow-sm"><i class="fa-solid fa-file-invoice-dollar"></i> åƒå®Œäº† (ä¸€éµè¨˜å¸³)</button>
                                <a v-if="item.reserveLink" :href="item.reserveLink" target="_blank" class="block w-full text-center bg-red-500 text-white font-bold py-2 rounded-lg text-xs active:scale-95">ç«‹å³é ç´„</a>
                            </div>

                            <a :href="getMapLink(item.link, item.name)" target="_blank" class="block w-full text-center bg-gray-100 text-gray-500 font-bold py-2 rounded-lg text-xs hover:bg-orange-400 hover:text-white transition active:scale-95"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                            
                            <div v-if="!isGuest" class="absolute top-2 right-2 flex gap-2 z-20">
                                <button @click="openEditModal(currentView==='food'?'food':'spot', item, idx)" class="w-8 h-8 bg-white/90 rounded-full shadow text-blue-500 flex items-center justify-center active:scale-90"><i class="fa-solid fa-pen text-[10px]"></i></button>
                                <button @click="spots[currentView][currentLoc].splice(idx,1);saveData()" class="w-8 h-8 bg-white/90 rounded-full shadow text-red-500 flex items-center justify-center active:scale-90"><i class="fa-solid fa-trash text-[10px]"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <button v-if="!isGuest" @click="currentView==='food'?openAddFoodModal():openAddSpotModal()" class="fab-main bg-orange-400 text-white"><i class="fa-solid fa-plus"></i></button>
            </div>
            
            <div v-if="currentView==='money'" class="px-5 py-4 animate-fade-in">
                 <div v-if="isGuest" class="text-center py-20 text-gray-400 font-bold">è¨ªå®¢æ¨¡å¼ç„¡æ³•è¨˜å¸³</div>
                  <div v-else>
                      <div class="flex gap-2 mb-4 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm shadow-sm">
                           <button @click="moneyTab='record'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='record'?'bg-yellow-400 text-white shadow-md':'text-gray-400']">æˆ‘çš„ç§å¸³</button>
                           <button @click="moneyTab='split'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='split'?'bg-blue-400 text-white shadow-md':'text-gray-400']">å…¬æ¬¾åˆ†å¸³</button>
                      </div>
                      <div class="space-y-3 pb-20">
                           <div v-for="exp in (moneyTab==='record'?myPrivateExpenses:groupExpenses)" :key="exp.id" class="card p-4 flex justify-between items-center !mb-0 !rounded-2xl border-l-4" :class="moneyTab==='record'?'border-yellow-300':'border-blue-300'">
                                <div><div class="font-bold text-gray-800">{{exp.name}}</div><div class="text-[10px] text-gray-400">{{exp.date}}</div></div>
                                <div class="text-right"><span class="font-black text-gray-700">{{exp.currency}} {{exp.amount}}</span></div>
                                <button @click="deleteExpense(exp.id)" class="ml-3 text-red-300"><i class="fa-solid fa-trash-can"></i></button>
                           </div>
                      </div>
                      <button @click="openExpenseModal(moneyTab==='record'?'private':'split')" class="fab-main bg-yellow-400 text-white"><i class="fa-solid fa-plus"></i></button>
                  </div>
             </div>

        </div> 
        
        <div v-if="currentView!=='menu'" class="fab-home" @click="currentView='menu'"><i class="fa-solid fa-house"></i></div>
        
        <div v-if="showPersonaModal" class="fixed inset-0 z-[2000] bg-black/85 flex items-center justify-center p-6 backdrop-blur-lg animate-fade-in">
             <div class="bg-white/95 w-full max-w-sm rounded-[32px] p-8 text-center shadow-2xl relative border-[6px] border-pink-200">
                 <h3 class="font-black text-2xl mb-8 text-pink-500 tracking-wider flex items-center justify-center gap-2"><i class="fa-solid fa-paw"></i> è«‹å•æ‚¨æ˜¯å“ªä¸€ä½ï¼Ÿ</h3>
                 <div class="grid grid-cols-2 gap-6 mb-2">
                     <div v-for="u in users" :key="u.id" class="relative group cursor-pointer" @click="setCurrentUser(u)">
                         <div class="w-24 h-24 mx-auto rounded-3xl bg-white border-4 border-gray-100 shadow-lg flex items-center justify-center text-4xl mb-3 overflow-hidden transition-all duration-300 group-hover:scale-110 group-hover:border-pink-400">
                             <img v-if="u.avatar" :src="u.avatar" class="w-full h-full object-cover">
                             <span v-else>{{u.icon}}</span>
                         </div>
                         <div class="font-black text-gray-600 text-lg">{{u.name}}</div>
                         <button v-if="!isGuest" @click.stop="openUserEditor(u)" class="absolute -top-2 -right-2 w-8 h-8 bg-gray-800 text-white rounded-full flex items-center justify-center shadow-md"><i class="fa-solid fa-pen text-xs"></i></button>
                     </div>
                 </div>
             </div>
        </div>

        <div v-if="showModal" class="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
                <h3 class="font-bold text-lg mb-4 text-center">{{modalTitle}}</h3>
                <div class="space-y-3">
                    <div v-for="f in modalFields" :key="f.key">
                        <label v-if="f.label" class="text-xs font-bold text-gray-400 ml-1 mb-1 block">{{f.label}}</label>
                        <div v-if="f.type==='checkbox'" class="flex items-center bg-gray-50 p-3 rounded-xl border">
                             <input type="checkbox" v-model="modalData[f.key]" class="w-5 h-5 accent-pink-500 mr-3">
                             <span class="font-bold text-gray-700 text-sm">{{f.label}}</span>
                        </div>
                        <textarea v-else-if="f.type==='textarea'" v-model="modalData[f.key]" class="w-full p-3 bg-gray-50 rounded-xl outline-none border h-24"></textarea>
                        <input v-else v-model="modalData[f.key]" class="w-full p-3 bg-gray-50 rounded-xl outline-none border">
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                    <button @click="handleModalSave" class="flex-1 py-3 bg-pink-500 text-white rounded-xl font-bold shadow-lg">å„²å­˜</button>
                </div>
            </div>
        </div>

        <div v-if="showExpenseModal" class="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="font-bold text-lg mb-4 text-center">è¨˜ä¸€ç­†</h3>
                <input v-model="modalData.name" placeholder="æ¶ˆè²»é …ç›®" class="w-full p-3 bg-gray-50 rounded-xl mb-3 border font-bold">
                <div class="flex gap-2 mb-3">
                    <input type="number" v-model="modalData.amount" placeholder="é‡‘é¡" class="flex-1 p-3 bg-gray-50 rounded-xl border font-black text-lg">
                    <select v-model="modalData.currency" class="bg-gray-100 rounded-xl px-2 font-bold text-sm outline-none"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
                </div>
                <button @click="saveExpense" class="w-full py-3 bg-yellow-400 text-white rounded-xl font-bold shadow-lg">å„²å­˜</button>
                <button @click="showExpenseModal=false" class="w-full py-3 mt-2 text-gray-400 font-bold">å–æ¶ˆ</button>
            </div>
        </div>

        <input type="file" ref="avatarInput" accept="image/*" class="hidden" @change="processAvatarUpload">
        <input type="file" ref="modalImgInput" accept="image/*" class="hidden" @change="processModalImg">
        <div v-if="previewImg" class="fixed inset-0 z-[9999] bg-black/95 flex items-center justify-center p-2" @click="closeLightbox"><img :src="previewImg" class="max-w-full max-h-full rounded-lg shadow-2xl"></div>

    </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3.3.4/dist/vue.esm-browser.js";

// Firebase Config
const firebaseConfig = { apiKey: "AIzaSyD3ojbkJVfDKmZQHRpZG-gp8gv7ajKdJr4", authDomain: "tokyo-trip-24b28.firebaseapp.com", projectId: "tokyo-trip-24b28", storageBucket: "tokyo-trip-24b28.firebasestorage.app", messagingSenderId: "518699705070", appId: "1:518699705070:web:56e95f603210d8d5d209ff" };
let auth, db; try { const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); enableIndexedDbPersistence(db).catch(e=>{}); } catch (e) { console.warn("Firebase Init Fail", e); }

// é è¨­è³‡æ–™ (Structure Only - Data comes from Cloud first)
const defaultUsers = [
    {id:1,name:'å‰ä¼Š',icon:'ğŸ¹',list:[]},{id:2,name:'å°å…«',icon:'ğŸ±',list:[]},{id:3,name:'å…”å…”',icon:'ğŸ°',list:[]},{id:4,name:'å°æ¡ƒ',icon:'ğŸ‘',list:[]}
];
// Updated Photo Spots (5 per loc)
const newPhotoSpots = {
    Tokyo: [
        {name:'SHIBUYA SKY', desc:'çµ•ç¾æ—¥è½å±•æœ›å°', link:'SHIBUYA SKY'},
        {name:'æ±äº¬éµå¡” (èŠå…¬åœ’)', desc:'4è™Ÿåœ°æœ€ä½³æ©Ÿä½', link:'èŠå…¬åœ’ 4è™Ÿåœ°'},
        {name:'æ·ºè‰é›·é–€', desc:'ç¶“å…¸ç´…ç‡ˆç± ', link:'é›·é–€'},
        {name:'TeamLab Planets', desc:'å¤¢å¹»å…‰å½±å±•', link:'TeamLab Planets'},
        {name:'è±ªå¾·å¯º', desc:'æ»¿æ»¿æ‹›è²¡è²“', link:'è±ªå¾·å¯º'}
    ],
    Kamakura: [
        {name:'éŒå€‰é«˜æ ¡å‰', desc:'çŒç±ƒé«˜æ‰‹å¹³äº¤é“', link:'éŒå€‰é«˜æ ¡å‰é§…'},
        {name:'é•·è°·å¯º', desc:'ç¹¡çƒèŠ±èˆ‡æµ·æ™¯', link:'é•·è°·å¯º'},
        {name:'ä¸ƒé‡Œæ¿±æµ·å²¸', desc:'å¯Œå£«å±±èˆ‡æ±Ÿä¹‹é›»', link:'ä¸ƒé‡Œãƒ¶æµœ æµ·å²¸'},
        {name:'å ±åœ‹å¯º', desc:'ç«¹æ—åº­åœ’', link:'å ±åœ‹å¯º'},
        {name:'æ±Ÿå³¶ç¥ç¤¾', desc:'æµ·ä¸Šé³¥å±…', link:'æ±Ÿå³¶ç¥ç¤¾'}
    ],
    Fuji: [
        {name:'æ–°å€‰å±±æ·ºé–“å…¬åœ’', desc:'äº”é‡å¡” x å¯Œå£«å±±', link:'æ–°å€‰å±±æ·ºé–“å…¬åœ’'},
        {name:'ä¸‹å‰ç”°æœ¬ç”ºé€š', desc:'æ—¥å·æ™‚è¨ˆåº—è¡—æ™¯', link:'æ—¥å·æ™‚è¨ˆåº—'},
        {name:'å¤§çŸ³å…¬åœ’', desc:'æ¹–ç•”èŠ±æµ·', link:'å¤§çŸ³å…¬åœ’'},
        {name:'æ²³å£æ¹–è»Šç«™', desc:'LAWSON å¯Œå£«å±±', link:'æ²³å£æ¹–é§…'},
        {name:'å¹³é‡ä¹‹æ¿±', desc:'é€†å¯Œå£«å€’å½±', link:'å¹³é‡ã®æµœ'}
    ]
};

const getImg = (p) => {
   if (!p) return 'https://placehold.co/600x400/pink/white?text=No+Image';
   if (p.startsWith('data:') || p.startsWith('http')) return p;
   return `https://raw.githubusercontent.com/sunny5200820-maker/2026.tokyo.fuji.trip/main/images/${p}`;
};
const compressImage = (base64) => { return new Promise((resolve) => { const img = new Image(); img.src = base64; img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height; const MAX = 600; if(w>MAX){ h*=MAX/w; w=MAX; } canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h); resolve(canvas.toDataURL('image/jpeg', 0.6)); }; }); };

createApp({
    setup() {
        const currentView = ref('welcome');
        const isWelcomeClosed = ref(false);
        const currentUser = ref(null);
        const isGuest = ref(false);
        const showPersonaModal = ref(false);
        const isLoggedIn = ref(false);
        const syncStatus = ref('idle');
        const showLoginModal = ref(false); 
        const loginForm = ref({email:'',password:''});

        // Data Refs
        const users = ref(JSON.parse(JSON.stringify(defaultUsers)));
        const itinerary = ref([]); 
        const expenses = ref([]);
        const spots = ref({ food:{Tokyo:[],Kamakura:[],Fuji:[]}, photo: newPhotoSpots }); // Init with new structure
        const shopping = ref({cosme:[],ldk:[],souvenir:[]});
        const japanesePhrases = ref([]);
        const emergTab = ref('map');

        // UI State
        const selectedDayIndex = ref(0);
        const itineraryMode = ref('normal');
        const shopCat = ref('cosme');
        const currentLoc = ref('Tokyo');
        const moneyTab = ref('record');
        
        // Modals
        const showModal = ref(false);
        const showExpenseModal = ref(false);
        const modalData = ref({});
        const modalFields = ref([]);
        const modalTitle = ref('');
        const modalCallback = ref(null);
        const modalHasImg = ref(false);
        const isEditingItem = ref(false);
        const previewImg = ref(null);

        // Constants
        const apps = [
            {id:1,name:'è¡Œç¨‹',icon:'fa-solid fa-map',view:'itinerary',bgClass:'bg-pink-400'},
            {id:2,name:'å°è²¡åº«',icon:'fa-solid fa-yen-sign',view:'money',bgClass:'bg-yellow-400'},
            {id:3,name:'è¡Œå‰æº–å‚™',icon:'fa-solid fa-suitcase',view:'prep',bgClass:'bg-blue-400'},
            {id:4,name:'ç¾é£Ÿåœ°åœ–',icon:'fa-solid fa-utensils',view:'food',bgClass:'bg-orange-400'},
            {id:5,name:'æ¨è–¦æ©Ÿä½',icon:'fa-solid fa-camera',view:'photo',bgClass:'bg-rose-400'},
            {id:6,name:'è³¼ç‰©æ¸…å–®',icon:'fa-solid fa-bag-shopping',view:'shopping',bgClass:'bg-purple-400'},
            {id:9,name:'ç·Šæ€¥æ•‘åŠ©',icon:'fa-solid fa-kit-medical',view:'emergency',bgClass:'bg-red-400'}
        ];
        const tripDays = [{week:'D1',title:'3/27'},{week:'D2',title:'3/28'},{week:'D3',title:'3/29'},{week:'D4',title:'3/30'},{week:'D5',title:'3/31'},{week:'D6',title:'4/01'},{week:'D7',title:'4/02'},{week:'D8',title:'4/03'}];
        const daysUntilTrip = ref(Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24)));
        const smartReminders = computed(() => { const l=[]; if(daysUntilTrip.value<=30) l.push("å¯Œå£«å›éŠè™Ÿï¼šè©²æ¶ç¥¨äº†ï¼"); if(daysUntilTrip.value<=0) l.push("æ—…é€”æ„‰å¿«ï¼"); return l; });

        // Helpers
        const getPageTitle = (view) => apps.find(a=>a.view===view)?.name || 'é—œæ±ä¹‹æ—…';
        const getImg = (p) => {
            if (!p) return 'https://placehold.co/600x400/pink/white?text=No+Image';
            if (p.startsWith('data:') || p.startsWith('http')) return p;
            return `https://raw.githubusercontent.com/sunny5200820-maker/2026.tokyo.fuji.trip/main/images/${p}`;
        };
        const handleImgError = (e) => e.target.src='https://placehold.co/400x300/pink/white?text=No+Image';
        const getIconByCategory = (cat) => ({'Flight':'fa-solid fa-plane','Sightseeing':'fa-solid fa-camera','Food':'fa-solid fa-utensils','Shopping':'fa-solid fa-bag-shopping','Transport':'fa-solid fa-train-subway'}[cat]||'fa-solid fa-location-dot');
        const getMapLink = (k,n) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k||n)}`;
        const getCurrentItinerary = () => itinerary.value[selectedDayIndex.value] || [];
        const statusText = computed(() => !isLoggedIn.value?'Offline':syncStatus.value==='syncing'?'Syncing...':'Online');
        const statusColor = computed(() => !isLoggedIn.value?'bg-gray-400':syncStatus.value==='syncing'?'bg-yellow-400 animate-pulse':'bg-green-400');
        const isUserOnline = (id) => false; // Simplified

        // ğŸ’° Logic: Budget Mood
        const myPrivateExpenses = computed(() => currentUser.value ? expenses.value.filter(e => e.whoPaid===currentUser.value.id && e.forWhom.length===1) : []);
        const groupExpenses = computed(() => expenses.value.filter(e => e.forWhom.length > 1));
        const totalSpent = computed(() => myPrivateExpenses.value.reduce((s,e)=>s+parseInt(e.amount), 0));
        const getBudgetMood = () => {
            const budget = 30000; // Hardcoded budget
            const r = totalSpent.value / budget;
            if(r > 1.0) return 'ğŸ˜±'; // Crying (Over budget)
            if(r > 0.8) return 'ğŸ˜°'; // Nervous
            if(r > 0.5) return 'ğŸ˜'; // Neutral
            return 'ğŸ˜Š'; // Happy
        };

        // ğŸ® Logic: Gamification
        const getPackingProgress = (u) => {
            if(!u || !u.list || u.list.length===0) return 0;
            return Math.round((u.list.filter(i=>i.checked).length / u.list.length)*100);
        };
        const getStamina = (dIdx) => {
             // Mock logic: Count items
             const count = (itinerary.value[dIdx] || []).length;
             let hp = 100 - (count * 15);
             if(dIdx===0 || dIdx===7) hp -= 20; // Flights tire you out
             return Math.max(10, hp);
        };
        const getStaminaColor = (i) => { const s=getStamina(i); return s<40?'hp-low':s<70?'hp-med':'hp-high'; };

        // ğŸ‘‹ Logic: Greeting
        const getGreeting = () => {
            if(!currentUser.value) return 'æ—…ç¨‹ä¸­å¿ƒ';
            const n = currentUser.value.name;
            if(n.includes('å‰ä¼Š')) return 'å“‡...å“‡æ¯å“‡æ¯...';
            if(n.includes('å°å…«')) return 'ä»Šå¤©ä¹Ÿè¦åŠªåŠ›å–”ï¼(å¾®ç¬‘)';
            if(n.includes('å…”å…”')) return 'Hula!!! (æ€ªå«)';
            if(n.includes('å°æ¡ƒ')) return 'å“¼...\nè¦åœ¨å¤§å®¶é¢å‰èª‡çæˆ‘å¾ˆå¯æ„›å–”ï¼';
            return `æ­¡è¿å›ä¾†ï¼Œ${n}ï¼`;
        };

        // ğŸ”§ Core: Save Logic
        let saveTimeout;
        const saveData = async () => {
            if(isGuest.value) return;
            syncStatus.value = 'syncing';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const data = {
                    users: users.value,
                    itinerary: itinerary.value,
                    expenses: expenses.value,
                    spots: spots.value,
                    shopping: shopping.value,
                    phrases: japanesePhrases.value,
                    lastUpdate: serverTimestamp()
                };
                try {
                    if(db && isLoggedIn.value) await setDoc(doc(db,"trips","kanto2026"), data, {merge:true});
                    setTimeout(() => syncStatus.value = 'idle', 500);
                } catch(e) { console.error("Save Fail", e); syncStatus.value = 'error'; }
            }, 800);
        };

        // ğŸ”§ Core: Merge Logic (The Fix for Reset Bug)
        const mergeData = (cloudData) => {
             if(!cloudData) return;
             // Merge Users (Keep local ID/Avatar if not changed, but sync List)
             if(cloudData.users) users.value = cloudData.users;
             
             // Merge Itinerary (Crucial)
             if(cloudData.itinerary && cloudData.itinerary.length > 0) itinerary.value = cloudData.itinerary;
             else if (itinerary.value.length === 0) {
                 // Init empty itinerary structure if completely empty
                 for(let i=0; i<8; i++) itinerary.value.push([]);
             }

             if(cloudData.expenses) expenses.value = cloudData.expenses;
             
             // Merge Spots (Preserve new structure while keeping old data)
             if(cloudData.spots) {
                 spots.value.food = cloudData.spots.food || {Tokyo:[],Kamakura:[],Fuji:[]};
                 // Ensure new photo spots exist if cloud is old version
                 spots.value.photo = cloudData.spots.photo || newPhotoSpots; 
             }
             if(cloudData.shopping) shopping.value = cloudData.shopping;
             if(cloudData.phrases) japanesePhrases.value = cloudData.phrases;
        };

        // ğŸš€ Quick Expense
        const quickExpense = (item) => {
             if(isGuest.value) { alert('è¨ªå®¢ç„¡æ³•è¨˜å¸³'); return; }
             currentView.value = 'money';
             openExpenseModal('private');
             modalData.value.name = item.name; // Auto-fill
             modalData.value.amount = '';
        };

        // Modals & Actions
        const openExpenseModal = (mode) => { showExpenseModal.value=true; modalData.value={name:'',amount:'',currency:'JPY',whoPaid:currentUser.value.id,forWhom:[currentUser.value.id]}; };
        const saveExpense = () => { expenses.value.push({...modalData.value, id:Date.now(), date:new Date().toLocaleDateString()}); saveData(); showExpenseModal.value=false; };
        const deleteExpense = (id) => { if(confirm('ç¢ºå®šåˆªé™¤?')) { expenses.value = expenses.value.filter(e=>e.id!==id); saveData(); } };
        const openEditItineraryModal = (item,idx) => { modalTitle.value='ç·¨è¼¯è¡Œç¨‹'; modalData.value={...item}; modalFields.value=[{key:'hours',label:'æ™‚é–“'},{key:'name',label:'åç¨±'},{key:'note',label:'å‚™è¨»'},{key:'mapKeyword',label:'åœ°åœ–é—œéµå­—'}]; showModal.value=true; modalCallback.value=()=>{ itinerary.value[selectedDayIndex.value][idx]=modalData.value; itinerary.value[selectedDayIndex.value].sort((a,b)=>a.hours.localeCompare(b.hours)); saveData(); }; };
        const openAddItineraryModal = () => { modalTitle.value='æ–°å¢è¡Œç¨‹'; modalData.value={hours:'',name:'',note:'',category:'Sightseeing'}; modalFields.value=[{key:'hours',label:'æ™‚é–“'},{key:'name',label:'åç¨±'},{key:'note',label:'å‚™è¨»'},{key:'mapKeyword',label:'åœ°åœ–é—œéµå­—'}]; showModal.value=true; modalCallback.value=()=>{ itinerary.value[selectedDayIndex.value].push(modalData.value); itinerary.value[selectedDayIndex.value].sort((a,b)=>a.hours.localeCompare(b.hours)); saveData(); }; };
        const handleModalSave = () => { if(modalCallback.value) modalCallback.value(); showModal.value=false; };
        const setCurrentUser = (u) => { if(isGuest.value) return; currentUser.value = u; showPersonaModal.value = false; currentView.value = 'menu'; };
        const enterSite = () => { isGuest.value=false; isWelcomeClosed.value=true; showPersonaModal.value=true; };
        const enterAsGuest = () => { isGuest.value=true; currentUser.value={id:999,name:'è¨ªå®¢',list:[]}; isWelcomeClosed.value=true; currentView.value='menu'; };
        const handleAuthClick = () => isLoggedIn.value ? signOut(auth) : showLoginModal.value=true;
        const getMapCover = (loc) => getImg(`${loc === 'Tokyo' ? 'æ±äº¬' : loc === 'Kamakura' ? 'éŒå€‰' : 'å¯Œå£«å±±'}ç¾é£Ÿåœ°åœ–.jpg`);
        const getRaidClass = (i) => i.reserveLink ? 'bg-red-500 text-white' : 'bg-green-500 text-white';
        const getRaidIcon = (i) => i.reserveLink ? 'fa-solid fa-fire' : 'fa-solid fa-leaf';
        const getRaidLabel = (i) => i.reserveLink ? 'éœ€é ç´„' : 'è¼•é¬†åƒ';
        const openLightbox = (img) => { if(img) previewImg.value = getImg(img); };
        const closeLightbox = () => previewImg.value = null;
        const addPrepItem = (u) => { u.list.push({text:'æ–°é …ç›®',checked:false}); saveData(); };
        const expandCard = (p) => alert(`${p.jp}\n${p.zh}`); // Simple alert for now
        const handleCameraTranslate = () => window.open('https://translate.google.com/?sl=auto&tl=zh-TW&op=images', '_blank');
        const openAddPhraseModal = () => { modalTitle.value='æ–°å¢ç¿»è­¯'; modalFields.value=[{key:'zh',label:'ä¸­æ–‡'},{key:'jp',label:'æ—¥æ–‡'}]; modalData.value={zh:'',jp:''}; showModal.value=true; modalCallback.value=()=>{japanesePhrases.value.push(modalData.value); saveData();}; };
        const openEditModal = (type, item, idx) => { modalTitle.value='ç·¨è¼¯'; modalData.value={...item}; modalFields.value=[{key:'name',label:'åç¨±'},{key:'desc',label:'æè¿°'},{key:'link',label:'é€£çµ'}]; showModal.value=true; modalCallback.value=()=>{ if(type==='food') spots.value.food[currentLoc.value][idx]=modalData.value; else spots.value.photo[currentLoc.value][idx]=modalData.value; saveData(); }; };
        const openAddFoodModal = () => { modalTitle.value='æ–°å¢ç¾é£Ÿ'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'desc',label:'æè¿°'},{key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalData.value={}; showModal.value=true; modalCallback.value=()=>{ spots.value.food[currentLoc.value].push(modalData.value); saveData(); }; };
        const openAddSpotModal = () => { modalTitle.value='æ–°å¢æ‰“å¡é»'; modalFields.value=[{key:'name',label:'åç¨±'},{key:'desc',label:'æè¿°'},{key:'link',label:'åœ°åœ–é—œéµå­—'}]; modalData.value={}; showModal.value=true; modalCallback.value=()=>{ spots.value.photo[currentLoc.value].push(modalData.value); saveData(); }; };
        const showDiagnostic = () => alert(`System Online.\nDB: ${!!db}\nUser: ${currentUser.value?.name}`);

        onMounted(() => {
            // Init empty itinerary slots
            for(let i=0; i<8; i++) itinerary.value.push([]);
            
            if(auth) onAuthStateChanged(auth, u => {
                isLoggedIn.value = !!u;
                if(u && db) {
                    // Real-time listener: THIS FIXES THE RESET BUG
                    onSnapshot(doc(db,"trips","kanto2026"), (doc) => {
                        if(doc.exists()) {
                            mergeData(doc.data()); // Intelligent Merge
                        } else {
                            // Only init defaults if DB is truly empty
                            saveData(); 
                        }
                    });
                }
            });
        });

        return {
            currentView, isWelcomeClosed, currentUser, isGuest, apps, daysUntilTrip, smartReminders, tripDays, selectedDayIndex,
            itinerary, getCurrentItinerary, itineraryMode,
            emergTab, japanesePhrases,
            spots, currentLoc, getMapCover, getImg, handleImgError, getRaidClass, getRaidIcon, getRaidLabel,
            moneyTab, myPrivateExpenses, groupExpenses, getBudgetMood, quickExpense,
            getPackingProgress, getStamina, getStaminaColor, getGreeting,
            statusText, statusColor, isLoggedIn, handleAuthClick, showLoginModal, loginForm,
            showModal, modalTitle, modalFields, modalData, handleModalSave, showExpenseModal, openExpenseModal, saveExpense, deleteExpense,
            openEditItineraryModal, openAddItineraryModal, getIconByCategory, getMapLink,
            enterSite, enterAsGuest, showPersonaModal, setCurrentUser, openLightbox, closeLightbox, previewImg, addPrepItem, saveData,
            handleCameraTranslate, expandCard, openAddPhraseModal, openEditModal, openAddFoodModal, openAddSpotModal, showDiagnostic,
            getPageTitle
        };
    }
}).mount('#app');
</script>
</body>
</html>
