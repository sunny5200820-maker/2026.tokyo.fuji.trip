<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—œæ±8æ—¥å¥³å­æ—… | å‰ä¼Šå¡å“‡é¢¨ V4.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chiika-pink': '#FFD1DC',
                        'chiika-blue': '#A2D2FF',
                        'chiika-yellow': '#FFF5BA',
                        'chiika-text': '#5D5D5D',
                    },
                    fontFamily: {
                        sans: ['Zen Maru Gothic', 'sans-serif'],
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #A2D2FF; 
            font-family: 'Zen Maru Gothic', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .banner-container {
            height: 250px;
            background-image: url('./banner.jpg'); 
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .banner-fallback {
            background: linear-gradient(180deg, #A2D2FF 0%, #FFD1DC 100%);
        }
        .app-content {
            background-color: #FFF5F7;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            margin-top: -30px; 
            position: relative;
            z-index: 10;
            min-height: calc(100vh - 220px);
            padding-bottom: 140px;
        }
        .floating-tabs {
            position: fixed;
            bottom: 20px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 40;
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            backdrop-filter: blur(5px);
            width: max-content;
            max-width: 98vw;
            overflow-x: auto;
        }
        .tab-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: #9CA3AF;
            transition: all 0.2s;
            position: relative;
            flex-shrink: 0;
        }
        .tab-btn.active {
            background: #FFD1DC;
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(255, 209, 220, 0.6);
        }
        .tab-label {
            position: absolute;
            bottom: -18px;
            font-size: 9px;
            width: max-content;
            color: #888;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .tab-btn.active .tab-label { opacity: 1; color: #FF8FAB; font-weight: bold; }
        
        /* æ¼‚æµ®å‹•ç•« (å‰ä¼Šå¡å“‡ç”¨) */
        .weather-chiika {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(255, 183, 178, 0.2);
            transition: transform 0.1s;
        }
        .card:active { transform: scale(0.98); }

        /* æ‡¸æµ®æŒ‰éˆ• */
        .fab-btn {
            position: fixed;
            bottom: 110px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 30;
            transition: transform 0.2s;
        }
        .fab-btn:active { transform: scale(0.9); }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app">
    <div v-if="!isMounted" class="fixed inset-0 flex items-center justify-center text-white font-bold bg-blue-300 z-50">
        <i class="fa-solid fa-spinner fa-spin mr-2"></i> æ­£åœ¨æº–å‚™è¡Œç¨‹...
    </div>

    <div v-if="isMounted" v-cloak>
        <div class="banner-container relative" :class="{'banner-fallback': !hasBanner}">
            <div class="absolute top-4 right-4 z-20 flex gap-2">
                <button @click="resetData" class="bg-red-400/80 backdrop-blur text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm hover:bg-red-500">
                    <i class="fa-solid fa-rotate-right mr-1"></i>é‡ç½®
                </button>
            </div>
            <div class="absolute bottom-10 left-6 text-white drop-shadow-md z-10">
                <h1 class="text-3xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">é—œæ±8æ—¥å¥³å­æ—…</h1>
                <p class="text-sm opacity-90 mt-1" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">å¯Œå£«å±±è‡ªé§• x å‰ä¼Šå¡å“‡</p>
            </div>
        </div>

        <div class="app-content px-4 py-6">

            <div v-if="currentTab === 'itinerary'">
                
                <div class="flex overflow-x-auto hide-scrollbar gap-3 mb-4 pb-2">
                    <div v-for="(day, index) in tripDays" :key="index" 
                        @click="changeDay(index)"
                        :class="['flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all', 
                                selectedDayIndex === index ? 'bg-chiika-pink text-white shadow-md transform scale-105' : 'bg-white text-gray-400']">
                        <span class="text-xs font-bold">{{ day.week }}</span>
                        <span class="text-2xl font-bold">{{ day.dateNum }}</span>
                    </div>
                </div>

                <div class="rounded-2xl p-4 mb-6 flex items-center justify-between shadow-md text-white relative overflow-hidden transition-all duration-500" 
                    :style="weatherBackground">
                    <div class="absolute -top-4 -right-4 w-24 h-24 bg-white opacity-20 rounded-full blur-xl"></div>
                    <div class="flex items-center gap-4 z-10">
                        <div class="text-4xl filter drop-shadow-lg weather-chiika">{{ weatherIcon }}</div>
                        <div>
                            <div class="text-lg font-bold flex items-center gap-2">
                                {{ locationName }} 
                                <span v-if="isFujiArea" class="text-xs bg-white/20 px-2 py-0.5 rounded-full border border-white/30">
                                    ğŸ—» èƒ½è¦‹åº¦ {{ fujiVisibility }}%
                                </span>
                            </div>
                            <div class="text-xs opacity-95 font-medium">{{ weatherDesc }}</div>
                        </div>
                    </div>
                    <div class="text-right z-10">
                        <div class="text-3xl font-bold">{{ currentTemp }}Â°C</div>
                        <div class="text-xs opacity-80">é™é›¨æ©Ÿç‡ {{ rainChance }}%</div>
                    </div>
                </div>

                <div class="space-y-0 min-h-[300px]">
                    <div v-if="currentDayItinerary.length === 0" class="text-center text-gray-400 py-10">
                        <p>ä»Šå¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹å‘¦</p>
                    </div>

                    <div v-for="(item, idx) in currentDayItinerary" :key="item.id" class="relative group mb-4">
                        <div v-if="idx > 0" class="ml-5 border-l-2 border-dashed border-gray-300 h-6"></div>
                        <div class="card p-4 flex gap-4 relative transition hover:shadow-md border-l-4" 
                             :class="getBorderColor(item.category)">
                            
                            <div class="flex-1 cursor-pointer" @click="editItem(item, idx)">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-lg leading-tight text-gray-700">
                                        {{ item.name }}
                                        <a v-if="item.mapKeyword" :href="getMapLink(item.mapKeyword)" target="_blank" @click.stop class="ml-2 text-blue-400 text-sm hover:text-blue-600">
                                            <i class="fa-solid fa-location-dot"></i>
                                        </a>
                                    </h3>
                                </div>
                                <div v-if="item.hours" class="text-xs mt-1 text-gray-500 font-mono">
                                    <i class="fa-regular fa-clock mr-1"></i> {{ item.hours }}
                                </div>
                                <p class="text-sm mt-2 text-gray-600 whitespace-pre-line">{{ item.note }}</p>
                            </div>

                            <button @click.stop="deleteItem(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400 p-2">
                                <i class="fa-solid fa-trash-can text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <button @click="openAddModal" class="fab-btn bg-chiika-blue text-white animate-bounce-slow hover:bg-blue-300">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'prep'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-pink-300">ç§Ÿè»Š & è¡Œå‰æº–å‚™</h2>
                
                <div class="bg-white rounded-xl p-4 shadow-sm mb-6 border border-blue-100">
                    <h3 class="font-bold text-blue-500 mb-3"><i class="fa-solid fa-car mr-2"></i>å¯Œå£«å±±ç§Ÿè»Šæ¨è–¦</h3>
                    <div class="space-y-2">
                        <a href="https://www.nipponrentacar.co.jp/en/" target="_blank" class="block bg-blue-50 p-3 rounded-lg flex justify-between items-center hover:bg-blue-100">
                            <div>
                                <div class="font-bold text-sm text-gray-700">Nippon Rent-A-Car</div>
                                <div class="text-xs text-gray-500">ä½å®¿é»é™„è¿‘é¦–é¸</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-blue-300"></i>
                        </a>
                        <a href="https://rent.toyota.co.jp/zh-tw/" target="_blank" class="block bg-blue-50 p-3 rounded-lg flex justify-between items-center hover:bg-blue-100">
                            <div>
                                <div class="font-bold text-sm text-gray-700">Toyota Rent a Car</div>
                                <div class="text-xs text-gray-500">æ²³å£æ¹–è»Šç«™å‰</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-blue-300"></i>
                        </a>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-6 relative">
                    <div class="absolute top-0 left-0 w-full h-4 bg-chiika-yellow opacity-50"></div>
                    <div v-for="(item, idx) in prepList" :key="idx" class="flex items-center gap-3 py-2 border-b border-gray-100 last:border-0">
                        <input type="checkbox" v-model="item.checked" class="w-5 h-5 text-pink-500 rounded focus:ring-pink-400">
                        <input v-model="item.text" class="flex-1 text-sm bg-transparent outline-none text-gray-700" :class="{'line-through text-gray-300': item.checked}">
                        <button @click="removePrepItem(idx)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
                <button @click="addPrepItem" class="fab-btn bg-pink-400 text-white hover:bg-pink-500"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div v-if="currentTab === 'shopping'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-blue-300">è³¼ç‰©é¡˜æœ›æ¸…å–®</h2>
                
                <div class="flex gap-2 mb-6 overflow-x-auto hide-scrollbar">
                    <a href="https://www.cosme.net/bestcosme/" target="_blank" class="flex-shrink-0 bg-green-100 text-green-700 px-4 py-2 rounded-full text-sm font-bold shadow-sm whitespace-nowrap">
                        <i class="fa-solid fa-crown mr-1"></i>@cosme å¤§è³
                    </a>
                    <a href="https://360life.shinyusha.co.jp/list/ldk" target="_blank" class="flex-shrink-0 bg-purple-100 text-purple-700 px-4 py-2 rounded-full text-sm font-bold shadow-sm whitespace-nowrap">
                        <i class="fa-solid fa-magazine mr-1"></i>LDK æ¯’èˆŒè©•æ¸¬
                    </a>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="card p-3 flex flex-col items-center relative group">
                        <button @click="shoppingList.splice(idx, 1)" class="absolute top-2 right-2 w-6 h-6 bg-white rounded-full text-red-400 shadow flex items-center justify-center z-10"><i class="fa-solid fa-xmark"></i></button>
                        <div class="w-full h-24 bg-gray-100 rounded-lg mb-2 overflow-hidden flex items-center justify-center text-gray-300 text-2xl"><i class="fa-solid fa-bag-shopping"></i></div>
                        <div class="font-bold text-sm text-center w-full text-gray-700">{{ item.name }}</div>
                        <div class="text-xs text-center text-gray-400">{{ item.tag }}</div>
                    </div>
                    <div @click="addShopItem" class="card p-3 flex flex-col items-center justify-center min-h-[140px] cursor-pointer border-2 border-dashed border-gray-300 hover:border-pink-300 shadow-none">
                        <i class="fa-solid fa-plus text-3xl text-gray-300"></i><div class="text-xs text-gray-400 mt-2">æ–°å¢å•†å“</div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'photos'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-purple-300">ğŸ“· ç¶²ç¾å¿…æ‹æ‰“å¡é»</h2>
                <div class="flex bg-white rounded-lg p-1 mb-4 shadow-sm">
                    <button v-for="area in ['Tokyo', 'Kamakura', 'Fuji']" :key="area" @click="photoArea = area" :class="['flex-1 py-2 text-sm font-bold rounded-md transition', photoArea === area ? 'bg-purple-100 text-purple-600' : 'text-gray-400']">
                        {{ area === 'Tokyo' ? 'æ±äº¬' : (area === 'Kamakura' ? 'éŒå€‰' : 'å¯Œå£«å±±') }}
                    </button>
                </div>
                <div class="space-y-4">
                    <div v-for="(spot, idx) in photoSpots[photoArea]" :key="idx" class="card p-0 overflow-hidden group">
                        <a :href="spot.link" target="_blank" class="block relative">
                            <div class="h-24 bg-gradient-to-r from-purple-50 to-pink-50 flex items-center justify-center text-4xl">{{ spot.icon }}</div>
                            <div class="p-3">
                                <h3 class="font-bold text-gray-700">{{ spot.name }}</h3>
                                <p class="text-xs text-gray-500 mt-1">{{ spot.desc }}</p>
                                <div class="mt-2 flex justify-end"><span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full font-bold"><i class="fa-solid fa-map-location-dot mr-1"></i>å°èˆª</span></div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'expenses'">
                <h2 class="text-xl font-bold text-chiika-text mb-4 pl-2 border-l-4 border-yellow-300">æ—…è²»è¨˜å¸³</h2>
                <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-yellow-100">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-xs font-bold text-gray-500">è¨˜å¸³äºº:</span>
                        <select v-model="currentUser" class="bg-gray-50 border border-gray-200 text-sm rounded-lg p-2 flex-1 outline-none">
                            <option v-for="u in expenseUsers" :key="u" :value="u">{{ u }}</option>
                        </select>
                        <button @click="addUser" class="text-blue-400 text-xs font-bold px-2">+äºº</button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400">åŒ¯ç‡:</span>
                            <input type="number" v-model="exchangeRate" class="w-16 bg-white border border-gray-200 text-xs p-1 rounded text-center" step="0.001">
                        </div>
                        <button @click="showTWD = !showTWD" class="text-xs font-bold px-3 py-1 rounded-full transition" :class="showTWD ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'">
                            é¡¯ç¤º: {{ showTWD ? 'å°å¹£ (NTD)' : 'æ—¥å¹£ (JPY)' }}
                        </button>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-yellow-100 to-orange-100 p-5 rounded-2xl mb-4 text-center shadow-inner relative">
                    <div class="text-xs text-gray-500 font-bold mb-1">{{ currentUser }} çš„ç¸½æ”¯å‡º</div>
                    <div class="text-3xl font-bold text-gray-800">{{ showTWD ? 'NT$' : 'Â¥' }} {{ convert(filteredTotal).toLocaleString() }}</div>
                </div>
                <div class="space-y-3 pb-20">
                    <div v-for="(exp, idx) in filteredExpenses" :key="exp.id" class="card p-3 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 text-sm font-bold">{{ exp.category.charAt(0) }}</div>
                            <div>
                                <div class="font-bold text-sm text-gray-700">{{ exp.name }}</div>
                                <div class="text-xs text-gray-400">{{ exp.date }}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-700">{{ showTWD ? 'NT$' : 'Â¥' }}{{ convert(exp.amount).toLocaleString() }}</div>
                            <button @click="deleteExpense(exp.id)" class="text-xs text-red-300 mt-1">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
                <button @click="openExpenseModal" class="fab-btn bg-yellow-400 text-white hover:bg-yellow-500"><i class="fa-solid fa-plus"></i></button>
            </div>

        </div>

        <div class="floating-tabs hide-scrollbar">
            <button @click="currentTab = 'itinerary'" :class="['tab-btn', currentTab === 'itinerary' ? 'active' : '']"><i class="fa-solid fa-map-location-dot"></i><span class="tab-label">è¡Œç¨‹</span></button>
            <button @click="currentTab = 'prep'" :class="['tab-btn', currentTab === 'prep' ? 'active' : '']"><i class="fa-solid fa-suitcase-rolling"></i><span class="tab-label">è¡Œå‰</span></button>
            <button @click="currentTab = 'shopping'" :class="['tab-btn', currentTab === 'shopping' ? 'active' : '']"><i class="fa-solid fa-bag-shopping"></i><span class="tab-label">è³¼ç‰©</span></button>
            <button @click="currentTab = 'photos'" :class="['tab-btn', currentTab === 'photos' ? 'active' : '']"><i class="fa-solid fa-camera"></i><span class="tab-label">æ‰“å¡</span></button>
            <button @click="currentTab = 'expenses'" :class="['tab-btn', currentTab === 'expenses' ? 'active' : '']"><i class="fa-solid fa-calculator"></i><span class="tab-label">è¨˜å¸³</span></button>
        </div>

        <div v-if="showModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-xl">
                <h3 class="font-bold text-lg mb-4 text-center">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <div class="space-y-3">
                    <input v-model="editForm.name" placeholder="è¡Œç¨‹åç¨±" class="w-full p-2 border rounded bg-gray-50 outline-none">
                    <input v-model="editForm.hours" placeholder="æ™‚é–“" class="w-full p-2 border rounded bg-gray-50 outline-none">
                    <input v-model="editForm.mapKeyword" placeholder="åœ°åœ–æœå°‹é—œéµå­—" class="w-full p-2 border rounded bg-gray-50 outline-none">
                    <select v-model="editForm.category" class="w-full p-2 border rounded bg-gray-50 outline-none">
                        <option value="Sightseeing">ğŸ“¸ æ™¯é»</option>
                        <option value="Food">ğŸœ ç¾é£Ÿ</option>
                        <option value="Shopping">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="Transport">ğŸš… äº¤é€š</option>
                        <option value="Hotel">ğŸ¨ ä½å®¿</option>
                    </select>
                    <textarea v-model="editForm.note" placeholder="å‚™è¨»..." class="w-full p-2 border rounded bg-gray-50 outline-none h-20"></textarea>
                    <div class="flex gap-2 pt-2">
                        <button @click="showModal = false" class="flex-1 py-2 bg-gray-200 rounded text-gray-600">å–æ¶ˆ</button>
                        <button @click="saveItem" class="flex-1 py-2 bg-chiika-blue text-white rounded shadow">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-xl">
                <h3 class="font-bold text-lg mb-4 text-center">è¨˜ä¸€ç­† ({{ currentUser }})</h3>
                <div class="space-y-3">
                    <input v-model="newExpense.name" placeholder="é …ç›®" class="w-full p-2 border rounded bg-gray-50 outline-none">
                    <input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡ (æ—¥å¹£)" class="w-full p-2 border rounded bg-gray-50 outline-none">
                    <select v-model="newExpense.category" class="w-full p-2 border rounded bg-gray-50 outline-none">
                        <option value="é£Ÿ">ğŸœ é£Ÿç‰©</option>
                        <option value="è¡£">ğŸ‘— è¡£æœ</option>
                        <option value="ä½">ğŸ¨ ä½å®¿</option>
                        <option value="è¡Œ">ğŸš… äº¤é€š</option>
                        <option value="æ¨‚">ğŸ¡ å¨›æ¨‚</option>
                    </select>
                    <div class="flex gap-2 pt-2">
                        <button @click="showExpenseModal = false" class="flex-1 py-2 bg-gray-200 rounded text-gray-600">å–æ¶ˆ</button>
                        <button @click="addExpense" class="flex-1 py-2 bg-yellow-400 text-white rounded shadow">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const isMounted = ref(false);
            const currentTab = ref('itinerary');
            const selectedDayIndex = ref(0);
            const hasBanner = ref(true);
            const STORAGE_KEY = 'tokyo_trip_v4';

            // --- Weather Data (V2.0 Core) ---
            const weatherIcon = ref('ğŸŒ¤ï¸');
            const currentTemp = ref('--');
            const rainChance = ref('0');
            const weatherDesc = ref('è®€å–ä¸­...');
            const fujiVisibility = ref('??');
            const weatherBackground = ref('background: linear-gradient(to right, #60a5fa, #a78bfa)');

            // UI State
            const showModal = ref(false);
            const showExpenseModal = ref(false);
            const isEditing = ref(false);
            const editIndex = ref(-1);

            // 1. è¡Œç¨‹è³‡æ–™
            const tripDays = [
                { week: 'Day 1', dateNum: 'å‡ºç™¼' }, { week: 'Day 2', dateNum: 'å¸‚å€' },
                { week: 'Day 3', dateNum: 'å¯Œå£«' }, { week: 'Day 4', dateNum: 'å±±ä¸­' },
                { week: 'Day 5', dateNum: 'æ²³å£' }, { week: 'Day 6', dateNum: 'éŒå€‰' },
                { week: 'Day 7', dateNum: 'æ¾€è°·' }, { week: 'Day 8', dateNum: 'è¿”ç¨‹' }
            ];

            const defaultItinerary = [
                [ // Day 1
                    { id: 101, category: 'Transport', name: 'æ¡ƒåœ’èµ·é£› (TR898)', hours: '06:40', note: 'ç¬¬ä¸€èˆªå»ˆ', mapKeyword: 'æ¡ƒåœ’æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ' },
                    { id: 102, category: 'Transport', name: 'æŠµé”æ±äº¬æˆç”°', hours: '10:40', note: 'æˆç”°æ©Ÿå ´', mapKeyword: 'æˆç”°æ©Ÿå ´' },
                    { id: 103, category: 'Sightseeing', name: 'æ™´ç©ºå¡”', hours: 'ä¸‹åˆ', note: 'å¿…æ‹åœ°æ¨™', mapKeyword: 'Tokyo Skytree' },
                    { id: 104, category: 'Food', name: 'æ™šé¤ï¼šéŒ¦ç³¸ç”ºå‘¨é­', hours: 'æ™šä¸Š', note: 'é€›è¡—å¾Œç”¨é¤', mapKeyword: 'éŒ¦ç³¸ç”ºç¾é£Ÿ' },
                    { id: 105, category: 'Hotel', name: 'ä½å®¿ (Day 1-2)', hours: '', note: 'é»æ“Šåœ°æ¨™æŸ¥çœ‹', mapKeyword: 'https://maps.app.goo.gl/1ohkU9q4txhJ6PJP8ï¼ˆè«‹ä¿®æ­£ï¼‰' }
                ],
                [ // Day 2
                    { id: 201, category: 'Sightseeing', name: 'æ·ºè‰å¯º', hours: 'ä¸Šåˆ', note: 'é›·é–€ã€ä»²è¦‹ä¸–é€š', mapKeyword: 'æ·ºè‰å¯º' },
                    { id: 202, category: 'Food', name: 'åˆé¤ï¼šæ·ºè‰å‘¨é­', hours: 'ä¸­åˆ', note: '', mapKeyword: 'æ·ºè‰åˆé¤' },
                    { id: 203, category: 'Sightseeing', name: 'å°ç¶²ç¥ç¤¾', hours: 'ä¸‹åˆ', note: 'å¼·é‹å„é™¤', mapKeyword: 'å°ç¶²ç¥ç¤¾' },
                    { id: 204, category: 'Sightseeing', name: 'ä¸Šé‡æ©è³œå…¬åœ’', hours: 'ä¸‹åˆ', note: 'æ•£æ­¥', mapKeyword: 'ä¸Šé‡æ©è³œå…¬åœ’' },
                    { id: 205, category: 'Shopping', name: 'ç§‹è‘‰åŸ æˆ– æ±äº¬ä¸€ç•ªè¡—', hours: 'æ™šä¸Š', note: 'å‹•æ¼«/ä¼´æ‰‹ç¦®', mapKeyword: 'æ±äº¬ç«™ä¸€ç•ªè¡—' },
                    { id: 206, category: 'Hotel', name: 'ä½å®¿ (Day 1-2)', hours: '', note: '', mapKeyword: 'https://maps.app.goo.gl/1ohkU9q4txhJ6PJP8ï¼ˆè«‹ä¿®æ­£ï¼‰' }
                ],
                [ // Day 3
                    { id: 301, category: 'Transport', name: 'å‰å¾€å¯Œå£«å±± (ç§Ÿè»Š)', hours: 'ä¸Šåˆ', note: 'å¾éŒ¦ç³¸ç”ºå‡ºç™¼ï¼Œ3å¤©2å¤œè‡ªé§•', mapKeyword: 'æ²³å£æ¹–ç§Ÿè»Š' },
                    { id: 302, category: 'Sightseeing', name: 'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨', hours: 'ä¸‹åˆ', note: 'å¤§çŸ³å…¬åœ’çœ‹å¯Œå£«å±±', mapKeyword: 'æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨' },
                    { id: 303, category: 'Sightseeing', name: 'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾', hours: 'ä¸‹åˆ', note: 'çˆ¬æ¨“æ¢¯çœ‹äº”é‡å¡”', mapKeyword: 'æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾' },
                    { id: 304, category: 'Sightseeing', name: 'é‡‘é³¥å±… & å•†åº—è¡—', hours: 'å‚æ™š', note: 'å¯Œå£«å‰ç”°æœ¬ç”ºé€š', mapKeyword: 'å¯Œå£«å‰ç”°æœ¬ç”ºé€š' },
                    { id: 305, category: 'Food', name: 'æ™šé¤', hours: 'æ™šä¸Š', note: 'è‡ªè¡Œçƒ¹é£ªæˆ–å•†åº—è¡—', mapKeyword: 'å¯Œå£«å‰ç”°æ™šé¤' }
                ],
                [ // Day 4
                    { id: 401, category: 'Sightseeing', name: 'å¹³é‡ä¹‹æ¿± (æ—¥å‡º)', hours: 'æ¸…æ™¨', note: 'çµ•ç¾é€†å¯Œå£«', mapKeyword: 'å¹³é‡ä¹‹æ¿±' },
                    { id: 402, category: 'Sightseeing', name: 'é•·æ± è¦ªæ°´å…¬åœ’ & ç™½é³¥æ¿±', hours: 'ä¸Šåˆ', note: 'å±±ä¸­æ¹–è‡ªè¡Œè»Š', mapKeyword: 'é•·æ± è¦ªæ°´å…¬åœ’' },
                    { id: 403, category: 'Food', name: 'åˆé¤ï¼šå±±ä¸­æ¹–é¤å»³', hours: 'ä¸­åˆ', note: '', mapKeyword: 'å±±ä¸­æ¹–åˆé¤' },
                    { id: 404, category: 'Sightseeing', name: 'KABA æ°´é™¸å·´å£«', hours: 'ä¸‹åˆ', note: 'æ—­æ—¥ä¸˜æ¹–ç•”ç¶ åœ°å…¬åœ’', mapKeyword: 'å±±ä¸­æ¹–KABA' },
                    { id: 405, category: 'Food', name: 'æ™šé¤ï¼šè¶…å¸‚æ¡è²·', hours: 'æ™šä¸Š', note: 'Oginoè¶…å¸‚', mapKeyword: 'Oginoæ²³å£æ¹–åº—' }
                ],
                [ // Day 5
                    { id: 501, category: 'Sightseeing', name: 'é‡‘é³¥å±… & æ²³å£æ¹–çºœè»Š', hours: 'æ—©ä¸Š', note: 'å¤©ä¸Šå±±å…¬åœ’é¦éŸ†', mapKeyword: 'æ²³å£æ¹–å¯Œå£«å±±å…¨æ™¯çºœè»Š' },
                    { id: 502, category: 'Food', name: 'Fujisan Shokupan', hours: 'é»å¿ƒ', note: 'ä¼´æ‰‹ç¦®åå¸', mapKeyword: 'Fujisan Shokupan' },
                    { id: 503, category: 'Transport', name: 'æ­ä¹˜å¯Œå£«å›éŠè¿”æ–°å®¿', hours: 'ä¸‹åˆ', note: 'é‚„è»Šå¾Œæ­è»Š', mapKeyword: 'æ²³å£æ¹–ç«™' },
                    { id: 504, category: 'Shopping', name: 'æ± è¢‹å¤ªé™½åŸ', hours: 'å‚æ™š', note: 'Sunshine City', mapKeyword: 'æ± è¢‹å¤ªé™½åŸ' },
                    { id: 505, category: 'Food', name: 'æ™šé¤ï¼šå¤ªé™½åŸå…§', hours: 'æ™šä¸Š', note: '', mapKeyword: 'æ± è¢‹å¤ªé™½åŸç¾é£Ÿ' }
                ],
                [ // Day 6
                    { id: 601, category: 'Transport', name: 'å‰å¾€è—¤æ¾¤', hours: 'ä¸Šåˆ', note: 'æ±Ÿä¹‹é›»ä¸€æ—¥éŠ', mapKeyword: 'è—¤æ¾¤ç«™' },
                    { id: 602, category: 'Sightseeing', name: 'æ±Ÿä¹‹é›»ä¹‹æ—…', hours: 'å…¨å¤©', note: 'è—¤æ¾¤ > æ±Ÿä¹‹å³¶ > éŒå€‰é«˜æ ¡å‰ > ä¸ƒé‡Œæ¿± > éŒå€‰', mapKeyword: 'æ±Ÿä¹‹å³¶' },
                    { id: 603, category: 'Food', name: 'åˆé¤ï¼šä¸ƒé‡Œæ¿±é¤å»³', hours: 'ä¸­åˆ', note: 'æµ·æ™¯é¤å»³', mapKeyword: 'ä¸ƒé‡Œæ¿±ç¾é£Ÿ' },
                    { id: 604, category: 'Transport', name: 'è¿”å›æ–°å®¿', hours: 'å‚æ™š', note: '', mapKeyword: 'æ–°å®¿ç«™' },
                    { id: 605, category: 'Food', name: 'æ™šé¤', hours: 'æ™šä¸Š', note: 'æ–°å®¿è»Šç«™æˆ–è‡ªç‚Š', mapKeyword: 'æ–°å®¿æ™šé¤' }
                ],
                [ // Day 7
                    { id: 701, category: 'Sightseeing', name: 'æ±äº¬éµå¡” & å…­æœ¬æœ¨/éº»å¸ƒå°', hours: 'ä¸Šåˆ', note: 'æ‹ç…§æ‰“å¡', mapKeyword: 'æ±äº¬éµå¡”' },
                    { id: 702, category: 'Food', name: 'åˆé¤ï¼šå…­æœ¬æœ¨å‘¨é­', hours: 'ä¸­åˆ', note: '', mapKeyword: 'å…­æœ¬æœ¨åˆé¤' },
                    { id: 703, category: 'Shopping', name: 'å‰å¾€æ¾€è°·', hours: 'ä¸‹åˆ', note: 'é€›è¡—', mapKeyword: 'æ¾€è°·' },
                    { id: 704, category: 'Sightseeing', name: 'SHIBUYA SKY', hours: 'å‚æ™š', note: 'çµ•ç¾å¤œæ™¯', mapKeyword: 'SHIBUYA SKY' },
                    { id: 705, category: 'Shopping', name: 'æ¾€è°·æœ€å¾Œæ¡è²·', hours: 'æ™šä¸Š', note: 'åå­—è·¯å£ã€è—¥å¦', mapKeyword: 'æ¾€è°·åå­—è·¯å£' }
                ],
                [ // Day 8
                    { id: 801, category: 'Sightseeing', name: 'è‡ªç”±è¡Œç¨‹', hours: 'ç™½å¤©', note: 'è£œè²¨æˆ–ä¼‘æ¯', mapKeyword: '' },
                    { id: 802, category: 'Transport', name: 'æˆç”°æ©Ÿå ´èµ·é£›', hours: '20:40', note: 'TR899', mapKeyword: 'æˆç”°æ©Ÿå ´' },
                    { id: 803, category: 'Transport', name: 'æŠµé”æ¡ƒåœ’', hours: '23:20', note: 'Sweet Home', mapKeyword: '' }
                ]
            ];

            const itineraryData = ref(defaultItinerary);
            const prepList = ref([{ text: 'è­·ç…§ (æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)', checked: false }, { text: 'é§•ç…§æ—¥æ–‡è­¯æœ¬ (è‡ªé§•å¿…å‚™)', checked: false }]);
            const shoppingList = ref([{ name: 'NY Perfect Cheese', tag: 'æ±äº¬å¿…è²·' }, { name: 'è±å³¶å±‹ é³©ä¸‰éƒé¤…ä¹¾', tag: 'éŒå€‰å¿…è²·' }, { name: 'å¯Œå£«å±±é€ å‹é¤…ä¹¾', tag: 'å¯Œå£«å±±å¿…è²·' }]);
            
            // 4. æ‰“å¡é»
            const photoArea = ref('Tokyo');
            const photoSpots = {
                'Tokyo': [
                    { name: 'SHIBUYA SKY', desc: '360åº¦æ±äº¬å¤œæ™¯ï¼Œé€æ˜æ‰¶æ¢¯å¿…æ‹', icon: 'ğŸ™ï¸', link: 'https://www.google.com/maps/search/?api=1&query=SHIBUYA+SKY' },
                    { name: 'èŠå…¬åœ’ (Prince Park)', desc: 'è·Ÿæ±äº¬éµå¡”åˆç…§çš„æœ€ä½³è‰åœ°', icon: 'ğŸ—¼', link: 'https://www.google.com/maps/search/?api=1&query=èŠå…¬åœ’' },
                    { name: 'éº»å¸ƒå° Hills', desc: 'æ±äº¬æœ€æ–°åœ°æ¨™ï¼Œæ³¢æµªå»ºç¯‰', icon: 'ğŸ¢', link: 'https://www.google.com/maps/search/?api=1&query=Azabudai+Hills' }
                ],
                'Kamakura': [
                    { name: 'éŒå€‰é«˜æ ¡å‰å¹³äº¤é“', desc: 'çŒç±ƒé«˜æ‰‹ç¶“å…¸å ´æ™¯', icon: 'ğŸšƒ', link: 'https://www.google.com/maps/search/?api=1&query=éŒå€‰é«˜æ ¡å‰é§…' },
                    { name: 'ä¸ƒé‡Œæ¿±æµ·å²¸', desc: 'çœ‹æµ·ã€çœ‹æ±Ÿä¹‹å³¶ã€çœ‹å¯Œå£«å±±', icon: 'ğŸŒŠ', link: 'https://www.google.com/maps/search/?api=1&query=ä¸ƒé‡Œæ¿±' }
                ],
                'Fuji': [
                    { name: 'å¯Œå£«å‰ç”°æœ¬ç”ºé€š', desc: 'å¾©å¤è¡—é“èˆ‡å·¨å¤§å¯Œå£«å±±', icon: 'ğŸ—»', link: 'https://www.google.com/maps/search/?api=1&query=å¯Œå£«å‰ç”°æœ¬ç”ºé€š' },
                    { name: 'æ²³å£æ¹– Lawson', desc: 'ä¾¿åˆ©å•†åº—ä¸Šçš„å¯Œå£«å±±', icon: 'ğŸª', link: 'https://www.google.com/maps/search/?api=1&query=Lawson+Kawaguchiko' },
                    { name: 'æ–°å€‰å±±æ·ºé–“å…¬åœ’', desc: 'äº”é‡å¡” x å¯Œå£«å±±', icon: 'â›©ï¸', link: 'https://www.google.com/maps/search/?api=1&query=æ–°å€‰å±±æ·ºé–“å…¬åœ’' }
                ]
            };

            // 5. è¨˜å¸³
            const expenseUsers = ref(['æˆ‘', 'æ—…ä¼´A', 'æ—…ä¼´B', 'å…¬è²»']);
            const currentUser = ref('æˆ‘');
            const exchangeRate = ref(0.22);
            const showTWD = ref(false);
            const expenses = ref([]);
            const editForm = ref({ name: '', hours: '', note: '', category: 'Sightseeing', mapKeyword: '' });
            const newExpense = ref({ name: '', amount: '', category: 'é£Ÿ' });

            // Computed
            const currentDayItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
            const filteredExpenses = computed(() => expenses.value.filter(e => e.user === currentUser.value));
            const filteredTotal = computed(() => filteredExpenses.value.reduce((sum, e) => sum + Number(e.amount), 0));

            // --- Weather Location Logic (V2.0 Core) ---
            const currentLocationKey = computed(() => {
                const day = selectedDayIndex.value;
                if (day >= 2 && day <= 4) return 'Fuji'; // Day 3,4,5
                if (day === 5) return 'Kamakura'; // Day 6
                return 'Tokyo'; 
            });
            const locationName = computed(() => {
                const map = { 'Tokyo': 'æ±äº¬ Tokyo', 'Fuji': 'å¯Œå£«å±± Fuji', 'Kamakura': 'éŒå€‰ Kamakura' };
                return map[currentLocationKey.value];
            });
            const isFujiArea = computed(() => currentLocationKey.value === 'Fuji');

            // Methods
            const changeDay = (index) => {
                selectedDayIndex.value = index;
                fetchWeather(); // åˆ‡æ›æ—¥æœŸæ™‚æ›´æ–°å¤©æ°£
            };
            const getMapLink = (keyword) => keyword.startsWith('http') ? keyword : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword)}`;
            const getBorderColor = (cat) => ({ 'Sightseeing': 'border-purple-300', 'Food': 'border-orange-300', 'Shopping': 'border-blue-300', 'Transport': 'border-gray-300', 'Hotel': 'border-pink-300' }[cat] || 'border-gray-200');

            const openAddModal = () => { isEditing.value = false; editForm.value = { name: '', hours: '', note: '', category: 'Sightseeing', mapKeyword: '' }; showModal.value = true; };
            const editItem = (item, idx) => { isEditing.value = true; editIndex.value = idx; editForm.value = { ...item }; showModal.value = true; };
            const saveItem = () => {
                const list = itineraryData.value[selectedDayIndex.value];
                isEditing.value ? list[editIndex.value] = { ...editForm.value, id: list[editIndex.value].id } : list.push({ ...editForm.value, id: Date.now() });
                showModal.value = false;
            };
            const deleteItem = (idx) => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) itineraryData.value[selectedDayIndex.value].splice(idx, 1); };

            const addUser = () => { const name = prompt('è¼¸å…¥æ–°ä½¿ç”¨è€…åç¨±ï¼š'); if(name) expenseUsers.value.push(name); };
            const openExpenseModal = () => { newExpense.value = { name: '', amount: '', category: 'é£Ÿ' }; showExpenseModal.value = true; };
            const addExpense = () => {
                if(!newExpense.value.name || !newExpense.value.amount) return;
                expenses.value.push({ id: Date.now(), user: currentUser.value, name: newExpense.value.name, amount: newExpense.value.amount, category: newExpense.value.category, date: `${new Date().getMonth()+1}/${new Date().getDate()}` });
                showExpenseModal.value = false;
            };
            const deleteExpense = (id) => expenses.value = expenses.value.filter(e => e.id !== id);
            const convert = (yen) => showTWD.value ? Math.round(yen * exchangeRate.value) : yen;

            const addPrepItem = () => { const text = prompt('æ–°å¢æº–å‚™äº‹é …ï¼š'); if(text) prepList.value.push({ text, checked: false }); };
            const removePrepItem = (idx) => prepList.value.splice(idx, 1);
            const addShopItem = () => { const name = prompt('æƒ³è²·ä»€éº¼ï¼Ÿ'); if(name) shoppingList.value.push({ name, tag: 'æœªåˆ†é¡' }); };

            const saveData = () => localStorage.setItem(STORAGE_KEY, JSON.stringify({ itinerary: itineraryData.value, prep: prepList.value, shopping: shoppingList.value, expenses: expenses.value, expenseUsers: expenseUsers.value, exchangeRate: exchangeRate.value }));
            const resetData = () => { if(confirm('ç¢ºå®šé‡ç½®ï¼Ÿ')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } };

            // --- Weather API (V2.0 Core) ---
            const fetchWeather = async () => {
                weatherDesc.value = 'æ›´æ–°ä¸­...';
                const coords = { 'Tokyo': { lat: 35.6895, lon: 139.6917 }, 'Fuji': { lat: 35.3606, lon: 138.7274 }, 'Kamakura': { lat: 35.3192, lon: 139.5467 } };
                const target = coords[currentLocationKey.value];
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${target.lat}&longitude=${target.lon}&current=temperature_2m,precipitation_probability,weather_code,cloud_cover&timezone=Asia%2FTokyo`);
                    const data = await res.json();
                    const current = data.current;
                    currentTemp.value = current.temperature_2m;
                    rainChance.value = current.precipitation_probability || 0;
                    
                    const code = current.weather_code;
                    if (code <= 3) { weatherIcon.value = 'ğŸŒ¤ï¸'; weatherDesc.value = 'æ˜¯å€‹å¥½å¤©æ°£ï¼'; weatherBackground.value = 'background: linear-gradient(to right, #60a5fa, #a78bfa)'; }
                    else if (code <= 67) { weatherIcon.value = 'â˜”'; weatherDesc.value = 'å¥½åƒåœ¨å“­å“­...'; weatherBackground.value = 'background: linear-gradient(to right, #475569, #64748b)'; }
                    else { weatherIcon.value = 'â˜ï¸'; weatherDesc.value = 'é™°é™°çš„æ„Ÿè¦º'; weatherBackground.value = 'background: linear-gradient(to right, #94a3b8, #cbd5e1)'; }

                    if (currentLocationKey.value === 'Fuji') {
                        let visibility = 100 - current.cloud_cover;
                        if (visibility < 0) visibility = 0;
                        fujiVisibility.value = visibility;
                    }
                } catch (e) { console.error("Weather API Error", e); weatherDesc.value = 'ç„¡æ³•å–å¾—å¤©æ°£'; }
            };

            onMounted(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        itineraryData.value = parsed.itinerary || defaultItinerary;
                        prepList.value = parsed.prep || prepList.value;
                        shoppingList.value = parsed.shopping || shoppingList.value;
                        expenses.value = parsed.expenses || [];
                        expenseUsers.value = parsed.expenseUsers || expenseUsers.value;
                        exchangeRate.value = parsed.exchangeRate || 0.22;
                    } catch(e) {}
                }
                const img = new Image(); img.src = './banner.jpg'; img.onerror = () => hasBanner.value = false;
                fetchWeather(); // Init Weather
                isMounted.value = true;
            });

            watch([itineraryData, prepList, shoppingList, expenses, expenseUsers, exchangeRate], saveData, { deep: true });

            return {
                isMounted, hasBanner, resetData, currentTab, selectedDayIndex, tripDays, changeDay, currentDayItinerary, getMapLink, getBorderColor,
                weatherIcon, currentTemp, rainChance, weatherDesc, fujiVisibility, weatherBackground, locationName, isFujiArea,
                showModal, isEditing, editForm, openAddModal, editItem, saveItem, deleteItem,
                prepList, addPrepItem, removePrepItem, shoppingList, addShopItem, photoArea, photoSpots,
                expenseUsers, currentUser, addUser, exchangeRate, showTWD, showExpenseModal, openExpenseModal, newExpense, addExpense, deleteExpense, filteredExpenses, filteredTotal, convert
            };
        }
    }).mount('#app');
</script>
</body>
</html>
