<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FFF0F5">
<title>é—œæ±ä¹‹æ—… 2026 (V18.00 Cloud Flagship)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>

<script>
    tailwind.config={theme:{extend:{colors:{'chii-pink':'#FFD1DC','chii-deep-pink':'#FF9EAC','chii-blue':'#A2D2FF','chii-yellow':'#FFF5BA','chii-text':'#5D4037'},fontFamily:{sans:['Zen Maru Gothic','sans-serif']},animation:{'wiggle':'wiggle 3s ease-in-out infinite','float':'float 3s ease-in-out infinite','fade-in':'fadeIn 0.5s ease-out forwards','spin-slow':'spin 8s linear infinite','pulse-slow':'pulse 3s infinite'},keyframes:{wiggle:{'0%,100%':{transform:'rotate(-3deg)'},'50%':{transform:'rotate(3deg)'}},float:{'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-5px)'}},fadeIn:{from:{opacity:0,transform:'translateY(10px)'},to:{opacity:1,transform:'translateY(0)'}}}}}}
</script>

<style>
    /* æ ¸å¿ƒèˆ‡é‡ç½® */
    html,body{margin:0;padding:0;width:100%;height:100%;background-color:#FFF0F5;background-image:radial-gradient(#FFD1DC 15%,transparent 16%),radial-gradient(#FFF5BA 15%,transparent 16%);background-size:60px 60px;background-position:0 0,30px 30px;font-family:"Zen Maru Gothic",sans-serif;color:#5D4037;overflow-x:hidden;-webkit-tap-highlight-color:transparent;padding-bottom:env(safe-area-inset-bottom)}
    input, textarea, select { font-size: 16px !important; font-family: inherit; }
    #app{display:block;min-height:100vh}
    [v-cloak]{display:none !important}
    .hide-scrollbar::-webkit-scrollbar{display:none}.hide-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    
    /* UI å…ƒä»¶æ¨£å¼ */
    .card{background:rgba(255,255,255,0.85);border-radius:24px;box-shadow:0 8px 32px rgba(255,105,180,0.1);border:1px solid rgba(255,255,255,0.9);margin-bottom:16px;position:relative;overflow:hidden;backdrop-filter:blur(12px);transition:transform 0.2s}
    .card:active { transform: scale(0.99); }
    
    /* æ‡¸æµ®æŒ‰éˆ• */
    .fab-home{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);width:68px;height:68px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:white;z-index:900;border:4px solid white;box-shadow:0 10px 25px rgba(255,105,180,0.5);background:linear-gradient(135deg,#FF9EAC,#FFD1DC);cursor:grab;touch-action:none;transition:transform 0.2s}
    .fab-home:active{transform:translateX(-50%) scale(0.9);}
    .fab-main{position:fixed;bottom:calc(110px + env(safe-area-inset-bottom));right:20px;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;color:white;z-index:40;border:3px solid white;box-shadow:0 8px 20px rgba(0,0,0,0.15);background-color:#ff9eac;transition:all 0.2s}
    
    /* Google æœå°‹çƒ (å·¦ä¸‹è§’) */
    .google-float { position: fixed; bottom: 30px; left: 20px; z-index: 800; display: flex; align-items: center; justify-content: flex-start; }
    .google-btn { width: 50px; height: 50px; border-radius: 50%; background: white; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #4285F4; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s; }
    .google-bar { width: 0; overflow: hidden; height: 50px; background: white; border-radius: 25px; display: flex; align-items: center; transition: width 0.3s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s; opacity: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-left: 10px; }
    .google-float.active .google-bar { width: 200px; opacity: 1; padding: 0 15px; }

    /* æ©Ÿç¥¨èˆ‡ç¥¨åˆ¸ */
    .boarding-pass { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.05); border: 1px solid white; margin-bottom: 20px; position: relative; }
    .cut-line { border-top: 2px dashed #ddd; position: relative; margin: 20px 0; }
    .cut-line::before, .cut-line::after { content: ''; position: absolute; top: -12px; width: 24px; height: 24px; background: #FFF0F5; border-radius: 50%; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
    .cut-line::before { left: -12px; } .cut-line::after { right: -12px; }

    /* æ­¡è¿é  */
    .welcome-screen{position:fixed;inset:0;z-index:9999;background:#FFF0F5;transition:transform 0.8s cubic-bezier(0.7,0,0.3,1); cursor: pointer;}
    .welcome-screen.hidden-screen{transform:translateY(-100%);pointer-events:none}
    
    /* ç‰¹æ•ˆ */
    .sakura{position:fixed;top:-10px;background:#FFB7B2;border-radius:100% 0 100% 0;opacity:0.6;animation:fall linear infinite;z-index:0;pointer-events:none;width:14px;height:14px; box-shadow: 0 2px 5px rgba(255,105,180,0.2);}
    @keyframes fall{to{transform:translate(15vw,105vh) rotate(360deg)}}
</style>
</head>
<body>

<div id="crash-screen" style="display:none; position:fixed; inset:0; background:#fff; z-index:100000; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px;">
    <div class="text-6xl mb-4">ğŸ˜¿</div>
    <h2 class="text-2xl font-black mb-2 text-red-500">å‰ä¼Šå¡å“‡è·Œå€’äº†</h2>
    <p class="text-gray-500 text-sm mb-4">ç³»çµ±åµæ¸¬åˆ°ç•°å¸¸ï¼Œè«‹å˜—è©¦é‡æ•´ã€‚</p>
    <button onclick="location.reload()" class="bg-red-500 text-white px-8 py-3 rounded-full font-bold">é‡æ–°æ•´ç†</button>
    <pre id="error-log" class="mt-4 text-[10px] text-gray-400 bg-gray-100 p-2 rounded text-left overflow-auto max-w-xs"></pre>
</div>
<script>window.onerror=function(m,u,l){document.getElementById('crash-screen').style.display='flex';document.getElementById('error-log').innerText=`${m}\nLn:${l}`;return false;}</script>

<div id="sakura-container"></div>

<div id="app" v-cloak>
    
    <div :class="['welcome-screen flex flex-col items-center justify-between', isWelcomeClosed ? 'hidden-screen' : '']" @click="enterSite">
        <div class="absolute inset-0 z-0"><img :src="getImg('welcome.jpg')" class="w-full h-full object-cover opacity-90"></div>
        <div class="relative z-10 mt-40 text-center px-6">
            <div class="inline-block bg-white/40 backdrop-blur-md px-6 py-2 rounded-full text-white text-xs font-black tracking-[0.2em] border border-white/50 mb-6 animate-float shadow-lg">TOKYO â€¢ FUJI â€¢ KAMAKURA</div>
            <h1 class="text-7xl font-black text-white drop-shadow-lg tracking-widest mb-2 font-sans" style="text-shadow: 0 4px 10px rgba(255,105,180,0.3);">é—œæ±ä¹‹æ—…</h1>
            <p class="text-3xl text-white/90 font-bold tracking-widest drop-shadow-md">2026.03.27</p>
        </div>
        <div class="relative z-10 mb-28 w-full px-10 pb-[env(safe-area-inset-bottom)]">
            <div class="w-full bg-white/90 text-pink-500 font-black py-5 rounded-full shadow-2xl backdrop-blur-xl text-xl flex items-center justify-center gap-3 border border-white animate-pulse-slow">
                <span class="animate-spin-slow">ğŸŒ¸</span> é»æ“Šä»»æ„è™•é–‹å§‹
            </div>
        </div>
    </div>

    <div v-if="currentView !== 'menu'" class="fixed top-0 left-0 right-0 h-[64px] bg-[#FFF0F5]/85 backdrop-blur-xl z-30 flex items-center justify-between px-4 border-b border-white/50 shadow-sm pt-[env(safe-area-inset-top)] box-content transition-all">
        <button @click="currentView='menu'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pink-400 shadow-md border border-white active:scale-90 transition"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="font-black text-gray-700 text-lg flex items-center gap-2"><i class="fa-solid fa-sakura text-pink-300"></i> {{getPageTitle(currentView)}}</h1>
        <button @click="handleAuthClick" :class="['w-auto px-4 h-10 rounded-full flex items-center justify-center shadow-md border border-white active:scale-90 transition text-xs font-bold gap-2', isLoggedIn ? 'bg-pink-500 text-white' : 'bg-white text-gray-500']">
            <i :class="isLoggedIn ? 'fa-solid fa-user-check' : 'fa-regular fa-user'"></i> {{isLoggedIn ? 'ç™»å‡º' : 'ç™»å…¥'}}
        </button>
    </div>
    <div v-if="currentView !== 'menu'" class="h-[64px] pt-[env(safe-area-inset-top)] box-content"></div>

    <div :class="['google-float', showGoogleSearch?'active':'']" v-if="isWelcomeClosed">
        <div class="google-btn" @click="showGoogleSearch=!showGoogleSearch"><i class="fa-brands fa-google"></i></div>
        <div class="google-bar"><form action="https://www.google.com/search" target="_blank" class="w-full flex"><input name="q" placeholder="Google..." class="w-full bg-transparent outline-none text-base text-gray-700 font-bold placeholder-gray-300"><button type="submit" class="text-blue-500 px-2"><i class="fa-solid fa-magnifying-glass"></i></button></form></div>
    </div>

    <div v-if="currentView==='menu'" class="min-h-screen p-6 pt-12 flex flex-col pb-40 animate-fade-in">
        <h2 class="text-3xl font-black text-gray-700 mb-8 text-center pt-[env(safe-area-inset-top)]">æ—…ç¨‹åŠŸèƒ½</h2>
        <div class="mb-8 bg-white/70 backdrop-blur-xl border border-white rounded-[32px] p-6 shadow-xl relative overflow-hidden group">
             <div class="absolute -right-5 -top-5 w-24 h-24 bg-yellow-100 rounded-full blur-2xl opacity-50"></div>
             <div class="flex items-start gap-4 relative z-10">
                 <div class="bg-gradient-to-br from-yellow-200 to-yellow-400 w-12 h-12 rounded-2xl flex items-center justify-center text-white text-xl shrink-0 shadow-lg"><i class="fa-solid fa-bell"></i></div>
                 <div class="flex-1">
                     <div class="font-black text-gray-800 text-lg mb-1">å€’æ•¸ {{daysUntilTrip}} å¤©</div>
                     <div class="text-xs text-gray-500 font-bold leading-relaxed">
                        <p>ğŸ“¢ <span class="text-pink-500">é‡è¦æé†’ï¼š</span></p>
                        <ul class="list-disc pl-4 mt-1 space-y-1">
                            <li>å‡ºç™¼å‰è«‹ç¢ºèªè­·ç…§æœ‰æ•ˆæœŸ > 6å€‹æœˆ</li>
                            <li>Visit Japan Web è«‹æˆªåœ– QR Code</li>
                            <li>æ—¥å¹£ç¾é‡‘è«‹è‡³å°‘æ”œå¸¶ 10 è¬å††</li>
                        </ul>
                     </div>
                 </div>
             </div>
        </div>
        <div class="grid grid-cols-3 gap-x-4 gap-y-8 px-2">
            <div v-for="app in apps" :key="app.id" class="flex flex-col items-center cursor-pointer active:scale-95 transition duration-300 group" @click="currentView=app.view">
                <div class="w-[76px] h-[76px] rounded-[30px] flex items-center justify-center text-3xl text-white shadow-lg border-[4px] border-white relative overflow-hidden" :class="app.bgClass"><i :class="app.icon"></i></div>
                <span class="text-sm font-bold mt-3 text-gray-600 group-hover:text-pink-500 transition">{{app.name}}</span>
            </div>
        </div>
    </div>

    <div v-if="currentView==='itinerary'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="flex overflow-x-auto gap-3 mb-6 hide-scrollbar sticky top-[68px] bg-[#FFF0F5]/95 z-20 py-3 -mx-5 px-5 backdrop-blur-md">
             <button v-for="(d,i) in tripDays" :key="i" @click="selectedDayIndex=i" :class="['px-6 py-3 rounded-2xl text-sm font-black border-2 transition shrink-0 shadow-sm flex flex-col items-center min-w-[70px]',selectedDayIndex===i?'bg-pink-400 text-white border-pink-400 shadow-lg scale-105':'bg-white text-gray-300 border-white']"><span>{{d.week}}</span><span class="text-[10px] mt-1 opacity-80">{{d.title}}</span></button>
        </div>
        
        <div class="space-y-4">
            <div v-for="(item,idx) in currentItinerary" :key="idx" class="card p-5 border-0 shadow-sm relative group">
                <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-pink-300 to-pink-100"></div>
                <div class="flex gap-4">
                    <div class="flex flex-col items-center pt-1 min-w-[50px]">
                        <input v-if="isLoggedIn" v-model="item.hours" class="w-full text-xs font-black text-gray-400 mb-2 bg-gray-50 rounded p-1 text-center" @change="saveData">
                        <span v-else class="text-xs font-black text-gray-400 mb-2">{{item.hours}}</span>
                        
                        <div class="w-10 h-10 rounded-full bg-pink-50 text-pink-400 flex items-center justify-center text-lg border border-pink-100"><i :class="getIconByCategory(item.category)"></i></div>
                    </div>
                    <div class="flex-1 py-1">
                        <div v-if="isLoggedIn" class="mb-2 space-y-2">
                             <input v-model="item.name" class="w-full font-black text-gray-800 text-lg bg-gray-50 rounded p-1" placeholder="åç¨±" @change="saveData">
                             <input v-model="item.mapKeyword" class="w-full text-xs text-blue-500 bg-blue-50 rounded p-1" placeholder="åœ°åœ–é—œéµå­—" @change="saveData">
                             <textarea v-model="item.note" class="w-full text-sm text-gray-500 bg-gray-50 rounded p-1 h-16" placeholder="å‚™è¨»" @change="saveData"></textarea>
                        </div>
                        <div v-else>
                            <h3 class="font-black text-gray-800 text-lg mb-1">{{item.name}}</h3>
                            <p class="text-sm text-gray-500 line-clamp-2 font-medium mb-2">{{item.note}}</p>
                        </div>
                        <a :href="getMapLink(item.mapKeyword || item.name)" target="_blank" class="inline-flex items-center gap-1 text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded-full font-bold border border-blue-100 hover:bg-blue-100 transition"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                    </div>
                </div>
            </div>
            <button v-if="isLoggedIn" @click="addItineraryItem" class="w-full py-3 rounded-2xl bg-gray-100 text-gray-400 font-bold border-2 border-dashed border-gray-300 hover:border-pink-300 hover:text-pink-400 transition">+ æ–°å¢è¡Œç¨‹</button>
        </div>
    </div>

    <div v-if="currentView==='money'" class="px-5 py-4 pb-40 animate-fade-in">
         <div class="flex gap-2 mb-4 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm">
             <button @click="moneyTab='record'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='record'?'bg-yellow-400 text-white shadow-md':'text-gray-400']">è¨˜å¸³</button>
             <button @click="moneyTab='split'" :class="['px-6 py-2 rounded-full font-bold transition text-sm',moneyTab==='split'?'bg-blue-400 text-white shadow-md':'text-gray-400']">åˆ†å¸³</button>
         </div>
         
         <div class="mb-4 bg-white/80 p-3 rounded-xl flex justify-between items-center text-xs font-bold text-gray-600 shadow-sm border border-white">
             <span>å³æ™‚åŒ¯ç‡ (åƒè€ƒ)</span>
             <div class="flex items-center gap-2">
                 <span class="bg-gray-100 px-2 py-1 rounded">1 JPY â‰ˆ {{exchangeRate}} TWD</span>
                 <button @click="fetchRate" class="text-blue-500"><i class="fa-solid fa-rotate"></i></button>
             </div>
         </div>

         <div class="flex justify-end mb-2 gap-2">
             <button @click="displayCurrency='JPY'" :class="['text-xs px-2 py-1 rounded font-bold', displayCurrency==='JPY'?'bg-yellow-100 text-yellow-600':'bg-gray-100 text-gray-400']">JPY</button>
             <button @click="displayCurrency='TWD'" :class="['text-xs px-2 py-1 rounded font-bold', displayCurrency==='TWD'?'bg-yellow-100 text-yellow-600':'bg-gray-100 text-gray-400']">TWD</button>
         </div>

         <div v-if="moneyTab==='record'">
             <div class="card p-6 bg-gradient-to-br from-yellow-300 to-orange-400 text-white border-none shadow-orange-200">
                <div class="text-xs font-bold opacity-80 mb-1">ç¸½æ”¯å‡º ({{displayCurrency}})</div>
                <div class="text-4xl font-black">{{formatMoney(userPersonalTotal)}}</div>
             </div>
             <div class="space-y-3 mt-4">
                <div v-for="exp in personalExpenses" :key="exp.id" class="card p-4 flex justify-between items-center !mb-0 !rounded-2xl">
                    <div><div class="font-bold text-gray-800">{{exp.name}}</div><div class="text-xs text-gray-400">{{exp.date}}</div></div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-lg text-gray-700">{{formatMoney(exp.amount)}}</span>
                        <button v-if="isLoggedIn" @click="deleteExpense(exp.id)" class="text-red-300"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
             </div>
             <button v-if="isLoggedIn" @click="openExpenseModal('personal')" class="fab-main bg-yellow-400 text-white"><i class="fa-solid fa-pen"></i></button>
         </div>
    </div>

    <div v-if="currentView==='hotel'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="flex gap-2 mb-6 justify-center bg-white/50 p-1 rounded-full w-max mx-auto backdrop-blur-sm">
            <button @click="hotelTab='stay'" :class="['px-5 py-2 rounded-full font-bold text-xs',hotelTab==='stay'?'bg-indigo-500 text-white':'text-gray-400']">ä½å®¿</button>
            <button @click="hotelTab='flight'" :class="['px-5 py-2 rounded-full font-bold text-xs',hotelTab==='flight'?'bg-pink-500 text-white':'text-gray-400']">æ©Ÿç¥¨éŒ¢åŒ…</button>
            <button @click="hotelTab='car'" :class="['px-5 py-2 rounded-full font-bold text-xs',hotelTab==='car'?'bg-green-500 text-white':'text-gray-400']">ç§Ÿè»Š</button>
        </div>
        
        <div v-if="hotelTab==='stay'" class="space-y-6">
            <div v-for="h in hotels" class="card !p-0 border-0 shadow-xl group overflow-hidden">
                <div class="h-40 bg-gray-200 relative"><img :src="h.img" class="w-full h-full object-cover"><div class="absolute bottom-4 left-5 text-white shadow-black drop-shadow-md"><h3 class="font-black text-2xl">{{h.name}}</h3></div></div>
                <div class="p-4"><a :href="getMapLink(h.name)" target="_blank" class="w-full flex items-center justify-center gap-2 bg-indigo-50 text-indigo-600 font-bold py-3 rounded-xl border border-indigo-100"><i class="fa-solid fa-location-dot"></i> å°èˆªå‰å¾€</a></div>
            </div>
        </div>

        <div v-if="hotelTab==='flight'" class="animate-fade-in">
            <div class="bg-red-50 p-4 rounded-2xl border border-red-100 mb-6 text-xs text-red-600 font-bold leading-relaxed">
                <i class="fa-solid fa-triangle-exclamation mr-1"></i> æ³¨æ„äº‹é …ï¼š
                <ul class="list-disc pl-4 mt-1">
                    <li>è«‹å‹™å¿…åˆ—å°ç´™æœ¬é›»å­æ©Ÿç¥¨å‚™æŸ¥ã€‚</li>
                    <li>é…·èˆªé—œæ«ƒæ™‚é–“ç‚ºèµ·é£›å‰ 60 åˆ†é˜ï¼Œè«‹åš´æ ¼éµå®ˆã€‚</li>
                    <li>è¡Œå‹•é›»æºèˆ‡é‹°é›»æ± å¿…é ˆéš¨èº«æ”œå¸¶ï¼Œä¸å¯è¨—é‹ã€‚</li>
                </ul>
            </div>
            <div class="grid grid-cols-1 gap-4">
                <div v-for="user in users" :key="user.id" class="boarding-pass p-0">
                     <div class="bg-gray-50 p-4 flex items-center gap-3 border-b border-dashed">
                         <div class="w-12 h-12 rounded-full bg-white border shadow-sm overflow-hidden flex items-center justify-center text-2xl" @click="isLoggedIn && triggerAvatarUpload(user)">
                             <img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover">
                             <span v-else>{{user.icon}}</span>
                         </div>
                         <div class="flex-1">
                             <input v-if="isLoggedIn" v-model="user.name" class="font-black text-gray-800 bg-transparent border-b border-gray-300 w-full" placeholder="å§“å">
                             <div v-else class="font-black text-gray-800">{{user.name}}</div>
                         </div>
                     </div>
                     <div class="p-4 space-y-3">
                         <div class="flex justify-between items-center text-xs text-gray-500 font-bold bg-pink-50 p-2 rounded">
                             <span>å»ç¨‹ (TR898)</span>
                             <input v-if="isLoggedIn" v-model="user.flightOutSeat" class="w-16 text-right bg-white rounded px-1" placeholder="åº§ä½">
                             <span v-else>åº§ä½: {{user.flightOutSeat||'--'}}</span>
                         </div>
                         <div class="flex justify-between items-center text-xs text-gray-500 font-bold bg-green-50 p-2 rounded">
                             <span>å›ç¨‹ (BR197)</span>
                             <input v-if="isLoggedIn" v-model="user.flightInSeat" class="w-16 text-right bg-white rounded px-1" placeholder="åº§ä½">
                             <span v-else>åº§ä½: {{user.flightInSeat||'--'}}</span>
                         </div>
                     </div>
                </div>
            </div>
        </div>

        <div v-if="hotelTab==='car'" class="animate-fade-in">
             <div class="card p-5 border-l-4 border-green-500 mb-4">
                 <h3 class="font-black text-lg mb-2">ğŸš— æ¨è–¦ç§Ÿè»Šï¼šToyota Rent a Car</h3>
                 <p class="text-sm text-gray-600 mb-3">ä½æ–¼æ²³å£æ¹–ç«™æ­£å°é¢ï¼Œè·é›¢ Megu Fuji ä½å®¿é»æœ€è¿‘ï¼Œå–é‚„è»Šæœ€æ–¹ä¾¿ã€‚</p>
                 <a href="https://rent.toyota.co.jp/zh-tw/" target="_blank" class="block text-center bg-green-500 text-white font-bold py-2 rounded-xl shadow-md active:scale-95 transition">å‰å¾€é ç´„å®˜ç¶²</a>
             </div>
             <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                 <h4 class="font-bold text-gray-700 mb-3 text-sm">è‡ªé§•å¿…å‚™æ¸…å–®</h4>
                 <ul class="space-y-2 text-sm text-gray-600">
                     <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> å°ç£é§•ç…§æ­£æœ¬</li>
                     <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> æ—¥æ–‡è­¯æœ¬ (ç›£ç†æ‰€)</li>
                     <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> è­·ç…§</li>
                     <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> ETC å¡ (å»ºè­°ç§Ÿç”¨)</li>
                 </ul>
             </div>
        </div>
    </div>

    <div v-if="currentView==='prep'" class="px-5 py-4 pb-40 animate-fade-in">
        <h3 class="font-black text-xl text-gray-700 mb-4">è¡Œå‰æª¢æŸ¥</h3>
        
        <div class="card p-5 bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200 mb-6">
            <h4 class="font-bold text-blue-800 text-sm mb-3"><i class="fa-solid fa-ticket"></i> è¡Œç¨‹æ‰€éœ€ç¥¨åˆ¸ (è‡ªå‹•åµæ¸¬)</h4>
            <div v-if="suggestedTickets.length > 0" class="space-y-2">
                <a v-for="t in suggestedTickets" :href="t.link" target="_blank" class="flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-blue-100 active:scale-95 transition">
                    <span class="text-sm font-bold text-gray-700">{{t.name}}</span>
                    <span class="text-xs text-blue-500 bg-blue-50 px-2 py-1 rounded">è³¼è²· <i class="fa-solid fa-arrow-right"></i></span>
                </a>
            </div>
            <div v-else class="text-xs text-gray-400">ç›®å‰è¡Œç¨‹ç„¡éœ€ç‰¹æ®Šç¥¨åˆ¸ï¼Œæˆ–è«‹æ‰‹å‹•æª¢æŸ¥ã€‚</div>
        </div>

        <div class="card p-4 border-l-4 border-red-500 mb-6">
            <div class="flex justify-between items-center mb-2">
                <span class="font-black text-gray-700">å¯Œå£«å›éŠ 3å·</span>
                <span class="text-xs bg-red-100 text-red-500 px-2 py-1 rounded font-bold">å¿…è²·</span>
            </div>
            <p class="text-xs text-gray-500 mb-3">éŒ¦ç³¸ç”º(07:08) ç›´é” æ²³å£æ¹–(09:28)ã€‚å…¨è»ŠæŒ‡å®šå¸­ã€‚</p>
            <a href="https://www.eki-net.com/zh-CHT/common/top/index" target="_blank" class="block w-full text-center bg-red-500 text-white font-bold py-2 rounded-lg text-sm">å‰å¾€ JR è¨‚ç¥¨</a>
        </div>

        <div v-for="user in users" :key="user.id" class="mb-4">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden"><img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover"></div>
                <div class="font-bold text-gray-700">{{user.name}} çš„è¡Œæ</div>
            </div>
            <div class="card p-0">
                <div v-for="(item, idx) in user.list" :key="idx" class="flex items-center p-3 border-b border-gray-100 last:border-0">
                    <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-pink-500 mr-3" @change="saveData">
                    <span :class="['flex-1 text-sm font-medium', item.checked?'text-gray-300 line-through':'text-gray-700']">{{item.text}}</span>
                    <button v-if="isLoggedIn" @click="user.list.splice(idx,1);saveData()" class="text-gray-300"><i class="fa-solid fa-times"></i></button>
                </div>
                <button v-if="isLoggedIn" @click="addPrepItem(user)" class="w-full py-2 text-center text-xs text-gray-400 font-bold hover:bg-gray-50">+ æ–°å¢é …ç›®</button>
            </div>
        </div>
    </div>

    <div v-if="currentView==='shopping'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="grid grid-cols-2 gap-3 mb-6">
            <a href="https://www.cosme.net/ranking/" target="_blank" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center gap-2 active:scale-95 transition">
                <span class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xl font-bold">C</span>
                <span class="text-xs font-bold text-gray-600">@COSME å¤§è³</span>
            </a>
            <a href="https://www.shinyusha.co.jp/media/ldk-the-beauty/" target="_blank" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center gap-2 active:scale-95 transition">
                <span class="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center text-xl font-bold">L</span>
                <span class="text-xs font-bold text-gray-600">LDK æ¯’èˆŒé›œèªŒ</span>
            </a>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div v-for="(item,idx) in shoppingList.wish" class="card !p-0 border-0 shadow-lg" :key="idx">
                 <div class="h-32 bg-gray-100 relative"><img :src="item.img" class="w-full h-full object-cover" @error="handleImgError"></div>
                 <div class="p-3">
                     <div class="font-bold text-gray-800 text-sm mb-1">{{item.name}}</div>
                     <div class="text-[10px] text-gray-400 mb-2">{{item.desc}}</div>
                     <a :href="getMapLink(item.name)" target="_blank" class="block text-center bg-gray-50 text-gray-500 text-[10px] py-1.5 rounded font-bold">æ‰¾åº—èˆ–</a>
                 </div>
            </div>
        </div>
    </div>

    <div v-if="currentView==='weather'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="grid grid-cols-2 gap-3 mb-6">
             <a href="https://n-kishou.com/corp/news-contents/sakura/" target="_blank" class="bg-pink-50 p-3 rounded-xl border border-pink-200 text-center text-xs font-bold text-pink-500 shadow-sm">æ°£è±¡æ ªå¼æœƒç¤¾ ğŸŒ¸</a>
             <a href="https://weathernews.jp/s/sakura/" target="_blank" class="bg-blue-50 p-3 rounded-xl border border-blue-200 text-center text-xs font-bold text-blue-500 shadow-sm">Weathernews ğŸŒ¸</a>
        </div>
        <div class="space-y-4">
            <div v-for="loc in weatherData" class="card p-5 relative overflow-hidden text-white" :class="loc.bg">
                <div class="relative z-10">
                    <div class="text-xs font-bold opacity-80 uppercase tracking-widest">{{loc.name}}</div>
                    <div class="text-5xl font-black my-2">{{loc.temp}}Â°C</div>
                    <div class="text-sm font-medium bg-white/20 backdrop-blur inline-block px-3 py-1 rounded-full">ğŸ‘• {{getClothingAdvice(loc.temp)}}</div>
                </div>
                <i class="fa-solid fa-cloud-sun absolute -right-5 -bottom-5 text-9xl opacity-20"></i>
            </div>
        </div>
    </div>

    <div v-if="currentView==='japanese'" class="px-5 py-4 pb-40 animate-fade-in">
        <div class="fixed top-24 left-5 right-5 h-64 bg-black rounded-3xl overflow-hidden shadow-2xl z-10 border-2 border-white/50 group" @click="$refs.cameraInput.click()">
             <div class="absolute inset-0 flex flex-col items-center justify-center text-white/50 group-hover:text-white transition">
                 <i class="fa-solid fa-camera text-4xl mb-2"></i>
                 <span class="text-sm font-bold">é»æ“Šå•Ÿå‹•ç›¸æ©Ÿç¿»è­¯</span>
             </div>
             <div class="absolute top-0 left-0 w-full h-1 bg-blue-400/80 shadow-[0_0_15px_rgba(59,130,246,1)] animate-[scan_2s_linear_infinite]"></div>
        </div>
        <input type="file" ref="cameraInput" accept="image/*" capture="environment" class="hidden">
        
        <div class="mt-72 space-y-3">
             <div v-for="p in japanesePhrases" class="card p-4 flex justify-between items-center" @click="speak(p.jp)">
                 <div><div class="font-bold text-lg">{{p.jp}}</div><div class="text-xs text-gray-500">{{p.tw}}</div></div>
                 <i class="fa-solid fa-volume-high text-pink-400"></i>
             </div>
        </div>
    </div>

    <div v-show="currentView!=='menu'" class="fab-home" @click="currentView='menu'" @touchstart.prevent="startDrag" @mousedown.prevent="startDrag"><i class="fa-solid fa-house"></i></div>

    <div v-if="showLoginModal" class="fixed inset-0 z-[9999] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm animate-fade-in">
        <div class="bg-white w-full max-w-xs rounded-[32px] p-8 shadow-2xl relative">
            <button @click="showLoginModal=false" class="absolute top-4 right-4 text-gray-300 w-8 h-8 flex items-center justify-center rounded-full bg-gray-100"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-2xl font-black text-center mb-6 text-gray-800">ç®¡ç†å“¡ç™»å…¥</h3>
            <div class="space-y-4">
                <input v-model="loginForm.email" type="email" placeholder="Email" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold border focus:border-pink-400 transition">
                <input v-model="loginForm.password" type="password" placeholder="Password" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold border focus:border-pink-400 transition">
                <button @click="doLogin" class="w-full py-4 bg-pink-500 text-white font-black rounded-2xl shadow-lg shadow-pink-200 active:scale-95 transition">ç™»å…¥ (Login)</button>
            </div>
        </div>
    </div>

    <input type="file" ref="avatarInput" accept="image/*" class="hidden" @change="processAvatarUpload">

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3.3.4/dist/vue.esm-browser.js";

// --- æ‚¨çš„ Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyD3ojbkJVfDKmZQHRpZG-gp8gv7ajKdJr4",
  authDomain: "tokyo-trip-24b28.firebaseapp.com",
  projectId: "tokyo-trip-24b28",
  storageBucket: "tokyo-trip-24b28.firebasestorage.app",
  messagingSenderId: "518699705070",
  appId: "1:518699705070:web:56e95f603210d8d5d209ff"
};
// -----------------------------------------------------

// åˆå§‹åŒ– Firebase (å¦‚æœæœ‰è¨­å®šæ‰è·‘ï¼Œé¿å…å ±éŒ¯)
let auth, db;
try {
    const app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
} catch (e) {
    console.warn("Firebase æœªè¨­å®šï¼Œå°‡é‹è¡Œåœ¨æœ¬åœ°æ¼”ç¤ºæ¨¡å¼ã€‚è«‹å¡«å…¥ Config ä»¥å•Ÿç”¨é›²ç«¯åŒæ­¥ã€‚", e);
}

// é è¨­è³‡æ–™ (è‹¥é›²ç«¯ç„¡è³‡æ–™æ™‚ä½¿ç”¨)
const defaultData = {
    itinerary: Array(8).fill([]).map((_,i)=>i===2?[
        {hours:"07:08",category:"Transport",name:"å¯Œå£«å›éŠ3è™Ÿ",mapKeyword:"Kinshicho Station",note:"éŒ¦ç³¸ç”ºç™¼è»Šï¼Œç›´é”æ²³å£æ¹–"},
        {hours:"09:28",category:"Sightseeing",name:"æŠµé”æ²³å£æ¹–",mapKeyword:"Kawaguchiko Station",note:"å‡ºç«™å°é¢ç§Ÿè»Š"},
        {hours:"12:00",category:"Food",name:"ä¸å‹•èŒ¶å±‹",mapKeyword:"Houtou Fudou Higashikoiji",note:"æ±æˆ€è·¯åº—"}
    ]:[]),
    expenses: [],
    users: [
        {id:1, name:'å‰ä¼Š', icon:'ğŸ¹', list:['è­·ç…§','æ—¥å¹£'], flightOutSeat:'', flightInSeat:''},
        {id:2, name:'å°å…«', icon:'ğŸ±', list:['è­·ç…§','æ—¥å¹£'], flightOutSeat:'', flightInSeat:''}
    ]
};

createApp({
    setup() {
        const currentView = ref('welcome');
        const isWelcomeClosed = ref(false);
        const showGoogleSearch = ref(false);
        const isLoggedIn = ref(false); // ç™»å…¥ç‹€æ…‹
        const showLoginModal = ref(false);
        const loginForm = ref({email:'', password:''});
        
        // è³‡æ–™ State
        const itineraryData = ref(defaultData.itinerary);
        const expenses = ref([]);
        const users = ref(defaultData.users);
        const daysUntilTrip = ref(Math.ceil((new Date('2026-03-27') - new Date())/(1000*60*60*24)));
        const selectedDayIndex = ref(0);
        
        // åŒ¯ç‡èˆ‡é‡‘éŒ¢
        const exchangeRate = ref(0.21); // é è¨­
        const displayCurrency = ref('JPY');
        const moneyTab = ref('record');

        // UI ç›¸é—œ
        const hotelTab = ref('stay');
        const apps = [
            {id:1,name:'è¡Œç¨‹',icon:'fa-solid fa-map-location-dot',bgClass:'bg-pink-400',view:'itinerary'},
            {id:2,name:'å°è²¡åº«',icon:'fa-solid fa-sack-dollar',bgClass:'bg-yellow-400',view:'money'},
            {id:3,name:'ä½å®¿äº¤é€š',icon:'fa-solid fa-plane-arrival',bgClass:'bg-indigo-400',view:'hotel'},
            {id:4,name:'è¡Œå‰æº–å‚™',icon:'fa-solid fa-suitcase-rolling',bgClass:'bg-blue-400',view:'prep'},
            {id:5,name:'å¿«æ¨‚è³¼',icon:'fa-solid fa-bag-shopping',bgClass:'bg-purple-400',view:'shopping'},
            {id:6,name:'å¤©æ°£é€±å ±',icon:'fa-solid fa-cloud-sun',bgClass:'bg-sky-400',view:'weather'},
            {id:7,name:'ç¿»è­¯é†¬',icon:'fa-solid fa-language',bgClass:'bg-emerald-400',view:'japanese'}
        ];
        const tripDays = [{week:'D1',title:'3/27'},{week:'D2',title:'3/28'},{week:'D3',title:'3/29'},{week:'D4',title:'3/30'},{week:'D5',title:'3/31'},{week:'D6',title:'4/01'},{week:'D7',title:'4/02'},{week:'D8',title:'4/03'}];
        
        // ä½å®¿è³‡æ–™
        const hotels = [
            {name:"Lotte City Hotel Kinshicho", img:"https://placehold.co/600x400/333/fff?text=Kinshicho"},
            {name:"Megu Fuji 2021", img:"https://placehold.co/600x400/333/fff?text=Fuji"},
            {name:"DOMO Hotel Shinjuku", img:"https://placehold.co/600x400/333/fff?text=Shinjuku"}
        ];

        // è³¼ç‰©è³‡æ–™
        const shoppingList = ref({
            wish: [{name:"Chiikawa Land", desc:"æ±äº¬ç«™ä¸€ç•ªè¡—", img:"https://placehold.co/100"}, {name:"Le Labo", desc:"Gaiac 10", img:"https://placehold.co/100"}]
        });

        // å¤©æ°£è³‡æ–™
        const weatherData = ref([
            {name:'Tokyo', temp:'--', bg:'bg-blue-400'},
            {name:'Kamakura', temp:'--', bg:'bg-teal-400'},
            {name:'Fuji', temp:'--', bg:'bg-indigo-400'}
        ]);

        // Computed
        const currentItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
        const personalExpenses = computed(() => expenses.value.filter(e=>e.type!=='split'));
        const userPersonalTotal = computed(() => personalExpenses.value.reduce((a,b)=>a+Number(b.amount),0));
        
        // æ™ºèƒ½ç¥¨åˆ¸åµæ¸¬
        const suggestedTickets = computed(() => {
            const allNotes = JSON.stringify(itineraryData.value);
            const list = [];
            if(allNotes.includes('è¿ªå£«å°¼')) list.push({name:'æ±äº¬è¿ªå£«å°¼é–€ç¥¨', link:'https://www.klook.com/zh-TW/activity/695-tokyo-disney-resort-1-day-pass-tokyo/'});
            if(allNotes.includes('Skyliner') || allNotes.includes('æˆç”°')) list.push({name:'Skyliner è»Šç¥¨', link:'https://www.klook.com/zh-TW/activity/1410-skyliner-tokyo/'});
            if(allNotes.includes('SHIBUYA SKY')) list.push({name:'SHIBUYA SKY å±•æœ›å°', link:'https://www.klook.com/zh-TW/activity/28522-shibuya-sky-ticket-tokyo/'});
            return list;
        });

        // ç›£è½ Auth ç‹€æ…‹ (Persistence)
        onMounted(() => {
            if(auth) {
                onAuthStateChanged(auth, (user) => {
                    isLoggedIn.value = !!user;
                    if(user) {
                        // å·²ç™»å…¥ï¼šé–‹å•Ÿ Firestore ç›£è½
                        onSnapshot(doc(db, "trips", "kanto2026"), (doc) => {
                            if(doc.exists()) {
                                const d = doc.data();
                                itineraryData.value = d.itinerary;
                                expenses.value = d.expenses;
                                users.value = d.users;
                            }
                        });
                    }
                });
            }
            // æŠ“å–åŒ¯ç‡èˆ‡å¤©æ°£
            fetchRate();
            fetchWeather();
        });

        // å‹•ä½œ Functions
        const enterSite = () => { isWelcomeClosed.value = true; currentView.value = 'menu'; };
        const getPageTitle = (v) => apps.find(a=>a.view===v)?.name || v;
        const getIconByCategory = (c) => ({'Transport':'fa-train','Sightseeing':'fa-camera','Food':'fa-utensils','Shopping':'fa-bag-shopping'}[c]||'fa-star');
        const getMapLink = (k) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}`;
        const getImg = (p) => `https://raw.githubusercontent.com/sunny5200820-maker/2026.tokyo.fuji.trip/main/${p}`;
        const handleImgError = (e) => e.target.src = 'https://placehold.co/400x300?text=No+Image';
        const getClothingAdvice = (t) => t<10?'ç¾½çµ¨è¡£+åœå·¾':t<15?'å¤§è¡£+ç™¼ç†±è¡£':'æ´‹è”¥å¼ç©¿æ­';
        
        // åŒ¯ç‡è½‰æ›
        const fetchRate = async () => {
             // æ¨¡æ“¬ API å‘¼å« (é¿å… Demo Key å¤±æ•ˆ)
             setTimeout(() => exchangeRate.value = 0.215, 500); 
        };
        const formatMoney = (val) => {
            if(displayCurrency.value === 'JPY') return `Â¥${val.toLocaleString()}`;
            return `NT$${Math.round(val * exchangeRate.value).toLocaleString()}`;
        };

        // å¤©æ°£ API (Open-Meteo)
        const fetchWeather = async () => {
            // ç°¡å–®ç¤ºç¯„æŠ“æ±äº¬ï¼Œå¯¦éš›æ‡‰ Promise.all æŠ“ä¸‰åœ°åº§æ¨™
            try {
                const r = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current_weather=true');
                const d = await r.json();
                weatherData.value[0].temp = d.current_weather.temperature;
                // æ¨¡æ“¬å…¶ä»–å…©åœ° (ç‚ºæ±‚ Demo ç©©å®š)
                weatherData.value[1].temp = d.current_weather.temperature - 2; 
                weatherData.value[2].temp = d.current_weather.temperature - 5;
            } catch(e){}
        };

        // Auth & Save
        const handleAuthClick = () => {
            if(isLoggedIn.value) auth ? signOut(auth) : (isLoggedIn.value=false);
            else showLoginModal.value = true;
        };
        const doLogin = async () => {
            if(!auth) { alert("è«‹å…ˆè¨­å®š Firebase Config"); return; }
            try {
                await signInWithEmailAndPassword(auth, loginForm.value.email, loginForm.value.password);
                showLoginModal.value = false;
            } catch(e) { alert("ç™»å…¥å¤±æ•—: " + e.message); }
        };
        const saveData = async () => {
            if(isLoggedIn.value && db) {
                await setDoc(doc(db, "trips", "kanto2026"), {
                    itinerary: itineraryData.value,
                    expenses: expenses.value,
                    users: users.value
                }, {merge:true});
            }
        };

        // UI äº’å‹•
        const addItineraryItem = () => {
            itineraryData.value[selectedDayIndex.value].push({hours:"10:00",category:"Sightseeing",name:"æ–°è¡Œç¨‹",mapKeyword:"",note:""});
            saveData();
        };
        const deleteExpense = (id) => {
            if(confirm('åˆªé™¤?')) { expenses.value = expenses.value.filter(e=>e.id!==id); saveData(); }
        };
        const addPrepItem = (user) => {
            user.list.push({text:'æ–°é …ç›®', checked:false});
            saveData();
        };
        const startDrag = (e) => { /* ç°¡æ˜“æ‹–æ›³é‚è¼¯å¯åœ¨æ­¤å¯¦ä½œ */ };
        
        // ç¿»è­¯ç™¼éŸ³
        const speak = (t) => { const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; speechSynthesis.speak(u); };

        return {
            currentView, isWelcomeClosed, showGoogleSearch, enterSite, apps, tripDays, selectedDayIndex, daysUntilTrip,
            itineraryData, currentItinerary, hotels, users, expenses, shoppingList, weatherData, japanesePhrases: [{jp:'ã™ã¿ã¾ã›ã‚“',tw:'ä¸å¥½æ„æ€'},{jp:'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™',tw:'æˆ‘è¦é€™å€‹'}],
            isLoggedIn, showLoginModal, loginForm, handleAuthClick, doLogin, saveData,
            moneyTab, exchangeRate, displayCurrency, userPersonalTotal, personalExpenses,
            hotelTab, suggestedTickets,
            getPageTitle, getIconByCategory, getMapLink, getImg, handleImgError, getClothingAdvice, formatMoney, fetchRate,
            addItineraryItem, deleteExpense, addPrepItem, startDrag, speak
        };
    }
}).mount('#app');
</script>
</body>
</html>
